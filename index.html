<!DOCTYPE html>

<html lang="it">

<head>

<meta charset="utf-8" />

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<meta name="app-version" content="2.0">

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

<title>Frigo Smart AI Ultra</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">

  <!-- Meta essenziali iOS (devono stare prima del manifest e dello style) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Frigo Smart">
  <link rel="apple-touch-icon" href="icon-512.png">

  <!-- Manifest e colori PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0a1929">

<!-- Font Poppins per il riquadro temperatura -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Font Awesome per l'icona temperatura -->
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">


<style>

  :root{

    --bg1:#e0f4ff; --bg2:#c8e9ff; --accent:#077fbf; --card:#ffffff; --muted:#4b5563;

/* NUOVE VARIABILI PER LA NAVBAR */
    --bg-app-start: #E8F4F8;
    --bg-app-mid: #D1E9F6;
    --bg-app-end: #B8DFF8;
    --nav-inner-bg: rgba(255, 255, 255, 0.8);
    --nav-text: rgba(66, 123, 183, 0.7);
    --nav-text-active: #0D47A1;
    --border-soft: rgba(255, 255, 255, 0.7);
    --shadow-soft: 0 10px 25px rgba(33, 150, 243, 0.16);
    --shadow-inner: inset 0 1px 2px rgba(255, 255, 255, 0.7);
    --radius-nav: 26px;
    --radius-item: 18px;
    --transition-fast: 0.18s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-normal: 0.25s cubic-bezier(0.4, 0, 0.2, 1);

    --success:#16a34a; --danger:#ef4444; --ice:#b3e5fc; --text:#052e3b;

    --input-bg:#ffffff; --border:#dbeafe;

  }

 

  body.dark-mode {

    --bg1:#0a1929; --bg2:#1a2332; --accent:#4fc3f7; --card:#1e293b; --muted:#94a3b8;

    --text:#e2e8f0; --input-bg:#334155; --border:#475569;

  }

 

  *{box-sizing:border-box}

 

  @keyframes slideIn {

    from { opacity:0; transform:translateY(20px); }

    to { opacity:1; transform:translateY(0); }

  }

 

  @keyframes shimmer {

    0% { background-position: -1000px 0; }

    100% { background-position: 1000px 0; }

  }

 

  @keyframes iceGlow {

    0%, 100% { box-shadow: 0 0 20px rgba(179, 229, 252, 0.3); }

    50% { box-shadow: 0 0 40px rgba(179, 229, 252, 0.6); }

  }

 

  @keyframes robotTalk {

    0%, 100% { transform: scale(1) rotate(0deg); }

    25% { transform: scale(1.05) rotate(-2deg); }

    75% { transform: scale(1.05) rotate(2deg); }

  }

 

  @keyframes pulse {

    0%, 100% { transform: scale(1); }

    50% { transform: scale(1.05); }

  }

 

  @keyframes spin {

    to { transform: rotate(360deg); }

  }

 

  body{

    margin:0;

    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;

    background:linear-gradient(180deg,var(--bg1),var(--bg2));

    color:var(--text);

    padding:12px;

    padding-bottom: 120px; /* AGGIUNGI QUESTA RIGA */

    position:relative;

    overflow-x:hidden;

    transition: background 0.5s ease, color 0.5s ease;

  }

 

  body::before {

    content:'';

    position:fixed;

    top:0; left:0; right:0; bottom:0;

    background:

      linear-gradient(90deg, transparent 0%, rgba(179, 229, 252, 0.1) 50%, transparent 100%);

    background-size: 200% 100%;

    animation: shimmer 8s infinite linear;

    pointer-events:none;

    z-index:0;

  }

 

  header{

    display:flex;

    align-items:center;

    justify-content:space-between;

    gap:8px;

    margin-bottom:10px;

    position:relative;

    z-index:1;

    animation: slideIn 0.5s ease-out;

  }

 

  h1{font-size:18px;margin:0}

  h2{color:var(--text)}

  h3{margin-top:0}

  h4{margin-top:0;margin-bottom:8px}

 

  .brand{

    background:linear-gradient(135deg, #077fbf, #0596d5);

    color:#fff;

    padding:8px 10px;

    border-radius:10px;

    font-weight:700;

    box-shadow:0 6px 18px rgba(7,127,191,0.3), inset 0 1px 0 rgba(255,255,255,0.3);

    animation: pulse 2s infinite;

  }

 

  nav{

    display:flex;

    flex-wrap:wrap;

    gap:8px;

    justify-content:center;

    margin-bottom:12px;

    position:relative;

    z-index:1;

  }

 

  nav button{

    flex:1 1 30%;

    min-width:120px;

    padding:10px;

    border-radius:10px;

    border:none;

    background:linear-gradient(135deg, var(--card), var(--input-bg));

    box-shadow:0 6px 14px rgba(2,6,23,0.06);

    cursor:pointer;

    transition:all 0.3s ease;

    position:relative;

    overflow:hidden;

    color:var(--text);

  }

 

  nav button:hover {

    transform:translateY(-2px);

    box-shadow:0 8px 20px rgba(7,127,191,0.15);

  }

 

  main{max-width:980px;margin:auto;position:relative;z-index:1;}

 

body > section{
  display:none;
  background:var(--card);
  padding:12px;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(2,6,23,0.06);
  margin-bottom:10px;
  position:relative;
  overflow:hidden;
  transition: background 0.3s ease;
}

 /* La sezione HOME non deve â€œtagliareâ€ la card interna */
section#home{
  background: transparent;   /* niente sfondo proprio */
  padding: 0;
  border-radius: 0;
  box-shadow: none;
  overflow: visible;         /* fondamentale per eliminare il triangolino */
}


  section.active{

    display:block;

    animation: slideIn 0.4s ease-out;

  }

 

  input,select,textarea,button{

    font-size:15px;

    padding:10px;

    border-radius:8px;

    border:1px solid var(--border);

    background:var(--input-bg);

    transition:all 0.3s ease;

    color:var(--text);

  }

 

  input:focus,select:focus,textarea:focus{

    outline:none;

    border-color:var(--accent);

    box-shadow:0 4px 12px rgba(7,127,191,0.15);

  }

 

  .row{display:flex;gap:8px;flex-wrap:wrap}

  .col{flex:1;min-width:120px}

  ul{list-style:none;padding:0;margin:0}

 

  li.item{

    display:flex;

    justify-content:space-between;

    align-items:center;

    padding:10px;

    border-radius:10px;

    background:linear-gradient(90deg, var(--input-bg), var(--card));

    margin-bottom:8px;

    transition:all 0.3s ease;

    animation: slideIn 0.3s ease-out;

    border:1px solid var(--border);

  }

 

  li.item:hover {

    transform:translateX(5px);

    box-shadow:0 4px 12px rgba(7,127,191,0.1);

  }

 

  .tiny{font-size:13px;color:var(--muted)}

 

  .chip{

    padding:6px 8px;

    border-radius:999px;

    background:linear-gradient(135deg, #e6f7ff, #b3e5fc);

    border:1px solid rgba(7,127,191,0.12);

    font-weight:600;

    color:#052e3b;

  }

 

  .btn-primary{

    background:linear-gradient(135deg, var(--accent), #0596d5);

    color:#fff;

    border:none;

    padding:10px;

    border-radius:10px;

    cursor:pointer;

    transition:all 0.3s ease;

    box-shadow:0 4px 12px rgba(7,127,191,0.2);

  }

 

  .btn-primary:hover {

    transform:translateY(-2px);

    box-shadow:0 6px 16px rgba(7,127,191,0.3);

  }

 

  .btn-ghost{

    background:var(--input-bg);

    border:1px solid var(--border);

    padding:8px;

    border-radius:10px;

    cursor:pointer;

    transition:all 0.3s ease;

    color:var(--text);

  }

 

  .btn-ghost:hover {

    border-color:var(--accent);

    transform:translateY(-1px);

  }

 

  .card{

    padding:10px;

    border-radius:10px;

    background:var(--card);

    box-shadow:0 6px 16px rgba(2,6,23,0.04);

    transition:all 0.3s ease;

    border:1px solid var(--border);

  }

 

  .card:hover {

    box-shadow:0 8px 20px rgba(2,6,23,0.08);

  }

 


  #chat{

    height:180px;

    overflow:auto;

    border-radius:8px;

    padding:8px;

    background:var(--input-bg);

    border:1px solid var(--border);

  }

 

  .recipe-card{

    padding:10px;

    border-radius:10px;

    background:var(--card);

    margin-bottom:8px;

    transition:all 0.3s ease;

    animation: slideIn 0.3s ease-out;

    border:1px solid var(--border);

  }

 

  .recipe-card:hover {

    transform:scale(1.02);

    box-shadow:0 6px 18px rgba(7,127,191,0.1);

  }

 

  .alert{color:var(--danger);font-weight:700;animation: pulse 1s infinite;}

  .success{color:var(--success);font-weight:700;}

 

  .grocery-item {

    display:flex;

    justify-content:space-between;

    align-items:center;

    padding:8px 10px;

    background:var(--input-bg);

    border-radius:8px;

    margin-bottom:6px;

    transition:all 0.3s ease;

    border:1px solid var(--border);

  }

 

  .grocery-item input[type="checkbox"] {

    width:auto;

    margin-right:8px;

  }

 

  .grocery-item.checked {

    opacity:0.5;

    text-decoration:line-through;

  }

 

  .progress-bar {

    width:100%;

    height:20px;

    background:var(--input-bg);

    border-radius:10px;

    overflow:hidden;

    position:relative;

    border:1px solid var(--border);

  }

 

  .progress-fill {

    height:100%;

    background:linear-gradient(90deg, var(--accent), #0596d5);

    transition:width 0.5s ease;

    display:flex;

    align-items:center;

    justify-content:center;

    color:#fff;

    font-size:11px;

    font-weight:600;

  }

 

  .macro-tracker {

    display:grid;

    grid-template-columns:1fr 1fr 1fr;

    gap:8px;

    margin-top:12px;

  }

 

  .macro-card {
    padding:10px;
    border-radius:10px;
    background:var(--card);
    border:2px solid var(--border);
    text-align:center;
    transition:all 0.3s ease;
    color:var(--text);
  }

 

  .macro-card:hover {

    transform:translateY(-3px);

    box-shadow:0 6px 16px rgba(7,127,191,0.1);

  }

 

  .macro-card.over {

    border-color:var(--danger);

    background:rgba(239, 68, 68, 0.05);

  }

 

  .macro-card.perfect {

    border-color:var(--success);

    background:rgba(22, 163, 74, 0.05);

  }

 

  #aiRobot {

    position:fixed;

    bottom:20px;

    right:20px;

    width:120px;

    height:120px;

    z-index:1000;

    pointer-events:none;

    opacity:0;

    transition:opacity 0.5s ease;

  }

 

  #aiRobot.talking {

    animation: robotTalk 0.5s ease-in-out infinite;

  }

 

  #aiRobot.visible {

    opacity:1;

  }

 

  .robot-body {

    position:relative;

    width:100%;

    height:100%;

    filter:drop-shadow(0 8px 16px rgba(7,127,191,0.3));

  }

 

  .modal {

    display: none;

    position: fixed;

    z-index: 10000;

    left: 0;

    top: 0;

    width: 100%;

    height: 100%;

    background: rgba(0,0,0,0.5);

  }

 

  .modal.active {

    display: flex;

    align-items: center;

    justify-content: center;

  }

 

  .modal-content {

    background: var(--card);

    padding: 20px;

    border-radius: 15px;

    max-width: 500px;

    width: 90%;

    max-height: 80vh;

    overflow-y: auto;

    box-shadow: 0 10px 40px rgba(0,0,0,0.3);

    animation: slideIn 0.3s ease-out;

    border: 2px solid var(--border);

  }

 

  .modal-header {

    display: flex;

    justify-content: space-between;

    align-items: center;

    margin-bottom: 15px;

    padding-bottom: 10px;

    border-bottom: 2px solid var(--border);

  }

 

  .close-modal {

    font-size: 28px;

    font-weight: bold;

    cursor: pointer;

    color: var(--muted);

    background: none;

    border: none;

    padding: 0;

    width: 30px;

    height: 30px;

    display: flex;

    align-items: center;

    justify-content: center;

  }

 

  .close-modal:hover {

    color: var(--danger);

  }

 

  .scan-loader {

    display: none;

    position: fixed;

    top: 0;

    left: 0;

    right: 0;

    bottom: 0;

    background: rgba(0, 0, 0, 0.8);

    z-index: 10001;

    align-items: center;

    justify-content: center;

    flex-direction: column;

    gap: 20px;

  }

 

  .scan-loader.active {

    display: flex;

  }

 

  .spinner {

    width: 60px;

    height: 60px;

    border: 6px solid rgba(255, 255, 255, 0.2);

    border-top-color: #4fc3f7;

    border-radius: 50%;

    animation: spin 1s linear infinite;

  }

 

  .scan-loader-text {

    color: white;

    font-size: 18px;

    font-weight: 600;

    text-align: center;

  }

 

  .day-menu {

    background: var(--card);

    border: 2px solid var(--border);

    border-radius: 12px;

    padding: 12px;

    margin-bottom: 12px;

    animation: slideIn 0.4s ease-out;

  }

 

  .day-header {

    font-size: 18px;

    font-weight: 700;

    margin-bottom: 10px;

    display: flex;

    justify-content: space-between;

    align-items: center;

  }

 

  .meal-item {

    background: var(--input-bg);

    padding: 8px;

    border-radius: 8px;

    margin-bottom: 6px;

    border: 1px solid var(--border);

  }

 

  .detected-item {

    display: inline-block;

    background: var(--input-bg);

    padding: 6px 10px;

    border-radius: 8px;

    margin: 4px;

    border: 1px solid var(--border);

    animation: slideIn 0.3s ease-out;

  }

 
/* ðŸŽ¯ SCANNER BARCODE - Box ottimizzato */
#scannerReader {
  border: 2px solid rgba(79, 195, 247, 0.5) !important;
  border-radius: 12px !important;
}

#scannerReader video {
  border-radius: 12px !important;
  object-fit: cover !important;
}

/* Box di scansione personalizzato */
#scannerReader canvas {
  border-radius: 12px !important;
}

/* Sovrascrivi stili libreria */
#scannerReader > div {
  border: none !important;
}


  @media(min-width:900px){

    nav button{flex:1 1 12%}

    .grid2{display:grid;grid-template-columns:1fr 360px;gap:12px}

  }


/* Splash "CARICAMENTO..." scuro */
#app-splash {
  position: fixed;
  inset: 0;
  background: #0a1929;     /* scuro coerente col tema */
  color: #fff;
  display: grid;
  place-items: center;
  z-index: 999999;
}

#app-splash .inner {
  text-align: center;
  animation: fadeIn 0.6s ease;
}

#app-splash img {
  width: 128px;
  height: 128px;
  display: block;
  margin: 0 auto 16px auto;
  animation: pulseLogo 1.6s ease-in-out infinite;
}

#app-splash .txt {
  font-size: 20px;
  letter-spacing: 2px;
  font-weight: 700;
}

@keyframes pulseLogo {
  0%, 100% { transform: scale(1); opacity: 0.95; }
  50% { transform: scale(1.08); opacity: 1; }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.hidden-splash { opacity: 0; pointer-events: none; transition: opacity .35s ease; }

  /* === ðŸ“Š GRAFICI E CRONOLOGIA === */
.chart-container {
  background: var(--card);
  border-radius: 12px;
  padding: 15px;
  margin: 10px 0;
  border: 2px solid var(--border);
}

.chart-canvas {
  width: 100%;
  height: 250px;
}

.chart-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.chart-tab {
  flex: 1;
  padding: 8px 12px;
  border-radius: 8px;
  border: 2px solid var(--border);
  background: var(--input-bg);
  cursor: pointer;
  transition: all 0.3s ease;
  color: var(--text);
}

.chart-tab.active {
  background: linear-gradient(135deg, var(--accent), #0596d5);
  color: white;
}

.cronologia-item {
  background: var(--input-bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 10px;
}

.cronologia-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
}

.cronologia-macros {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  margin-top: 8px;
}

.search-recipe-input {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--input-bg);
  color: var(--text);
}

.filter-badge {
  padding: 4px 10px;
  border-radius: 999px;
  background: var(--input-bg);
  border: 1px solid var(--border);
  font-size: 12px;
  cursor: pointer;
}

.filter-badge.active {
  background: var(--accent);
  color: white;
}

 /* ========================================
   TUTORIAL CLASSICO (OVERLAY CON SLIDE)
   ======================================== */

#tutorial-overlay {
  position: fixed;
  inset: 0;
  background: rgba(10, 25, 41, 0.95);
  backdrop-filter: blur(10px);
  z-index: 999999;
  display: none;
  opacity: 0;
  transition: opacity 0.4s ease;
}

#tutorial-overlay.active {
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 1;
}

.tutorial-container {
  max-width: 600px;
  width: 90%;
  max-height: 90vh;
  background: linear-gradient(135deg, #1a2332, #0a1929);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  border: 2px solid rgba(79, 195, 247, 0.3);
  animation: slideUp 0.5s ease-out;
  position: relative;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.tutorial-header {
  text-align: center;
  margin-bottom: 12px;
  flex-shrink: 0;
}

.tutorial-icon {
  font-size: 40px;
  margin-bottom: 8px;
  animation: bounce 1s ease-in-out infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.tutorial-title {
  font-size: 20px;
  font-weight: 700;
  color: #4fc3f7;
  margin: 0 0 6px 0;
}

.tutorial-subtitle {
  font-size: 13px;
  color: #94a3b8;
  margin: 0;
}

.tutorial-content {
  color: #e2e8f0;
  line-height: 1.5;
  font-size: 14px;
  overflow-y: auto;
  flex: 1;
  padding-right: 8px;
  margin-bottom: 12px;
}

.tutorial-content::-webkit-scrollbar {
  width: 6px;
}

.tutorial-content::-webkit-scrollbar-track {
  background: rgba(79, 195, 247, 0.1);
  border-radius: 3px;
}

.tutorial-content::-webkit-scrollbar-thumb {
  background: rgba(79, 195, 247, 0.3);
  border-radius: 3px;
}

.tutorial-content::-webkit-scrollbar-thumb:hover {
  background: rgba(79, 195, 247, 0.5);
}

.tutorial-footer {
  flex-shrink: 0;
  padding-top: 8px;
}

.tutorial-progress {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 12px;
}

.tutorial-progress-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: rgba(79, 195, 247, 0.3);
  transition: all 0.3s ease;
}

.tutorial-progress-dot.active {
  background: #4fc3f7;
  transform: scale(1.2);
}

.tutorial-buttons {
  display: flex;
  gap: 8px;
  justify-content: center;
}

.tutorial-btn {
  padding: 8px 16px;
  font-size: 14px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 600;
}

.tutorial-btn-skip {
  background: rgba(148, 163, 184, 0.2);
  color: #94a3b8;
}

.tutorial-btn-skip:hover {
  background: rgba(148, 163, 184, 0.3);
}

.tutorial-btn-next {
  background: linear-gradient(135deg, #4fc3f7, #077fbf);
  color: white;
}

.tutorial-btn-next:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(79, 195, 247, 0.3);
}

/* MOBILE */
@media (max-width: 480px) {
  .tutorial-container {
    width: 96%;
    max-height: 92vh;
    padding: 12px;
    border-radius: 12px;
  }
  
  .tutorial-icon {
    font-size: 32px;
    margin-bottom: 6px;
  }
  
  .tutorial-title {
    font-size: 17px;
    margin-bottom: 4px;
  }
  
  .tutorial-subtitle {
    font-size: 12px;
  }
  
  .tutorial-content {
    font-size: 13px;
    line-height: 1.4;
    margin-bottom: 10px;
  }
  
  .tutorial-header {
    margin-bottom: 10px;
  }
  
  .tutorial-footer {
    padding-top: 6px;
  }
  
  .tutorial-progress {
    margin-bottom: 10px;
    gap: 6px;
  }
  
  .tutorial-progress-dot {
    width: 8px;
    height: 8px;
  }
  
  .tutorial-btn {
    padding: 7px 12px;
    font-size: 13px;
  }
}

/* ========================================
   FREEZY - PERSONAGGIO GUIDA
   ======================================== */

#guide-character {
  position: fixed;
  bottom: -300px;
  right: 30px;
  width: 280px; /* ðŸ‘ˆ Ridotto da 300px */
  height: 330px; /* ðŸ‘ˆ Ridotto da 350px */
  z-index: 999997; /* ðŸ‘ˆ Ridotto per evitare conflitti */
  transition: bottom 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  pointer-events: none;
}

#guide-character.active {
  bottom: 110px !important;
}

#guide-character img,
#guide-character video {
  width: 100%;
  height: 100%;
  object-fit: contain;
  filter: drop-shadow(0 10px 30px rgba(0, 0, 0, 0.3));
  animation: bobbing 3s ease-in-out infinite;
}

@keyframes bobbing {
  0%, 100% { transform: translateY(0) rotate(-2deg); }
  50% { transform: translateY(-15px) rotate(2deg); }
}

.ice-bubble {
  position: absolute;
  background: linear-gradient(135deg, rgba(179, 229, 252, 0.6), rgba(129, 212, 250, 0.4));
  border-radius: 50%;
  animation: floatBubble 4s ease-in-out infinite;
  box-shadow: 0 4px 15px rgba(79, 195, 247, 0.3);
}

.ice-bubble:nth-child(1) {
  width: 15px;
  height: 15px;
  top: 20%;
  right: -10px;
  animation-delay: 0s;
}

.ice-bubble:nth-child(2) {
  width: 10px;
  height: 10px;
  top: 40%;
  right: 10px;
  animation-delay: 1s;
}

.ice-bubble:nth-child(3) {
  width: 12px;
  height: 12px;
  top: 60%;
  right: 5px;
  animation-delay: 2s;
}

@keyframes floatBubble {
  0%, 100% { transform: translateY(0) scale(1); opacity: 0.6; }
  50% { transform: translateY(-20px) scale(1.1); opacity: 1; }
}

/* ========================================
   FUMETTO DI FREEZY
   ======================================== */

#guide-speech {
  position: fixed;
  bottom: 220px;
  right: 230px;
  max-width: 320px; /* ðŸ‘ˆ Ridotto da 350px */
  background: rgba(255, 255, 255, 0.98); /* ðŸ‘ˆ Leggermente trasparente */
  backdrop-filter: blur(10px); /* ðŸ‘ˆ Effetto blur */
  border-radius: 18px; /* ðŸ‘ˆ Ridotto */
  padding: 16px; /* ðŸ‘ˆ Ridotto da 20px */
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
  border: 2px solid #4fc3f7; /* ðŸ‘ˆ Ridotto da 3px */
  z-index: 999998; /* ðŸ‘ˆ Ridotto da 999999 */
  opacity: 0;
  transform: scale(0.8) translateY(20px);
  transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  pointer-events: none;
}

#guide-speech.active {
  opacity: 1;
  transform: scale(1) translateY(0);
  pointer-events: auto;
}

#guide-speech::after {
  content: '';
  position: absolute;
  bottom: -18px; /* ðŸ‘ˆ Ridotto */
  right: 35px;
  width: 0;
  height: 0;
  border-left: 18px solid transparent;
  border-right: 18px solid transparent;
  border-top: 22px solid rgba(255, 255, 255, 0.98);
}

#guide-speech::before {
  content: '';
  position: absolute;
  bottom: -22px; /* ðŸ‘ˆ Ridotto */
  right: 33px;
  width: 0;
  height: 0;
  border-left: 20px solid transparent;
  border-right: 20px solid transparent;
  border-top: 24px solid #4fc3f7;
  z-index: -1;
}

.guide-speech-text {
  font-size: 15px; /* ðŸ‘ˆ Ridotto da 16px */
  color: #0a1929;
  line-height: 1.5; /* ðŸ‘ˆ Ridotto da 1.6 */
  margin-bottom: 12px; /* ðŸ‘ˆ Ridotto da 15px */
}

.guide-speech-buttons {
  display: flex;
  gap: 8px; /* ðŸ‘ˆ Ridotto da 10px */
  justify-content: flex-end;
}

.guide-btn {
  padding: 7px 14px; /* ðŸ‘ˆ Ridotto */
  border-radius: 8px;
  border: none;
  font-size: 13px; /* ðŸ‘ˆ Ridotto da 14px */
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.guide-btn-skip {
  background: rgba(239, 68, 68, 0.15);
  color: #dc2626;
  border: 1px solid rgba(239, 68, 68, 0.3);
}

.guide-btn-skip:hover {
  background: rgba(239, 68, 68, 0.25);
  transform: translateY(-1px);
}

.guide-btn-next {
  background: linear-gradient(135deg, #077fbf, #0596d5);
  color: white;
  box-shadow: 0 4px 15px rgba(7, 127, 191, 0.3);
}

.guide-btn-next:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 20px rgba(7, 127, 191, 0.4);
}

.interactive-tooltip {
  position: absolute;
  background: linear-gradient(135deg, #1a2332, #0a1929);
  color: white;
  padding: 15px 18px;
  border-radius: 12px;
  font-size: 14px;
  z-index: 999997;
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s ease;
  border: 2px solid #4fc3f7;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
  min-width: 200px;
  max-width: 300px;
}

.interactive-tooltip.active {
  opacity: 1;
}

.interactive-tooltip::after {
  content: '';
  position: absolute;
  border: 8px solid transparent;
}

.interactive-tooltip.arrow-bottom::after {
  bottom: -16px;
  left: 50%;
  transform: translateX(-50%);
  border-top-color: #4fc3f7;
}

.tooltip-title {
  font-weight: 700;
  font-size: 16px;
  margin-bottom: 8px;
  color: #4fc3f7;
}

.tooltip-desc {
  font-size: 13px;
  line-height: 1.5;
  color: #cbd5e1;
}

.interactive-highlight {
  position: relative;
  z-index: 999996;
  animation: pulse-highlight 2s ease-in-out infinite;
}

@keyframes pulse-highlight {
  0%, 100% { box-shadow: 0 0 0 0 rgba(79, 195, 247, 0.7); }
  50% { box-shadow: 0 0 0 15px rgba(79, 195, 247, 0); }
}

#interactive-overlay {
  position: fixed;
  inset: 0;
  background: rgba(10, 25, 41, 0.7);
  backdrop-filter: blur(3px);
  z-index: 999995;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

#interactive-overlay.active {
  opacity: 1;
  pointer-events: auto;
}

.interactive-arrow {
  position: absolute;
  width: 60px;
  height: 60px;
  z-index: 999998;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.interactive-arrow.active {
  opacity: 1;
  animation: bounce-arrow 1.5s ease-in-out infinite;
}

@keyframes bounce-arrow {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-15px); }
}

.interactive-arrow svg {
  width: 100%;
  height: 100%;
  filter: drop-shadow(0 4px 8px rgba(79, 195, 247, 0.5));
}

/* ========== FROSTY AI CHAT STYLES ========== */
.glass-panel-frosty {
    background: rgba(30, 41, 59, 0.7);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.neon-glow-frosty { 
    box-shadow: 0 0 15px rgba(56, 189, 248, 0.3); 
}

@keyframes pulse-idle-frosty {
    0% { box-shadow: 0 0 30px rgba(34,211,238,0.4); transform: scale(1); }
    50% { box-shadow: 0 0 50px rgba(34,211,238,0.6); transform: scale(1.05); }
    100% { box-shadow: 0 0 30px rgba(34,211,238,0.4); transform: scale(1); }
}

@keyframes pulse-listening-frosty {
    0% { box-shadow: 0 0 40px rgba(248,113,113,0.6); opacity: 1; }
    50% { box-shadow: 0 0 60px rgba(248,113,113,0.8); opacity: 0.7; }
    100% { box-shadow: 0 0 40px rgba(248,113,113,0.6); opacity: 1; }
}

@keyframes pulse-speaking-frosty {
    0% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); transform: scale(1); }
    50% { box-shadow: 0 0 40px rgba(168, 85, 247, 0.7); transform: scale(1.1); }
    100% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); transform: scale(1); }
}

.orb-idle-frosty { animation: pulse-idle-frosty 4s infinite ease-in-out; }
.orb-listening-frosty { animation: pulse-listening-frosty 1s infinite ease-in-out; }
.orb-speaking-frosty { animation: pulse-speaking-frosty 1.5s infinite ease-in-out; }

.message-enter-frosty { 
    animation: slideIn-frosty 0.3s ease-out forwards; 
    opacity: 0; 
    transform: translateY(20px); 
}

@keyframes slideIn-frosty { 
    to { opacity: 1; transform: translateY(0); } 
}

/* ========== FIN FROSTY AI CHAT STYLES ========== */

/* ============================
   Mini barra di avanzamento tutorial - ULTRA COMPATTA
   ============================ */
#interactive-progress {
  position: fixed;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(25, 35, 50, 0.9);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  padding: 6px 12px;
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.15);
  display: inline-flex;
  align-items: center;
  gap: 8px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  z-index: 999999;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  width: auto;
  max-width: 90vw;
}

#interactive-progress.active {
  opacity: 1;
}

/* Testo tipo "2/13" */
#interactive-progress .progress-text {
  font-size: 11px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.95);
  letter-spacing: 0.3px;
  white-space: nowrap;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  line-height: 1;
}

/* Container pallini */
.progress-dots {
  display: inline-flex;
  gap: 4px;
  align-items: center;
}

/* Pallini */
.progress-dot-interactive {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.25);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  flex-shrink: 0;
}

.progress-dot-interactive.active {
  background: #ffffff;
  width: 14px;
  border-radius: 4px;
  box-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
}

/* Hover (solo desktop) */
@media (hover: hover) {
  .progress-dot-interactive:hover:not(.active) {
    background: rgba(255, 255, 255, 0.5);
    transform: scale(1.1);
    cursor: pointer;
  }
}

/* ðŸ“± Tablet */
@media (max-width: 768px) {
  #interactive-progress {
    top: 10px;
    padding: 5px 10px;
    gap: 6px;
  }
  
  #interactive-progress .progress-text {
    font-size: 10px;
  }
  
  .progress-dot-interactive {
    width: 5px;
    height: 5px;
  }
  
  .progress-dot-interactive.active {
    width: 12px;
  }
}

/* ðŸ“± Mobile */
@media (max-width: 480px) {
  #interactive-progress {
    top: 8px;
    padding: 4px 8px;
    gap: 6px;
    border-radius: 18px;
  }
  
  #interactive-progress .progress-text {
    font-size: 9px;
  }
  
  .progress-dots {
    gap: 3px;
  }
  
  .progress-dot-interactive {
    width: 4px;
    height: 4px;
  }
  
  .progress-dot-interactive.active {
    width: 10px;
    border-radius: 3px;
  }
}

/* ðŸ“± Schermi molto piccoli */
@media (max-width: 360px) {
  #interactive-progress {
    padding: 3px 7px;
  }
  
  #interactive-progress .progress-text {
    font-size: 8px;
  }
}

/* RESPONSIVE - SOLO TUTORIAL */
@media (max-width: 768px) {
  /* Tutorial Overlay Classico */
  .tutorial-container {
    width: 95%;
    padding: 15px;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  .tutorial-icon {
    font-size: 42px;
    margin-bottom: 10px;
  }
  
  .tutorial-title {
    font-size: 20px;
  }
  
  .tutorial-subtitle {
    font-size: 13px;
  }
  
  .tutorial-content {
    font-size: 14px;
  }
  
  .tutorial-grid {
    grid-template-columns: 1fr;
  }
  
  .tutorial-buttons {
    flex-direction: column;
    width: 100%;
  }
  
  .tutorial-btn {
    width: 100%;
    font-size: 14px;
  }
 }

/* ========================================
   MOBILE: TABLET E GRANDI
   ======================================== */

  #guide-character {
    width: 110px; /* ðŸ‘ˆ Ridotto da 120px */
    height: 140px; /* ðŸ‘ˆ Ridotto da 150px */
    right: 15px; /* ðŸ‘ˆ PiÃ¹ margine */
    bottom: -200px; /* ðŸ‘ˆ Meno nascosto fuori schermo */
  }
  
  #guide-character.active {
    bottom: 15px; /* ðŸ‘ˆ PiÃ¹ margine dal basso */
  }
  
  #guide-speech {
    right: 15px;
    left: 15px;
    bottom: 140px; /* ðŸ‘ˆ Aumentato da 100px per non sovrapporsi */
    max-width: none;
    padding: 12px; /* ðŸ‘ˆ Ridotto */
    max-height: 45vh; /* ðŸ‘ˆ Aumentato da 40vh */
    overflow-y: auto;
    border-radius: 15px; /* ðŸ‘ˆ Ridotto */
  }
  
  #guide-speech::after {
    bottom: -15px; /* ðŸ‘ˆ Adattato */
    right: 30px;
    border-left: 15px solid transparent;
    border-right: 15px solid transparent;
    border-top: 18px solid rgba(255, 255, 255, 0.98);
  }
  
  #guide-speech::before {
    bottom: -18px; /* ðŸ‘ˆ Adattato */
    right: 28px;
    border-left: 17px solid transparent;
    border-right: 17px solid transparent;
    border-top: 20px solid #4fc3f7;
  }
  
  .guide-speech-text {
    font-size: 13px; /* ðŸ‘ˆ Ridotto */
    line-height: 1.5;
    margin-bottom: 10px;
  }

  .guide-speech-buttons {
    margin-top: 10px;
    gap: 6px;
  }

  .guide-btn {
    padding: 6px 12px;
    font-size: 12px;
  }

  .interactive-tooltip {
    max-width: 250px;
    font-size: 12px;
    padding: 10px; /* ðŸ‘ˆ Ridotto */
  }

  #interactive-progress {
    padding: 8px 12px;
    top: 10px;
    left: 10px;
    right: 10px;
  }
}

/* ========================================
   MOBILE: PICCOLI
   ======================================== */

@media (max-width: 480px) {
  #guide-character {
    width: 90px; /* ðŸ‘ˆ Ridotto da 100px */
    height: 115px; /* ðŸ‘ˆ Ridotto da 130px */
    right: 10px;
    bottom: -150px;
  }
  
  #guide-character.active {
    bottom: 10px;
  }
  
 .tutorial-container {
    padding: 12px;
  }
  
  .tutorial-icon {
    font-size: 36px;
  }
  
  .tutorial-title {
    font-size: 18px;
  }

  #guide-speech {
    right: 10px;
    left: 10px;
    bottom: 110px; /* ðŸ‘ˆ Ridotto da 120px */
    padding: 10px; /* ðŸ‘ˆ Ridotto */
    max-height: 50vh; /* ðŸ‘ˆ PiÃ¹ spazio */
    border-radius: 12px;
  }
  
  #guide-speech::after {
    bottom: -12px;
    right: 20px;
    border-left: 12px solid transparent;
    border-right: 12px solid transparent;
    border-top: 15px solid rgba(255, 255, 255, 0.98);
  }
  
  #guide-speech::before {
    bottom: -15px;
    right: 18px;
    border-left: 14px solid transparent;
    border-right: 14px solid transparent;
    border-top: 17px solid #4fc3f7;
  }
  
  .guide-speech-text {
    font-size: 12px; /* ðŸ‘ˆ Ridotto */
    line-height: 1.4;
    margin-bottom: 8px;
  }

  .guide-speech-buttons {
    margin-top: 8px;
    flex-direction: column; /* ðŸ‘ˆ Bottoni in verticale su mobile piccolo */
    gap: 6px;
  }

  .guide-btn {
    padding: 8px 12px; /* ðŸ‘ˆ PiÃ¹ padding verticale */
    font-size: 12px;
    width: 100%; /* ðŸ‘ˆ Bottoni a tutta larghezza */
    text-align: center;
  }
  
  .interactive-tooltip {
    max-width: 200px; /* ðŸ‘ˆ Ridotto */
    font-size: 11px;
    padding: 8px;
  }

  #interactive-progress {
    padding: 6px 10px;
    top: 8px;
    left: 8px;
    right: 8px;
    font-size: 11px;
  }
  
  .progress-dot-interactive {
    width: 6px; /* ðŸ‘ˆ Ridotto */
    height: 6px;
  }
}

/* ========================================
   MOBILE: EXTRA PICCOLI
   ======================================== */
@media (max-width: 360px) {
  #guide-character {
    width: 75px; /* ðŸ‘ˆ Ancora piÃ¹ piccolo */
    height: 95px;
    right: 8px;
  }
  
  #guide-speech {
    right: 8px;
    left: 8px;
    bottom: 90px;
    padding: 8px;
    max-height: 55vh;
  }
  
  .guide-speech-text {
    font-size: 11px;
  }
  
  .guide-btn {
    font-size: 11px;
    padding: 7px 10px;
  }
}
   
@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.05); opacity: 0.9; }
} 


/* ========== NAVBAR CSS DEFINITIVO ========== */
@keyframes fridgePulse {
    0%, 100% { box-shadow: 0 10px 24px rgba(50, 103, 212, 0.40); }
    50% { box-shadow: 0 14px 30px rgba(50, 103, 212, 0.55); }
}

/* Animazione nebulosa per tasto frigo */
@keyframes frigoNebulaMove {
  0% { background-position: 0% 0%; }
  50% { background-position: 100% 100%; }
  100% { background-position: 0% 0%; }
}
.navbar-container {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 10px 14px calc(14px + env(safe-area-inset-bottom, 0px));
    background: transparent;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    z-index: 1000;
}

.navbar {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(241,245,249,0.98) 50%, rgba(226,232,240,0.95) 100%);
    backdrop-filter: blur(22px) saturate(1.15);
    -webkit-backdrop-filter: blur(22px) saturate(1.15);
    border-radius: 100px;
    border: 1px solid var(--border-soft);
    box-shadow: var(--shadow-soft);
    
    /* FORZA TUTTO SU UNA RIGA */
    flex-wrap: nowrap !important;
    width: 480px;
    max-width: calc(100vw - 30px);
    margin: 0 auto;
    transform-origin: center;
    transition: transform 0.3s ease;
}

/* Scala quando serve */
@media (max-width: 370px) {
    .navbar {
        transform: scale(0.9);
    }
}
@media (max-width: 330px) {
    .navbar {
        transform: scale(0.85);
    }
}
@media (max-width: 310px) {
    .navbar {
        transform: scale(0.8);
    }
}
.nav-group {
    display: flex;
    flex-wrap: nowrap !important;
    flex-direction: row !important;
    gap: 14px;
}
.nav-group-left {
    justify-content: flex-start;
    flex: 0 0 auto;
}
.nav-group-right {
    justify-content: flex-end;
    flex: 0 0 auto;
}
.nav-item {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 7px 12px;
    flex: 0 0 68px;
    min-width: 68px;
    max-width: 68px;
    background: transparent;
    border: none;
    border-radius: var(--radius-item);
    cursor: pointer;
    color: var(--nav-text);
    font-size: 11px;
    font-weight: 500;
    -webkit-user-select: none;
    user-select: none;
    transition: background-color var(--transition-normal), color var(--transition-normal), transform var(--transition-fast), box-shadow var(--transition-normal);
}
.nav-item:active {
    transform: scale(0.96);
}
.nav-item.active {
    background: rgba(144, 202, 249, 0.22);
    color: var(--nav-text-active);
    box-shadow: var(--shadow-inner);
}
@keyframes frigoNebula {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

.nav-item.frigo {
    padding: 9px 12px;
    border-radius: 20px;
    flex: 0 0 auto;
    min-width: auto;
    max-width: none;
    margin: 0 10px;
    color: #FFFFFF;

    background-image: url('img/tasto-frigo.jpg');  /* âœ… CORRETTO */
    background-position: center;
    background-size: cover;
    background-repeat: no-repeat;


    border: none;
    box-shadow: 0 4px 15px rgba(74, 144, 226, 0.4);
    transform: translateY(-2px);
    position: relative;
    overflow: hidden;
}

.nav-item.frigo::before {
    content: none !important;
}

@keyframes frigoShine {
    0%, 100% { transform: rotate(0deg); opacity: 0.3; }
    50% { transform: rotate(180deg); opacity: 0.6; }
}

.nav-item.frigo:active {
    transform: translateY(-1px) scale(0.97);
    box-shadow: 0 7px 18px rgba(50, 103, 212, 0.38);
}

.nav-item.frigo.active {
    box-shadow: 0 12px 28px rgba(50, 103, 212, 0.55);
}.nav-icon {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.nav-item.frigo .nav-icon {
    width: 28px;
    height: 28px;
}
.nav-icon svg {
    width: 100%;
    height: 100%;
    fill: currentColor;
}
.nav-label {
    font-size: 11px;
    white-space: nowrap;
}
.nav-item.frigo .nav-label {
    font-size: 12px;
    font-weight: 600;
}
 
/* --- CARD TEMPERATURA HOME (stile identico al prototipo Tailwind) --- */

/* Home: togli il riquadro bianco della section, lasciando solo la card interna */
section#home {
  background: transparent !important;  /* niente sfondo bianco sotto */
  box-shadow: none !important;        /* niente ombra sotto */
  padding: 0 !important;              /* niente padding extra */
  border-radius: 0 !important;        /* niente bordi arrotondati sotto */
}


/* CARD TEMPERATURA - Compatta come Prossime Scadenze */
#home .card-temp {
  width: 100%;
  margin: 0 auto 16px auto;

  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 14px;  /* ðŸ‘ˆ Ridotto da 16px */

  border: 1px solid rgba(148, 163, 184, 0.2);
  box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);

  display: flex;
  flex-direction: column;
  gap: 10px;  /* ðŸ‘ˆ Ridotto da 12px */
  box-sizing: border-box;
  font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

/* HEADER: icona + testo + stato */
#home .card-temp-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

/* Sinistra */
#home .card-temp-left {
  display: flex;
  align-items: center;
}

/* Icona piÃ¹ piccola */
#home .card-temp-icon {
  width: 40px;  /* ðŸ‘ˆ Uguale a alert-icon-box */
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 12px;
  background-image: linear-gradient(135deg, #06b6d4, #0ea5e9);
  color: #ffffff;
  font-size: 18px;
}

#home .card-temp-label {
  font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
  font-size: 14px;  /* ðŸ‘ˆ Grande */
  font-weight: 600;  /* ðŸ‘ˆ Grassetto */
  color: #1e293b;  /* ðŸ‘ˆ Scuro */
  margin: 0 0 4px 0;
  line-height: 1.4;
}


#home .card-temp-value {
  font-size: 18px;  /* ðŸ‘ˆ Ridotto da 20px */
  font-weight: 700;
  color: #111827;
  line-height: 1.2;
}

/* Destra: "Stato" */
#home .card-temp-status {
  text-align: right;
}

#home .card-temp-status-label {
  font-size: 11px;  /* ðŸ‘ˆ Ridotto */
  color: #9ca3af;
  line-height: 1.2;
}

/* Pill verde "Ottimale" */
#home .card-temp-status-pill {
  margin-top: 3px;  /* ðŸ‘ˆ Ridotto */
  display: inline-flex;
  align-items: center;
  padding: 3px 8px;  /* ðŸ‘ˆ Ridotto */
  border-radius: 9999px;
  font-size: 11px;  /* ðŸ‘ˆ Ridotto */
  font-weight: 600;
  background-color: #d1fae5;
  color: #065f46;
  white-space: nowrap;
}

#home .card-temp-status-dot {
  width: 5px;  /* ðŸ‘ˆ Ridotto */
  height: 5px;
  border-radius: 9999px;
  background-color: #10b981;
  margin-right: 5px;  /* ðŸ‘ˆ Ridotto */
}

/* Barra progresso piÃ¹ sottile */
#home .card-temp-progress {
  height: 5px;  /* ðŸ‘ˆ Ridotto da 6px */
  border-radius: 9999px;
  background-color: rgba(148, 163, 184, 0.15);
  overflow: hidden;
}

#home .card-temp-progress-bar {
  height: 100%;
  width: 75%;
  border-radius: 9999px;
  background-image: linear-gradient(90deg, #22d3ee, #0ea5e9);  /* Azzurro */
}



/* CARD PROSSIME SCADENZE - Allineata come temperatura */
.alert-smart {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 16px;
  padding: 14px;  /* ðŸ‘ˆ Uguale alle altre */
  margin-bottom: 16px;
  box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
  display: flex;
  align-items: flex-start;  /* ðŸ‘ˆ Importante per allineamento */
  gap: 12px;
  animation: slideIn 0.4s ease-out;
}

/* Icona allineata come temperatura */
.alert-icon-box {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background: #fef3c7;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  margin-top: 0;  /* ðŸ‘ˆ Allineata in alto */
}

.alert-icon-box svg {
  width: 18px;
  height: 18px;
  color: #f59e0b;
}

/* Contenuto prossime scadenze */
.alert-content {
  flex: 1;
}

/* Titolo identico agli altri */
.alert-title {
  font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
  font-size: 14px;
  font-weight: 600;
  color: #1e293b;
  margin: 0 0 4px 0;
  line-height: 1.4;
}

.alert-text {
  font-size: 12px;
  color: #64748b;
  margin: 0;
  line-height: 1.4;
}



/* === Badge stato scadenza === */
.expiry-item {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
}

.expiry-item:last-child {
  border-bottom: none;
}

.expiry-text {
  font-size: 13px;
  color: #334155;
  font-weight: 500;
}

.badge-expiry {
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  white-space: nowrap;
}

.badge-dangerous {
  background: #fee2e2;
  color: #dc2626;
}

.badge-warning {
  background: #fef3c7;
  color: #d97706;
}

.badge-safe {
  background: #dcfce7;
  color: #16a34a;
}


/* === CARD RIEPILOGO DI OGGI (identica a temperatura) === */
.nutrition-card {
  width: 100%;
  margin: 0 auto 16px auto;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 14px;
  border: 1px solid rgba(148, 163, 184, 0.2);
  box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
  display: flex;
  flex-direction: column;
  gap: 10px;
  box-sizing: border-box;
  font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
}

/* HEADER: icona + testo */
.nutrition-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

/* Sinistra */
.nutrition-card-left {
  display: flex;
  align-items: center;
}

/* Icona verde */
.nutrition-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 12px;
  background-image: linear-gradient(135deg, #86efac, #22c55e);
  color: #ffffff;
  flex-shrink: 0;
}

.nutrition-icon svg {
  width: 18px;
  height: 18px;
  color: white;
}

.nutrition-label {
  font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif !important;
  font-size: 14px !important;  /* ðŸ‘ˆ Grande */
  font-weight: 600 !important;  /* ðŸ‘ˆ Grassetto */
  color: #1e293b !important;  /* ðŸ‘ˆ Scuro */
  margin: 0 0 4px 0;
  line-height: 1.4;
}


/* "1,450 / 2,000 kcal" - PICCOLA COME "Cerca le tue preferite" */
.nutrition-subtitle {
  font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
  font-size: 10px;  /* ðŸ‘ˆ Uguale a .feature-subtitle */
  font-weight: 400;  /* ðŸ‘ˆ Uguale a .feature-subtitle */
  color: #6b7280;  /* ðŸ‘ˆ Uguale a .feature-subtitle */
  margin: 2px 0 0 0;
  line-height: 1.4;
}

/* Barra progresso verde */
.nutrition-progress {
  width: 100%;
  height: 5px;
  border-radius: 9999px;
  background-color: rgba(148, 163, 184, 0.15);
  overflow: hidden;
}

.nutrition-progress-bar {
  height: 100%;
  border-radius: 9999px;
  background-image: linear-gradient(90deg, #86efac, #22c55e);
  transition: width 0.3s ease;
}

/* Griglia macronutrienti */
.nutrition-macros {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
  margin-top: 4px;
}

.nutrition-macro-item {
  text-align: center;
  padding: 4px 2px;
}

.macro-label {
  font-size: 10px;
  color: #64748b;
  margin: 0 0 2px 0;
  font-weight: 500;
}

.macro-value {
  font-size: 12px;
  color: #1e293b;
  font-weight: 600;
  margin: 0;
}


/* === TITOLI SEZIONI HOME === */
.section-card-title {
  font-size: 17px;
  font-weight: 700;
  color: #1f2937;
  margin: 0 0 12px 0;
  letter-spacing: -0.3px;
  font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
}

.section-card-title:not(:first-child) {
  margin-top: 24px;  /* Spazio sopra se non Ã¨ il primo elemento */
}


/* ========== FUNZIONI INTELLIGENTI & UTILI ========== */

/* Font Inter solo per questa sezione */
.main-features,
.main-features * {
  font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
}

.main-features {
  margin-top: 24px;  /* ðŸ‘ˆ PiÃ¹ spazio sopra (era 16px) */
  margin-bottom: 24px;
}

.main-features-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;  /* ðŸ‘ˆ PiÃ¹ spazio sotto titolo (era 8px) */
}

.main-features-header h2 {
  font-size: 17px;  /* ðŸ‘ˆ Titolo un po' piÃ¹ grande */
  font-weight: 700;
  color: #1f2937;  /* ðŸ‘ˆ Grigio piÃ¹ scuro */
  margin: 0;
  letter-spacing: -0.3px;
}

/* Griglia 2x2 */
.smart-features-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

.smart-feature-item {
  background: rgba(255, 255, 255, 0.95);  /* ðŸ‘ˆ PiÃ¹ opaco */
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 16px;  /* ðŸ‘ˆ Angoli un po' meno arrotondati */
  padding: 16px;
  text-align: left;  /* ðŸ‘ˆ TESTO A SINISTRA (era center) */
  cursor: pointer;
  transition: all 0.3s ease;
}

.smart-feature-item:hover {
  transform: translateY(-2px);  /* ðŸ‘ˆ Movimento piÃ¹ leggero */
  box-shadow: 0 8px 20px rgba(14, 165, 233, 0.15);
}

/* Effetto vetro aggiuntivo */
.frosted-card {
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid rgba(148, 163, 184, 0.15);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}

.ice-shadow {
  box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
}

  
/* Card con immagine di sfondo */
.smart-feature-item.with-bg-image {
    position: relative;
    overflow: hidden;
}

.smart-feature-item.with-bg-image::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: url('img/trova ricette.png');
    background-size: 100% 100%;
    background-position: center;
    background-repeat: no-repeat;
    opacity: 0.80;
    filter: blur(0.5px);
    transition: all 0.3s ease;
    z-index: 0;
}

.smart-feature-item.with-bg-image:hover::before,
.smart-feature-item.with-bg-image:active::before {
    opacity: 1;
    filter: blur(0px);
}

.smart-feature-item.with-bg-image > * {
    position: relative;
    z-index: 1;
}

/* Testo leggibile su immagine */
.smart-feature-item.with-bg-image .feature-title,
.smart-feature-item.with-bg-image .feature-subtitle {
    padding: 4px 10px;
    border-radius: 8px;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    display: inline-block;
    box-shadow: 0 2px 8px rgba(255, 255, 255, 0.5);
}

.smart-feature-item.with-bg-image .feature-title {
    background: rgba(255, 255, 255, 0.7);
    color: #1e293b;
    margin-bottom: 6px;
}

.smart-feature-item.with-bg-image .feature-subtitle {
    background: rgba(255, 255, 255, 0.5);
    color: #1e293b;
}
  
/* Vignette icone */
.feature-icon-box {
  width: 56px;  /* ðŸ‘ˆ PiÃ¹ grandi (era 48px) */
  height: 56px;
  border-radius: 16px;  /* ðŸ‘ˆ PiÃ¹ arrotondato */
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 0 12px 0;  /* ðŸ‘ˆ A sinistra, non centrato */
  transition: transform 0.3s ease;
}

.smart-feature-item:hover .feature-icon-box {
  transform: scale(1.05);  /* ðŸ‘ˆ Zoom piÃ¹ leggero */
}

.feature-icon-box svg {
  width: 28px;  /* ðŸ‘ˆ Icone piÃ¹ grandi */
  height: 28px;
  color: white;
}

/* Immagine AI dentro la vignetta */
.ai-logo-img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  border-radius: 16px;
  display: block;
}

/* Testi card */
.feature-title {
  font-size: 15px;  /* ðŸ‘ˆ Titolo piÃ¹ grande */
  font-weight: 600;
  color: #111827;  /* ðŸ‘ˆ Nero piÃ¹ scuro */
  margin: 0 0 4px 0;
  font-family: Inter, sans-serif;
  letter-spacing: -0.2px;
}

.feature-subtitle {
  font-size: 12px;  /* ðŸ‘ˆ Sottotitolo piÃ¹ grande */
  color: #6b7280;  /* ðŸ‘ˆ Grigio medio */
  margin: 0;
  font-weight: 400;
  font-family: Inter, sans-serif;
  line-height: 1.4;
}

/* Gradienti vignette */
.gradient-recipes {
  background: linear-gradient(135deg, #f59e0b, #f97316);
}

.gradient-scan {
  background: linear-gradient(135deg, #10b981, #22c55e);  /* ðŸ‘ˆ Verde come nell'immagine */
}

.gradient-ai {
  background: linear-gradient(135deg, #06b6d4, #0ea5e9);  /* ðŸ‘ˆ Azzurro/turchese */
}

.gradient-trophies {
  background: linear-gradient(135deg, #eab308, #f59e0b);
}

@media (max-width: 480px) {
  .smart-features-grid {
    grid-template-columns: 1fr 1fr;
  }
  
  .feature-icon-box {
    width: 48px;
    height: 48px;
  }
  
  .feature-icon-box svg {
    width: 24px;
    height: 24px;
  }
}  


/* === CARD EFFICIENZA ENERGETICA === */
.energy-smart-card {
  width: 100%;
  margin: 0 auto 16px auto;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 14px;
  border: 1px solid rgba(148, 163, 184, 0.2);
  box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
  display: flex;
  flex-direction: column;
  gap: 12px;
  box-sizing: border-box;
  font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
}

.energy-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.energy-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.energy-icon-box {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  background-image: linear-gradient(135deg, #fbbf24, #f59e0b);
  color: #ffffff;
  flex-shrink: 0;
}

.energy-icon-box i {
  font-size: 18px;
}

.energy-title {
  font-size: 14px;
  font-weight: 600;
  color: #1e293b;
  margin: 0 0 4px 0;
  line-height: 1.4;
}

.energy-subtitle {
  font-size: 10px;
  font-weight: 400;
  color: #6b7280;
  margin: 0;
  line-height: 1.4;
}

.energy-badge-pill {
  display: inline-flex;
  align-items: center;
  padding: 3px 8px;
  border-radius: 9999px;
  font-size: 11px;
  font-weight: 600;
  background-color: #d1fae5;
  color: #065f46;
  white-space: nowrap;
}

.energy-dot {
  width: 5px;
  height: 5px;
  border-radius: 9999px;
  background-color: #10b981;
  margin-right: 5px;
}

.energy-content {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  gap: 16px;
}

.energy-bars {
  display: flex;
  align-items: flex-end;
  gap: 4px;
  flex: 1;
  height: 60px;
}

.energy-bar {
  width: 8px;
  background: linear-gradient(180deg, #4ade80, #22c55e);
  border-top-left-radius: 3px;
  border-top-right-radius: 3px;
  transition: all 0.3s ease;
}

.energy-grade {
  text-align: right;
  flex-shrink: 0;
}

.grade-value {
  font-size: 28px;
  font-weight: 700;
  color: #16a34a;
  margin: 0;
  line-height: 1;
}

.grade-label {
  font-size: 10px;
  color: #64748b;
  margin: 4px 0 0 0;
  font-weight: 500;
}

/* === RESPONSIVE === */
@media (max-width: 480px) {
  .energy-bars {
    height: 50px;
    gap: 3px;
  }
  
  .energy-bar {
    width: 6px;
  }
  
  .grade-value {
    font-size: 24px;
  }
}

/* === SCROLLBAR MODERNA MESSAGGI FROSTY === */

#frosty-messages {
  overflow-y: auto;
  overflow-x: hidden;
}

/* WEBKIT (Chrome, Safari, Edge) */
#frosty-messages::-webkit-scrollbar {
  width: 10px;
}

#frosty-messages::-webkit-scrollbar-track {
  background: rgba(15, 23, 42, 0.6);
  border-radius: 10px;
  margin: 4px 0;
}

#frosty-messages::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #0e7490, #075985);
  border-radius: 10px;
  border: 2px solid rgba(15, 23, 42, 0.6);
  transition: all 0.3s ease;
}

#frosty-messages::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(180deg, #0891b2, #0369a1);
  border-color: rgba(6, 182, 212, 0.4);
  box-shadow: 0 0 8px rgba(6, 182, 212, 0.3);
}

#frosty-messages::-webkit-scrollbar-thumb:active {
  background: linear-gradient(180deg, #164e63, #0c4a6e);
}

/* FIREFOX */
#frosty-messages {
  scrollbar-width: thin;
  scrollbar-color: #0e7490 rgba(15, 23, 42, 0.6);
}


/* === CAMPANELLA + PROFILO IN ALTO A DESTRA === */
.top-right-actions {
  position: fixed;
  top: 16px;
  right: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 10001;
}

/* Campanella bianca circolare */
.bell-btn {
  width: 40px;
  height: 40px;
  min-width: 40px;
  min-height: 40px;
  border-radius: 50%;
  background: #ffffff;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
  padding: 0;
  transition: transform 0.2s ease;
}

.bell-btn:active {
  transform: scale(0.92);
}

.bell-btn i {
  font-size: 18px;
  color: #374151;
}

/* Profilo circolare */
.profile-circle {
  width: 40px;
  height: 40px;
  min-width: 40px;
  min-height: 40px;
  border-radius: 50%;
  overflow: hidden;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
  transition: transform 0.2s ease;
  border: 2px solid #ffffff;
}

.profile-circle:active {
  transform: scale(0.92);
}

.profile-circle img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* Mobile */
@media (max-width: 480px) {
  .top-right-actions {
    top: 12px;
    right: 12px;
    gap: 8px;
  }
  
  .bell-btn,
  .profile-circle {
    width: 36px;
    height: 36px;
    min-width: 36px;
    min-height: 36px;
  }
  
  .bell-btn i {
    font-size: 16px;
  }
}  

/* âœ… SEZIONE ASSISTENTE FULLSCREEN */
#assistente {
  display: none !important;
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100% !important;
  height: 100vh !important;
  z-index: 999999 !important;
  background: #0f1419 !important;
  flex-direction: column !important;
  overflow: hidden !important;
}

#assistente.active {
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
}

/* ðŸ“± RESPONSIVE MOBILE */
@media (max-width: 768px) {
  #assistente {
    height: 100vh !important;
    width: 100% !important;
  }
}

@media (max-width: 480px) {
  #assistente {
    height: 100vh !important;
    width: 100% !important;
  }
}


/* âœ… QUANDO ASSISTENTE Ãˆ ATTIVO */
#assistente.active {
  z-index: 999999 !important;
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100% !important;
  height: 100vh !important;
  display: flex !important;
  flex-direction: column !important;
  background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%) !important;
}

/* Nascondi navbar, header, sidebar quando assistente attivo */
body:has(#assistente.active) nav,
body:has(#assistente.active) header,
body:has(#assistente.active) .navbar-container,
body:has(#assistente.active) .top-right-actions,
body:has(#assistente.active) aside {
  z-index: 1 !important;
  pointer-events: none !important;
  opacity: 0 !important;
}

#assistente.active {
  display: flex !important;
}

#assistente > header {
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
  position: relative !important;
  background: #0f172a !important;
  padding: 16px !important;
  min-height: 60px !important;
  z-index: 99999 !important;
  justify-content: space-between !important;
  align-items: center !important;
}

#assistente > header button {
  pointer-events: auto !important;
  cursor: pointer !important;
  z-index: 999999 !important;
}


@keyframes float {
  0%, 100% {
    transform: translateY(0px);
  }
  50% {
    transform: translateY(-12px);
  }
}

@keyframes float-glow {
  0%, 100% {
    transform: translate(-50%, -50%) translateY(0px);
    opacity: 0.8;
  }
  50% {
    transform: translate(-50%, -50%) translateY(-12px);
    opacity: 1;
  }
}

/* Luce che si muove - PIÃ™ INTENSA */
@keyframes move-light {
  0%, 100% {
    filter: blur(40px) drop-shadow(15px 0 20px rgba(6, 182, 212, 0.5));
  }
  25% {
    filter: blur(40px) drop-shadow(0 15px 20px rgba(6, 182, 212, 0.5));
  }
  50% {
    filter: blur(40px) drop-shadow(-15px 0 20px rgba(6, 182, 212, 0.5));
  }
  75% {
    filter: blur(40px) drop-shadow(0 -15px 20px rgba(6, 182, 212, 0.5));
  }
}

@keyframes orbPulse {
  0%, 100% {
    opacity: 0.600089;
    transform: translate(-50%, -50%) scale(0.8321);
  }
  50% {
    opacity: 0.999993;
    transform: translate(-50%, -50%) scale(1.0903);
  }
}


@keyframes blink-eyes {
  0%, 45%, 55%, 100% {
    height: 20px;
    opacity: 1;
  }
  50% {
    height: 2px;
    opacity: 0.8;
  }
}

/* Animazione pulsante microfono quando registra */
@keyframes micPulse {
    0%, 100% { box-shadow: 0 0 15px rgba(248,113,113,0.5); }
    50% { box-shadow: 0 0 25px rgba(248,113,113,0.8); }
}

.mic-recording {
    animation: micPulse 1s ease-in-out infinite !important;
}

/* Hover per camera e microfono */
#frosty-camera-btn:hover {
    color: #67e8f9 !important;
    background: rgba(34,211,238,0.15) !important;
}

#frosty-mic-btn:hover:not(.mic-recording) {
    color: #06b6d4 !important;
    background: rgba(6,182,212,0.15) !important;
}

/* Centra Frosty - TUTTI GLI SCHERMI */
#assistente {
  width: 100vw !important;
}

#assistente > main {
  flex: 1 !important;
  display: flex !important;
  flex-direction: column !important;
  width: 100% !important;
  max-width: 100vw !important;
}

#frosty-messages {
  width: 100% !important;
  max-width: 100vw !important;
  flex: 1 !important;
  display: flex !important;
  flex-direction: column !important;
  justify-content: flex-start !important;
  align-items: center !important;
  position: relative !important;
  overflow-y: auto !important;
}

#frosty-welcome {
  position: relative !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  text-align: center !important;
}

.orb-container {
  display: flex !important;
  justify-content: center !important;
}

/* Animazione nebulosa per bottone invia */
@keyframes nebulaMove {
  0% {
    background-position: 0% 0%;
  }
  25% {
    background-position: 100% 0%;
  }
  50% {
    background-position: 100% 100%;
  }
  75% {
    background-position: 0% 100%;
  }
  100% {
    background-position: 0% 0%;
  }
}

#frosty-send-btn.active {
  background: linear-gradient(135deg, 
    #0a0a1a 0%, 
    #1a0a2e 10%,
    #0d3d4d 25%, 
    #06b6d4 35%,
    #1a0a2e 50%,
    #4a1a1a 65%,
    #8b2020 75%,
    #1a0a2e 90%,
    #0a0a1a 100%) !important;
  background-size: 400% 400% !important;
  animation: nebulaMove 6s ease infinite !important;
  color: white !important;
  cursor: pointer !important;
  box-shadow: 0 0 15px rgba(6, 182, 212, 0.4), 0 0 25px rgba(139, 32, 32, 0.3) !important;
  border: none !important;
}

/* Menu popup hover */
#frosty-menu-popup button:hover {
    background: rgba(6, 182, 212, 0.15) !important;
}

#frosty-menu-btn:hover {
    color: #94a3b8 !important;
    background: rgba(255,255,255,0.05) !important;
}

/* === BOTTONE INVIO CON IMMAGINE DI SFONDO === */

#frosty-send-btn {
  /* Mantieni tutte le proprietÃ  esistenti */
  position: relative;
  overflow: hidden;
  
  /* Immagine di sfondo - PERCORSO CORRETTO */
  background-image: url('img/1.jpg') !important;
  background-size: cover !important;
  background-position: center !important;
  background-repeat: no-repeat !important;
  
  /* Overlay scuro per leggibilitÃ  icona */
  background-color: transparent !important;
}

/* Overlay scuro sopra l'immagine per mantenere visibile l'icona */
#frosty-send-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(15, 23, 42, 0.4); /* Overlay scuro al 40% */
  pointer-events: none; /* Non blocca i click */
  z-index: 0;
}

/* Assicura che l'icona stia sopra lo sfondo */
#frosty-send-btn i,
#frosty-send-btn svg,
#frosty-send-btn * {
  position: relative;
  z-index: 1;
}

/* Stato ATTIVO - Mantieni animazione nebulosa SOPRA l'immagine */
#frosty-send-btn.active {
  background-image: url('img/1.jpg') !important;
  background-size: cover !important;
  background-position: center !important;
  animation: nebulaMove 6s ease infinite !important;
  box-shadow: 0 0 15px rgba(6, 182, 212, 0.4), 0 0 25px rgba(139, 32, 32, 0.3) !important;
}

/* Overlay piÃ¹ luminoso nello stato attivo */
#frosty-send-btn.active::before {
  background: linear-gradient(135deg, 
    rgba(10, 10, 26, 0.6) 0%, 
    rgba(26, 10, 46, 0.5) 10%,
    rgba(13, 61, 77, 0.4) 25%, 
    rgba(6, 182, 212, 0.3) 35%,
    rgba(26, 10, 46, 0.5) 50%,
    rgba(74, 26, 26, 0.4) 65%,
    rgba(139, 32, 32, 0.3) 75%,
    rgba(26, 10, 46, 0.5) 90%,
    rgba(10, 10, 26, 0.6) 100%) !important;
  background-size: 400% 400% !important;
  animation: nebulaMove 6s ease infinite !important;
}

/* Hover - Leggero zoom sull'immagine */
#frosty-send-btn:hover:not(.active) {
  transform: scale(1.05);
  box-shadow: 0 0 20px rgba(6, 182, 212, 0.5);
}

#frosty-send-btn:hover:not(.active)::before {
  background: rgba(15, 23, 42, 0.3); /* PiÃ¹ trasparente al hover */
}

/* Quando ci sono messaggi, allinea in alto */
#frosty-chat-list {
  width: 100% !important;
  padding-bottom: 20px !important;
}

/* Welcome screen centrato */
#frosty-welcome {
  margin: auto !important;
}

/* Animazione click profilo e campanella */
.profile-circle:active,
.bell-btn:active {
    transform: scale(0.85) !important;
    transition: transform 0.1s ease !important;
}

.profile-circle,
.bell-btn {
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease !important;
}

.profile-circle:hover,
.bell-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
}

/* ========== SEZIONE PROFILO ========== */
#profilo-section {
    position: fixed;
    top: 0;
    right: -100%;
    width: 100%;
    max-width: 400px;
    height: 100vh;
    background: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
    z-index: 100000;
    transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    box-shadow: -5px 0 30px rgba(0, 0, 0, 0.2);
    overflow-y: auto;
}

#profilo-section.open {
    right: 0;
}

/* Overlay profilo */
#profilo-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    z-index: 99999;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

#profilo-overlay.open {
    opacity: 1;
    visibility: visible;
}

/* ========== SEZIONE NOTIFICHE ========== */
#notifiche-section {
    position: fixed;
    top: -100%;
    left: 0;
    width: 100%;
    height: auto;
    max-height: 80vh;
    background: linear-gradient(180deg, #ffffff 0%, #f1f5f9 100%);
    z-index: 100000;
    transition: top 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    box-shadow: 0 5px 30px rgba(0, 0, 0, 0.2);
    border-radius: 0 0 24px 24px;
    overflow-y: auto;
}

#notifiche-section.open {
    top: 0;
}

/* Overlay notifiche */
#notifiche-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    z-index: 99999;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

#notifiche-overlay.open {
    opacity: 1;
    visibility: visible;
}

/* Toggle Switch Preferenze */
.toggle-switch {
    width: 52px;
    height: 28px;
    background: #cbd5e1;
    border-radius: 28px;
    position: relative;
    cursor: pointer;
    transition: background 0.3s ease;
}

.toggle-switch[data-active="true"] {
    background: #06b6d4;
}

.toggle-switch .toggle-slider {
    position: absolute;
    top: 3px;
    left: 3px;
    width: 22px;
    height: 22px;
    background: white;
    border-radius: 50%;
    transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.toggle-switch[data-active="true"] .toggle-slider {
    transform: translateX(24px);
}

.toggle-switch:active .toggle-slider {
    width: 26px;
}

.toggle-switch[data-active="true"]:active .toggle-slider {
    transform: translateX(20px);
}

/* Disabilita zoom e selezione */
html, body {
    touch-action: manipulation;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
    overscroll-behavior: none;
}

input, textarea {
    font-size: 16px !important; /* Previene zoom automatico su iOS */
    touch-action: manipulation;
}

/* Footer Assistente - si alza con tastiera */
#assistente footer {
    position: fixed !important;
    bottom: 0 !important;
    left: 0 !important;
    right: 0 !important;
    z-index: 1000 !important;
    transition: transform 0.3s ease !important;
    -webkit-transition: transform 0.3s ease !important;
}

/* Quando tastiera Ã¨ aperta */
#assistente.keyboard-open footer {
    transform: translateY(calc(-1 * var(--keyboard-height, 0px))) !important;
    -webkit-transform: translateY(calc(-1 * var(--keyboard-height, 0px))) !important;
}


/* ========== RESPONSIVE FIXES ========== */

/* Mobile: max 768px */
@media (max-width: 768px) {
    body {
        padding: 8px !important;
        padding-bottom: 100px !important;
    }
    
    /* Navbar mobile */
    .navbar {
        width: calc(100vw - 20px) !important;
        max-width: 100% !important;
        padding: 6px 10px !important;
    }
    
    .navbar-container {
        padding: 8px 10px calc(10px + env(safe-area-inset-bottom, 0px)) !important;
    }
    
    .nav-item {
        flex: 0 0 auto !important;
        min-width: 50px !important;
        max-width: 60px !important;
        padding: 6px 8px !important;
    }
    
    .nav-item.frigo {
        padding: 8px 10px !important;
        margin: 0 6px !important;
    }
    
    .nav-label {
        font-size: 10px !important;
    }
    
    .nav-icon {
        width: 22px !important;
        height: 22px !important;
    }
    
    .nav-group {
        gap: 6px !important;
    }
    
    /* Sezioni mobile */
    section {
        padding: 10px !important;
        border-radius: 10px !important;
        margin-bottom: 8px !important;
    }
    
    /* Card temperatura mobile */
    #home .card-temp {
        padding: 12px !important;
    }
    
    /* Header mobile */
    header {
        padding: 0 4px !important;
    }
    
    h1 {
        font-size: 16px !important;
    }
    
    h2 {
        font-size: 18px !important;
    }
    
    /* Bottoni campanella e profilo */
    #topActionsDiv {
        top: 8px !important;
        right: 8px !important;
        gap: 6px !important;
    }
    
    #topActionsDiv button {
        width: 32px !important;
        height: 32px !important;
    }
}

/* Mobile piccolo: max 380px */
@media (max-width: 380px) {
    .navbar {
        width: calc(100vw - 16px) !important;
        padding: 5px 8px !important;
    }
    
    .nav-item {
        min-width: 45px !important;
        max-width: 50px !important;
        padding: 5px 6px !important;
    }
    
    .nav-label {
        font-size: 9px !important;
    }
    
    .nav-icon {
        width: 20px !important;
        height: 20px !important;
    }
    
    .nav-group {
        gap: 4px !important;
    }
    
    .nav-item.frigo {
        padding: 6px 8px !important;
        margin: 0 4px !important;
    }
}

/* Assistente Frosty - mobile */
@media (max-width: 768px) {
    #assistente main {
        padding-bottom: 80px !important;
    }
    
    #assistente footer {
        padding: 8px 12px calc(8px + env(safe-area-inset-bottom, 0px)) !important;
    }
    
    #frosty-input {
        font-size: 16px !important; /* Previene zoom iOS */
    }
}

/* Pannelli profilo/preferenze - mobile */
@media (max-width: 768px) {
    #profilo-section,
    #modifica-profilo-panel,
    #preferenze-panel,
    #aiuto-panel,
    #privacy-panel,
    #terms-panel {
        max-width: 100% !important;
        width: 100% !important;
    }
}

/* Notifiche - mobile */
@media (max-width: 768px) {
    #notifiche-section {
        max-height: 85vh !important;
        border-radius: 0 0 20px 20px !important;
    }
}

/* Tablet: 769px - 1024px */
@media (min-width: 769px) and (max-width: 1024px) {
    .navbar {
        width: 450px !important;
    }
    
    main {
        max-width: 720px !important;
    }
}

/* Desktop: 1025px+ */
@media (min-width: 1025px) {
    .navbar {
        width: 480px !important;
    }
    
    main {
        max-width: 900px !important;
    }
    
    #profilo-section,
    #notifiche-section {
        max-width: 400px !important;
    }
}


/* Fix iOS Safari - safe area */
@supports (padding-bottom: env(safe-area-inset-bottom)) {
    #assistente footer {
        padding-bottom: calc(10px + env(safe-area-inset-bottom)) !important;
    }
    
    .navbar-container {
        padding-bottom: calc(14px + env(safe-area-inset-bottom)) !important;
    }
}

/* Fix iOS input zoom */
input, textarea, select {
    font-size: 16px !important;
}

/* ========== FABBISOGNO - RIEPILOGO CARD ========== */
.fabbisogno-card {
    background: linear-gradient(135deg, #d1fae5 0%, #ccfbf1 50%, #ffffff 100%);
    border-radius: 28px;
    padding: 20px;
    box-shadow: 0 20px 50px rgba(16, 185, 129, 0.15);
    border: 1px solid rgba(16, 185, 129, 0.1);
    position: relative;
    overflow: hidden;
}

.fabbisogno-blur-1 {
    position: absolute;
    top: -40px;
    right: -40px;
    width: 150px;
    height: 150px;
    background: rgba(16, 185, 129, 0.25);
    border-radius: 50%;
    filter: blur(50px);
    pointer-events: none;
}

.fabbisogno-blur-2 {
    position: absolute;
    bottom: -20px;
    left: -20px;
    width: 120px;
    height: 120px;
    background: rgba(20, 184, 166, 0.2);
    border-radius: 50%;
    filter: blur(40px);
    pointer-events: none;
}

.fabbisogno-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    position: relative;
    z-index: 1;
}

.fabbisogno-title {
    font-size: 18px;
    font-weight: 700;
    color: #134e4a;
    margin: 0;
}

.fabbisogno-btn-calc {
    display: flex;
    align-items: center;
    gap: 4px;
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: none;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    color: #0f766e;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: all 0.2s;
}

.fabbisogno-btn-calc:hover {
    background: white;
    transform: translateY(-1px);
}

/* Grafico Donut */
.donut-container {
    position: relative;
    width: 180px;
    height: 180px;
    margin: 12px auto;
}

.donut-chart {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.donut-ring {
    fill: none;
    stroke: rgba(255, 255, 255, 0.6);
    stroke-width: 14;
}

.donut-segment {
    fill: none;
    stroke: #10b981;
    stroke-width: 14;
    stroke-linecap: round;
    transition: stroke-dasharray 0.6s ease, stroke 0.3s ease;
}

.donut-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.donut-value-row {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 2px;
}

.donut-value {
    font-size: 28px;
    font-weight: 800;
    color: #1e293b;
    line-height: 1;
}

.donut-separator {
    font-size: 18px;
    font-weight: 600;
    color: #94a3b8;
}

.donut-total {
    font-size: 18px;
    font-weight: 600;
    color: #94a3b8;
}

.donut-label {
    font-size: 10px;
    font-weight: 700;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-top: 6px;
}

/* Bottone Dettagli */
.dettagli-btn-container {
    display: flex;
    justify-content: center;
    margin: 12px 0 20px 0;
    position: relative;
    z-index: 1;
}

.dettagli-btn {
    display: flex;
    align-items: center;
    gap: 4px;
    background: transparent;
    border: none;
    color: rgba(15, 118, 110, 0.6);
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    cursor: pointer;
    padding: 6px 12px;
    transition: all 0.2s;
}

.dettagli-btn:hover {
    color: #0f766e;
}

.dettagli-btn svg {
    transition: transform 0.2s;
}

.dettagli-btn:hover svg {
    transform: translateY(2px);
}

/* Macros Row Nuova */
.macros-row-new {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0;
    padding-top: 20px;
    border-top: 1px solid rgba(15, 118, 110, 0.08);
    position: relative;
    z-index: 1;
}

.macro-item-new {
    display: flex;
    flex-direction: column;
    padding: 0 12px;
    border-right: 1px solid rgba(15, 118, 110, 0.08);
}

.macro-item-new:last-child {
    border-right: none;
}

.macro-label-new {
    font-size: 10px;
    font-weight: 700;
    color: rgba(15, 118, 110, 0.6);
    text-transform: uppercase;
    letter-spacing: 1px;
    text-align: center;
    margin-bottom: 6px;
}

.macro-values-row {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 4px;
    margin-bottom: 8px;
}

.macro-current {
    font-size: 14px;
    font-weight: 700;
    color: #134e4a;
}

.macro-separator {
    font-size: 12px;
    font-weight: 600;
    color: rgba(15, 118, 110, 0.5);
}

.macro-progress-bar {
    height: 6px;
    background: rgba(15, 118, 110, 0.08);
    border-radius: 10px;
    overflow: hidden;
}

.macro-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #14b8a6, #10b981);
    border-radius: 10px;
    transition: width 0.5s ease;
}

/* ========== ANIMAZIONI FABBISOGNO ========== */

/* Animazione Donut all'ingresso */
@keyframes donutFill {
    from {
        stroke-dasharray: 0 251.2;
    }
}

@keyframes donutFadeIn {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes macroBarFill {
    from {
        width: 0% !important;
    }
}

@keyframes fadeSlideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes countUp {
    from {
        opacity: 0;
        transform: scale(0.5);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* Applicazione animazioni quando sezione attiva */
section#fabbisogno.active .fabbisogno-card {
    animation: fadeSlideUp 0.6s ease-out;
}

section#fabbisogno.active .donut-container {
    animation: donutFadeIn 0.8s ease-out;
}

section#fabbisogno.active .donut-segment {
    animation: donutFill 1.2s ease-out;
}

section#fabbisogno.active .donut-value {
    animation: countUp 0.6s ease-out 0.3s both;
}

section#fabbisogno.active .macro-progress-fill {
    animation: macroBarFill 0.8s ease-out 0.4s both;
}

section#fabbisogno.active .macro-item-new:nth-child(1) {
    animation: fadeSlideUp 0.5s ease-out 0.2s both;
}

section#fabbisogno.active .macro-item-new:nth-child(2) {
    animation: fadeSlideUp 0.5s ease-out 0.3s both;
}

section#fabbisogno.active .macro-item-new:nth-child(3) {
    animation: fadeSlideUp 0.5s ease-out 0.4s both;
}

/* Animazione blur decorativi */
@keyframes blurPulse {
    0%, 100% {
        opacity: 0.6;
        transform: scale(1);
    }
    50% {
        opacity: 0.8;
        transform: scale(1.1);
    }
}

section#fabbisogno.active .fabbisogno-blur-1,
section#fabbisogno.active .fabbisogno-blur-2 {
    animation: blurPulse 4s ease-in-out infinite;
}

/* Altre card con animazione */
section#fabbisogno.active .fabbisogno-calc-card {
    animation: fadeSlideUp 0.6s ease-out 0.1s both;
}

section#fabbisogno.active .ristorante-card {
    animation: fadeSlideUp 0.6s ease-out 0.2s both;
}

section#fabbisogno.active .tracking-card {
    animation: fadeSlideUp 0.6s ease-out 0.3s both;
}

/* ========================================
   RIMUOVI RIQUADRO BIANCO DA FABBISOGNO E ANDAMENTO
   ======================================== */
section#fabbisogno,
section#andamento {
    background: transparent !important;
    box-shadow: none !important;
    border: none !important;
    padding: 8px !important;
    overflow: visible !important;
}

/* Se vuoi rimuoverlo da TUTTE le sezioni */
section {
    background: transparent !important;
    box-shadow: none !important;
    border: none !important;
}

/* ========================================
   NUOVO DESIGN CARD TRACCIA PASTI
   ======================================== */

/* Container ricerca pasti - Frosted Glass */
.meal-search-container {
    position: relative;
    margin-bottom: 16px;
}

.meal-search-container .search-icon-new {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    color: #64748b;
    pointer-events: none;
    z-index: 2;
    transition: color 0.3s ease;
}

.meal-search-container:focus-within .search-icon-new {
    color: #10b981;
}

/* Input ricerca frosted glass */
.meal-search-input {
    width: 100%;
    background: rgba(255, 255, 255, 0.6) !important;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.5) !important;
    border-radius: 16px !important;
    padding: 18px 16px 18px 52px !important;
    font-size: 15px !important;
    font-weight: 500;
    color: #1e293b !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    transition: all 0.3s ease !important;
}

.meal-search-input::placeholder {
    color: #94a3b8;
}

.meal-search-input:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
}

.meal-search-input:focus {
    background: rgba(255, 255, 255, 0.8) !important;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    outline: none !important;
    border-color: rgba(16, 185, 129, 0.3) !important;
}

/* Bottone Aggiungi Pasto - Design moderno */
.btn-add-meal-new {
    width: 100%;
    position: relative;
    overflow: hidden;
    background: linear-gradient(135deg, #10b981 0%, #0d9488 100%);
    color: white;
    border: none !important;
    border-radius: 16px !important;
    padding: 18px 24px !important;
    font-size: 15px !important;
    font-weight: 600;
    letter-spacing: 0.3px;
    cursor: pointer;
    box-shadow: 0 8px 20px -6px rgba(16, 185, 129, 0.4);
    transition: all 0.3s ease !important;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-top: 12px;
}

.btn-add-meal-new:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 24px -8px rgba(16, 185, 129, 0.5);
}

.btn-add-meal-new:active {
    transform: scale(0.98);
}

.btn-add-meal-new:disabled {
    background: #e2e8f0 !important;
    color: #94a3b8 !important;
    cursor: not-allowed;
    box-shadow: none !important;
    transform: none !important;
}

.btn-add-meal-new .btn-icon-new {
    background: rgba(255, 255, 255, 0.2);
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease;
}

.btn-add-meal-new:hover .btn-icon-new {
    transform: translateX(4px);
}

/* Shimmer effect */
@keyframes shimmerEffect {
    0% { left: -100%; }
    100% { left: 100%; }
}

.btn-add-meal-new::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    pointer-events: none;
}

.btn-add-meal-new:hover::after {
    animation: shimmerEffect 0.8s ease;
}

/* Nascondi vecchi elementi */
.tracking-card .tracking-date,
.tracking-card .search-box,
.tracking-card .add-meal-row {
    display: none !important;
}

/* Stile per i pasti nella lista */
.pasti-lista .card {
    background: rgba(255, 255, 255, 0.7) !important;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.5) !important;
    border-radius: 12px !important;
    transition: all 0.2s ease;
}

.pasti-lista .card:hover {
    background: rgba(255, 255, 255, 0.85) !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
}

/* Container nuovo tracking */
.new-tracking-ui {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

/* ========================================
   ðŸ†• QUICK ADD SECTION (sotto donut)
   ======================================== */

.quick-add-section {
    margin-top: 20px;
    margin-bottom: 28px;
    padding: 0 4px;
}

/* Barra ricerca frosted grigia */
.quick-add-search-container {
    position: relative;
    margin-bottom: 12px;
}

.quick-add-search-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
    pointer-events: none;
    z-index: 2;
    transition: color 0.3s ease;
}

.quick-add-search-container:focus-within .quick-add-search-icon {
    color: #10b981;
}

.quick-add-search-input {
    width: 100%;
    background: rgba(148, 163, 184, 0.12) !important;
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(148, 163, 184, 0.15) !important;
    border-radius: 14px !important;
    padding: 16px 16px 16px 48px !important;
    font-size: 15px !important;
    font-weight: 500;
    color: #1e293b !important;
    transition: all 0.3s ease !important;
    outline: none !important;
}

.quick-add-search-input::placeholder {
    color: #94a3b8;
}

.quick-add-search-input:hover {
    background: rgba(148, 163, 184, 0.18) !important;
}

.quick-add-search-input:focus {
    background: rgba(148, 163, 184, 0.22) !important;
    border-color: rgba(16, 185, 129, 0.4) !important;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.08);
}

/* Bottone Aggiungi moderno */
.quick-add-btn {
    width: 100%;
    position: relative;
    overflow: hidden;
    background: linear-gradient(135deg, #064e3b 0%, #166534 50%, #22c55e 100%);
    color: white;
    border: none !important;
    border-radius: 14px !important;
    padding: 16px 24px !important;
    font-size: 15px !important;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(6, 78, 59, 0.3), 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.quick-add-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(6, 78, 59, 0.4), 0 4px 8px rgba(0, 0, 0, 0.15);
}

.quick-add-btn:active {
    transform: translateY(-1px) scale(0.98);
    box-shadow: 0 4px 12px rgba(6, 78, 59, 0.3);
}

.quick-add-btn-icon {
    background: rgba(255, 255, 255, 0.25);
    width: 26px;
    height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}

.quick-add-btn:hover .quick-add-btn-icon {
    background: rgba(255, 255, 255, 0.35);
    transform: scale(1.1);
}

/* ========================================
   BOTTONI GEMELLI RICETTE
   ======================================== */
.recipe-buttons-row {
    display: flex;
    gap: 10px;
    margin-top: 12px;
}

.recipe-twin-btn {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: linear-gradient(135deg, #065f46 0%, #059669 50%, #34d399 100%);
    color: white;
    border: none !important;
    border-radius: 12px !important;
    padding: 14px 16px !important;
    font-size: 13px !important;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3), 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.recipe-twin-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4), 0 4px 8px rgba(0, 0, 0, 0.15);
}

.recipe-twin-btn:active {
    transform: translateY(-1px) scale(0.98);
    box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
}

.recipe-twin-btn-icon {
    background: rgba(255, 255, 255, 0.25);
    width: 26px;
    height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}

.recipe-twin-btn:hover .recipe-twin-btn-icon {
    background: rgba(255, 255, 255, 0.35);
    transform: scale(1.1);
}

/* Bottone con immagine di sfondo */
.recipe-twin-btn.with-bg-image {
    background: linear-gradient(135deg, rgba(6, 95, 70, 0.85) 0%, rgba(5, 150, 105, 0.85) 50%, rgba(52, 211, 153, 0.85) 100%);
    background-size: cover;
    background-position: center;
    position: relative;
}

.recipe-twin-btn.with-bg-image::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: url('img/trova ricette.png');
    background-size: cover;
    background-position: center;
    border-radius: 12px;
    z-index: 0;
    opacity: 0.3;
    transition: opacity 0.25s ease;
}

.recipe-twin-btn.with-bg-image:hover::before {
    opacity: 0.45;
}

.recipe-twin-btn.with-bg-image > * {
    position: relative;
    z-index: 1;
}  

/* Bottone Le Mie Ricette con immagine di sfondo */
.recipe-twin-btn.with-bg-image-mie {
    background: linear-gradient(135deg, rgba(6, 95, 70, 0.85) 0%, rgba(5, 150, 105, 0.85) 50%, rgba(52, 211, 153, 0.85) 100%);
    background-size: cover;
    background-position: center;
    position: relative;
}

.recipe-twin-btn.with-bg-image-mie::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: url('img/lemiericette.png');
    background-size: cover;
    background-position: center;
    border-radius: 12px;
    z-index: 0;
    opacity: 0.3;
    transition: opacity 0.25s ease;
}

.recipe-twin-btn.with-bg-image-mie:hover::before {
    opacity: 0.45;
}

.recipe-twin-btn.with-bg-image-mie > * {
    position: relative;
    z-index: 1;
}  
  
/* Icona immagine per secondo bottone */
.recipe-twin-btn-img {
    width: 22px;
    height: 22px;
    object-fit: contain;
    flex-shrink: 0;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}

.recipe-twin-btn:hover .recipe-twin-btn-img {
    transform: scale(1.15);
}

/* ========================================
   SEZIONE RICETTE FULLSCREEN
   ======================================== */
.ricette-fullscreen-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    height: 100dvh;
    z-index: 99999 !important;
    background: linear-gradient(135deg, #fffdfa 0%, #f1f8e9 50%, #fffde7 100%);
    overflow-y: auto;
    overflow-x: hidden;
    display: none;
}

.ricette-fullscreen-wrapper.open {
    display: block;
    animation: slideFromLeft 0.25s ease-out;
}


/* ========================================
   CERCA RICETTE ONLINE - NUOVO DESIGN FOODIE
   ======================================== */

.cerca-ricette-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    height: 100dvh;
    z-index: 9999;
    background-image: url('img/sfondoricette.png');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-color: #EBF2F0;
    overflow-y: auto;
    overflow-x: hidden;
    display: none;
}

.cerca-ricette-wrapper.open {
    display: block;
    animation: slideFromLeft 0.25s ease-out;
}

/* ============================================
   HEADER - BLU SCURO SFUMATO CON OMBRE
   ============================================ */

.cerca-ricette-header {
    position: sticky;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, 
        #0f172a 0%, 
        #1e293b 40%,
        #334155 100%);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 16px 16px 12px 16px;
    z-index: 1001;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    box-shadow: 
        0 4px 20px rgba(15, 23, 42, 0.4),
        0 2px 8px rgba(15, 23, 42, 0.3),
        inset 0 1px 0 rgba(255,255,255,0.05),
        inset 0 -1px 0 rgba(0,0,0,0.2);
    border-bottom: 1px solid rgba(86, 118, 163, 0.3);
}

/* Bottone freccia - Celestino sfumato con ombre */
.cerca-ricette-back-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: linear-gradient(135deg, 
        #94a3b8 0%, 
        #64748b 50%,
        #475569 100%);
    border: none;
    color: #000000;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    box-shadow: 
        0 3px 10px rgba(71, 85, 105, 0.3),
        inset 0 1px 2px rgba(255,255,255,0.2);
}

.cerca-ricette-back-btn:hover {
    background: linear-gradient(135deg, 
        #cbd5e1 0%, 
        #94a3b8 50%,
        #64748b 100%);
    transform: translateY(-2px);
    box-shadow: 
        0 4px 12px rgba(71, 85, 105, 0.35),
        inset 0 1px 2px rgba(255,255,255,0.3);
}

.cerca-ricette-back-btn:active {
    transform: scale(0.95) translateY(0);
    box-shadow: 
        0 2px 6px rgba(71, 85, 105, 0.25),
        inset 0 2px 4px rgba(0,0,0,0.1);
}

/* Titolo centrato */
.cerca-ricette-title {
    font-family: 'Inter', system-ui, sans-serif;
    font-size: 20px;
    font-weight: 700;
    color: #f1f5f9;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    letter-spacing: -0.02em;
}


.cerca-ricette-content {
    padding: 20px 16px 120px 16px;
    max-width: 700px;
    margin: 0 auto;
}

.cerca-ricette-search-box {
    position: relative;
    z-index: 100;
    background: transparent;
    padding: 0;
    margin-bottom: 20px;
}

#searchDropdownResults {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    margin-top: 8px;
    z-index: 1000;
    max-height: 320px;
    overflow-y: auto;
    background: linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(243,244,246,0.95) 100%);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.6);
    border-radius: 20px;
    padding: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.12), 0 8px 20px rgba(0,0,0,0.06);
}

#searchDropdownResults {
    scrollbar-width: thin;
    scrollbar-color: transparent transparent;
}

#searchDropdownResults:hover {
    scrollbar-color: rgba(0,0,0,0.12) transparent;
}

#searchDropdownResults::-webkit-scrollbar {
    width: 4px;
}

#searchDropdownResults::-webkit-scrollbar-track {
    background: transparent;
}

#searchDropdownResults::-webkit-scrollbar-thumb {
    background: transparent;
    border-radius: 4px;
    transition: background 0.3s ease;
}

#searchDropdownResults:hover::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.12);
}

#searchDropdownResults::-webkit-scrollbar-thumb:hover {
    background: rgba(0,0,0,0.2);
}

/* Overlay scuro quando tendina aperta */
.search-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.15);
    z-index: 99;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
}

.search-overlay.active {
    opacity: 1;
    visibility: visible;
}  
  
.star-fav-btn-mini {
    width: 28px;
    height: 28px;
    border: none;
    border-radius: 8px;
    background: transparent;
    color: #d1d5db;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    padding: 0;
    flex-shrink: 0;
}

.star-fav-btn-mini:hover {
    color: #fbbf24;
    transform: scale(1.1);
}

.star-fav-btn-mini.active {
    color: #fbbf24;
}

.star-fav-btn-mini svg {
    width: 16px;
    height: 16px;
}  
  
.cerca-ricette-search-row {
    display: flex;
    align-items: center;
    width: 100%;
    height: 52px;
    padding: 0 18px;
    background: linear-gradient(145deg, rgba(250,250,250,0.95) 0%, rgba(240,240,240,0.9) 100%);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 14px;
    box-shadow: 
        inset 0 2px 4px rgba(0,0,0,0.06),
        inset 0 -1px 2px rgba(255,255,255,0.8),
        0 4px 15px rgba(0,0,0,0.08),
        0 2px 6px rgba(0,0,0,0.04);
    border: 1px solid rgba(255,255,255,0.6);
    transition: all 0.3s ease;
    gap: 12px;
}

.cerca-ricette-search-row:focus-within {
    box-shadow: 
        inset 0 2px 5px rgba(0,0,0,0.08),
        inset 0 -1px 2px rgba(255,255,255,0.8),
        0 6px 20px rgba(0,0,0,0.1),
        0 3px 8px rgba(0,0,0,0.05);
}

.search-icon-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
    flex-shrink: 0;
}

.search-icon-wrapper svg {
    width: 22px;
    height: 22px;
}

.cerca-ricette-input {
    flex: 1;
    height: 100%;
    border: none;
    background: transparent;
    font-size: 15px;
    font-weight: 400;
    color: #374151;
    outline: none;
    caret-color: #6b7280;
}

.cerca-ricette-input::placeholder {
    color: #9ca3af;
}

.cerca-ricette-input:focus {
    outline: none;
    box-shadow: none;
}

.cerca-ricette-search-btn {
    padding: 10px 18px;
    border: none;
    border-radius: 9999px;
    background: #1E293B;
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
}

.cerca-ricette-search-btn:hover {
    background: #334155;
}

.cerca-ricette-search-btn:active {
    transform: scale(0.98);
}

.cerca-ricette-search-btn:disabled {
    background: #cbd5e1;
    cursor: not-allowed;
}

.cerca-ricette-search-btn svg {
    width: 16px;
    height: 16px;
}

.cucina-filters {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding: 8px 4px 20px 4px;
    margin: 0 -4px 16px -4px;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
}

.cucina-filters::-webkit-scrollbar {
    display: none;
}

.cucina-filter-btn {
    flex-shrink: 0;
    padding: 10px 20px;
    border: 1px solid #e5e7eb;
    border-radius: 9999px;
    background: rgba(255,255,255,0.8);
    backdrop-filter: blur(10px);
    color: #6b7280;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.cucina-filter-btn.active {
    background: linear-gradient(135deg, 
        #0f172a 0%, 
        #1e293b 50%,
        #334155 100%);
    color: white;
    border-color: transparent;
    box-shadow: 0 2px 8px rgba(15, 23, 42, 0.2);
}

.cucina-filter-btn:not(.active):hover {
    background: rgba(255,255,255,0.95);
    border-color: #d1d5db;
}

.cerca-ai-results {
    background: linear-gradient(160deg, rgba(250,250,252,0.80) 0%, rgba(245,246,250,0.80) 100%);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(230,232,240,0.8);
    border-radius: 14px;
    padding: 16px;
    margin-bottom: 20px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.08);
    max-height: 450px;
    overflow-y: auto;
}

.cerca-ai-results {
    scrollbar-width: thin;
    scrollbar-color: transparent transparent;
}

.cerca-ai-results:hover {
    scrollbar-color: rgba(0,0,0,0.1) transparent;
}

.cerca-ai-results::-webkit-scrollbar {
    width: 4px;
}

.cerca-ai-results::-webkit-scrollbar-track {
    background: transparent;
}

.cerca-ai-results::-webkit-scrollbar-thumb {
    background: transparent;
    border-radius: 4px;
    transition: background 0.3s ease;
}

.cerca-ai-results:hover::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.1);
}

.cerca-ai-results::-webkit-scrollbar-thumb:hover {
    background: rgba(0,0,0,0.18);
}
  
.cerca-ai-results-title {
    font-size: 14px;
    font-weight: 600;
    color: #1E293B;
    margin: 0 0 12px 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.ricetta-ai-mini-card {
    display: flex;
    align-items: center;
    gap: 12px;
    background: white;
    border-radius: 16px;
    padding: 10px;
    margin-bottom: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    transition: all 0.2s ease;
    cursor: pointer;
    border: 1px solid #f3f4f6;
}

.ricetta-ai-mini-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}

.ricetta-ai-mini-card:last-child {
    margin-bottom: 0;
}

.ricetta-ai-mini-img {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    object-fit: cover;
    flex-shrink: 0;
}

.ricetta-ai-mini-info {
    flex: 1;
    min-width: 0;
}

.ricetta-ai-mini-nome {
    font-size: 13px;
    font-weight: 600;
    color: #1E293B;
    margin: 0 0 2px 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.ricetta-ai-mini-kcal {
    font-size: 11px;
    color: #6b7280;
    margin: 0;
}

.ricette-tipo-section {
    margin-bottom: 32px;
}

.ricette-tipo-title {
    font-size: 20px;
    font-weight: 700;
    color: #1E293B;
    margin: 0 0 16px 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.ricetta-online-card {
    position: relative;
    display: flex;
    align-items: center;
    gap: 12px;
    background: white;
    border-radius: 20px;
    padding: 10px;
    margin-bottom: 12px;
    box-shadow: 0 20px 40px -12px rgba(0,0,0,0.12);
    transition: all 0.3s ease;
    cursor: pointer;
}

.ricetta-online-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 30px 60px -12px rgba(0,0,0,0.18);
}

.ricetta-online-img {
    width: 70px;
    height: 70px;
    border-radius: 14px;
    object-fit: cover;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.ricetta-online-info {
    flex: 1;
    min-width: 0;
    padding: 4px 0;
}

.ricetta-online-nome {
    font-size: 14px;
    font-weight: 700;
    color: #1E293B;
    margin: 0 0 4px 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding-right: 30px;
}

.ricetta-online-desc {
    font-size: 11px;
    color: #9ca3af;
    font-weight: 300;
    margin: 0 0 8px 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.4;
}

.ricetta-online-kcal {
    display: none;
}

.ricetta-online-tags {
    display: flex;
    flex-wrap: nowrap;
    overflow-x: auto;
    gap: 6px;
    padding-bottom: 2px;
    scrollbar-width: none;
}

.ricetta-online-tags::-webkit-scrollbar {
    display: none;
}

.ricetta-tag {
    flex-shrink: 0;
    padding: 3px 8px;
    border-radius: 9999px;
    font-size: 9px;
    font-weight: 600;
    white-space: nowrap;
    border: 1px solid;
}

.ricetta-tag.kcal {
    background: #f3f4f6;
    color: #374151;
    border-color: #e5e7eb;
}

.ricetta-tag.carb {
    background: #eff6ff;
    color: #2563eb;
    border-color: #dbeafe;
}

.ricetta-tag.prot {
    background: #fff7ed;
    color: #ea580c;
    border-color: #fed7aa;
}

.ricetta-tag.fat {
    background: #fffbeb;
    color: #d97706;
    border-color: #fef3c7;
}

.star-fav-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 8px;
    background: transparent;
    color: #d1d5db;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    padding: 0;
}

.star-fav-btn:hover {
    color: #fbbf24;
    transform: scale(1.1);
}

.star-fav-btn.active {
    color: #fbbf24;
}

.star-fav-btn svg {
    width: 18px;
    height: 18px;
}

.cerca-ricette-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    color: #6b7280;
}

.cerca-ricette-loading .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #e5e7eb;
    border-top-color: #1E293B;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 16px;
}

body.dark-mode .cerca-ricette-wrapper {
    background-color: #0f172a;
}

body.dark-mode .cerca-ricette-header {
    background: linear-gradient(135deg, 
        #020617 0%, 
        #0f172a 40%,
        #1e293b 100%);
    box-shadow: 
        0 4px 20px rgba(0, 0, 0, 0.5),
        0 2px 8px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255,255,255,0.03);
    border-bottom-color: rgba(51, 65, 85, 0.4);
}

body.dark-mode .cerca-ricette-back-btn {
    background: linear-gradient(135deg, 
        #155e75 0%, 
        #0e7490 30%,
        #0891b2 70%,
        #06b6d4 100%);
    color: #ecfeff;
    box-shadow: 
        0 4px 15px rgba(6, 182, 212, 0.3),
        0 2px 6px rgba(6, 182, 212, 0.2),
        inset 0 1px 2px rgba(255,255,255,0.2);
}

body.dark-mode .cerca-ricette-back-btn:hover {
    background: linear-gradient(135deg, 
        #0e7490 0%, 
        #0891b2 30%,
        #06b6d4 70%,
        #22d3ee 100%);
}

body.dark-mode .cerca-ricette-title {
    color: #e2e8f0;
}

body.dark-mode .cucina-filter-btn.active {
    background: linear-gradient(135deg, 
        #020617 0%, 
        #0f172a 40%,
        #1e293b 100%);
    box-shadow: 
        0 4px 15px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255,255,255,0.05);
}

body.dark-mode .cerca-ricette-search-row {
    background: rgba(30,41,59,0.9);
}

body.dark-mode .cerca-ricette-input {
    color: #f1f5f9;
}

body.dark-mode .cucina-filter-btn {
    background: rgba(30,41,59,0.8);
    color: #94a3b8;
}

body.dark-mode .cucina-filter-btn.active {
    background: #3b82f6;
    color: white;
}

body.dark-mode .ricette-tipo-title {
    color: #f1f5f9;
}

body.dark-mode .ricetta-online-card {
    background: #1e293b;
}

body.dark-mode .ricetta-online-nome {
    color: #f1f5f9;
}

body.dark-mode .ricetta-online-desc {
    color: #64748b;
}

body.dark-mode .ricetta-tag.kcal {
    background: #334155;
    color: #e2e8f0;
    border-color: #475569;
}

body.dark-mode .ricetta-tag.carb {
    background: rgba(59,130,246,0.2);
    color: #60a5fa;
    border-color: rgba(59,130,246,0.3);
}

body.dark-mode .ricetta-tag.prot {
    background: rgba(249,115,22,0.2);
    color: #fb923c;
    border-color: rgba(249,115,22,0.3);
}

body.dark-mode .ricetta-tag.fat {
    background: rgba(245,158,11,0.2);
    color: #fbbf24;
    border-color: rgba(245,158,11,0.3);
}

body.dark-mode .star-fav-btn {
    color: #475569;
}

body.dark-mode .star-fav-btn:hover,
body.dark-mode .star-fav-btn.active {
    color: #fbbf24;
}

body.dark-mode .cerca-ai-results {
    background: rgba(30,41,59,0.95);
}

body.dark-mode .cerca-ai-results-title {
    color: #f1f5f9;
}

body.dark-mode .ricetta-ai-mini-card {
    background: #1e293b;
    border-color: #334155;
}

body.dark-mode .ricetta-ai-mini-nome {
    color: #f1f5f9;
}

body.dark-mode .ricetta-ai-mini-kcal {
    color: #94a3b8;
}

/* ========================================
   CARD DETTAGLIO RICETTA - NUOVO DESIGN
   ======================================== */
.recipe-detail-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(15, 23, 42, 0.75);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 16px;
}

.recipe-detail-overlay.show {
    display: flex;
}

.recipe-detail-card {
    position: relative;
    background: linear-gradient(145deg, #ffffff 0%, #f8fafc 50%, #f1f5f9 100%);
    border-radius: 32px;
    width: 100%;
    max-width: 400px;
    height: 85vh;
    max-height: 800px;
    overflow: hidden;
    box-shadow: 
        0 25px 50px -12px rgba(0, 0, 0, 0.25),
        0 12px 24px -8px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
    animation: detailCardPop 0.3s ease;
    display: flex;
    flex-direction: column;
    font-family: 'Inter', system-ui, sans-serif;
    border: 1px solid rgba(255, 255, 255, 0.8);
}

@keyframes detailCardPop {
    from { opacity: 0; transform: scale(0.92) translateY(20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

/* Pulsante chiudi fisso */
.recipe-detail-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 40px;
    height: 40px;
    border: none;
    border-radius: 50%;
    background: rgba(0,0,0,0.2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
    color: white;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
    z-index: 50;
}

.recipe-detail-close:hover {
    background: white;
    color: #1e293b;
    transform: scale(1.1);
}

/* Container scrollabile */
.recipe-detail-scroll {
    width: 100%;
    height: 100%;
    overflow-y: auto;
    overflow-x: hidden;
    background: linear-gradient(180deg, #ffffff 0%, #fafbfc 100%);
}

.recipe-detail-scroll::-webkit-scrollbar {
    width: 0;
    background: transparent;
}

/* Header con immagine */
.recipe-detail-header {
    position: relative;
    height: 320px;
    width: 100%;
    flex-shrink: 0;
    overflow: hidden;
}

.recipe-detail-header-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.recipe-detail-header-gradient {
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0.4) 0%, transparent 40%, transparent 100%);
    pointer-events: none;
}

/* Badge tempo e porzioni sull'immagine */
.recipe-detail-badges {
    position: absolute;
    bottom: 60px;
    left: 20px;
    display: flex;
    gap: 8px;
    z-index: 10;
}

.recipe-detail-badge {
    padding: 6px 12px;
    border-radius: 50px;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 6px;
    border: 1px solid rgba(255,255,255,0.6);
}

.recipe-detail-badge svg {
    width: 13px;
    height: 13px;
    color: #0d9488;
}

.recipe-detail-badge span {
    font-size: 10px;
    font-weight: 700;
    color: #1e293b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Contenuto principale */
.recipe-detail-body {
    position: relative;
    background: linear-gradient(180deg, #ffffff 0%, #f8fafc 30%, #f1f5f9 100%);
    margin-top: -40px;
    border-radius: 36px 36px 0 0;
    z-index: 10;
    box-shadow: 
        0 -15px 35px rgba(0, 0, 0, 0.08),
        inset 0 2px 0 rgba(255, 255, 255, 1);
    padding: 40px 24px 140px 24px;
}

/* Titolo centrato */
.recipe-detail-title-section {
    text-align: center;
    margin-bottom: 32px;
}

.recipe-detail-ai-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 50px;
    background: linear-gradient(135deg, #f0fdfa 0%, #d1fae5 100%);
    border: 1px solid rgba(20,184,166,0.2);
    color: #0f766e;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px rgba(20,184,166,0.15);
}

.recipe-detail-ai-badge svg {
    width: 11px;
    height: 11px;
}

.recipe-detail-title {
    font-size: 28px;
    font-weight: 600;
    color: #0f172a;
    margin: 0 0 12px 0;
    line-height: 1.2;
    letter-spacing: -0.5px;
}

.recipe-detail-cuisine {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    color: #64748b;
}

.recipe-detail-cuisine-line {
    height: 1px;
    width: 32px;
    background: #cbd5e1;
}

.recipe-detail-cuisine-text {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: #64748b;
}

/* Macro cards */
.recipe-detail-macros {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-bottom: 32px;
}

.recipe-detail-macro {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 14px 8px;
    background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.9);
    box-shadow: 
        0 4px 12px -2px rgba(0, 0, 0, 0.08),
        0 2px 4px -1px rgba(0, 0, 0, 0.04),
        inset 0 1px 0 rgba(255, 255, 255, 1);
    transition: all 0.3s ease;
}

.recipe-detail-macro:hover {
    box-shadow: 0 8px 16px -4px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.recipe-detail-macro-label {
    font-size: 9px;
    color: #94a3b8;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.recipe-detail-macro-value {
    font-size: 18px;
    font-weight: 700;
    color: #1e293b;
}

/* Citazione/Descrizione */
.recipe-detail-quote {
    position: relative;
    padding: 20px;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0fdfa 100%);
    border-radius: 16px;
    border: 1px solid rgba(14, 165, 233, 0.15);
    text-align: center;
    margin-bottom: 32px;
    box-shadow: 
        0 4px 15px -3px rgba(14, 165, 233, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
}

.recipe-detail-quote p {
    font-size: 15px;
    line-height: 1.6;
    color: #475569;
    font-style: italic;
    margin: 0;
}

/* Sezioni */
.recipe-detail-section {
    margin-bottom: 32px;
}

.recipe-detail-section-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 11px;
    font-weight: 700;
    color: #0f172a;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin: 0 0 16px 4px;
}

.recipe-detail-section-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: #f0fdfa;
    border: 1px solid #ccfbf1;
    border-radius: 8px;
    color: #0d9488;
}

.recipe-detail-section-icon svg {
    width: 14px;
    height: 14px;
}

/* Lista ingredienti */
.recipe-detail-ingredients-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.recipe-detail-ingredient {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 14px;
    border-radius: 12px;
    transition: all 0.2s ease;
    border: 1px solid transparent;
}

.recipe-detail-ingredient:hover {
    background: #f8fafc;
    border-color: #f1f5f9;
}

.recipe-detail-ingredient-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.recipe-detail-ingredient-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #cbd5e1;
    transition: background 0.2s ease;
}

.recipe-detail-ingredient:hover .recipe-detail-ingredient-dot {
    background: #14b8a6;
}

.recipe-detail-ingredient-name {
    font-size: 15px;
    font-weight: 500;
    color: #334155;
}

.recipe-detail-ingredient-qty {
    font-size: 12px;
    font-weight: 700;
    color: #64748b;
    background: #f1f5f9;
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

/* Timeline procedimento */
.recipe-detail-steps {
    position: relative;
    padding-left: 32px;
}

.recipe-detail-steps-line {
    position: absolute;
    left: 6px;
    top: 20px;
    bottom: 30px;
    width: 2px;
    background: linear-gradient(to bottom, #14b8a6 0%, #99f6e4 50%, transparent 100%);
    border-radius: 2px;
}

.recipe-detail-step {
    position: relative;
    padding-left: 12px;
    padding-bottom: 24px;
}

.recipe-detail-step:last-child {
    padding-bottom: 0;
}

.recipe-detail-step-dot {
    position: absolute;
    left: -32px;
    top: 4px;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: linear-gradient(135deg, #ffffff 0%, #f0fdfa 100%);
    border: 3px solid #14b8a6;
    box-shadow: 
        0 0 0 4px rgba(20, 184, 166, 0.12),
        0 2px 6px rgba(20, 184, 166, 0.2);
    z-index: 10;
    transition: all 0.2s ease;
}

.recipe-detail-step:hover .recipe-detail-step-dot {
    box-shadow: 0 0 0 6px rgba(20,184,166,0.2);
    transform: scale(1.1);
}

.recipe-detail-step-text {
    font-size: 15px;
    line-height: 1.7;
    color: #475569;
    transition: color 0.2s ease;
}

.recipe-detail-step:hover .recipe-detail-step-text {
    color: #0f172a;
}

/* Card storia */
.recipe-detail-history {
    position: relative;
    padding: 20px;
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    border-radius: 16px;
    border: 1px solid #fde68a;
    overflow: hidden;
}

.recipe-detail-history-icon {
    position: absolute;
    right: -10px;
    top: -10px;
    color: rgba(245,158,11,0.1);
    transform: rotate(12deg);
}

.recipe-detail-history-icon svg {
    width: 80px;
    height: 80px;
}

.recipe-detail-history p {
    position: relative;
    z-index: 10;
    font-size: 14px;
    line-height: 1.6;
    color: #92400e;
    font-style: italic;
    font-weight: 500;
    margin: 0;
}

/* Footer con bottone fisso */
.recipe-detail-footer {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 24px;
    padding-top: 60px;
    background: linear-gradient(to top, white 60%, rgba(255,255,255,0.95) 80%, transparent 100%);
    z-index: 40;
    pointer-events: none;
}

.recipe-detail-fav-btn {
    pointer-events: auto;
    width: 100%;
    padding: 16px 24px;
    border: none;
    border-radius: 16px;
    background: #0f172a;
    color: white;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 15px 30px -5px rgba(15,23,42,0.3);
    transition: all 0.2s ease;
}

.recipe-detail-fav-btn:hover {
    background: #1e293b;
    transform: translateY(-2px);
    box-shadow: 0 20px 40px -5px rgba(15,23,42,0.4);
}

.recipe-detail-fav-btn:active {
    transform: scale(0.98);
}

.recipe-detail-fav-btn-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.recipe-detail-fav-btn-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: rgba(255,255,255,0.1);
    border-radius: 8px;
    transition: background 0.2s ease;
}

.recipe-detail-fav-btn:hover .recipe-detail-fav-btn-icon {
    background: rgba(255,255,255,0.2);
}

.recipe-detail-fav-btn-icon svg {
    width: 18px;
    height: 18px;
    color: #fbbf24;
    fill: #fbbf24;
}

.recipe-detail-fav-btn-text {
    font-size: 15px;
    font-weight: 600;
    letter-spacing: 0.3px;
}

.recipe-detail-fav-btn-arrow {
    color: #64748b;
    transition: all 0.2s ease;
}

.recipe-detail-fav-btn:hover .recipe-detail-fav-btn-arrow {
    color: white;
    transform: translateX(4px);
}

.recipe-detail-fav-btn.added {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.recipe-detail-fav-btn.added .recipe-detail-fav-btn-icon svg {
    color: white;
    fill: white;
}

/* Loading state */
.recipe-detail-loading {
    color: #94a3b8;
    font-style: italic;
    font-size: 14px;
}

/* Dark mode */
body.dark-mode .recipe-detail-card {
    background: #0f172a;
}

body.dark-mode .recipe-detail-scroll {
    background: #1e293b;
}

body.dark-mode .recipe-detail-body {
    background: #1e293b;
}

body.dark-mode .recipe-detail-title {
    color: #f1f5f9;
}

body.dark-mode .recipe-detail-cuisine-text {
    color: #94a3b8;
}

body.dark-mode .recipe-detail-macro {
    background: #334155;
    border-color: #475569;
}

body.dark-mode .recipe-detail-macro-label {
    color: #94a3b8;
}

body.dark-mode .recipe-detail-macro-value {
    color: #f1f5f9;
}

body.dark-mode .recipe-detail-quote {
    background: #334155;
    border-color: #475569;
}

body.dark-mode .recipe-detail-quote p {
    color: #cbd5e1;
}

body.dark-mode .recipe-detail-section-title {
    color: #f1f5f9;
}

body.dark-mode .recipe-detail-ingredient-name {
    color: #e2e8f0;
}

body.dark-mode .recipe-detail-ingredient-qty {
    background: #334155;
    border-color: #475569;
    color: #94a3b8;
}

body.dark-mode .recipe-detail-step-text {
    color: #cbd5e1;
}

body.dark-mode .recipe-detail-history {
    background: linear-gradient(135deg, #422006 0%, #78350f 100%);
    border-color: #a16207;
}

body.dark-mode .recipe-detail-history p {
    color: #fef3c7;
}

body.dark-mode .recipe-detail-footer {
    background: linear-gradient(to top, #1e293b 60%, rgba(30,41,59,0.95) 80%, transparent 100%);
}  
  
@keyframes slideFromLeft {
    from {
        opacity: 0;
        transform: translateX(-100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.ricette-fullscreen-header {
    position: sticky;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(180deg, rgba(255,253,250,1) 0%, rgba(255,253,250,0.95) 80%, rgba(255,253,250,0) 100%);
    padding: 16px 16px 20px 16px;
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 12px;
}

.ricette-back-btn {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: white;
    border: 1px solid rgba(6, 78, 59, 0.15);
    color: #064e3b;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.ricette-back-btn:hover {
    background: #f0fdf4;
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
}

.ricette-back-btn:active {
    transform: scale(0.95);
}

.ricette-fullscreen-title {
    font-family: 'Fredoka', 'Poppins', sans-serif;
    font-size: 22px;
    font-weight: 600;
    color: #064e3b;
    margin: 0;
}

.ricette-fullscreen-content {
    padding: 0 16px 120px 16px;
    max-width: 500px;
    margin: 0 auto;
}

.ricette-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    background: white;
    padding: 6px;
    border-radius: 14px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.ricette-tab {
    flex: 1;
    padding: 12px 16px;
    border: none;
    border-radius: 10px;
    background: transparent;
    color: #64748b;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.ricette-tab.active {
    background: linear-gradient(135deg, #064e3b 0%, #166534 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(6, 78, 59, 0.3);
}

.ricette-tab:not(.active):hover {
    background: #f0fdf4;
    color: #064e3b;
}

.ricette-fullscreen-wrapper #ricette > h2,
.ricette-fullscreen-wrapper #aggiungiRicetta > h2 {
    display: none;
}

/* Dark mode ricette fullscreen */
body.dark-mode .ricette-fullscreen-wrapper {
    background: linear-gradient(180deg, #0a1929, #1a2332);
}

body.dark-mode .ricette-fullscreen-header {
    background: linear-gradient(180deg, rgba(10,25,41,1) 0%, rgba(10,25,41,0.95) 80%, rgba(10,25,41,0) 100%);
}

body.dark-mode .ricette-back-btn {
    background: #1e293b;
    border-color: rgba(148, 163, 184, 0.2);
    color: #e2e8f0;
}

body.dark-mode .ricette-back-btn:hover {
    background: #334155;
}

body.dark-mode .ricette-fullscreen-title {
    color: #4ade80;
}

body.dark-mode .ricette-tabs {
    background: #1e293b;
}

body.dark-mode .ricette-tab {
    color: #94a3b8;
}

body.dark-mode .ricette-tab:not(.active):hover {
    background: rgba(74, 222, 128, 0.1);
    color: #4ade80;
}

/* ========================================
   LE MIE RICETTE - DESIGN LIBRO ESATTO
   ======================================== */

/* Nascondi vecchi elementi */
.ricette-fullscreen-wrapper .card,
.ricette-fullscreen-wrapper .recipe-card,
.ricette-fullscreen-wrapper #ricette > h2,
.ricette-fullscreen-wrapper .filter-badge,
.ricette-fullscreen-wrapper .search-recipe-input,
.ricette-fullscreen-wrapper .ricette-tabs,
.ricette-fullscreen-wrapper .ricette-fullscreen-header {
    display: none !important;
}

/* Sfondo libro crema */
.ricette-fullscreen-wrapper {
    background-image: url('img/immaginericettemie.png') !important;
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
    background-color: #f9f5eb !important;
}

/* Effetto rilegatura a sinistra */
.ricette-book-spine {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 32px;
    background: linear-gradient(to right, rgba(0,0,0,0.05), rgba(0,0,0,0.02), transparent);
    pointer-events: none;
    z-index: 1;
}

/* Header libro */
/* ============================================
   HEADER - BIANCO SFUMATO CON OMBRE
   ============================================ */

.ricette-book-header {
    position: sticky;
    top: 0;
    z-index: 20;
    background: linear-gradient(135deg, 
        #a7f3d0 0%, 
        #6ee7b7 30%,
        #5eead4 70%,
        #99f6e4 100%);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 20px 20px 16px 20px;
    box-shadow: 
        0 4px 20px rgba(16, 185, 129, 0.15),
        0 2px 8px rgba(16, 185, 129, 0.1),
        0 1px 3px rgba(0, 0, 0, 0.05),
        inset 0 1px 2px rgba(255,255,255,0.4),
        inset 0 -1px 2px rgba(0,0,0,0.03);
    border-bottom: 1px solid rgba(255,255,255,0.3);
}

.ricette-book-header-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.ricette-book-back-btn {
    width: 40px;
    height: 40px;
    padding: 8px;
    border-radius: 50%;
    color: #065f46;
    background: linear-gradient(135deg, 
        #d1fae5 0%, 
        #a7f3d0 30%,
        #6ee7b7 70%,
        #5eead4 100%);
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 
        0 3px 12px rgba(16, 185, 129, 0.25),
        0 1px 4px rgba(16, 185, 129, 0.15),
        inset 0 1px 2px rgba(255,255,255,0.5),
        inset 0 -1px 2px rgba(0,0,0,0.05);
    display: flex;
    align-items: center;
    justify-content: center;
}

.ricette-book-back-btn:hover {
    background: linear-gradient(135deg, 
        #ecfdf5 0%, 
        #d1fae5 30%,
        #a7f3d0 70%,
        #6ee7b7 100%);
    transform: translateY(-2px);
    box-shadow: 
        0 5px 18px rgba(16, 185, 129, 0.3),
        0 2px 6px rgba(16, 185, 129, 0.2),
        inset 0 1px 2px rgba(255,255,255,0.6);
}

.ricette-book-back-btn:active {
    transform: scale(0.95) translateY(0);
    box-shadow: 
        0 2px 6px rgba(16, 185, 129, 0.2),
        inset 0 2px 4px rgba(0,0,0,0.08);
}

.ricette-book-title-wrap {
    display: flex;
    align-items: center;
    gap: 10px;
}

.ricette-book-title-wrap svg {
    color: #059669;
}

.ricette-book-title {
    font-size: 20px;
    font-weight: 700;
    color: #1e293b;
    letter-spacing: -0.02em;
    margin: 0;
    font-family: 'Inter', system-ui, sans-serif;
}

/* ============================================
   BARRA RICERCA - STILE CERCA RICETTE ONLINE
   ============================================ */

.ricette-mie-search-box {
    padding: 12px 16px 16px 16px;
}

.ricette-mie-search-row {
    display: flex;
    align-items: center;
    width: 100%;
    height: 52px;
    padding: 0 18px;
    background: linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.9) 100%);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 16px;
    box-shadow: 
        inset 0 2px 4px rgba(0,0,0,0.04),
        inset 0 -1px 2px rgba(255,255,255,0.9),
        0 4px 15px rgba(0,0,0,0.08),
        0 2px 6px rgba(0,0,0,0.04);
    border: 1px solid rgba(255,255,255,0.7);
    transition: all 0.3s ease;
    gap: 12px;
}

.ricette-mie-search-row:focus-within {
    box-shadow: 
        inset 0 2px 5px rgba(0,0,0,0.06),
        inset 0 -1px 2px rgba(255,255,255,0.9),
        0 6px 20px rgba(0,0,0,0.1),
        0 3px 8px rgba(0,0,0,0.05),
        0 0 0 3px rgba(16, 185, 129, 0.15);
}

.ricette-mie-search-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
    flex-shrink: 0;
}

.ricette-mie-search-icon svg {
    width: 20px;
    height: 20px;
}

.ricette-mie-search-input {
    flex: 1;
    height: 100%;
    border: none;
    background: transparent;
    font-size: 15px;
    font-weight: 400;
    color: #374151;
    outline: none;
    caret-color: #059669;
    font-family: 'Inter', system-ui, sans-serif;
}

.ricette-mie-search-input::placeholder {
    color: #9ca3af;
}

.ricette-mie-search-input:focus {
    outline: none;
    box-shadow: none;
}

/* ============================================
   TABS - VERDE SALVIA/CELESTINO CON OMBRE
   ============================================ */

.ricette-book-tabs {
    display: flex;
    padding: 6px;
    gap: 6px;
    background: linear-gradient(145deg, rgba(255,255,255,0.7) 0%, rgba(248,250,252,0.6) 100%);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 18px;
    margin: 0 16px 16px 16px;
    box-shadow: 
        0 4px 15px rgba(0,0,0,0.06),
        0 2px 6px rgba(0,0,0,0.03),
        inset 0 1px 2px rgba(255,255,255,0.8);
    border: 1px solid rgba(255,255,255,0.5);
}

.ricette-book-tab {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 14px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 14px;
    border: none;
    background: transparent;
    color: #64748b;
    cursor: pointer;
    transition: all 0.25s ease;
    font-family: 'Inter', system-ui, sans-serif;
}

.ricette-book-tab:hover:not(.active) {
    color: #059669;
    background: rgba(16, 185, 129, 0.08);
}

.ricette-book-tab.active {
    background: linear-gradient(135deg, 
        #a7f3d0 0%, 
        #6ee7b7 30%,
        #5eead4 70%,
        #99f6e4 100%);
    color: #065f46;
    box-shadow: 
        0 4px 12px rgba(16, 185, 129, 0.25),
        0 2px 6px rgba(16, 185, 129, 0.15),
        inset 0 1px 2px rgba(255,255,255,0.4),
        inset 0 -1px 2px rgba(0,0,0,0.05);
    text-shadow: 0 1px 1px rgba(255,255,255,0.3);
}

.ricette-book-tab svg {
    width: 16px;
    height: 16px;
}

.ricette-book-tab.active svg {
    filter: drop-shadow(0 1px 1px rgba(0,0,0,0.1));
}

/* ============================================
   DARK MODE
   ============================================ */

body.dark-mode .ricette-book-header {
    background: linear-gradient(180deg, 
        rgba(30, 41, 59, 0.98) 0%, 
        rgba(30, 41, 59, 0.95) 60%,
        rgba(30, 41, 59, 0.85) 100%);
    box-shadow: 
        0 4px 20px rgba(0, 0, 0, 0.3),
        0 2px 8px rgba(0, 0, 0, 0.2);
    border-bottom-color: rgba(71, 85, 105, 0.3);
}

body.dark-mode .ricette-book-back-btn {
    background: rgba(51, 65, 85, 0.8);
    color: #94a3b8;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

body.dark-mode .ricette-book-back-btn:hover {
    background: rgba(71, 85, 105, 0.9);
    color: #e2e8f0;
}

body.dark-mode .ricette-book-title-wrap svg {
    color: #4ade80;
}

body.dark-mode .ricette-book-title {
    color: #e2e8f0;
}

body.dark-mode .ricette-mie-search-row {
    background: linear-gradient(145deg, rgba(51, 65, 85, 0.9) 0%, rgba(30, 41, 59, 0.85) 100%);
    border-color: rgba(71, 85, 105, 0.5);
    box-shadow: 
        inset 0 2px 4px rgba(0,0,0,0.2),
        0 4px 15px rgba(0,0,0,0.2);
}

body.dark-mode .ricette-mie-search-row:focus-within {
    box-shadow: 
        inset 0 2px 5px rgba(0,0,0,0.25),
        0 6px 20px rgba(0,0,0,0.25),
        0 0 0 3px rgba(74, 222, 128, 0.2);
}

body.dark-mode .ricette-mie-search-icon {
    color: #64748b;
}

body.dark-mode .ricette-mie-search-input {
    color: #e2e8f0;
    caret-color: #4ade80;
}

body.dark-mode .ricette-mie-search-input::placeholder {
    color: #64748b;
}

body.dark-mode .ricette-book-tabs {
    background: linear-gradient(145deg, rgba(51, 65, 85, 0.6) 0%, rgba(30, 41, 59, 0.5) 100%);
    border-color: rgba(71, 85, 105, 0.3);
    box-shadow: 
        0 4px 15px rgba(0,0,0,0.2),
        inset 0 1px 2px rgba(255,255,255,0.05);
}

body.dark-mode .ricette-book-tab {
    color: #94a3b8;
}

body.dark-mode .ricette-book-tab:hover:not(.active) {
    color: #4ade80;
    background: rgba(74, 222, 128, 0.1);
}

body.dark-mode .ricette-book-tab.active {
    background: linear-gradient(135deg, 
        #065f46 0%, 
        #047857 30%,
        #059669 70%,
        #10b981 100%);
    color: #ecfdf5;
    box-shadow: 
        0 4px 12px rgba(16, 185, 129, 0.3),
        0 2px 6px rgba(16, 185, 129, 0.2),
        inset 0 1px 2px rgba(255,255,255,0.1);
}


/* Container vista */
.ricette-book-view-container {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 80px;
}

/* ============================================
   LISTA RICETTE - STILE ESATTO COME ORIGINALE
   ============================================ */

/* Container lista */
.ricette-book-list {
    display: flex;
    flex-direction: column;
    padding: 0 24px;
}

/* Singola riga ricetta */
.ricette-book-row {
    position: relative;
    display: flex;
    align-items: flex-start;
    gap: 16px;
    padding: 20px 0;
    border-bottom: 1px solid rgba(6, 78, 59, 0.1);
    cursor: pointer;
}

.ricette-book-row:last-child {
    border-bottom: none;
}

/* Immagine tonda a sinistra */
.ricette-book-row-img-wrap {
    flex-shrink: 0;
    padding-top: 4px;
}

.ricette-book-row-img {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    object-fit: cover;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.8);
    filter: sepia(0.15);
}

/* Placeholder immagine con emoji */
.ricette-book-row-img-placeholder {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.8);
}

/* Contenuto centrale */
.ricette-book-row-content {
    flex: 1;
    min-width: 0;
    padding-right: 32px;
}

/* Titolo + icona veg */
.ricette-book-row-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
}

.ricette-book-row-name {
    font-size: 18px;
    font-weight: 700;
    color: #022c22;
    line-height: 1.25;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-family: 'Inter', system-ui, sans-serif;
}

/* Icona foglia verde */
.ricette-book-row-leaf {
    flex-shrink: 0;
    color: #10b981;
}

/* Blocco macro */
.ricette-book-row-macros {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.ricette-book-row-kcal {
    font-size: 14px;
    font-weight: 600;
    color: rgba(6, 95, 70, 0.8);
    font-family: 'Inter', system-ui, sans-serif;
}

.ricette-book-row-macro-line {
    display: flex;
    gap: 8px;
    font-size: 12px;
    font-weight: 500;
    color: rgba(4, 120, 87, 0.6);
    letter-spacing: 0.025em;
    font-family: 'Inter', system-ui, sans-serif;
}

/* Stella preferiti a destra */
.ricette-book-row-star {
    position: absolute;
    top: 20px;
    right: 0;
    padding: 4px;
    border-radius: 50%;
    background: transparent;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}

.ricette-book-row-star:hover {
    background: rgba(6, 78, 59, 0.05);
}

.ricette-book-row-star:active {
    transform: scale(0.9);
}

.ricette-book-row-star svg {
    width: 18px;
    height: 18px;
}

.ricette-book-row-star.active svg {
    fill: #eab308;
    color: #eab308;
}

.ricette-book-row-star:not(.active) svg {
    fill: none;
    color: rgba(6, 78, 59, 0.2);
}

/* Messaggio vuoto */
.ricette-book-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 80px 24px;
    color: rgba(6, 78, 59, 0.4);
    font-style: italic;
    font-family: 'Inter', system-ui, sans-serif;
}

/* ============================================
   FORM NUOVA RICETTA
   ============================================ */

.ricette-book-form-container {
    padding: 0 16px 80px 16px;
}

.ricette-book-form {
    background: rgba(255, 255, 255, 0.4);
    backdrop-filter: blur(8px);
    border-radius: 24px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    border: 1px solid rgba(16, 185, 129, 0.1);
}

.ricette-book-form-row {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
}

.ricette-book-form-row-full {
    margin-bottom: 16px;
}

.ricette-book-form-row-half {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
}

.ricette-book-form-label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: #065f46;
    margin-bottom: 4px;
    margin-left: 4px;
}

.ricette-book-form-input {
    width: 100%;
    padding: 12px 16px;
    border-radius: 16px;
    border: none;
    background: white;
    color: #022c22;
    font-size: 14px;
    outline: none;
    box-sizing: border-box;
}

.ricette-book-form-input:focus {
    box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
}

.ricette-book-form-input::placeholder {
    color: rgba(6, 78, 59, 0.3);
}

.ricette-book-form-textarea {
    width: 100%;
    padding: 12px 16px;
    border-radius: 16px;
    border: none;
    background: white;
    color: #022c22;
    font-size: 14px;
    outline: none;
    resize: none;
    height: 96px;
    box-sizing: border-box;
}

.ricette-book-form-textarea:focus {
    box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
}

.ricette-book-form-textarea::placeholder {
    color: rgba(6, 78, 59, 0.3);
}

.ricette-book-veg-btn {
    width: 100%;
    height: 46px;
    border-radius: 16px;
    border: none;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.ricette-book-veg-btn.nonveg {
    background: white;
    color: #9ca3af;
}

.ricette-book-veg-btn.veg {
    background: #dcfce7;
    color: #15803d;
}

.ricette-book-form-actions {
    display: flex;
    gap: 12px;
    padding-top: 8px;
}

.ricette-book-form-submit {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 20px;
    background: #059669;
    color: white;
    border: none;
    border-radius: 16px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(5, 150, 105, 0.2);
}

.ricette-book-form-submit:hover {
    background: #047857;
}

.ricette-book-form-reset {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 14px 16px;
    background: white;
    color: #059669;
    border: none;
    border-radius: 16px;
    cursor: pointer;
}

.ricette-book-form-reset:hover {
    background: #ecfdf5;
}

/* ============================================
   DARK MODE
   ============================================ */

body.dark-mode .ricette-fullscreen-wrapper {
    background: #1a1f2e !important;
}

body.dark-mode .ricette-book-header {
    background: rgba(26, 31, 46, 0.85);
}

body.dark-mode .ricette-book-back-btn {
    color: rgba(74, 222, 128, 0.6);
}

body.dark-mode .ricette-book-title-wrap svg {
    color: #4ade80;
}

body.dark-mode .ricette-book-title {
    color: #e2e8f0;
}

body.dark-mode .ricette-book-search-input {
    background: rgba(30, 41, 59, 0.8);
    border-color: rgba(74, 222, 128, 0.1);
    color: #e2e8f0;
}

body.dark-mode .ricette-book-search-input::placeholder {
    color: rgba(148, 163, 184, 0.5);
}

body.dark-mode .ricette-book-tabs {
    background: rgba(74, 222, 128, 0.08);
}

body.dark-mode .ricette-book-tab {
    color: rgba(148, 163, 184, 0.8);
}

body.dark-mode .ricette-book-tab.active {
    background: #1e293b;
    color: #4ade80;
}

body.dark-mode .ricette-book-row {
    border-bottom-color: rgba(148, 163, 184, 0.1);
}

body.dark-mode .ricette-book-row-img-placeholder {
    background: linear-gradient(135deg, #064e3b 0%, #047857 100%);
}

body.dark-mode .ricette-book-row-name {
    color: #e2e8f0;
}

body.dark-mode .ricette-book-row-kcal {
    color: rgba(74, 222, 128, 0.8);
}

body.dark-mode .ricette-book-row-macro-line {
    color: rgba(148, 163, 184, 0.6);
}

body.dark-mode .ricette-book-row-star:not(.active) svg {
    color: rgba(148, 163, 184, 0.3);
}

body.dark-mode .ricette-book-empty {
    color: rgba(148, 163, 184, 0.5);
}

body.dark-mode .ricette-book-form {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(74, 222, 128, 0.15);
}

body.dark-mode .ricette-book-form-label {
    color: #4ade80;
}

body.dark-mode .ricette-book-form-input,
body.dark-mode .ricette-book-form-textarea {
    background: #1e293b;
    color: #e2e8f0;
}

body.dark-mode .ricette-book-veg-btn.nonveg {
    background: #1e293b;
    color: #94a3b8;
}

body.dark-mode .ricette-book-veg-btn.veg {
    background: rgba(74, 222, 128, 0.2);
    color: #4ade80;
}

body.dark-mode .ricette-book-form-reset {
    background: #1e293b;
    color: #4ade80;
}
  
body.dark-mode .recipe-twin-btn {
    background: linear-gradient(135deg, #047857 0%, #10b981 50%, #6ee7b7 100%);
}

/* ========================================
   ðŸ†• DROPDOWN PROFESSIONALE
   ======================================== */

.quick-dropdown {
    position: absolute;
    top: calc(100% + 6px);
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(148, 163, 184, 0.12);
    border-radius: 14px;
    box-shadow: 0 12px 40px -12px rgba(0, 0, 0, 0.25),
                0 4px 16px -4px rgba(0, 0, 0, 0.1);
    max-height: 260px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    padding: 6px;
}

.quick-dropdown.show {
    display: block;
    animation: dropdownSlide 0.2s ease;
}

@keyframes dropdownSlide {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.quick-dropdown-item {
    padding: 12px 14px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.quick-dropdown-item:hover {
    background: rgba(16, 185, 129, 0.08);
}

.quick-dropdown-item:active {
    background: rgba(16, 185, 129, 0.15);
    transform: scale(0.98);
}

.quick-dropdown-item-name {
    font-size: 14px;
    font-weight: 500;
    color: #1e293b;
}

.quick-dropdown-item-kcal {
    font-size: 12px;
    font-weight: 600;
    color: #10b981;
    background: rgba(16, 185, 129, 0.1);
    padding: 4px 10px;
    border-radius: 8px;
}

.quick-dropdown-empty {
    padding: 20px;
    text-align: center;
    color: #94a3b8;
    font-size: 13px;
}

/* Scrollbar dropdown */
.quick-dropdown::-webkit-scrollbar {
    width: 5px;
}

.quick-dropdown::-webkit-scrollbar-track {
    background: transparent;
}

.quick-dropdown::-webkit-scrollbar-thumb {
    background: rgba(148, 163, 184, 0.25);
    border-radius: 3px;
}

/* ========================================
   ðŸ†• SEZIONE MANGIA FUORI (senza card)
   ======================================== */

.restaurant-section-new {
    margin-top: 28px;
    padding: 0 4px;
}

.restaurant-title-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 2px;
}

.restaurant-icon-new {
    font-size: 20px;
}

.restaurant-title-new {
    font-size: 15px;
    font-weight: 600;
    color: #475569;
}

.restaurant-buttons-new {
    display: flex;
    gap: 10px;
    margin-top: 12px;
}

.restaurant-add-btn-new {
    flex: 1;
    background: linear-gradient(135deg, #10b981 0%, #0d9488 100%);
    color: white;
    border: none !important;
    border-radius: 12px !important;
    padding: 14px 16px !important;
    font-size: 14px !important;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 14px -4px rgba(16, 185, 129, 0.4);
    transition: all 0.3s ease !important;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.restaurant-add-btn-new:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 18px -5px rgba(16, 185, 129, 0.5);
}

.restaurant-edit-btn-new {
    width: 50px;
    height: 50px;
    background: rgba(148, 163, 184, 0.12);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(148, 163, 184, 0.15) !important;
    border-radius: 12px !important;
    color: #64748b;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.3s ease !important;
    display: flex;
    align-items: center;
    justify-content: center;
}

.restaurant-edit-btn-new:hover {
    background: rgba(148, 163, 184, 0.2);
    color: #475569;
}

/* Custom meal section */
.quick-custom-meal {
    margin-top: 14px;
    background: rgba(148, 163, 184, 0.08);
    border-radius: 14px;
    padding: 16px;
    display: none;
}

.quick-custom-meal.show {
    display: block;
    animation: dropdownSlide 0.2s ease;
}

.quick-custom-input {
    width: 100%;
    background: rgba(255, 255, 255, 0.8) !important;
    border: 1px solid rgba(148, 163, 184, 0.15) !important;
    border-radius: 10px !important;
    padding: 12px 14px !important;
    font-size: 14px !important;
    margin-bottom: 10px;
    outline: none !important;
    transition: all 0.2s ease;
}

.quick-custom-input:focus {
    border-color: rgba(16, 185, 129, 0.4) !important;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.08);
}

.quick-custom-confirm {
    width: 100%;
    background: linear-gradient(135deg, #10b981 0%, #0d9488 100%);
    color: white;
    border: none !important;
    border-radius: 10px !important;
    padding: 12px !important;
    font-size: 14px !important;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.quick-custom-confirm:hover {
    transform: scale(1.02);
}

/* Nascondi vecchia card ristorante */
.ristorante-card {
    display: none !important;
}

/* ========================================
   ðŸ†• MANGIA FUORI - MIGLIORAMENTI
   ======================================== */

/* Header con subtitle */
.restaurant-header-new {
    margin-bottom: 16px;
}

.restaurant-title-row {
    display: flex;
    align-items: center;
    gap: 8px;
    position: relative;
}

.restaurant-subtitle-new {
    margin: 4px 0 0 28px;
    font-size: 12px;
    color: #94a3b8;
    font-weight: 400;
}

/* ========================================
   BOTTONE E TOOLTIP INFO - STILE PRO
   ======================================== */

/* Sottotitolo allineato a sinistra */
.restaurant-subtitle-pro {
    margin: 0;
    padding-left: 0;
    font-size: 12px;
    color: #94a3b8;
    font-weight: 400;
    line-height: 1.3;
}

/* Bottone Info PRO */
.restaurant-info-btn-pro {
    width: 18px;
    height: 18px;
    background: transparent;
    border: none;
    color: #cbd5e1;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    margin-left: 4px;
    padding: 0;
    flex-shrink: 0;
}

.restaurant-info-btn-pro:hover {
    color: #94a3b8;
}

.restaurant-info-btn-pro:active {
    transform: scale(0.9);
}

/* Tooltip PRO - Sfumato come app moderne */
.restaurant-info-tooltip-pro {
    position: absolute;
    bottom: calc(100% + 10px);
    left: 0;
    width: 260px;
    background: rgba(15, 23, 42, 0.92);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-radius: 12px;
    padding: 12px 14px;
    box-shadow: 0 8px 32px -8px rgba(0, 0, 0, 0.3),
                0 2px 8px rgba(0, 0, 0, 0.1);
    z-index: 1001;
    display: none;
    animation: tooltipFadeInPro 0.2s ease;
}

.restaurant-info-tooltip-pro.show {
    display: block;
}

@keyframes tooltipFadeInPro {
    from {
        opacity: 0;
        transform: translateY(6px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Freccia tooltip */
.info-tooltip-arrow-pro {
    position: absolute;
    bottom: -5px;
    left: 70px;
    width: 10px;
    height: 10px;
    background: rgba(15, 23, 42, 0.92);
    transform: rotate(45deg);
}

/* Contenuto tooltip */
.info-tooltip-content-pro {
    position: relative;
    z-index: 1;
}

.info-tooltip-title-pro {
    font-size: 12px;
    font-weight: 600;
    color: #f8fafc;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.info-tooltip-text-pro {
    font-size: 11px;
    color: #94a3b8;
    line-height: 1.5;
}

/* Bottone Aggiungi PRO (stesso stile dell'altro) */
.restaurant-add-btn-pro {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: linear-gradient(135deg, #064e3b 0%, #166534 50%, #22c55e 100%);
    color: white;
    border: none !important;
    border-radius: 12px !important;
    padding: 14px 20px !important;
    font-size: 14px !important;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(6, 78, 59, 0.3), 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.restaurant-add-btn-pro:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(6, 78, 59, 0.4), 0 4px 8px rgba(0, 0, 0, 0.15);
}

.restaurant-add-btn-pro:active {
    transform: translateY(-1px) scale(0.98);
    box-shadow: 0 4px 12px rgba(6, 78, 59, 0.3);
}

.restaurant-add-btn-icon {
    background: rgba(255, 255, 255, 0.25);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}

.restaurant-add-btn-pro:hover .restaurant-add-btn-icon {
    background: rgba(255, 255, 255, 0.35);
    transform: scale(1.1);
}

/* Shimmer effect per bottone ristorante */
.restaurant-add-btn-pro::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    pointer-events: none;
}

.restaurant-add-btn-pro:hover::after {
    animation: quickShimmer 0.8s ease;
}

/* Bottone Modifica PRO */
.restaurant-edit-btn-pro {
    width: 54px;
    height: 54px;
    background: rgba(148, 163, 184, 0.12);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(148, 163, 184, 0.15) !important;
    border-radius: 14px !important;
    color: #64748b;
    cursor: pointer;
    transition: all 0.3s ease !important;
    display: flex;
    align-items: center;
    justify-content: center;
}

.restaurant-edit-btn-pro:hover {
    background: rgba(99, 102, 241, 0.12);
    border-color: rgba(99, 102, 241, 0.2) !important;
    color: #6366f1;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
}

.restaurant-edit-btn-pro:active {
    transform: scale(0.95);
}

/* Rimuovi vecchi stili bottoni ristorante */
.restaurant-add-btn-new,
.restaurant-edit-btn-new {
    display: none !important;
}

/* ========================================
   SLIDE-IN FULLSCREEN (Fabbisogno)
   ======================================== */

.fullscreen-slide {
    position: fixed;
    top: 0;
    right: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
    z-index: 100001;
    overflow-y: auto;
    transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    padding-bottom: 40px;
}

.fullscreen-slide.open {
    right: 0;
}

.fullscreen-slide-header {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    padding: 50px 20px 30px;
    border-radius: 0 0 32px 32px;
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.fullscreen-slide-back {
    width: 40px;
    height: 40px;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.fullscreen-slide-back:hover {
    background: rgba(255,255,255,0.3);
    transform: scale(1.05);
}

.fullscreen-slide-content {
    padding: 20px;
    margin-top: -20px;
}

.slide-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 100000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

.slide-overlay.open {
    opacity: 1;
    visibility: visible;
}

/* Tooltip Info Fabbisogno */
.fabbisogno-info-tooltip {
    position: absolute;
    top: calc(100% + 10px);
    right: 0;
    width: 280px;
    background: rgba(15, 23, 42, 0.95);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-radius: 14px;
    padding: 14px 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
    z-index: 100002;
    display: none;
    animation: tooltipFadeInPro 0.25s ease;
}

.fabbisogno-info-tooltip.show {
    display: block;
}


body.dark-mode .navbar {
    background: linear-gradient(135deg, rgba(30,41,59,0.95) 0%, rgba(51,65,85,0.98) 50%, rgba(71,85,105,0.95) 100%);
}


/* ====== FIX MANGIA FUORI - Titolo e sottotitolo attaccati ====== */
.restaurant-section-new {
    margin-top: 24px !important;
}

.restaurant-section-new .mangia-fuori-title {
    font-size: 16px;
    font-weight: 700;
    color: #1e293b;
    margin: 0 !important;
    padding: 0;
    line-height: 1.2;
}

.restaurant-section-new .mangia-fuori-subtitle {
    font-size: 12px;
    color: #64748b;
    margin: 2px 0 0 0 !important;
    padding: 0;
    line-height: 1.3;
}


/* ========================================
   NUTRIFLOW PROFESSIONAL CALCULATOR
   Design identico al codice React
   ======================================== */

/* Glass Card Base */
.glass-card-nutriflow {
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(30px) saturate(120%);
    -webkit-backdrop-filter: blur(30px) saturate(120%);
    border: 1px solid rgba(255, 255, 255, 0.12);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), 0 10px 15px -3px rgba(0, 0, 0, 0.2);
}

.glass-card-nutriflow:hover {
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transform: translateY(-1px);
}

/* Slide Animation */
@keyframes slideInNutriflow {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.animate-slide-nutriflow {
    animation: slideInNutriflow 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

/* Input Styling - SENZA RIQUADRO VISIBILE */
.input-nutriflow {
    background: transparent !important;
    backdrop-filter: none !important;
    border: none !important;
    border-radius: 0 !important;
    padding: 0 !important;
    /* ðŸ†• NESSUN font-size qui - viene definito inline */
    font-weight: 600;
    color: white;
    transition: none;
    outline: none !important;
    width: 100%;
}

.input-nutriflow:focus {
    border: none !important;
    background: transparent !important;
    outline: none !important;
    box-shadow: none !important;
}

/* Remove number input spinners */
.input-nutriflow[type="number"]::-webkit-inner-spin-button,
.input-nutriflow[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.input-nutriflow[type="number"] {
    -moz-appearance: textfield;
}

/* Shimmer Effect */
.shimmer-nutriflow {
    position: relative;
    overflow: hidden;
}

.shimmer-nutriflow::after {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        to bottom right,
        rgba(255, 255, 255, 0) 0%,
        rgba(255, 255, 255, 0.1) 40%,
        rgba(255, 255, 255, 0.1) 60%,
        rgba(255, 255, 255, 0) 100%
    );
    transform: rotate(45deg);
    transition: all 0.7s;
    pointer-events: none;
}

.shimmer-nutriflow:hover::after {
    left: 100%;
    top: 100%;
}

/* Label Style */
.label-small-nutriflow {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.4);
}

/* Spinning Animation per AI Loading */
@keyframes spin-nutriflow {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

.spin-animation {
    animation: spin-nutriflow 1s linear infinite;
}

/* Canvas Animation */
@keyframes growSegment {
    from {
        transform: scale(0);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

/* ========== SFONDO PROGRESSO DI OGGI ========== */

/* Importa font Fredoka */
@import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap');

/* Animazione marble per il titolo */
@keyframes marbleFlow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* Animazione rotazione lenta anello */
@keyframes ringRotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Animazione pulse sottile */
@keyframes subtlePulse {
    0%, 100% { opacity: 0.9; }
    50% { opacity: 1; }
}

#riepilogoCard {
    background-image: url('img/sfondo_dieta.png');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    position: relative;
    overflow: hidden;
}

/* Rimuovi i blur decorativi */
#riepilogoCard .fabbisogno-blur-1,
#riepilogoCard .fabbisogno-blur-2 {
    display: none;
}

/* Contenuto sopra overlay */
#riepilogoCard > * {
    position: relative;
    z-index: 1;
}

/* ========== TITOLO FREDOKA - DUE RIGHE ========== */
#riepilogoCard .fabbisogno-title {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0px;
    line-height: 1.1;
}

#riepilogoCard .fabbisogno-title .title-line-1,
#riepilogoCard .fabbisogno-title .title-line-2 {
    font-family: 'Fredoka', sans-serif;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: -0.5px;
    background-image: linear-gradient(110deg, 
        #064e3b 0%, 
        #14532d 12%, 
        #166534 24%, 
        #22c55e 36%, 
        #3f6212 48%, 
        #064e3b 60%, 
        #4d7c0f 72%, 
        #166534 84%, 
        #14532d 100%);
    background-size: 300% 300%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: marbleFlow 30s ease-in-out infinite;
    filter: drop-shadow(0 2px 4px rgba(6, 78, 59, 0.15)) contrast(1.15) brightness(1.05);
}

#riepilogoCard .fabbisogno-title .title-line-1 {
    font-size: 28px;
}

#riepilogoCard .fabbisogno-title .title-line-2 {
    font-size: 22px;
    margin-top: -2px;
}

/* ========== BOTTONE CALCOLA ========== */
#riepilogoCard .fabbisogno-btn-calc {
    color: #064e3b;
    border-color: rgba(6, 78, 59, 0.3);
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(8px);
    animation: subtlePulse 4s ease-in-out infinite;
}

#riepilogoCard .fabbisogno-btn-calc:hover {
    background: rgba(255, 255, 255, 0.4);
}

#riepilogoCard .fabbisogno-btn-calc svg {
    stroke: #064e3b;
}

/* ========== DONUT CHART ========== */
#riepilogoCard .donut-chart {
    animation: ringRotate 60s linear infinite;
}

#riepilogoCard .donut-ring {
    stroke: rgba(6, 78, 59, 0.15);
}

#riepilogoCard .donut-segment {
    stroke: #064e3b;
}

#riepilogoCard .donut-value {
    color: #064e3b;
    font-weight: 700;
}

#riepilogoCard .donut-separator {
    color: rgba(6, 78, 59, 0.5);
}

#riepilogoCard .donut-total {
    color: rgba(6, 78, 59, 0.7);
}

#riepilogoCard .donut-label {
    color: #166534;
    font-weight: 600;
}

/* ========== BOTTONE DETTAGLI ========== */
#riepilogoCard .dettagli-btn {
    color: #064e3b;
    border-color: rgba(6, 78, 59, 0.3);
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(8px);
}

#riepilogoCard .dettagli-btn:hover {
    background: rgba(255, 255, 255, 0.4);
}

#riepilogoCard .dettagli-btn svg {
    stroke: #064e3b;
}

/* ========== MACRO NUTRIENTS ========== */
#riepilogoCard .macro-label-new {
    color: #064e3b;
    font-weight: 600;
}

#riepilogoCard .macro-current {
    color: #064e3b;
    font-weight: 700;
}

#riepilogoCard .macro-separator {
    color: rgba(6, 78, 59, 0.6);
}

/* Progress bars background */
#riepilogoCard .macro-progress-bar {
    background: rgba(6, 78, 59, 0.15);
}

/* Proteine */
#riepilogoCard .macro-item-new:nth-child(1) .macro-progress-fill {
    background: linear-gradient(90deg, #064e3b, #166534);
}

/* Carbo */
#riepilogoCard .macro-item-new:nth-child(2) .macro-progress-fill {
    background: linear-gradient(90deg, #14532d, #22c55e);
}

/* Grassi */
#riepilogoCard .macro-item-new:nth-child(3) .macro-progress-fill {
    background: linear-gradient(90deg, #3f6212, #4d7c0f);
}
  
/* ========== ICONA ALBERO ACCANTO A OGGI ========== */
#riepilogoCard .title-tree-icon {
    height: 28px;
    width: auto;
    margin-left: 6px;
    vertical-align: middle;
    display: inline-block;
    margin-top: -2px;
}  

@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap');

:root {
    --nature-dark: #051410;
    --nature-sage: #2e7d32;
    --nature-autumn: #e65100;
    --nature-spring: #7cb342;
    --nature-sky: #0288d1;
    --bg-gradient: linear-gradient(135deg, #fffdfa 0%, #f1f8e9 50%, #fffde7 100%);
}

* { box-sizing: border-box; }

.analisi-salute-wrapper {
    font-family: 'Outfit', sans-serif;
    -webkit-font-smoothing: antialiased;
    background: var(--bg-gradient);
    color: var(--nature-dark);
    min-height: 100vh;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: 9999;
    overflow-y: auto;
    overflow-x: hidden;
    display: none;
    animation: slideFromTop 0.4s ease-out;
}

@keyframes slideFromTop {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Blobs */
.blob {
    position: fixed;
    width: 500px;
    height: 500px;
    border-radius: 50%;
    filter: blur(100px);
    z-index: 0;
    opacity: 0.35;
    animation: drift 25s infinite alternate ease-in-out;
    pointer-events: none;
}

@keyframes drift {
    from { transform: translate(-20px, -20px); }
    to { transform: translate(40px, 40px); }
}

.blob-1 { background: #c5e1a5; top: -10%; left: -5%; }
.blob-2 { background: #ffe082; bottom: -5%; right: -5%; }
.blob-3 { background: #a5d6a7; top: 35%; right: -15%; }

.analisi-salute-wrapper::-webkit-scrollbar { width: 0px; }

/* Container */
.analisi-content {
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
    padding: 20px 16px 160px 16px;
    position: relative;
    z-index: 10;
    min-height: 100vh;
}

/* Nature Card */
.nature-card {
    width: 100%;
    background: rgba(255, 255, 255, 0.98) !important;
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1.5px solid rgba(200, 230, 201, 0.5);
    box-shadow: 0 8px 25px -10px rgba(10, 37, 30, 0.15);
    border-radius: 36px;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    margin-bottom: 20px;
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
}

.nature-card-closed {
    border-radius: 28px;
    padding: 14px 24px !important;
}
  
/* Expand Section */
.expand-section {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease;
    opacity: 0;
}

.expand-section.open {
    max-height: 6000px;
    opacity: 1;
    margin-top: 20px;
}

.rotate-btn { 
    transition: transform 0.3s ease; 
    font-size: 14px;
    color: var(--nature-dark);
}
.rotate-btn.active { transform: rotate(180deg); }

/* Progress */
.progress-track {
    height: 12px;
    background: #e8f5e9;
    border-radius: 20px;
    overflow: hidden;
}

.micro-track {
    height: 6px;
    background: #f1f8e9;
    border-radius: 10px;
    overflow: hidden;
    margin-top: 6px;
}

/* Tooltip */
.tooltip-box {
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 8px;
    background: #004d40;
    color: white;
    padding: 16px;
    border-radius: 16px;
    font-size: 12px;
    width: 240px;
    z-index: 100;
    box-shadow: 0 15px 35px rgba(0,0,0,0.25);
    display: none;
    line-height: 1.5;
}

.tooltip-box.show {
    display: block;
    animation: fadeInDown 0.2s ease-out;
}

@keyframes fadeInDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Header */
.header-section { margin-bottom: 20px; }

.header-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 16px;
}

.header-left {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.riepilogo-label {
    font-size: 15px !important;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #0a1a14;
    opacity: 0.8;
    margin: 0;
    white-space: nowrap;
    flex-shrink: 0;
}

.peso-grande {
    font-size: 56px !important;
    font-weight: 900;
    color: var(--nature-dark);
    letter-spacing: -0.05em;
    line-height: 1;
    margin: 0;
    white-space: nowrap;
    flex-shrink: 0;
}

.peso-grande span {
    font-size: 22px !important;
    font-weight: 300;
    opacity: 0.3;
}

/* Toggle Container */
.time-toggle-container {
    display: flex;
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.6));
    padding: 9px;
    border-radius: 28px;
    border: 1px solid rgba(255, 255, 255, 0.9);
    box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.1), 
                0 2px 6px -2px rgba(0, 0, 0, 0.05),
                inset 0 1px 2px rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(12px);
}

.time-toggle-item {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.time-toggle-btn {
    padding: 10px 18px;
    border-radius: 16px;
    font-size: 11px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    background: transparent;
    border: none;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    color: #0a1a14;
    opacity: 0.6;
}

.time-toggle-btn:hover {
    opacity: 0.85;
    background: rgba(46, 125, 50, 0.08);
}

.time-toggle-btn.active {
    background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
    color: white;
    opacity: 1;
    box-shadow: 0 6px 20px -4px rgba(46, 125, 50, 0.5),
                0 3px 8px -2px rgba(46, 125, 50, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
}

.time-toggle-desc {
    font-size: 8px;
    font-weight: 900;
    color: #0a1a14;
    opacity: 0.4;
    text-transform: uppercase;
    letter-spacing: -0.05em;
    margin-top: 4px;
}

/* Grafico Card - SFONDO COMPLETAMENTE TRASPARENTE */
.grafico-card {
    width: calc(100% + 15px) !important;
    height: auto !important;
    min-height: 320px !important;
    padding: 0 0px 0 0 !important;
    position: relative !important;
    left: -34px !important;
    display: block !important;
    background: transparent !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    border: none !important;
    box-shadow: none !important;
    border-radius: 0 !important;
    margin: 0 0 8px 0 !important;
}
  
.grafico-card .chart-container {
    background: transparent !important;
    border: none !important;
    border-radius: 0 !important;
    padding: 0 !important;
    margin: 0 !important;
    height: 300px !important;
    width: 100% !important;
}

.grafico-card canvas {
    background: transparent !important;
}

/* Info Button Grafico Peso */
.peso-info-btn {
    position: absolute;
    top: 0px;
    left: 0px;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: rgba(5, 150, 105, 0.1);
    border: 1.5px solid rgba(5, 150, 105, 0.3);
    color: #059669;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 25;
}

.peso-info-btn:hover {
    background: rgba(5, 150, 105, 0.2);
    transform: scale(1.1);
}

.peso-info-tooltip {
    position: absolute;
    top: 30px;
    left: 0;
    width: 280px;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 16px;
    padding: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    z-index: 1000;
}

.peso-info-tooltip.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.peso-info-tooltip h4 {
    color: #4ade80;
    font-size: 13px;
    font-weight: 700;
    margin: 0 0 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.peso-info-tooltip p {
    color: rgba(255,255,255,0.85);
    font-size: 11px;
    line-height: 1.5;
    margin: 0 0 8px 0;
}

.peso-info-tooltip .info-note {
    color: rgba(255,255,255,0.6);
    font-size: 10px;
    font-style: italic;
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.1);
}  
  
.variazione-box {
    position: absolute;
    top: 0px;
    right: 0px;
    text-align: right;
    z-index: 20;
}

.variazione-title {
    font-size: 9px;
    font-weight: 900;
    color: #059669;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    margin: 0 0 2px 0;
}

.variazione-value {
    font-size: 20px;
    font-weight: 900;
    color: #047857;
    letter-spacing: -0.05em;
    margin: 0;
}

.chart-container {
    width: 100% !important;
    height: 180px !important;
    position: relative !important;
}
  
/* Section Card */
.section-card { padding: 28px; }

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
}

.section-title {
    font-size: 12px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.25em;
    color: #0a1a14;
    margin: 0;
}

/* ========== COMPOSIZIONE CORPOREA - LAYOUT VERTICALE ========== */
.body-grid {
    display: flex;
    flex-direction: row;
    gap: 20px;
    margin-bottom: 24px;
    align-items: center;
}

.pie-container {
    width: 180px;
    height: 180px;
    flex-shrink: 0;
}

.body-legend {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-width: 0;
}

.legend-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 14px;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 14px;
    border: 1px solid rgba(124, 179, 66, 0.2);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.legend-left {
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 0;
}

.legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
}

.legend-name {
    font-size: 11px;
    font-weight: 800;
    color: #0a1a14;
    text-transform: uppercase;
    letter-spacing: -0.02em;
    white-space: nowrap;
}

.legend-value {
    font-size: 13px;
    font-weight: 900;
    color: var(--nature-dark);
    flex-shrink: 0;
    margin-left: 8px;
}

/* Mobile: layout verticale */
@media (max-width: 450px) {
    .body-grid {
        flex-direction: column;
    }
    
    .pie-container {
        width: 160px;
        height: 160px;
    }
    
    .body-legend {
        width: 100%;
    }
}

.btn-section {
    padding-top: 20px;
    border-top: 1px solid rgba(46, 125, 50, 0.1);
    display: flex;
    justify-content: center;
}

.btn-accent-ia {
    width: 100%;
    padding: 16px 24px;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.15) 100%);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 16px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    position: relative;
    overflow: hidden;
}

.btn-accent-ia::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.1), transparent);
    transition: left 0.5s ease;
}

.btn-accent-ia:hover {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.2) 100%);
    border-color: rgba(16, 185, 129, 0.5);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2);
}

.btn-accent-ia:hover::before {
    left: 100%;
}

.btn-accent-ia:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.ia-result-box {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(5, 150, 105, 0.05) 100%);
    border: 1px solid rgba(16, 185, 129, 0.2);
    border-radius: 16px;
    padding: 16px 18px;
    margin-top: 12px;
}

.ia-result-text {
    font-size: 13px;
    font-style: italic;
    color: #374151;
    line-height: 1.6;
    text-align: justify;
    text-align-last: left;
}

.ia-result-box .ia-result-label {
    font-size: 9px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: #10b981;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* Bio-Nutrizione */
.info-container {
    display: flex;
    align-items: center;
    gap: 8px;
    position: relative;
}

.info-btn {
    background: none;
    border: none;
    color: rgba(46, 125, 50, 0.6);
    font-size: 16px;
    cursor: pointer;
    padding: 0;
    transition: all 0.3s ease;
}

.info-btn:hover { color: var(--nature-sage); transform: scale(1.1); }
.info-btn.hidden { opacity: 0; transform: scale(0); pointer-events: none; }

.macros-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.macro-header {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    font-weight: 900;
    text-transform: uppercase;
    margin-bottom: 8px;
}

.macro-label { color: #0a1a14; }
.macro-value { color: var(--nature-dark); }
.macro-value span { opacity: 0.3; }

.progress-fill {
    height: 100%;
    border-radius: 20px;
    transition: width 1s ease;
}

/* Micronutrienti */
.micros-section {
    padding-top: 32px;
    border-top: 1px solid rgba(46, 125, 50, 0.1);
}

.micros-title {
    font-size: 10px;
    font-weight: 900;
    text-transform: uppercase;
    color: #0a1a14;
    opacity: 0.4;
    letter-spacing: 0.15em;
    margin-bottom: 24px;
    text-align: center;
}

.micros-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px 24px;
    margin-bottom: 24px;
}

@media (max-width: 400px) {
    .micros-grid { grid-template-columns: 1fr; }
}

.micro-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.micro-name {
    font-size: 11px;
    font-weight: 900;
    color: #0a1a14;
    text-transform: uppercase;
    margin: 0;
}

.micro-value {
    font-size: 11px;
    font-weight: 900;
    color: var(--nature-dark);
}

.micro-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 1s ease;
}

.micro-status {
    font-size: 9px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-top: 6px;
    display: block;
}

.micro-status.good { color: #047857; opacity: 0.6; }
.micro-status.warning { color: #ea580c; }

.btn-ia-nutrizione {
    width: 100%;
    padding: 16px 24px;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(109, 40, 217, 0.12) 100%);
    color: #7c3aed;
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 16px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    position: relative;
    overflow: hidden;
}

.btn-ia-nutrizione::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.1), transparent);
    transition: left 0.5s ease;
}

.btn-ia-nutrizione:hover {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(109, 40, 217, 0.18) 100%);
    border-color: rgba(139, 92, 246, 0.5);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(139, 92, 246, 0.2);
}

.btn-ia-nutrizione:hover::before {
    left: 100%;
}

.btn-ia-nutrizione:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.ia-result-box.nutrizione {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(109, 40, 217, 0.05) 100%);
    border: 1px solid rgba(139, 92, 246, 0.2);
}

.ia-result-box.nutrizione .ia-result-label {
    color: #7c3aed;
}

.ia-result-close {
    position: absolute;
    top: 10px;
    right: 12px;
    width: 22px;
    height: 22px;
    background: rgba(0, 0, 0, 0.08);
    border: none;
    border-radius: 50%;
    color: #6b7280;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.ia-result-close:hover {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
    transform: scale(1.1);
}

.ia-result-box {
    position: relative;
}  
  
/* Efficienza Metabolica */
.metabolic-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.metabolic-card-dig {
    padding: 20px;
    background: linear-gradient(to bottom right, #d1fae5, #f0fdf4);
    border-radius: 24px;
    border: 1px solid #a7f3d0;
}

.metabolic-card-rec {
    padding: 20px;
    background: linear-gradient(to bottom right, #ffedd5, #fffbeb);
    border-radius: 24px;
    border: 1px solid #fed7aa;
}

.metabolic-label-dig, .metabolic-label-rec {
    font-size: 10px;
    font-weight: 900;
    text-transform: uppercase;
    opacity: 0.7;
    margin-bottom: 6px;
    letter-spacing: 0.1em;
}

.metabolic-label-dig { color: #065f46; }
.metabolic-label-rec { color: #9a3412; }

.metabolic-value-dig, .metabolic-value-rec {
    font-size: 26px;
    font-weight: 900;
    letter-spacing: -0.05em;
    margin: 0;
}

.metabolic-value-dig { color: #064e3b; }
.metabolic-value-rec { color: #7c2d12; }

.metabolic-desc-dig, .metabolic-desc-rec {
    font-size: 8px;
    font-weight: 900;
    margin-top: 6px;
    text-transform: uppercase;
}

.metabolic-desc-dig { color: #047857; }
.metabolic-desc-rec { color: #c2410c; }

.basale-card {
    padding: 20px;
    background: linear-gradient(to right, rgba(224, 242, 254, 0.5), transparent);
    border-radius: 24px;
    border: 1px solid #bae6fd;
    margin-top: 16px;
}

.basale-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.basale-label {
    font-size: 11px;
    font-weight: 900;
    text-transform: uppercase;
    color: #0a1a14;
}

.basale-value {
    font-size: 22px;
    font-weight: 900;
    color: var(--nature-dark);
}

.basale-value span {
    font-size: 11px;
    font-weight: 400;
    opacity: 0.4;
}

.basale-desc {
    font-size: 11px;
    font-weight: 600;
    color: #1b332b;
    line-height: 1.5;
    opacity: 0.8;
    margin: 0;
}

/* Consulto IA */
.consulto-container {
    text-align: center;
    padding: 12px 0;
}

.btn-consulto {
    padding: 20px 48px;
    background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
    color: white;
    border: none;
    border-radius: 9999px;
    font-size: 11px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.3em;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 20px 40px -10px rgba(27, 94, 32, 0.4);
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-consulto:hover { transform: scale(1.05); }
.btn-consulto:active { transform: scale(0.95); }

.loading-box {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    padding: 40px 0;
}

.loading-box.show { display: flex; }

.spinner {
    width: 56px;
    height: 56px;
    border: 5px solid #d1fae5;
    border-top-color: #059669;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-text {
    font-size: 10px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.25em;
    color: #0a1a14;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Result Card */
.result-card {
    display: none;
    background: var(--nature-dark);
    color: white;
    text-align: left;
    padding: 32px;
    border-radius: 32px;
    position: relative;
    overflow: hidden;
    margin-top: 20px;
}

.result-card.show {
    display: block;
    animation: slideUp 0.7s ease;
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(50px); }
    to { opacity: 1; transform: translateY(0); }
}

.result-blur {
    position: absolute;
    top: 0;
    right: 0;
    width: 280px;
    height: 280px;
    background: rgba(16, 185, 129, 0.2);
    filter: blur(100px);
    margin-right: -140px;
    margin-top: -140px;
}

.result-content { position: relative; z-index: 10; }

.result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 20px;
    margin-bottom: 32px;
}

.result-title {
    font-size: 24px;
    font-weight: 900;
    letter-spacing: -0.05em;
    text-transform: uppercase;
    margin: 0;
}

.result-score {
    padding: 8px 20px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 9999px;
    font-size: 11px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.feedback-box {
    background: rgba(16, 185, 129, 0.15);
    padding: 24px;
    border-radius: 28px;
    border: 1px solid rgba(16, 185, 129, 0.2);
    margin-bottom: 24px;
}

.feedback-label {
    font-size: 10px;
    font-weight: 900;
    color: #34d399;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 12px;
}

.feedback-text {
    font-size: 16px;
    font-weight: 500;
    font-style: italic;
    line-height: 1.5;
    color: #ecfdf5;
    margin: 0;
}

.detail-box {
    padding: 24px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 28px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 20px;
}

.detail-label {
    font-size: 10px;
    font-weight: 900;
    color: #34d399;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 16px;
}

.detail-text {
    font-size: 14px;
    font-weight: 500;
    line-height: 1.5;
    color: white;
    margin: 0;
    white-space: pre-wrap;
}

.action-box {
    padding: 24px;
    background: rgba(5, 150, 105, 0.4);
    border-radius: 28px;
    border: 1px solid rgba(16, 185, 129, 0.5);
}

.action-label {
    font-size: 10px;
    font-weight: 900;
    color: rgba(255, 255, 255, 0.7);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 12px;
}

.action-text {
    font-size: 20px;
    font-weight: 900;
    color: white;
    line-height: 1.25;
    margin: 0;
}

.btn-close-result {
    margin-top: 16px;
    width: 100%;
    padding: 16px;
    background: transparent;
    border: none;
    font-size: 10px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.25em;
    color: rgba(255, 255, 255, 0.3);
    cursor: pointer;
    transition: color 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.btn-close-result:hover { color: white; }

/* ========== NUOVO STILE ANALISI IA OVERLAY ========== */
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

.ai-panel-overlay {
    position: fixed;
    inset: 0;
    background: linear-gradient(180deg, rgba(1, 8, 7, 0.98) 0%, rgba(0, 5, 4, 1) 100%);
    backdrop-filter: blur(100px);
    z-index: 10000;
    display: none;
    flex-direction: column;
    padding: 1.5rem;
    overflow-y: auto;
    animation: aiFadeIn 0.7s ease;
}

.ai-panel-overlay.show {
    display: flex;
}

@keyframes aiFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.ai-font-stylish { font-family: 'Syne', sans-serif; }
.ai-font-tech { font-family: 'Space Grotesk', sans-serif; }

.ai-header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.2rem 2rem;
    border-radius: 2.5rem;
    background: linear-gradient(135deg, rgba(2, 32, 23, 0.95) 0%, rgba(4, 47, 36, 0.9) 100%);
    border: 1px solid rgba(16, 185, 129, 0.4);
    margin-bottom: 2.5rem;
    backdrop-filter: blur(20px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(16, 185, 129, 0.1);
}

.ai-header-title {
    font-family: 'Syne', sans-serif;
    font-size: 1.6rem;
    font-weight: 700;
    color: rgba(10, 200, 70, 0.98);
    letter-spacing: -0.02em;
    margin: 0;
    text-shadow:
    0 1px 2px rgba(0, 0, 0, 0.35),
    0 0 6px rgba(20, 143, 119, 0.25);
}

.ai-header-title span {
    color: #148F77;
text-shadow:
    0 1px 2px rgba(0, 0, 0, 0.35),
    0 0 6px rgba(20, 143, 119, 0.25);
}

.ai-header-decor {
    height: 60px;
    width: auto;
    opacity: 0.60;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}

.ai-score-badge {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.25) 100%);
    padding: 0.6rem 1.4rem;
    border-radius: 2rem;
    border: 1px solid rgba(16, 185, 129, 0.35);
    color: #bef264;
    font-weight: 800;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.15);
}

.ai-score-badge::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.15), 
        transparent);
    animation: scoreShine 3s ease-in-out infinite;
}

@keyframes scoreShine {
    0% { left: -100%; }
    50%, 100% { left: 100%; }
}

.ai-score-badge .score-label {
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    opacity: 0.6;
}

.ai-glass-box {
    border-radius: 3.5rem;
    padding: 3rem;
    margin-bottom: 2.2rem;
    backdrop-filter: blur(80px) saturate(160%);
    border: 1px solid rgba(0, 255, 65, 0.25);
    box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.7),
                0 0 15px rgba(0, 255, 65, 0.08);
    animation: matrixBorder 4s ease-in-out infinite;
}

@keyframes matrixBorder {
    0%, 100% { 
        border-color: rgba(0, 255, 65, 0.2);
        box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.7),
                    0 0 12px rgba(0, 255, 65, 0.06);
    }
    50% { 
        border-color: rgba(0, 255, 65, 0.4);
        box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.7),
                    0 0 18px rgba(0, 255, 65, 0.1);
    }
}

.ai-coach-box {
    background: linear-gradient(145deg, rgba(16, 185, 129, 0.25) 0%, rgba(20, 184, 166, 0.1) 100%);
}

.ai-detail-box {
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.01) 100%);
}

.ai-action-box {
    background: linear-gradient(145deg, rgba(190, 242, 100, 0.2) 0%, rgba(22, 163, 74, 0.1) 100%);
    border: 1px solid rgba(190, 242, 100, 0.2);
}

.ai-title-label {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 4px;
    margin-bottom: 1.5rem;
    display: block;
    color: #bef264;
    opacity: 0.9;
    text-align: center;
}

.ai-content-text {
    color: #f1f5f9;
    line-height: 1.7;
    font-size: 1.15rem;
    font-weight: 500;
}

.ai-action-text {
    color: #f1f5f9;
    line-height: 1.7;
    font-size: 1.15rem;
    font-weight: 500;
}

.accurate-advice-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    animation: slideDown 0.6s ease-out;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

.metric-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

.metric-item {
    padding: 1rem 1.2rem;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.04) 0%, rgba(255, 255, 255, 0.02) 100%);
    border-radius: 1.2rem;
    border: 1px solid rgba(255, 255, 255, 0.08);
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
}

.metric-item .metric-label {
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    margin: 0;
    letter-spacing: 0.15em;
    padding-bottom: 0.4rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
}

.metric-item .metric-label.prot { color: #34d399; }
.metric-item .metric-label.carb { color: #fb923c; }
.metric-item .metric-label.fat { color: #38bdf8; }

.metric-item .metric-value {
    color: #e2e8f0;
    line-height: 1.65;
    font-size: 0.9rem;
    font-weight: 400;
    margin: 0;
    text-align: justify;
    text-align-last: left;
    padding: 0 0.3rem;
}

.previsioni-list {
    margin-top: 1rem;
}

.previsioni-title {
    font-size: 9px;
    font-weight: 700;
    color: rgba(255,255,255,0.4);
    text-transform: uppercase;
    letter-spacing: 0.2em;
    margin-bottom: 12px;
}

.previsione-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.previsione-item:last-child {
    border-bottom: none;
}

.previsione-item .prev-title {
    font-size: 13px;
    font-weight: 500;
    color: rgba(255,255,255,0.7);
}

.previsione-item .prev-perc {
    font-size: 13px;
    font-weight: 800;
    color: #34d399;
}

.ai-extra-text {
    font-size: 13px;
    font-style: italic;
    color: rgba(255,255,255,0.6);
    line-height: 1.5;
    margin-top: 1rem;
}

.cyber-btn {
    width: 100%;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.6);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border-radius: 2.25rem;
    padding: 1.6rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 3px;
    font-size: 0.75rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-bottom: 1rem;
}

.cyber-btn-accent {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(190, 242, 100, 0.2));
    border: 1px solid rgba(16, 185, 129, 0.4);
    color: #bef264;
}

.cyber-btn:hover {
    background: rgba(255, 255, 255, 0.08);
    color: #fff;
    transform: translateY(-2px);
    border-color: rgba(255, 255, 255, 0.3);
}

.cyber-btn:disabled {
    opacity: 0.5;
    pointer-events: none;
}
  
/* Footer */
.analisi-footer {
    text-align: center;
    padding: 40px 0;
    opacity: 0.3;
}

.analisi-footer p {
    font-size: 10px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.5em;
    color: #0a1a14;
    margin: 0;
}  

/* ========================================
   FILTRI BARRA RICERCA PASTO
   ======================================== */
.quick-search-filters {
    display: none;
    gap: 8px;
    margin-bottom: 10px;
    padding: 10px 12px;
    background: rgba(16, 185, 129, 0.08);
    border-radius: 12px;
    animation: filtersSlideDown 0.2s ease;
    flex-wrap: wrap;
    align-items: center;
}

.quick-search-filters.show {
    display: flex;
}

@keyframes filtersSlideDown {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
}

.quick-filter-dropdown {
    padding: 8px 12px;
    border: none;
    border-radius: 18px;
    background: rgba(16, 185, 129, 0.2);
    color: #059669;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    outline: none;
    transition: all 0.2s ease;
}

.quick-filter-dropdown:hover,
.quick-filter-dropdown:focus {
    background: rgba(16, 185, 129, 0.3);
}

.quick-filter-mini-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 18px;
    background: rgba(16, 185, 129, 0.2);
    color: #059669;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 4px;
}

.quick-filter-mini-btn:hover {
    background: rgba(16, 185, 129, 0.3);
}

.quick-filter-mini-btn.active {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.quick-filter-mini-btn svg {
    width: 12px;
    height: 12px;
}

.quick-filter-reset-btn {
    padding: 6px 10px;
    border: none;
    border-radius: 12px;
    background: transparent;
    color: #9ca3af;
    font-size: 11px;
    cursor: pointer;
    margin-left: auto;
    transition: all 0.2s ease;
}

.quick-filter-reset-btn:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

/* Dark mode */
body.dark-mode .quick-search-filters {
    background: rgba(16, 185, 129, 0.1);
}

body.dark-mode .quick-filter-dropdown,
body.dark-mode .quick-filter-mini-btn {
    background: rgba(16, 185, 129, 0.2);
    color: #34d399;
}

body.dark-mode .quick-filter-mini-btn.active {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}  

/* ========================================
   CARD SELEZIONE QUANTITÃ€
   ======================================== */
.qty-select-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.qty-select-overlay.show {
    display: flex;
}

.qty-select-card {
    position: relative;
    width: 100%;
    max-width: 400px;
    background: linear-gradient(135deg, #a7f3d0, #6ee7b7, #34d399);
    border-radius: 2.5rem;
    padding: 1.75rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.5);
    overflow: hidden;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    animation: qtyCardPop 0.25s ease;
}

@keyframes qtyCardPop {
    from { opacity: 0; transform: scale(0.92) translateY(20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

/* Decorazioni astratte */
.qty-deco-svg-top {
    position: absolute;
    top: -2rem;
    right: -2rem;
    width: 12rem;
    height: 12rem;
    color: #064e3b;
    opacity: 0.08;
    pointer-events: none;
}

.qty-deco-svg-bottom {
    position: absolute;
    bottom: -3rem;
    left: -3rem;
    width: 16rem;
    height: 16rem;
    color: #064e3b;
    opacity: 0.05;
    pointer-events: none;
}

.qty-floating-ring {
    position: absolute;
    border: 1px solid rgba(6, 78, 59, 0.06);
    border-radius: 50%;
    pointer-events: none;
}

.qty-ring-1 { width: 150px; height: 150px; top: 20%; left: -20px; transform: rotate(45deg); }
.qty-ring-2 { width: 100px; height: 100px; bottom: 15%; right: 10%; transform: rotate(-12deg); }

.qty-card-content {
    position: relative;
    z-index: 10;
}

/* Header */
.qty-select-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.75rem;
}

.qty-select-title {
    font-size: 1.5rem;
    font-weight: 800;
    color: #064e3b;
    margin: 0;
    letter-spacing: -0.025em;
}

.qty-select-subtitle {
    font-size: 1rem;
    font-weight: 500;
    color: #047857;
    opacity: 0.85;
    margin: 0.25rem 0 0 0;
}

.qty-select-close {
    background: rgba(255, 255, 255, 0.4);
    border: none;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #064e3b;
    transition: background 0.2s;
}

.qty-select-close:hover {
    background: rgba(255, 255, 255, 0.6);
}

/* Input Row */
.qty-select-input-row {
    display: flex;
    gap: 0.85rem;
    margin-bottom: 1.75rem;
}

.qty-select-number {
    width: 33%;
    background: white;
    border: none;
    border-radius: 1.4rem;
    padding: 1.1rem 0;
    text-align: center;
    font-size: 1.6rem;
    font-weight: 800;
    color: #064e3b;
    box-shadow: 0 4px 10px rgba(0,0,0,0.04);
    outline: none;
    transition: box-shadow 0.2s;
}

.qty-select-number:focus {
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
}

.qty-unit-select-wrapper {
    width: 67%;
    position: relative;
}

.qty-select-unit {
    width: 100%;
    background: white;
    border: none;
    border-radius: 1.4rem;
    padding: 1.1rem 1.25rem;
    font-size: 1.1rem;
    font-weight: 700;
    color: #064e3b;
    appearance: none;
    -webkit-appearance: none;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.04);
    outline: none;
}

.qty-select-arrow {
    position: absolute;
    right: 1.1rem;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    color: #064e3b;
}

/* Grid buttons */
.qty-select-presets {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.85rem;
    margin-bottom: 0.85rem;
}

.qty-preset-btn {
    background: rgba(255, 255, 255, 0.4);
    border: none;
    border-radius: 1.2rem;
    padding: 0.9rem 0;
    font-size: 1rem;
    font-weight: 700;
    color: #064e3b;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
}

.qty-preset-btn:hover {
    background: rgba(255, 255, 255, 0.6);
    transform: translateY(-1px);
}

.qty-preset-btn.active {
    background: #059669;
    color: white;
    transform: scale(1.05);
    box-shadow: 0 12px 20px -5px rgba(5, 150, 105, 0.3);
}

/* Footer */
.qty-select-actions {
    display: flex;
    gap: 1.25rem;
    margin-top: 2rem;
}

.qty-select-cancel {
    flex: 1;
    background: rgba(255, 255, 255, 0.4);
    border: none;
    border-radius: 1.4rem;
    padding: 1.1rem 0;
    font-size: 1.1rem;
    font-weight: 700;
    color: #065f46;
    cursor: pointer;
    transition: all 0.25s;
}

.qty-select-cancel:hover {
    background: rgba(255, 255, 255, 0.6);
}

.qty-select-confirm {
    flex: 1;
    background: #059669;
    border: none;
    border-radius: 1.4rem;
    padding: 1.1rem 0;
    font-size: 1.1rem;
    font-weight: 700;
    color: white;
    cursor: pointer;
    box-shadow: 0 10px 25px -5px rgba(5, 150, 105, 0.3);
    transition: all 0.25s;
}

.qty-select-confirm:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 30px -5px rgba(5, 150, 105, 0.4);
}

.qty-select-confirm:active {
    transform: scale(0.96);
}

/* Dark mode */
body.dark-mode .qty-select-card {
    background: linear-gradient(135deg, #064e3b, #065f46, #047857);
    border-color: rgba(255, 255, 255, 0.1);
}

body.dark-mode .qty-select-title {
    color: #ecfdf5;
}

body.dark-mode .qty-select-subtitle {
    color: #a7f3d0;
}

body.dark-mode .qty-select-close {
    background: rgba(255, 255, 255, 0.1);
    color: #ecfdf5;
}

body.dark-mode .qty-select-number {
    background: rgba(0, 0, 0, 0.3);
    color: #ecfdf5;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

body.dark-mode .qty-unit-select-wrapper .qty-select-unit {
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: #ecfdf5;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

body.dark-mode .qty-select-unit option {
    background: #1e293b;
    color: #ecfdf5;
}

body.dark-mode .qty-select-arrow {
    color: #a7f3d0;
}

body.dark-mode .qty-preset-btn {
    background: rgba(255, 255, 255, 0.1);
    color: #ecfdf5;
}

body.dark-mode .qty-preset-btn:hover {
    background: rgba(255, 255, 255, 0.15);
}

body.dark-mode .qty-preset-btn.active {
    background: #10b981;
    color: white;
}

body.dark-mode .qty-select-cancel {
    background: rgba(255, 255, 255, 0.1);
    color: #ecfdf5;
}

body.dark-mode .qty-select-cancel:hover {
    background: rgba(255, 255, 255, 0.15);
}

body.dark-mode .qty-deco-svg-top,
body.dark-mode .qty-deco-svg-bottom {
    color: #a7f3d0;
    opacity: 0.1;
}

body.dark-mode .qty-floating-ring {
    border-color: rgba(167, 243, 208, 0.1);
}

/* ========================================
   SELEZIONE CORRENTE (sotto progressi)
   ======================================== */
.quick-selection-display {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 14px;
    margin-bottom: 10px;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.15) 100%);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 12px;
    animation: selectionFadeIn 0.2s ease;
}

@keyframes selectionFadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

.quick-selection-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.quick-selection-name {
    font-size: 14px;
    font-weight: 600;
    color: #065f46;
}

.quick-selection-qty {
    font-size: 12px;
    color: #059669;
}

.quick-selection-edit {
    padding: 6px 10px;
    border: none;
    border-radius: 8px;
    background: rgba(16, 185, 129, 0.2);
    color: #059669;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.quick-selection-edit:hover {
    background: rgba(16, 185, 129, 0.3);
}

.quick-selection-remove {
    width: 28px;
    height: 28px;
    border: none;
    border-radius: 50%;
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.quick-selection-remove:hover {
    background: rgba(239, 68, 68, 0.2);
}

/* Dark mode */
body.dark-mode .quick-selection-display {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.2) 100%);
    border-color: rgba(16, 185, 129, 0.4);
}

body.dark-mode .quick-selection-name {
    color: #34d399;
}

body.dark-mode .quick-selection-qty {
    color: #6ee7b7;
}

body.dark-mode .quick-selection-edit {
    background: rgba(16, 185, 129, 0.25);
    color: #34d399;
}

/* ========================================
   RISULTATI RICERCA IA NEL DROPDOWN
   ======================================== */
.quick-dropdown-ai-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 20px;
    color: #6b7280;
    font-size: 14px;
}

.quick-dropdown-ai-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    cursor: pointer;
    transition: all 0.15s ease;
    border-bottom: 1px solid #f1f5f9;
}

.quick-dropdown-ai-item:hover {
    background: #f8fafc;
}

.quick-dropdown-ai-item:last-child {
    border-bottom: none;
}

.quick-dropdown-ai-item-left {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.quick-dropdown-ai-item-name {
    font-size: 14px;
    font-weight: 600;
    color: #1f2937;
}

.quick-dropdown-ai-item-info {
    font-size: 12px;
    color: #6b7280;
}

.quick-dropdown-ai-item-right {
    display: flex;
    align-items: center;
    gap: 8px;
}

.quick-dropdown-ai-item-kcal {
    font-size: 13px;
    font-weight: 600;
    color: #059669;
}

.quick-dropdown-new-badge {
    padding: 3px 8px;
    border-radius: 10px;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
}

/* Dark mode */
body.dark-mode .quick-dropdown-ai-item:hover {
    background: #334155;
}

body.dark-mode .quick-dropdown-ai-item-name {
    color: #f1f5f9;
}

body.dark-mode .quick-dropdown-ai-item-info {
    color: #94a3b8;
}  

/* ========================================
   FOOTER CARD DETTAGLIO - STELLINA + SALVA
   ======================================== */
.recipe-detail-footer-row {
    display: flex;
    gap: 14px;
    align-items: center;
    pointer-events: auto;
}

/* Stellina minimal senza riquadro */
.recipe-detail-star-btn {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 50%;
    background: transparent;
    color: #cbd5e1;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    flex-shrink: 0;
    padding: 0;
}

.recipe-detail-star-btn:hover {
    color: #fbbf24;
    transform: scale(1.15);
}

.recipe-detail-star-btn:active {
    transform: scale(0.95);
}

.recipe-detail-star-btn.active {
    color: #fbbf24;
}

.recipe-detail-star-btn.active svg {
    fill: #fbbf24;
    stroke: #fbbf24;
    filter: drop-shadow(0 0 6px rgba(251, 191, 36, 0.5));
}

.recipe-detail-star-btn svg {
    width: 20px;
    height: 20px;
    transition: all 0.25s ease;
}

/* Bottone Salva compatto e professionale */
.recipe-detail-save-btn {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 12px;
    background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #1e293b 100%);
    background-size: 200% 200%;
    color: white;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 
        0 4px 15px rgba(15, 23, 42, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.recipe-detail-save-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s ease;
}

.recipe-detail-save-btn:hover {
    background-position: 100% 100%;
    transform: translateY(-2px);
    box-shadow: 
        0 8px 25px rgba(15, 23, 42, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
}

.recipe-detail-save-btn:hover::before {
    left: 100%;
}

.recipe-detail-save-btn:active {
    transform: translateY(0) scale(0.98);
}

.recipe-detail-save-btn.saved {
    background: linear-gradient(135deg, #059669 0%, #10b981 50%, #059669 100%);
    background-size: 200% 200%;
}

.recipe-detail-save-btn-icon {
    display: flex;
    align-items: center;
    justify-content: center;
}

.recipe-detail-save-btn-icon svg {
    width: 16px;
    height: 16px;
    color: rgba(255, 255, 255, 0.9);
}

.recipe-detail-save-btn-text {
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.2px;
}

/* Dark mode */
body.dark-mode .recipe-detail-star-btn {
    color: #64748b;
}

body.dark-mode .recipe-detail-star-btn:hover,
body.dark-mode .recipe-detail-star-btn.active {
    color: #fbbf24;
}

body.dark-mode .recipe-detail-save-btn {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
    box-shadow: 
        0 4px 15px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
} 

.cerca-ricette-search-btn {
    display: none !important;
}  

/* ========================================
   DETTAGLI RICETTA - FULLSCREEN
   ======================================== */

.recipe-detail-fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: #fdfdfd;
    z-index: 999999;
    display: none;
    flex-direction: column;
    overflow: hidden;
}

.recipe-detail-fullscreen.open {
    display: flex;
}

/* Variabili colori */
.recipe-detail-fullscreen {
    --rd-bg-body: #fdfdfd;
    --rd-bg-card: #ffffff;
    --rd-bg-subtle: #f8fafc;
    --rd-border-light: #e2e8f0;
    --rd-text-main: #1e293b;
    --rd-text-body: #475569;
    --rd-text-muted: #94a3b8;
    --rd-text-dark: #0f172a;
    --rd-primary: #14b8a6;
    --rd-primary-hover: #0d9488;
    --rd-primary-light: #f0fdfa;
    --rd-primary-border: #2dd4bf;
    --rd-accent-yellow: #fbbf24;
    --rd-danger: #ef4444;
    --rd-danger-bg: #fef2f2;
    --rd-danger-border: #fee2e2;
}

/* Screen management */
.rd-screen {
    display: none;
    flex-direction: column;
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    background: var(--rd-bg-body);
}

.rd-screen.active {
    display: flex;
    z-index: 10;
}

/* Header */
.rd-header {
    position: sticky;
    top: 0;
    z-index: 50;
    background: linear-gradient(180deg, 
        rgba(255, 255, 255, 0.98) 0%, 
        rgba(248, 250, 252, 0.95) 50%,
        rgba(241, 245, 249, 0.9) 100%);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-bottom: 1px solid rgba(226, 232, 240, 0.5);
    box-shadow: 
        0 4px 20px rgba(0, 0, 0, 0.06),
        0 2px 8px rgba(0, 0, 0, 0.04),
        inset 0 -1px 0 rgba(255, 255, 255, 0.8);
    padding: 12px 16px;
    padding-top: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    min-height: 64px;
}

.rd-btn-icon {
    background: transparent;
    border: none;
    padding: 10px;
    border-radius: 50%;
    color: var(--rd-text-body);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.rd-btn-icon:hover {
    background-color: var(--rd-bg-subtle);
}

.rd-btn-icon:active {
    transform: scale(0.95);
}

.rd-header-title {
    flex: 1;
    font-size: 17px;
    font-weight: 700;
    color: var(--rd-text-dark);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-family: 'Inter', system-ui, sans-serif;
}

/* Scroll content */
.rd-scroll-content {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 20px;
    scrollbar-width: none;
}

.rd-scroll-content::-webkit-scrollbar {
    display: none;
}

.rd-content-padding {
    padding: 20px 20px;
}

/* Hero Section */
.rd-hero-section {
    display: flex;
    gap: 16px;
    margin-bottom: 28px;
}

.rd-hero-image-container {
    width: 42%;
    flex-shrink: 0;
    aspect-ratio: 1/1;
    position: relative;
}

.rd-hero-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 20px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.rd-image-badges {
    position: absolute;
    bottom: 8px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    gap: 6px;
}

.rd-badge {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(4px);
    padding: 4px 8px 4px 6px;
    border-radius: 999px;
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 9px;
    font-weight: 700;
    color: var(--rd-text-main);
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.rd-hero-details {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding-top: 2px;
    padding-bottom: 2px;
}

.rd-macros-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 8px;
}

.rd-macro-card {
    background: var(--rd-bg-card);
    border: 1px solid var(--rd-bg-subtle);
    border-radius: 14px;
    padding: 8px 4px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px -2px rgba(0,0,0,0.05);
}

.rd-macro-label {
    font-size: 9px;
    text-transform: uppercase;
    font-weight: 800;
    letter-spacing: 0.1em;
    color: var(--rd-text-muted);
    margin-bottom: 2px;
}

.rd-macro-value {
    font-size: 15px;
    font-weight: 700;
    color: var(--rd-text-main);
    letter-spacing: -0.02em;
}

.rd-description-box {
    background: rgba(248, 250, 252, 0.8);
    border: 1px solid var(--rd-border-light);
    border-radius: 12px;
    padding: 10px;
    flex: 1;
    display: flex;
    align-items: center;
}

.rd-description-text {
    font-size: 11px;
    color: var(--rd-text-body);
    line-height: 1.5;
    font-weight: 500;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Divider */
.rd-divider {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    margin-bottom: 28px;
}

.rd-divider-line {
    height: 1px;
    width: 48px;
    background-color: var(--rd-border-light);
    border-radius: 99px;
}

.rd-divider-text {
    font-size: 10px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    font-weight: 700;
    color: var(--rd-text-body);
}

/* Section Headers */
.rd-section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 18px;
}

.rd-icon-box {
    background-color: var(--rd-primary-light);
    color: var(--rd-primary);
    padding: 8px;
    border-radius: 10px;
    display: flex;
}

.rd-section-title {
    font-size: 11px;
    font-weight: 800;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--rd-text-dark);
    margin: 0;
}

/* Ingredient List */
.rd-ingredient-list {
    list-style: none;
    padding: 0;
    margin: 0;
    padding-left: 4px;
}

.rd-ingredient-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
}

.rd-ing-name-group {
    display: flex;
    align-items: center;
    gap: 14px;
}

.rd-ing-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #cbd5e1;
    transition: background 0.2s ease;
}

.rd-ingredient-item:hover .rd-ing-dot {
    background: #14b8a6;
}

.rd-ing-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--rd-text-body);
}

.rd-ing-amount {
    font-size: 12px;
    font-weight: 700;
    color: var(--rd-text-body);
    background-color: var(--rd-bg-subtle);
    padding: 6px 12px;
    border-radius: 8px;
    border: 1px solid rgba(226, 232, 240, 0.5);
    min-width: 3.5rem;
    text-align: center;
}

/* Steps Timeline */
.rd-timeline-container {
    position: relative;
    padding-left: 32px;
}

.rd-timeline-line {
    position: absolute;
    left: 6px;
    top: 20px;
    bottom: 30px;
    width: 2px;
    background: linear-gradient(to bottom, #14b8a6 0%, #99f6e4 50%, transparent 100%);
    border-radius: 2px;
}

.rd-step-item {
    position: relative;
    padding-left: 32px;
    padding-bottom: 24px;
}

.rd-step-item:last-child {
    padding-bottom: 0;
}

.rd-step-item:last-child {
    margin-bottom: 0;
}

.rd-step-marker-container {
    position: absolute;
    left: -32px;
    top: 4px;
}

.rd-step-marker {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: linear-gradient(135deg, #ffffff 0%, #f0fdfa 100%);
    border: 3px solid #14b8a6;
    box-shadow: 
        0 0 0 4px rgba(20, 184, 166, 0.12),
        0 2px 6px rgba(20, 184, 166, 0.2);
    z-index: 10;
    transition: all 0.2s ease;
}

.rd-step-item:hover .rd-step-marker {
    box-shadow: 0 0 0 6px rgba(20,184,166,0.2);
    transform: scale(1.1);
}

.rd-step-text {
    font-size: 14px;
    font-weight: 500;
    line-height: 1.6;
    color: var(--rd-text-body);
    margin: 0;
}

.rd-step-item:hover .rd-step-text {
    color: #334155;
}
  
/* Footer */
.rd-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(180deg, 
        rgba(248, 250, 252, 0.95) 0%, 
        rgba(255, 255, 255, 0.98) 30%,
        rgba(255, 255, 255, 1) 100%);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-top: 1px solid rgba(226, 232, 240, 0.6);
    padding: 16px 20px 28px 20px;
    z-index: 100;
    box-shadow: 
        0 -8px 30px rgba(0, 0, 0, 0.08),
        0 -4px 12px rgba(0, 0, 0, 0.04),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
}

.rd-footer-row {
    display: flex;
    align-items: center;
    gap: 12px;
}

.rd-btn-primary {
    flex: 1;
    height: 52px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    border-radius: 14px;
    background-color: var(--rd-text-dark);
    color: white;
    font-weight: 700;
    font-size: 14px;
    border: none;
    cursor: pointer;
    box-shadow: 0 10px 15px -3px rgba(226, 232, 240, 0.8);
    transition: all 0.2s;
    font-family: 'Inter', system-ui, sans-serif;
}

.rd-btn-primary:hover {
    background-color: var(--rd-text-body);
}

.rd-btn-primary:active {
    transform: scale(0.98);
}

.rd-btn-secondary {
    flex: none;
    height: 52px;
    width: 52px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 14px;
    background-color: var(--rd-danger-bg);
    color: var(--rd-danger);
    border: 1px solid rgba(254, 226, 226, 0.5);
    cursor: pointer;
    transition: all 0.2s;
}

.rd-btn-secondary:hover {
    background-color: var(--rd-danger-border);
}

.rd-btn-secondary:active {
    transform: scale(0.98);
}

/* ========================================
   EDIT MODE
   ======================================== */

.rd-edit-image-container {
    width: 100%;
    aspect-ratio: 1/1;
    position: relative;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    margin-bottom: 28px;
    cursor: pointer;
}

.rd-edit-overlay {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, 0.4);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.rd-edit-icon-circle {
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    padding: 12px;
    margin-bottom: 8px;
    color: white;
    display: flex;
}

.rd-edit-text-overlay {
    color: white;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-transform: uppercase;
}

.rd-form-group {
    margin-bottom: 20px;
}

.rd-form-row {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
}

.rd-form-col {
    flex: 1;
}

.rd-label-tiny {
    font-size: 10px;
    text-transform: uppercase;
    font-weight: 800;
    color: var(--rd-text-muted);
    letter-spacing: 0.05em;
    margin-left: 4px;
    margin-bottom: 6px;
    display: block;
}

.rd-input-base {
    width: 100%;
    background-color: var(--rd-bg-subtle);
    border: 1px solid var(--rd-border-light);
    border-radius: 12px;
    padding: 12px 14px;
    color: var(--rd-text-main);
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    transition: all 0.2s;
    box-sizing: border-box;
}

.rd-input-base:focus {
    outline: none;
    border-color: var(--rd-primary);
    box-shadow: 0 0 0 2px rgba(20, 184, 166, 0.15);
}

.rd-input-lg {
    font-size: 17px;
    font-weight: 700;
}

.rd-input-icon-wrapper {
    position: relative;
}

.rd-input-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--rd-text-muted);
    pointer-events: none;
}

.rd-input-w-icon {
    padding-left: 38px;
}

.rd-macro-edit-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
}

.rd-macro-edit-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.rd-macro-edit-input {
    width: 100%;
    text-align: center;
    background-color: var(--rd-bg-subtle);
    border: 1px solid var(--rd-border-light);
    border-radius: 10px;
    padding: 10px 6px;
    font-size: 14px;
    font-weight: 700;
    color: var(--rd-text-main);
    box-sizing: border-box;
}

.rd-macro-edit-input:focus {
    outline: none;
    border-color: var(--rd-primary);
}

.rd-textarea-base {
    width: 100%;
    background-color: var(--rd-bg-subtle);
    border: 1px solid var(--rd-border-light);
    border-radius: 12px;
    padding: 12px 14px;
    color: var(--rd-text-body);
    font-size: 14px;
    font-weight: 500;
    font-family: 'Inter', sans-serif;
    resize: none;
    line-height: 1.6;
    box-sizing: border-box;
}

.rd-textarea-base:focus {
    outline: none;
    border-color: var(--rd-primary);
}

.rd-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.rd-btn-add {
    font-size: 10px;
    font-weight: 700;
    color: var(--rd-primary);
    background-color: var(--rd-primary-light);
    padding: 5px 10px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: background 0.2s;
}

.rd-btn-add:hover {
    background-color: #ccfbf1;
}

.rd-edit-list-row {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
    align-items: center;
}

.rd-btn-remove {
    background: none;
    border: none;
    color: #cbd5e1;
    padding: 8px;
    cursor: pointer;
    transition: color 0.2s;
    display: flex;
    align-items: center;
    flex-shrink: 0;
}

.rd-btn-remove:hover {
    color: var(--rd-danger);
}

.rd-step-number {
    width: 26px;
    height: 26px;
    background-color: var(--rd-border-light);
    color: var(--rd-text-muted);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 700;
    flex-shrink: 0;
}

.rd-btn-save {
    background-color: var(--rd-primary) !important;
    box-shadow: 0 10px 15px -3px rgba(20, 184, 166, 0.3) !important;
}

.rd-btn-save:hover {
    background-color: var(--rd-primary-hover) !important;
}

/* Dark Mode */
body.dark-mode .recipe-detail-fullscreen {
    --rd-bg-body: #0f172a;
    --rd-bg-card: #1e293b;
    --rd-bg-subtle: #1e293b;
    --rd-border-light: #334155;
    --rd-text-main: #e2e8f0;
    --rd-text-body: #94a3b8;
    --rd-text-muted: #64748b;
    --rd-text-dark: #f1f5f9;
    --rd-primary-light: rgba(20, 184, 166, 0.15);
}

body.dark-mode .recipe-detail-fullscreen {
    background: #0f172a;
}

body.dark-mode .rd-header {
    background: linear-gradient(180deg, 
        rgba(15, 23, 42, 0.98) 0%, 
        rgba(30, 41, 59, 0.95) 50%,
        rgba(30, 41, 59, 0.9) 100%);
    border-bottom-color: rgba(51, 65, 85, 0.5);
    box-shadow: 
        0 4px 20px rgba(0, 0, 0, 0.2),
        0 2px 8px rgba(0, 0, 0, 0.15),
        inset 0 -1px 0 rgba(71, 85, 105, 0.3);
}

body.dark-mode .rd-footer {
    background: linear-gradient(180deg, 
        rgba(30, 41, 59, 0.95) 0%, 
        rgba(15, 23, 42, 0.98) 30%,
        rgba(15, 23, 42, 1) 100%);
    border-top-color: rgba(51, 65, 85, 0.5);
    box-shadow: 
        0 -8px 30px rgba(0, 0, 0, 0.3),
        0 -4px 12px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(71, 85, 105, 0.3);
}

body.dark-mode .rd-btn-primary {
    background-color: #e2e8f0;
    color: #0f172a;
}

body.dark-mode .rd-btn-primary:hover {
    background-color: #f1f5f9;
}  

/* Bottone salva inline (senza footer fisso) */
.rd-btn-save-inline {
    width: 100%;
    height: 54px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    border-radius: 16px;
    background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
    color: white;
    font-weight: 700;
    font-size: 15px;
    border: none;
    cursor: pointer;
    box-shadow: 
        0 8px 20px rgba(20, 184, 166, 0.35),
        0 4px 8px rgba(20, 184, 166, 0.2),
        inset 0 1px 0 rgba(255,255,255,0.2);
    transition: all 0.2s ease;
    font-family: 'Inter', system-ui, sans-serif;
    margin-top: 8px;
}

.rd-btn-save-inline:hover {
    background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
    transform: translateY(-2px);
    box-shadow: 
        0 12px 28px rgba(20, 184, 166, 0.4),
        0 6px 12px rgba(20, 184, 166, 0.25);
}

.rd-btn-save-inline:active {
    transform: scale(0.98) translateY(0);
}

body.dark-mode .rd-btn-save-inline {
    background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
    box-shadow: 
        0 8px 20px rgba(20, 184, 166, 0.25),
        0 4px 8px rgba(20, 184, 166, 0.15);
}
  

/* ========== SMARTWATCH CARD ========== */
.smartwatch-card-wrapper {
  margin-top: 20px;
}

.smartwatch-section-divider {
  height: 1px;
  background: #d1d5db;
  margin-bottom: 14px;
  margin-top: 8px;
}

.smartwatch-section-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--text, #1f2937);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  position: relative;
}

.smartwatch-info-btn-pro {
  width: 18px;
  height: 18px;
  background: transparent;
  border: none;
  color: #cbd5e1;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  margin-left: 6px;
  padding: 0;
  flex-shrink: 0;
}

.smartwatch-info-btn-pro:hover {
  color: #94a3b8;
}

.smartwatch-info-btn-pro:active {
  transform: scale(0.9);
}

.smartwatch-info-tooltip-pro {
  position: absolute;
  bottom: calc(100% + 10px);
  left: 0;
  width: 280px;
  background: rgba(15, 23, 42, 0.92);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-radius: 12px;
  padding: 12px 14px;
  box-shadow: 0 8px 32px -8px rgba(0, 0, 0, 0.3),
              0 2px 8px rgba(0, 0, 0, 0.1);
  z-index: 1001;
  display: none;
  animation: tooltipFadeInPro 0.2s ease;
}

.smartwatch-info-tooltip-pro.show {
  display: block;
}

.smartwatch-tooltip-arrow {
  position: absolute;
  bottom: -5px;
  left: 90px;
  width: 10px;
  height: 10px;
  background: rgba(15, 23, 42, 0.92);
  transform: rotate(45deg);
}

.smartwatch-tooltip-content {
  position: relative;
  z-index: 1;
}

.smartwatch-tooltip-title {
  font-size: 12px;
  font-weight: 600;
  color: #f8fafc;
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.smartwatch-tooltip-text {
  font-size: 11px;
  color: #94a3b8;
  line-height: 1.5;
}

.card-container {
  width: 100%;
  max-width: 32rem;
  margin: 0 auto;
  position: relative;
  overflow: hidden;
  border-radius: 32px;
  box-shadow: 0 20px 40px -10px rgba(6, 78, 59, 0.4);
  transition: all 0.3s ease;
  background-color: #064e3b;
  border: 1px solid rgba(6, 78, 59, 0.1);
  aspect-ratio: 16/10;
}

@media (min-width: 640px) {
  .card-container {
    aspect-ratio: 2/1;
  }
}

.bg-gradient {
  position: absolute;
  inset: 0;
  background: linear-gradient(to bottom right, #022c22, #064e3b, #065f46);
  z-index: 0;
}

.bg-noise {
  position: absolute;
  inset: 0;
  opacity: 0.3;
  mix-blend-mode: overlay;
  z-index: 1;
  background-repeat: repeat;
}

.bg-waves {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 12rem;
  opacity: 0.15;
  pointer-events: none;
  overflow: hidden;
  z-index: 2;
}

.waves-svg {
  width: 200%;
  height: 100%;
  position: absolute;
  bottom: 0;
  left: 0;
}

.waves-overlay {
  position: absolute;
  inset: 0;
  background: linear-gradient(to top, transparent, transparent, rgba(6, 78, 59, 0.8));
}

.sw-content-wrapper {
  position: relative;
  z-index: 10;
  display: flex;
  flex-direction: column;
  height: 100%;
  padding: 0.75rem 1rem;
}

@media (min-width: 640px) {
  .sw-content-wrapper {
    padding: 1rem 1.5rem;
  }
}

.sw-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 2rem;
  flex-shrink: 0;
  margin-bottom: 0.125rem;
}

.sw-header-badge {
  display: flex;
  align-items: center;
  column-gap: 0.5rem;
  background-color: rgba(0, 0, 0, 0.2);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.sw-header-text {
  font-size: 10px;
  font-weight: 700;
  color: #ffffff;
  letter-spacing: 0.1em;
  text-transform: uppercase;
}

.sw-live-indicator {
  display: flex;
  align-items: center;
  column-gap: 0.5rem;
}

.sw-live-indicator.hidden {
  display: none;
}

.sw-live-text {
  font-size: 9px;
  color: rgba(167, 243, 208, 0.8);
  font-weight: 500;
  display: none;
}

@media (min-width: 640px) {
  .sw-live-text {
    display: inline;
    font-size: 10px;
  }
}

.sw-live-dot {
  width: 0.375rem;
  height: 0.375rem;
  background-color: #34d399;
  border-radius: 9999px;
  box-shadow: 0 0 8px #34d399;
  animation: swPulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

#sw-main-content {
  flex: 1;
  width: 100%;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

.sw-flex-center-row { display: flex; align-items: center; justify-content: center; width: 100%; }
.sw-flex-between-row { display: flex; align-items: center; justify-content: space-between; width: 100%; }
.sw-flex-col-center { display: flex; flex-direction: column; align-items: center; justify-content: center; }
.sw-items-start { align-items: flex-start; }
.sw-w-full { width: 100%; }
.sw-h-full { height: 100%; }
.sw-w-half { width: 50%; }
.sw-pl-2 { padding-left: 0.5rem; }

.sw-start-btn {
  position: relative;
  width: 8rem;
  height: 8rem;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
  transition: transform 0.5s ease;
}
.sw-start-btn:hover { transform: scale(1.05); }

@media (min-width: 640px) {
  .sw-start-btn { width: 10rem; height: 10rem; }
}

.sw-btn-glow {
  position: absolute;
  inset: 0;
  background-color: rgba(16, 185, 129, 0.2);
  border-radius: 9999px;
  filter: blur(40px);
  transition: all 0.3s;
}
.sw-start-btn:hover .sw-btn-glow {
  background-color: rgba(52, 211, 153, 0.3);
}

.sw-btn-svg {
  width: 100%;
  height: 100%;
  filter: drop-shadow(0 25px 25px rgb(0 0 0 / 0.15));
}

.sw-idle-title {
  font-size: 1.25rem;
  font-weight: 700;
  color: white;
  margin: 0 0 0.25rem 0;
  line-height: 1.25;
}
.sw-idle-desc {
  color: rgba(209, 250, 229, 0.7);
  font-size: 0.75rem;
  line-height: 1.375;
  margin: 0;
}
@media (min-width: 640px) {
  .sw-idle-title { font-size: 1.5rem; }
  .sw-idle-desc { font-size: 0.875rem; }
}

.sw-proc-icon-wrap {
  width: 6rem; height: 6rem;
  position: relative;
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
}
@media (min-width: 640px) {
  .sw-proc-icon-wrap { width: 7rem; height: 7rem; }
}

.sw-proc-svg-container {
  position: absolute;
  z-index: 10;
  color: rgba(255, 255, 255, 0.9);
  filter: drop-shadow(0 0 10px rgba(52, 211, 153, 0.5));
}

.sw-orbit-1 {
  position: absolute; inset: 0;
  animation: swSpin 3s linear infinite;
}
.sw-orbit-dot-1 {
  position: absolute; top: 0; left: 50%;
  transform: translate(-50%, -50%);
  width: 0.75rem; height: 0.75rem;
  background-color: #34d399;
  border-radius: 50%;
  filter: blur(2px);
  box-shadow: 0 0 15px #34d399;
}

.sw-orbit-2 {
  position: absolute; inset: 1rem;
  animation: swSpin 4s linear infinite reverse;
}
.sw-orbit-dot-2 {
  position: absolute; bottom: 0; left: 50%;
  transform: translate(-50%, 50%);
  width: 0.5rem; height: 0.5rem;
  background-color: white;
  border-radius: 50%;
  filter: blur(1px);
  box-shadow: 0 0 10px white;
}

.sw-ring-static {
  position: absolute; inset: 0;
  border-radius: 50%;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.sw-proc-text {
  color: #ecfdf5;
  font-weight: 300;
  font-size: 0.875rem;
  text-align: center;
  margin-top: 0.5rem;
  letter-spacing: 0.025em;
}
@media (min-width: 640px) {
  .sw-proc-text { font-size: 1rem; }
}

.sw-monitor-container {
  display: flex;
  flex-direction: row;
  height: 100%;
  width: 100%;
  align-items: center;
}

.sw-gauge-col {
  width: 50%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  padding-right: 0.5rem;
}
@media (min-width: 640px) { .sw-gauge-col { padding-right: 1rem; } }

.sw-gauge-wrap {
  position: relative;
  width: 170px; height: 170px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  transform: translateY(-0.25rem);
}
@media (min-width: 640px) {
  .sw-gauge-wrap { width: 210px; height: 210px; transform: translateY(-0.5rem); }
}

.sw-gauge-svg {
  width: 100%; height: 100%;
  filter: drop-shadow(0 0 15px rgba(52, 211, 153, 0.2));
  transform: rotate(135deg);
}

.sw-gauge-content {
  position: absolute; inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 10;
  padding-bottom: 0.25rem;
}

.sw-cal-val-wrap {
  position: relative;
  display: flex;
  align-items: baseline;
  justify-content: center;
}
.sw-cal-minus {
  position: absolute;
  right: 100%;
  margin-right: 0.5rem;
  font-size: 1.875rem;
  font-weight: 300;
  color: #34d399;
  opacity: 0.8;
  top: 0.25rem;
}
.sw-cal-number {
  font-size: 2.5rem;
  font-weight: 700;
  color: white;
  letter-spacing: -0.05em;
  line-height: 1;
}
.sw-cal-label {
  font-size: 0.75rem;
  color: rgba(209, 250, 229, 0.5);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-top: 0.25rem;
}

@media (min-width: 640px) {
  .sw-cal-minus { font-size: 2rem; }
  .sw-cal-number { font-size: 3rem; }
  .sw-cal-label { font-size: 0.875rem; }
}
  
.sw-stats-col {
  width: 50%;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding-left: 0.25rem;
  padding-right: 0.25rem;
  padding-bottom: 1.5rem;
  row-gap: 0.75rem;
}
@media (min-width: 640px) { .sw-stats-col { padding-left: 1rem; } }

.sw-stats-row {
  display: flex;
  column-gap: 0.5rem;
  width: 100%;
}

.sw-stat-card {
  flex: 1;
  background-color: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 0.75rem;
  padding: 0.625rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  border: 1px solid rgba(255, 255, 255, 0.05);
  box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  transition: background-color 0.3s;
}
.sw-stat-card:hover { background-color: rgba(255, 255, 255, 0.1); }

.sw-stat-val {
  font-size: 1.125rem;
  font-weight: 700;
  color: white;
  line-height: 1;
  margin-top: 0.25rem;
}
.sw-stat-label {
  font-size: 8px;
  text-transform: uppercase;
  color: rgba(167, 243, 208, 0.7);
  margin-top: 0.25rem;
}
@media (min-width: 640px) {
  .sw-stat-val { font-size: 1.25rem; }
  .sw-stat-label { font-size: 9px; }
}

.sw-insight-card {
  width: 100%;
  background-color: rgba(0, 0, 0, 0.2);
  backdrop-filter: blur(24px);
  -webkit-backdrop-filter: blur(24px);
  border: 1px solid rgba(255, 255, 255, 0.05);
  border-radius: 0.75rem;
  padding: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  height: 5rem;
  overflow: hidden;
}
@media (min-width: 640px) {
  .sw-insight-card { padding: 1rem; height: auto; }
}

.sw-insight-text {
  font-size: 10px;
  color: #ecfdf5;
  font-weight: 500;
  line-height: 1.25;
  font-style: italic;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
  margin: 0;
}
@media (min-width: 640px) { .sw-insight-text { font-size: 0.75rem; } }

.sw-icon-base { display: inline-block; vertical-align: middle; }
.sw-icon-watch { width: 0.875rem; height: 0.875rem; color: #d1fae5; }
.sw-icon-activity { width: 0.75rem; height: 0.75rem; color: #6ee7b7; animation: swPulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
.sw-icon-flame { width: 1rem; height: 1rem; color: #6ee7b7; fill: rgba(110, 231, 183, 0.2); margin-bottom: 0.25rem; opacity: 0.6; }
.sw-icon-steps { width: 0.875rem; height: 0.875rem; color: #6ee7b7; margin-bottom: 0.25rem; }
.sw-icon-bpm { width: 0.875rem; height: 0.875rem; color: #6ee7b7; margin-bottom: 0.25rem; }

@media (min-width: 640px) {
  .sw-icon-steps { width: 1rem; height: 1rem; }
  .sw-icon-bpm { width: 1rem; height: 1rem; }
}

@keyframes swSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes swPulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
@keyframes swFadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes swZoomIn { from { transform: scale(0.95); } to { transform: scale(1); } }

.sw-animate-fade-in { animation: swFadeIn 0.5s ease-out forwards; }
.sw-animate-zoom-in { animation: swZoomIn 0.5s ease-out forwards; }
.sw-gauge-circle { transition: stroke-dashoffset 2s ease-out; }

/* ========== BILANCIO ENERGETICO - WRAPPER & TITOLO ESTERNO ========== */
.bilancio-card-wrapper {
  margin-top: 16px;
}

.bilancio-section-divider {
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(96, 165, 250, 0.3), transparent);
  margin-bottom: 12px;
}

.bilancio-section-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 12px;
  position: relative;
}

.bilancio-info-btn-pro {
  width: 18px;
  height: 18px;
  background: transparent;
  border: none;
  color: #cbd5e1;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  margin-left: 6px;
  padding: 0;
  flex-shrink: 0;
}

.bilancio-info-btn-pro:hover {
  color: #94a3b8;
}

.bilancio-info-btn-pro:active {
  transform: scale(0.9);
}

.bilancio-info-tooltip-pro {
  position: absolute;
  bottom: calc(100% + 10px);
  left: 0;
  width: 280px;
  background: rgba(15, 23, 42, 0.92);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-radius: 12px;
  padding: 12px 14px;
  box-shadow: 0 8px 32px -8px rgba(0, 0, 0, 0.3),
              0 2px 8px rgba(0, 0, 0, 0.1);
  z-index: 1001;
  display: none;
  animation: tooltipFadeInPro 0.2s ease;
}

.bilancio-info-tooltip-pro.show {
  display: block;
}

.bilancio-tooltip-arrow {
  position: absolute;
  bottom: -5px;
  left: 90px;
  width: 10px;
  height: 10px;
  background: rgba(15, 23, 42, 0.92);
  transform: rotate(45deg);
}

.bilancio-tooltip-content {
  position: relative;
  z-index: 1;
}

.bilancio-tooltip-title {
  font-size: 12px;
  font-weight: 600;
  color: #f8fafc;
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.bilancio-tooltip-text {
  font-size: 11px;
  color: #94a3b8;
  line-height: 1.5;
}

/* ========== BILANCIO CARD CONTAINER ========== */
.bilancio-card-container {
  width: 100%;
  position: relative;
  overflow: hidden;
  border-radius: 24px;
  box-shadow: 0 20px 40px -10px rgba(6, 78, 59, 0.4);
  background-color: #064e3b;
  border: 1px solid rgba(6, 78, 59, 0.1);
  display: flex;
  flex-direction: column;
}

.bilancio-bg-gradient {
  position: absolute;
  inset: 0;
  background: linear-gradient(to bottom right, #022c22, #064e3b, #065f46);
  z-index: 0;
}

.bilancio-bg-noise {
  position: absolute;
  inset: 0;
  opacity: 0.3;
  mix-blend-mode: overlay;
  z-index: 1;
  background-repeat: repeat;
  background-image: url('data:image/svg+xml,%3Csvg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"%3E%3Cfilter id="noiseFilter"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="100%25" height="100%25" filter="url(%23noiseFilter)"/%3E%3C/svg%3E');
}

.bilancio-bg-waves {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 8rem;
  opacity: 0.15;
  pointer-events: none;
  overflow: hidden;
  z-index: 2;
}

.bilancio-waves-svg {
  width: 200%;
  height: 100%;
  position: absolute;
  bottom: 0;
  left: 0;
}

.bilancio-content-wrapper {
  position: relative;
  z-index: 10;
  display: flex;
  flex-direction: column;
  padding: 1.25rem;
  gap: 1rem;
}

/* ========== STATS GRID ========== */
.bilancio-stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.6rem;
}

.bilancio-grid-card {
  background-color: rgba(255, 255, 255, 0.03);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border: 1px solid rgba(255, 255, 255, 0.05);
  border-radius: 1rem;
  padding: 0.7rem 0.5rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  transition: transform 0.2s, background-color 0.2s;
}

.bilancio-grid-card:hover {
  background-color: rgba(255, 255, 255, 0.07);
  transform: translateY(-2px);
}

.bilancio-grid-icon {
  margin-bottom: 0.4rem;
  width: 1.25rem;
  height: 1.25rem;
  opacity: 0.9;
}

.bilancio-grid-value {
  font-size: 1.125rem;
  font-weight: 700;
  color: #ffffff;
  line-height: 1.2;
}

.bilancio-grid-label {
  font-size: 0.6rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: rgba(255, 255, 255, 0.5);
  margin-top: 0.2rem;
  font-weight: 500;
}

/* ========== HERO BANNER - CON MARGINI CORRETTI ========== */
.bilancio-hero-banner {
  border-radius: 1rem;
  padding: 1rem;
  margin-top: 0.5rem;
  margin-bottom: 0.5rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}

.bilancio-hero-banner.deficit {
  background: linear-gradient(90deg, rgba(248, 113, 113, 0.15) 0%, rgba(251, 146, 60, 0.1) 100%);
  border: 1px solid rgba(248, 113, 113, 0.3);
  box-shadow: 0 0 20px rgba(248, 113, 113, 0.1) inset;
}

.bilancio-hero-banner.surplus {
  background: linear-gradient(90deg, rgba(251, 146, 60, 0.15) 0%, rgba(250, 204, 21, 0.1) 100%);
  border: 1px solid rgba(251, 146, 60, 0.3);
  box-shadow: 0 0 20px rgba(251, 146, 60, 0.1) inset;
}

.bilancio-hero-banner.pareggio {
  background: linear-gradient(90deg, rgba(52, 211, 153, 0.15) 0%, rgba(16, 185, 129, 0.1) 100%);
  border: 1px solid rgba(52, 211, 153, 0.3);
  box-shadow: 0 0 20px rgba(52, 211, 153, 0.1) inset;
}

.bilancio-hero-banner::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
  opacity: 0.5;
}

.bilancio-hero-value {
  font-size: 1.875rem;
  font-weight: 800;
  line-height: 1;
  margin-bottom: 0.25rem;
}

.bilancio-hero-value.deficit { color: #f87171; text-shadow: 0 2px 10px rgba(248, 113, 113, 0.3); }
.bilancio-hero-value.surplus { color: #fb923c; text-shadow: 0 2px 10px rgba(251, 146, 60, 0.3); }
.bilancio-hero-value.pareggio { color: #34d399; text-shadow: 0 2px 10px rgba(52, 211, 153, 0.3); }

.bilancio-hero-label {
  font-size: 0.875rem;
  color: rgba(255, 255, 255, 0.7);
  font-weight: 500;
}

/* ========== INFO CARDS ========== */
.bilancio-info-list {
  display: flex;
  flex-direction: column;
  gap: 0.6rem;
}

.bilancio-info-card {
  background-color: rgba(0, 0, 0, 0.2);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid rgba(255, 255, 255, 0.05);
  border-radius: 0.75rem;
  padding: 0.7rem 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.2rem;
  position: relative;
  overflow: hidden;
}

.bilancio-info-card.analysis { border-left: 3px solid #60a5fa; }
.bilancio-info-card.advice { border-left: 3px solid #facc15; }

.bilancio-info-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.bilancio-info-icon {
  width: 1.125rem;
  height: 1.125rem;
}

.bilancio-info-title {
  font-size: 0.875rem;
  font-weight: 600;
  color: #ffffff;
}

.bilancio-info-desc {
  font-size: 0.75rem;
  color: rgba(255, 255, 255, 0.7);
  line-height: 1.4;
  padding-left: 1.625rem;
  margin: 0;
}

/* Colori utility */
.bilancio-highlight { font-weight: 600; color: #ffffff; }
.bilancio-text-fire { color: #fb923c; filter: drop-shadow(0 0 8px rgba(251, 146, 60, 0.6)); }
.bilancio-text-purple { color: #a78bfa; }
.bilancio-text-blue { color: #60a5fa; }
.bilancio-text-pink { color: #f472b6; }
.bilancio-text-yellow { color: #facc15; filter: drop-shadow(0 0 6px rgba(250, 204, 21, 0.4)); }

@media (max-width: 380px) {
  .bilancio-stats-grid { gap: 0.4rem; }
  .bilancio-grid-value { font-size: 1rem; }
  .bilancio-hero-value { font-size: 1.5rem; }
}

/* ========== DUE BILANCI AFFIANCATI ========== */
.bilancio-dual-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.75rem;
  margin-top: 0.5rem;
  margin-bottom: 0.5rem;
}

.bilancio-hero-mini {
  border-radius: 1rem;
  padding: 0.875rem 0.75rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  position: relative;
  overflow: hidden;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.08);
}

.bilancio-hero-mini.deficit {
  background: linear-gradient(135deg, rgba(248, 113, 113, 0.12) 0%, rgba(239, 68, 68, 0.06) 100%);
  border-color: rgba(248, 113, 113, 0.25);
}

.bilancio-hero-mini.surplus {
  background: linear-gradient(135deg, rgba(251, 146, 60, 0.12) 0%, rgba(245, 158, 11, 0.06) 100%);
  border-color: rgba(251, 146, 60, 0.25);
}

.bilancio-hero-mini.pareggio {
  background: linear-gradient(135deg, rgba(52, 211, 153, 0.12) 0%, rgba(16, 185, 129, 0.06) 100%);
  border-color: rgba(52, 211, 153, 0.25);
}

.bilancio-hero-mini-title {
  font-size: 0.6875rem;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: rgba(255, 255, 255, 0.7);
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.bilancio-hero-mini-value {
  font-size: 1.5rem;
  font-weight: 800;
  line-height: 1;
}

.bilancio-hero-mini-value.deficit { 
  color: #f87171; 
  text-shadow: 0 2px 8px rgba(248, 113, 113, 0.3); 
}

.bilancio-hero-mini-value.surplus { 
  color: #fb923c; 
  text-shadow: 0 2px 8px rgba(251, 146, 60, 0.3); 
}

.bilancio-hero-mini-value.pareggio { 
  color: #34d399; 
  text-shadow: 0 2px 8px rgba(52, 211, 153, 0.3); 
}

.bilancio-hero-mini-unit {
  font-size: 0.75rem;
  color: rgba(255, 255, 255, 0.5);
  font-weight: 500;
  margin-top: 0.125rem;
}

.bilancio-hero-mini-label {
  font-size: 0.75rem;
  color: rgba(255, 255, 255, 0.8);
  font-weight: 600;
  margin-top: 0.375rem;
}

.bilancio-hero-mini-desc {
  font-size: 0.625rem;
  color: rgba(255, 255, 255, 0.4);
  margin-top: 0.25rem;
}

@media (max-width: 360px) {
  .bilancio-dual-container {
    gap: 0.5rem;
  }
  .bilancio-hero-mini {
    padding: 0.75rem 0.5rem;
  }
  .bilancio-hero-mini-value {
    font-size: 1.25rem;
  }
  .bilancio-hero-mini-title {
    font-size: 0.5rem;
  }
}  
  
</style>

</head>

<body>
 
 <!-- LANGUAGE SELECTOR MODAL -->
<div id="language-selector-modal" style="display:none;position:fixed;inset:0;background:linear-gradient(135deg, #0f172a 0%, #1e293b 100%);z-index:999999;justify-content:center;align-items:center;flex-direction:column;">
    <div style="text-align:center;padding:20px;max-width:350px;width:90%;">
        <!-- Logo -->
        <div style="width:80px;height:80px;margin:0 auto 24px;background:linear-gradient(135deg,#06b6d4,#3b82f6);border-radius:20px;display:flex;align-items:center;justify-content:center;box-shadow:0 10px 40px rgba(6,182,212,0.3);">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="white">
                <rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect>
                <line x1="4" y1="10" x2="20" y2="10"></line>
            </svg>
        </div>
        
        <h1 style="color:white;font-size:24px;margin:0 0 8px 0;font-weight:700;">Frigo Smart AI</h1>
        <p style="color:#94a3b8;font-size:14px;margin:0 0 32px 0;">Seleziona la tua lingua / Select your language</p>
        
        <!-- Language Options -->
        <div style="display:flex;flex-direction:column;gap:12px;">
            <button onclick="setLanguage('it')" style="width:100%;padding:16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:white;font-size:16px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all 0.2s;" onmouseover="this.style.background='rgba(6,182,212,0.2)';this.style.borderColor='#06b6d4'" onmouseout="this.style.background='rgba(255,255,255,0.05)';this.style.borderColor='rgba(255,255,255,0.1)'">
                <span style="font-size:24px;">ðŸ‡®ðŸ‡¹</span>
                <span>Italiano</span>
            </button>
            
            <button onclick="setLanguage('en')" style="width:100%;padding:16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:white;font-size:16px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all 0.2s;" onmouseover="this.style.background='rgba(6,182,212,0.2)';this.style.borderColor='#06b6d4'" onmouseout="this.style.background='rgba(255,255,255,0.05)';this.style.borderColor='rgba(255,255,255,0.1)'">
                <span style="font-size:24px;">ðŸ‡¬ðŸ‡§</span>
                <span>English</span>
            </button>
            
            <button onclick="setLanguage('fr')" style="width:100%;padding:16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:white;font-size:16px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all 0.2s;" onmouseover="this.style.background='rgba(6,182,212,0.2)';this.style.borderColor='#06b6d4'" onmouseout="this.style.background='rgba(255,255,255,0.05)';this.style.borderColor='rgba(255,255,255,0.1)'">
                <span style="font-size:24px;">ðŸ‡«ðŸ‡·</span>
                <span>FranÃ§ais</span>
            </button>
            
            <button onclick="setLanguage('es')" style="width:100%;padding:16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:white;font-size:16px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all 0.2s;" onmouseover="this.style.background='rgba(6,182,212,0.2)';this.style.borderColor='#06b6d4'" onmouseout="this.style.background='rgba(255,255,255,0.05)';this.style.borderColor='rgba(255,255,255,0.1)'">
                <span style="font-size:24px;">ðŸ‡ªðŸ‡¸</span>
                <span>EspaÃ±ol</span>
            </button>
        </div>
    </div>
</div>

  <!-- ========================================
     TUTORIAL OVERLAY CLASSICO
     ======================================== -->
<div id="tutorial-overlay">
  <div class="tutorial-container">
    <div class="tutorial-header">
      <div class="tutorial-icon" id="classic-tutorial-icon">â„ï¸</div>
      <h1 class="tutorial-title" id="classic-tutorial-title">Benvenuto!</h1>
      <p class="tutorial-subtitle" id="classic-tutorial-subtitle">Scopri tutte le funzionalitÃ </p>
    </div>
    
    <div class="tutorial-content" id="classic-tutorial-content">
      <!-- Il contenuto cambierÃ  dinamicamente -->
    </div>
    
    <div class="tutorial-footer">
      <div class="tutorial-progress" id="classic-tutorial-progress">
        <!-- I pallini di progressione verranno aggiunti dinamicamente -->
      </div>
      
      <div class="tutorial-buttons">
        <button class="tutorial-btn tutorial-btn-skip" onclick="skipClassicTutorial()" id="classic-skip-btn">
          â­ï¸ Salta
        </button>
        <button class="tutorial-btn tutorial-btn-next" onclick="nextClassicSlide()" id="classic-next-btn">
          Avanti âž¡ï¸
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ========================================
     ðŸŽ“ PRESENTAZIONE INTERATTIVA
     ======================================== -->

<!-- Overlay scuro -->
<div id="interactive-overlay" style="display:none;position:fixed;inset:0;background:rgba(15,23,42,0.95);z-index:9998;pointer-events:none"></div>

<!-- Progress bar tutorial NUOVA -->
<style>
#tutorial-progress {
  position: fixed;
  top: 15px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(30, 41, 59, 0.95);
  backdrop-filter: blur(12px);
  padding: 8px 16px;
  border-radius: 25px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  display: none;
  align-items: center;
  gap: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
  z-index: 999999;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}
#tutorial-progress.active { display: flex; }
.progress-number {
  color: white;
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 0.5px;
}
.progress-separator {
  width: 1px;
  height: 20px;
  background: rgba(255, 255, 255, 0.3);
}
.progress-dots { display: flex; gap: 6px; }
.dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  transition: all 0.3s ease;
}
.dot.active {
  background: white;
  width: 20px;
  border-radius: 5px;
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.6);
}
@media (max-width: 768px) {
  #tutorial-progress { padding: 6px 14px; }
  .progress-number { font-size: 12px; }
  .dot { width: 7px; height: 7px; }
  .dot.active { width: 16px; }
}
@media (max-width: 480px) {
  #tutorial-progress { padding: 5px 12px; gap: 10px; }
  .progress-number { font-size: 11px; }
  .progress-dots { gap: 5px; }
  .dot { width: 6px; height: 6px; }
  .dot.active { width: 14px; }
}
</style>

<div id="tutorial-progress">
  <span class="progress-number" id="progress-number">1/13</span>
  <div class="progress-separator"></div>
  <div class="progress-dots" id="progress-dots"></div>
</div>

<script>
window.initProgressBar = function(steps) {
  const d = document.getElementById('progress-dots');
if (!d) return;

  d.innerHTML = '';
  for (let i = 0; i < steps; i++) {
    const dot = document.createElement('div');
    dot.className = 'dot';
    dot.id = 'dot-' + i;
    d.appendChild(dot);
  }

  document.getElementById('tutorial-progress').classList.add('active');
  window.updateProgressBar(0, steps);
};

window.updateProgressBar = function(step, total) {
  document.getElementById('progress-number').textContent = (step + 1) + '/' + total;
  for (let i = 0; i < total; i++) {
    const dot = document.getElementById('dot-' + i);
    dot.className = i === step ? 'dot active' : 'dot';
  }
};

window.hideProgressBar = function() {
  document.getElementById('tutorial-progress').classList.remove('active');
};
</script>

<!-- Card centrale (piÃ¹ piccola e colorata) -->
<div id="guide-character" style="display:none;position:fixed;bottom:110px;left:50%;transform:translateX(-50%);width:65%;max-width:280px;z-index:9999">
  <div style="background:linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);border-radius:16px;padding:14px 12px;box-shadow:0 20px 60px rgba(79,70,229,0.5);position:relative;border:1px solid rgba(255,255,255,0.1)">
    
    <!-- Testo -->
    <div id="guide-text" style="color:white;text-align:center;font-size:14.5px;line-height:1.6;font-weight:500"></div>
    
    <!-- Container bottoni (nascosto, verrÃ  mostrato solo quando necessario) -->
    <div id="guide-speech" style="display:none">
      <div class="guide-speech-buttons" style="display:none"></div>
    </div>
  </div>
</div>

<!-- Bottoni FUORI dalla card, a sinistra del video -->
<div id="tutorial-buttons" style="display:none;position:fixed;bottom:20px;left:20px;z-index:10000;flex-direction:column;gap:10px">
  <button id="skip-btn" class="tutorial-btn tutorial-btn-skip" onclick="skipInteractiveTutorial()">
    â­ï¸ Salta
  </button>
  <button id="next-btn" class="tutorial-btn tutorial-btn-next" onclick="nextInteractiveStep()">
    Avanti âž¡ï¸
  </button>
</div>

<!-- Video Freezy in basso a destra -->
<div id="freezy-video-container" style="display:none;position:fixed;bottom:15px;right:10px;width:110px;height:110px;z-index:10000;pointer-events:none">
  <video 
    id="freezy-video" 
    autoplay 
    loop 
    muted 
    playsinline
    style="width:100%;height:100%;object-fit:contain;filter:drop-shadow(0 10px 25px rgba(0,0,0,0.5))"
  >
    <source src="freezy-video.webm" type="video/webm">
<source src="freezy-video.mp4" type="video/mp4">  <!-- ðŸ‘ˆ Fallback MP4 -->
  <!-- Se il video non funziona, mostra un'immagine -->
  <img src="freezy-avatar.png" alt="Freezy" style="width:100%;height:100%">
  </video>
</div>

<style>
/* ========================================
   ANIMAZIONI
   ======================================== */

@keyframes arrowBounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

@keyframes pulse {
  0%, 100% { 
    box-shadow: 0 0 0 0 rgba(96,165,250,0.6);
  }
  50% { 
    box-shadow: 0 0 0 15px rgba(96,165,250,0);
  }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUpCard {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(50px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(70px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-70px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* Stati attivi */
#interactive-overlay.active {
  display: block !important;
  animation: fadeIn 0.3s ease;
  z-index: 9998 !important;
}

#interactive-progress.active {
  display: block !important;
  animation: fadeIn 0.4s ease;
}

#guide-character.active {
  display: block !important;
  animation: slideUpCard 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

#tutorial-buttons.active {
  display: flex !important;
  animation: slideInLeft 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

#freezy-video-container.active {
  display: block !important;
  animation: slideInRight 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

#interactive-arrow.active {
  display: block !important;
}

/* Progress dots */
.progress-dot-interactive {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: rgba(255,255,255,0.3);
  transition: all 0.3s ease;
}

.progress-dot-interactive.active {
  background: white;
  width: 16px;
  border-radius: 3px;
  box-shadow: 0 0 8px rgba(255,255,255,0.5);
}

/* Bottoni tutorial (fuori card) */
.tutorial-btn {
  padding: 12px 20px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
  min-width: 110px;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}

.tutorial-btn:active {
  transform: scale(0.95);
}

.tutorial-btn-skip {
  background: rgba(148,163,184,0.9);
  color: white;
  backdrop-filter: blur(10px);
}

.tutorial-btn-skip:hover {
  background: rgba(148,163,184,1);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.3);
}

.tutorial-btn-next {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
}

.tutorial-btn-next:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(59,130,246,0.5);
}

/* Elemento evidenziato - Effetto neon SUPER visibile */
.interactive-highlight {
  position: relative !important;
  z-index: 1000 !important;
  border-radius: 12px !important;
  border: 6px solid #3b82f6 !important;
  box-shadow: 
    0 0 40px rgba(59,130,246,1),
    0 0 80px rgba(59,130,246,0.9),
    0 0 120px rgba(59,130,246,0.7),
    inset 0 0 30px rgba(59,130,246,0.5) !important;
  animation: neonPulseStrong 1s ease-in-out infinite;
  transform: scale(1.08) !important;
  filter: brightness(1.2) !important;
}

/* Assicura che il bottone evidenziato sia sopra TUTTO */
nav .interactive-highlight,
button.interactive-highlight {
  position: relative !important;
  z-index: 999999 !important;
  isolation: isolate;
}

@keyframes neonPulseStrong {
  0%, 100% {
    border-color: #3b82f6;
    border-width: 6px;
    box-shadow: 
      0 0 40px rgba(59,130,246,1),
      0 0 80px rgba(59,130,246,0.9),
      0 0 120px rgba(59,130,246,0.7);
  }
  50% {
    border-color: #60a5fa;
    border-width: 8px;
    box-shadow: 
      0 0 60px rgba(96,165,250,1),
      0 0 100px rgba(96,165,250,1),
      0 0 150px rgba(96,165,250,0.8);
  }
}

/* Tooltip */
.interactive-tooltip {
  position: fixed;
  background: linear-gradient(135deg, #4f46e5, #7c3aed);
  color: white;
  padding: 14px 16px;
  border-radius: 12px;
  box-shadow: 0 12px 40px rgba(79,70,229,0.4);
  z-index: 200000;
  max-width: 260px;
  animation: tooltipPop 0.3s ease;
  border: 1px solid rgba(255,255,255,0.2);
}

/* Freccia che punta VERSO IL BASSO (tooltip sopra) */
.interactive-tooltip.arrow-bottom::after {
  content: '';
  position: absolute;
  bottom: -15px;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 15px solid transparent;
  border-right: 15px solid transparent;
  border-top: 15px solid #7c3aed;
  filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
}

/* Freccia che punta VERSO L'ALTO (tooltip sotto) */
.interactive-tooltip.arrow-top::after {
  content: '';
  position: absolute;
  top: -15px;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 15px solid transparent;
  border-right: 15px solid transparent;
  border-bottom: 15px solid #4f46e5;
  filter: drop-shadow(0 -4px 8px rgba(0,0,0,0.3));
}

/* Freccia del tooltip che punta al bottone */
.interactive-tooltip::after {
  content: '';
  position: absolute;
  bottom: -15px; /* Punta in basso verso il bottone */
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 15px solid transparent;
  border-right: 15px solid transparent;
  border-top: 15px solid #7c3aed;
  filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
  animation: arrowPoint 1.5s ease-in-out infinite;
}

@keyframes arrowPoint {
  0%, 100% { 
    bottom: -15px;
  }
  50% { 
    bottom: -20px;
  }
}

.interactive-tooltip .tooltip-title {
  font-weight: 700;
  font-size: 14px;
  margin-bottom: 6px;
}

.interactive-tooltip .tooltip-desc {
  font-size: 12px;
  line-height: 1.5;
  opacity: 0.95;
}

/* ========================================
   RESPONSIVE
   ======================================== */

@media (max-width: 768px) {
  #guide-character {
    width: 90%;
    bottom: 160px;
  }
  
  #guide-character > div {
    padding: 20px 18px;
  }
  
  #guide-text {
    font-size: 13.5px;
  }
  
  #freezy-video-container {
    width: 110px;
    height: 110px;
  }
  
  #tutorial-buttons {
    bottom: 15px;
    left: 15px;
    gap: 8px;
  }
  
  .tutorial-btn {
    padding: 10px 18px;
    font-size: 12px;
    min-width: 100px;
  }
}

@media (max-width: 480px) {
  #guide-character {
  width: 70%;  /* ðŸ‘ˆ Ridotto */
  max-width: 260px;  /* ðŸ‘ˆ Ridotto */
  bottom: 120px !important;
  }  

  #guide-character > div {
    padding: 12px 10px;
  }  

  #guide-character > div {
    padding: 18px 16px;
  }
  
  #guide-text {
    font-size: 13px;
    line-height: 1.5;
  }
  
  #freezy-video-container {
  width: 85px;  /* ðŸ‘ˆ Ridotto */
  height: 85px;  /* ðŸ‘ˆ Ridotto */
  bottom: 10px;
  right: 5px;  /* ðŸ‘ˆ Molto piÃ¹ a sinistra */
  }
  
  #tutorial-buttons {
    bottom: 12px;
    left: 12px;
    gap: 7px;
  }
  
  .tutorial-btn {
    padding: 9px 16px;
    font-size: 11.5px;
    min-width: 90px;
  }
  
  #interactive-progress {
    top: 10px;
    padding: 5px 12px;
  }
  
  .progress-dot-interactive {
    width: 5px;
    height: 5px;
  }
  
  .progress-dot-interactive.active {
    width: 14px;
  }
}

@media (max-width: 360px) {
  #guide-character {
    bottom: 130px;
  }
  
  #guide-text {
    font-size: 12px;
  }
  
  #freezy-video-container {
  width: 70px;  /* ðŸ‘ˆ Ridotto */
  height: 70px;  /* ðŸ‘ˆ Ridotto */
  right: 3px;  /* ðŸ‘ˆ Aggiunto - molto a sinistra */
  bottom: 8px;
  }
  
  .tutorial-btn {
    padding: 8px 14px;
    font-size: 11px;
    min-width: 80px;
  }
}

@media (max-height: 700px) {
  #guide-character {
    bottom: 140px;
  }
  
  #freezy-video-container {
    width: 100px;
    height: 100px;
  }
}

/* ===== FIX COMPLETO TOOLTIP E NAVBAR ===== */

/* Assicura che la navbar sia SEMPRE sotto i tooltip ma sopra l'overlay */
nav {
  position: relative;
  z-index: 9999 !important;
}

/* Ma quando Ã¨ evidenziato, va ancora piÃ¹ su */
nav .interactive-highlight {
  position: relative !important;
  z-index: 999996 !important;
}

/* Il tooltip sta sopra tutto tranne il progress */
.interactive-tooltip {
  z-index: 999997 !important;
}

/* L'overlay sta sotto */
#interactive-overlay {
  z-index: 9998 !important;
}

/* Freccia che punta VERSO IL BASSO (tooltip sopra) */
.interactive-tooltip.arrow-bottom::after {
  content: '';
  position: absolute;
  bottom: -15px;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 15px solid transparent;
  border-right: 15px solid transparent;
  border-top: 15px solid #7c3aed;
  filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
}

/* Freccia che punta VERSO L'ALTO (tooltip sotto) */
.interactive-tooltip.arrow-top::after {
  content: '';
  position: absolute;
  top: -15px;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 15px solid transparent;
  border-right: 15px solid transparent;
  border-bottom: 15px solid #4f46e5;
  filter: drop-shadow(0 -4px 8px rgba(0,0,0,0.3));
}

/* Pulisci effetti neon quando il tutorial non Ã¨ attivo */
body:not(:has(#interactive-overlay.active)) nav button {
  box-shadow: none !important;
  animation: none !important;
  filter: none !important;
}

/* Nascondi tooltip quando overlay non Ã¨ attivo */
body:not(:has(#interactive-overlay.active)) .interactive-tooltip {
  display: none !important;
}

/* Reset forzato dopo tutorial */
.tutorial-cleanup * {
  box-shadow: none !important;
  animation: none !important;
  filter: none !important;
  border-color: initial !important;
}
</style>

 <!-- Splash Screen scuro -->
<div id="app-splash">
  <div class="inner">
    <img src="icon-512.png" alt="Logo">
    <div class="txt">CARICAMENTO...</div>
  </div>
</div>


<div id="scanLoader" class="scan-loader">

  <div class="spinner"></div>

  <div class="scan-loader-text">ðŸ” Scansione in corso...<br>Attendere prego</div>

</div>

 

<div id="recipeModal" class="modal">

  <div class="modal-content">

    <div class="modal-header">

      <h2 id="modalTitle">Dettagli Ricetta</h2>

      <button class="close-modal" onclick="closeRecipeModal()">&times;</button>

    </div>

    <div id="modalBody"></div>

    <div style="margin-top:15px">

      <button class="btn-ghost" onclick="speakRecipeDetails()">ðŸ”Š Ascolta Dettagli</button>

    </div>

  </div>

</div>

 <!-- MODALE GUIDA GROQ AI -->
<div id="groqGuideModal" class="modal">
  <div class="modal-content" style="max-width:600px">
    <div class="modal-header">
      <h2>ðŸš€ Come Ottenere la Chiave API Groq</h2>
      <button class="close-modal" onclick="closeGroqGuide()">&times;</button>
    </div>
    
    <div style="margin-bottom:15px">
      <h3 style="color:var(--accent);margin-bottom:12px">ðŸ“Œ Passaggi (2 minuti):</h3>
      
      <div class="card" style="margin-bottom:10px;border-left:3px solid var(--accent)">
        <strong>1ï¸âƒ£ Registrati su Groq</strong>
        <div class="tiny" style="margin-top:4px">
          Clicca il bottone qui sotto per aprire il sito Groq
        </div>
        <a href="https://console.groq.com/keys" target="_blank" rel="noopener">
          <button class="btn-primary" style="margin-top:8px;width:100%">
            ðŸ”— Vai a Groq Console
          </button>
        </a>
      </div>
      
      <div class="card" style="margin-bottom:10px;border-left:3px solid var(--accent)">
        <strong>2ï¸âƒ£ Crea Account</strong>
        <div class="tiny" style="margin-top:4px">
          â€¢ Clicca "Sign Up" (in alto a destra)<br>
          â€¢ Usa Google, GitHub o email<br>
          â€¢ Conferma l'email (se richiesto)
        </div>
      </div>
      
      <div class="card" style="margin-bottom:10px;border-left:3px solid var(--accent)">
        <strong>3ï¸âƒ£ Genera Chiave API</strong>
        <div class="tiny" style="margin-top:4px">
          â€¢ Nel menu a sinistra, clicca "API Keys"<br>
          â€¢ Clicca "Create API Key"<br>
          â€¢ Dai un nome (es: "Frigo Smart")<br>
          â€¢ Clicca "Submit"
        </div>
      </div>
      
      <div class="card" style="margin-bottom:10px;border-left:3px solid var(--accent)">
        <strong>4ï¸âƒ£ Copia la Chiave</strong>
        <div class="tiny" style="margin-top:4px">
          â€¢ La chiave inizia con <code>gsk_</code><br>
          â€¢ Clicca il bottone "Copy" per copiarla<br>
          â€¢ âš ï¸ Salvala subito! Non la vedrai piÃ¹ dopo
        </div>
      </div>
      
      <div class="card" style="margin-bottom:10px;border-left:3px solid var(--accent)">
        <strong>5ï¸âƒ£ Incolla nell'App</strong>
        <div class="tiny" style="margin-top:4px">
          â€¢ Torna qui nelle Impostazioni<br>
          â€¢ Incolla la chiave nel campo "Chiave API Groq"<br>
          â€¢ Clicca "ðŸ’¾ Salva"<br>
          â€¢ Clicca "ðŸ§ª Testa" per verificare
        </div>
      </div>
    </div>
    
    <div class="card" style="background:rgba(22,163,74,0.05);border-left:3px solid var(--success)">
      <div class="tiny">
        <strong>âœ… Limiti Gratuiti:</strong><br>
        â€¢ 30 richieste al minuto<br>
        â€¢ 14.400 richieste al giorno<br>
        â€¢ PiÃ¹ che sufficienti per uso personale!
      </div>
    </div>
    
    <div class="card" style="background:rgba(239,68,68,0.05);border-left:3px solid var(--danger);margin-top:10px">
      <div class="tiny">
        <strong>âš ï¸ Raccomandazioni Sicurezza:</strong><br>
        ðŸ”’ Non condividere MAI la tua chiave<br>
        ðŸ“± La chiave Ã¨ salvata solo sul tuo dispositivo<br>
        ðŸ”„ Puoi rigenerarla quando vuoi dal sito Groq<br>
        ðŸ—‘ï¸ Puoi eliminarla dall'app in qualsiasi momento
      </div>
    </div>
    
    <button class="btn-ghost" onclick="closeGroqGuide()" style="width:100%;margin-top:15px">
      âœ… Ho Capito
    </button>
  </div>
</div>

<div id="aiRobot">

  <svg class="robot-body" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">

    <line x1="60" y1="15" x2="60" y2="25" stroke="#077fbf" stroke-width="2"/>

    <circle cx="60" cy="12" r="4" fill="#ff6b9d"/>

    <rect x="40" y="25" width="40" height="35" rx="8" fill="#077fbf"/>

    <rect x="42" y="27" width="36" height="31" rx="6" fill="#0596d5"/>

    <circle cx="50" cy="40" r="5" fill="#ffffff"/>

    <circle cx="70" cy="40" r="5" fill="#ffffff"/>

    <circle cx="51" cy="40" r="3" fill="#052e3b"/>

    <circle cx="71" cy="40" r="3" fill="#052e3b"/>

    <path d="M 48 50 Q 60 55 72 50" stroke="#052e3b" stroke-width="2" fill="none" stroke-linecap="round"/>

    <rect x="35" y="65" width="50" height="40" rx="10" fill="#077fbf"/>

    <rect x="37" y="67" width="46" height="36" rx="8" fill="#0596d5"/>

    <circle cx="60" cy="80" r="6" fill="#b3e5fc"/>

    <rect x="50" y="90" width="20" height="3" rx="1.5" fill="#b3e5fc"/>

    <rect x="52" y="95" width="16" height="3" rx="1.5" fill="#b3e5fc"/>

    <rect x="25" y="70" width="8" height="25" rx="4" fill="#077fbf"/>

    <rect x="87" y="70" width="8" height="25" rx="4" fill="#077fbf"/>

    <circle cx="29" cy="97" r="5" fill="#0596d5"/>

    <circle cx="91" cy="97" r="5" fill="#0596d5"/>

    <rect x="43" y="105" width="12" height="8" rx="4" fill="#077fbf"/>

    <rect x="65" y="105" width="12" height="8" rx="4" fill="#077fbf"/>

  </svg>

</div>

 <!-- âœ… HEADER: Frigo Smart a sinistra | Campanella + Avatar a destra -->
<header>
  <div style="display:flex;align-items:center;gap:10px">
    <div class="brand" style="margin-left:20px;flex-shrink:0;">â„ï¸ Freezy</div>

<img src="./img/me_ghiaccio.png" alt="Avatar" style="width:180px; height:auto;">
</div>

</header>

<!-- ðŸ”” CAMPANELLA + PROFILO (scorrono con la pagina) -->
<div id="topActionsDiv" style="position: absolute !important; top: 12px !important; right: 12px !important; display: flex !important; align-items: center !important; gap: 8px !important; z-index: 1 !important;">
  
 <!-- Campanella -->
<button id="bell-button" type="button" onclick="openNotificheSection()" style="width: 36px !important; height: 36px !important; border-radius: 50% !important; background: #ffffff !important; border: none !important; display: flex !important; align-items: center !important; justify-content: center !important; cursor: pointer !important; box-shadow: 0 2px 6px rgba(0,0,0,0.1) !important; padding: 0 !important; flex-shrink: 0 !important; transition: transform 0.2s ease !important; position: relative !important;" onmousedown="this.style.transform='scale(0.9)'" onmouseup="this.style.transform='scale(1)'" onmouseleave="this.style.transform='scale(1)'">
    <i class="fa-regular fa-bell" style="font-size: 16px !important; color: #374151 !important;"></i>
    <span id="notification-badge" style="display:none;position:absolute;top:-4px;right:-4px;background:#ef4444;color:white;font-size:10px;font-weight:700;min-width:18px;height:18px;border-radius:50%;align-items:center;justify-content:center;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.2);"></span>
</button>

<!-- Profilo (icona) -->
<button id="home-profile-btn" type="button" onclick="openProfiloSection()" style="width: 36px !important; height: 36px !important; border-radius: 50% !important; background: #ffffff !important; border: none !important; display: flex !important; align-items: center !important; justify-content: center !important; cursor: pointer !important; box-shadow: 0 2px 6px rgba(0,0,0,0.1) !important; padding: 0 !important; flex-shrink: 0 !important; transition: transform 0.2s ease !important; overflow: hidden !important;" onmousedown="this.style.transform='scale(0.9)'" onmouseup="this.style.transform='scale(1)'" onmouseleave="this.style.transform='scale(1)'">
  <img id="home-profile-img" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
  <i id="home-profile-icon" class="fa-solid fa-user" style="font-size: 16px !important; color: #374151 !important;"></i>
</button>
  
</div>

  
</div>
  
</div>

<nav>


  <button onclick="show('lista')">ðŸ“‹ Lista</button>

  <button onclick="show('fotocamera')">ðŸ“· Fotocamera</button>

  <button onclick="show('menu')">ðŸ½ï¸ MenÃ¹</button>

  <button onclick="show('spesa')">ðŸ›’ Spesa</button>

                                      
</nav>


<section id="home">
<h3 class="section-card-title">Nel tuo Frigo</h3>
  <div class="card-temp">
    <div class="card-temp-header">
      <!-- Sinistra: icona + temperatura -->
      <div class="card-temp-left">
        <div class="card-temp-icon">
          <i class="fa-solid fa-temperature-three-quarters"></i>
        </div>
        <div>
          <p class="card-temp-label">Temperatura</p>
          <p class="card-temp-value">4Â°C</p>
        </div>
      </div>

      <!-- Destra: stato -->
      <div class="card-temp-status">
        <p class="card-temp-status-label">Stato</p>
        <span class="card-temp-status-pill">
          <span class="card-temp-status-dot"></span>
          Ottimale
        </span>
      </div>
    </div>

    <!-- Barra progressione -->
    <div class="card-temp-progress">
      <div class="card-temp-progress-bar"></div>
    </div>
  </div>

<!-- === ðŸ“… PROSSIME SCADENZE (dinamico) === -->
<div class="alert-smart">
  <div class="alert-icon-box">
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
      <path d="M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480H40c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24V296c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/>
    </svg>
  </div>
  <div class="alert-content" style="flex:1">
    <h3 class="alert-title">Prossime scadenze</h3>
    
    <!-- Lista dinamica alimenti in scadenza -->
    <div id="expiring-foods-list" style="margin-top:10px">
      <!-- VerrÃ  popolato da JavaScript -->
    </div>
  </div>
</div>

<!-- Titolo Riepilogo -->
<h3 class="section-card-title">Riepilogo di Oggi</h3>

<!-- === ðŸŒ¿ CARD CALORIE === -->
<div class="card nutrition-card">
  <div class="nutrition-card-header">
    <!-- Sinistra: icona + testo -->
    <div class="nutrition-card-left">
      <div class="nutrition-icon">
        <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor">
          <path d="M224 112c-8.8 0-16-7.2-16-16V80c0-44.2 35.8-80 80-80h16c8.8 0 16 7.2 16 16V32c0 44.2-35.8 80-80 80H224zM0 288c0-76.3 35.7-160 112-160c27.3 0 59.7 10.3 82.7 19.3c18.8 7.3 39.9 7.3 58.7 0c22.9-8.9 55.4-19.3 82.7-19.3c76.3 0 112 83.7 112 160c0 128-80 224-160 224c-16.5 0-38.1-6.6-51.5-11.3c-8.1-2.8-16.9-2.8-25 0c-13.4 4.7-35 11.3-51.5 11.3C80 512 0 416 0 288z"/>
        </svg>
      </div>
      <div>
        <p class="nutrition-label">Calorie assunte oggi</p>
        <p class="nutrition-subtitle">1,450 / 2,000 kcal</p>
      </div>
    </div>
  </div>
  
  <!-- Barra progresso verde -->
  <div class="nutrition-progress">
    <div class="nutrition-progress-bar" style="width: 72.5%"></div>
  </div>
  
  <!-- Macronutrienti -->
  <div class="nutrition-macros">
    <div class="nutrition-macro-item">
      <p class="macro-label">Proteine</p>
      <p class="macro-value">45g</p>
    </div>
    <div class="nutrition-macro-item">
      <p class="macro-label">Carboidrati</p>
      <p class="macro-value">180g</p>
    </div>
    <div class="nutrition-macro-item">
      <p class="macro-label">Grassi</p>
      <p class="macro-value">52g</p>
    </div>
  </div>
</div>

<!-- ========== FUNZIONI INTELLIGENTI & UTILI ========== -->

  <div class="main-features-header">
    <h2>Funzioni Intelligenti &amp; Utili</h2>
  </div>

  <div class="smart-features-grid">
    <!-- Trova Ricette -->
    <div class="smart-feature-item frosted-card ice-shadow with-bg-image" onclick="openCercaRicette()">
      <div class="feature-icon-box gradient-recipes">
        <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg"
             viewBox="0 0 448 512" fill="currentColor">
          <path d="M416 0C400 0 288 32 288 176V288c0 35.3 28.7 64 64 64h32V480c0 17.7
                   14.3 32 32 32s32-14.3 32-32V352 240 32c0-17.7-14.3-32-32-32zM64 16C64
                   7.8 57.9 1 49.7 .1S34.2 4.6 32.4 12.5L2.1 148.8C.7 155.1 0 161.5 0
                   167.9c0 45.9 35.1 83.6 80 87.7V480c0 17.7 14.3 32 32 32s32-14.3
                   32-32V255.6c44.9-4.1 80-41.8 80-87.7c0-6.4-.7-12.8-2.1-19.1L191.6
                   12.5c-1.8-8-9.3-13.3-17.4-12.4S160 7.8 160 16V150.2c0 5.4-4.4 9.8-9.8
                   9.8c-5.1 0-9.3-3.9-9.8-9L127.9 14.6C127.2 6.3 120.3 0 112 0s-15.2
                   6.3-15.9 14.6L83.7 151c-.5 5.1-4.7 9-9.8 9c-5.4 0-9.8-4.4-9.8-9.8V16z"/>
        </svg>
      </div>
      <h3 class="feature-title">Trova Ricette</h3>
      <p class="feature-subtitle">Cerca le tue preferite</p>
    </div>

    <!-- Scan -->
    <div class="smart-feature-item frosted-card ice-shadow">
      <div class="feature-icon-box gradient-scan">
        <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg"
             viewBox="0 0 24 24" fill="none" stroke="currentColor"
             stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 7V5a2 2 0 0 1 2-2h2"/>
          <path d="M17 3h2a2 2 0 0 1 2 2v2"/>
          <path d="M21 17v2a2 2 0 0 1-2 2h-2"/>
          <path d="M7 21H5a2 2 0 0 1-2-2v-2"/>
          <path d="M8 10h8"/>
          <path d="M8 14h8"/>
        </svg>
      </div>
      <h3 class="feature-title">Scan</h3>
      <p class="feature-subtitle">Scansione barcode prodotti</p>
    </div>

    <!-- Chiedi a IA -->
<div class="smart-feature-item frosted-card ice-shadow" onclick="show('assistente'); resetFrostyChat();" style="cursor:pointer;">
  <div class="feature-icon-box gradient-ai">
    <img src="img/ai-icon.png" alt="AI" class="ai-logo-img">
  </div>
  <h3 class="feature-title">Chiedi a IA</h3>
  <p class="feature-subtitle">Assistente smart</p>
</div>

    <!-- Trofei -->
    <div class="smart-feature-item frosted-card ice-shadow">
      <div class="feature-icon-box gradient-trophies">
        <svg aria-hidden="true" focusable="false"
             xmlns="http://www.w3.org/2000/svg"
             viewBox="0 0 576 512" fill="currentColor">
          <path d="M400 0H176c-26.5 0-48.1 21.8-47.1 48.2c.2 5.3 .4 10.6 .7 15.8H24C10.7 64 0 74.7 0 88c0 92.6 33.5 157 78.5 200.7c44.3 43.1 98.3 64.8 138.1 75.8c23.4 6.5 39.4 26 39.4 45.6c0 20.9-17 37.9-37.9 37.9H192c-17.7 0-32 14.3-32 32s14.3 32 32 32H384c17.7 0 32-14.3 32-32s-14.3-32-32-32H357.9C337 448 320 431 320 410.1c0-19.6 15.9-39.2 39.4-45.6c39.9-11 93.9-32.7 138.2-75.8C542.5 245 576 180.6 576 88c0-13.3-10.7-24-24-24H446.4c.3-5.2 .5-10.4 .7-15.8C448.1 21.8 426.5 0 400 0zM48.9 112h84.4c9.1 90.1 29.2 150.3 51.9 190.6c-24.9-11-50.8-26.5-73.2-48.3c-32-31.1-58-76-63-142.3zM464.1 254.3c-22.4 21.8-48.3 37.3-73.2 48.3c22.7-40.3 42.8-100.5 51.9-190.6h84.4c-5.1 66.3-31.1 111.2-63 142.3z"/>
        </svg>
      </div>
      <h3 class="feature-title">Trofei</h3>
      <p class="feature-subtitle">Achievements</p>
    </div>
  </div>

<!-- ðŸ†• TITOLO SEZIONE -->
<h3 class="section-card-title">Riepilogo Risparmio energetico</h3>
<!-- ðŸ†• EFFICIENZA ENERGETICA -->
<div class="energy-smart-card">
  <div class="energy-card-header">
    <div class="energy-left">
      <div class="energy-icon-box">
        <i class="fa-solid fa-bolt"></i>
      </div>
      <div>
        <h3 class="energy-title">Efficienza Energetica</h3>
        <p class="energy-subtitle">Consumo ottimizzato</p>
      </div>
    </div>
    
    <span class="energy-badge-pill">
      <span class="energy-dot"></span>
      Ottima
    </span>
  </div>

  <div class="energy-content">
    <!-- Mini grafico barre -->
    <div class="energy-bars">
      <div class="energy-bar" style="height: 32px;"></div>
      <div class="energy-bar" style="height: 48px;"></div>
      <div class="energy-bar" style="height: 24px;"></div>
      <div class="energy-bar" style="height: 40px;"></div>
      <div class="energy-bar" style="height: 56px;"></div>
      <div class="energy-bar" style="height: 32px;"></div>
      <div class="energy-bar" style="height: 44px;"></div>
    </div>

    <!-- Classe energetica -->
    <div class="energy-grade">
      <p class="grade-value">A+</p>
      <p class="grade-label">Classe</p>
    </div>
  </div>
</div>



</section>

<main class="grid2">

  <div>

    <section id="lista">

      <h2>ðŸ“‹ Lista alimenti</h2>

      <div class="row">

        <input id="nome" class="col" placeholder="Nome (es: Latte)">

        <input id="peso" class="col" type="number" placeholder="Peso (g)">

        <input id="scadenza" class="col" type="date">

        <select id="categoria" class="col">

          <option>Generale</option><option>Frutta</option><option>Verdura</option><option>Carne</option><option>Latticini</option><option>Bevande</option>

        </select>

      </div>

      <div style="display:flex;gap:8px;margin-top:6px">

        <button class="btn-primary" onclick="addItem()">âž• Aggiungi</button>

        <button class="btn-ghost" onclick="importDemo()">ðŸ“¥ Import demo</button>

      </div>

      <div style="margin-top:12px">

        <div class="row">

          <input id="cerca" placeholder="ðŸ” Cerca..." oninput="refreshList()" style="flex:1">

          <select id="filtro" onchange="refreshList()">

            <option value="tutti">Tutti</option><option value="scadenza">Scadenzaâ‰¤3gg</option><option value="scaduti">Scaduti</option>

          </select>

          <select id="ordina" onchange="refreshList()">

            <option value="nome">Nome</option><option value="scadenza">Scadenza</option><option value="peso">Peso</option>

          </select>

        </div>

        <ul id="listaAlimenti" style="margin-top:10px"></ul>

        <div class="tiny" id="contatore"></div>

      </div>

    </section>

 </section>

    <section id="stat">

      <h2>ðŸ“Š Statistiche Avanzate</h2>

      <div class="card" style="margin-bottom:12px">

        <h3>ðŸ“ˆ Riepilogo Frigo</h3>

        <div id="statistiche" style="margin-top:8px"></div>

      </div>

      <div class="card" style="margin-bottom:12px">

        <h3>ðŸ“Š Statistiche Dettagliate</h3>

        <div id="statisticheDettagliate" style="margin-top:8px"></div>

      </div>

      <div class="card">

        <h3>âš ï¸ Avvisi Scadenze</h3>

        <div id="alertScadenza" style="margin-top:8px"></div>

      </div>

    </section>

    <!-- RICETTE FULLSCREEN WRAPPER -->
<div class="ricette-fullscreen-wrapper" id="ricetteFullscreen">
  <!-- Effetto rilegatura libro -->
  <div class="ricette-book-spine"></div>
  
  <!-- Header - Solo titolo -->
  <div class="ricette-book-header">
    <div class="ricette-book-header-row">
      <button class="ricette-book-back-btn" onclick="closeRicetteFullscreen()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>
        </svg>
      </button>
      
      <div class="ricette-book-title-wrap">
        
        <h1 class="ricette-book-title">Le Mie Ricette</h1>
      </div>
      
      <div style="width:40px;"></div>
    </div>
  </div>
  
  <!-- Barra ricerca - Stile Cerca Ricette Online -->
  <div class="ricette-mie-search-box" id="ricetteBookSearchContainer">
    <div class="ricette-mie-search-row">
      <div class="ricette-mie-search-icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
        </svg>
      </div>
      <input 
        type="text" 
        class="ricette-mie-search-input"
        id="searchRicette"
        placeholder="Cerca tra le tue ricette..."
        oninput="filtraRicette()"
      >
    </div>
  </div>
  
  <!-- Tabs -->
  <div class="ricette-book-tabs">
    <button class="ricette-book-tab active" onclick="switchRicetteTab('salvate')" id="tabRicetteSalvate">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/>
      </svg>
      <span>Salvate</span>
    </button>
    <button class="ricette-book-tab" onclick="switchRicetteTab('preferite')" id="tabRicettePreferite">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
      </svg>
      <span>Preferite</span>
    </button>
    <button class="ricette-book-tab" onclick="switchRicetteTab('aggiungi')" id="tabRicetteAggiungi">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M5 12h14"/><path d="M12 5v14"/>
      </svg>
      <span>Nuova</span>
    </button>
  </div>
  
  <!-- Container dinamico -->
  <div class="ricette-book-list-container" id="ricetteBookViewContainer">
    <div id="listaRicette" class="ricette-book-list"></div>
  </div>
  
  <!-- Form nuova ricetta (nascosto inizialmente) -->
  <div id="aggiungiRicetta" style="display:none;">
    <div class="ricette-book-form-container">
      <div class="ricette-book-form">
        <div class="ricette-book-form-row">
          <div>
            <label class="ricette-book-form-label">Nome ricetta</label>
            <input type="text" id="rNome" class="ricette-book-form-input" placeholder="Es. Pasta al pesto">
          </div>
          <div>
            <label class="ricette-book-form-label">Tipo</label>
            <button type="button" id="rVegBtn" class="ricette-book-veg-btn nonveg" onclick="toggleVegBook()">
              ðŸ– Non-Veg
            </button>
            <input type="hidden" id="rVeg" value="false">
          </div>
        </div>
        
        <div class="ricette-book-form-row-full">
          <label class="ricette-book-form-label">Ingredienti</label>
          <textarea id="rIngredienti" class="ricette-book-form-textarea" placeholder="Lista ingredienti separati da virgola..."></textarea>
        </div>
        
        <div class="ricette-book-form-row-half">
          <div>
            <label class="ricette-book-form-label">Calorie (Kcal)</label>
            <input type="number" id="rKcal" class="ricette-book-form-input" placeholder="0">
          </div>
          <div>
            <label class="ricette-book-form-label">Proteine (g)</label>
            <input type="number" id="rProt" class="ricette-book-form-input" placeholder="0">
          </div>
        </div>
        
        <div class="ricette-book-form-row-half">
          <div>
            <label class="ricette-book-form-label">Grassi (g)</label>
            <input type="number" id="rFat" class="ricette-book-form-input" placeholder="0">
          </div>
          <div>
            <label class="ricette-book-form-label">Carboidrati (g)</label>
            <input type="number" id="rCarb" class="ricette-book-form-input" placeholder="0">
          </div>
        </div>
        
        <div class="ricette-book-form-actions">
          <button type="button" class="ricette-book-form-submit" onclick="saveRecipe()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
              <polyline points="17 21 17 13 7 13 7 21"/>
              <polyline points="7 3 7 8 15 8"/>
            </svg>
            Salva Ricetta
          </button>
          <button type="button" class="ricette-book-form-reset" onclick="clearRecipeForm()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/>
              <path d="M22 21H7"/><path d="m5 11 9 9"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

 

    <section id="assistente" style="position:fixed;top:0;left:0;width:100%;height:100vh;z-index:9000;display:none;flex-direction:column;background:linear-gradient(180deg, #0f172a 0%, #1e293b 100%);overflow:hidden;padding:0;margin:0;font-family:system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;">
  
  <!-- Header -->
  <header style="display:flex !important;visibility:visible !important;opacity:1 !important;position:relative !important;background:#0f172a !important;padding:16px !important;min-height:60px !important;z-index:99999 !important;justify-content:space-between !important;align-items:center !important;border-bottom:1px solid rgba(255,255,255,0.1);">
    
    <!-- Bottone Indietro -->
    <button onclick="show('home')" style="padding:8px;border-radius:50%;background:rgba(255,255,255,0.1);color:#cbd5e1;border:none;cursor:pointer;transition:all 0.3s;width:36px;height:36px;display:flex;align-items:center;justify-content:center;position:relative;z-index:999999;pointer-events:auto;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="19" y1="12" x2="5" y2="12"></line>
        <polyline points="12 19 5 12 12 5"></polyline>
      </svg>
    </button>
    
    <!-- Logo Centrale -->
    <div style="display:flex;align-items:center;gap:12px;">
      <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg, #22d3ee 0%, #a855f7 100%);display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:18px;">
        F
      </div>
      <div>
        <h1 style="font-weight:700;font-size:18px;margin:0;letter-spacing:0.5px;background:linear-gradient(90deg, #67e8f9 0%, #c084fc 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;color:transparent;">
          Frosty AI
        </h1>
        <p style="font-size:10px;color:#94a3b8;text-transform:uppercase;letter-spacing:1.5px;margin:0;">Smart Fridge Assistant</p>
      </div>
    </div>
    
    <!-- Bottone Volume -->
   <button id="frosty-tts-btn-header" style="padding:8px;border-radius:50%;background:#1e293b;color:#64748b;border:none;cursor:pointer;transition:color 0.6s ease, background 0.6s ease;width:36px;height:36px;display:flex;align-items:center;justify-content:center;position:relative;z-index:999999;pointer-events:auto;">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
    <line x1="23" y1="9" x2="17" y2="15"></line>
    <line x1="17" y1="9" x2="23" y2="15"></line>
  </svg>
</button>
  </header>

<!-- Main Chat Area -->
<main style="flex:1;overflow:hidden;position:relative;display:flex;flex-direction:column;justify-content:center;align-items:center;background:transparent;border:none;padding:0;margin:0;width:100%;">


    
    <!-- Background Effects -->
    <div style="position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden;pointer-events:none;z-index:0;">
      <div style="position:absolute;top:25%;left:25%;width:256px;height:256px;background:rgba(147,51,234,0.1);border-radius:50%;filter:blur(60px);"></div>
      <div style="position:absolute;bottom:25%;right:25%;width:320px;height:320px;background:rgba(6,182,212,0.1);border-radius:50%;filter:blur(60px);"></div>
    </div>

    <!-- Messages Container -->
    <div id="frosty-messages" style="flex:1;width:100%;overflow-y:auto;padding:16px;z-index:10;scroll-behavior:smooth;display:flex;flex-direction:column;justify-content:center;align-items:center;box-sizing:border-box;">
      
      <!-- Welcome Screen -->
      <div id="frosty-welcome" style="display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;width:100%;margin:0 auto;padding:20px;box-sizing:border-box;">
        
        <!-- ORB 80px -->
<div class="orb-container" style="position: relative; margin-bottom: 28px;">
  <!-- Luce che si muove -->
  <!-- Da 3s a 4s per rallentare leggermente -->
<div id="frosty-orb-glow" class="orb-glow" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 160px; height: 160px; background: radial-gradient(circle, rgba(6, 182, 212, 0.8) 0%, rgba(6, 182, 212, 0.3) 50%, transparent 70%); border-radius: 50%; filter: blur(40px); animation: orbPulse 4s ease-in-out infinite;"></div>


  <div id="frosty-orb-core" class="orb" style="position: relative; width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #06b6d4 0%, #0284c7 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(6, 182, 212, 0.35), 0 0 40px rgba(6, 182, 212, 0.2), inset 0 -12px 25px rgba(0, 0, 0, 0.4), inset 0 8px 25px rgba(255, 255, 255, 0.3); animation: float 4s ease-in-out infinite;">
    
    <!-- Occhi che si chiudono -->
    <div style="display: flex; gap: 12px;">
      <div class="orb-eye" style="width: 8px; height: 20px; background: rgba(255, 255, 255, 0.95); border-radius: 4px; animation: blink-eyes 5s ease-in-out infinite;"></div>
      <div class="orb-eye" style="width: 8px; height: 20px; background: rgba(255, 255, 255, 0.95); border-radius: 4px; animation: blink-eyes 5s ease-in-out infinite;"></div>
    </div>
  </div>
</div>

        <p id="frosty-orb-status" style="font-size:11px;font-weight:600;color:#64748b;letter-spacing:2.5px;text-transform:uppercase;margin:0 0 20px 0;">FROSTY AI</p>

        <p style="color:#cbd5e1;font-size:15px;max-width:300px;line-height:1.5;margin:0;">
          Ciao! Sono Frosty.<br>
          Posso aiutarti con il frigo, le diete e nuove ricette.
        </p>

        <p style="font-size:11px;color:#475569;margin-top:12px;opacity:0.6;">
          Scrivi qualcosa per iniziare!
        </p>
      </div>

      <!-- Chat Messages Here -->
      <div id="frosty-chat-list" style="display:none;flex-direction:column;gap:12px;width:100%;"></div>
    </div>
  </main>

<!-- Input Footer -->
<footer style="padding: 10px 20px; background: 0; backdrop-filter: blur(20px); z-index: 20;">
  <div style="display: flex; align-items: center; gap: 6px; background: #0f172a; padding: 6px; border-radius: 100px; border: 1px solid rgba(15, 23, 42, 0.9); box-shadow: none; transition: all 0.3s;">

    <!-- Fotocamera -->
    <button id="frosty-camera-btn" onclick="openFrostyCamera()" style="padding: 10px;  margin-right: 6px; border-radius: 50%; background: transparent; color: #22d3ee; border: none; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center;" title="Fotocamera">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
        <circle cx="12" cy="13" r="4"></circle>
      </svg>
    </button>

    <!-- Input -->
    <input 
      id="frosty-input" 
      type="text" 
      placeholder="Scrivi o parla..." 
      autocomplete="off"
      style="flex:1;background:transparent;border:none;outline:none;color:white;font-size:15px;padding:11px 7px;"
    />

    <!-- Menu 3 puntini -->
<div style="position:relative;display:flex;align-items:center;">
  <button id="frosty-menu-btn" onclick="toggleFrostyMenu()" style="padding: 10px; margin-left: 5px; border-radius: 50%; background: transparent; color: #64748b; border: none; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center;" title="Menu">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
      <circle cx="12" cy="5" r="2"></circle>
      <circle cx="12" cy="12" r="2"></circle>
      <circle cx="12" cy="19" r="2"></circle>
    </svg>
  </button>
  
  <!-- Menu popup -->
<div id="frosty-menu-popup" style="display:none;position:absolute;bottom:50px;left:50%;transform:translateX(-50%);background:#1e293b;border-radius:12px;padding:8px;min-width:180px;box-shadow:0 10px 40px rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.1);z-index:100;">
  <button onclick="addFrostyFile()" style="width:100%;padding:10px 12px;background:transparent;border:none;color:#cbd5e1;font-size:13px;text-align:left;cursor:pointer;border-radius:8px;display:flex;align-items:center;gap:10px;transition:background 0.2s;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
      <polyline points="14 2 14 8 20 8"></polyline>
    </svg>
    Aggiungi file
  </button>
  <button onclick="addFrostyImage()" style="width:100%;padding:10px 12px;background:transparent;border:none;color:#cbd5e1;font-size:13px;text-align:left;cursor:pointer;border-radius:8px;display:flex;align-items:center;gap:10px;transition:background 0.2s;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
      <circle cx="8.5" cy="8.5" r="1.5"></circle>
      <polyline points="21 15 16 10 5 21"></polyline>
    </svg>
    Aggiungi immagine
  </button>
  <div style="height:1px;background:rgba(255,255,255,0.1);margin:6px 0;"></div>
  <button onclick="openVoiceSelector()" style="width:100%;padding:10px 12px;background:transparent;border:none;color:#cbd5e1;font-size:13px;text-align:left;cursor:pointer;border-radius:8px;display:flex;align-items:center;gap:10px;transition:background 0.2s;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
      <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
    </svg>
    Cambia voce
  </button>
</div>


    
    <!-- Microfono -->
    <button id="frosty-mic-btn" onclick="startFrostyListening()" style="padding: 10px; margin-left: 5px; margin-right: 5px; border-radius: 50%; background: transparent; color: #94a3b8; border: none; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center;" title="Parla">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
        <line x1="12" y1="19" x2="12" y2="23"></line>
        <line x1="8" y1="23" x2="16" y2="23"></line>
      </svg>
    </button>
    
    <!-- Invia -->
    <button id="frosty-send-btn" onclick="sendFrostyMessage()" disabled style="padding: 12px; border-radius: 50%; background: rgba(100, 116, 139, 0.3); color: rgba(255, 255, 255, 0.3); border: none; cursor: not-allowed; box-shadow: none; transition: all 0.3s; display: flex; align-items: center; justify-content: center;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    </button>
  </div>
</footer>
  
<!-- Voice Selector Modal -->
<div id="frosty-voice-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;justify-content:center;align-items:center;">
  <div style="background:#1e293b;border-radius:16px;padding:20px;max-width:300px;width:90%;max-height:70vh;overflow-y:auto;border:1px solid rgba(255,255,255,0.1);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h3 style="color:white;margin:0;font-size:16px;">Scegli voce</h3>
      <button onclick="closeVoiceSelector()" style="background:transparent;border:none;color:#94a3b8;cursor:pointer;font-size:20px;">âœ•</button>
    </div>
    <div id="frosty-voice-list" style="display:flex;flex-direction:column;gap:8px;">
      <!-- Voci qui -->
    </div>
  </div>
</div>

  <!-- BOTTONE TTS NASCOSTO (per compatibilitÃ  JS) -->
  <button id="frosty-tts-btn" style="display:none;"></button>

  <!-- CAMERA MODAL -->
  <div id="frosty-camera-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:9999;flex-direction:column;align-items:center;justify-content:center;padding:16px;">
    <div style="position:relative;width:100%;max-width:500px;background:#1e293b;border-radius:24px;overflow:hidden;border:1px solid #475569;box-shadow:0 0 40px rgba(0,0,0,0.8);display:flex;flex-direction:column;height:80vh;">
      
      <div style="padding:16px;background:linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);display:flex;justify-content:space-between;align-items:center;z-index:10;">
        <span style="color:white;font-weight:500;">Scatta quando vuoi!</span>
        <button id="frosty-close-camera" style="padding:8px;background:rgba(255,255,255,0.2);border:none;border-radius:50%;cursor:pointer;color:white;transition:all 0.3s;">
          <i class="fa-solid fa-xmark" style="font-size:18px;"></i>
        </button>
      </div>

      <div style="flex:1;background:black;overflow:hidden;position:relative;">
        <video id="frosty-video" autoplay playsinline muted style="width:100%;height:100%;object-fit:cover;"></video>
        <canvas id="frosty-canvas" style="display:none;"></canvas>
      </div>

      <div style="background:#1e293b;padding:20px;display:flex;justify-content:space-around;align-items:center;border-top:1px solid #475569;">
        <button id="frosty-switch-camera" style="padding:10px;color:#94a3b8;background:transparent;border:none;cursor:pointer;transition:all 0.3s;">
          <i class="fa-solid fa-repeat" style="font-size:20px;"></i>
        </button>
        <button id="frosty-capture-btn" style="width:64px;height:64px;border:4px solid white;border-radius:50%;background:transparent;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;">
          <div style="width:48px;height:48px;background:white;border-radius:50%;"></div>
        </button>
        <div style="width:40px;"></div>
      </div>
    </div>
  </div>

</section>

 
    <section id="fotocamera">
  <h2>ðŸ“· Fotocamera â€” Scansiona il frigo</h2>
  <input type="file" accept="image/*" capture="environment" id="fotoInput">
  
  <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
    <button class="btn-primary" onclick="scanPhoto()">ðŸ” Scansiona Base</button>
    <button class="btn-primary" onclick="analyzePhotoWithGroq()" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%)">
      ðŸ§  Analisi AI Intelligente
    </button>
    <button class="btn-ghost" onclick="scanAndAdd()">âž• Aggiungi al Frigo</button>
  </div>
  
  <img id="fotoPreview" style="width:100%;max-width:380px;border-radius:12px;margin-top:8px;box-shadow:0 8px 20px rgba(7,127,191,0.2);display:none" />
  
  <div id="predictions" style="margin-top:8px"></div>
  
  <!-- RISULTATI AI INTELLIGENTE -->
  <div id="aiAnalysis" style="margin-top:12px;display:none" class="card" style="background:linear-gradient(135deg, rgba(102,126,234,0.05), rgba(118,75,162,0.05))">
    <h3>ðŸ§  Analisi AI Avanzata</h3>
    <div id="aiAnalysisContent"></div>
  </div>
</section>

      <img id="fotoPreview" style="width:100%;max-width:380px;border-radius:12px;margin-top:8px;box-shadow:0 8px 20px rgba(7,127,191,0.2);display:none" />

      <div id="predictions" style="margin-top:8px"></div>

    </section>

 

    <section id="menu">
      <h2>ðŸ½ï¸ MenÃ¹ Settimanale Completo</h2>
      
      <!-- BOTTONE SPOSTATO IN ALTO -->
      <div style="margin-bottom:16px">
        <button class="btn-primary" onclick="generateMenu()">ðŸ”„ Genera menÃ¹</button>
      </div>
      
      <div class="tiny" style="margin-bottom:12px" id="menuInfo">
        â„¹ï¸ Calcola il fabbisogno per un menÃ¹ personalizzato
      </div>
      
      <div id="menuSettimana"></div>
    </section>

 

    <section id="spesa">

      <h2>ðŸ›’ Lista della spesa</h2>

      <div style="display:flex;gap:8px;margin-bottom:12px">

        <button class="btn-primary" onclick="generateGrocery()">âœ¨ Genera</button>

        <button class="btn-ghost" onclick="copyGrocery()">ðŸ“‹ Copia</button>

        <button class="btn-ghost" onclick="clearGrocery()">ðŸ—‘ï¸ Pulisci</button>

      </div>

  <!-- BARCODE SCANNER -->
<div class="card" style="margin-bottom:12px;background:linear-gradient(135deg, rgba(139,92,246,0.05), rgba(168,85,247,0.05))">
  <h3>ðŸ·ï¸ Scansiona Codice a Barre</h3>
  <div class="tiny" style="margin-bottom:8px">
    Scansiona il barcode per aggiungere prodotti automaticamente
  </div>
  
  <div style="display:flex;gap:8px;margin-bottom:8px">
    <input id="barcodeInput" type="text" placeholder="Inserisci codice manualmente" style="flex:1">
    <button class="btn-primary" onclick="searchBarcode()">ðŸ”</button>
  </div>
  
  <div style="display:flex;gap:8px">
    <!-- ðŸ†• SCANNER LIVE -->
    <button class="btn-primary" onclick="openBarcodeScanner()" style="flex:1;background:linear-gradient(135deg, #8b5cf6, #a855f7)">
      ðŸ“¸ Scanner Live
    </button>
    
    <!-- Scanner da foto (opzionale) -->
    <input type="file" accept="image/*" capture="environment" id="barcodeCamera" style="display:none" onchange="scanBarcodeFromImage()">
    <button class="btn-ghost" onclick="document.getElementById('barcodeCamera').click()" style="flex:1">
      ðŸ–¼ï¸ Da Foto
    </button>
    
    <button class="btn-ghost" onclick="showBarcodeHelp()">â“</button>
  </div>
  
  <div id="barcodeResult" style="margin-top:8px"></div>
</div>

<!-- ðŸ†• MODAL SCANNER LIVE -->
<div id="scannerModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:1000;display:none">
  <div style="position:relative;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px">
 
    <!-- Chiudi (SPOSTATO IN ALTO) -->
<button type="button" onclick="closeBarcodeScanner()" 
  style="position:absolute;top:20px;right:20px;background:rgba(239,68,68,0.95);color:white;border:3px solid white;border-radius:50%;width:56px;height:56px;font-size:26px;font-weight:700;cursor:pointer;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center">
  âœ•
</button>

    
    <!-- Titolo -->
    <div style="color:white;font-size:20px;font-weight:700;margin-bottom:20px;text-align:center">
      ðŸ“¸ Inquadra il Codice a Barre
    </div>
    
    <!-- Video Preview -->
    <div style="position:relative;max-width:500px;width:100%;aspect-ratio:4/3;background:#000;border-radius:12px;overflow:hidden;box-shadow:0 10px 40px rgba(79,195,247,0.5)">
      <div id="scannerReader" style="width:100%;height:100%;position:relative;z-index:1"></div>

      
      <!-- Overlay mira -->
      <div style="position:absolute;inset:0;pointer-events:none">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:80%;height:40%;border:3px solid #4fc3f7;border-radius:12px;box-shadow:0 0 0 9999px rgba(0,0,0,0.5)">
          <!-- Angoli -->
          <div style="position:absolute;top:-3px;left:-3px;width:30px;height:30px;border-top:5px solid #4fc3f7;border-left:5px solid #4fc3f7"></div>
          <div style="position:absolute;top:-3px;right:-3px;width:30px;height:30px;border-top:5px solid #4fc3f7;border-right:5px solid #4fc3f7"></div>
          <div style="position:absolute;bottom:-3px;left:-3px;width:30px;height:30px;border-bottom:5px solid #4fc3f7;border-left:5px solid #4fc3f7"></div>
          <div style="position:absolute;bottom:-3px;right:-3px;width:30px;height:30px;border-bottom:5px solid #4fc3f7;border-right:5px solid #4fc3f7"></div>
        </div>
      </div>
    </div>
    
    <!-- Istruzioni -->
    <div style="color:rgba(255,255,255,0.8);margin-top:20px;text-align:center;max-width:400px">
      ðŸ’¡ <strong>Suggerimenti:</strong><br>
      â€¢ Tieni il telefono stabile<br>
      â€¢ Assicurati che ci sia buona luce<br>
      â€¢ Il codice verrÃ  rilevato automaticamente
    </div>
    
    <!-- Status -->
    <div id="scannerStatus" style="color:#4fc3f7;margin-top:12px;font-weight:600;text-align:center"></div>
  </div>
</div>

      <div style="display:flex;gap:8px;margin-bottom:8px">

        <input id="nuovoItemSpesa" placeholder="âž• Aggiungi elemento..." style="flex:1">

        <button class="btn-primary" onclick="addGroceryItem()">+</button>

      </div>

      <!-- ðŸ” BARRA RICERCA SPESA -->
      <div style="margin-bottom:12px">
        <input 
          id="cercaSpesa" 
          placeholder="ðŸ” Cerca nella spesa..." 
          oninput="filtraSpesa()" 
          style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--input-bg);color:var(--text)"
        >
        <div class="tiny" id="contatoreSpesa" style="margin-top:6px;color:var(--muted)"></div>
      </div>

      <div id="listaSpesa"></div>

    </section>



<section id="fabbisogno">

<!-- ========== CARD RIEPILOGO - DONUT (INVARIATA) ========== -->
<div class="fabbisogno-card" id="riepilogoCard">
  <div class="fabbisogno-blur-1"></div>
  <div class="fabbisogno-blur-2"></div>
  
  <div class="fabbisogno-header">
    <h2 class="fabbisogno-title">
  <span class="title-line-1">PROGRESSO</span>
  <span class="title-line-2">
    DI OGGI
    <img src="img/albero2.png" alt="" class="title-tree-icon">
  </span>
</h2>
  <button class="fabbisogno-btn-calc" onclick="scrollToCalcSection()">
      CALCOLA
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </button>
  </div>
  
  <div class="donut-container">
    <svg class="donut-chart" viewBox="0 0 100 100">
      <circle class="donut-ring" cx="50" cy="50" r="40"></circle>
      <circle class="donut-segment" id="donutSegment" cx="50" cy="50" r="40" 
              stroke-dasharray="0 251.2" stroke-dashoffset="0"></circle>
    </svg>
    <div class="donut-center">
      <div class="donut-value-row">
        <span class="donut-value" id="kcalConsumate">0</span>
        <span class="donut-separator">/</span>
        <span class="donut-total" id="kcalTotaleDonut">0</span>
      </div>
      <div class="donut-label">Kcal Assunte</div>
    </div>
  </div>
  
  <div class="dettagli-btn-container">
    <button class="dettagli-btn" onclick="openAnalisiSalute()">
      <span>DETTAGLI</span>
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    </button>
  </div>
  
  <div class="macros-row-new">
    <div class="macro-item-new">
      <div class="macro-label-new">Proteine</div>
      <div class="macro-values-row">
        <span class="macro-current" id="protRiepilogo">0</span>
        <span class="macro-separator">/ <span id="protTotRiepilogo">0</span>g</span>
      </div>
      <div class="macro-progress-bar">
        <div class="macro-progress-fill" id="protBarRiepilogo" style="width:0%"></div>
      </div>
    </div>
    
    <div class="macro-item-new">
      <div class="macro-label-new">Carbo</div>
      <div class="macro-values-row">
        <span class="macro-current" id="carbRiepilogo">0</span>
        <span class="macro-separator">/ <span id="carbTotRiepilogo">0</span>g</span>
      </div>
      <div class="macro-progress-bar">
        <div class="macro-progress-fill" id="carbBarRiepilogo" style="width:0%"></div>
      </div>
    </div>
    
    <div class="macro-item-new">
      <div class="macro-label-new">Grassi</div>
      <div class="macro-values-row">
        <span class="macro-current" id="fatRiepilogo">0</span>
        <span class="macro-separator">/ <span id="fatTotRiepilogo">0</span>g</span>
      </div>
      <div class="macro-progress-bar">
        <div class="macro-progress-fill" id="fatBarRiepilogo" style="width:0%"></div>
      </div>
    </div>
  </div>
</div>

<!-- ========== ðŸ†• AGGIUNGI PASTO (sotto donut, senza card) ========== -->
<div class="quick-add-section">
  
  <!-- Selezione corrente -->
  <div class="quick-selection-display" id="quickSelectionDisplay" style="display:none;">
    <div class="quick-selection-info">
      <span class="quick-selection-name" id="quickSelectionName">Pasta al pomodoro</span>
      <span class="quick-selection-qty" id="quickSelectionQty">1 porzione</span>
    </div>
    <button class="quick-selection-edit" onclick="editQtySelection()">âœï¸ Modifica</button>
    <button class="quick-selection-remove" onclick="removeQtySelection()">âœ•</button>
  </div>
  
  <!-- Filtri (appaiono al click sulla barra) -->
  <div class="quick-search-filters" id="quickSearchFilters">
    <select class="quick-filter-dropdown" id="quickFilterCategory" onchange="applyQuickSearchFilters()">
      <option value="">ðŸ½ï¸ Tutti</option>
      <option value="veg">ðŸŒ± Vegano</option>
      <option value="dolce">ðŸ° Dolce</option>
      <option value="salato">ðŸ¥˜ Salato</option>
      <option value="bevanda">ðŸ¥¤ Bevanda</option>
      <option value="colazione">ðŸŒ… Colazione</option>
      <option value="snack">ðŸ¿ Snack</option>
      <option value="carne">ðŸ¥© Carne</option>
      <option value="pesce">ðŸŸ Pesce</option>
      <option value="pasta">ðŸ Pasta</option>
    </select>
    <button class="quick-filter-mini-btn" id="quickFilterFavBtn" onclick="toggleQuickFilterFav()">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
      Preferite
    </button>
    <button class="quick-filter-mini-btn" id="quickFilterSavedBtn" onclick="toggleQuickFilterSaved()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
      Salvate
    </button>
    <button class="quick-filter-reset-btn" onclick="resetQuickSearchFilters()">âœ• Reset</button>
  </div>

  <div class="quick-add-search-container" id="recipeSearchContainer">
    <svg class="quick-add-search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"></circle>
      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
    </svg>
    <input 
      type="text" 
      id="quickSearchRecipe" 
      class="quick-add-search-input" 
      placeholder="Cerca pasto salvato..."
      autocomplete="off"
      onfocus="openRecipeDropdown()"
      oninput="filterRecipeDropdown()"
    >
    <div class="quick-dropdown" id="recipeDropdownList"></div>
  </div>
  
 <button class="quick-add-btn" onclick="quickAddMeal()">
    <span>Aggiungi Pasto</span>
    <div class="quick-add-btn-icon">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    </div>
  </button>
  
 <!-- BOTTONI RICETTE -->
  <div class="recipe-buttons-row">
    <button class="recipe-twin-btn with-bg-image-mie" onclick="openRicetteFullscreen()">
      <div class="recipe-twin-btn-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 6.25278V19.2528M12 6.25278C10.8321 5.47686 9.24649 5 7.5 5C5.75351 5 4.16789 5.47686 3 6.25278V19.2528C4.16789 18.4769 5.75351 18 7.5 18C9.24649 18 10.8321 18.4769 12 19.2528M12 6.25278C13.1679 5.47686 14.7535 5 16.5 5C18.2465 5 19.8321 5.47686 21 6.25278V19.2528C19.8321 18.4769 18.2465 18 16.5 18C14.7535 18 13.1679 18.4769 12 19.2528"></path>
        </svg>
      </div>
      <span>Le Mie Ricette</span>
    </button>
    <button class="recipe-twin-btn with-bg-image" onclick="openCercaRicette()">
      <div class="recipe-twin-btn-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </div>
      <span>Cerca Online</span>
    </button>
  </div>
</div>

<!-- ========== ðŸ†• MANGIA FUORI (tutto dentro il container) ========== -->
<div class="restaurant-section-new">
  <div class="restaurant-header-new">
    <div class="restaurant-title-row">
      <span class="restaurant-title-new">Mangia Fuori</span>
      <button class="restaurant-info-btn-pro" onclick="toggleRestaurantInfo(event)">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
        </svg>
      </button>
      <div class="restaurant-info-tooltip-pro" id="restaurantInfoTooltip">
        <div class="info-tooltip-arrow-pro"></div>
        <div class="info-tooltip-content-pro">
          <div class="info-tooltip-title-pro">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            Pasti fuori casa
          </div>
          <div class="info-tooltip-text-pro">
            I ristoranti usano piÃ¹ condimenti, olio e porzioni abbondanti rispetto alla cucina casalinga. Questa sezione ti permette di tracciare rapidamente con stime realistiche.
          </div>
        </div>
      </div>
    </div>
    <p class="restaurant-subtitle-pro">Traccia velocemente i pasti fuori casa</p>
  </div>

  <div class="quick-add-search-container" id="restaurantSearchContainer">
    <svg class="quick-add-search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"></circle>
      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
    </svg>
    <input 
      type="text" 
      id="quickSearchRestaurant" 
      class="quick-add-search-input" 
      placeholder="Cerca pasto ristorante..."
      autocomplete="off"
      onfocus="openRestaurantDropdown()"
      oninput="filterRestaurantDropdown()"
    >
    <div class="quick-dropdown" id="restaurantDropdownList"></div>
  </div>
  
  <div class="restaurant-buttons-new">
    <button class="restaurant-add-btn-pro" onclick="quickAddRestaurant()">
      <span>Aggiungi Pasto</span>
      <div class="restaurant-add-btn-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      </div>
    </button>
    <button class="restaurant-edit-btn-pro" onclick="toggleQuickCustomMeal()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
      </svg>
    </button>
  </div>
  
  <div class="quick-custom-meal" id="quickCustomMeal">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
      </svg>
      <span style="font-size:14px;font-weight:600;color:#475569;">Pasto Personalizzato</span>
    </div>
    <input type="text" id="quickCustomName" class="quick-custom-input" placeholder="Nome pasto (es. Kebab)">
    <input type="number" id="quickCustomKcal" class="quick-custom-input" placeholder="Calorie stimate (es. 900)">
    <button class="quick-custom-confirm" onclick="quickAddCustomMeal()">âœ… Conferma</button>
  </div>
</div> <!-- Fine restaurant-section-new -->


<!-- ========== TRACCIA PASTI (ORIGINALE - con elementi nascosti per compatibilitÃ ) ========== -->
<div class="card tracking-card" style="margin-top:16px">
  <div class="tracking-header">
    <h3 style="margin:0;display:flex;align-items:center;gap:8px;">
      <span>ðŸ“</span> Pasti di Oggi
    </h3>
    <div class="tracking-date">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      <span id="currentDate"></span>
    </div>
  </div>
  
  <!-- Elementi nascosti per compatibilitÃ  con funzioni esistenti -->
  <div style="display:none;">
    <input type="text" id="searchPastoRicetta">
    <select id="pastoRicetta">
      <option value="">Seleziona ricetta...</option>
    </select>
    <input id="porzioni" type="number" value="1" min="0.5" step="0.5">
  </div>
  
  <div id="pastiOggi" class="pasti-lista"></div>
  
  <!-- Progresso Giornaliero nascosto -->
  <div style="display:none">
    <div id="kcalCard"><div id="kcalProgress">0</div><span id="kcalTarget">0</span></div>
    <div id="protCard"><span id="protProgress">0</span><span id="protTarget">0</span></div>
    <div id="carbCard"><span id="carbProgress">0</span><span id="carbTarget">0</span></div>
    <div id="fatCard"><span id="fatProgress">0</span><span id="fatTarget">0</span></div>
    <div id="kcalBar"></div><div id="protBar"></div><div id="carbBar"></div>
  </div>
  
  <div id="suggestions" class="suggestions-box"></div>
</div>

<!-- SMARTWATCH SYNC CARD -->
<div class="smartwatch-card-wrapper">
  <div class="smartwatch-section-divider"></div>
  <div class="smartwatch-section-title">
  Smartwatch
  <button class="smartwatch-info-btn-pro" onclick="toggleSmartwatchInfo(event)">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
    </svg>
  </button>
  <div class="smartwatch-info-tooltip-pro" id="smartwatchInfoTooltip">
    <div class="smartwatch-tooltip-arrow"></div>
    <div class="smartwatch-tooltip-content">
      <div class="smartwatch-tooltip-title">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#34d399" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        Sincronizzazione Smartwatch
      </div>
      <div class="smartwatch-tooltip-text">
        Sincronizza il tuo smartwatch per importare automaticamente calorie bruciate, passi e battito cardiaco. I dati vengono confrontati con le calorie assunte per calcolare il tuo bilancio energetico reale.
      </div>
    </div>
  </div>
</div>
  <div id="smart-watch-card" class="card-container">
    
    <!-- 1. LAYERED BACKGROUNDS -->
    <div class="bg-gradient"></div>
    <div class="bg-noise" style="background-image: url('data:image/svg+xml,%3Csvg viewBox=\'0 0 200 200\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cfilter id=\'noiseFilter\'%3E%3CfeTurbulence type=\'fractalNoise\' baseFrequency=\'0.65\' numOctaves=\'3\' stitchTiles=\'stitch\'/%3E%3C/filter%3E%3Crect width=\'100%25\' height=\'100%25\' filter=\'url(%23noiseFilter)\'/%3E%3C/svg%3E')"></div>

    <!-- Background SVG Elements: Parallax Smooth Waves -->
    <div class="bg-waves">
       <svg class="waves-svg" viewBox="0 0 1200 120" preserveAspectRatio="none">
          <path d="M0,120 L0,60 C150,90 300,30 450,60 C600,90 750,30 900,60 C1050,90 1200,30 1200,120 Z" fill="white" opacity="0.3">
              <animateTransform attributeName="transform" type="translate" from="0 0" to="-600 0" dur="20s" repeatCount="indefinite" />
          </path>
          <path d="M0,120 L0,80 C100,50 200,100 300,70 C400,40 500,90 600,60 C700,30 800,80 900,50 C1000,20 1100,70 1200,120 Z" fill="white" opacity="0.5">
              <animateTransform attributeName="transform" type="translate" from="-200 0" to="-800 0" dur="15s" repeatCount="indefinite" />
          </path>
          <path d="M0,120 L0,95 C120,110 240,70 360,95 C480,120 600,80 720,95 C840,110 960,70 1080,95 L1200,120 Z" fill="white" opacity="0.8">
               <animateTransform attributeName="transform" type="translate" from="0 0" to="-720 0" dur="10s" repeatCount="indefinite" />
          </path>
       </svg>
       <div class="waves-overlay"></div>
    </div>

    <!-- 2. CONTENT CONTAINER -->
    <div class="sw-content-wrapper">
      
      <!-- Header -->
      <div class="sw-header">
          <div class="sw-header-badge">
              <span id="sw-header-icon"></span>
              <span id="sw-header-text" class="sw-header-text">Smart Device</span>
          </div>
          <div id="sw-live-indicator" class="sw-live-indicator hidden">
                 <span class="sw-live-text">Live Sync</span>
                 <div class="sw-live-dot"></div>
          </div>
      </div>

      <!-- Main Center Area -->
      <div id="sw-main-content"></div>

    </div>
  </div>
</div>

<!-- Bilancio Energetico Reale - Wrapper esterno come Smartwatch -->
<div class="bilancio-card-wrapper" id="bilancioWrapper" style="display:none;">
  <div class="bilancio-section-divider"></div>
  <div class="bilancio-section-title">
    Bilancio Energetico
    <button class="bilancio-info-btn-pro" onclick="toggleBilancioInfo(event)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
      </svg>
    </button>
    <div class="bilancio-info-tooltip-pro" id="bilancioInfoTooltip">
      <div class="bilancio-tooltip-arrow"></div>
      <div class="bilancio-tooltip-content">
        <div class="bilancio-tooltip-title">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#34d399" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          Bilancio Energetico Reale
        </div>
        <div class="bilancio-tooltip-text">
          Confronta le calorie consumate (BMR + attivitÃ  smartwatch) con quelle assunte dai pasti. Ti mostra se sei in deficit (dimagrimento) o surplus (aumento peso) calorico.
        </div>
      </div>
    </div>
  </div>
  
  <!-- Card interna -->
  <div id="bilancioEnergeticoCard" class="bilancio-card-container">
    <div class="bilancio-bg-gradient"></div>
    <div class="bilancio-bg-noise"></div>
    <div class="bilancio-bg-waves">
      <svg class="bilancio-waves-svg" viewBox="0 0 1200 120" preserveAspectRatio="none">
        <path d="M0,120 L0,60 C150,90 300,30 450,60 C600,90 750,30 900,60 C1050,90 1200,30 1200,120 Z" fill="white" opacity="0.1">
          <animateTransform attributeName="transform" type="translate" from="0 0" to="-600 0" dur="20s" repeatCount="indefinite" />
        </path>
      </svg>
    </div>
    
    <div class="bilancio-content-wrapper">
      <div id="risultatoConfronto"></div>
    </div>
  </div>
</div>

<!-- Hidden inputs for compatibility -->
<input type="hidden" id="calorieOrologio" value="0">
<div id="confrontoCalorie" style="display:none;"></div>

<!-- Elementi nascosti per compatibilitÃ  ristorante originale -->
<div style="display:none;">
  <select id="ristorantePasto"></select>
  <input id="customMealName" type="text">
  <input id="customMealKcal" type="number">
</div>

</section>

 <section id="andamento">
      <h2>ðŸ“ˆ Andamento e Statistiche</h2>
      
      <!-- ANALISI INTELLIGENTE -->
      <div class="card" style="margin-bottom:12px;background:linear-gradient(135deg, rgba(7,127,191,0.05), rgba(79,195,247,0.05))">
        <h3>ðŸ§  Analisi Intelligente</h3>
        <div id="analisiAndamento"></div>
      </div>
      
      <div class="card" style="margin-bottom:12px">
        <h3>ðŸ“Š Grafici Andamento</h3>
        
        <div class="chart-tabs">
          <button class="chart-tab active" onclick="switchChart('settimana')" id="tab-settimana">
            ðŸ“… Settimana
          </button>
          <button class="chart-tab" onclick="switchChart('mese')" id="tab-mese">
            ðŸ“† Mese
          </button>
          <button class="chart-tab" onclick="switchChart('3mesi')" id="tab-3mesi">
            ðŸ“Š 3 Mesi
          </button>
        </div>
        
        <div class="chart-container">
          <canvas id="chartCalorie" class="chart-canvas"></canvas>
        </div>
      </div>
      
      <div class="card">
        <h3>ðŸ“‹ Andamento Completo (ultimi 90 giorni)</h3>
        
        <div style="display:flex;gap:8px;margin-bottom:12px">
          <input type="date" id="filtroDa" class="col" onchange="filtraAndamento()">
          <input type="date" id="filtroA" class="col" onchange="filtraAndamento()">
          <button class="btn-ghost" onclick="resetFiltroAndamento()">ðŸ”„ Reset</button>
        </div>
        
        <div id="andamentoLista" style="max-height:500px;overflow-y:auto">
          <!-- Andamento qui -->
        </div>
      </div>
    </section>
        
       
    <section id="impostazioni">

      <h2>âš™ï¸ Impostazioni</h2>

                           
        <!-- Tutorial Card - DA AGGIUNGERE ALL'INIZIO DELLA SEZIONE IMPOSTAZIONI -->
<div class="card" style="background: linear-gradient(135deg, rgba(79, 195, 247, 0.1), rgba(7, 127, 191, 0.05)); border-left: 1px solid #4fc3f7;">
  <h3>â“ Tutorial & Guida</h3>
  <p class="tiny">Rivedi la guida completa o riavvia il tutorial interattivo con Freezy</p>
  <div style="display:flex; gap:8px; margin-top:10px;">
    <button class="btn-primary" onclick="openClassicTutorial()" style="flex:1;">
      ðŸ“š Guida Completa
    </button>
    <button class="btn-primary" onclick="startInteractiveTutorial()" style="flex:1;">
      ðŸ¤– Tutorial Interattivo
    </button>
  </div>
</div>                      
      
<hr style="border: none; margin: 5px 0;">                                                                       
                                                                                    
      <div class="card" style="margin-bottom:12px">

        <h3>ðŸŽ¨ Tema e Audio</h3>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">

          <button class="btn-primary" onclick="toggleDarkMode()">ðŸŒ“ Cambia Tema</button>

          <span class="tiny" id="currentTheme">Tema Chiaro</span>
                                              
                                              </div>
                                              
                                              <div id="themeImages" style="position:absolute; right:5px; top: 18.05%; transform: translateY(-80%) scale(0.7); display:flex; gap:80px; z-index:1000;">
  <img id="lightImage" src="./img/me_chiaro.png" alt="Tema Chiaro" style="width:145px; display:block;">
  <img id="darkImage" src="./img/me_scuro.png" alt="Tema Scuro" style="width:150px; display:none;">

        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap">

          <button class="btn-ghost" id="autoSpeakBtn" onclick="toggleAutoSpeak()">ðŸ”‡ Voce Auto OFF</button>

          <button class="btn-primary" id="muteBtn" onclick="toggleMute()">ðŸ”Š Audio ON</button>

        </div>

        <div class="tiny" style="margin-top:8px">

          <strong>Voce Automatica:</strong> l'assistente parlerÃ  dopo ogni risposta.<br>

          <strong>Muta Audio:</strong> disattiva tutti i suoni.

        </div>

      </div>

     <div class="card" style="margin-bottom:12px">
        <h3>ðŸ¤– Intelligenza Artificiale Avanzata</h3>
        
        <!-- INDICATORE STATO AI -->
        <div id="aiStatus" class="tiny" style="margin-bottom:12px;padding:10px;border-radius:8px;background:var(--input-bg);border-left:3px solid var(--accent)">
          â³ Verifica stato AI in corso...
        </div>
        
        <!-- INFO MODALITÃ€ -->
        <div class="card" style="margin-bottom:12px;background:rgba(7,127,191,0.05)">
          <div class="tiny">
            <strong>ðŸ“Š ModalitÃ  AI Disponibili:</strong><br><br>
            
            ðŸ¥‡ <strong>Groq AI (Consigliata)</strong><br>
            âœ… Potentissima e veloce<br>
            âœ… 14.400 richieste/giorno gratis<br>
            âš ï¸ Richiede chiave API (gratuita)<br><br>
            
            ðŸ¥ˆ <strong>AI Locale</strong><br>
            âœ… Funziona offline<br>
            âœ… Nessuna chiave necessaria<br>
            âš ï¸ Meno potente<br><br>
            
            ðŸ¥‰ <strong>Assistente Base</strong><br>
            âœ… Sempre disponibile<br>
            âš ï¸ Risposte predefinite limitate
          </div>
        </div>
        
        <!-- BOTTONE GUIDA RAPIDA -->
        <button class="btn-primary" onclick="showGroqGuide()" style="width:100%;margin-bottom:12px">
          ðŸš€ Come Ottenere la Chiave API Groq (2 minuti)
        </button>
        
        <!-- CAMPO CHIAVE -->
        <label class="tiny" style="display:block;margin-bottom:4px;font-weight:600">
          ðŸ”‘ Chiave API Groq (opzionale)
        </label>
        <input 
          type="password" 
          id="groqApiKey" 
          placeholder="gsk_..." 
          style="width:100%;margin-bottom:8px"
        >
        
        <!-- BOTTONI AZIONE -->
        <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">
          <button class="btn-primary" onclick="saveGroqKey()">ðŸ’¾ Salva</button>
          <button class="btn-ghost" onclick="testGroqKey()">ðŸ§ª Testa</button>
          <button class="btn-ghost" onclick="clearGroqKey()">ðŸ—‘ï¸ Elimina</button>
          <button class="btn-ghost" onclick="toggleKeyVisibility()">ðŸ‘ï¸ Mostra</button>
        </div>
        
        <div id="groqStatus" class="tiny" style="margin-bottom:8px"></div>
        
        <!-- RACCOMANDAZIONI SICUREZZA -->
        <div class="card" style="background:rgba(239,68,68,0.05);border-left:3px solid var(--danger)">
          <div class="tiny">
            <strong>âš ï¸ IMPORTANTE - Sicurezza:</strong><br>
            ðŸ”’ La chiave Ã¨ salvata SOLO sul tuo dispositivo<br>
            ðŸš« Non condividere MAI la tua chiave<br>
            ðŸ”„ Puoi rigenerarla in qualsiasi momento<br>
            ðŸ’¡ Se non usi Groq, l'AI Locale funziona ugualmente
          </div>
        </div>
      </div>


<div class="card" style="margin-top:12px">
  <h3>ðŸ”® Replicate AI Vision</h3>
  <div class="tiny" style="margin-bottom:8px">Per l'analisi AI visiva delle foto (crediti gratuiti mensili)</div>
  
  <input type="password" id="replicateApiKey" placeholder="Inserisci API Token Replicate" style="width:100%;margin-bottom:8px">
  
  <div style="display:flex;gap:6px;flex-wrap:wrap">
    <button class="btn-primary" onclick="saveReplicateKey()">ðŸ’¾ Salva</button>
    <button class="btn-ghost" onclick="testReplicateKey()">âœ… Testa</button>
    <button class="btn-ghost" onclick="clearReplicateKey()">ðŸ—‘ï¸ Elimina</button>
    <button class="btn-ghost" onclick="toggleReplicateKeyVisibility()">ðŸ‘ï¸</button>
  </div>
  
  <div id="replicateStatus" style="margin-top:8px;padding:8px;border-radius:6px;font-size:13px"></div>
  
  <div style="margin-top:12px;padding:10px;background:rgba(139,92,246,0.1);border-radius:8px">
    <strong>âœ¨ Vantaggi Replicate:</strong>
    <ul style="margin:8px 0 0 20px;font-size:13px">
      <li>$0.025 di credito gratuito ogni mese</li>
      <li>~25 analisi foto gratis al mese</li>
      <li>Solo email richiesta (no carta)</li>
      <li>AI visiva molto accurata (LLaMA 3.2 Vision)</li>
    </ul>
    <div style="margin-top:8px">
      <a href="https://replicate.com/signin" target="_blank" style="color:var(--primary)">
        ðŸ”— Registrati su Replicate (1 minuto)
      </a>
    </div>
  </div>
</div>


      <div class="card" style="margin-bottom:12px">

        <h3>â„ï¸ Parametri Frigo</h3>

        <div class="row">

          <input id="temp" type="number" placeholder="Temp Â°C" class="col" value="4">

          <input id="umid" type="number" placeholder="UmiditÃ  %" class="col" value="60">

        </div>

        <div class="row" style="margin-top:8px">

          <input id="tempMin" type="number" placeholder="Min Â°C" class="col" value="2">

          <input id="tempMax" type="number" placeholder="Max Â°C" class="col" value="8">

          <input id="umidMin" type="number" placeholder="Min UmiditÃ  %" class="col" value="40">

          <input id="umidMax" type="number" placeholder="Max UmiditÃ  %" class="col" value="80">

        </div>

        <div class="row" style="margin-top:8px">

          <select id="modalitaFrigo" class="col">

            <option value="eco">ðŸŒ± ModalitÃ  Eco</option>

            <option value="normale" selected>âš¡ Normale</option>

            <option value="turbo">ðŸš€ Turbo</option>

            <option value="vacanza">âœˆï¸ Vacanza</option>

          </select>

          <select id="zonaFrigo" class="col">

            <option value="generale">Frigo Generale</option>

            <option value="verdure">ðŸ¥¬ Cassetto Verdure</option>

            <option value="carne">ðŸ¥© Zona Carne</option>

            <option value="freezer">â„ï¸ Freezer</option>

          </select>

        </div>

      </div>

     

      <div class="card" style="margin-bottom:12px">

        <h3>ðŸ”” Notifiche</h3>

        <div style="display:flex;flex-direction:column;gap:8px">

          <label style="display:flex;align-items:center;gap:8px">

            <input type="checkbox" id="notifScadenza" checked>

            <span class="tiny">Avvisi scadenza alimenti (3 giorni prima)</span>

          </label>

          <label style="display:flex;align-items:center;gap:8px">

            <input type="checkbox" id="notifTemp" checked>

            <span class="tiny">Avvisi temperatura anomala</span>

          </label>

          <label style="display:flex;align-items:center;gap:8px">

            <input type="checkbox" id="notifPasti" checked>

            <span class="tiny">Promemoria pasti giornalieri</span>

          </label>

        </div>

      </div>

     

      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">

        <button class="btn-primary" onclick="saveSettingsIndexed()">ðŸ’¾ Salva Impostazioni</button>

        <button class="btn-ghost" onclick="loadSettingsIndexed()">ðŸ“‚ Carica</button>

        <button class="btn-ghost" onclick="resetSettings()">ðŸ”„ Reset</button>

      </div>

      <div class="tiny" id="statoImpostazioni" style="margin-top:8px"></div>

    </section>

  </div>

 

  <aside>

    <section class="card">

      <h3>ðŸŽ® Controllo rapido</h3>

      <div class="tiny">ðŸŒ¡ï¸ Temp: <span id="curTemp">4Â°C</span></div>

      <div class="tiny">ðŸ’§ UmiditÃ : <span id="curUmid">60%</span></div>

      <div style="margin-top:8px">

        <button class="btn-ghost" onclick="checkExpiry()">â° Controlla scadenze</button>

      </div>

    </section>

 

    <section class="card" style="margin-top:10px">

      <h3>âš¡ Rapide</h3>

      <div style="display:flex;flex-direction:column;gap:6px">

        <button class="btn-ghost" onclick="planFromFridge()">ðŸ’¡ Suggerisci</button>

        <button class="btn-ghost" onclick="show('fotocamera')">ðŸ“· Scansiona</button>

      </div>

    </section>

  </aside>

</main>

<!-- ========================================
     PROFESSIONAL NUTRIFLOW CALCULATOR
     Design identico al codice React
     ======================================== -->

<!-- Paint Splatter Background -->
<div id="paintSplatterBg" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;display:none;background:#042f2e;background-image:radial-gradient(circle at 10% 20%, rgba(34, 197, 94, 0.8) 0%, transparent 40%),radial-gradient(circle at 90% 10%, rgba(125, 211, 252, 0.8) 0%, transparent 45%),radial-gradient(circle at 50% 80%, rgba(34, 197, 94, 0.6) 0%, transparent 50%),radial-gradient(circle at 80% 90%, rgba(14, 165, 233, 0.7) 0%, transparent 40%),radial-gradient(circle at 30% 60%, rgba(134, 239, 172, 0.5) 0%, transparent 35%);filter:blur(60px);"></div>

<!-- ðŸ†• Spinner Caricamento Aggiornamento -->
<div id="updateSpinner" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter:blur(10px);z-index:100003;flex-direction:column;align-items:center;justify-content:center;gap:16px;">
    <div style="width:48px;height:48px;border:3px solid rgba(16,185,129,0.2);border-top-color:#10b981;border-radius:50%;animation:spin-update 1s linear infinite;"></div>
    <span style="color:#10b981;font-size:13px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;">Aggiornamento...</span>
</div>

<style>
@keyframes spin-update {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<!-- Close Button - Visibile solo quando slide Ã¨ aperto -->
<button id="closeFabbisognoBtn" onclick="closeFabbisognoSlide()" style="position:fixed;top:20px;left:20px;z-index:100002;width:40px;height:40px;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);border-radius:50%;color:white;font-size:18px;cursor:pointer;display:none;align-items:center;justify-content:center;transition:all 0.3s;">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
</button>

<!-- Overlay -->
<div id="fabbisogno-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:100000;opacity:0;visibility:hidden;transition:opacity 0.3s ease,visibility 0.3s ease;" onclick="closeFabbisognoSlide()"></div>

<!-- Main Slide -->
<div id="fabbisogno-slide" style="position:fixed;top:0;right:-100%;width:100%;height:100%;background:transparent;z-index:100001;overflow-y:auto;transition:right 0.4s cubic-bezier(0.25,0.46,0.45,0.94);padding:12px 0 40px;">
    
    <!-- Container -->
    <div style="display:flex;flex-direction:column;align-items:center;width:100%;max-width:450px;margin:0 auto;padding:0 16px;">
        
        <!-- Main Glass Card -->
        <div class="main-glass-nutriflow" style="width:100%;background:rgba(15,23,42,0.2);backdrop-filter:blur(45px) saturate(180%);-webkit-backdrop-filter:blur(45px) saturate(180%);border:1px solid rgba(255,255,255,0.1);border-radius:48px;box-shadow:0 50px 100px -20px rgba(0,0,0,0.5),inset 0 1px 1px rgba(255,255,255,0.05);padding:32px;">
            
            <!-- Header -->
            <div id="headerSection" style="margin-bottom:32px;text-align:center;">
                <h1 style="font-size:30px;font-weight:900;color:white;letter-spacing:-0.05em;text-transform:uppercase;margin:0;">
    CALCOLO<span style="color:#34d399;"> NUTRIZIONALE</span>
</h1>
<p style="font-size:0.65rem;text-transform:uppercase;letter-spacing:0.15em;font-weight:700;color:rgba(255,255,255,0.4);margin:8px 0 0;">Professional Analysis</p>
            </div>
            
            <!-- Progress Bar -->
            <div id="progressBarNutriflow" style="display:flex;justify-content:center;gap:6px;margin-bottom:40px;">
                <!-- Generated by JS -->
            </div>
            
            <!-- Step Content -->
            <div id="stepContentNutriflow">
                <!-- Generated by JS -->
            </div>
            
            <!-- Navigation Buttons -->
            <div id="navButtonsNutriflow" style="margin-top:40px;display:flex;gap:12px;">
                <!-- Generated by JS -->
            </div>
            
        </div>
    </div>
    
    <!-- Hidden fields for compatibility -->
    <div style="display:none;">
        <input id="sesso" type="text">
        <input id="eta" type="number">
        <input id="pesoF" type="number">
        <input id="altezza" type="number">
        <input id="attivita" type="text">
        <input id="obiettivo" type="number">
        <input id="tipoDieta" type="text">
        <div id="dietaInfo"><div id="dietaDescrizione"></div></div>
        <div id="risultatoFabbisogno"></div>
    </div>
</div>

<!-- Overlay -->
<div id="fabbisogno-overlay" class="slide-overlay" onclick="closeFabbisognoSlide()"></div>

<!-- HTML -->
<div class="analisi-salute-wrapper">
<!-- HEADER CHIUDI -->
    <div style="position: sticky; top: 0; z-index: 100; background: linear-gradient(135deg, rgba(17, 237, 62, 0.42) 0%, rgba(255, 255, 255, 0.5) 100%); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 4px 30px rgba(14, 193, 57, 0.36);">
        <button onclick="closeAnalisiSalute()" style="background: rgba(7, 169, 33, 0.3); border: none; font-size: 20px; color: white; cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s;">
            <i class="fa-solid fa-arrow-left"></i>
        </button>
        <h2 style="margin: 0; font-size: 15px; font-weight: 800; color: rgba(5, 20, 16, 0.7); text-transform: uppercase; letter-spacing: 0.12em;">Analisi Salute</h2>
        <div style="width: 40px;"></div>
    </div>
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
    
    <div class="analisi-content">
        
        <!-- Header -->
        <section class="header-section">
            <div class="header-row">
               <div class="header-left">
                    <div class="info-container">
                        <p class="riepilogo-label">Riepilogo Salute</p>
                        <button class="info-btn" id="riepilogoInfoBtn" onclick="toggleRiepilogoTooltip(event)">
                            <i class="fa-solid fa-circle-info"></i>
                        </button>
                        <div class="tooltip-box" id="riepilogoTooltip">
                            <strong>ðŸ“Š Il Grafico del Peso</strong><br><br>
                            Questo grafico mostra come cambia il tuo peso giorno per giorno. Sull'asse orizzontale vedi i giorni, su quello verticale il peso in kg.<br><br>
                            <strong>Come funziona:</strong> L'app calcola automaticamente il peso stimato in base a quello che mangi ogni giorno.<br><br>
                            <strong>âš ï¸ Importante:</strong> Per avere risultati affidabili devi inserire TUTTI i pasti che fai ogni giorno con le calorie corrette. Se registri solo 1-2 pasti da 500 kcal ma in realtÃ  ne mangi 3-4 da 2500 kcal, il calcolo sarÃ  completamente sbagliato!
                        </div>
                    </div>
                    <h1 class="peso-grande" id="pesoDisplay">82.4 <span>kg</span></h1>
                </div>
                <div class="time-toggle-container">
                    <div class="time-toggle-item">
                        <button class="time-toggle-btn" data-range="7d" onclick="setTimeRange('7d')">7d</button>
                        <span class="time-toggle-desc">Settimanale</span>
                    </div>
                    <div class="time-toggle-item">
                        <button class="time-toggle-btn active" data-range="30d" onclick="setTimeRange('30d')">30d</button>
                        <span class="time-toggle-desc">Mensile</span>
                    </div>
                    <div class="time-toggle-item">
                        <button class="time-toggle-btn" data-range="90d" onclick="setTimeRange('90d')">90d</button>
                        <span class="time-toggle-desc">Trimestrale</span>
                    </div>
                </div>
            </div>
            
            <div class="grafico-card">
    
    <div class="variazione-box">
                    <p class="variazione-title">Variazione</p>
                    <p class="variazione-value" id="variazioneDisplay">-1.7 kg</p>
                </div>
                <div class="chart-container">
                    <canvas id="pesoChart"></canvas>
                </div>
            </div>
        </section>
       
        <!-- Composizione Corporea -->
        <section class="nature-card section-card" id="bodySection">
            <div class="section-header" onclick="toggleSection('body')">
                <h3 class="section-title">Composizione Corporea</h3>
                <i class="fa-solid fa-chevron-down rotate-btn active" id="bodyChevron"></i>
            </div>
            <div class="expand-section open" id="bodyContent">
                <div class="body-grid">
                    <div class="pie-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                    <div class="body-legend">
                        <div class="legend-item">
                            <div class="legend-left">
                                <div class="legend-dot" style="background-color: #2e7d32;"></div>
                                <span class="legend-name">Massa Magra</span>
                            </div>
                            <span class="legend-value">72%</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-left">
                                <div class="legend-dot" style="background-color: #e65100;"></div>
                                <span class="legend-name">Massa Grassa</span>
                            </div>
                            <span class="legend-value">18%</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-left">
                                <div class="legend-dot" style="background-color: #0288d1;"></div>
                                <span class="legend-name">Liquidi</span>
                            </div>
                            <span class="legend-value">10%</span>
                        </div>
                    </div>
                </div>
                <div class="btn-section" id="composizioneIASection">
                    <button class="btn-accent-ia" id="btnIAComposizione" onclick="analisiIAComposizione()">
                        <i class="fa-solid fa-atom"></i>
                        Analizza Composizione con IA
                    </button>
                    <div class="ia-result-box" id="composizioneIAResult" style="display: none;">
                        <button class="ia-result-close" onclick="chiudiIAComposizione()">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                        <p class="ia-result-label"><i class="fa-solid fa-robot"></i> Analisi IA</p>
                        <p class="ia-result-text" id="composizioneIAText"></p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Bio-Nutrizione -->
        <section class="nature-card section-card" id="macrosSection">
            <div class="section-header" onclick="toggleSection('macros')">
                <div class="info-container">
                    <h3 class="section-title">Bio-Nutrizione</h3>
                    <button class="info-btn hidden" id="infoBtn" onclick="toggleTooltip(event)">
                        <i class="fa-solid fa-circle-info"></i>
                    </button>
                    <div class="tooltip-box" id="nutriTooltip">
                        Analisi molecolare del bilancio azotato, turnover glucidico e assorbimento dei minerali essenziali.
                    </div>
                </div>
                <i class="fa-solid fa-chevron-down rotate-btn" id="macrosChevron"></i>
            </div>
            <div class="expand-section" id="macrosContent">
                <div class="macros-list" id="macrosList"></div>
                
                <div class="micros-section">
                    <p class="micros-title">Monitoraggio Micronutrienti</p>
                    <div class="micros-grid" id="microsGrid"></div>
                    <div id="nutrizioneIASection" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(46, 125, 50, 0.15);">
                        <button class="btn-ia-nutrizione" id="btnIANutrizione" onclick="analisiIANutrizione()">
                            <i class="fa-solid fa-atom"></i>
                            Analizza con IA
                        </button>
                        <div class="ia-result-box nutrizione" id="nutrizioneIAResult" style="display: none;">
                            <button class="ia-result-close" onclick="chiudiIANutrizione()">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                            <p class="ia-result-label"><i class="fa-solid fa-robot"></i> Analisi IA</p>
                            <p class="ia-result-text" id="nutrizioneIAText"></p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
<!-- Efficienza Metabolica -->
        <section class="nature-card section-card" id="metabolicSection">
            <div class="section-header" onclick="toggleSection('metabolic')">
                <div class="info-container">
                    <h3 class="section-title">Efficienza Metabolica</h3>
                   <button class="info-btn hidden" id="metabolicInfoBtn" onclick="toggleMetabolicTooltip(event)">
                        <i class="fa-solid fa-circle-info"></i>
                    </button>
                    <div class="tooltip-box" id="metabolicTooltip">
                        <strong>ðŸ”¥ Digestione:</strong> Valuta l'efficienza del transito intestinale basata sul rapporto tra macro consumati e target. Alta = bilanciamento >70%.<br><br>
                        <strong>ðŸ’ª Recupero:</strong> Stima la capacitÃ  di recupero muscolare. Calcolato: (proteineÃ—60% + carboidratiÃ—40%). Valori >80% indicano ottima resintesi glicogeno.<br><br>
                        <strong>âš¡ BMR:</strong> Metabolismo Basale calcolato con formula Mifflin-St Jeor. Indica le calorie bruciate a riposo.
                    </div>
                </div>
                <i class="fa-solid fa-chevron-down rotate-btn active" id="metabolicChevron"></i>
            </div>
            <div class="expand-section open" id="metabolicContent">
                <div class="metabolic-grid">
                    <div class="metabolic-card-dig">
                        <p class="metabolic-label-dig">Digestione</p>
                        <p class="metabolic-value-dig">Alta</p>
                        <p class="metabolic-desc-dig">Tempo di transito ottimale.</p>
                    </div>
                    <div class="metabolic-card-rec">
                        <p class="metabolic-label-rec">Recupero</p>
                        <p class="metabolic-value-rec">92%</p>
                        <p class="metabolic-desc-rec">Resintesi glicogeno rapida.</p>
                    </div>
                </div>
                <div class="basale-card">
                    <div class="basale-header">
                        <span class="basale-label">Metabolismo Basale</span>
                        <span class="basale-value" id="metabolismoBasaleValue">-- <span>kcal</span></span>
                    </div>
                    <p class="basale-desc" id="metabolismoBasaleDesc">Calcola il fabbisogno per vedere il tuo BMR.</p>
                </div>
            </div>
        </section>
        
        <!-- Consulto IA -->
        <div class="consulto-container">
            <button class="btn-consulto" id="btnConsulto" onclick="runConsultoIA()">
                Consulto Profondo IA <i class="fa-solid fa-sparkles"></i>
            </button>
            
            <div class="loading-box" id="loadingBox">
                <div class="spinner"></div>
                <p class="loading-text">Sincronizzazione Bio-Metrica...</p>
            </div>
        </div>
        
        <!-- OVERLAY ANALISI IA -->
        <div class="ai-panel-overlay" id="aiPanelOverlay">
            <div style="max-width: 500px; margin: 0 auto; width: 100%; padding-bottom: 40px; padding-top: 70px;">
                
                <!-- Header -->
                <div class="ai-header-bar">
                    <h4 class="ai-header-title">Analisi <span>IA</span></h4>
                    <img src="img/fioridettagli.png" alt="" class="ai-header-decor">
                    <div class="ai-score-badge">
                        <span class="score-label">Score</span>
                        <span id="aiScoreValue">0</span>%
                    </div>
                </div>
                
                <!-- Feedback Coach -->
                <div class="ai-glass-box ai-coach-box">
                    <span class="ai-title-label">Feedback Coach</span>
                    <p class="ai-content-text ai-font-stylish" id="aiFeedbackText">"..."</p>
                </div>
                
                <!-- Scientific Insight -->
                <div class="ai-glass-box ai-detail-box">
                    <span class="ai-title-label">Scientific Insight</span>
                    <p class="ai-content-text ai-font-tech" id="aiDetailText">...</p>
                </div>
                
                <!-- Azione Prioritaria -->
                <div class="ai-glass-box ai-action-box">
                    <span class="ai-title-label">Azione Prioritaria</span>
                    <p class="ai-action-text" id="aiActionText">...</p>
                </div>
                
                <!-- Sezione Accurate Advice (nascosta inizialmente) -->
              <div class="accurate-advice-section" id="accurateAdviceSection" style="display: none;">
                    <div class="ai-glass-box" style="background: linear-gradient(145deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);">
                        <span class="ai-title-label">Consiglio Accurate Pro</span>
                        
                        <div class="metric-grid" style="grid-template-columns: 1fr; gap: 0.8rem;">
                            <div class="metric-item">
                                <p class="metric-label prot">Proteine</p>
                                <p class="metric-value" id="accProteine">--</p>
                            </div>
                            <div class="metric-item">
                                <p class="metric-label carb">Carboidrati</p>
                                <p class="metric-value" id="accCarboidrati">--</p>
                            </div>
                            <div class="metric-item">
                                <p class="metric-label fat">Grassi</p>
                                <p class="metric-value" id="accGrassi">--</p>
                            </div>
                        </div>
                        
                        <div class="previsioni-list">
                            <p class="previsioni-title">Miglioramenti Previsti</p>
                            <div id="previsioniContainer"></div>
                        </div>
                        
                        <p class="ai-extra-text" id="accTestoExtra"></p>
                    </div>
                </div>

               <!-- Bottoni -->
                <div style="margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem;">
                    <button class="cyber-btn cyber-btn-accent" id="btnAccurate" onclick="generateAccurateAdvice()">
                        <i class="fa-solid fa-chart-line"></i>
                        Genera un consiglio piÃ¹ accurato
                    </button>
                    
                    <button class="cyber-btn" onclick="closeAiPanel()">
                        Chiudi Report <i class="fa-solid fa-chevron-down" style="margin-left: 12px;"></i>
                    </button>
                </div>
                
            </div>
        </div>
        
        <footer class="analisi-footer">
            <p>Personal Health Engine</p>
        </footer>
        
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>

 <!-- Transformers.js per AI locale -->
<script type="module">
  import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1';
  env.allowLocalModels = false;
  env.useBrowserCache = true;
  window.transformers = { pipeline, env };
</script>

<script>

// ========================================
// ðŸ”„ SERVICE WORKER E AUTO-UPDATE
// ========================================

// Registra service worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(registration => {
        console.log('âœ… Service Worker registrato:', registration.scope);
        
        // Controlla aggiornamenti ogni 60 secondi
        setInterval(() => {
          registration.update();
        }, 60000);
        
        // Listener per nuovi service worker
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          console.log('ðŸ”„ Nuovo Service Worker trovato!');
          
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              console.log('âœ¨ Nuova versione disponibile!');
              
              // AGGIORNAMENTO AUTOMATICO SILENZIOSO
              newWorker.postMessage('skipWaiting');
              
              // Ricarica la pagina dopo 1 secondo
              setTimeout(() => {
                console.log('ðŸ”„ Ricarico la pagina per applicare aggiornamenti...');
                window.location.reload();
              }, 1000);
            }
          });
        });
        
        // Se c'Ã¨ giÃ  un service worker in attesa, attivalo
        if (registration.waiting) {
          registration.waiting.postMessage('skipWaiting');
          setTimeout(() => window.location.reload(), 1000);
        }
      })
      .catch(err => {
        console.error('âŒ Errore registrazione Service Worker:', err);
      });
    
    // Listener per quando il nuovo SW prende controllo
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      console.log('ðŸ”„ Nuovo Service Worker attivo, ricarico...');
      window.location.reload();
    });
  });
}

// Fallback: controllo versione meta tag (se SW non supportato)
(function() {
  const currentVersion = document.querySelector('meta[name="app-version"]')?.content || '2.0';
  const savedVersion = localStorage.getItem('appVersion');
  
  if (savedVersion && savedVersion !== currentVersion) {
    console.log('ðŸ”„ Nuova versione rilevata dal meta tag!');
    localStorage.setItem('appVersion', currentVersion);
    window.location.reload(true);
  } else {
    localStorage.setItem('appVersion', currentVersion);
  }
})();

let fridge = [];


let recipes = [
  // Ricette originali
  {nome:"Pasta al pomodoro", veg:true, ingredienti:["pasta","pomodoro","olio","basilico"], kcal:420, prot:12, carb:68, fat:10},
  {nome:"Insalata di quinoa", veg:true, ingredienti:["quinoa","verdure","olio"], kcal:380, prot:10, carb:50, fat:12},
  {nome:"Pollo al forno", veg:false, ingredienti:["pollo","olio","rosmarino"], kcal:550, prot:40, carb:4, fat:36},
  {nome:"Zuppa di lenticchie", veg:true, ingredienti:["lenticchie","carota","cipolla"], kcal:320, prot:18, carb:45, fat:4},
  {nome:"Frullato banana", veg:true, ingredienti:["banana","spinaci","latte"], kcal:210, prot:6, carb:40, fat:2},
  {nome:"Risotto ai funghi", veg:true, ingredienti:["riso","funghi","burro"], kcal:480, prot:9, carb:68, fat:14},
  {nome:"Salmone al forno", veg:false, ingredienti:["salmone","limone"], kcal:460, prot:34, carb:0, fat:34},
  {nome:"Frittata verdure", veg:false, ingredienti:["uova","verdure"], kcal:300, prot:18, carb:6, fat:22},
  {nome:"Insalata di ceci", veg:true, ingredienti:["ceci","verdure"], kcal:350, prot:15, carb:40, fat:10},
  {nome:"Smoothie verde", veg:true, ingredienti:["spinaci","frutta","yogurt"], kcal:190, prot:8, carb:30, fat:3},
  {nome:"Toast avocado", veg:true, ingredienti:["pane","avocado","uova"], kcal:340, prot:14, carb:28, fat:18},
  {nome:"Yogurt e cereali", veg:true, ingredienti:["yogurt","cereali","frutta"], kcal:280, prot:12, carb:45, fat:6},
  {nome:"Pancake proteici", veg:false, ingredienti:["uova","banana","farina"], kcal:350, prot:20, carb:42, fat:10},
  {nome:"Insalata Caesar", veg:false, ingredienti:["lattuga","pollo","parmigiano"], kcal:420, prot:28, carb:12, fat:28},
  {nome:"Wrap tonno", veg:false, ingredienti:["tortilla","tonno","verdure"], kcal:380, prot:26, carb:35, fat:14},
  
  // Ricette dai menu - Bilanciata
  {nome:"Yogurt greco con avena e miele", veg:true, ingredienti:["yogurt greco","avena","miele"], kcal:95, prot:7, carb:12, fat:2},
  {nome:"Riso integrale con pollo e verdure", veg:false, ingredienti:["riso integrale","pollo","verdure"], kcal:120, prot:9, carb:16, fat:3},
  {nome:"Pesce al forno con patate e zucchine", veg:false, ingredienti:["pesce","patate","zucchine"], kcal:115, prot:13, carb:8, fat:3},
  {nome:"Latte scremato con cereali integrali", veg:true, ingredienti:["latte scremato","cereali integrali"], kcal:90, prot:4, carb:15, fat:1.5},
  {nome:"Pollo alla piastra con riso e spinaci", veg:false, ingredienti:["pollo","riso","spinaci"], kcal:115, prot:10, carb:11, fat:3},
  {nome:"Fette biscottate con marmellata", veg:true, ingredienti:["fette biscottate","marmellata"], kcal:110, prot:3, carb:20, fat:1.5},
  {nome:"Pasta e fagioli", veg:true, ingredienti:["pasta","fagioli","pomodoro"], kcal:130, prot:7, carb:19, fat:3},
  {nome:"Salmone al forno con verdure al vapore", veg:false, ingredienti:["salmone","verdure"], kcal:130, prot:14, carb:5, fat:6},
  {nome:"Insalata di farro con tonno e verdure", veg:false, ingredienti:["farro","tonno","verdure"], kcal:125, prot:8, carb:17, fat:3},
  {nome:"Petto di tacchino con patate lesse", veg:false, ingredienti:["tacchino","patate"], kcal:110, prot:11, carb:10, fat:3},
  {nome:"Pancake d'avena e albume", veg:true, ingredienti:["avena","albume","banana"], kcal:110, prot:9, carb:14, fat:3},
  {nome:"Merluzzo al vapore con verdure e cous cous", veg:false, ingredienti:["merluzzo","verdure","cous cous"], kcal:115, prot:12, carb:10, fat:2},
  {nome:"Pasta al pesto leggero", veg:true, ingredienti:["pasta","pesto","basilico"], kcal:135, prot:4, carb:19, fat:5},
  {nome:"Riso con legumi e verdure", veg:true, ingredienti:["riso","legumi","verdure"], kcal:125, prot:6, carb:19, fat:3},
  {nome:"Filetto di pesce con patate e spinaci", veg:false, ingredienti:["pesce","patate","spinaci"], kcal:110, prot:13, carb:7, fat:3},
  
  // Ricette Chetogeniche
  {nome:"Uova strapazzate con avocado e olio EVO", veg:true, ingredienti:["uova","avocado","olio evo"], kcal:170, prot:9, carb:2, fat:14},
  {nome:"Salmone con spinaci al burro", veg:false, ingredienti:["salmone","spinaci","burro"], kcal:200, prot:16, carb:3, fat:15},
  {nome:"Pollo con panna e funghi", veg:false, ingredienti:["pollo","panna","funghi"], kcal:210, prot:18, carb:4, fat:15},
  {nome:"Omelette con formaggio e bacon", veg:false, ingredienti:["uova","formaggio","bacon"], kcal:190, prot:12, carb:2, fat:15},
  {nome:"Filetto di orata con verdure al burro", veg:false, ingredienti:["orata","verdure","burro"], kcal:180, prot:14, carb:2, fat:13},
  {nome:"Hamburger di manzo con zucchine", veg:false, ingredienti:["manzo","zucchine"], kcal:210, prot:18, carb:3, fat:16},
  {nome:"Yogurt intero con semi di chia e cocco", veg:true, ingredienti:["yogurt intero","semi di chia","cocco"], kcal:160, prot:6, carb:4, fat:13},
  {nome:"Tonno all'olio d'oliva con avocado", veg:false, ingredienti:["tonno","avocado","olio"], kcal:200, prot:17, carb:2, fat:15},
  {nome:"Bistecca con burro e asparagi", veg:false, ingredienti:["bistecca","burro","asparagi"], kcal:230, prot:20, carb:2, fat:18},
  {nome:"Polpette di tacchino al burro con zucchine", veg:false, ingredienti:["tacchino","burro","zucchine"], kcal:200, prot:17, carb:3, fat:15},
  {nome:"Manzo con broccoli e olio EVO", veg:false, ingredienti:["manzo","broccoli","olio"], kcal:190, prot:16, carb:2, fat:13},
  {nome:"Orata con verdure al burro", veg:false, ingredienti:["orata","verdure","burro"], kcal:180, prot:15, carb:2, fat:13},
  {nome:"Pancake low carb", veg:true, ingredienti:["uova","mandorle","burro"], kcal:200, prot:10, carb:4, fat:17},
  {nome:"Filetto di salmone al forno con zucchine", veg:false, ingredienti:["salmone","zucchine"], kcal:200, prot:17, carb:3, fat:15},
  
  // Ricette Ipertrofiche
  {nome:"Pancake proteico con frutta", veg:true, ingredienti:["albume","avena","banana","burro arachidi"], kcal:130, prot:9, carb:15, fat:4},
  {nome:"Porridge d'avena con latte e miele", veg:true, ingredienti:["avena","latte","miele"], kcal:110, prot:6, carb:16, fat:3},
  {nome:"Pasta al tonno e pomodoro", veg:false, ingredienti:["pasta","tonno","pomodoro"], kcal:130, prot:8, carb:18, fat:3},
  {nome:"Riso con tacchino e olio EVO", veg:false, ingredienti:["riso","tacchino","olio"], kcal:130, prot:9, carb:17, fat:3},
  {nome:"Bistecca con patate e spinaci", veg:false, ingredienti:["bistecca","patate","spinaci"], kcal:145, prot:14, carb:10, fat:6},
  {nome:"Pasta con pollo e verdure", veg:false, ingredienti:["pasta","pollo","verdure"], kcal:125, prot:9, carb:17, fat:3},
  {nome:"Tonno con riso e piselli", veg:false, ingredienti:["tonno","riso","piselli"], kcal:120, prot:11, carb:13, fat:3},
  {nome:"Risotto con pollo e zucchine", veg:false, ingredienti:["riso","pollo","zucchine"], kcal:125, prot:9, carb:16, fat:3},
  {nome:"Salmone con patate e verdure", veg:false, ingredienti:["salmone","patate","verdure"], kcal:140, prot:13, carb:8, fat:6},
  {nome:"Pollo al curry con riso", veg:false, ingredienti:["pollo","curry","riso"], kcal:125, prot:10, carb:15, fat:3},
  {nome:"Bistecca di manzo con cous cous e verdure", veg:false, ingredienti:["manzo","cous cous","verdure"], kcal:140, prot:12, carb:11, fat:5},
  {nome:"Pasta integrale con tonno e pomodoro", veg:false, ingredienti:["pasta integrale","tonno","pomodoro"], kcal:130, prot:8, carb:18, fat:3},
  {nome:"Pollo con patate e verdure al forno", veg:false, ingredienti:["pollo","patate","verdure"], kcal:135, prot:12, carb:11, fat:4},
  
  // Ricette Definizione
  {nome:"Albume e fiocchi d'avena", veg:true, ingredienti:["albume","avena"], kcal:95, prot:10, carb:8, fat:2},
  {nome:"Petto di pollo con riso basmati e verdure", veg:false, ingredienti:["pollo","riso basmati","verdure"], kcal:120, prot:12, carb:10, fat:3},
  {nome:"Filetto di merluzzo con zucchine", veg:false, ingredienti:["merluzzo","zucchine"], kcal:110, prot:14, carb:4, fat:3},
  {nome:"Tacchino alla piastra con riso integrale", veg:false, ingredienti:["tacchino","riso integrale"], kcal:115, prot:12, carb:9, fat:3},
  {nome:"Tonno al naturale con broccoli", veg:false, ingredienti:["tonno","broccoli"], kcal:105, prot:13, carb:4, fat:2},
  {nome:"Uova strapazzate con albumi e spinaci", veg:true, ingredienti:["uova","albumi","spinaci"], kcal:120, prot:12, carb:3, fat:6},
  {nome:"Pollo al curry con verdure grigliate", veg:false, ingredienti:["pollo","curry","verdure"], kcal:120, prot:13, carb:8, fat:4},
  {nome:"Salmone al vapore con zucchine e limone", veg:false, ingredienti:["salmone","zucchine","limone"], kcal:130, prot:15, carb:3, fat:6},
  {nome:"Manzo magro con cavolfiore al vapore", veg:false, ingredienti:["manzo","cavolfiore"], kcal:125, prot:14, carb:4, fat:4},
  {nome:"Branzino al forno con asparagi", veg:false, ingredienti:["branzino","asparagi"], kcal:110, prot:13, carb:3, fat:3},
  {nome:"Tacchino con patate dolci e verdure", veg:false, ingredienti:["tacchino","patate dolci","verdure"], kcal:120, prot:11, carb:11, fat:3},
  {nome:"Pollo al limone con broccoli", veg:false, ingredienti:["pollo","limone","broccoli"], kcal:110, prot:13, carb:5, fat:2},
  {nome:"Filetto di orata al forno", veg:false, ingredienti:["orata"], kcal:120, prot:14, carb:2, fat:4},
  
  // Ricette Low Fat
  {nome:"Latte scremato con cereali integrali low fat", veg:true, ingredienti:["latte scremato","cereali integrali"], kcal:85, prot:4, carb:14, fat:1},
  {nome:"Riso bollito con verdure e petto di pollo", veg:false, ingredienti:["riso","verdure","pollo"], kcal:110, prot:8, carb:17, fat:2},
  {nome:"Merluzzo al vapore con patate lesse e spinaci", veg:false, ingredienti:["merluzzo","patate","spinaci"], kcal:95, prot:11, carb:8, fat:1.5},
  {nome:"Pane integrale con marmellata light", veg:true, ingredienti:["pane integrale","marmellata"], kcal:100, prot:4, carb:18, fat:1},
  {nome:"Petto di tacchino grigliato con riso e carote", veg:false, ingredienti:["tacchino","riso","carote"], kcal:110, prot:11, carb:12, fat:1.5},
  {nome:"Insalata di farro con legumi e verdure", veg:true, ingredienti:["farro","legumi","verdure"], kcal:115, prot:6, carb:19, fat:1.5},
  {nome:"Pesce bianco al forno con patate e piselli", veg:false, ingredienti:["pesce bianco","patate","piselli"], kcal:105, prot:12, carb:9, fat:2},
  {nome:"Riso basmati con verdure al vapore", veg:true, ingredienti:["riso basmati","verdure"], kcal:115, prot:3, carb:22, fat:1},
  {nome:"Petto di pollo al limone con zucchine", veg:false, ingredienti:["pollo","limone","zucchine"], kcal:105, prot:12, carb:6, fat:1.5},
  {nome:"Tonno al naturale con insalata e pane integrale", veg:false, ingredienti:["tonno","insalata","pane"], kcal:110, prot:13, carb:11, fat:1.5},
  {nome:"Cous cous con verdure miste", veg:true, ingredienti:["cous cous","verdure"], kcal:115, prot:5, carb:20, fat:1.5},
  {nome:"Filetto di sogliola con riso e verdure al vapore", veg:false, ingredienti:["sogliola","riso","verdure"], kcal:105, prot:12, carb:9, fat:1.5},
  
  // Ricette Low Carb
  {nome:"Uova strapazzate con spinaci low carb", veg:true, ingredienti:["uova","spinaci"], kcal:140, prot:11, carb:2, fat:10},
  {nome:"Petto di pollo con broccoli al vapore e olio EVO", veg:false, ingredienti:["pollo","broccoli","olio"], kcal:130, prot:14, carb:3, fat:8},
  {nome:"Salmone al forno con zucchine low carb", veg:false, ingredienti:["salmone","zucchine"], kcal:150, prot:14, carb:2, fat:10},
  {nome:"Omelette con formaggio light e pomodoro", veg:true, ingredienti:["uova","formaggio","pomodoro"], kcal:145, prot:12, carb:2, fat:9},
  {nome:"Manzo magro alla griglia con insalata mista", veg:false, ingredienti:["manzo","insalata"], kcal:160, prot:16, carb:1, fat:10},
  {nome:"Orata al vapore con verdure al burro", veg:false, ingredienti:["orata","verdure","burro"], kcal:130, prot:13, carb:3, fat:7},
  {nome:"Tacchino alla piastra con melanzane grigliate", veg:false, ingredienti:["tacchino","melanzane"], kcal:120, prot:13, carb:2, fat:6},
  {nome:"Filetto di salmone con broccoli", veg:false, ingredienti:["salmone","broccoli"], kcal:150, prot:14, carb:3, fat:9},
  {nome:"Pollo al curry con panna leggera e zucchine", veg:false, ingredienti:["pollo","curry","panna","zucchine"], kcal:130, prot:12, carb:4, fat:7},
  {nome:"Tonno con insalata di uova e avocado", veg:false, ingredienti:["tonno","uova","avocado"], kcal:140, prot:13, carb:2, fat:9},
  {nome:"Bistecca di manzo con verdure al forno", veg:false, ingredienti:["manzo","verdure"], kcal:160, prot:18, carb:2, fat:9},
  {nome:"Branzino al forno con melanzane e zucchine", veg:false, ingredienti:["branzino","melanzane","zucchine"], kcal:120, prot:14, carb:2, fat:5},
  {nome:"Polpette di tacchino con cavolfiore", veg:false, ingredienti:["tacchino","cavolfiore"], kcal:130, prot:13, carb:4, fat:6},
  {nome:"Filetto di orata con spinaci saltati", veg:false, ingredienti:["orata","spinaci"], kcal:115, prot:12, carb:2, fat:5},
  {nome:"Salmone con cavolfiore al forno", veg:false, ingredienti:["salmone","cavolfiore"], kcal:145, prot:13, carb:3, fat:9},
  
  // Ricette Zona
  {nome:"Fiocchi d'avena con latte scremato e frutti di bosco", veg:true, ingredienti:["avena","latte","frutti di bosco"], kcal:90, prot:6, carb:13, fat:2},
  {nome:"Petto di pollo alla piastra con riso integrale e verdure zona", veg:false, ingredienti:["pollo","riso integrale","verdure"], kcal:110, prot:10, carb:12, fat:2.5},
  {nome:"Salmone al forno con broccoli al vapore zona", veg:false, ingredienti:["salmone","broccoli"], kcal:130, prot:14, carb:4, fat:7},
  {nome:"Tonno con insalata di quinoa e verdure", veg:false, ingredienti:["tonno","quinoa","verdure"], kcal:120, prot:9, carb:13, fat:4},
  {nome:"Uova strapazzate con spinaci e pane integrale", veg:true, ingredienti:["uova","spinaci","pane integrale"], kcal:130, prot:11, carb:10, fat:5},
  {nome:"Pollo al curry con riso basmati e verdure zona", veg:false, ingredienti:["pollo","curry","riso","verdure"], kcal:115, prot:10, carb:13, fat:3},
  {nome:"Merluzzo con patate dolci e insalata verde", veg:false, ingredienti:["merluzzo","patate dolci","insalata"], kcal:105, prot:12, carb:8, fat:2},
  {nome:"Tacchino alla griglia con riso e piselli", veg:false, ingredienti:["tacchino","riso","piselli"], kcal:115, prot:10, carb:13, fat:3},
  {nome:"Salmone alla piastra con verdure miste zona", veg:false, ingredienti:["salmone","verdure"], kcal:130, prot:13, carb:4, fat:7},
  {nome:"Tonno con patate e fagiolini", veg:false, ingredienti:["tonno","patate","fagiolini"], kcal:110, prot:9, carb:12, fat:3},
  {nome:"Pollo al limone con verdure grigliate zona", veg:false, ingredienti:["pollo","limone","verdure"], kcal:115, prot:12, carb:6, fat:4},
  {nome:"Riso integrale con salmone e zucchine", veg:false, ingredienti:["riso","salmone","zucchine"], kcal:120, prot:8, carb:14, fat:3},
  {nome:"Filetto di manzo magro con insalata e pane integrale", veg:false, ingredienti:["manzo","insalata","pane"], kcal:130, prot:14, carb:8, fat:4},
  {nome:"Pollo alla piastra con cous cous e verdure", veg:false, ingredienti:["pollo","cous cous","verdure"], kcal:120, prot:11, carb:13, fat:3},
  {nome:"Pesce spada alla griglia con patate e insalata", veg:false, ingredienti:["pesce spada","patate","insalata"], kcal:115, prot:13, carb:7, fat:3},
  
  // Ricette Mediterranee
  {nome:"Yogurt greco magro con miele e frutta fresca", veg:true, ingredienti:["yogurt greco","miele","frutta"], kcal:95, prot:6, carb:12, fat:2},
  {nome:"Pasta integrale al pomodoro e basilico", veg:true, ingredienti:["pasta integrale","pomodoro","basilico"], kcal:120, prot:4, carb:20, fat:2},
  {nome:"Filetto di orata al forno con patate e verdure", veg:false, ingredienti:["orata","patate","verdure"], kcal:110, prot:12, carb:8, fat:4},
  {nome:"Pane integrale con ricotta e miele", veg:true, ingredienti:["pane integrale","ricotta","miele"], kcal:140, prot:7, carb:20, fat:4},
  {nome:"Insalata di farro con tonno e verdure med", veg:false, ingredienti:["farro","tonno","verdure"], kcal:125, prot:8, carb:17, fat:3},
  {nome:"Pasta e ceci", veg:true, ingredienti:["pasta","ceci","pomodoro"], kcal:130, prot:6, carb:19, fat:3},
  {nome:"Salmone al forno con broccoli al vapore med", veg:false, ingredienti:["salmone","broccoli"], kcal:130, prot:14, carb:4, fat:7},
  {nome:"Risotto con zucchine e parmigiano", veg:true, ingredienti:["riso","zucchine","parmigiano"], kcal:125, prot:4, carb:20, fat:3},
  {nome:"Branzino alla griglia con spinaci e patate", veg:false, ingredienti:["branzino","spinaci","patate"], kcal:105, prot:13, carb:5, fat:3},
  {nome:"Lasagna vegetariana leggera", veg:true, ingredienti:["pasta","verdure","formaggio"], kcal:140, prot:7, carb:16, fat:5},
  {nome:"Merluzzo con patate lesse e insalata verde", veg:false, ingredienti:["merluzzo","patate","insalata"], kcal:100, prot:11, carb:7, fat:2},
  {nome:"Riso integrale con verdure e legumi med", veg:true, ingredienti:["riso","verdure","legumi"], kcal:125, prot:6, carb:19, fat:3},
  {nome:"Spigola al vapore con patate e verdure grigliate", veg:false, ingredienti:["spigola","patate","verdure"], kcal:110, prot:13, carb:6, fat:4}
];

// Variabili aggiuntive per compatibilitÃ  con il sistema di salvataggio
let shoppingList = [];
let mealPlan = [];
let mealTracking = [];
window.voiceEnabled = false;

let autoSpeak = localStorage.getItem('autoSpeak') === 'true';
let isMuted = localStorage.getItem('isMuted') === 'true';
let lastAssistantMessage = ''; // Memorizza l'ultimo messaggio dell'assistente
window.audioEnabled = autoSpeak;

let groceryList = [];
window.groceryList = groceryList;

let userNeeds = null;

let dailyMeals = {};
window.dailyMeals = dailyMeals;

let currentRecipeDetails = null;

let modelCOCO = null;

// ====== Estensioni IndexedDB: aggiungi store e salvataggi extra ======
// Se hai giÃ  aperto l'IndexedDB "FrigoSmartDB", assicurati che nella onupgradeneeded
// ci siano anche questi store (se non ci sono giÃ ):

// ESEMPIO (metti dentro richiesta.onupgradeneeded che hai giÃ ):
// if (!db.objectStoreNames.contains("grocery")) db.createObjectStore("grocery", { keyPath: "id" });
// if (!db.objectStoreNames.contains("menu")) db.createObjectStore("menu", { keyPath: "id" });
// if (!db.objectStoreNames.contains("prefs")) db.createObjectStore("prefs", { keyPath: "id" });

/* Se non puoi riaprire quella parte ora, aggiungo qui dei safe-guards: */
function ensureExtraStores() {
  try {
    const req = indexedDB.open("FrigoSmartDB");
    req.onsuccess = ev => {
      const _db = ev.target.result;
      // Se mancano store, bisogna fare bump di versione: skip per ora per non rompere.
      // (Se vuoi, mi dici e ti mando la migrazione con version bump)
    };
  } catch(e) { console.log(e); }
}
ensureExtraStores();

// ------ Salvataggi extra ------
function saveGroceryIndexed() {
  if (!window.db) return;
  const tx = db.transaction(["grocery"], "readwrite");
  const st = tx.objectStore("grocery");
  st.put({ id: 1, dati: (window.groceryList || []) });
  tx.oncomplete = () => console.log("âœ… Lista spesa salvata");
}

function loadGroceryIndexed() {
  if (!window.db) return;
  const tx = db.transaction(["grocery"], "readonly");
  const st = tx.objectStore("grocery");
  st.get(1).onsuccess = e => {
    if (e.target.result) {
      // ðŸ”§ Sincronizza ENTRAMBE le variabili
      groceryList = e.target.result.dati || [];
      window.groceryList = groceryList;
      
      console.log("ðŸ“š Lista spesa caricata da IndexedDB:", groceryList.length, "elementi");
      
      if (typeof renderGrocery === 'function') {
        renderGrocery();
      }
    } else {
      // Se non ci sono dati salvati, inizializza
      groceryList = [];
      window.groceryList = groceryList;
      console.log("ðŸ“ Lista spesa vuota inizializzata");
    }
  };
}

function saveMenuIndexed() {
  if (!window.db) return;
  const tx = db.transaction(["menu"], "readwrite");
  const st = tx.objectStore("menu");
  st.put({ id: 1, dati: (window.dailyMeals || {}) });
  tx.oncomplete = () => console.log("âœ… MenÃ¹ salvato");
}

function loadMenuIndexed() {
  if (!window.db) return;
  const tx = db.transaction(["menu"], "readonly");
  const st = tx.objectStore("menu");
  st.get(1).onsuccess = e => {
    if (e.target.result) {
      window.dailyMeals = e.target.result.dati || {};
      if (typeof updateDailyTracking === 'function') updateDailyTracking();
      console.log("ðŸ“š MenÃ¹ caricato");
    }
  };
}

// Preferenze (tema)
function savePrefsIndexed(theme) {
  if (!window.db) return;
  const tx = db.transaction(["prefs"], "readwrite");
  const st = tx.objectStore("prefs");
  st.put({ id: 1, theme: theme });
  tx.oncomplete = () => console.log("âœ… Tema salvato:", theme);
}

function loadPrefsIndexed() {
  if (!window.db) return;
  const tx = db.transaction(["prefs"], "readonly");
  const st = tx.objectStore("prefs");
  st.get(1).onsuccess = e => {
    const r = e.target.result;
    if (r && r.theme) {
      const isDark = r.theme === 'dark';
      document.body.classList.toggle('dark-mode', isDark);
      const currentThemeEl = document.getElementById('currentTheme');
      if (currentThemeEl) currentThemeEl.textContent = isDark ? 'Tema Scuro' : 'Tema Chiaro';
      // switch immagini se presenti
      const lightImg = document.getElementById("lightImage");
      const darkImg = document.getElementById("darkImage");
      if (lightImg && darkImg) {
        lightImg.style.display = isDark ? "none" : "block";
        darkImg.style.display = isDark ? "block" : "none";
      }
      console.log("ðŸ“š Tema caricato:", r.theme);
    }
  };
}

// ========== SISTEMA CALCOLO PESO AUTOMATICO ==========

function saveWeightEntry(peso, isInitial = false) {
    if (!window.db) return;
    const today = new Date().toISOString().split('T')[0];
    const tx = db.transaction(["weightHistory"], "readwrite");
    const store = tx.objectStore("weightHistory");
    store.put({ 
        data: today, 
        peso: peso, 
        isInitial: isInitial,
        timestamp: Date.now() 
    });
    tx.oncomplete = () => console.log("âœ… Peso salvato:", peso, "kg");
}

function loadWeightHistory(callback) {
    if (!window.db) {
        callback([]);
        return;
    }
    const tx = db.transaction(["weightHistory"], "readonly");
    const store = tx.objectStore("weightHistory");
    store.getAll().onsuccess = (e) => {
        const data = e.target.result || [];
        data.sort((a, b) => new Date(a.data) - new Date(b.data));
        callback(data);
    };
}

function calcolaPesoAutomatico() {
    return new Promise((resolve) => {
        loadWeightHistory((history) => {
            if (!window.userNeeds || history.length === 0) {
                resolve(null);
                return;
            }
            
            const pesoIniziale = history.find(h => h.isInitial)?.peso || history[0].peso;
            const dataInizio = history.find(h => h.isInitial)?.data || history[0].data;
            
            const oggi = new Date();
            const inizio = new Date(dataInizio);
            const giorniTotali = Math.floor((oggi - inizio) / (1000 * 60 * 60 * 24));
            
            let pesoCorrente = pesoIniziale;
            const pesoGiornaliero = [];
            
            for (let i = 0; i <= giorniTotali; i++) {
                const data = new Date(inizio);
                data.setDate(inizio.getDate() + i);
                const dataStr = data.toISOString().split('T')[0];
                
                const pasti = (dailyMeals && dailyMeals[dataStr]) || (window.dailyMeals && window.dailyMeals[dataStr]) || [];
                let kcalMangiate = 0;
                pasti.forEach(p => kcalMangiate += (p.kcal || 0));
                
                const kcalTarget = userNeeds.kcal || 2000;
                const differenza = kcalMangiate - kcalTarget;
                const variazionePeso = differenza / 7700;
                
                if (kcalMangiate === 0 && i > 0) {
                    pesoCorrente -= (kcalTarget * 0.3) / 7700;
                } else {
                    pesoCorrente += variazionePeso;
                }
                
                pesoCorrente = Math.max(pesoIniziale - 20, Math.min(pesoIniziale + 20, pesoCorrente));
                
                pesoGiornaliero.push({
                    data: dataStr,
                    peso: parseFloat(pesoCorrente.toFixed(2)),
                    kcalMangiate: kcalMangiate,
                    kcalTarget: kcalTarget,
                    differenza: differenza
                });
            }
            
            resolve(pesoGiornaliero);
        });
    });
}

function calcolaComposizioneCorporea(pesoAttuale) {
    if (!window.userNeeds) return null;
    
    const peso = pesoAttuale || userNeeds.peso;
    const altezza = userNeeds.altezza / 100;
    const eta = userNeeds.eta;
    const sesso = userNeeds.sesso === 'uomo' ? 1 : 0;
    
    const bmi = peso / (altezza * altezza);
    
    let percGrasso = (1.20 * bmi) + (0.23 * eta) - (10.8 * sesso) - 5.4;
    percGrasso = Math.max(5, Math.min(50, percGrasso));
    
    const massaGrassa = (peso * percGrasso / 100);
    const percMassaMagra = Math.round(((peso - massaGrassa) / peso) * 100);
    const percMassaGrassa = Math.round(percGrasso);
    const percLiquidiTot = 100 - percMassaMagra - percMassaGrassa;
    
    return {
        massaMagra: percMassaMagra,
        massaGrassa: percMassaGrassa,
        liquidi: Math.max(5, percLiquidiTot),
        bmi: bmi.toFixed(1)
    };
}

function calcolaNutrizioneOggi() {
    const today = getTodayKey();
    const meals = (dailyMeals && dailyMeals[today]) || (window.dailyMeals && window.dailyMeals[today]) || [];
    
    let totali = { 
        kcal: 0, prot: 0, carb: 0, fat: 0,
        vitC: 0, vitD: 0, vitB12: 0, vitA: 0, vitE: 0,
        magnesio: 0, zinco: 0, ferro: 0, calcio: 0, potassio: 0, sodio: 0, iodio: 0
    };
    
    meals.forEach(meal => {
        totali.kcal += meal.kcal || 0;
        totali.prot += meal.prot || 0;
        totali.carb += meal.carb || 0;
        totali.fat += meal.fat || 0;
        
        const stimaMicro = stimaMicronutrienti(meal);
        Object.keys(stimaMicro).forEach(k => {
            if (totali[k] !== undefined) totali[k] += stimaMicro[k];
        });
    });
    
    return totali;
}

function stimaMicronutrienti(meal) {
    const kcal = meal.kcal || 0;
    const prot = meal.prot || 0;
    const carb = meal.carb || 0;
    const fat = meal.fat || 0;
    
    const factorKcal = kcal / 500;
    const factorProt = prot / 30;
    const factorCarb = carb / 60;
    const factorFat = fat / 20;
    
    return {
        vitC: Math.round(25 * factorCarb),
        vitD: Math.round(3 * factorFat),
        vitB12: parseFloat((0.8 * factorProt).toFixed(1)),
        vitA: Math.round(200 * factorFat),
        vitE: Math.round(4 * factorFat),
        magnesio: Math.round(80 * factorKcal),
        zinco: Math.round(2.5 * factorProt),
        ferro: Math.round(3 * factorProt),
        calcio: Math.round(150 * factorKcal),
        potassio: Math.round(600 * factorCarb),
        sodio: Math.round(400 * factorKcal),
        iodio: Math.round(30 * factorKcal)
    };
}

function getTargetNutrizione() {
    if (!window.userNeeds) {
        return { kcal: 2000, prot: 150, carb: 200, fat: 70 };
    }
    return {
        kcal: userNeeds.kcal,
        prot: userNeeds.prot,
        carb: userNeeds.carb,
        fat: userNeeds.fat
    };
}

function getMacrosData() {
    const oggi = calcolaNutrizioneOggi();
    const target = getTargetNutrizione();
    
    return [
        { label: 'Proteine', val: Math.round(oggi.prot), goal: target.prot, color: '#2e7d32' },
        { label: 'Carboidrati', val: Math.round(oggi.carb), goal: target.carb, color: '#e65100' },
        { label: 'Grassi Sani', val: Math.round(oggi.fat * 0.7), goal: Math.round(target.fat * 0.7), color: '#0288d1' },
        { label: 'Zuccheri Semplici', val: Math.round(oggi.carb * 0.15), goal: Math.round(target.carb * 0.20), color: '#f43f5e' },
        { label: 'Zuccheri Composti', val: Math.round(oggi.carb * 0.85), goal: Math.round(target.carb * 0.80), color: '#f59e0b' },
        { label: 'Fibre', val: Math.round(oggi.carb * 0.12), goal: 35, color: '#064e3b' },
        { label: 'Grassi Saturi', val: Math.round(oggi.fat * 0.30), goal: Math.round(target.fat * 0.30), color: '#475569' },
        { label: 'Acqua', val: 1.5, goal: 3.0, color: '#38bdf8', unit: 'L' },
        { label: 'Omega-3', val: parseFloat((oggi.fat * 0.05).toFixed(1)), goal: 1.6, color: '#ec4899', unit: 'g' }
    ];
}

function getMicrosData() {
    const oggi = calcolaNutrizioneOggi();
    
    const targets = {
        vitC: 90, vitD: 20, vitB12: 2.4, vitA: 900, vitE: 15,
        magnesio: 400, zinco: 11, ferro: 18, calcio: 1000, potassio: 3500, sodio: 2300, iodio: 150
    };
    
    const calcPerc = (val, target) => Math.min(Math.round((val / target) * 100), 100);
    const getStatus = (perc) => perc >= 80 ? 'Ottimo' : perc >= 50 ? 'In Target' : 'Carente';
    
    return [
        { n: 'Vitamina C', v: `${Math.round(oggi.vitC)}mg`, p: calcPerc(oggi.vitC, targets.vitC), st: getStatus(calcPerc(oggi.vitC, targets.vitC)), color: '#10b981' },
        { n: 'Vitamina D', v: `${Math.round(oggi.vitD)}mcg`, p: calcPerc(oggi.vitD, targets.vitD), st: getStatus(calcPerc(oggi.vitD, targets.vitD)), color: '#f59e0b' },
        { n: 'Vitamina B12', v: `${oggi.vitB12.toFixed(1)}mcg`, p: calcPerc(oggi.vitB12, targets.vitB12), st: getStatus(calcPerc(oggi.vitB12, targets.vitB12)), color: '#8b5cf6' },
        { n: 'Vitamina A', v: `${Math.round(oggi.vitA)}mcg`, p: calcPerc(oggi.vitA, targets.vitA), st: getStatus(calcPerc(oggi.vitA, targets.vitA)), color: '#fb923c' },
        { n: 'Vitamina E', v: `${Math.round(oggi.vitE)}mg`, p: calcPerc(oggi.vitE, targets.vitE), st: getStatus(calcPerc(oggi.vitE, targets.vitE)), color: '#f472b6' },
        { n: 'Magnesio', v: `${Math.round(oggi.magnesio)}mg`, p: calcPerc(oggi.magnesio, targets.magnesio), st: getStatus(calcPerc(oggi.magnesio, targets.magnesio)), color: '#3b82f6' },
        { n: 'Zinco', v: `${Math.round(oggi.zinco)}mg`, p: calcPerc(oggi.zinco, targets.zinco), st: getStatus(calcPerc(oggi.zinco, targets.zinco)), color: '#f97316' },
        { n: 'Ferro', v: `${Math.round(oggi.ferro)}mg`, p: calcPerc(oggi.ferro, targets.ferro), st: getStatus(calcPerc(oggi.ferro, targets.ferro)), color: '#ef4444' },
        { n: 'Calcio', v: `${Math.round(oggi.calcio)}mg`, p: calcPerc(oggi.calcio, targets.calcio), st: getStatus(calcPerc(oggi.calcio, targets.calcio)), color: '#06b6d4' },
        { n: 'Potassio', v: `${(oggi.potassio/1000).toFixed(1)}g`, p: calcPerc(oggi.potassio, targets.potassio), st: getStatus(calcPerc(oggi.potassio, targets.potassio)), color: '#6366f1' },
        { n: 'Sodio', v: `${(oggi.sodio/1000).toFixed(1)}g`, p: oggi.sodio < targets.sodio ? 80 : 40, st: oggi.sodio < targets.sodio ? 'Controllato' : 'Alto', color: '#64748b' },
        { n: 'Iodio', v: `${Math.round(oggi.iodio)}mcg`, p: calcPerc(oggi.iodio, targets.iodio), st: getStatus(calcPerc(oggi.iodio, targets.iodio)), color: '#eab308' }
    ];
}

function getBodyCompData(pesoAttuale) {
    const comp = calcolaComposizioneCorporea(pesoAttuale);
    if (!comp) {
        return [
            { name: 'Massa Magra', value: 70, color: '#2e7d32' },
            { name: 'Massa Grassa', value: 20, color: '#e65100' },
            { name: 'Liquidi', value: 10, color: '#0288d1' }
        ];
    }
    return [
        { name: 'Massa Magra', value: comp.massaMagra, color: '#2e7d32' },
        { name: 'Massa Grassa', value: comp.massaGrassa, color: '#e65100' },
        { name: 'Liquidi', value: comp.liquidi, color: '#0288d1' }
    ];
}

function calcolaEfficienzaMetabolica() {
    const oggi = calcolaNutrizioneOggi();
    const target = getTargetNutrizione();
    
    const ratioCarb = target.carb > 0 ? oggi.carb / target.carb : 0;
    const ratioProt = target.prot > 0 ? oggi.prot / target.prot : 0;
    const ratioFat = target.fat > 0 ? oggi.fat / target.fat : 0;
    const ratioKcal = target.kcal > 0 ? oggi.kcal / target.kcal : 0;
    
    // Bilanciamento limitato a 120% per il calcolo
    const bilanciamento = ((Math.min(ratioCarb, 1.2) + Math.min(ratioProt, 1.2) + Math.min(ratioFat, 1.2)) / 3) * 100;
    
    // Digestione
    let digestione = "Bassa";
    let descrizioneDigestione = "";
    
    if (oggi.kcal === 0) {
        digestione = "---";
        descrizioneDigestione = "Nessun pasto registrato oggi.";
    } else if (ratioKcal > 1.3) {
        digestione = "Sovraccarico";
        descrizioneDigestione = "Stai mangiando troppo! Riduci le porzioni.";
    } else if (ratioKcal > 1.15) {
        digestione = "Elevata";
        descrizioneDigestione = "Leggermente sopra il target. Attenzione agli eccessi.";
    } else if (bilanciamento > 85) {
        digestione = "Ottimale";
        descrizioneDigestione = "Equilibrio perfetto! Continua cosÃ¬.";
    } else if (bilanciamento > 70) {
        digestione = "Alta";
        descrizioneDigestione = "Buon bilanciamento dei macronutrienti.";
    } else if (bilanciamento > 40) {
        digestione = "Media";
        descrizioneDigestione = "Cerca di bilanciare meglio i macro.";
    } else if (ratioKcal < 0.3 && oggi.kcal > 0) {
        digestione = "Insufficiente";
        descrizioneDigestione = "Stai mangiando troppo poco! Rischio rallentamento metabolico.";
    } else if (ratioKcal < 0.5) {
        digestione = "Bassa";
        descrizioneDigestione = "Apporto calorico insufficiente. Aumenta i pasti.";
    } else {
        digestione = "Bassa";
        descrizioneDigestione = "Migliora l'apporto di fibre e nutrienti.";
    }
    
// Recupero - PENALIZZA anche gli eccessi!
    const penaltyProt = ratioProt <= 1 ? ratioProt : Math.max(0, 2 - ratioProt);
    const penaltyCarb = ratioCarb <= 1 ? ratioCarb : Math.max(0, 2 - ratioCarb);
    const penaltyKcal = ratioKcal <= 1 ? 1 : Math.max(0, 2 - ratioKcal);
    
    let recuperoBase = Math.round((penaltyProt * 0.6 + penaltyCarb * 0.4) * 100);
    const recupero = Math.round(Math.max(0, Math.min(recuperoBase * penaltyKcal, 100)));
    
    let descrizioneRecupero = "";
    
    if (oggi.kcal === 0) {
        descrizioneRecupero = "Inserisci i pasti per calcolare.";
    } else if (ratioKcal > 1.5) {
        descrizioneRecupero = "âš ï¸ ECCESSO GRAVE! Metabolismo sotto stress, recupero compromesso.";
    } else if (ratioKcal > 1.2) {
        descrizioneRecupero = "âš ï¸ Troppe calorie! Il corpo fatica a gestire l'eccesso.";
    } else if (ratioProt > 1.3) {
        descrizioneRecupero = "Eccesso proteico! Reni sotto sforzo, riduci le proteine.";
    } else if (ratioCarb > 1.3) {
        descrizioneRecupero = "Eccesso carboidrati! Rischio accumulo grasso.";
    } else if (recupero > 90) {
        descrizioneRecupero = "Recupero eccellente! Sintesi muscolare ottimale.";
    } else if (recupero > 80) {
        descrizioneRecupero = "Resintesi glicogeno rapida.";
    } else if (recupero > 60) {
        descrizioneRecupero = "Recupero buono. Puoi migliorare con piÃ¹ proteine.";
    } else if (recupero > 40) {
        descrizioneRecupero = "Recupero nella media. Aumenta proteine e carbo.";
    } else if (ratioProt < 0.3) {
        descrizioneRecupero = "Proteine troppo basse! Rischio catabolismo.";
    } else {
        descrizioneRecupero = "Bilancia meglio i macro per recupero ottimale.";
    }
    
    return {
        digestione: digestione,
        recupero: recupero,
        descrizioneDigestione: descrizioneDigestione,
        descrizioneRecupero: descrizioneRecupero,
        ratioKcal: ratioKcal,
        ratioProt: ratioProt,
        ratioCarb: ratioCarb,
        ratioFat: ratioFat
    };
}

function updateEfficienzaMetabolica() {
    const eff = calcolaEfficienzaMetabolica();
    
    const digestioneEl = document.querySelector('.metabolic-value-dig');
    const recuperoEl = document.querySelector('.metabolic-value-rec');
    const descDigEl = document.querySelector('.metabolic-desc-dig');
    const descRecEl = document.querySelector('.metabolic-desc-rec');
    
    if (digestioneEl) digestioneEl.textContent = eff.digestione;
    if (recuperoEl) recuperoEl.textContent = `${eff.recupero}%`;
    if (descDigEl) descDigEl.textContent = eff.descrizioneDigestione;
    if (descRecEl) descRecEl.textContent = eff.descrizioneRecupero;
    
    // Aggiorna Metabolismo Basale
    const bmrEl = document.getElementById('metabolismoBasaleValue');
    const bmrDescEl = document.getElementById('metabolismoBasaleDesc');
    
    if (bmrEl && window.userNeeds && window.userNeeds.bmr) {
        const bmr = window.userNeeds.bmr;
        bmrEl.innerHTML = `${bmr.toLocaleString('it-IT')} <span>kcal</span>`;
        
        // Descrizione basata sul BMR
        let desc = "Il tuo corpo processa energia in modo eccellente.";
        if (bmr < 1400) {
            desc = "Metabolismo lento. Considera di aumentare l'attivitÃ  fisica.";
        } else if (bmr < 1600) {
            desc = "Metabolismo nella media. Buon equilibrio energetico.";
        } else if (bmr < 1900) {
            desc = "Metabolismo attivo. Ottima efficienza energetica.";
        } else {
            desc = "Metabolismo elevato. Il tuo corpo brucia molte calorie a riposo.";
        }
        
        if (bmrDescEl) bmrDescEl.textContent = desc;
    }
}
  
// Funzione per aggiornare tutti i dati Analisi Salute
function aggiornaAnalisiSalute() {
    // Aggiorna macro e micro se la sezione Ã¨ visibile
    if (typeof renderMacros === 'function') renderMacros();
    if (typeof renderMicros === 'function') renderMicros();
    if (typeof updateEfficienzaMetabolica === 'function') updateEfficienzaMetabolica();
    console.log('ðŸ“Š Analisi Salute aggiornata');
}
  
function toggleRiepilogoTooltip(event) {
    event.stopPropagation();
    const tooltip = document.getElementById('riepilogoTooltip');
    if (tooltip) tooltip.classList.toggle('show');
}

document.addEventListener('click', (e) => {
    if (!e.target.closest('#riepilogoInfoBtn') && !e.target.closest('#riepilogoTooltip')) {
        const tooltip = document.getElementById('riepilogoTooltip');
        if (tooltip) tooltip.classList.remove('show');
    }
});
  
// Hook nella tua toggleDarkMode esistente
// Sostituisci il contenuto della tua funzione toggleDarkMode con questo:
window.toggleDarkMode = function(){
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  const currentThemeEl = document.getElementById('currentTheme');
  if (currentThemeEl) currentThemeEl.textContent = isDark ? 'Tema Scuro' : 'Tema Chiaro';
  if (typeof toast === 'function') toast(isDark ? 'ðŸŒ™ Tema scuro' : 'â˜€ï¸ Tema chiaro');

  // switch immagini se presenti
  const lightImg = document.getElementById("lightImage");
  const darkImg = document.getElementById("darkImage");
  if (lightImg && darkImg) {
    lightImg.style.display = isDark ? "none" : "block";
    darkImg.style.display = isDark ? "block" : "none";
  }

  // salva preferenza tema
  savePrefsIndexed(isDark ? 'dark' : 'light');
};

// Estendi la tua loadAllData per caricare anche grocery/menu/prefs
// (Se giÃ  esiste loadAllData, aggiungi SOLO queste 3 righe in fondo)
if (typeof loadAllData === 'function') {
  const __oldLoadAllData = loadAllData;
  window.loadAllData = function(){
    __oldLoadAllData();
    loadGroceryIndexed();
    loadMenuIndexed();
    loadPrefsIndexed();
  }
}

// Salva automatico grocery/menu dove ha senso (aggiungi dove modifichi i dati)
window.__attachSavers = function(){
  // ESEMPI: chiama questi punti nel tuo codice dove giÃ  aggiorni i dati:

  // 1) dopo aver aggiunto/rimosso un item spesa:
  if (typeof addGroceryItem === 'function') {
    const _old = addGroceryItem;
    window.addGroceryItem = function(){ _old(); saveGroceryIndexed(); }
  }
  if (typeof removeGroceryItem === 'function') {
    const _old2 = removeGroceryItem;
    window.removeGroceryItem = function(i){ _old2(i); saveGroceryIndexed(); }
  }

  // 2) dopo aver aggiunto/rimosso un pasto nel menÃ¹:
  if (typeof addMeal === 'function') {
    const _old3 = addMeal;
    window.addMeal = function(){ _old3(); saveMenuIndexed(); }
  }
  if (typeof removeMeal === 'function') {
    const _old4 = removeMeal;
    window.removeMeal = function(i){ _old4(i); saveMenuIndexed(); }
  }
};

// Splash handling + first-run toast
window.addEventListener('load', () => {
  // attacca i saver una volta che le funzioni originali sono definite
  setTimeout(() => { 
    if (typeof __attachSavers === 'function') __attachSavers();
  }, 300);

  // chiudi splash quando i dati sono stati caricati (piccolo delay per sicurezza)
  setTimeout(() => {
    const splash = document.getElementById('app-splash');
    if (splash) {
      splash.classList.add('hidden-splash');
      setTimeout(() => splash.remove(), 350);
    }
    // toast "prima volta"
    try {
      if (!localStorage.getItem('__frigo_saw_loaded')) {
        if (typeof toast === 'function') toast('âœ… Dati caricati correttamente');
        localStorage.setItem('__frigo_saw_loaded', '1');
      }
    } catch(e){}
  }, 2000);
});

 // =============================
// IndexedDB - Gestione Dati App
// =============================
let db;
const richiesta = indexedDB.open("FrigoSmartDB", 5);

richiesta.onupgradeneeded = function(event) {
  db = event.target.result;
  if (!db.objectStoreNames.contains("ricette"))
    db.createObjectStore("ricette", { keyPath: "id", autoIncrement: true });
  if (!db.objectStoreNames.contains("fabbisogno"))
    db.createObjectStore("fabbisogno", { keyPath: "id" });
  if (!db.objectStoreNames.contains("impostazioni"))
    db.createObjectStore("impostazioni", { keyPath: "id" });

  if (!db.objectStoreNames.contains("grocery"))
    db.createObjectStore("grocery", { keyPath: "id" });
  if (!db.objectStoreNames.contains("menu"))
    db.createObjectStore("menu", { keyPath: "id" });
  if (!db.objectStoreNames.contains("prefs"))
    db.createObjectStore("prefs", { keyPath: "id" });
  if (!db.objectStoreNames.contains("weightHistory"))
    db.createObjectStore("weightHistory", { keyPath: "data" });

};

richiesta.onsuccess = function(event) {
  db = event.target.result;
  console.log("âœ… IndexedDB pronto");
  loadAllData(); // carica ricette, fabbisogno e impostazioni

};

richiesta.onerror = function(event) {
  console.error("âŒ Errore IndexedDB", event);
};

// Salva ricette
function saveRecipeIndexed() {
  if (!db || !window.recipes) return;
  const tx = db.transaction(["ricette"], "readwrite");
  const store = tx.objectStore("ricette");
  store.clear();
  recipes.forEach((r, i) => store.add({ id: i + 1, dati: r }));
  tx.oncomplete = () => console.log("âœ… Ricette salvate in IndexedDB");
}

// Salva fabbisogno
function saveFabbisognoIndexed() {
  if (!db || !window.userNeeds) return;
  const tx = db.transaction(["fabbisogno"], "readwrite");
  const store = tx.objectStore("fabbisogno");
  store.clear();
  store.add({ id: 1, dati: userNeeds });
  tx.oncomplete = () => console.log("âœ… Fabbisogno salvato in IndexedDB");
}

// Salva lista spesa
function saveGroceryIndexed() {
  if (!db) return;
  const tx = db.transaction(["grocery"], "readwrite");
  const store = tx.objectStore("grocery");
  store.clear();
  groceryList.forEach((item, i) => store.add({ id: i + 1, dati: item }));
  tx.oncomplete = () => console.log("âœ… Lista spesa salvata in IndexedDB");
}

// Salva menu giornaliero
function saveMenuIndexed() {
  if (!db) return;
  const tx = db.transaction(["menu"], "readwrite");
  const store = tx.objectStore("menu");
  store.clear();
  store.add({ id: 1, dati: dailyMeals });
  tx.oncomplete = () => console.log("âœ… Menu giornaliero salvato in IndexedDB");
}

// Salva frigo
function saveFridgeIndexed() {
  if (!db) return;
  const tx = db.transaction(["prefs"], "readwrite");
  const store = tx.objectStore("prefs");
  store.clear();
  store.add({ id: 1, dati: fridge });
  tx.oncomplete = () => console.log("âœ… Frigo salvato in IndexedDB");
}

// Salva impostazioni
function saveSettingsIndexed() {
  if (!db) return;
  const settings = {
    id: 1,
    temp: document.getElementById('temp').value,
    umid: document.getElementById('umid').value,
    tempMin: document.getElementById('tempMin').value,
    tempMax: document.getElementById('tempMax').value,
    umidMin: document.getElementById('umidMin').value,
    umidMax: document.getElementById('umidMax').value,
    modalita: document.getElementById('modalitaFrigo').value,
    zona: document.getElementById('zonaFrigo').value,
    notifScadenza: document.getElementById('notifScadenza').checked,
    notifTemp: document.getElementById('notifTemp').checked,
    notifPasti: document.getElementById('notifPasti').checked
  };
  const tx = db.transaction(["impostazioni"], "readwrite");
  const store = tx.objectStore("impostazioni");
  store.clear();
  store.put(settings);
  tx.oncomplete = () => console.log("âœ… Impostazioni salvate in IndexedDB");
}

// Carica impostazioni
function loadSettingsIndexed() {
  if (!db) return;
  const tx = db.transaction(["impostazioni"], "readonly");
  const store = tx.objectStore("impostazioni");
  const req = store.get(1);
  req.onsuccess = function() {
    if (req.result) {
      const s = req.result;
      document.getElementById('temp').value = s.temp;
      document.getElementById('umid').value = s.umid;
      document.getElementById('tempMin').value = s.tempMin;
      document.getElementById('tempMax').value = s.tempMax;
      document.getElementById('umidMin').value = s.umidMin;
      document.getElementById('umidMax').value = s.umidMax;
      document.getElementById('modalitaFrigo').value = s.modalita;
      document.getElementById('zonaFrigo').value = s.zona;
      document.getElementById('notifScadenza').checked = s.notifScadenza;
      document.getElementById('notifTemp').checked = s.notifTemp;
      document.getElementById('notifPasti').checked = s.notifPasti;
      console.log("âœ… Impostazioni caricate da IndexedDB");
    }
  };
}

// =============================
// Carica tutti i dati salvati all'avvio
// =============================
function loadAllData() {
  if (!db) return;

  // --- Ricette ---
  const txR = db.transaction(["ricette"], "readonly");
  const storeR = txR.objectStore("ricette");
  storeR.getAll().onsuccess = e => {
    const dati = e.target.result;
    if (dati && dati.length) {
      recipes = dati.map(r => r.dati);
      renderRecipes();
      console.log("ðŸ“š Ricette caricate da IndexedDB");
    }
  };

  // --- Fabbisogno ---
const txF = db.transaction(["fabbisogno"], "readonly");
const storeF = txF.objectStore("fabbisogno");
storeF.get(1).onsuccess = e => {
  if (e.target.result) {
    userNeeds = e.target.result.dati;
    
// Ripristina i valori nei campi input
    if (userNeeds.sesso) document.getElementById('sesso').value = userNeeds.sesso;
    if (userNeeds.eta) document.getElementById('eta').value = userNeeds.eta;
    if (userNeeds.peso) document.getElementById('pesoF').value = userNeeds.peso;
    if (userNeeds.altezza) document.getElementById('altezza').value = userNeeds.altezza;
    if (userNeeds.attivita) document.getElementById('attivita').value = userNeeds.attivita;
    if (userNeeds.obiettivo) document.getElementById('obiettivo').value = userNeeds.obiettivo;

    // Mostra i risultati nella sezione calcolo
    const out = document.getElementById('risultatoFabbisogno');
    if (out && userNeeds) {
      out.innerHTML = `
        <strong>ðŸ“Š Risultato:</strong><br>
        <div style="margin-top:8px">
          ðŸ”¥ BMR: <strong>${userNeeds.kcal} kcal</strong><br>
          âš¡ Fabbisogno: <strong>${userNeeds.kcal} kcal</strong>
        </div>
        <div style="margin-top:12px">
          <strong>ðŸ½ï¸ Macro consigliati:</strong><br>
          ðŸ’ª Proteine: <strong>${userNeeds.prot} g</strong><br>
          ðŸž Carboidrati: <strong>${userNeeds.carb} g</strong><br>
          ðŸ§ˆ Grassi: <strong>${userNeeds.fat} g</strong>
        </div>
      `;
      
      // Ripristina tipo di dieta se salvato
      if (userNeeds.tipoDieta) {
        const selectDieta = document.getElementById('tipoDieta');
        if (selectDieta) {
          selectDieta.value = userNeeds.tipoDieta;
          mostraDietaInfo();
        }
      }
      
      // Ripristina calorie orologio se salvate
      if (userNeeds.calorieOrologio) {
        const inputOrologio = document.getElementById('calorieOrologio');
        if (inputOrologio) {
          inputOrologio.value = userNeeds.calorieOrologio;
          document.getElementById('confrontoCalorie').style.display = 'block';
          calcolaConfrontoCalorie();
        }
      }
    }
    
    updateDailyTracking();
    console.log("ðŸ“š Fabbisogno caricato da IndexedDB");
  }
};

  // --- Impostazioni ---
  const txS = db.transaction(["impostazioni"], "readonly");
  const storeS = txS.objectStore("impostazioni");
  storeS.get(1).onsuccess = e => {
    if (e.target.result) {
      const s = e.target.result;
      document.getElementById('temp').value = s.temp;
      document.getElementById('umid').value = s.umid;
      document.getElementById('tempMin').value = s.tempMin;
      document.getElementById('tempMax').value = s.tempMax;
      document.getElementById('umidMin').value = s.umidMin;
      document.getElementById('umidMax').value = s.umidMax;
      document.getElementById('modalitaFrigo').value = s.modalita;
      document.getElementById('zonaFrigo').value = s.zona;
      document.getElementById('notifScadenza').checked = s.notifScadenza;
      document.getElementById('notifTemp').checked = s.notifTemp;
      document.getElementById('notifPasti').checked = s.notifPasti;
      console.log("ðŸ“š Impostazioni caricate da IndexedDB");
    }
  };

  // --- Lista Spesa ---
  const txG = db.transaction(["grocery"], "readonly");
  const storeG = txG.objectStore("grocery");
  storeG.getAll().onsuccess = e => {
    const dati = e.target.result;
    if (dati && dati.length) {
      groceryList = dati.map(g => g.dati);
      renderGrocery();
      console.log("ðŸ“š Lista spesa caricata da IndexedDB");
    }
  };

  // --- Menu Giornaliero ---
  const txM = db.transaction(["menu"], "readonly");
  const storeM = txM.objectStore("menu");
  storeM.get(1).onsuccess = e => {
    if (e.target.result) {
      dailyMeals = e.target.result.dati;
      updateDailyTracking();
      console.log("ðŸ“š Menu giornaliero caricato da IndexedDB");
    }
  };

  // --- Frigo ---
  const txP = db.transaction(["prefs"], "readonly");
  const storeP = txP.objectStore("prefs");
  storeP.get(1).onsuccess = e => {
    if (e.target.result) {
      fridge = e.target.result.dati;
      refreshList();
      updateExpiringFoods();
      console.log("ðŸ“š Frigo caricato da IndexedDB");
    }
  };
}

const robot = document.getElementById('aiRobot');

let robotTimeout;

let lastAssistantText = '';

 

function showRobot() {

  robot.classList.add('visible');

  robot.classList.add('talking');

}

 

function hideRobot() {

  robot.classList.remove('talking');

  clearTimeout(robotTimeout);

  robotTimeout = setTimeout(() => {

    robot.classList.remove('visible');

  }, 3000);

}

 

function toggleAutoSpeak() {
  autoSpeak = !autoSpeak;
  window.audioEnabled = autoSpeak; // ðŸ‘ˆ AGGIUNGI QUESTA RIGA
  
  const btn = document.getElementById('autoSpeakBtn');
  btn.textContent = autoSpeak ? 'ðŸ”Š Voce Auto ON' : 'ðŸ”‡ Voce Auto OFF';
  btn.classList.toggle('btn-primary');
  btn.classList.toggle('btn-ghost');
  
  // Salva preferenza
  localStorage.setItem('autoSpeak', autoSpeak);
  
  toast(autoSpeak ? 'ðŸ”Š Voce automatica ON' : 'ðŸ”‡ Voce automatica OFF');
}

 

function toggleMute() {
  isMuted = !isMuted;
  
  const btn = document.getElementById('muteBtn');
  btn.textContent = isMuted ? 'ðŸ”‡ Audio OFF' : 'ðŸ”Š Audio ON';
  btn.classList.toggle('btn-primary');
  btn.classList.toggle('btn-ghost');
  
  if (isMuted) {
    window.speechSynthesis.cancel();
  }
  
  // Salva preferenza
  localStorage.setItem('isMuted', isMuted);
  
  toast(isMuted ? 'ðŸ”‡ Audio disattivato' : 'ðŸ”Š Audio attivato');
}
 

function openRecipeModal(index) {

  const recipe = recipes[index];

  currentRecipeDetails = recipe;

 

  const modal = document.getElementById('recipeModal');

  const modalTitle = document.getElementById('modalTitle');

  const modalBody = document.getElementById('modalBody');

 

  modalTitle.textContent = recipe.nome;

 

  modalBody.innerHTML = `

    <div style="margin-bottom:15px">

      <h3 style="margin-bottom:8px">ðŸ¥˜ Ingredienti</h3>

      <div class="card" style="padding:12px">

        ${recipe.ingredienti.map(ing => `<div class="tiny">â€¢ ${ing}</div>`).join('')}

      </div>

    </div>

   

    <div style="margin-bottom:15px">

      <h3 style="margin-bottom:8px">ðŸ“Š Valori Nutrizionali</h3>

      <div class="card" style="padding:12px">

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">

          <div class="macro-card">

            <div style="font-size:20px;font-weight:700">ðŸ”¥ ${recipe.kcal}</div>

            <div class="tiny">kcal</div>

          </div>

          <div class="macro-card">

            <div style="font-size:20px;font-weight:700">ðŸ’ª ${recipe.prot}g</div>

            <div class="tiny">Proteine</div>

          </div>

          <div class="macro-card">

            <div style="font-size:20px;font-weight:700">ðŸž ${recipe.carb}g</div>

            <div class="tiny">Carboidrati</div>

          </div>

          <div class="macro-card">

            <div style="font-size:20px;font-weight:700">ðŸ§ˆ ${recipe.fat}g</div>

            <div class="tiny">Grassi</div>

          </div>

        </div>

      </div>

    </div>

   

    <div>

      <h3 style="margin-bottom:8px">ðŸŒ± Tipo</h3>

      <div class="chip" style="display:inline-block">

        ${recipe.veg ? 'ðŸŒ± Vegetariano' : 'ðŸ– Non Vegetariano'}

      </div>

    </div>

  `;

 

  modal.classList.add('active');

 

  if(autoSpeak && !isMuted) {

    setTimeout(() => speakRecipeDetails(), 500);

  }

}

 

function closeRecipeModal() {

  document.getElementById('recipeModal').classList.remove('active');

  window.speechSynthesis.cancel();

}

 

function speakRecipeDetails() {

  if(isMuted || !currentRecipeDetails) return;

 

  const recipe = currentRecipeDetails;

  const text = `${recipe.nome}. Ingredienti: ${recipe.ingredienti.join(', ')}. Valori: ${recipe.kcal} kcal, ${recipe.prot}g proteine, ${recipe.carb}g carboidrati, ${recipe.fat}g grassi.`;

 

  showRobot();

  const utterance = new SpeechSynthesisUtterance(text);

  utterance.lang = 'it-IT';

  utterance.rate = 0.9;

  utterance.onend = () => hideRobot();

  window.speechSynthesis.cancel();

  window.speechSynthesis.speak(utterance);

}

 

function show(id){
  document.querySelectorAll('section').forEach(s => {
    s.classList.remove('active');
    s.style.display = 'none';
  });
  
  const el = document.getElementById(id);
  if(el) {
    el.classList.add('active');
    if(id === 'assistente') {
      el.style.display = 'flex';
    } else {
      el.style.display = 'block';
    }
    
    // Scroll to top quando si apre una sezione
    window.scrollTo(0, 0);
    el.scrollTop = 0;
  }
  
  if(id==='lista') refreshList();
  if(id==='ricette') renderRecipes();
  if(id==='menu') renderMenu();
  if(id==='spesa') renderGrocery();
  if(id==='fabbisogno') {
    updateRecipeSelector();
    updateDailyTracking();
    // ðŸ†• ANIMAZIONI DONUT E MACRO BARS
    setTimeout(() => {
      if(typeof updateDonutChart === 'function') updateDonutChart();
      if(typeof animateMacroBars === 'function') animateMacroBars();
    }, 100);
  }
  if(id==='assistente') {
    if(typeof resetFrostyChat === 'function') resetFrostyChat();
  }
}

function addItem(){
  const name=document.getElementById('nome').value.trim();
  const peso=document.getElementById('peso').value;
  const scad=document.getElementById('scadenza').value;
  const cat=document.getElementById('categoria').value;
  if(!name || !peso || !scad){ alert('Compila tutti i campi'); return; }
  fridge.push({nome:name,peso:parseFloat(peso),scadenza:scad,categoria:cat});
  saveFridgeIndexed(); // â¬…ï¸ AGGIUNTO
  clearItemForm(); refreshList(); toast(`âœ… ${name} aggiunto`);
  updateExpiringFoods();
}
 

function clearItemForm(){

  document.getElementById('nome').value='';

  document.getElementById('peso').value='';

  document.getElementById('scadenza').value='';

}

function refreshList(){

  const ul=document.getElementById('listaAlimenti'); ul.innerHTML='';

  const q=(document.getElementById('cerca').value||'').toLowerCase();

  const filtro=document.getElementById('filtro').value;

  const ord=document.getElementById('ordina').value;

  const today=new Date();

  let list=fridge.filter(i=>i.nome.toLowerCase().includes(q));

  if(filtro==='scadenza') list=list.filter(i=>{const d=new Date(i.scadenza); const diff=(d-today)/(1000*60*60*24); return diff>=0 && diff<=3;});

  if(filtro==='scaduti') list=list.filter(i=>new Date(i.scadenza) < today);

  list.sort((a,b)=>{

    if(ord==='nome') return a.nome.localeCompare(b.nome);

    if(ord==='scadenza') return new Date(a.scadenza)-new Date(b.scadenza);

    if(ord==='peso') return a.peso - b.peso;

    return 0;

  });

  list.forEach((it,idx)=>{

    const li=document.createElement('li'); li.className='item';

    li.innerHTML = `<div>

      <strong>${it.nome}</strong><div class="tiny">${it.peso} g â€¢ ${it.scadenza} â€¢ ${it.categoria}</div>

    </div>

    <div style="display:flex;gap:6px">

      <button onclick="removeItem(${fridge.indexOf(it)})" class="btn-ghost">ðŸ—‘ï¸</button>

    </div>`;

    ul.appendChild(li);

  });

  document.getElementById('contatore').innerText = `ðŸ“¦ Totale: ${fridge.length}`;

  checkExpiry(); updateStats();

}

function removeItem(idx){
  if(!confirm('Eliminare?')) return;
  fridge.splice(idx,1);
  saveFridgeIndexed(); // â¬…ï¸ AGGIUNTO
  refreshList(); toast('ðŸ—‘ï¸ Eliminato');
  updateExpiringFoods();
}
 
function importDemo(){

  fridge = [

    {nome:"Latte",peso:1000,scadenza:nextDays(5),categoria:"Latticini"},

    {nome:"Uova",peso:600,scadenza:nextDays(8),categoria:"Generale"},

    {nome:"Pomodoro",peso:400,scadenza:nextDays(3),categoria:"Verdura"},

    {nome:"Spinaci",peso:150,scadenza:nextDays(4),categoria:"Verdura"},

    {nome:"Pane",peso:500,scadenza:nextDays(2),categoria:"Generale"}

  ];

  refreshList(); toast('ðŸ“¥ Demo caricato');

}

 

function nextDays(n){ const d=new Date(); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }

 

function updateStats(){

  const stats = {};

  let totalW = 0;

  let expiringSoon = 0;

  let expired = 0;

  const today = new Date();

 

  fridge.forEach(i=>{

    stats[i.categoria]=(stats[i.categoria]||0)+1;

    totalW += (parseFloat(i.peso)||0);

   

    const d = new Date(i.scadenza);

    const diff = (d - today)/(1000*60*60*24);

    if(diff < 0) expired++;

    else if(diff <= 3) expiringSoon++;

  });

 

  let out = Object.keys(stats).map(k=>`${k}: ${stats[k]}`).join(' â€¢ ');

  out += `<br>Peso totale: ${Math.round(totalW)} g`;

  const el = document.getElementById('statistiche');

  if(el) el.innerHTML = out;

 

  // Statistiche dettagliate

  const detEl = document.getElementById('statisticheDettagliate');

  if(detEl) {

    detEl.innerHTML = `

      <div class="tiny">ðŸ“¦ Totale alimenti: <strong>${fridge.length}</strong></div>

      <div class="tiny">âš–ï¸ Peso medio per alimento: <strong>${fridge.length > 0 ? Math.round(totalW / fridge.length) : 0} g</strong></div>

      <div class="tiny">âš ï¸ In scadenza (â‰¤3 giorni): <strong>${expiringSoon}</strong></div>

      <div class="tiny">âŒ Scaduti: <strong>${expired}</strong></div>

      <div class="tiny">âœ… Alimenti freschi: <strong>${fridge.length - expiringSoon - expired}</strong></div>

      <div class="tiny">ðŸ“Š Categorie diverse: <strong>${Object.keys(stats).length}</strong></div>

      ${fridge.length > 0 ? `<div class="tiny">ðŸ† Categoria piÃ¹ presente: <strong>${Object.entries(stats).sort((a,b)=>b[1]-a[1])[0][0]}</strong></div>` : ''}

    `;

  }

}

 

function renderRecipes() {
  const container = document.getElementById('listaRicette');
  container.innerHTML = '';
  
  if (recipes.length === 0) {
    container.innerHTML = '<div class="tiny" style="text-align:center;padding:20px;color:var(--muted)">ðŸ“– Nessuna ricetta salvata</div>';
    return;
  }
  
  recipes.forEach((r, idx) => {
    const div = document.createElement('div');
    div.className = 'recipe-card';
    div.setAttribute('data-recipe-index', idx);
    
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:start;gap:12px">
        <div style="flex:1">
          <strong style="font-size:16px">${r.nome}</strong> 
          <span class="tiny">${r.veg ? 'ðŸŒ± Veg' : 'ðŸ–'}</span>
          <div class="tiny" style="margin-top:4px;color:var(--muted)">
            ${r.ingredienti && r.ingredienti.length > 0 ? r.ingredienti.slice(0, 3).join(', ') + (r.ingredienti.length > 3 ? '...' : '') : 'Nessun ingrediente'}
          </div>
        </div>
        <div style="text-align:right">
          <div class="chip">${r.kcal || 0} kcal</div>
          <div class="tiny" style="margin-top:4px">
            ${r.prot || 0}g P â€¢ ${r.carb || 0}g C â€¢ ${r.fat || 0}g F
          </div>
        </div>
      </div>
      
      <div style="display:flex;gap:6px;margin-top:12px;flex-wrap:wrap">
        <button class="btn-primary" onclick="openRecipeModal(${idx})" style="flex:1;min-width:100px">
          ðŸ“– Dettagli
        </button>
        <button class="btn-ghost" onclick="useRecipe(${idx})" style="flex:1;min-width:100px">
          ðŸ” Usa
        </button>
        <button class="btn-ghost" onclick="editRecipe(${idx})">
          âœï¸
        </button>
        <button class="btn-ghost" onclick="deleteRecipe(${idx})">
          ðŸ—‘ï¸
        </button>
      </div>
    `;
    
    container.appendChild(div);
  });
}

function saveRecipe(){
  const name = document.getElementById('rNome').value.trim();
  const veg = document.getElementById('rVeg').value === 'true';
  const ings = (document.getElementById('rIngredienti').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const kcal = parseFloat(document.getElementById('rKcal').value) || 0;
  const prot = parseFloat(document.getElementById('rProt').value) || 0;
  const carb = parseFloat(document.getElementById('rCarb').value) || 0;
  const fat = parseFloat(document.getElementById('rFat').value) || 0;
  if(!name || !ings.length){ alert('Nome e ingredienti richiesti'); return; }
  recipes.unshift({nome:name, veg:veg, ingredienti:ings, kcal:kcal, prot:prot, carb:carb, fat:fat});
  saveRecipeIndexed(); // â¬…ï¸ AGGIUNTO
  clearRecipeForm(); renderRecipes(); toast('ðŸ’¾ Ricetta salvata');
}
 
function useRecipe(i){

  const r = recipes[i];

  const have = fridge.map(x=>x.nome.toLowerCase());

  const present = r.ingredienti.filter(ing => have.some(h => h.includes(ing.toLowerCase())));

  const missing = r.ingredienti.filter(ing => !have.some(h => h.includes(ing.toLowerCase())));

 

  let msg = `ðŸ³ Per ${r.nome}:\n`;

  if(present.length > 0) msg += `âœ… Hai: ${present.join(', ')}\n`;

  if(missing.length > 0) msg += `âŒ Mancano: ${missing.join(', ')}`;

  else msg += `ðŸŽ‰ Hai tutti gli ingredienti!`;

 

  addChat('Assistente', msg);

}

 

function editRecipe(i){

  const r = recipes[i];

  document.getElementById('rNome').value = r.nome;

  document.getElementById('rVeg').value = r.veg ? 'true' : 'false';

  document.getElementById('rIngredienti').value = r.ingredienti.join(', ');

  document.getElementById('rKcal').value = r.kcal;

  document.getElementById('rProt').value = r.prot;

  document.getElementById('rCarb').value = r.carb;

  document.getElementById('rFat').value = r.fat;

  recipes.splice(i,1);

  renderRecipes();

  show('aggiungiRicetta');

  toast('âœï¸ Modifica la ricetta e salva');

}

 

function clearRecipeForm(){

  ['rNome','rIngredienti','rKcal','rProt','rCarb','rFat'].forEach(id=>document.getElementById(id).value='');

}

function deleteRecipe(i){
  if(!confirm('Eliminare ricetta?')) return;
  recipes.splice(i,1);
  saveRecipeIndexed(); // â¬…ï¸ AGGIUNTO
  renderRecipes(); toast('ðŸ—‘ï¸ Eliminata');
}
 
function addChat(who,text){

  const box=document.getElementById('chat');

  const p=document.createElement('p');

  p.innerHTML = `<strong>${who}:</strong> ${text}`;

  box.appendChild(p); box.scrollTop = box.scrollHeight;

  lastAssistantText = text;

  if(who === 'Assistente') {

    showRobot();

    if(autoSpeak && !isMuted) {

      setTimeout(() => {

        const utterance = new SpeechSynthesisUtterance(text);

        utterance.lang = 'it-IT';

        utterance.rate = 0.9;

        utterance.onend = () => hideRobot();

        window.speechSynthesis.cancel();

        window.speechSynthesis.speak(utterance);

      }, 300);

    }

  }

}


function speakLast() {
  // Se c'Ã¨ un ultimo messaggio salvato, leggilo
  if (lastAssistantMessage) {
    speak(lastAssistantMessage);
    if (typeof toast === 'function') toast('ðŸ”Š Lettura ultima risposta...');
    return;
  }
  
  // Altrimenti cerca nell'HTML del chat
  const chatDiv = document.getElementById('chat');
  if (!chatDiv) {
    if (typeof toast === 'function') toast('âš ï¸ Nessuna chat trovata');
    return;
  }
  
  // Cerca l'ultimo messaggio dell'assistente
  const messages = chatDiv.querySelectorAll('.chat-message.assistant, div[style*="Frigo Smart AI"]');
  
  if (messages.length === 0) {
    if (typeof toast === 'function') toast('âš ï¸ Nessuna risposta da leggere');
    return;
  }
  
  // Prendi l'ultimo messaggio
  const lastMessage = messages[messages.length - 1];
  let text = lastMessage.innerText || lastMessage.textContent || '';
  
  // Rimuovi il prefisso "Frigo Smart AI:"
  text = text.replace(/^(Frigo Smart AI:|ðŸ¤– Assistente:)\s*/i, '').trim();
  
  if (text.length === 0) {
    if (typeof toast === 'function') toast('âš ï¸ Nessun testo da leggere');
    return;
  }
  
  speak(text);
  if (typeof toast === 'function') toast('ðŸ”Š Lettura ultima risposta...');
}
// Funzione principale per sintesi vocale
function speak(text) {
  // PRIMO: Controlla se l'audio Ã¨ completamente disattivato
  if (isMuted) {
    console.log('ðŸ”‡ Audio disattivato (mute)');
    return;
  }
  
  if (!text || text.trim().length === 0) {
    console.log('âš ï¸ Nessun testo da pronunciare');
    return;
  }
  
  // Pulisci il testo da emoji e caratteri speciali
  const cleanText = text
    .replace(/[ðŸ¤–ðŸ”ŠðŸ’¬ðŸ“¤ðŸŽ¤â„ï¸âœ…âŒâš ï¸ðŸ•ðŸðŸ¥—ðŸ”ðŸ¥©ðŸŒ®ðŸ±ðŸ¥™ðŸ²ðŸ¥˜ðŸ›ðŸœðŸ£ðŸ¤ðŸ³ðŸ§ ðŸ“ŠðŸ”‡]/g, '')
    .replace(/\*\*/g, '')
    .replace(/#{1,6}\s/g, '')
    .replace(/<[^>]*>/g, '')
    .replace(/\s+/g, ' ')
    .trim();
  
  if (cleanText.length === 0) {
    console.log('âš ï¸ Testo vuoto dopo pulizia');
    return;
  }
  
  // Mostra il robot animato
  if (typeof showRobot === 'function') {
    showRobot();
  }
  
  // Cancella eventuali speech in corso
  window.speechSynthesis.cancel();
  
  // Crea utterance
  const utterance = new SpeechSynthesisUtterance(cleanText);
  utterance.lang = 'it-IT';
  utterance.rate = 0.95;
  utterance.pitch = 1.0;
  utterance.volume = 1.0;
  
  // Quando finisce di parlare
  utterance.onend = () => {
    console.log('âœ… Sintesi vocale completata');
    if (typeof hideRobot === 'function') {
      hideRobot();
    }
  };
  
  utterance.onerror = (error) => {
    console.error('âŒ Errore sintesi vocale:', error);
    if (typeof hideRobot === 'function') {
      hideRobot();
    }
  };
  
  // Pronuncia
  window.speechSynthesis.speak(utterance);
  
  console.log('ðŸ”Š Pronunciando:', cleanText.substring(0, 60) + (cleanText.length > 60 ? '...' : ''));
} 

function renderMenu(){
  const container = document.getElementById('menuSettimana');
  container.innerHTML='';

  const days = ["LunedÃ¬","MartedÃ¬","MercoledÃ¬","GiovedÃ¬","VenerdÃ¬","Sabato","Domenica"];
  const dayEmojis = ["ðŸŒ™","âœ¨","ðŸŒŸ","â­","ðŸ’«","ðŸŽ‰","â˜€ï¸"];

  const targetKcal = userNeeds ? userNeeds.kcal : 2000;

  if(userNeeds){
    const nomeDieta = {
      bilanciata: 'Bilanciata Standard',
      chetogenica: 'Chetogenica',
      lowcarb: 'Low Carb',
      definizione: 'Definizione',
      ipertrofica: 'Ipertrofica',
      lowfat: 'Low Fat',
      zona: 'Zona (40-30-30)',
      mediterranea: 'Mediterranea'
    };
    const dietaSelezionata = userNeeds.tipoDieta || 'bilanciata';
    document.getElementById('menuInfo').innerHTML = `
      ðŸŽ¯ Piano basato su ${targetKcal} kcal/giorno<br>
      ðŸ¥— Dieta: ${nomeDieta[dietaSelezionata]}
    `;
  }

  // Se non c'Ã¨ mealPlan, non mostrare nulla
  if(!mealPlan || mealPlan.length === 0) {
    container.innerHTML = '<div style="padding:20px;text-align:center;color:#666">Clicca su "Genera MenÃ¹" per creare il tuo piano settimanale personalizzato ðŸ½ï¸</div>';
    return;
  }

  days.forEach((d, idx)=>{
    const dayDiv = document.createElement('div');
    dayDiv.className = 'day-menu';
   
    let dayHtml = `<div class="day-header">${dayEmojis[idx]} ${d} <span class="tiny">Target: ${targetKcal} kcal</span></div>`;
   
    let totalDayKcal = 0;
    let totalDayProt = 0;
    let totalDayCarb = 0;
    let totalDayFat = 0;

    const dayPlan = mealPlan[idx];
    
    // Colazione
    if(dayPlan.colazione) {
      const colazione = dayPlan.colazione;
      totalDayKcal += colazione.recipe.kcal * colazione.portions;
      totalDayProt += colazione.recipe.prot * colazione.portions;
      totalDayCarb += colazione.recipe.carb * colazione.portions;
      totalDayFat += colazione.recipe.fat * colazione.portions;
      dayHtml += `
        <div class="meal-item">
          <strong>ðŸŒ… Colazione</strong> <span class="tiny">(${Math.round(colazione.recipe.kcal * colazione.portions)} kcal)</span>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px">
            <span>${colazione.recipe.nome} ${colazione.portions !== 1 ? `(${colazione.portions}x)` : ''}</span>
            <button class="btn-ghost" style="padding:4px 8px" onclick="openRecipeModal(${recipes.indexOf(colazione.recipe)})">ðŸ“–</button>
          </div>
          <div class="tiny">ðŸ”¥ ${Math.round(colazione.recipe.kcal * colazione.portions)} kcal â€¢ ðŸ’ª ${Math.round(colazione.recipe.prot * colazione.portions)}g P â€¢ ðŸž ${Math.round(colazione.recipe.carb * colazione.portions)}g C â€¢ ðŸ§ˆ ${Math.round(colazione.recipe.fat * colazione.portions)}g F</div>
        </div>
      `;
    }
   
    // Spuntino
    if(dayPlan.spuntino) {
      const spuntino = dayPlan.spuntino;
      totalDayKcal += spuntino.recipe.kcal * spuntino.portions;
      totalDayProt += spuntino.recipe.prot * spuntino.portions;
      totalDayCarb += spuntino.recipe.carb * spuntino.portions;
      totalDayFat += spuntino.recipe.fat * spuntino.portions;
      dayHtml += `
        <div class="meal-item">
          <strong>ðŸŽ Spuntino</strong> <span class="tiny">(${Math.round(spuntino.recipe.kcal * spuntino.portions)} kcal)</span>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px">
            <span>${spuntino.recipe.nome} ${spuntino.portions !== 1 ? `(${spuntino.portions}x)` : ''}</span>
            <button class="btn-ghost" style="padding:4px 8px" onclick="openRecipeModal(${recipes.indexOf(spuntino.recipe)})">ðŸ“–</button>
          </div>
          <div class="tiny">ðŸ”¥ ${Math.round(spuntino.recipe.kcal * spuntino.portions)} kcal</div>
        </div>
      `;
    }
   
    // Pranzo
    if(dayPlan.pranzo) {
      const pranzo = dayPlan.pranzo;
      totalDayKcal += pranzo.recipe.kcal * pranzo.portions;
      totalDayProt += pranzo.recipe.prot * pranzo.portions;
      totalDayCarb += pranzo.recipe.carb * pranzo.portions;
      totalDayFat += pranzo.recipe.fat * pranzo.portions;
      dayHtml += `
        <div class="meal-item">
          <strong>ðŸ½ï¸ Pranzo</strong> <span class="tiny">(${Math.round(pranzo.recipe.kcal * pranzo.portions)} kcal)</span>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px">
            <span>${pranzo.recipe.nome} ${pranzo.portions !== 1 ? `(${pranzo.portions}x)` : ''}</span>
            <button class="btn-ghost" style="padding:4px 8px" onclick="openRecipeModal(${recipes.indexOf(pranzo.recipe)})">ðŸ“–</button>
          </div>
          <div class="tiny">ðŸ”¥ ${Math.round(pranzo.recipe.kcal * pranzo.portions)} kcal â€¢ ðŸ’ª ${Math.round(pranzo.recipe.prot * pranzo.portions)}g P â€¢ ðŸž ${Math.round(pranzo.recipe.carb * pranzo.portions)}g C â€¢ ðŸ§ˆ ${Math.round(pranzo.recipe.fat * pranzo.portions)}g F</div>
        </div>
      `;
    }
   
    // Merenda
    if(dayPlan.merenda) {
      const merenda = dayPlan.merenda;
      totalDayKcal += merenda.recipe.kcal * merenda.portions;
      totalDayProt += merenda.recipe.prot * merenda.portions;
      totalDayCarb += merenda.recipe.carb * merenda.portions;
      totalDayFat += merenda.recipe.fat * merenda.portions;
      dayHtml += `
        <div class="meal-item">
          <strong>ðŸ¥¤ Merenda</strong> <span class="tiny">(${Math.round(merenda.recipe.kcal * merenda.portions)} kcal)</span>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px">
            <span>${merenda.recipe.nome} ${merenda.portions !== 1 ? `(${merenda.portions}x)` : ''}</span>
            <button class="btn-ghost" style="padding:4px 8px" onclick="openRecipeModal(${recipes.indexOf(merenda.recipe)})">ðŸ“–</button>
          </div>
          <div class="tiny">ðŸ”¥ ${Math.round(merenda.recipe.kcal * merenda.portions)} kcal</div>
        </div>
      `;
    }
   
    // Cena
    if(dayPlan.cena) {
      const cena = dayPlan.cena;
      totalDayKcal += cena.recipe.kcal * cena.portions;
      totalDayProt += cena.recipe.prot * cena.portions;
      totalDayCarb += cena.recipe.carb * cena.portions;
      totalDayFat += cena.recipe.fat * cena.portions;
      dayHtml += `
        <div class="meal-item">
          <strong>ðŸŒ† Cena</strong> <span class="tiny">(${Math.round(cena.recipe.kcal * cena.portions)} kcal)</span>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px">
            <span>${cena.recipe.nome} ${cena.portions !== 1 ? `(${cena.portions}x)` : ''}</span>
            <button class="btn-ghost" style="padding:4px 8px" onclick="openRecipeModal(${recipes.indexOf(cena.recipe)})">ðŸ“–</button>
          </div>
          <div class="tiny">ðŸ”¥ ${Math.round(cena.recipe.kcal * cena.portions)} kcal â€¢ ðŸ’ª ${Math.round(cena.recipe.prot * cena.portions)}g P â€¢ ðŸž ${Math.round(cena.recipe.carb * cena.portions)}g C â€¢ ðŸ§ˆ ${Math.round(cena.recipe.fat * cena.portions)}g F</div>
        </div>
      `;
    }
   
    // Totale giornata
    const deviation = Math.abs(totalDayKcal - targetKcal);
    const isGood = deviation <= targetKcal * 0.1;
    dayHtml += `
      <div style="margin-top:10px;padding:8px;background:${isGood ? 'rgba(22,163,74,0.1)' : 'rgba(239,68,68,0.1)'};border-radius:8px">
        <strong>${isGood ? 'âœ…' : 'âš ï¸'} Totale giornata:</strong>
        <div class="tiny">ðŸ”¥ ${Math.round(totalDayKcal)} kcal â€¢ ðŸ’ª ${Math.round(totalDayProt)}g P â€¢ ðŸž ${Math.round(totalDayCarb)}g C â€¢ ðŸ§ˆ ${Math.round(totalDayFat)}g F</div>
      </div>
    `;
   
    dayDiv.innerHTML = dayHtml;
    container.appendChild(dayDiv);
  });
}


function getBestRecipe(targetKcal, preferredNames = [], tipoPasto = '') {
  const dietaSelezionata = userNeeds?.tipoDieta || 'bilanciata';
  
  // Filtri per dieta
  const filtriDieta = {
    chetogenica: (r) => r.carb < 10 && r.fat > 10, // bassi carb, alti grassi
    lowcarb: (r) => r.carb < 25, // carb moderatamente bassi
    definizione: (r) => r.prot > 15, // alte proteine
    ipertrofica: (r) => r.prot > 12 && r.carb > 15, // proteine e carb alti
    lowfat: (r) => r.fat < 8, // grassi bassi
    zona: (r) => true, // tutte le ricette vanno bene
    mediterranea: (r) => r.veg || r.nome.includes('pesce') || r.nome.includes('olio'), // vegetariane o pesce
    bilanciata: (r) => true // tutte le ricette vanno bene
  };
  
  // Filtra ricette in base alla dieta
  let candidates = recipes.filter(filtriDieta[dietaSelezionata] || (() => true));
  
  // Se ci sono nomi preferiti, dai prioritÃ  a quelli
  if(preferredNames.length > 0) {
    const preferred = candidates.filter(r => preferredNames.some(name => r.nome.includes(name)));
    if(preferred.length > 0) candidates = preferred;
  }
  
  // Se non ci sono candidati, usa tutte le ricette
  if(candidates.length === 0) candidates = recipes;
  
  const portions = [0.5, 0.75, 1, 1.25, 1.5, 1.75, 2, 2.5, 3];
  let best = null;
  let minDiff = Infinity;
  
  candidates.forEach(recipe => {
    portions.forEach(p => {
      const totalKcal = recipe.kcal * p;
      const diff = Math.abs(totalKcal - targetKcal);
      if(diff < minDiff) {
        minDiff = diff;
        best = {recipe, portions: p};
      }
    });
  });
  
  return best || {recipe: recipes[0], portions: 1};
}

 
function generateMenu(){
  if(!userNeeds){
    // Esce silenziosamente se non c'Ã¨ il fabbisogno
    return;
  }

  const dietaSelezionata = userNeeds.tipoDieta || 'bilanciata';
  
  // Categorizza ricette per tipo di pasto
  const categorieRicette = {
    colazione: recipes.filter(r => 
      r.nome.includes('Yogurt') || r.nome.includes('Pancake') || 
      r.nome.includes('Latte') || r.nome.includes('Porridge') ||
      r.nome.includes('Fette biscottate') || r.nome.includes('Cappuccino') ||
      r.nome.includes('Fiocchi') || r.nome.includes('Omelette') ||
      r.nome.includes('Uova strapazzate') || r.nome.includes('Albume')
    ),
    spuntino: recipes.filter(r => 
      r.nome.includes('Mela') || r.nome.includes('Banana') || 
      r.nome.includes('Frutta') || r.nome.includes('Yogurt') ||
      r.nome.includes('Mandorle') || r.nome.includes('Noci') ||
      r.nome.includes('Kiwi') || r.nome.includes('Pera') ||
      r.nome.includes('Arancia') || r.nome.includes('Formaggio') ||
      r.nome.includes('Olive') || r.nome.includes('Uovo sodo')
    ),
    pranzo: recipes.filter(r => 
      r.nome.includes('Pasta') || r.nome.includes('Riso') || 
      r.nome.includes('Pollo') || r.nome.includes('Insalata') ||
      r.nome.includes('Risotto') || r.nome.includes('Farro') ||
      r.nome.includes('Tacchino') || r.nome.includes('Tonno') ||
      r.nome.includes('Quinoa') || r.nome.includes('Cous cous') ||
      r.nome.includes('Salmone') || r.nome.includes('Manzo')
    ),
    cena: recipes.filter(r => 
      r.nome.includes('Pesce') || r.nome.includes('Pollo') || 
      r.nome.includes('Salmone') || r.nome.includes('Merluzzo') ||
      r.nome.includes('Orata') || r.nome.includes('Branzino') ||
      r.nome.includes('Bistecca') || r.nome.includes('Tacchino') ||
      r.nome.includes('Filetto') || r.nome.includes('Sogliola') ||
      r.nome.includes('Spigola') || r.nome.includes('Tonno') ||
      r.nome.includes('Hamburger')
    )
  };

  // Filtra per dieta
  const filtriDieta = {
    chetogenica: (r) => r.carb < 10 && r.fat > 10,
    lowcarb: (r) => r.carb < 25,
    definizione: (r) => r.prot > 15,
    ipertrofica: (r) => r.prot > 12 && r.carb > 15,
    lowfat: (r) => r.fat < 8,
    zona: (r) => true,
    mediterranea: (r) => true,
    bilanciata: (r) => true
  };

  const filtro = filtriDieta[dietaSelezionata] || (() => true);

  // Applica filtro dieta a ogni categoria
  Object.keys(categorieRicette).forEach(cat => {
    categorieRicette[cat] = categorieRicette[cat].filter(filtro);
    // Se la categoria Ã¨ vuota dopo il filtro, usa tutte le ricette
    if(categorieRicette[cat].length === 0) {
      categorieRicette[cat] = recipes.filter(filtro);
    }
  });

  const targetKcal = userNeeds.kcal;
  const mealDistribution = {
    colazione: 0.25,
    spuntino1: 0.10,
    pranzo: 0.35,
    merenda: 0.10,
    cena: 0.20
  };

  mealPlan = [];
  const usedRecipes = new Set(); // Traccia ricette giÃ  usate

  for(let day = 0; day < 7; day++){
    const dayPlan = {};
    
    // Colazione
    const colazioneTarget = targetKcal * mealDistribution.colazione;
    const availableColazione = categorieRicette.colazione.filter(r => !usedRecipes.has(r.nome));
    const colazione = getBestRecipeFromList(colazioneTarget, availableColazione.length > 0 ? availableColazione : categorieRicette.colazione);
    if(colazione) {
      dayPlan.colazione = colazione;
      usedRecipes.add(colazione.recipe.nome);
      if(usedRecipes.size > recipes.length * 0.7) usedRecipes.clear(); // Reset se troppo piene
    }

    // Spuntino
    const spuntinoTarget = targetKcal * mealDistribution.spuntino1;
    const availableSpuntino = categorieRicette.spuntino.filter(r => !usedRecipes.has(r.nome));
    const spuntino = getBestRecipeFromList(spuntinoTarget, availableSpuntino.length > 0 ? availableSpuntino : categorieRicette.spuntino);
    if(spuntino) {
      dayPlan.spuntino = spuntino;
      usedRecipes.add(spuntino.recipe.nome);
    }

    // Pranzo
    const pranzoTarget = targetKcal * mealDistribution.pranzo;
    const availablePranzo = categorieRicette.pranzo.filter(r => !usedRecipes.has(r.nome));
    const pranzo = getBestRecipeFromList(pranzoTarget, availablePranzo.length > 0 ? availablePranzo : categorieRicette.pranzo);
    if(pranzo) {
      dayPlan.pranzo = pranzo;
      usedRecipes.add(pranzo.recipe.nome);
    }

    // Merenda
    const merendaTarget = targetKcal * mealDistribution.merenda;
    const availableMerenda = categorieRicette.spuntino.filter(r => !usedRecipes.has(r.nome));
    const merenda = getBestRecipeFromList(merendaTarget, availableMerenda.length > 0 ? availableMerenda : categorieRicette.spuntino);
    if(merenda) {
      dayPlan.merenda = merenda;
      usedRecipes.add(merenda.recipe.nome);
    }

    // Cena
    const cenaTarget = targetKcal * mealDistribution.cena;
    const availableCena = categorieRicette.cena.filter(r => !usedRecipes.has(r.nome));
    const cena = getBestRecipeFromList(cenaTarget, availableCena.length > 0 ? availableCena : categorieRicette.cena);
    if(cena) {
      dayPlan.cena = cena;
      usedRecipes.add(cena.recipe.nome);
    }

    mealPlan.push(dayPlan);
  }

  saveMenuIndexed();
  renderMenu();
  toast('ðŸ½ï¸ MenÃ¹ generato con varietÃ !');
}

// Funzione helper per selezionare da una lista specifica
function getBestRecipeFromList(targetKcal, recipeList) {
  if(!recipeList || recipeList.length === 0) return null;
  
  const portions = [0.5, 0.75, 1, 1.25, 1.5, 1.75, 2, 2.5, 3];
  let best = null;
  let minDiff = Infinity;
  
  recipeList.forEach(recipe => {
    portions.forEach(p => {
      const totalKcal = recipe.kcal * p;
      const diff = Math.abs(totalKcal - targetKcal);
      if(diff < minDiff) {
        minDiff = diff;
        best = {recipe, portions: p};
      }
    });
  });
  
  return best;
}

 
function generateGrocery(){

  const have = fridge.map(f=>f.nome.toLowerCase());

  const missing = new Set();

  recipes.forEach(r => r.ingredienti.forEach(ing => {

    if(!have.some(h=>h.includes(ing.toLowerCase()))) missing.add(ing);

  }));

  missing.forEach(m => {

    if(!groceryList.find(g => g.nome.toLowerCase() === m.toLowerCase())) {

      groceryList.push({nome: m, checked: false});

    }

  });

  renderGrocery();

  toast('âœ¨ Lista generata');

}

 

function renderGrocery() {
  const out = document.getElementById('listaSpesa');
  out.innerHTML = '';
  
  if (groceryList.length === 0) {
    out.innerHTML = '<div class="tiny">ðŸ“ Lista vuota</div>';
    return;
  }
  
  // ðŸ”§ NORMALIZZA I DATI: converte stringhe in oggetti
  groceryList = groceryList.map(item => {
    // Se Ã¨ giÃ  un oggetto con 'nome', lascialo com'Ã¨
    if (typeof item === 'object' && item !== null && item.nome) {
      return item;
    }
    // Se Ã¨ una stringa, convertila in oggetto
    if (typeof item === 'string') {
      return {
        nome: item,
        quantita: '1',
        acquistato: false,
        checked: false,
        timestamp: Date.now()
      };
    }
    // Fallback: oggetto malformato
    return {
      nome: item?.nome || 'Elemento sconosciuto',
      quantita: item?.quantita || '1',
      acquistato: item?.acquistato || item?.checked || false,
      checked: item?.checked || item?.acquistato || false,
      timestamp: item?.timestamp || Date.now()
    };
  });
  
  // Salva la lista normalizzata
  window.groceryList = groceryList;
  if (typeof saveGroceryIndexed === 'function') saveGroceryIndexed();
  
  // Renderizza
  groceryList.forEach((item, idx) => {
    const div = document.createElement('div');
    div.className = 'grocery-item' + (item.checked || item.acquistato ? ' checked' : '');
    div.innerHTML = `
      <div style="display:flex;align-items:center;flex:1">
        <input type="checkbox" ${item.checked || item.acquistato ? 'checked' : ''} onchange="toggleGroceryItem(${idx})">
        <span>${item.nome}</span>
      </div>
      <button class="btn-ghost" onclick="removeGroceryItem(${idx})" style="padding:4px 8px">ðŸ—‘ï¸</button>
    `;
    out.appendChild(div);
  });
  
  // Aggiorna contatore ricerca
  if (typeof filtraSpesa === 'function') filtraSpesa();
}

// ðŸ” FILTRA LISTA SPESA
function filtraSpesa() {
  const query = document.getElementById('cercaSpesa').value.toLowerCase().trim();
  const listaDiv = document.getElementById('listaSpesa');
  const items = listaDiv.querySelectorAll('.grocery-item, [style*="padding:8px"]');
  
  let visibili = 0;
  let totali = items.length;
  
  items.forEach(item => {
    const testo = item.innerText.toLowerCase();
    
    if (testo.includes(query)) {
      item.style.display = '';
      visibili++;
    } else {
      item.style.display = 'none';
    }
  });
  
  // Aggiorna contatore
  const contatore = document.getElementById('contatoreSpesa');
  if (query) {
    contatore.textContent = `ðŸ” Trovati: ${visibili} / ${totali} articoli`;
  } else {
    contatore.textContent = `ðŸ“‹ Totale: ${totali} articoli`;
  }
}


function addGroceryItem(){

  const input = document.getElementById('nuovoItemSpesa');

  const nome = input.value.trim();

  if(!nome) return;

  if(groceryList.find(g => g.nome.toLowerCase() === nome.toLowerCase())) {

    alert('âŒ GiÃ  presente');

    return;

  }

  groceryList.push({nome: nome, checked: false});

  input.value = '';

  renderGrocery();

  toast('âœ… Aggiunto');

saveGroceryIndexed();

}

 

function toggleGroceryItem(idx){

  groceryList[idx].checked = !groceryList[idx].checked;

  renderGrocery();

}

 

function removeGroceryItem(idx){

  groceryList.splice(idx, 1);

  renderGrocery();

saveGroceryIndexed();

  toast('ðŸ—‘ï¸ Rimosso');

}

 

function clearGrocery(){

  if(!confirm('Cancellare tutto?')) return;

  groceryList = [];

  renderGrocery();

  toast('ðŸ§¹ Pulita');

}

 

function copyGrocery(){

  const txt = groceryList.map(g => (g.checked ? 'âœ“ ' : 'â—‹ ') + g.nome).join('\n');

  if(!txt) return alert('âŒ Lista vuota');

  navigator.clipboard.writeText(txt).then(()=>toast('ðŸ“‹ Copiato'));
}

 

async function loadModel(){

  if(modelCOCO) return modelCOCO;

  try {

    // Prova a caricare il modello TensorFlow

    modelCOCO = await cocoSsd.load();

    console.log('âœ… Modello AI caricato con successo');

    return modelCOCO;

  } catch(e) {

    console.warn('âš ï¸ Modello AI non disponibile, uso modalitÃ  simulata:', e.message);

    // Ritorna null per usare la modalitÃ  simulata

    return null;

  }

}

 

async function scanPhoto(){

  const file = document.getElementById('fotoInput').files[0];

  if(!file){ alert('âŒ Seleziona immagine'); return; }

 

  const loader = document.getElementById('scanLoader');

  loader.classList.add('active');

 

  const img = document.getElementById('fotoPreview');

  img.src = URL.createObjectURL(file);

  img.style.display = 'block';

 

  img.onload = async ()=>{

    try {

      const mdl = await loadModel();

     

      if(!mdl) {

        // ModalitÃ  simulata se il modello non Ã¨ disponibile

        setTimeout(() => {

          loader.classList.remove('active');

          const out = document.getElementById('predictions');

          out.innerHTML='<div class="card"><div class="tiny">â„¹ï¸ Modello AI non disponibile. Usa la modalitÃ  simulata:</div></div>';

          simulateScan();

          toast('âš ï¸ Scansione simulata (modello AI offline)');

        }, 1500);

        return;

      }

     

      const preds = await mdl.detect(img);

      loader.classList.remove('active');

     

      const out = document.getElementById('predictions');

      out.innerHTML='';

     

      if(preds.length===0){

        out.innerHTML='<div class="card"><div class="tiny">âŒ Nessun oggetto riconosciuto. Prova con un\'immagine piÃ¹ chiara.</div></div>';

        return;

      }

     

      const card = document.createElement('div');

      card.className = 'card';

      card.innerHTML = '<div class="tiny" style="margin-bottom:8px"><strong>ðŸ” Oggetti rilevati:</strong></div>';

     

      preds.forEach(p=>{

        const div = document.createElement('div');

        div.className='detected-item';

        div.innerHTML = `âœ… <strong>${p.class}</strong> â€” Confidenza: ${Math.round(p.score*100)}%`;

        card.appendChild(div);

      });

     

      out.appendChild(card);

      toast('âœ… Scansione completata');

    } catch(e) {

      loader.classList.remove('active');

      console.error('Errore scansione:', e);

      document.getElementById('predictions').innerHTML = '<div class="card"><div class="tiny alert">âŒ Errore durante la scansione</div></div>';

      simulateScan();

    }

  };

}

 

function simulateScan(){

  const items = ['apple','banana','orange','carrot','broccoli','bottle','milk','egg'];

  const random = items.sort(()=>Math.random()-0.5).slice(0,Math.floor(Math.random()*3)+2);

  const out = document.getElementById('predictions');

 

  if(!out.querySelector('.card')) {

    const card = document.createElement('div');

    card.className = 'card';

    card.innerHTML = '<div class="tiny" style="margin-bottom:8px"><strong>ðŸŽ² Simulazione (per test):</strong></div>';

    out.appendChild(card);

  }

 

  const card = out.querySelector('.card');

  random.forEach(item => {

    const div = document.createElement('div');

    div.className = 'detected-item';

    div.innerHTML = `âœ… <strong>${item}</strong> â€” ${Math.round(Math.random()*30+70)}%`;

    card.appendChild(div);

  });

}

 

async function scanAndAdd(){

  const file = document.getElementById('fotoInput').files[0];

  if(!file){ alert('âŒ Seleziona immagine'); return; }

 

  const loader = document.getElementById('scanLoader');

  loader.classList.add('active');

 

  const img = document.getElementById('fotoPreview');

  img.src = URL.createObjectURL(file);

  img.style.display = 'block';

 

  img.onload = async ()=>{

    try {

      const mdl = await loadModel();

      let items = [];

     

      if(!mdl) {

        // ModalitÃ  simulata

        const simItems = ['Mela','Banana','Arancia','Carota','Broccoli','Latte','Uova','Yogurt'];

        items = simItems.sort(()=>Math.random()-0.5).slice(0,Math.floor(Math.random()*3)+2);

        toast('âš ï¸ ModalitÃ  simulata (modello AI offline)');

      } else {

        const preds = await mdl.detect(img);

        items = preds.map(p => {

          const name = p.class.charAt(0).toUpperCase() + p.class.slice(1);

          // Traduci alcuni nomi comuni

          const translations = {

            'Apple': 'Mela',

            'Banana': 'Banana',

            'Orange': 'Arancia',

            'Carrot': 'Carota',

            'Broccoli': 'Broccoli',

            'Bottle': 'Bottiglia',

            'Cup': 'Tazza',

            'Bowl': 'Ciotola'

          };

          return translations[name] || name;

        });

      }

     

      loader.classList.remove('active');

     

      if(items.length === 0) {

        alert('âŒ Nessun elemento rilevato');

        return;

      }

     

      const out = document.getElementById('predictions');

      out.innerHTML = '';

     

      const card = document.createElement('div');

      card.className = 'card';

      card.innerHTML = '<div class="tiny" style="margin-bottom:8px"><strong>ðŸ” Elementi da aggiungere:</strong></div>';

     

      items.forEach(item => {

        const div = document.createElement('div');

        div.className = 'detected-item';

        div.innerHTML = `âœ… <strong>${item}</strong>`;

        card.appendChild(div);

      });

     

      out.appendChild(card);

     

      if(!confirm(`Aggiungere al frigo:\n\n${items.join('\n')}\n\n?`)) return;

     

      items.forEach(name=> {

        fridge.push({

          nome: name,

          peso: Math.floor(Math.random()*300+100),

          scadenza: nextDays(Math.floor(Math.random()*5)+3),

          categoria: 'Generale'

        });

      });

     

      refreshList();

      toast(`âœ… Aggiunti ${items.length} elementi al frigo`);

      show('lista');

    } catch(e) {

      loader.classList.remove('active');

      console.error('Errore:', e);

      alert('âŒ Errore durante la scansione');

    }

  };

}

 

function checkExpiry(){

  const out = document.getElementById('alertScadenza');

  if(out) out.innerHTML='';

  const now = new Date();

  fridge.forEach(i=>{

    const d = new Date(i.scadenza);

    const diff = (d - now)/(1000*60*60*24);

    if(out){

      if(diff < 0) out.innerHTML += `<div class="alert">âš ï¸ ${i.nome} scaduto!</div>`;

      else if(diff <= 3) out.innerHTML += `<div class="alert">â° ${i.nome} scade tra ${Math.ceil(diff)} giorni</div>`;

    }

  });

}

 

function toast(msg){

  console.log(msg);

}

 

function planFromFridge(){

  const have=fridge.map(i=>i.nome.toLowerCase());

  const scored = recipes.map(r=>{

    const score = r.ingredienti.reduce((s,ing)=> s + (have.some(h=>h.includes(ing.toLowerCase()))?1:0),0);

    return {r,score};

  }).sort((a,b)=>b.score-a.score);

 

  if(scored.length===0 || scored[0].score===0){

    addChat('Assistente','ðŸ˜… Nessuna corrispondenza trovata');

    return;

  }

  addChat('Assistente',`ðŸ’¡ Consiglio: ${scored[0].r.nome} (hai ${scored[0].score}/${scored[0].r.ingredienti.length} ingredienti)`);

}

 

function calcolaFabbisogno(){

  const sesso=document.getElementById('sesso').value;

  const eta=parseFloat(document.getElementById('eta').value);

  const peso=parseFloat(document.getElementById('pesoF').value);

  const altezza=parseFloat(document.getElementById('altezza').value);

  const att=parseFloat(document.getElementById('attivita').value);

  const obiettivo=parseFloat(document.getElementById('obiettivo').value);

  const out=document.getElementById('risultatoFabbisogno');

 

  if(!eta||!peso||!altezza){

    out.innerHTML='<div class="alert">âš ï¸ Compila tutti i campi</div>';

    return;


  }

 

  let bmr = sesso==='uomo' ? (10*peso + 6.25*altezza - 5*eta + 5)

                            : (10*peso + 6.25*altezza - 5*eta - 161);

  const tdee = bmr * att + obiettivo;

 

  // Calcolo macro basato sulla dieta selezionata
const tipoDieta = document.getElementById('tipoDieta').value;

let percProt, percCarb, percGrassi;

switch(tipoDieta) {
  case 'chetogenica':
    percProt = 0.25; percCarb = 0.05; percGrassi = 0.70;
    break;
  case 'lowcarb':
    percProt = 0.30; percCarb = 0.20; percGrassi = 0.50;
    break;
  case 'definizione':
    percProt = 0.40; percCarb = 0.30; percGrassi = 0.30;
    break;
  case 'ipertrofica':
    percProt = 0.25; percCarb = 0.50; percGrassi = 0.25;
    break;
  case 'lowfat':
    percProt = 0.25; percCarb = 0.60; percGrassi = 0.15;
    break;
  case 'zona':
    percProt = 0.30; percCarb = 0.40; percGrassi = 0.30;
    break;
  case 'mediterranea':
    percProt = 0.20; percCarb = 0.50; percGrassi = 0.30;
    break;
  default: // bilanciata
    percProt = 0.20; percCarb = 0.50; percGrassi = 0.30;
}

const prot = Math.round((tdee * percProt) / 4);
const carb = Math.round((tdee * percCarb) / 4);
const grassi = Math.round((tdee * percGrassi) / 9);

 

  userNeeds = {

    kcal: Math.round(tdee),

    prot: Math.round(prot),

    carb: Math.round(carb),

    fat: Math.round(grassi)

  };

 

  out.innerHTML = `

    <strong>ðŸ“Š Risultato:</strong><br>

    <div style="margin-top:8px">

      ðŸ”¥ BMR: <strong>${Math.round(bmr)} kcal</strong><br>

      âš¡ Fabbisogno: <strong>${userNeeds.kcal} kcal</strong>

    </div>

    <div style="margin-top:12px">

      <strong>ðŸ½ï¸ Macro consigliati:</strong><br>

      ðŸ’ª Proteine: <strong>${userNeeds.prot} g</strong><br>

      ðŸž Carboidrati: <strong>${userNeeds.carb} g</strong><br>

     ðŸ§ˆ Grassi: <strong>${userNeeds.fat} g</strong>
    </div>
  `;
  
  // Salva il tipo di dieta selezionato
  userNeeds.tipoDieta = document.getElementById('tipoDieta').value;
  
  // Salva il BMR (metabolismo basale)
  userNeeds.bmr = Math.round(bmr);

// Salva anche i dati personali per ripristinarli
  userNeeds.sesso = sesso;
  userNeeds.eta = eta;
  userNeeds.peso = peso;
  userNeeds.altezza = altezza;
  userNeeds.attivita = att;
  userNeeds.obiettivo = obiettivo;

  saveFabbisognoIndexed();
  // Salva peso iniziale nello storico
  if (typeof saveWeightEntry === 'function') {
      saveWeightEntry(peso, true);
  }
  window.userNeeds = userNeeds;
  if (typeof salvaTutto === 'function') {
    setTimeout(() => salvaTutto(), 200);
  }

  // Mostra sezione confronto calorie e info dieta
  document.getElementById('confrontoCalorie').style.display = 'block';
  mostraDietaInfo();

  // Aggiorna automaticamente il tracciamento pasti e il menu ricette
  if (typeof updateDailyTracking === 'function') updateDailyTracking();
  if (typeof updateRecipeSelector === 'function') updateRecipeSelector();
  if (typeof calcolaConfrontoCalorie === 'function') calcolaConfrontoCalorie();
  
  toast('ðŸ§® Calcolo completato');
}

// Mostra info sulla dieta selezionata
function mostraDietaInfo() {
  const tipo = document.getElementById('tipoDieta').value;
  const info = document.getElementById('dietaInfo');
  const desc = document.getElementById('dietaDescrizione');
  
  const diete = {
    bilanciata: 'âš–ï¸ <strong>Bilanciata Standard:</strong> 50% carboidrati, 20% proteine, 30% grassi. Ideale per mantenimento e salute generale.',
    ipertrofica: 'ðŸ’ª <strong>Ipertrofica:</strong> Alta in proteine (2g/kg), carboidrati elevati per energia, grassi moderati. Perfetta per aumento massa muscolare e forza.',
    definizione: 'ðŸ”¥ <strong>Definizione:</strong> Proteine molto alte (2.2g/kg) per preservare muscoli, carboidrati moderati, grassi bassi. Per perdere grasso mantenendo la massa magra.',
    lowcarb: 'ðŸ¥© <strong>Low Carb:</strong> Carboidrati ridotti (20-30% calorie), proteine alte (30-35%), grassi alti (40-50%). Efficace per dimagrimento e controllo glicemia.',
    lowfat: 'ðŸŒ¾ <strong>Low Fat:</strong> Grassi ridotti (15-20%), carboidrati alti (55-60%), proteine moderate (25-30%). Classica per perdita peso e salute cardiovascolare.',
    zona: 'âš–ï¸ <strong>Dieta Zona:</strong> 40% carboidrati, 30% proteine, 30% grassi. Equilibrio ormonale, controllo insulina e riduzione infiammazione.',
    mediterranea: 'ðŸŒ± <strong>Mediterranea:</strong> Carboidrati 50-55% (preferire integrali), proteine 15-20%, grassi sani 25-30% (olio oliva, pesce). Ottima per salute cardiovascolare e longevitÃ .',
    chetogenica: 'ðŸ¥‘ <strong>Chetogenica:</strong> Carboidrati <50g/giorno, proteine moderate (20-25%), grassi molto alti (70-75%). Induce chetosi per dimagrimento rapido e energia mentale.'
  };
  
  desc.innerHTML = diete[tipo];
  info.style.display = 'block';
  
  if (typeof salvaTutto === 'function') {
    setTimeout(() => salvaTutto(), 100);
  }
}

// ========== SMARTWATCH HEALTH CONNECT ==========
const swIcons = {
    watch: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sw-icon-base sw-icon-watch"><circle cx="12" cy="12" r="6"/><polyline points="12 10 12 12 13 13"/><path d="m16.13 7.66-.81-4.05a2 2 0 0 0-2-2.32l-2.63.53a2 2 0 0 0-1.6 1.79l-.81 4.05"/><path d="m7.88 16.34.81 4.05a2 2 0 0 0 2 2.32l2.63-.53a2 2 0 0 0 1.6-1.79l.81-4.05"/></svg>`,
    activity: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sw-icon-base sw-icon-activity"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`,
    flame: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sw-icon-base sw-icon-flame"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3.3.3.6.8.9 1.8z"/></svg>`,
    footprints: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="sw-icon-base sw-icon-steps"><path d="M14.2,5.5c0-2.5,1.5-3.5,3.3-3.5s3.3,1,3.3,3.5c0,3-1.5,5-3.3,5S14.2,8.5,14.2,5.5z M15.5,12.5c0-1.5,1-2,2-2s2,0.5,2,2c0,1.5-1,2.5-2,2.5S15.5,14,15.5,12.5z"/><path d="M3.5,13.5c0-2.5,1.5-3.5,3.3-3.5s3.3,1,3.3,3.5c0,3-1.5,5-3.3,5S3.5,16.5,3.5,13.5z M4.8,20.5c0-1.5,1-2,2-2s2,0.5,2,2c0,1.5-1,2.5-2,2.5S4.8,22,4.8,20.5z"/></svg>`,
    activityStat: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sw-icon-base sw-icon-bpm"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`
};

let swStatus = 'IDLE';
let swData = {
    caloriesBurned: 0,
    steps: 0,
    heartRateAvg: 0,
    aiInsight: null,
    sincronizzato: false
};
const swDailyGoal = 2000;
let swUpdateInterval = null;

function swRenderHeader() {
    const headerIconEl = document.getElementById('sw-header-icon');
    const headerTextEl = document.getElementById('sw-header-text');
    const liveIndicatorEl = document.getElementById('sw-live-indicator');
    
    if (swStatus === 'MONITORING') {
        if (headerIconEl) headerIconEl.innerHTML = swIcons.activity;
        if (headerTextEl) headerTextEl.textContent = 'Attivo';
        if (liveIndicatorEl) liveIndicatorEl.classList.remove('hidden');
    } else {
        if (headerIconEl) headerIconEl.innerHTML = swIcons.watch;
        if (headerTextEl) headerTextEl.textContent = 'Smart Device';
        if (liveIndicatorEl) liveIndicatorEl.classList.add('hidden');
    }
}

function swRenderIdle() {
    const mainContentEl = document.getElementById('sw-main-content');
    if (!mainContentEl) return;
    
    mainContentEl.innerHTML = `
        <div class="sw-flex-between-row sw-h-full sw-animate-fade-in sw-animate-zoom-in" style="gap: 0.5rem;">
            <div class="sw-flex-center-row sw-w-half">
                <button id="sw-start-btn" class="sw-start-btn">
                    <div class="sw-btn-glow"></div>
                    <svg class="sw-btn-svg" viewBox="0 0 200 200" fill="none">
                        <path d="M70 40 L 80 10 L 120 10 L 130 40 Z" fill="#042f2e" stroke="#064e3b" stroke-width="2" />
                        <path d="M70 160 L 80 190 L 120 190 L 130 160 Z" fill="#042f2e" stroke="#064e3b" stroke-width="2" />
                        <circle cx="100" cy="100" r="62" fill="rgba(0,0,0,0.3)" />
                        <circle cx="100" cy="100" r="60" fill="url(#swCaseGradient)" stroke="#34d399" stroke-width="1" stroke-opacity="0.5" />
                        <defs>
                            <linearGradient id="swCaseGradient" x1="0" y1="0" x2="200" y2="200">
                                <stop offset="0%" stop-color="#1f2937" />
                                <stop offset="100%" stop-color="#111827" />
                            </linearGradient>
                            <linearGradient id="swScreenGradient" x1="100" y1="40" x2="100" y2="160">
                                <stop offset="0%" stop-color="#065f46" />
                                <stop offset="100%" stop-color="#064e3b" />
                            </linearGradient>
                        </defs>
                        <circle cx="100" cy="100" r="50" fill="url(#swScreenGradient)" />
                        <rect x="158" y="90" width="6" height="20" rx="2" fill="#374151" />
                        <text x="100" y="105" text-anchor="middle" fill="white" font-size="24" font-family="sans-serif" font-weight="bold">START</text>
                        <circle cx="100" cy="100" r="45" stroke="rgba(255,255,255,0.1)" stroke-width="1" stroke-dasharray="2 4" />
                    </svg>
                </button>
            </div>
            
            <div class="sw-flex-col-center sw-items-start sw-w-half sw-pl-2">
                <h2 class="sw-idle-title">Sincronizza</h2>
                <p class="sw-idle-desc">Collega il tuo smartwatch per leggere i dati.</p>
            </div>
        </div>
    `;
    document.getElementById('sw-start-btn').addEventListener('click', swStartSyncProcess);
}

function swRenderProcessing(text) {
    const mainContentEl = document.getElementById('sw-main-content');
    if (!mainContentEl) return;
    
    mainContentEl.innerHTML = `
         <div class="sw-flex-col-center sw-w-full sw-h-full">
            <div class="sw-proc-icon-wrap">
                <div class="sw-proc-svg-container">
                     <svg width="40" height="40" viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                         <rect x="25" y="25" width="50" height="50" rx="12" />
                         <path d="M35 25 L 35 15 L 65 15 L 65 25" />
                         <path d="M35 75 L 35 85 L 65 85 L 65 75" />
                     </svg>
                </div>
                <div class="sw-orbit-1">
                    <div class="sw-orbit-dot-1"></div>
                </div>
                <div class="sw-orbit-2">
                    <div class="sw-orbit-dot-2"></div>
                </div>
                <div class="sw-ring-static"></div>
            </div>

            <p class="sw-proc-text">${text}</p>
         </div>
    `;
}

function swRenderMonitoring() {
    const mainContentEl = document.getElementById('sw-main-content');
    if (!mainContentEl) return;
    
    const percentage = Math.min((swData.caloriesBurned / swDailyGoal) * 100, 100);
    const radius = 80;
    const circumference = 2 * Math.PI * radius; 
    const visiblePortion = 0.75; 
    const visibleLength = circumference * visiblePortion;
    const gapLength = circumference * (1 - visiblePortion);
    const dashOffset = visibleLength * (1 - (percentage / 100));

    mainContentEl.innerHTML = `
        <div class="sw-monitor-container sw-animate-fade-in"> 
            
            <div class="sw-gauge-col">
                <div class="sw-gauge-wrap">
                     
                     <svg class="sw-gauge-svg" viewBox="0 0 240 240">
                        <defs>
                            <linearGradient id="swProgressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stop-color="#34d399" />
                                <stop offset="100%" stop-color="#10b981" />
                            </linearGradient>
                        </defs>
                        
                        <circle cx="120" cy="120" r="${radius}" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="10" stroke-linecap="round" stroke-dasharray="${visibleLength} ${gapLength}" stroke-dashoffset="0" />

                        <circle class="sw-gauge-circle" cx="120" cy="120" r="${radius}" fill="none" stroke="url(#swProgressGradient)" stroke-width="10" stroke-linecap="round" stroke-dasharray="${visibleLength} ${gapLength}" stroke-dashoffset="${dashOffset}" />
                     </svg>
                     
                     <div class="sw-gauge-content">
                         <div>${swIcons.flame}</div>
                         <div class="sw-cal-val-wrap">
                            <span class="sw-cal-minus">-</span>
                            <span id="sw-cal-val" class="sw-cal-number">${swData.caloriesBurned}</span>
                         </div>
                         <div class="sw-cal-label">Kcal</div>
                     </div>
                </div>
            </div>

            <div class="sw-stats-col">
                <div class="sw-stats-row">
                    <div class="sw-stat-card">
                        ${swIcons.footprints}
                        <span id="sw-steps-val" class="sw-stat-val">${swData.steps}</span>
                        <span class="sw-stat-label">Passi</span>
                    </div>
                    <div class="sw-stat-card">
                        ${swIcons.activityStat}
                        <span class="sw-stat-val">${swData.heartRateAvg}</span>
                        <span class="sw-stat-label">BPM</span>
                    </div>
                </div>

                ${swData.aiInsight ? `
                    <div class="sw-insight-card">
                        <p class="sw-insight-text">"${swData.aiInsight}"</p>
                    </div>
                ` : ''}
            </div>

        </div>
    `;
    
    document.getElementById('calorieOrologio').value = swData.caloriesBurned;
    if (typeof calcolaConfrontoCalorie === 'function') calcolaConfrontoCalorie();
}

function swUpdateMonitoringUI() {
    const calEl = document.getElementById('sw-cal-val');
    const stepsEl = document.getElementById('sw-steps-val');
    const circleEl = document.querySelector('.sw-gauge-circle');

    if(calEl) calEl.innerText = swData.caloriesBurned;
    if(stepsEl) stepsEl.innerText = swData.steps;
    
    if(circleEl) {
        const radius = 80;
        const circumference = 2 * Math.PI * radius; 
        const visiblePortion = 0.75; 
        const visibleLength = circumference * visiblePortion;
        const percentage = Math.min((swData.caloriesBurned / swDailyGoal) * 100, 100);
        const dashOffset = visibleLength * (1 - (percentage / 100));
        circleEl.style.strokeDashoffset = dashOffset;
    }
    
    document.getElementById('calorieOrologio').value = swData.caloriesBurned;
}

function swSetStatus(newStatus) {
    swStatus = newStatus;
    swRenderHeader();
    
    if (swStatus === 'IDLE') swRenderIdle();
    else if (swStatus === 'SCANNING') swRenderProcessing('Ricerca dispositivo...');
    else if (swStatus === 'SYNCING') swRenderProcessing('Sincronizzazione...');
    else if (swStatus === 'ANALYZING') swRenderProcessing('Analisi in corso...');
    else if (swStatus === 'MONITORING') swRenderMonitoring();
}

function isNativeApp() {
    return window.Capacitor && window.Capacitor.isNativePlatform && window.Capacitor.isNativePlatform();
}

async function readFromHealthConnect() {
    if (typeof CapacitorHealthConnect !== 'undefined') {
        try {
            await CapacitorHealthConnect.requestAuthorization({
                read: ['Steps', 'ActiveCaloriesBurned', 'HeartRate'],
                write: []
            });
            
            const today = new Date();
            const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            
            const stepsResult = await CapacitorHealthConnect.readRecords({
                type: 'Steps',
                startTime: startOfDay.toISOString(),
                endTime: today.toISOString()
            });
            
            const caloriesResult = await CapacitorHealthConnect.readRecords({
                type: 'ActiveCaloriesBurned',
                startTime: startOfDay.toISOString(),
                endTime: today.toISOString()
            });
            
            const heartResult = await CapacitorHealthConnect.readRecords({
                type: 'HeartRate',
                startTime: startOfDay.toISOString(),
                endTime: today.toISOString()
            });
            
            let totalSteps = 0;
            let totalCalories = 0;
            let avgHeartRate = 0;
            
            if (stepsResult.records) {
                stepsResult.records.forEach(r => totalSteps += r.count || 0);
            }
            if (caloriesResult.records) {
                caloriesResult.records.forEach(r => totalCalories += r.energy?.inKilocalories || 0);
            }
            if (heartResult.records && heartResult.records.length > 0) {
                const sum = heartResult.records.reduce((acc, r) => acc + (r.beatsPerMinute || 0), 0);
                avgHeartRate = Math.round(sum / heartResult.records.length);
            }
            
            return {
                steps: totalSteps,
                calories: Math.round(totalCalories),
                heartRate: avgHeartRate || 72
            };
        } catch (error) {
            console.error('Health Connect error:', error);
            return null;
        }
    }
    return null;
}

function simulateHealthData() {
    return {
        steps: Math.floor(3000 + Math.random() * 7000),
        calories: Math.floor(200 + Math.random() * 500),
        heartRate: Math.floor(65 + Math.random() * 30)
    };
}

async function swStartSyncProcess() {
    swSetStatus('SCANNING');
    await new Promise(r => setTimeout(r, 1500));
    swSetStatus('SYNCING');
    await new Promise(r => setTimeout(r, 1200));
    
    swSetStatus('ANALYZING');
    
    let healthData = null;
    
    if (isNativeApp()) {
        healthData = await readFromHealthConnect();
    }
    
    if (!healthData) {
        healthData = simulateHealthData();
    }
    
    swData.caloriesBurned = healthData.calories;
    swData.steps = healthData.steps;
    swData.heartRateAvg = healthData.heartRate;
    swData.aiInsight = "Ottimo lavoro! Continua cosÃ¬ per raggiungere i tuoi obiettivi.";
    swData.sincronizzato = true;
    
    swSetStatus('MONITORING');
    
    localStorage.setItem('swData', JSON.stringify(swData));

    if (swUpdateInterval) clearInterval(swUpdateInterval);
    swUpdateInterval = setInterval(() => {
        swData.caloriesBurned += Math.floor(Math.random() * 2);
        swData.steps += Math.floor(Math.random() * 5);
        if(swStatus === 'MONITORING') {
            swUpdateMonitoringUI();
        }
    }, 5000);
    
    if (typeof toast === 'function') {
        toast('âŒš Smartwatch sincronizzato!');
    }
}

function initSmartwatch() {
    const saved = localStorage.getItem('swData');
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            swData = { ...swData, ...parsed };
        } catch(e) {}
    }
    
    swRenderHeader();
    swRenderIdle();
}

document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initSmartwatch, 500);
});

// Toggle info smartwatch
function toggleSmartwatchInfo(event) {
  event.stopPropagation();
  const tooltip = document.getElementById('smartwatchInfoTooltip');
  if (tooltip) {
    tooltip.classList.toggle('show');
  }
}

function toggleBilancioInfo(event) {
  event.stopPropagation();
  const tooltip = document.getElementById('bilancioInfoTooltip');
  tooltip.classList.toggle('show');
  
  // Chiudi al click fuori
  if (tooltip.classList.contains('show')) {
    setTimeout(() => {
      document.addEventListener('click', closeBilancioTooltip);
    }, 10);
  }
}

function closeBilancioTooltip(e) {
  const tooltip = document.getElementById('bilancioInfoTooltip');
  if (tooltip && !tooltip.contains(e.target)) {
    tooltip.classList.remove('show');
    document.removeEventListener('click', closeBilancioTooltip);
  }
}  
  
function closeSmartwatchInfo() {
  const tooltip = document.getElementById('smartwatchInfoTooltip');
  if (tooltip) {
    tooltip.classList.remove('show');
  }
}

// Chiudi tooltip smartwatch cliccando fuori
document.addEventListener('click', function(e) {
  if (!e.target.closest('.smartwatch-info-btn-pro') && !e.target.closest('.smartwatch-info-tooltip-pro')) {
    closeSmartwatchInfo();
  }
});  
  
function calcolaConfrontoCalorie() {
  if (!userNeeds) {
    return;
  }
  
  // Dati smartwatch
  const calorieOrologioRaw = parseFloat(document.getElementById('calorieOrologio').value) || 0;
  const passiOrologioRaw = (typeof swData !== 'undefined') ? swData.steps : 0;
  const orologioSincronizzato = (typeof swData !== 'undefined' && swData.sincronizzato === true);
  
  // Per i calcoli usa i valori numerici
  const calorieOrologio = calorieOrologioRaw;
  const passiOrologio = passiOrologioRaw;
  
  // Per la visualizzazione
  const calorieOrologioDisplay = orologioSincronizzato ? calorieOrologio : '- -';
  const passiOrologioDisplay = orologioSincronizzato ? passiOrologio.toLocaleString() : '- -';
  
  // Dati utente
  const sesso = document.getElementById('sesso')?.value || userNeeds.sesso || 'uomo';
  const eta = parseFloat(document.getElementById('eta')?.value) || userNeeds.eta || 30;
  const peso = parseFloat(document.getElementById('pesoF')?.value) || userNeeds.peso || 70;
  const altezza = parseFloat(document.getElementById('altezza')?.value) || userNeeds.altezza || 170;
  
  // BMR (metabolismo basale)
  let bmr = sesso === 'uomo' 
    ? (10 * peso + 6.25 * altezza - 5 * eta + 5)
    : (10 * peso + 6.25 * altezza - 5 * eta - 161);
  bmr = Math.round(bmr);
  
  // Calorie totali bruciate oggi (BMR + attivitÃ  smartwatch)
  const calorieBruciate = bmr + calorieOrologio;
  
  // Target dieta
  const targetDieta = userNeeds.kcal || 2000;
  
  // Obiettivo utente
  const obiettivoCalorie = userNeeds.obiettivo || 0;
  const vuoleDimagrire = obiettivoCalorie < 0;
  const vuoleIngrassare = obiettivoCalorie > 0;
  
  // TDEE teorico (fabbisogno senza obiettivo)
  const tdeeTeoricoBase = targetDieta - obiettivoCalorie;
  
  // Calorie assunte dai pasti
  const today = typeof getTodayKey === 'function' ? getTodayKey() : new Date().toISOString().slice(0,10);
  let meals = [];
  if (typeof dailyMeals !== 'undefined' && dailyMeals[today]) meals = dailyMeals[today];
  else if (window.dailyMeals && window.dailyMeals[today]) meals = window.dailyMeals[today];
  
  const calorieAssunte = Math.round(meals.reduce((sum, meal) => sum + (meal.kcal || 0), 0));
  const numPasti = meals.length;
  
  // ========== BILANCIO 1: EFFETTIVO (Assunte vs Bruciate) ==========
  const bilancioReale = calorieAssunte - calorieBruciate;
  
  let realeClasse = 'pareggio';
  let realeMsg = 'Pareggio';
  
  if (bilancioReale < -300) {
    realeClasse = 'deficit';
    realeMsg = 'Deficit';
  } else if (bilancioReale < -100) {
    realeClasse = 'deficit';
    realeMsg = 'Deficit lieve';
  } else if (bilancioReale > 300) {
    realeClasse = 'surplus';
    realeMsg = 'Surplus';
  } else if (bilancioReale > 100) {
    realeClasse = 'surplus';
    realeMsg = 'Surplus lieve';
  }
  
  // ========== BILANCIO 2: PIANO (Assunte vs Target) ==========
  const bilancioDieta = calorieAssunte - targetDieta;
  
  let dietaClasse = 'pareggio';
  let dietaMsg = 'In target';
  
  if (bilancioDieta < -300) {
    dietaClasse = 'deficit';
    dietaMsg = 'Sotto target';
  } else if (bilancioDieta < -100) {
    dietaClasse = 'deficit';
    dietaMsg = 'Poco sotto';
  } else if (bilancioDieta > 300) {
    dietaClasse = 'surplus';
    dietaMsg = 'Sopra target';
  } else if (bilancioDieta > 100) {
    dietaClasse = 'surplus';
    dietaMsg = 'Poco sopra';
  }
  
  // ========== ANALISI ATTIVITÃ€ (dinamica come consiglio) ==========
  const differenzaAttivita = calorieBruciate - tdeeTeoricoBase;
  
  let attivitaMsg = '';
  let attivitaHighlight = '';
  
  if (calorieOrologio === 0) {
    attivitaMsg = 'Sincronizza lo smartwatch per monitorare l\'attivitÃ  fisica e avere un\'analisi piÃ¹ accurata del tuo bilancio energetico.';
    attivitaHighlight = 'ðŸ“µ';
  } else {
    // Calcola highlight basato sulla differenza attivitÃ 
    if (Math.abs(differenzaAttivita) <= 100) {
      attivitaHighlight = 'âœ…';
    } else if (differenzaAttivita > 0) {
      attivitaHighlight = `ðŸ”¥ +${Math.round(differenzaAttivita)} kcal`;
    } else {
      attivitaHighlight = `ðŸ’¤ ${Math.round(differenzaAttivita)} kcal`;
    }
    
    // Messaggio basato su obiettivo + bilancio reale + attivitÃ 
    if (vuoleDimagrire) {
      // OBIETTIVO: DIMAGRIRE
      if (bilancioReale < -100) {
        // Sei in deficit (bene!)
        if (differenzaAttivita > 100) {
          attivitaMsg = `Ottimo! Hai bruciato +${Math.round(differenzaAttivita)} kcal in piÃ¹ del solito e sei in deficit di ${Math.abs(bilancioReale)} kcal. Stai accelerando il dimagrimento!`;
        } else if (differenzaAttivita < -100) {
          attivitaMsg = `Hai bruciato ${Math.round(differenzaAttivita)} kcal rispetto al solito, ma sei comunque in deficit di ${Math.abs(bilancioReale)} kcal. Stai dimagrendo!`;
        } else {
          attivitaMsg = `AttivitÃ  normale e sei in deficit di ${Math.abs(bilancioReale)} kcal. Perfetto per dimagrire!`;
        }
      } else if (bilancioReale > 100) {
        // Sei in surplus (male per dimagrire!)
        if (differenzaAttivita < -100) {
          attivitaMsg = `Attenzione! Hai bruciato ${Math.round(differenzaAttivita)} kcal rispetto al solito e sei in surplus di +${bilancioReale} kcal. Devi mangiare meno o muoverti di piÃ¹!`;
        } else if (differenzaAttivita > 100) {
          attivitaMsg = `Hai bruciato +${Math.round(differenzaAttivita)} kcal in piÃ¹, ma sei comunque in surplus di +${bilancioReale} kcal. Riduci le porzioni!`;
        } else {
          attivitaMsg = `AttivitÃ  normale ma sei in surplus di +${bilancioReale} kcal. Per dimagrire devi ridurre le calorie o muoverti di piÃ¹.`;
        }
      } else {
        // Pareggio
        if (differenzaAttivita > 100) {
          attivitaMsg = `Hai bruciato +${Math.round(differenzaAttivita)} kcal in piÃ¹ del solito. Riduci un po' le calorie per creare deficit e dimagrire.`;
        } else if (differenzaAttivita < -100) {
          attivitaMsg = `Hai bruciato ${Math.round(differenzaAttivita)} kcal rispetto al solito. Per dimagrire dovresti mangiare meno o muoverti di piÃ¹.`;
        } else {
          attivitaMsg = `Bilancio in pareggio. Per dimagrire devi creare un deficit: mangia meno o muoviti di piÃ¹.`;
        }
      }
    } else if (vuoleIngrassare) {
      // OBIETTIVO: MASSA
      if (bilancioReale > 100) {
        // Sei in surplus (bene!)
        if (differenzaAttivita < -100) {
          attivitaMsg = `Hai bruciato ${Math.round(differenzaAttivita)} kcal rispetto al solito e sei in surplus di +${bilancioReale} kcal. Perfetto per mettere massa!`;
        } else if (differenzaAttivita > 100) {
          attivitaMsg = `Hai bruciato +${Math.round(differenzaAttivita)} kcal in piÃ¹, ma sei comunque in surplus di +${bilancioReale} kcal. Ottimo per la massa!`;
        } else {
          attivitaMsg = `AttivitÃ  normale e sei in surplus di +${bilancioReale} kcal. Perfetto per costruire massa!`;
        }
      } else if (bilancioReale < -100) {
        // Sei in deficit (male per massa!)
        if (differenzaAttivita > 100) {
          attivitaMsg = `Attenzione! Hai bruciato +${Math.round(differenzaAttivita)} kcal in piÃ¹ e sei in deficit di ${Math.abs(bilancioReale)} kcal. Devi mangiare molto di piÃ¹!`;
        } else if (differenzaAttivita < -100) {
          attivitaMsg = `Hai bruciato ${Math.round(differenzaAttivita)} kcal rispetto al solito, ma sei in deficit di ${Math.abs(bilancioReale)} kcal. Mangia di piÃ¹!`;
        } else {
          attivitaMsg = `AttivitÃ  normale ma sei in deficit di ${Math.abs(bilancioReale)} kcal. Per mettere massa devi mangiare di piÃ¹!`;
        }
      } else {
        // Pareggio
        if (differenzaAttivita < -100) {
          attivitaMsg = `Hai bruciato ${Math.round(differenzaAttivita)} kcal rispetto al solito. Mangia un po' di piÃ¹ per creare surplus.`;
        } else if (differenzaAttivita > 100) {
          attivitaMsg = `Hai bruciato +${Math.round(differenzaAttivita)} kcal in piÃ¹ del solito. Devi mangiare molto di piÃ¹ per creare surplus!`;
        } else {
          attivitaMsg = `Bilancio in pareggio. Per mettere massa devi creare un surplus: mangia di piÃ¹.`;
        }
      }
    } else {
      // OBIETTIVO: MANTENIMENTO
      if (Math.abs(bilancioReale) <= 150) {
        if (Math.abs(differenzaAttivita) <= 100) {
          attivitaMsg = `AttivitÃ  e bilancio nella norma. Perfetto per mantenere il peso!`;
        } else if (differenzaAttivita > 100) {
          attivitaMsg = `Hai bruciato +${Math.round(differenzaAttivita)} kcal in piÃ¹, ma il bilancio Ã¨ equilibrato. Ottimo!`;
        } else {
          attivitaMsg = `Hai bruciato ${Math.round(differenzaAttivita)} kcal rispetto al solito, ma il bilancio Ã¨ equilibrato. Tutto ok!`;
        }
      } else if (bilancioReale < -150) {
        attivitaMsg = `Sei in deficit di ${Math.abs(bilancioReale)} kcal. Per mantenere il peso dovresti mangiare un po' di piÃ¹.`;
      } else {
        attivitaMsg = `Sei in surplus di +${bilancioReale} kcal. Per mantenere il peso dovresti ridurre le porzioni o muoverti di piÃ¹.`;
      }
    }
  }
  
  // ========== CONSIGLIO INTELLIGENTE ==========
  let consiglio = '';
  
  if (vuoleDimagrire) {
    if (bilancioReale < -100 && bilancioDieta <= 100) {
      consiglio = 'ðŸŽ‰ Perfetto! Sei in deficit e stai rispettando la dieta. Continua cosÃ¬!';
    } else if (bilancioReale < -100 && bilancioDieta > 100) {
      consiglio = 'âš ï¸ Sei in deficit MA hai mangiato piÃ¹ del target. Funziona, ma cerca di rispettare il piano.';
    } else if (bilancioReale >= -100 && bilancioDieta <= 0) {
      consiglio = 'ðŸ’ª Rispetti la dieta ma non sei in deficit. Muoviti di piÃ¹ o riduci ancora le calorie.';
    } else if (bilancioReale > 100) {
      consiglio = 'âŒ Sei in surplus! Stai mangiando troppo per dimagrire. Riduci le porzioni.';
    } else {
      consiglio = 'ðŸ“Š Bilancio equilibrato. Per dimagrire dovresti creare piÃ¹ deficit.';
    }
  } else if (vuoleIngrassare) {
    if (bilancioReale > 100 && bilancioDieta >= -100) {
      consiglio = 'ðŸŽ‰ Perfetto! Sei in surplus e rispetti il piano. Ottimo per la massa!';
    } else if (bilancioReale > 100 && bilancioDieta < -100) {
      consiglio = 'ðŸ’ª Sei in surplus ma sotto il target. Potresti mangiare ancora di piÃ¹.';
    } else if (bilancioReale <= 100 && bilancioDieta >= 0) {
      consiglio = 'âš ï¸ Rispetti il target ma non sei in surplus. Mangia di piÃ¹ o riduci l\'attivitÃ .';
    } else if (bilancioReale < -100) {
      consiglio = 'âŒ Sei in deficit! Stai bruciando troppo per mettere massa. Mangia di piÃ¹!';
    } else {
      consiglio = 'ðŸ“Š Bilancio equilibrato. Per aumentare massa dovresti creare piÃ¹ surplus.';
    }
  } else {
    if (Math.abs(bilancioReale) <= 150 && Math.abs(bilancioDieta) <= 150) {
      consiglio = 'ðŸŽ¯ Perfetto! Bilancio equilibrato e target rispettato. Ottimo mantenimento!';
    } else if (bilancioReale < -200) {
      consiglio = 'ðŸ“‰ Sei in deficit. Se vuoi mantenere il peso, mangia un po\' di piÃ¹.';
    } else if (bilancioReale > 200) {
      consiglio = 'ðŸ“ˆ Sei in surplus. Se vuoi mantenere il peso, riduci le porzioni o muoviti di piÃ¹.';
    } else {
      consiglio = 'ðŸ“Š Quasi in equilibrio. Piccoli aggiustamenti per perfezionare.';
    }
  }
  
  // Formatta i bilanci per la visualizzazione
  const bilancioRealeDisplay = bilancioReale >= 0 ? `+${bilancioReale}` : `${bilancioReale}`;
  const bilancioDietaDisplay = bilancioDieta >= 0 ? `+${bilancioDieta}` : `${bilancioDieta}`;
  
  // Render HTML
  document.getElementById('risultatoConfronto').innerHTML = `
    <!-- Stats Grid -->
    <div class="bilancio-stats-grid">
      <div class="bilancio-grid-card">
        <svg class="bilancio-grid-icon bilancio-text-fire" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3.3.3.6.8.9 1.8z"/>
        </svg>
        <span class="bilancio-grid-value">${bmr}</span>
        <span class="bilancio-grid-label">BMR</span>
      </div>
      <div class="bilancio-grid-card">
        <svg class="bilancio-grid-icon bilancio-text-purple" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
        </svg>
        <span class="bilancio-grid-value">${calorieOrologioDisplay}</span>
        <span class="bilancio-grid-label">Attive</span>
      </div>
      <div class="bilancio-grid-card">
        <svg class="bilancio-grid-icon bilancio-text-blue" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>
        </svg>
        <span class="bilancio-grid-value">${calorieBruciate}</span>
        <span class="bilancio-grid-label">Bruciate</span>
      </div>
      <div class="bilancio-grid-card">
        <svg class="bilancio-grid-icon bilancio-text-pink" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>
        </svg>
        <span class="bilancio-grid-value">${targetDieta}</span>
        <span class="bilancio-grid-label">Target</span>
      </div>
      <div class="bilancio-grid-card">
        <svg class="bilancio-grid-icon bilancio-text-yellow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/>
        </svg>
        <span class="bilancio-grid-value">${calorieAssunte}</span>
        <span class="bilancio-grid-label">${numPasti} Pasti</span>
      </div>
      <div class="bilancio-grid-card">
        <svg class="bilancio-grid-icon bilancio-text-purple" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M14.2,5.5c0-2.5,1.5-3.5,3.3-3.5s3.3,1,3.3,3.5c0,3-1.5,5-3.3,5S14.2,8.5,14.2,5.5z M15.5,12.5c0-1.5,1-2,2-2s2,0.5,2,2c0,1.5-1,2.5-2,2.5S15.5,14,15.5,12.5z"/><path d="M3.5,13.5c0-2.5,1.5-3.5,3.3-3.5s3.3,1,3.3,3.5c0,3-1.5,5-3.3,5S3.5,16.5,3.5,13.5z M4.8,20.5c0-1.5,1-2,2-2s2,0.5,2,2c0,1.5-1,2.5-2,2.5S4.8,22,4.8,20.5z"/>
        </svg>
        <span class="bilancio-grid-value">${passiOrologioDisplay}</span>
        <span class="bilancio-grid-label">Passi</span>
      </div>
    </div>
    
    <!-- DUE HERO BANNER AFFIANCATI -->
    <div class="bilancio-dual-container">
      <!-- Bilancio Effettivo (sinistra) -->
      <div class="bilancio-hero-mini ${realeClasse}">
        <span class="bilancio-hero-mini-title">Bilancio Effettivo</span>
        <span class="bilancio-hero-mini-value ${realeClasse}">${bilancioRealeDisplay}</span>
        <span class="bilancio-hero-mini-unit">kcal</span>
        <span class="bilancio-hero-mini-label">${realeMsg}</span>
        <span class="bilancio-hero-mini-desc">Assunte âˆ’ Bruciate</span>
      </div>
      
      <!-- Aderenza Piano (destra) -->
      <div class="bilancio-hero-mini ${dietaClasse}">
        <span class="bilancio-hero-mini-title">Aderenza al Piano</span>
        <span class="bilancio-hero-mini-value ${dietaClasse}">${bilancioDietaDisplay}</span>
        <span class="bilancio-hero-mini-unit">kcal</span>
        <span class="bilancio-hero-mini-label">${dietaMsg}</span>
        <span class="bilancio-hero-mini-desc">Assunte âˆ’ ${targetDieta} target</span>
      </div>
    </div>
    
    <!-- Info Cards -->
    <div class="bilancio-info-list">
      <div class="bilancio-info-card analysis">
        <div class="bilancio-info-header">
          <svg class="bilancio-info-icon bilancio-text-blue" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>
          </svg>
          <span class="bilancio-info-title">Analisi AttivitÃ </span>
        </div>
        <p class="bilancio-info-desc">${attivitaMsg}</p>
      </div>
      
      <div class="bilancio-info-card advice">
        <div class="bilancio-info-header">
          <svg class="bilancio-info-icon bilancio-text-yellow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6A4.997 4.997 0 0 1 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"/>
          </svg>
          <span class="bilancio-info-title">Consiglio</span>
        </div>
        <p class="bilancio-info-desc">${consiglio}</p>
      </div>
    </div>
  `;
  
  // Mostra il WRAPPER
  const bilancioWrapper = document.getElementById('bilancioWrapper');
  if (bilancioWrapper) bilancioWrapper.style.display = 'block';
  
  // Salva solo calorieOrologio (non interferire con salvataggio pasti)
  userNeeds.calorieOrologio = calorieOrologio;
  if (typeof saveFabbisognoIndexed === 'function') saveFabbisognoIndexed();
}

function saveFabbisogno(){
  if(!userNeeds){
    alert('âš ï¸ Calcola prima il fabbisogno');
    return;
  }
  saveFabbisognoIndexed();
  
  if (typeof salvaTutto === 'function') {
    setTimeout(() => salvaTutto(), 100);
  }
  
  updateDailyTracking();
  toast('ðŸ’¾ Fabbisogno salvato');
}

function resetFabbisogno(){

  ['eta','pesoF','altezza'].forEach(id=>document.getElementById(id).value='');

  document.getElementById('risultatoFabbisogno').innerHTML='';

  toast('ðŸ§¹ Pulito');

}

 

function updateRecipeSelector(){

  const select = document.getElementById('pastoRicetta');

  select.innerHTML = '<option value="">Seleziona ricetta...</option>';

  recipes.forEach((r, idx) => {

    const opt = document.createElement('option');

    opt.value = idx;

    opt.textContent = `${r.nome} (${r.kcal} kcal)`;

    select.appendChild(opt);

  });

}

 

function getTodayKey(){

  return new Date().toISOString().slice(0,10);

}

 

function addMeal(){
  if(!userNeeds){
    alert('âš ï¸ Salva prima il fabbisogno');
    return;
  }

  const recipeIdx = document.getElementById('pastoRicetta').value;
  const porzioni = parseFloat(document.getElementById('porzioni').value) || 1;

  if(!recipeIdx){
    alert('âŒ Seleziona ricetta');
    return;
  }

  const recipe = recipes[recipeIdx];
  const today = getTodayKey();

  if(!dailyMeals[today]) dailyMeals[today] = [];

  dailyMeals[today].push({
    nome: recipe.nome,
    kcal: recipe.kcal * porzioni,
    prot: recipe.prot * porzioni,
    carb: recipe.carb * porzioni,
    fat: recipe.fat * porzioni,
    porzioni: porzioni,
    time: new Date().toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'})
  });

  updateDailyTracking();
  
  // ðŸ†• AGGIORNA DONUT CHART
  if(typeof updateDonutChart === 'function') updateDonutChart();
  
  toast(`âœ… ${recipe.nome} aggiunto`);

  saveMenuIndexed();
  
  if (document.getElementById('calorieOrologio').value) {
    calcolaConfrontoCalorie();
  }
  
  // Aggiorna Analisi Salute
  if (typeof aggiornaAnalisiSalute === 'function') aggiornaAnalisiSalute();
}

 
function updateDailyTracking(){

  document.getElementById('currentDate').textContent = new Date().toLocaleDateString('it-IT');

 

  const today = getTodayKey();

  const meals = dailyMeals[today] || [];

 

  const pastiContainer = document.getElementById('pastiOggi');

  pastiContainer.innerHTML = '';

 

  if(meals.length === 0){

    pastiContainer.innerHTML = '<div class="tiny">ðŸ“ Nessun pasto registrato</div>';

  } else {

    meals.forEach((meal, idx) => {

      const div = document.createElement('div');

      div.className = 'card';

      div.style.marginBottom = '6px';

      div.innerHTML = `

        <div style="display:flex;justify-content:space-between;align-items:center">

          <div>

            <strong>${meal.nome}</strong> ${meal.porzioni !== 1 ? `(${meal.porzioni}x)` : ''}

            <div class="tiny">ðŸ• ${meal.time} â€¢ ðŸ”¥ ${Math.round(meal.kcal)} kcal</div>

          </div>

          <button class="btn-ghost" onclick="removeMeal(${idx})" style="padding:4px 8px">ðŸ—‘ï¸</button>

        </div>

      `;

      pastiContainer.appendChild(div);

    });

  }

 

  if(userNeeds){

    const totals = meals.reduce((acc, m) => ({

      kcal: acc.kcal + m.kcal,

      prot: acc.prot + m.prot,

      carb: acc.carb + m.carb,

      fat: acc.fat + m.fat

    }), {kcal: 0, prot: 0, carb: 0, fat: 0});

   

    document.getElementById('kcalTarget').textContent = userNeeds.kcal;

    document.getElementById('protTarget').textContent = userNeeds.prot;

    document.getElementById('carbTarget').textContent = userNeeds.carb;

    document.getElementById('fatTarget').textContent = userNeeds.fat;

   

    document.getElementById('kcalProgress').textContent = Math.round(totals.kcal);

    document.getElementById('protProgress').textContent = Math.round(totals.prot);

    document.getElementById('carbProgress').textContent = Math.round(totals.carb);

    document.getElementById('fatProgress').textContent = Math.round(totals.fat);

   

    const kcalPct = Math.min((totals.kcal / userNeeds.kcal) * 100, 100);

    const protPct = Math.min((totals.prot / userNeeds.prot) * 100, 100);

    const carbPct = Math.min((totals.carb / userNeeds.carb) * 100, 100);

   

    document.getElementById('kcalBar').style.width = kcalPct + '%';

    document.getElementById('protBar').style.width = protPct + '%';

    document.getElementById('carbBar').style.width = carbPct + '%';

   

    const kcalCard = document.getElementById('kcalCard');

    const protCard = document.getElementById('protCard');

    const carbCard = document.getElementById('carbCard');

    const fatCard = document.getElementById('fatCard');

   

    [kcalCard, protCard, carbCard, fatCard].forEach(c => c.classList.remove('over', 'perfect'));

   

    if(totals.kcal > userNeeds.kcal * 1.1) kcalCard.classList.add('over');

    else if(totals.kcal >= userNeeds.kcal * 0.9) kcalCard.classList.add('perfect');

   

    if(totals.prot > userNeeds.prot * 1.2) protCard.classList.add('over');

    else if(totals.prot >= userNeeds.prot * 0.9) protCard.classList.add('perfect');

   

    if(totals.carb > userNeeds.carb * 1.2) carbCard.classList.add('over');

    else if(totals.carb >= userNeeds.carb * 0.9) carbCard.classList.add('perfect');

   

    if(totals.fat > userNeeds.fat * 1.2) fatCard.classList.add('over');

    else if(totals.fat >= userNeeds.fat * 0.9) fatCard.classList.add('perfect');

   

    generateSuggestions(totals);

  }

}

 

function generateSuggestions(totals){

  const suggestions = document.getElementById('suggestions');

  if(!userNeeds) return;

 

  const kcalLeft = userNeeds.kcal - totals.kcal;

  const protLeft = userNeeds.prot - totals.prot;

  const carbLeft = userNeeds.carb - totals.carb;

  const fatLeft = userNeeds.fat - totals.fat;

 

  let html = '<div class="card"><h4>ðŸ’¡ Suggerimenti Nutrizionali</h4>';

 

  if(kcalLeft > 200){

    html += `<div class="tiny">ðŸ”¥ Ti mancano ancora <strong>${Math.round(kcalLeft)} kcal</strong> per raggiungere il tuo obiettivo giornaliero.</div>`;

   

    const suitableRecipes = recipes.filter(r => r.kcal <= kcalLeft * 1.2 && r.kcal >= kcalLeft * 0.5).sort((a,b) => {

      const aScore = Math.abs((a.prot - protLeft)) + Math.abs((a.carb - carbLeft)) + Math.abs((a.fat - fatLeft));

      const bScore = Math.abs((b.prot - protLeft)) + Math.abs((b.carb - carbLeft)) + Math.abs((b.fat - fatLeft));

      return aScore - bScore;

    }).slice(0, 3);

   

    if(suitableRecipes.length > 0){

      html += '<div class="tiny" style="margin-top:8px"><strong>ðŸ½ï¸ Ricette consigliate:</strong><br>';

      suitableRecipes.forEach(r => {

        html += `â€¢ ${r.nome} (${r.kcal} kcal, ${r.prot}g P, ${r.carb}g C, ${r.fat}g F)<br>`;

      });

      html += '</div>';

    }

  } else if(kcalLeft < -200){

    html += `<div class="tiny">âš ï¸ Hai superato il tuo obiettivo di <strong>${Math.round(Math.abs(kcalLeft))} kcal</strong>. Considera di ridurre le porzioni nei prossimi pasti.</div>`;

  } else {

    html += '<div class="tiny success">ðŸŽ‰ Perfetto! Sei nel range ottimale del tuo obiettivo calorico!</div>';

  }

 

  // Suggerimenti sui macronutrienti

  if(protLeft > 20){

    html += `<div class="tiny" style="margin-top:6px">ðŸ’ª <strong>Proteine:</strong> Ti mancano ancora <strong>${Math.round(protLeft)}g</strong>. Considera alimenti come pollo, pesce, uova o legumi.</div>`;

  } else if(protLeft < -20){

    html += `<div class="tiny" style="margin-top:6px">ðŸ’ª <strong>Proteine:</strong> Hai superato di <strong>${Math.round(Math.abs(protLeft))}g</strong>. Va bene, le proteine in eccesso non sono un problema!</div>`;

  }

 

  if(carbLeft > 30){

    html += `<div class="tiny" style="margin-top:6px">ðŸž <strong>Carboidrati:</strong> Ti mancano <strong>${Math.round(carbLeft)}g</strong>. Considera pasta, riso, pane integrale o frutta.</div>`;

  } else if(carbLeft < -30){

    html += `<div class="tiny" style="margin-top:6px">ðŸž <strong>Carboidrati:</strong> Hai superato di <strong>${Math.round(Math.abs(carbLeft))}g</strong>. Riduci carboidrati nei prossimi pasti.</div>`;

  }

 

  if(fatLeft > 20){

    html += `<div class="tiny" style="margin-top:6px">ðŸ§ˆ <strong>Grassi:</strong> Ti mancano <strong>${Math.round(fatLeft)}g</strong>. Considera olio d'oliva, frutta secca, avocado o pesce grasso.</div>`;

  } else if(fatLeft < -20){

    html += `<div class="tiny" style="margin-top:6px">ðŸ§ˆ <strong>Grassi:</strong> Hai superato di <strong>${Math.round(Math.abs(fatLeft))}g</strong>. Riduci grassi nei prossimi pasti.</div>`;

  }

 

  // Consigli generali

  html += '<div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">';

  html += '<div class="tiny"><strong>ðŸ“ Consigli generali:</strong></div>';

 

  const now = new Date().getHours();

  if(now < 12 && kcalLeft > 500) {

    html += '<div class="tiny">â€¢ Ãˆ ancora mattina, hai tempo per distribuire bene le calorie nella giornata!</div>';

  } else if(now >= 12 && now < 18 && kcalLeft > 800) {

    html += '<div class="tiny">â€¢ Ãˆ pomeriggio, assicurati di fare un buon pranzo e spuntini.</div>';

  } else if(now >= 18 && kcalLeft > 400) {

    html += '<div class="tiny">â€¢ Ãˆ sera, fai una cena completa ma non troppo pesante.</div>';

  } else if(kcalLeft < 100 && kcalLeft > -100) {

    html += '<div class="tiny success">â€¢ ðŸŽ¯ Obiettivo praticamente raggiunto! Ottimo lavoro!</div>';

  }

 

  html += '</div></div>';

  suggestions.innerHTML = html;

}function generateSuggestions(totals){

  const suggestions = document.getElementById('suggestions');

  if(!userNeeds) return;

 

  const kcalLeft = userNeeds.kcal - totals.kcal;

  const protLeft = userNeeds.prot - totals.prot;

  const carbLeft = userNeeds.carb - totals.carb;

  const fatLeft = userNeeds.fat - totals.fat;

 

  let html = '<div class="card"><h4>ðŸ’¡ Suggerimenti Nutrizionali</h4>';

 

  if(kcalLeft > 200){

    html += `<div class="tiny">ðŸ”¥ Ti mancano ancora <strong>${Math.round(kcalLeft)} kcal</strong> per raggiungere il tuo obiettivo giornaliero.</div>`;

   

    const suitableRecipes = recipes.filter(r => r.kcal <= kcalLeft * 1.2 && r.kcal >= kcalLeft * 0.5).sort((a,b) => {

      const aScore = Math.abs((a.prot - protLeft)) + Math.abs((a.carb - carbLeft)) + Math.abs((a.fat - fatLeft));

      const bScore = Math.abs((b.prot - protLeft)) + Math.abs((b.carb - carbLeft)) + Math.abs((b.fat - fatLeft));

      return aScore - bScore;

    }).slice(0, 3);

   

    if(suitableRecipes.length > 0){

      html += '<div class="tiny" style="margin-top:8px"><strong>ðŸ½ï¸ Ricette consigliate:</strong><br>';

      suitableRecipes.forEach(r => {

        html += `â€¢ ${r.nome} (${r.kcal} kcal, ${r.prot}g P, ${r.carb}g C, ${r.fat}g F)<br>`;

      });

      html += '</div>';

    }

  } else if(kcalLeft < -200){

    html += `<div class="tiny">âš ï¸ Hai superato il tuo obiettivo di <strong>${Math.round(Math.abs(kcalLeft))} kcal</strong>. Considera di ridurre le porzioni nei prossimi pasti.</div>`;

  } else {

    html += '<div class="tiny success">ðŸŽ‰ Perfetto! Sei nel range ottimale del tuo obiettivo calorico!</div>';

  }

 

  if(protLeft > 20){

    html += `<div class="tiny" style="margin-top:6px">ðŸ’ª <strong>Proteine:</strong> Ti mancano ancora <strong>${Math.round(protLeft)}g</strong>. Considera alimenti come pollo, pesce, uova o legumi.</div>`;

  } else if(protLeft < -20){

    html += `<div class="tiny" style="margin-top:6px">ðŸ’ª <strong>Proteine:</strong> Hai superato di <strong>${Math.round(Math.abs(protLeft))}g</strong>. Va bene, le proteine in eccesso non sono un problema!</div>`;

  }

 

  if(carbLeft > 30){

    html += `<div class="tiny" style="margin-top:6px">ðŸž <strong>Carboidrati:</strong> Ti mancano <strong>${Math.round(carbLeft)}g</strong>. Considera pasta, riso, pane integrale o frutta.</div>`;

  } else if(carbLeft < -30){

    html += `<div class="tiny" style="margin-top:6px">ðŸž <strong>Carboidrati:</strong> Hai superato di <strong>${Math.round(Math.abs(carbLeft))}g</strong>. Riduci carboidrati nei prossimi pasti.</div>`;

  }

 

  if(fatLeft > 20){

    html += `<div class="tiny" style="margin-top:6px">ðŸ§ˆ <strong>Grassi:</strong> Ti mancano <strong>${Math.round(fatLeft)}g</strong>. Considera olio d'oliva, frutta secca, avocado o pesce grasso.</div>`;

  } else if(fatLeft < -20){

    html += `<div class="tiny" style="margin-top:6px">ðŸ§ˆ <strong>Grassi:</strong> Hai superato di <strong>${Math.round(Math.abs(fatLeft))}g</strong>. Riduci grassi nei prossimi pasti.</div>`;

  }

 

  html += '<div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">';

  html += '<div class="tiny"><strong>ðŸ“ Consigli generali:</strong></div>';

 

  const now = new Date().getHours();

  if(now < 12 && kcalLeft > 500) {

    html += '<div class="tiny">â€¢ Ãˆ ancora mattina, hai tempo per distribuire bene le calorie nella giornata!</div>';

  } else if(now >= 12 && now < 18 && kcalLeft > 800) {

    html += '<div class="tiny">â€¢ Ãˆ pomeriggio, assicurati di fare un buon pranzo e spuntini.</div>';

  } else if(now >= 18 && kcalLeft > 400) {

    html += '<div class="tiny">â€¢ Ãˆ sera, fai una cena completa ma non troppo pesante.</div>';

  } else if(kcalLeft < 100 && kcalLeft > -100) {

    html += '<div class="tiny success">â€¢ ðŸŽ¯ Obiettivo praticamente raggiunto! Ottimo lavoro!</div>';

  }

 

  html += '</div></div>';

  suggestions.innerHTML = html;

}

 

function removeMeal(idx){
  const today = getTodayKey();
  dailyMeals[today].splice(idx, 1);
  updateDailyTracking();
  
  // ðŸ†• AGGIORNA DONUT CHART
  if(typeof updateDonutChart === 'function') updateDonutChart();
  
  saveMenuIndexed();
  toast('ðŸ—‘ï¸ Pasto rimosso');
  
  if (document.getElementById('calorieOrologio').value) {
    calcolaConfrontoCalorie();
  }
}

 

function saveSettings(){

  const settings = {

    temp: document.getElementById('temp').value,

    umid: document.getElementById('umid').value,

    tempMin: document.getElementById('tempMin').value,

    tempMax: document.getElementById('tempMax').value,

    umidMin: document.getElementById('umidMin').value,

    umidMax: document.getElementById('umidMax').value,

    modalita: document.getElementById('modalitaFrigo').value,

    zona: document.getElementById('zonaFrigo').value,

    notifScadenza: document.getElementById('notifScadenza').checked,

    notifTemp: document.getElementById('notifTemp').checked,

    notifPasti: document.getElementById('notifPasti').checked

  };

 

  document.getElementById('curTemp').innerText = settings.temp + 'Â°C';

  document.getElementById('curUmid').innerText = settings.umid + '%';

 

  const modalitaText = {

    'eco': 'ðŸŒ± Eco',

    'normale': 'âš¡ Normale',

    'turbo': 'ðŸš€ Turbo',

    'vacanza': 'âœˆï¸ Vacanza'

  };

  document.getElementById('curMode').innerText = modalitaText[settings.modalita];

 

  document.getElementById('statoImpostazioni').innerHTML = '<span class="success">âœ… Impostazioni salvate con successo!</span>';

  setTimeout(() => {

    document.getElementById('statoImpostazioni').innerHTML = '';

  }, 3000);

 

  toast('ðŸ’¾ Tutte le impostazioni salvate');

}

 

function loadSettings(){

  document.getElementById('curTemp').innerText = '4Â°C';

  document.getElementById('curUmid').innerText = '60%';

  document.getElementById('curMode').innerText = 'âš¡ Normale';

}

 

function resetSettings(){

  if(!confirm('Ripristinare le impostazioni predefinite?')) return;

  document.getElementById('temp').value = '4';

  document.getElementById('umid').value = '60';

  document.getElementById('tempMin').value = '2';

  document.getElementById('tempMax').value = '8';

  document.getElementById('umidMin').value = '40';

  document.getElementById('umidMax').value = '80';

  document.getElementById('modalitaFrigo').value = 'normale';

  document.getElementById('zonaFrigo').value = 'generale';

  document.getElementById('notifScadenza').checked = true;

  document.getElementById('notifTemp').checked = true;

  document.getElementById('notifPasti').checked = true;

  loadSettings();

  toast('ðŸ”„ Impostazioni ripristinate');

}

 

function toggleDarkMode(){

  document.body.classList.toggle('dark-mode');

  const isDark = document.body.classList.contains('dark-mode');

  document.getElementById('currentTheme').textContent = isDark ? 'Tema Scuro' : 'Tema Chiaro';

  toast(isDark ? 'ðŸŒ™ Tema scuro' : 'â˜€ï¸ Tema chiaro');
                                                                                   const lightImg = document.getElementById("lightImage");
  const darkImg = document.getElementById("darkImage");

  if (document.body.classList.contains("dark-mode")) {
    lightImg.style.display = "none";
    darkImg.style.display = "block";
  } else {
    lightImg.style.display = "block";
    darkImg.style.display = "none";
  }

}

 

refreshList();

renderRecipes();

// generateMenu(); // Rimosso per evitare alert all'avvio

renderGrocery();

loadModel();

// Caricamento delle impostazioni salvate da IndexedDB
// loadSettings() rimossa perchÃ© sovrascriverebbe i dati salvati


const inputUtente = document.getElementById('inputUtente');
if (inputUtente) {
  inputUtente.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') handleAssist();
  });
}

document.getElementById('nuovoItemSpesa').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') addGroceryItem();
});

 

setTimeout(() => {

  updateStats();

  checkExpiry();

}, 500);

// Test funzionalitÃ  IndexedDB sul dispositivo (versione stabile)
window.addEventListener('load', () => {
  setTimeout(() => {
    try {
      const testRequest = indexedDB.open("FrigoSmartDB_Test");
      testRequest.onsuccess = function() {
        toast("ðŸ’¾ IndexedDB attivo sul dispositivo!");
        indexedDB.deleteDatabase("FrigoSmartDB_Test");
      };
      testRequest.onerror = function() {
        toast("âŒ IndexedDB non disponibile! I dati non verranno salvati.");
        console.error("IndexedDB non disponibile su questo dispositivo");
      };
    } catch (err) {
      toast("âŒ IndexedDB non supportato!");
      console.error("Errore durante il test IndexedDB:", err);
    }
  }, 3000); // piccolo ritardo per garantire che il toast sia pronto
});

 if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js')
    .then(reg => {
      console.log('âœ… Service Worker registrato');

      // Mostra l'avviso solo se il service worker nuovo Ã¨ in attesa di attivarsi
      if (reg.waiting) {
        if (confirm("ðŸ†• Nuova versione disponibile! Vuoi aggiornare?")) {
          reg.waiting.postMessage('skipWaiting');
          window.location.reload();
        }
      }

      // Quando viene rilevato un nuovo SW installato
      reg.addEventListener('updatefound', () => {
        const newWorker = reg.installing;
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            if (confirm("ðŸ†• Nuova versione disponibile! Vuoi aggiornare?")) {
              newWorker.postMessage('skipWaiting');
              window.location.reload();
            }
          }
        });
      });
    })
    .catch(err => console.error('âŒ Errore registrazione SW:', err));
}

console.log('ðŸŽ‰ Frigo Smart AI Ultra caricato con successo!');

console.log('â„¹ï¸ Se il modello AI non Ã¨ disponibile, verrÃ  usata la modalitÃ  simulata per i test.');

// Nascondi lo splash una volta che tutto Ã¨ pronto
window.addEventListener("load", () => {
  const splash = document.getElementById("app-splash");
  if (splash) {
    setTimeout(() => splash.classList.add("hidden-splash"), 800);
    setTimeout(() => splash.remove(), 1500);
  }
});

</script>

<script>
// === VERSIONE MIGLIORATA FRIGOSTORAGE con BACKUP AUTOMATICO (no conflitti) ===

// Chiave locale e costanti
const DB_NAME = 'FrigoApp';
const BACKUP_KEY = 'backupData';
let frigoDB = null;

// --- Inizializza IndexedDB e ripristina all'avvio ---
function initFrigoStorage() {
  const dbRequest = indexedDB.open(DB_NAME, 5);
  dbRequest.onupgradeneeded = event => {
    const database = event.target.result;
    // Assicurati che esistano entrambi gli store
    if (!database.objectStoreNames.contains('data')) {
      database.createObjectStore('data');
    }
    if (!database.objectStoreNames.contains('backups')) {
      database.createObjectStore('backups', { keyPath: 'ts' });
    }
  };

  dbRequest.onsuccess = event => {
    frigoDB = event.target.result;
    console.log('âœ… IndexedDB (FrigoApp) pronto');

    // Dopo apertura, tenta di ripristinare automaticamente
    restoreLastBackup();
    attivaAutoSave();
  };

  dbRequest.onerror = () => console.error('âŒ IndexedDB non disponibile');
}

// --- Salva tutto e crea backup ---
function salvaTutto() {
  const dati = {
    timestamp: Date.now(),
    fridge: window.fridge || [],
    recipes: window.recipes || [],
    groceryList: window.groceryList || [],
    shoppingList: window.shoppingList || [],
    mealPlan: window.mealPlan || [],
    mealTracking: window.mealTracking || [],
    dailyMeals: window.dailyMeals || {},
    userNeeds: window.userNeeds || null,
    voiceEnabled: window.voiceEnabled || false,
    audioEnabled: window.audioEnabled || false,
    darkMode: document.body.classList.contains('dark-mode')
  };

  if (!frigoDB) {
    console.warn('âš ï¸ IndexedDB non pronto, uso localStorage');
    localStorage.setItem(BACKUP_KEY, JSON.stringify(dati));
    return;
  }

  try {
    // 1ï¸âƒ£ Salva stato corrente (appData)
    const tx = frigoDB.transaction(['data'], 'readwrite');
    const store = tx.objectStore('data');
    store.put(dati, 'appData');

    // 2ï¸âƒ£ Crea un backup con timestamp unico (senza .catch)
    const tx2 = frigoDB.transaction(['backups'], 'readwrite');
    const bstore = tx2.objectStore('backups');
    const record = { ...dati, ts: Date.now() };

    // Usa i metodi di IndexedDB corretti
    const reqAdd = bstore.add(record);
    reqAdd.onerror = () => {
      // Se il record esiste giÃ , lo sostituisce
      bstore.put(record);
    };

    // 3ï¸âƒ£ Pulisce i backup vecchi (>50)
    tx2.oncomplete = () => {
      const MAX_BACKUPS = 50;
      const tx3 = frigoDB.transaction(['backups'], 'readwrite');
      const st3 = tx3.objectStore('backups');
      const req = st3.openCursor(null, 'prev');
      let count = 0;
      req.onsuccess = e => {
        const c = e.target.result;
        if (!c) return;
        count++;
        if (count > MAX_BACKUPS) {
          c.delete();
        }
        c.continue();
      };
    };

    console.log('ðŸ’¾ Dati salvati + backup creato');
  } catch (err) {
    console.error('âŒ Errore salvataggio:', err);
  }
}

// --- Ripristina automaticamente l'ultimo backup all'avvio ---
function restoreLastBackup() {
  if (!frigoDB) return;

  const tx = frigoDB.transaction(['backups'], 'readonly');
  const st = tx.objectStore('backups');
  const req = st.openCursor(null, 'prev'); // ultimo backup

  req.onsuccess = e => {
    const cursor = e.target.result;
    if (cursor && cursor.value) {
      const dati = cursor.value;
      applicaDati(dati);
      console.log('ðŸ”„ Ripristinato backup piÃ¹ recente', new Date(dati.ts).toLocaleString());
      forzaAggiornamentoUI();
    } else {
      // fallback: se non ci sono backup, prova con appData
      const tx2 = frigoDB.transaction(['data'], 'readonly');
      tx2.objectStore('data').get('appData').onsuccess = ev => {
        const dati = ev.target.result;
        if (dati) {
          applicaDati(dati);
          console.log('ðŸ”„ Ripristinati dati appData base');
          forzaAggiornamentoUI();
        } else {
          console.log('â„¹ï¸ Nessun dato da ripristinare');
        }
      };
    }
  };
}

// ðŸ” Forza aggiornamento completo della UI dopo il ripristino
function forzaAggiornamentoUI() {
  console.log('ðŸŽ¨ Aggiornamento interfaccia forzato dopo il ripristino...');
  const funzioniUI = [
    'refreshList',
    'renderRecipes',
    'renderMenu',
    'renderGrocery',
    'updateDailyTracking',
    'updateStats',
    'renderMealPlan',
    'updateRecipesUI',
    'renderFridge',
    'renderSettings'
  ];
  funzioniUI.forEach(fn => {
    if (typeof window[fn] === 'function') {
      try { window[fn](); } catch (e) {}
    }
  });
}

// --- Applica i dati caricati allo stato attuale ---
function applicaDati(dati) {
  if (!dati) return;
  window.fridge = dati.fridge || [];
  window.recipes = dati.recipes || [];
  window.groceryList = dati.groceryList || [];
  window.shoppingList = dati.shoppingList || [];
  window.mealPlan = dati.mealPlan || [];
  window.mealTracking = dati.mealTracking || [];
  window.dailyMeals = dati.dailyMeals || {};
  window.userNeeds = dati.userNeeds || null;
  window.voiceEnabled = dati.voiceEnabled || false;
  window.audioEnabled = dati.audioEnabled || false;
  
  if (dati.darkMode) document.body.classList.add('dark-mode');
  else document.body.classList.remove('dark-mode');
  
  // â¬‡ï¸ AGGIUNTO: Mostra i risultati del fabbisogno se esistono
  if (window.userNeeds) {
    setTimeout(() => {
      const out = document.getElementById('risultatoFabbisogno');
      if (out) {
        out.innerHTML = `
          <strong>ðŸ“Š Risultato:</strong><br>
          <div style="margin-top:8px">
            ðŸ”¥ BMR: <strong>${window.userNeeds.kcal} kcal</strong><br>
            âš¡ Fabbisogno: <strong>${window.userNeeds.kcal} kcal</strong>
          </div>
          <div style="margin-top:12px">
            <strong>ðŸ½ï¸ Macro consigliati:</strong><br>
            ðŸ’ª Proteine: <strong>${window.userNeeds.prot} g</strong><br>
            ðŸž Carboidrati: <strong>${window.userNeeds.carb} g</strong><br>
            ðŸ§ˆ Grassi: <strong>${window.userNeeds.fat} g</strong>
          </div>
        `;
        
        // Ripristina tipo di dieta
        if (window.userNeeds.tipoDieta) {
          const selectDieta = document.getElementById('tipoDieta');
          if (selectDieta) {
            selectDieta.value = window.userNeeds.tipoDieta;
            mostraDietaInfo();
          }
        }
        
        // Ripristina calorie orologio
        if (window.userNeeds.calorieOrologio) {
          const inputOrologio = document.getElementById('calorieOrologio');
          if (inputOrologio) {
            inputOrologio.value = window.userNeeds.calorieOrologio;
            document.getElementById('confrontoCalorie').style.display = 'block';
            calcolaConfrontoCalorie();
          }
        }
        
    // Ripristina i campi input del fabbisogno
        if (window.userNeeds.sesso) document.getElementById('sesso').value = window.userNeeds.sesso;
        if (window.userNeeds.eta) document.getElementById('eta').value = window.userNeeds.eta;
        if (window.userNeeds.peso) document.getElementById('pesoF').value = window.userNeeds.peso;
        if (window.userNeeds.altezza) document.getElementById('altezza').value = window.userNeeds.altezza;
        if (window.userNeeds.attivita) document.getElementById('attivita').value = window.userNeeds.attivita;
        if (window.userNeeds.obiettivo) document.getElementById('obiettivo').value = window.userNeeds.obiettivo;

        console.log('ðŸ“Š Risultati fabbisogno ripristinati nella UI');
      }
    }, 500); // piccolo ritardo per assicurarsi che il DOM sia pronto
  }
  
  // aggiorna UI se esistono funzioni
  if (typeof refreshList === 'function') refreshList();
  if (typeof renderMealPlan === 'function') renderMealPlan();
  if (typeof updateRecipesUI === 'function') updateRecipesUI();
  if (typeof updateDailyTracking === 'function') updateDailyTracking();
}

// --- AutoSave: ogni volta che cambia un dato ---
function attivaAutoSave() {
  // Salva ogni 10 secondi se ci sono modifiche
  let timer;
  const debouncedSave = () => {
    clearTimeout(timer);
    timer = setTimeout(salvaTutto, 3000);
  };

  // Intercetta cambi di storage e UI
  const osserva = ['click', 'change', 'input'];
  osserva.forEach(ev => document.addEventListener(ev, debouncedSave, true));

  // Fallback: salva quando si chiude
  window.addEventListener('beforeunload', salvaTutto);

  console.log('âš™ï¸ AutoSave + Backup automatico attivati');
}

// Avvio
window.addEventListener('load', initFrigoStorage);
</script>

<script>
// === ðŸ§  Super Auto Backup intelligente ===
window.addEventListener('load', () => {
  console.log('ðŸ§  Super Auto Backup Intelligente attivo');
  let ultimoSalvataggio = 0;
  let timer = null;
  
  function salvaConRitardo() {
    clearTimeout(timer);
    timer = setTimeout(() => {
      const ora = Date.now();
      if (ora - ultimoSalvataggio > 1000) {
        ultimoSalvataggio = ora;
        if (typeof salvaTutto === 'function') {
          try {
            salvaTutto();
            console.log('ðŸ’¾ Backup salvato automaticamente');
          } catch (e) {
            console.error('âŒ Errore nel backup automatico:', e);
          }
        }
      }
    }, 500);
  }
  
  // Ascolta tutti i click, input e tocchi
  ['click', 'input', 'change', 'touchend'].forEach(evento => {
    document.addEventListener(evento, ev => {
      const target = ev.target;
      if (target.closest('button, .btn, .card, input, select, textarea, [onclick], [data-action]')) {
        salvaConRitardo();
      }
    }, true);
  });
  
  // Salva quando l'app va in background o viene chiusa
  window.addEventListener('beforeunload', () => {
    if (typeof salvaTutto === 'function') salvaTutto();
  });
  
  document.addEventListener('visibilitychange', () => {
    if (document.hidden && typeof salvaTutto === 'function') salvaTutto();
  });
  
  // Ripristina stato audio all'avvio
  const autoSpeakBtn = document.getElementById('autoSpeakBtn');
  if (autoSpeakBtn) {
    autoSpeakBtn.textContent = autoSpeak ? 'ðŸ”Š Voce Auto ON' : 'ðŸ”‡ Voce Auto OFF';
    if (autoSpeak) {
      autoSpeakBtn.classList.add('btn-primary');
      autoSpeakBtn.classList.remove('btn-ghost');
    }
  }
  
  const muteBtn = document.getElementById('muteBtn');
  if (muteBtn) {
    muteBtn.textContent = isMuted ? 'ðŸ”‡ Audio OFF' : 'ðŸ”Š Audio ON';
    if (!isMuted) {
      muteBtn.classList.add('btn-primary');
      muteBtn.classList.remove('btn-ghost');
    }
  }
}); 

</script>

<script>
// === ðŸ§  Modulo di Backup Intelligente (verifica differenze reali) ===
// Evita salvataggi inutili e assicura che ogni modifica venga conservata esattamente come l'utente la lascia.

window.addEventListener('load', () => {
  console.log('ðŸ§© Backup Intelligente: controllo differenze attivo');

  // Mantiene una copia dellâ€™ultimo stato salvato
  let ultimoSnapshot = {};

  // Funzione per confrontare due oggetti in modo profondo
  function oggettiDiversi(a, b) {
    try {
      return JSON.stringify(a) !== JSON.stringify(b);
    } catch {
      return true;
    }
  }

  // Funzione che controlla se i dati sono cambiati
  function verificaCambiamenti() {
    if (typeof salvaTutto !== 'function') return;

    // Prepara il nuovo stato attuale dell'app
    const statoCorrente = {
      fridge: window.fridge || [],
      recipes: window.recipes || [],
      groceryList: window.groceryList || [],
      shoppingList: window.shoppingList || [],
      mealPlan: window.mealPlan || [],
      mealTracking: window.mealTracking || [],
      dailyMeals: window.dailyMeals || {},
      userNeeds: window.userNeeds || null,
      voiceEnabled: window.voiceEnabled || false,
      audioEnabled: window.audioEnabled || false,
      darkMode: document.body.classList.contains('dark-mode')
    };

    // Se Ã¨ la prima volta, crea il primo snapshot con timestamp
if (!ultimoSnapshot.timestamp) {
  ultimoSnapshot = { ...statoCorrente, timestamp: Date.now() };
  console.log('ðŸ“¦ Snapshot iniziale creato');
  return;
}

    // Se qualcosa Ã¨ cambiato rispetto allâ€™ultimo snapshot â†’ salva
    if (oggettiDiversi(statoCorrente, ultimoSnapshot)) {
      ultimoSnapshot = { ...statoCorrente, timestamp: Date.now() };
      try {
        salvaTutto();
        console.log('ðŸ’¾ Backup Intelligente: modifiche rilevate â†’ salvato');
      } catch (e) {
        console.error('âŒ Errore nel salvataggio intelligente:', e);
      }
    }
  }

  // Controlla ogni pochi secondi se qualcosa Ã¨ cambiato
  setInterval(verificaCambiamenti, 4000);

  // Controlla anche dopo ogni click/tocco (in sinergia col Super Auto Backup)
  ['click', 'input', 'change'].forEach(evt => {
    document.addEventListener(evt, () => {
      setTimeout(verificaCambiamenti, 800);
    }, true);
  });
});
  
  // ========================================
// ðŸ“Š CRONOLOGIA E GRAFICI
// ========================================

let currentChart = null;
let ricetteFiltroTipo = 'tutti';

// Renderizza grafico
function renderChart(tipo) {
  const canvas = document.getElementById('chartCalorie');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  const oggi = new Date();
  let giorni = tipo === 'settimana' ? 7 : tipo === 'mese' ? 30 : 90;
  
  const labels = [];
  const calorie = [];
  
  for (let i = giorni - 1; i >= 0; i--) {
    const data = new Date(oggi);
    data.setDate(data.getDate() - i);
    const dataStr = data.toISOString().split('T')[0];
    
    if (tipo === 'settimana') {
      labels.push(data.toLocaleDateString('it-IT', { weekday: 'short' }));
    } else {
      labels.push(data.getDate() + '/' + (data.getMonth() + 1));
    }
    
    const pasti = window.dailyMeals[dataStr] || [];
    let kcal = 0;
    pasti.forEach(p => kcal += p.kcal || 0);
    calorie.push(Math.round(kcal));
  }
  
  // Disegna grafico semplice
  const w = canvas.width = canvas.offsetWidth * 2;
  const h = canvas.height = 500;
  ctx.clearRect(0, 0, w, h);
  
  const maxCal = Math.max(...calorie, 100) * 1.1;
  const step = w / (labels.length - 1);
  
  // Linea
  ctx.strokeStyle = '#077fbf';
  ctx.lineWidth = 4;
  ctx.beginPath();
  
  calorie.forEach((cal, i) => {
    const x = i * step;
    const y = h - (cal / maxCal) * h;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();
  
  // Punti
  calorie.forEach((cal, i) => {
    const x = i * step;
    const y = h - (cal / maxCal) * h;
    ctx.fillStyle = '#077fbf';
    ctx.beginPath();
    ctx.arc(x, y, 6, 0, Math.PI * 2);
    ctx.fill();
  });
}

function switchChart(tipo) {
  document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + tipo).classList.add('active');
  renderChart(tipo);
}

// Renderizza cronologia
function renderCronologia() {
  const container = document.getElementById('cronologiaLista');
  if (!container) return;
  
  const items = [];
  const oggi = new Date();
  
  for (let i = 0; i < 90; i++) {
    const data = new Date(oggi);
    data.setDate(data.getDate() - i);
    const dataStr = data.toISOString().split('T')[0];
    const pasti = window.dailyMeals[dataStr];
    
    if (!pasti || pasti.length === 0) continue;
    
    let kcal = 0, prot = 0, carb = 0, fat = 0;
    pasti.forEach(p => {
      kcal += p.kcal || 0;
      prot += p.prot || 0;
      carb += p.carb || 0;
      fat += p.fat || 0;
    });
    
    items.push({
      data: data.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' }),
      pasti: pasti.length,
      kcal: Math.round(kcal),
      prot: Math.round(prot),
      carb: Math.round(carb),
      fat: Math.round(fat)
    });
  }
  
  if (items.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">ðŸ“­ Nessun dato</div>';
    return;
  }
  
  let html = '';
  items.forEach(item => {
    const target = window.userNeeds ? window.userNeeds.kcal : 2000;
    const perc = Math.round((item.kcal / target) * 100);
    
    html += `
      <div class="cronologia-item">
        <div class="cronologia-header">
          <div style="font-weight:700">ðŸ“… ${item.data}</div>
          <div class="chip">${perc}% obiettivo</div>
        </div>
        <div class="tiny">ðŸ½ï¸ ${item.pasti} pasti</div>
        <div class="cronologia-macros">
          <div style="text-align:center">
            <div style="font-size:18px;font-weight:700">ðŸ”¥ ${item.kcal}</div>
            <div class="tiny">kcal</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:18px;font-weight:700">ðŸ’ª ${item.prot}g</div>
            <div class="tiny">proteine</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:18px;font-weight:700">ðŸž ${item.carb}g</div>
            <div class="tiny">carboidrati</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:18px;font-weight:700">ðŸ§ˆ ${item.fat}g</div>
            <div class="tiny">grassi</div>
          </div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function filtraCronologia() {
  renderCronologia();
}

function resetFiltroCronologia() {
  document.getElementById('filtroDa').value = '';
  document.getElementById('filtroA').value = '';
  renderCronologia();
}

// Override show
const originalShow = window.show;
window.show = function(section) {
  originalShow(section);
  if (section === 'cronologia') {
    setTimeout(() => {
      renderCronologia();
      renderChart('settimana');
    }, 100);
  }
};

// ========================================
// ðŸ” RICERCA RICETTE
// ========================================

function filtraRicette() {
  const search = (document.getElementById('searchRicette')?.value || '').toLowerCase();
  const container = document.getElementById('listaRicette');
  if (!container) return;
  
  // Array di immagini di cibo per le ricette
  const foodImages = [
    'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1484723091739-30a097e8f929?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1473093295043-cdd812d0e601?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1493770348161-369560ae357d?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1476224203421-9ac39bcb3327?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1499028344343-cd173ffc68a9?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1432139555190-58524dae6a55?w=400&h=400&fit=crop'
  ];
  
  let ricetteFiltrate = recipes.filter(r => {
    if (ricetteFiltroTipo === 'veg' && !r.veg) return false;
    if (ricetteFiltroTipo === 'nonveg' && r.veg) return false;
    
    if (search) {
      const nomeMatch = r.nome.toLowerCase().includes(search);
      let ingMatch = false;
      if (Array.isArray(r.ingredienti)) {
        ingMatch = r.ingredienti.some(ing => ing.toLowerCase().includes(search));
      } else if (typeof r.ingredienti === 'string') {
        ingMatch = r.ingredienti.toLowerCase().includes(search);
      }
      return nomeMatch || ingMatch;
    }
    return true;
  });
  
  if (ricetteFiltrate.length === 0) {
    container.innerHTML = '<div class="ricette-book-empty"><p>Il tuo ricettario Ã¨ vuoto.</p></div>';
    return;
  }
  
  let html = '<div class="ricette-book-list">';
  
  ricetteFiltrate.forEach((r, index) => {
    const realIdx = recipes.indexOf(r);
    const isLast = index === ricetteFiltrate.length - 1;
    const isFav = r.preferito === true;
    
    // Usa immagine custom se presente, altrimenti genera da hash
    let imgUrl;
    if (r.immagine || r.customImage) {
      imgUrl = r.immagine || r.customImage;
    } else {
      const hashCode = r.nome.split('').reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a; }, 0);
      const imgIndex = Math.abs(hashCode) % foodImages.length;
      imgUrl = foodImages[imgIndex];
    }
    
    const leafIcon = r.veg ? `
      <svg class="ricette-book-row-leaf" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
        <path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 19.7 7.3 22 11c-2.3 3.7-6.5 6-12.2 5a7 7 0 0 0-3.8 4z"/>
      </svg>
    ` : '';
    
    const starFill = isFav ? 'currentColor' : 'none';
    const starClass = isFav ? 'ricette-book-row-star active' : 'ricette-book-row-star';
    
    html += `
      <div class="ricette-book-row" style="${isLast ? 'border-bottom:none;' : ''}" onclick="if(!event.target.closest('.ricette-book-row-star')) openRecipeModal(${realIdx})">
        <div class="ricette-book-row-img-wrap">
          <img src="${imgUrl}" alt="${r.nome}" class="ricette-book-row-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
          <div class="ricette-book-row-img-placeholder" style="display:none;">${r.veg ? 'ðŸ¥—' : 'ðŸ–'}</div>
        </div>
        
        <div class="ricette-book-row-content">
          <div class="ricette-book-row-header">
            <h3 class="ricette-book-row-name">${r.nome}</h3>
            ${leafIcon}
          </div>
          
          <div class="ricette-book-row-macros">
            <span class="ricette-book-row-kcal">${r.kcal || 0} kcal</span>
            <div class="ricette-book-row-macro-line">
              <span>${r.prot || 0}g P</span>
              <span>â€¢</span>
              <span>${r.fat || 0}g G</span>
              <span>â€¢</span>
              <span>${r.carb || 0}g C</span>
            </div>
          </div>
        </div>
        
        <button class="${starClass}" onclick="event.stopPropagation(); togglePreferito(${realIdx})">
          <svg viewBox="0 0 24 24" fill="${starFill}" stroke="currentColor" stroke-width="2">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
          </svg>
        </button>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

function filtraRicettePreferite() {
  const container = document.getElementById('listaRicette');
  if (!container) return;
  
  // Array di immagini di cibo per le ricette
  const foodImages = [
    'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1484723091739-30a097e8f929?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1473093295043-cdd812d0e601?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1493770348161-369560ae357d?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1476224203421-9ac39bcb3327?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1499028344343-cd173ffc68a9?w=400&h=400&fit=crop',
    'https://images.unsplash.com/photo-1432139555190-58524dae6a55?w=400&h=400&fit=crop'
  ];
  
  const preferite = recipes.filter(r => r.preferito === true);
  
  if (preferite.length === 0) {
    container.innerHTML = '<div class="ricette-book-empty"><p>â­ Nessuna ricetta preferita</p><p style="font-size:13px;margin-top:8px;">Aggiungi ricette ai preferiti dalla sezione Salvate</p></div>';
    return;
  }
  
  let html = '<div class="ricette-book-list">';
  
  preferite.forEach((r, index) => {
    const realIdx = recipes.indexOf(r);
    const isLast = index === preferite.length - 1;
    
    // Usa immagine custom se presente, altrimenti genera da hash
    let imgUrl;
    if (r.immagine || r.customImage) {
      imgUrl = r.immagine || r.customImage;
    } else {
      const hashCode = r.nome.split('').reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a; }, 0);
      const imgIndex = Math.abs(hashCode) % foodImages.length;
      imgUrl = foodImages[imgIndex];
    }
    
    const leafIcon = r.veg ? `
      <svg class="ricette-book-row-leaf" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
        <path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 19.7 7.3 22 11c-2.3 3.7-6.5 6-12.2 5a7 7 0 0 0-3.8 4z"/>
      </svg>
    ` : '';
    
    html += `
      <div class="ricette-book-row" style="${isLast ? 'border-bottom:none;' : ''}" onclick="if(!event.target.closest('.ricette-book-row-star')) openRecipeModal(${realIdx})">
        <div class="ricette-book-row-img-wrap">
          <img src="${imgUrl}" alt="${r.nome}" class="ricette-book-row-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
          <div class="ricette-book-row-img-placeholder" style="display:none;">${r.veg ? 'ðŸ¥—' : 'ðŸ–'}</div>
        </div>
        
        <div class="ricette-book-row-content">
          <div class="ricette-book-row-header">
            <h3 class="ricette-book-row-name">${r.nome}</h3>
            ${leafIcon}
          </div>
          
          <div class="ricette-book-row-macros">
            <span class="ricette-book-row-kcal">${r.kcal || 0} kcal</span>
            <div class="ricette-book-row-macro-line">
              <span>${r.prot || 0}g P</span>
              <span>â€¢</span>
              <span>${r.fat || 0}g G</span>
              <span>â€¢</span>
              <span>${r.carb || 0}g C</span>
            </div>
          </div>
        </div>
        
        <button class="ricette-book-row-star active" onclick="event.stopPropagation(); togglePreferito(${realIdx})">
          <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
          </svg>
        </button>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}


function filtroTipoRicetta(tipo) {
  ricetteFiltroTipo = tipo;
  document.querySelectorAll('.filter-badge').forEach(b => b.classList.remove('active'));
  document.getElementById('filtro-' + tipo).classList.add('active');
  filtraRicette();
}

function filtraRicettePasto() {
  const search = document.getElementById('searchPastoRicetta').value.toLowerCase();
  const select = document.getElementById('pastoRicetta');
  
  select.innerHTML = '<option value="">Seleziona...</option>';
  
  recipes.forEach((r, idx) => {
    if (search) {
      const match = r.nome.toLowerCase().includes(search) || 
                    r.ingredienti.some(i => i.toLowerCase().includes(search));
      if (!match) return;
    }
    
    const icon = r.veg ? 'ðŸŒ±' : 'ðŸ–';
    const opt = document.createElement('option');
    opt.value = idx;
    opt.textContent = `${icon} ${r.nome} (${r.kcal} kcal)`;
    select.appendChild(opt);
  });
}

// Inizializza
window.addEventListener('load', () => {
  setTimeout(() => {
    if (document.getElementById('listaRicette')) filtraRicette();
    if (document.getElementById('pastoRicetta')) filtraRicettePasto();
  }, 500);
});
 
  // ========================================
// ðŸ¤– GROQ AI INTEGRATION
// ========================================

let groqApiKey = null;

// Carica chiave all'avvio
function loadGroqKey() {
  const saved = localStorage.getItem('groqApiKey');
  if (saved) {
    groqApiKey = saved;
    const input = document.getElementById('groqApiKey');
    if (input) input.value = saved;
    updateGroqStatus('âœ… Chiave API caricata', 'var(--success)');
  }
}

// Salva chiave
function saveGroqKey() {
  const input = document.getElementById('groqApiKey');
  const key = input.value.trim();
  
  if (!key) {
    updateGroqStatus('âŒ Inserisci una chiave valida', 'var(--danger)');
    return;
  }
  
  if (!key.startsWith('gsk_')) {
    updateGroqStatus('âš ï¸ La chiave dovrebbe iniziare con gsk_', 'var(--danger)');
    return;
  }
  
  groqApiKey = key;
  localStorage.setItem('groqApiKey', key);
  updateGroqStatus('âœ… Chiave salvata con successo!', 'var(--success)');
  setTimeout(checkAIStatus, 100);
}

// Testa chiave
async function testGroqKey() {
  if (!groqApiKey) {
    updateGroqStatus('âŒ Prima salva la chiave', 'var(--danger)');
    return;
  }
  
  updateGroqStatus('ðŸ”„ Test in corso...', 'var(--accent)');
  
  try {
    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${groqApiKey}`
      },
      body: JSON.stringify({
        model: 'llama-3.1-8b-instant',
        messages: [{role: 'user', content: 'Ciao!'}],
        max_tokens: 10
      })
    });
    
    if (response.ok) {
      updateGroqStatus('âœ… Chiave valida! AI attiva!', 'var(--success)');
    } else {
      updateGroqStatus('âŒ Chiave non valida', 'var(--danger)');
    }
  } catch (error) {
    updateGroqStatus('âŒ Errore di connessione', 'var(--danger)');
  }
}

// Elimina chiave
function clearGroqKey() {
  groqApiKey = null;
  localStorage.removeItem('groqApiKey');
  document.getElementById('groqApiKey').value = '';
  updateGroqStatus('ðŸ—‘ï¸ Chiave eliminata', 'var(--muted)');
  setTimeout(checkAIStatus, 100);
}


// ========================================
// ðŸ”® GESTIONE CHIAVE REPLICATE AI
// ========================================

function saveReplicateKey() {
  const key = document.getElementById('replicateApiKey').value.trim();
  if (!key) {
    updateReplicateStatus('âŒ Inserisci una chiave valida', 'var(--danger)');
    return;
  }
  
  localStorage.setItem('replicateApiKey', key);
  updateReplicateStatus('âœ… Chiave salvata!', 'var(--success)');
}

function testReplicateKey() {
  const key = localStorage.getItem('replicateApiKey');
  if (!key) {
    updateReplicateStatus('âŒ Nessuna chiave salvata', 'var(--danger)');
    return;
  }
  
  updateReplicateStatus('ðŸ”„ Test in corso...', 'var(--accent)');
  
  // Test con un endpoint che supporta CORS
  fetch('https://api.replicate.com/v1/predictions', {
    method: 'POST',
    headers: { 
      'Authorization': `Bearer ${key}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      version: "test",
      input: {}
    })
  })
  .then(r => {
    if (r.status === 401) {
      updateReplicateStatus('âŒ Chiave non valida', 'var(--danger)');
    } else if (r.status === 422 || r.status === 400) {
      // Errore di validazione = chiave valida ma input sbagliato (normale)
      updateReplicateStatus('âœ… Chiave valida!', 'var(--success)');
    } else if (r.ok) {
      updateReplicateStatus('âœ… Chiave valida!', 'var(--success)');
    } else {
      updateReplicateStatus('âš ï¸ Test inconclusivo - Prova l\'analisi foto', 'var(--accent)');
    }
  })
  .catch((error) => {
    // CORS error o altro - suggerisci di provare direttamente
    if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
      updateReplicateStatus('âš ï¸ Impossibile testare in locale - Prova l\'analisi foto direttamente', 'var(--accent)');
    } else {
      updateReplicateStatus('âŒ Errore: ' + error.message, 'var(--danger)');
    }
  });
}

function clearReplicateKey() {
  localStorage.removeItem('replicateApiKey');
  document.getElementById('replicateApiKey').value = '';
  updateReplicateStatus('ðŸ—‘ï¸ Chiave eliminata', 'var(--muted)');
}

function toggleReplicateKeyVisibility() {
  const input = document.getElementById('replicateApiKey');
  input.type = input.type === 'password' ? 'text' : 'password';
}

function updateReplicateStatus(message, color) {
  const status = document.getElementById('replicateStatus');
  if (!status) return;
  status.textContent = message;
  status.style.color = color;
  status.style.background = color === 'var(--success)' ? 'rgba(34,197,94,0.1)' : 
                            color === 'var(--danger)' ? 'rgba(239,68,68,0.1)' : 'var(--input-bg)';
  status.style.borderLeft = `3px solid ${color}`;
}

// Carica chiave Replicate all'avvio
window.addEventListener('load', () => {
  setTimeout(() => {
    const savedReplicate = localStorage.getItem('replicateApiKey');
    const inputReplicate = document.getElementById('replicateApiKey');
    if (savedReplicate && inputReplicate) {
      inputReplicate.value = savedReplicate;
      updateReplicateStatus('âœ… Chiave caricata', 'var(--success)');
    }
  }, 500);
});

// Aggiorna status
function updateGroqStatus(message, color) {
  const status = document.getElementById('groqStatus');
  if (status) {
    status.textContent = message;
    status.style.color = color;
  }
}

// ========================================
// ðŸ§  AI LOCALE CON TRANSFORMERS.JS
// ========================================

let localAI = null;
let localAILoading = false;

// Inizializza AI locale
async function initLocalAI() {
  if (localAI || localAILoading) return localAI;
  
  localAILoading = true;
  
  try {
    console.log('ðŸ§  Caricamento AI locale...');
    const { pipeline } = window.transformers;
    localAI = await pipeline('text2text-generation', 'Xenova/LaMini-Flan-T5-783M');
    console.log('âœ… AI locale pronta!');
    return localAI;
  } catch (error) {
    console.error('âŒ Errore caricamento AI locale:', error);
    localAI = null;
    return null;
  } finally {
    localAILoading = false;
  }
}

// Usa AI locale per rispondere
async function handleLocalAI(userMsg, chat, robot) {
  try {
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'tiny';
    loadingDiv.style.marginBottom = '6px';
    loadingDiv.innerHTML = '<strong>ðŸ§  AI Locale:</strong> <em>Caricamento modello (solo la prima volta)...</em>';
    chat.appendChild(loadingDiv);
    chat.scrollTop = chat.scrollHeight;
    
    if (!localAI) await initLocalAI();
    
    if (!localAI) {
      chat.removeChild(loadingDiv);
      chat.innerHTML += `<div class="tiny alert">âš ï¸ AI locale non disponibile. Uso assistente base.</div>`;
      handleBasicAssist(userMsg, chat, robot);
      return;
    }
    
    loadingDiv.innerHTML = '<strong>ðŸ§  AI Locale:</strong> <em>Sto pensando...</em>';
    
    const prompt = buildLocalAIPrompt(userMsg);
    const result = await localAI(prompt, {
      max_length: 150,
      temperature: 0.7,
      top_p: 0.9,
      do_sample: true
    });
    
    let aiResponse = result[0].generated_text.replace(prompt, '').trim();
    
    chat.removeChild(loadingDiv);
    
    chat.innerHTML += `<div class="tiny" style="margin-bottom:6px;background:var(--input-bg);padding:8px;border-radius:8px;border-left:3px solid var(--accent)">
      <strong>ðŸ§  AI Locale:</strong> ${aiResponse}
    </div>`;
    chat.scrollTop = chat.scrollHeight;
    
    if (window.audioEnabled) speak(aiResponse);
    
    setTimeout(() => {
      robot.classList.remove('talking');
      setTimeout(() => robot.classList.remove('visible'), 500);
    }, 4000);
    
  } catch (error) {
    console.error('âŒ Errore AI locale:', error);
    chat.innerHTML += `<div class="tiny alert">âš ï¸ Errore AI locale. Uso assistente base.</div>`;
    handleBasicAssist(userMsg, chat, robot);
  }
}

// Costruisce prompt ottimizzato
function buildLocalAIPrompt(userMsg) {
  let prompt = `Tu sei un assistente nutrizionale. `;
  const lower = userMsg.toLowerCase();
  
  if (lower.includes('ricetta') || lower.includes('cucinare')) {
    if (recipes && recipes.length > 0) {
      const ricetteNomi = recipes.slice(0, 5).map(r => r.nome).join(', ');
      prompt += `Ho queste ricette: ${ricetteNomi}. `;
    }
    if (fridge && fridge.length > 0) {
      const ingredienti = fridge.slice(0, 5).map(f => f.nome).join(', ');
      prompt += `Nel frigo ho: ${ingredienti}. `;
    }
  }
  
  if (lower.includes('calorie') || lower.includes('kcal')) {
    if (window.userNeeds) {
      prompt += `Il mio fabbisogno Ã¨ ${window.userNeeds.kcal} kcal al giorno. `;
    }
  }
  
  prompt += `\n\nDomanda: ${userMsg}\n\nRisposta breve in italiano:`;
  return prompt;
}

// ========================================
// ðŸ”¥ FROSTY AI CHAT SYSTEM
// ========================================

let frostyState = {
    status: 'IDLE', // IDLE, LISTENING, THINKING, SPEAKING
    isTTSActive: false,
    messages: [],
    cameraStream: null,
    facingMode: 'environment',
    capturedImage: null
};

// Elementi DOM Frosty
const frostyEls = {
    container: document.getElementById('frosty-container'),
    messagesArea: document.getElementById('frosty-messages'),
    welcome: document.getElementById('frosty-welcome'),
    chatList: document.getElementById('frosty-chat-list'),
    input: document.getElementById('frosty-input'),
    sendBtn: document.getElementById('frosty-send-btn'),
    micBtn: document.getElementById('frosty-mic-btn'),
    cameraBtn: document.getElementById('frosty-camera-btn'),
    ttsBtn: document.getElementById('frosty-tts-btn'),
    orbCore: document.getElementById('frosty-orb-core'),
    orbGlow: document.getElementById('frosty-orb-glow'),
    orbStatus: document.getElementById('frosty-orb-status'),
    cameraModal: document.getElementById('frosty-camera-modal'),
    video: document.getElementById('frosty-video'),
    canvas: document.getElementById('frosty-canvas'),
    closeCameraBtn: document.getElementById('frosty-close-camera'),
    captureBtn: document.getElementById('frosty-capture-btn'),
    switchCameraBtn: document.getElementById('frosty-switch-camera')
};

// Update Orb Status
function updateFrostyOrb(status) {
    frostyState.status = status;
    const core = frostyEls.orbCore;
    const glow = frostyEls.orbGlow;
    const text = frostyEls.orbStatus;

    core.className = "orb-idle-frosty";
    glow.style.backgroundColor = '#06b6d4';
    let label = "Frosty AI";
    let color = '#06b6d4';

    switch (status) {
        case 'LISTENING':
            core.className = "orb-listening-frosty";
            glow.style.backgroundColor = '#f87171';
            label = "Ascolto...";
            color = '#f87171';
            break;
        case 'THINKING':
            core.className = "orb-idle-frosty";
            glow.style.backgroundColor = '#fbbf24';
            label = "Ragiono...";
            color = '#fbbf24';
            break;
        case 'SPEAKING':
            core.className = "orb-speaking-frosty";
            glow.style.backgroundColor = '#a855f7';
            label = "Parlo...";
            color = '#a855f7';
            break;
    }

    core.style.backgroundColor = color;
    glow.style.backgroundColor = color;
    text.textContent = label;
}

// Add Message to Chat
function addFrostyMessage(role, text, image = null) {
    const isUser = role === 'user';
    frostyState.messages.push({ role, text });

    // Show chat list
    frostyEls.welcome.style.display = 'none';
    frostyEls.chatList.style.display = 'flex';

    const div = document.createElement('div');
    div.style.cssText = `
        display: flex;
        width: 100%;
        justify-content: ${isUser ? 'flex-end' : 'flex-start'};
        animation: slideIn-frosty 0.3s ease-out forwards;
    `;

    const bubbleColor = isUser 
        ? 'background:rgba(168, 85, 247, 0.2);border:1px solid rgba(168, 85, 247, 0.3);border-bottom-right-radius:4px;'
        : 'background:rgba(6, 182, 212, 0.15);border:1px solid rgba(6, 182, 212, 0.3);border-bottom-left-radius:4px;';

    const avatarColor = isUser ? '#a855f7' : '#06b6d4';

    let imageHtml = '';
    if (image) {
        imageHtml = `<div style="margin-bottom:10px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.1);">
            <img src="${image}" style="width:100%;height:auto;max-height:200px;object-fit:cover;">
        </div>`;
    }

    let audioBtn = '';
    if (!isUser) {
        audioBtn = `
        <button onclick="playFrostyAudio('${text}')" style="margin-top:8px;display:flex;align-items:center;gap:6px;font-size:11px;color:#06b6d4;background:transparent;border:none;cursor:pointer;transition:all 0.3s;">
            <i class="fa-solid fa-play" style="font-size:10px;"></i> Ascolta
        </button>`;
    }

    div.innerHTML = `
        <div style="display:flex;max-width:85%;${isUser ? 'flex-direction:row-reverse;' : ''}gap:10px;align-items:flex-end;">
            <div style="width:32px;height:32px;border-radius:50%;background:${isUser ? avatarColor : 'linear-gradient(135deg, #06b6d4 0%, #0284c7 100%)'};display:flex;align-items:center;justify-content:center;flex-shrink:0;color:white;box-shadow:${isUser ? 'none' : '0 0 10px rgba(6,182,212,0.4)'};">
    ${isUser 
        ? '<i class="fa-solid fa-user" style="font-size:14px;"></i>' 
        : '<div style="display:flex;gap:4px;"><div style="width:4px;height:10px;background:rgba(255,255,255,0.95);border-radius:2px;"></div><div style="width:4px;height:10px;background:rgba(255,255,255,0.95);border-radius:2px;"></div></div>'
    }
</div>
            <div style="padding:12px 16px;border-radius:16px;${bubbleColor}">
                ${imageHtml}
                <p style="font-size:14px;line-height:1.5;color:#e2e8f0;margin:0;white-space:pre-wrap;">${text}</p>
                ${audioBtn}
            </div>
        </div>
    `;

    frostyEls.chatList.appendChild(div);
    frostyEls.messagesArea.scrollTop = frostyEls.messagesArea.scrollHeight;
}

// Send Message to Groq - CON TUTTE LE FUNZIONI ORIGINALI
async function sendFrostyMessage() {
    const text = frostyEls.input.value.trim();
    const image = frostyState.capturedImage;

    if ((!text && !image) || frostyState.status === 'THINKING') return;

    frostyEls.input.value = '';
    frostyState.capturedImage = null;
    updateFrostyOrb('THINKING');
    frostyEls.sendBtn.style.opacity = '0.5';

    addFrostyMessage('user', text, image);

    try {
        if (!groqApiKey) {
            addFrostyMessage('model', 'âŒ Chiave API Groq non configurata. Vai nelle Impostazioni!');
            updateFrostyOrb('IDLE');
            frostyEls.sendBtn.style.opacity = '1';
            return;
        }

        // PROMPT ORIGINALE MANTENUTO IDENTICO
        const systemPrompt = `Sei Frigo Smart AI, assistente intelligente per gestione alimentare.

HAI ACCESSO A:
${buildFrostyContext()}

REGOLE:
- Rispondi in italiano in modo amichevole e conciso
- Usa emoji appropriate
- Se ti chiedono ricette, suggerisci quelle disponibili
- Se ti chiedono cosa cucinare, usa gli ingredienti del frigo
- Dai consigli nutrizionali basati sul fabbisogno dell'utente
- Mantieni risposte brevi (max 100 parole)

COMANDI JSON (RISPONDI SOLO JSON quando appropriato):

Se l'utente dice "aggiungi [X] al frigo":
{"action":"add_to_fridge","items":[{"nome":"X","peso":200,"categoria":"Frutta","giorni":7}]}

Se l'utente dice "aggiungi [X] alla spesa":
{"action":"add_to_shopping","items":[{"nome":"X","quantita":"1"}]}

Se l'utente dice "ho mangiato [X]":
{"action":"log_meal","meal":{"nome":"X","kcal":500,"prot":25,"carb":60,"fat":15}}

Se l'utente dice "crea ricetta [X]":
{"action":"create_recipe","recipe":{"nome":"X","ingredienti":["ing1","ing2"],"kcal":450}}

âš ï¸ IMPORTANTE: Quando devi usare JSON, metti SOLO il JSON, senza testo prima o dopo`;

        const messages = [{
            role: 'system',
            content: systemPrompt
        }, {
            role: 'user',
            content: text || "Cosa vedi in questo frigo? Dammi ricette."
        }];

        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${groqApiKey}`
            },
            body: JSON.stringify({
                model: 'llama-3.1-8b-instant',
                messages: messages,
                temperature: 0.7,
                max_tokens: 800
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error?.message || 'Errore API');
        }

        const data = await response.json();
        let aiResponse = data.choices[0].message.content;

        // GESTISCI AZIONI JSON (IDENTICO ALL'ORIGINALE)
        try {
            const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
            
            if (jsonMatch) {
                const action = JSON.parse(jsonMatch[0]);
                console.log('âœ… Azione rilevata:', action);

                // AZIONE 1: Aggiungi al frigo
                if (action.action === 'add_to_fridge' && action.items) {
                    console.log('ðŸŽ Aggiungo al frigo:', action.items);
                    
                    if (!fridge) fridge = [];
                    
                    action.items.forEach(item => {
                        fridge.push({
                            nome: item.nome,
                            peso: item.peso || 100,
                            scadenza: nextDays(item.giorni || 7),
                            categoria: item.categoria || 'Generale'
                        });
                    });

                    if (typeof saveFridgeIndexed === 'function') saveFridgeIndexed();
                    if (typeof salvaTutto === 'function') salvaTutto();
                    if (typeof refreshList === 'function') {
                        setTimeout(() => refreshList(), 300);
                    }
                    
                    aiResponse = `âœ… Ho aggiunto ${action.items.map(i => i.nome).join(', ')} al frigo!`;
                }
                
                // AZIONE 2: Aggiungi alla spesa
                else if (action.action === 'add_to_shopping' && action.items) {
                    console.log('ðŸ›’ Aggiungo alla spesa:', action.items);
                    
                    if (!groceryList) groceryList = [];
                    
                    action.items.forEach(item => {
                        groceryList.push({
                            nome: item.nome || item,
                            quantita: item.quantita || '1',
                            acquistato: false,
                            timestamp: Date.now()
                        });
                    });

                    if (typeof saveGroceryIndexed === 'function') saveGroceryIndexed();
                    if (typeof salvaTutto === 'function') salvaTutto();
                    if (typeof renderGrocery === 'function') {
                        setTimeout(() => renderGrocery(), 300);
                    }
                    
                    const itemNames = action.items.map(i => typeof i === 'string' ? i : i.nome).join(', ');
                    aiResponse = `âœ… Ho aggiunto ${itemNames} alla lista della spesa!`;
                }
                
                // AZIONE 3: Registra pasto
                else if (action.action === 'log_meal' && action.meal) {
                    console.log('ðŸ½ï¸ Registro pasto:', action.meal);
                    
                    const today = new Date().toISOString().split('T')[0];
                    
                    if (!dailyMeals) dailyMeals = {};
                    if (!dailyMeals[today]) dailyMeals[today] = [];
                    
                    dailyMeals[today].push({
                        nome: action.meal.nome,
                        kcal: action.meal.kcal || 0,
                        prot: action.meal.prot || 0,
                        carb: action.meal.carb || 0,
                        fat: action.meal.fat || 0,
                        timestamp: new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })
                    });

                    localStorage.setItem('dailyMeals', JSON.stringify(dailyMeals));
                    if (typeof updateDailyTracking === 'function') {
                        setTimeout(() => updateDailyTracking(), 300);
                    }
                    
                    aiResponse = `âœ… Ho registrato "${action.meal.nome}" nel tracking di oggi!`;
                }
                
                // AZIONE 4: Crea ricetta
                else if (action.action === 'create_recipe' && action.recipe) {
                    console.log('ðŸ“– Creo ricetta:', action.recipe);
                    
                    if (!recipes) recipes = [];
                    
                    const newRecipe = {
                        nome: action.recipe.nome,
                        ingredienti: action.recipe.ingredienti || [],
                        kcal: action.recipe.kcal || 0,
                        prot: action.recipe.prot || 0,
                        carb: action.recipe.carb || 0,
                        fat: action.recipe.fat || 0,
                        veg: action.recipe.veg || false
                    };
                    
                    recipes.push(newRecipe);
                    
                    if (typeof saveRecipeIndexed === 'function') saveRecipeIndexed();
                    if (typeof salvaTutto === 'function') salvaTutto();
                    if (typeof renderRecipes === 'function') {
                        setTimeout(() => renderRecipes(), 300);
                    }
                    
                    aiResponse = `âœ… Ricetta "${action.recipe.nome}" creata con successo!`;
                }
            }
        } catch (e) {
            console.log('âš ï¸ Risposta non-azione (normale)');
        }

        addFrostyMessage('model', aiResponse);
        updateFrostyOrb('IDLE');

        if (frostyState.isTTSActive) {
            playFrostyAudio(aiResponse);
        }

    } catch (error) {
        console.error('Frosty Error:', error);
        addFrostyMessage('model', 'âŒ Errore: ' + error.message);
        updateFrostyOrb('IDLE');
    } finally {
        frostyEls.sendBtn.style.opacity = '1';
    }
}

// Helper per contesto Frosty
function buildFrostyContext() {
    let context = '';
    
    if (fridge && fridge.length > 0) {
        context += `\nðŸ“¦ FRIGO (${fridge.length} alimenti):\n`;
        fridge.slice(0, 10).forEach(item => {
            context += `- ${item.nome} (${item.peso}g)\n`;
        });
    }
    
    if (recipes && recipes.length > 0) {
        context += `\nðŸ“– RICETTE (${recipes.length}):\n`;
        recipes.slice(0, 10).forEach(r => {
            context += `- ${r.nome} (${r.kcal} kcal)\n`;
        });
    }
    
    if (window.userNeeds) {
        context += `\nðŸ’ª FABBISOGNO:\n`;
        context += `- Calorie: ${window.userNeeds.kcal} kcal/giorno\n`;
        context += `- Proteine: ${window.userNeeds.prot}g\n`;
    }
    
    return context || 'Nessun dato disponibile';
}

// TTS - Play Audio
async function playFrostyAudio(text) {
    try {
        updateFrostyOrb('SPEAKING');
        
        // Rimuovi emoji dal testo
        text = text.replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F600}-\u{1F64F}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{1F900}-\u{1F9FF}]|[\u{1FA00}-\u{1FA6F}]|[\u{1FA70}-\u{1FAFF}]|[\u{231A}-\u{231B}]|[\u{23E9}-\u{23F3}]|[\u{23F8}-\u{23FA}]|[\u{25AA}-\u{25AB}]|[\u{25B6}]|[\u{25C0}]|[\u{25FB}-\u{25FE}]|[\u{2614}-\u{2615}]|[\u{2648}-\u{2653}]|[\u{267F}]|[\u{2693}]|[\u{26A1}]|[\u{26AA}-\u{26AB}]|[\u{26BD}-\u{26BE}]|[\u{26C4}-\u{26C5}]|[\u{26CE}]|[\u{26D4}]|[\u{26EA}]|[\u{26F2}-\u{26F3}]|[\u{26F5}]|[\u{26FA}]|[\u{26FD}]|[\u{2702}]|[\u{2705}]|[\u{2708}-\u{270D}]|[\u{270F}]|[\u{2712}]|[\u{2714}]|[\u{2716}]|[\u{271D}]|[\u{2721}]|[\u{2728}]|[\u{2733}-\u{2734}]|[\u{2744}]|[\u{2747}]|[\u{274C}]|[\u{274E}]|[\u{2753}-\u{2755}]|[\u{2757}]|[\u{2763}-\u{2764}]|[\u{2795}-\u{2797}]|[\u{27A1}]|[\u{27B0}]|[\u{27BF}]|[\u{2934}-\u{2935}]|[\u{2B05}-\u{2B07}]|[\u{2B1B}-\u{2B1C}]|[\u{2B50}]|[\u{2B55}]|[\u{3030}]|[\u{303D}]|[\u{3297}]|[\u{3299}]/gu, '').trim();
        
        if ('speechSynthesis' in window) {
            // Cancella eventuali audio in corso
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'it-IT';
            
            // Cerca la voce migliore disponibile
            const voices = window.speechSynthesis.getVoices();
            const preferredVoices = [
                'Google italiano',
                'Microsoft Elsa',
                'Microsoft Isabella',
                'Elsa',
                'Isabella',
                'Alice',
                'Federica',
                'Luca'
            ];
            
            let bestVoice = null;
            
            // Prima cerca le voci preferite
            for (const preferred of preferredVoices) {
                bestVoice = voices.find(v => 
                    v.name.toLowerCase().includes(preferred.toLowerCase()) && 
                    v.lang.includes('it')
                );
                if (bestVoice) break;
            }
            
            // Se non trova, prendi qualsiasi voce italiana
            if (!bestVoice) {
                bestVoice = voices.find(v => v.lang.includes('it'));
            }
            
            // Usa voce selezionata o cerca la migliore
if (selectedVoice) {
    utterance.voice = selectedVoice;
} else if (bestVoice) {
    utterance.voice = bestVoice;
}
            
            // Parametri per voce piÃ¹ naturale
            utterance.rate = 1.0;      // VelocitÃ  normale
            utterance.pitch = 1.1;     // Tono leggermente piÃ¹ alto (piÃ¹ femminile/amichevole)
            utterance.volume = 1.0;    // Volume massimo
            
            utterance.onend = () => updateFrostyOrb('IDLE');
            utterance.onerror = () => updateFrostyOrb('IDLE');
            
            window.speechSynthesis.speak(utterance);
        } else {
            updateFrostyOrb('IDLE');
        }
    } catch (error) {
        console.error('TTS Error:', error);
        updateFrostyOrb('IDLE');
    }
}

// Carica le voci quando disponibili
if ('speechSynthesis' in window) {
    window.speechSynthesis.onvoiceschanged = () => {
        window.speechSynthesis.getVoices();
    };
}

// Speech Recognition
function startFrostyListening() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('Browser non supportato per comandi vocali');
        return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'it-IT';
    recognition.interimResults = false;

      updateFrostyOrb('LISTENING');
    const micBtnEl = document.getElementById('frosty-mic-btn');
    if (micBtnEl) {
           micBtnEl.style.transition = 'all 0.3s ease';
           micBtnEl.style.color = '#f87171';
           micBtnEl.style.background = 'rgba(248, 113, 113, 0.2)';
           micBtnEl.style.boxShadow = '0 0 15px rgba(248,113,113,0.5)';
           micBtnEl.classList.add('mic-recording');
     }

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        frostyEls.input.value = transcript;
    };

    recognition.onend = () => {
        updateFrostyOrb('IDLE');
        const micBtnEl = document.getElementById('frosty-mic-btn');
if (micBtnEl) {
    micBtnEl.style.transition = 'all 0.4s ease';
    micBtnEl.style.color = '#94a3b8';
    micBtnEl.style.background = 'transparent';
    micBtnEl.style.boxShadow = 'none';
    micBtnEl.classList.remove('mic-recording');
}
    };

    recognition.onerror = () => {
        updateFrostyOrb('IDLE');
        const micBtnEl = document.getElementById('frosty-mic-btn');
if (micBtnEl) {
    micBtnEl.style.transition = 'all 0.4s ease';
    micBtnEl.style.color = '#94a3b8';
    micBtnEl.style.background = 'transparent';
    micBtnEl.style.boxShadow = 'none';
    micBtnEl.classList.remove('mic-recording');
}
    };

    recognition.start();
}

// Camera Functions
async function openFrostyCamera() {
    // Controlla se Ã¨ mobile
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        // Mobile: usa fotocamera nativa
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.capture = 'environment';
        
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    frostyState.capturedImage = event.target.result;
                    addFrostyMessage('user', 'ðŸ“¸ Foto scattata', event.target.result);
                    updateSendButton();
                };
                reader.readAsDataURL(file);
            }
        };
        
        input.click();
    } else {
        // PC: usa il modale con webcam
        frostyEls.cameraModal.style.display = 'flex';
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: frostyState.facingMode }
            });
            frostyState.cameraStream = stream;
            frostyEls.video.srcObject = stream;
        } catch (err) {
            alert('Errore accesso fotocamera: ' + err.message);
            closeFrostyCamera();
        }
    }
}

function closeFrostyCamera() {
    frostyEls.cameraModal.style.display = 'none';
    if (frostyState.cameraStream) {
        frostyState.cameraStream.getTracks().forEach(track => track.stop());
        frostyState.cameraStream = null;
    }
}

function captureFrostyPhoto() {
    const canvas = frostyEls.canvas;
    const video = frostyEls.video;
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);

    frostyState.capturedImage = canvas.toDataURL('image/jpeg');
    
    // Mostra preview
    addFrostyMessage('user', 'ðŸ“¸ Foto scansionata', frostyState.capturedImage);
    
    closeFrostyCamera();
    
    // Auto-invia il messaggio con la foto
    setTimeout(() => {
        frostyEls.input.value = 'Analizza questa foto del frigo';
        sendFrostyMessage();
    }, 300);
}

function switchFrostyCamera() {
    frostyState.facingMode = frostyState.facingMode === 'user' ? 'environment' : 'user';
    if (frostyState.cameraStream) {
        frostyState.cameraStream.getTracks().forEach(track => track.stop());
    }
    openFrostyCamera();
}

// Event Listeners Frosty
// Send Button
frostyEls.sendBtn?.addEventListener('click', sendFrostyMessage);

// Input
frostyEls.input?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendFrostyMessage();
});

// Input bar animazione focus (solo glow interno)
const frostyInputEl = document.getElementById('frosty-input');
frostyInputEl?.addEventListener('focus', function() {
    const container = this.parentElement;
    if (container) {
        container.style.transition = 'all 0.3s ease';
        container.style.boxShadow = 'inset 0 0 15px rgba(6,182,212,0.05)';
    }
});

frostyInputEl?.addEventListener('blur', function() {
    const container = this.parentElement;
    if (container) {
        container.style.transition = 'all 0.3s ease';
        container.style.boxShadow = 'none';
    }
});

// Controlla input per abilitare/disabilitare bottone invia
const frostyInput = document.getElementById('frosty-input');
const frostySendBtn = document.getElementById('frosty-send-btn');

function updateSendButton() {
    const hasText = frostyInput && frostyInput.value.trim().length > 0;
    const hasImage = frostyState && frostyState.capturedImage;
    
    if (frostySendBtn) {
        if (hasText || hasImage) {
            // ACCESO - Nebulosa
            frostySendBtn.disabled = false;
            frostySendBtn.classList.add('active');
            frostySendBtn.style.cursor = 'pointer';
        } else {
            // SPENTO
            frostySendBtn.disabled = true;
            frostySendBtn.classList.remove('active');
            frostySendBtn.style.background = 'rgba(100, 116, 139, 0.3)';
            frostySendBtn.style.color = 'rgba(255, 255, 255, 0.3)';
            frostySendBtn.style.cursor = 'not-allowed';
            frostySendBtn.style.boxShadow = 'none';
        }
    }
}

frostyInput?.addEventListener('input', updateSendButton);
updateSendButton();

// Menu 3 puntini
function toggleFrostyMenu() {
    const popup = document.getElementById('frosty-menu-popup');
    if (popup) {
        popup.style.display = popup.style.display === 'none' ? 'block' : 'none';
    }
}

// Chiudi menu se clicchi fuori
document.addEventListener('click', function(e) {
    const menuBtn = document.getElementById('frosty-menu-btn');
    const popup = document.getElementById('frosty-menu-popup');
    if (popup && menuBtn && !menuBtn.contains(e.target) && !popup.contains(e.target)) {
        popup.style.display = 'none';
    }
});

// Funzioni placeholder per file e immagine
function addFrostyFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.pdf,.doc,.docx,.txt';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            addFrostyMessage('user', `ðŸ“Ž File: ${file.name}`);
            toggleFrostyMenu();
        }
    };
    input.click();
}

function addFrostyImage() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                frostyState.capturedImage = event.target.result;
                addFrostyMessage('user', 'ðŸ–¼ï¸ Immagine caricata', event.target.result);
                updateSendButton();
                toggleFrostyMenu();
            };
            reader.readAsDataURL(file);
        }
    };
    input.click();
}

// Voce selezionata
let selectedVoice = null;

// Apri selettore voce
function openVoiceSelector() {
    toggleFrostyMenu();
    const modal = document.getElementById('frosty-voice-modal');
    const list = document.getElementById('frosty-voice-list');
    
    if (modal && list) {
        modal.style.display = 'flex';
        
        // Ottieni voci disponibili
        const voices = window.speechSynthesis.getVoices();
        const italianVoices = voices.filter(v => v.lang.includes('it'));
        
        list.innerHTML = '';
        
        if (italianVoices.length === 0) {
            list.innerHTML = '<p style="color:#94a3b8;font-size:13px;">Nessuna voce italiana trovata</p>';
            return;
        }
        
        italianVoices.forEach((voice, i) => {
            const isSelected = selectedVoice && selectedVoice.name === voice.name;
            const btn = document.createElement('button');
            btn.style.cssText = `
                width:100%;
                padding:12px;
                background:${isSelected ? 'rgba(6,182,212,0.2)' : 'rgba(255,255,255,0.05)'};
                border:1px solid ${isSelected ? 'rgba(6,182,212,0.5)' : 'transparent'};
                color:#e2e8f0;
                font-size:13px;
                text-align:left;
                cursor:pointer;
                border-radius:10px;
                transition:all 0.2s;
            `;
            btn.innerHTML = `
                <div style="font-weight:500;">${voice.name}</div>
                <div style="font-size:11px;color:#94a3b8;margin-top:2px;">${voice.lang}</div>
            `;
            btn.onclick = () => selectVoice(voice);
            list.appendChild(btn);
        });
    }
}

// Chiudi selettore voce
function closeVoiceSelector() {
    const modal = document.getElementById('frosty-voice-modal');
    if (modal) modal.style.display = 'none';
}

// Seleziona voce
function selectVoice(voice) {
    selectedVoice = voice;
    closeVoiceSelector();
    
    // Test voce
    const utterance = new SpeechSynthesisUtterance('Ciao, sono la tua nuova voce!');
    utterance.voice = voice;
    utterance.lang = 'it-IT';
    utterance.rate = 1.0;
    utterance.pitch = 1.1;
    window.speechSynthesis.speak(utterance);
}

// Camera Button con animazione
const camBtn = document.getElementById('frosty-camera-btn');
camBtn?.addEventListener('click', function() {
    // Animazione flash al click
    this.style.transition = 'all 0.15s ease';
    this.style.color = '#67e8f9';
    this.style.background = 'rgba(34,211,238,0.2)';
    
    setTimeout(() => {
        this.style.transition = 'all 0.4s ease';
        this.style.color = '#22d3ee';
        this.style.background = 'transparent';
    }, 200);
});

frostyEls.closeCameraBtn?.addEventListener('click', closeFrostyCamera);
frostyEls.captureBtn?.addEventListener('click', captureFrostyPhoto);
frostyEls.switchCameraBtn?.addEventListener('click', switchFrostyCamera);

// TTS Button - Header (quello in alto)
const frostyTtsBtnHeader = document.getElementById('frosty-tts-btn-header');
frostyTtsBtnHeader?.addEventListener('click', () => {
    frostyState.isTTSActive = !frostyState.isTTSActive;
    updateTTSButtons();
});

// Funzione per aggiornare ENTRAMBI i bottoni
function updateTTSButtons() {
    const svgOn = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
      </svg>`;
    
    const svgOff = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
        <line x1="23" y1="9" x2="17" y2="15"></line>
        <line x1="17" y1="9" x2="23" y2="15"></line>
      </svg>`;
    
    const svg = frostyState.isTTSActive ? svgOn : svgOff;
    
    // Aggiorna bottone in basso
    if (frostyEls.ttsBtn) {
        const color = frostyState.isTTSActive ? '#06b6d4' : '#64748b';
        const bgColor = frostyState.isTTSActive ? 'rgba(6, 182, 212, 0.15)' : 'rgba(30,41,59,0.6)';
        frostyEls.ttsBtn.style.color = color;
        frostyEls.ttsBtn.style.background = bgColor;
        frostyEls.ttsBtn.innerHTML = svg;
    }
    
    // Aggiorna bottone in alto con effetto candela
    const frostyTtsBtnHeader = document.getElementById('frosty-tts-btn-header');
    if (frostyTtsBtnHeader) {
        frostyTtsBtnHeader.style.transition = 'color 0.6s ease, background 0.6s ease';
        
        if (frostyState.isTTSActive) {
            frostyTtsBtnHeader.style.color = '#06b6d4';
            frostyTtsBtnHeader.style.background = 'rgba(6, 182, 212, 0.15)';
        } else {
            frostyTtsBtnHeader.style.color = '#64748b';
            frostyTtsBtnHeader.style.background = '#1e293b';
        }
        frostyTtsBtnHeader.innerHTML = svg;
    }
}

// Inizializza i bottoni al caricamento
updateTTSButtons();
  
  // Reset Frosty Chat (quando entri in sezione assistente)
function resetFrostyChat() {
    frostyState.messages = [];
    frostyState.status = 'IDLE';
    frostyState.capturedImage = null;
    frostyEls.input.value = '';
    frostyEls.chatList.innerHTML = '';
    frostyEls.welcome.style.display = 'flex';
    frostyEls.chatList.style.display = 'none';
    updateFrostyOrb('IDLE');
    updateTTSButtons();
}

// ========================================
// FIN FROSTY AI CHAT SYSTEM
// ========================================

// ========================================
// ðŸ¤– ASSISTENTE AI POTENZIATO
// ========================================

async function handleAssist() {
  const input = document.getElementById('inputUtente');
  const chatHistory = document.getElementById('chat');
  const question = input.value.trim();
  
  if (!question) {
    if (typeof toast === 'function') toast('âš ï¸ Scrivi una domanda!');
    return;
  }
  
  if (!groqApiKey) {
    alert('âš ï¸ Configura la chiave Groq nelle Impostazioni!');
    show('impostazioni');
    return;
  }
  
  const userMsg = document.createElement('div');
  userMsg.className = 'chat-message user';
  userMsg.innerHTML = `<strong>Tu:</strong> ${question}`;
  chatHistory.appendChild(userMsg);
  
  input.value = '';
  chatHistory.scrollTop = chatHistory.scrollHeight;
  
  const loadingMsg = document.createElement('div');
  loadingMsg.className = 'chat-message assistant';
  loadingMsg.innerHTML = '<strong>Frigo Smart AI:</strong> <span class="loading">Sto pensando...</span>';
  chatHistory.appendChild(loadingMsg);
  chatHistory.scrollTop = chatHistory.scrollHeight;
  
  try {
    const systemPrompt = `Sei Frigo Smart AI, assistente intelligente per gestione alimentare.

ðŸŽ¯ REGOLE IMPORTANTI:
1. DEVI rispondere in formato JSON quando l'utente vuole aggiungere qualcosa
2. Per conversazioni normali, rispondi in modo naturale
3. Usa emoji con moderazione

ðŸ’¬ COMANDI CHE ATTIVANO JSON:

Se l'utente dice "aggiungi [X] al frigo" o "metti [X] nel frigo":
DEVI rispondere SOLO con questo JSON (niente altro testo):
{
  "action": "add_to_fridge",
  "items": [{"nome": "X", "peso": 200, "categoria": "Frutta", "giorni": 7}]
}

Se l'utente dice "aggiungi [X] alla spesa" o "metti [X] nella lista":
DEVI rispondere SOLO con questo JSON:
{
  "action": "add_to_shopping",
  "items": [{"nome": "X", "quantita": "1"}]
}

Se l'utente dice "ho mangiato [X]" o "ho consumato [X]":
DEVI rispondere SOLO con questo JSON:
{
  "action": "log_meal",
  "meal": {"nome": "X", "kcal": 500, "prot": 25, "carb": 60, "fat": 15}
}

Se l'utente dice "crea ricetta [X]":
DEVI rispondere SOLO con questo JSON:
{
  "action": "create_recipe",
  "recipe": {
    "nome": "X",
    "ingredienti": ["ing1", "ing2"],
    "procedimento": "Passaggi della ricetta",
    "categoria": "Primi",
    "tempo": 30,
    "porzioni": 4,
    "kcal": 450
  }
}

âš ï¸ IMPORTANTE:
- Quando devi usare JSON, metti SOLO il JSON, senza testo prima o dopo
- Per conversazioni normali (es: "quante calorie ha una mela?"), rispondi in modo naturale
- Stima valori realistici per peso, calorie, macro

Esempi:
User: "Aggiungi 3 mele al frigo"
Assistant: {"action":"add_to_fridge","items":[{"nome":"Mela","peso":150,"categoria":"Frutta","giorni":7}]}

User: "Quante calorie ha una banana?"
Assistant: Una banana media (circa 120g) contiene circa 105 calorie. Ãˆ ricca di potassio e ottima come snack pre-workout!`;

    const messages = [{ role: 'system', content: systemPrompt }];
    
    const recentMessages = Array.from(chatHistory.children)
      .filter(msg => msg.classList.contains('chat-message'))
      .slice(-10);
    
    recentMessages.forEach(msg => {
      const isUser = msg.classList.contains('user');
      const text = msg.textContent.replace(/^(Tu:|Frigo Smart AI:)/, '').trim();
      if (text && text !== 'Sto pensando...') {
        messages.push({
          role: isUser ? 'user' : 'assistant',
          content: text
        });
      }
    });
    
    messages.push({ role: 'user', content: question });
    
    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${groqApiKey}`
      },
      body: JSON.stringify({
        model: 'llama-3.1-8b-instant',
        messages: messages,
        temperature: 0.7,
        max_tokens: 800,
        top_p: 0.9
      })
    });
    
    if (!response.ok) {
      throw new Error(`Groq Error: ${response.status}`);
    }
    
    const data = await response.json();
    let aiResponse = data.choices[0].message.content;
    
    console.log('ðŸ¤– Risposta AI:', aiResponse);
    
    // ========================================
// GESTISCI AZIONI JSON
// ========================================
try {
  const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
  
  if (jsonMatch) {
    const action = JSON.parse(jsonMatch[0]);
    console.log('âœ… Azione rilevata:', action);
    
    // AZIONE 1: Aggiungi al frigo
    if (action.action === 'add_to_fridge' && action.items) {
      console.log('ðŸŽ Aggiungo al frigo:', action.items);
      
      if (!fridge) fridge = [];
      
      action.items.forEach(item => {
        fridge.push({
          nome: item.nome,
          peso: item.peso || 100,
          scadenza: nextDays(item.giorni || 7),
          categoria: item.categoria || 'Generale'
        });
      });
      
      console.log('ðŸ“¦ Frigo ora ha', fridge.length, 'elementi');
      
      if (typeof saveFridgeIndexed === 'function') saveFridgeIndexed();
      if (typeof salvaTutto === 'function') salvaTutto();
      
      if (typeof refreshList === 'function') {
        setTimeout(() => {
          refreshList();
          console.log('âœ… UI lista aggiornata');
        }, 300);
      }
      
      aiResponse = `âœ… Ho aggiunto ${action.items.map(i => i.nome).join(', ')} al frigo! Vai nella sezione Lista per vederli.`;
    }
    
    // AZIONE 2: Aggiungi alla spesa
    else if (action.action === 'add_to_shopping' && action.items) {
      console.log('ðŸ›’ Aggiungo alla spesa:', action.items);
      
      if (!groceryList) groceryList = [];
      
      action.items.forEach(item => {
        groceryList.push({
          nome: item.nome || item,
          quantita: item.quantita || '1',
          acquistato: false,
          timestamp: Date.now()
        });
      });
      
      console.log('ðŸ›’ Spesa ora ha', groceryList.length, 'elementi');
      
      if (typeof saveGroceryIndexed === 'function') saveGroceryIndexed();
      if (typeof salvaTutto === 'function') salvaTutto();
      
      if (typeof renderGrocery === 'function') {
        setTimeout(() => {
          renderGrocery();
          console.log('âœ… UI spesa aggiornata');
        }, 300);
      }
      
      const itemNames = action.items.map(i => typeof i === 'string' ? i : i.nome).join(', ');
      aiResponse = `âœ… Ho aggiunto ${itemNames} alla lista della spesa! Vai nella sezione Spesa per vederli.`;
    }
    
    // AZIONE 3: Crea ricetta
    else if (action.action === 'create_recipe' && action.recipe) {
      console.log('ðŸ“– Creo ricetta:', action.recipe);
      
      if (!recipes) recipes = [];
      
      const newRecipe = {
        nome: action.recipe.nome,
        ingredienti: action.recipe.ingredienti || [],
        procedimento: action.recipe.procedimento || '',
        categoria: action.recipe.categoria || 'Altro',
        tempo: action.recipe.tempo || 30,
        porzioni: action.recipe.porzioni || 4,
        kcal: action.recipe.kcal || 0,
        prot: action.recipe.prot || 0,
        carb: action.recipe.carb || 0,
        fat: action.recipe.fat || 0,
        veg: action.recipe.veg || false
      };
      
      recipes.push(newRecipe);
      console.log('ðŸ“š Ricette ora sono', recipes.length);
      
      if (typeof saveRecipeIndexed === 'function') saveRecipeIndexed();
      if (typeof salvaTutto === 'function') salvaTutto();
      
      if (typeof renderRecipes === 'function') {
        setTimeout(() => {
          renderRecipes();
          console.log('âœ… UI ricette aggiornata');
        }, 300);
      }
      
      aiResponse = `âœ… Ricetta "${action.recipe.nome}" creata con successo! Vai nella sezione Ricette per vederla.`;
    }
    
    // AZIONE 4: Registra pasto
    else if (action.action === 'log_meal' && action.meal) {
      console.log('ðŸ½ï¸ Registro pasto:', action.meal);
      
      const today = new Date().toISOString().split('T')[0];
      
      if (!dailyMeals) dailyMeals = {};
      if (!dailyMeals[today]) dailyMeals[today] = [];
      
      dailyMeals[today].push({
        nome: action.meal.nome,
        kcal: action.meal.kcal || 0,
        prot: action.meal.prot || 0,
        carb: action.meal.carb || 0,
        fat: action.meal.fat || 0,
        timestamp: new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })
      });
      
      console.log('ðŸ¥— Pasti di oggi:', dailyMeals[today].length);
      
      localStorage.setItem('dailyMeals', JSON.stringify(dailyMeals));
      
      if (typeof saveDailyMealsIndexed === 'function') saveDailyMealsIndexed();
      if (typeof salvaTutto === 'function') salvaTutto();
      
      if (typeof updateDailyTracking === 'function') {
        setTimeout(() => {
          updateDailyTracking();
          console.log('âœ… UI tracking aggiornato');
        }, 300);
      }
      
      aiResponse = `âœ… Ho registrato "${action.meal.nome}" (${action.meal.kcal} kcal) nel tracking di oggi! Vai nella sezione Fabbisogno per vedere il tuo progresso.`;
    }
  }
} catch (e) {
  console.log('âš ï¸ Risposta non-azione (normale)');
}
    
    loadingMsg.innerHTML = `<strong>Frigo Smart AI:</strong> ${aiResponse}`;
chatHistory.scrollTop = chatHistory.scrollHeight;

// ðŸ”Š SINTESI VOCALE (AGGIUNTO)
if (autoSpeak && !isMuted) {
  speak(aiResponse);
}

// Salva ultimo messaggio per il tasto "Parla"
lastAssistantMessage = aiResponse;
    
  } catch (error) {
    console.error('âŒ Errore:', error);
    loadingMsg.innerHTML = `<strong>Frigo Smart AI:</strong> âŒ Errore: ${error.message}`;
  }
}

// AI Groq
async function handleGroqAI(userMsg, chat, robot) {
  try {
    const context = buildContext();
    
    const thinkingDiv = document.createElement('div');
    thinkingDiv.className = 'tiny';
    thinkingDiv.style.marginBottom = '6px';
    thinkingDiv.innerHTML = '<strong>ðŸ¤– Assistente:</strong> <em>Sto pensando...</em>';
    chat.appendChild(thinkingDiv);
    chat.scrollTop = chat.scrollHeight;
    
    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${groqApiKey}`
      },
      body: JSON.stringify({
        model: 'llama-3.1-8b-instant',
        messages: [
          {
            role: 'system',
            content: `Sei un assistente nutrizionale intelligente integrato in un'app di gestione frigo.

HAI ACCESSO A:
${context}

REGOLE:
- Rispondi in italiano in modo amichevole e conciso
- Usa emoji appropriate
- Se ti chiedono ricette, suggerisci quelle disponibili
- Se ti chiedono cosa cucinare, usa gli ingredienti del frigo
- Dai consigli nutrizionali basati sul fabbisogno dell'utente
- Mantieni risposte brevi (max 100 parole)`
          },
          {
            role: 'user',
            content: userMsg
          }
        ],
        temperature: 0.7,
        max_tokens: 300
      })
    });
    
    chat.removeChild(thinkingDiv);
    
    if (response.status === 429) {
      const data = await response.json().catch(() => ({}));
      let errorMsg = 'âš ï¸ <strong>Limite API raggiunto!</strong><br>Hai raggiunto il limite di richieste. Attendi qualche minuto.';
      
      chat.innerHTML += `<div class="tiny" style="background:rgba(239,68,68,0.1);padding:10px;border-radius:8px;border:1px solid var(--danger);margin-bottom:6px">
        ${errorMsg}
      </div>`;
      
      setTimeout(() => {
        chat.innerHTML += `<div class="tiny" style="margin-bottom:6px"><strong>ðŸ¤–:</strong> Uso l'assistente base...</div>`;
        handleBasicAssist(userMsg, chat, robot);
      }, 1000);
      return;
    }
    
    if (response.status === 401) {
      chat.innerHTML += `<div class="tiny alert" style="padding:10px;border-radius:8px">
        âŒ <strong>Chiave API non valida!</strong><br>
        Vai nelle Impostazioni e inserisci una chiave corretta.
      </div>`;
      setTimeout(() => handleBasicAssist(userMsg, chat, robot), 1000);
      return;
    }
    
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const data = await response.json();
    const aiResponse = data.choices[0].message.content;
    
    chat.innerHTML += `<div class="tiny" style="margin-bottom:6px;background:var(--input-bg);padding:8px;border-radius:8px">
      <strong>ðŸ¤– Assistente:</strong> ${aiResponse}
    </div>`;
    chat.scrollTop = chat.scrollHeight;
    
    if (window.audioEnabled) speak(aiResponse);
    
    setTimeout(() => {
      robot.classList.remove('talking');
      setTimeout(() => robot.classList.remove('visible'), 500);
    }, 4000);
    
  } catch (error) {
    console.error('Errore AI:', error);
    chat.innerHTML += `<div class="tiny" style="background:rgba(239,68,68,0.1);padding:8px;border-radius:8px;margin-bottom:6px">
      âŒ Errore di connessione. Uso assistente base.
    </div>`;
    handleBasicAssist(userMsg, chat, robot);
  }
}

// Costruisce contesto
function buildContext() {
  let context = '';
  
  if (fridge && fridge.length > 0) {
    context += `\nðŸ“¦ FRIGO (${fridge.length} alimenti):\n`;
    fridge.slice(0, 10).forEach(item => {
      context += `- ${item.nome} (${item.peso}g)\n`;
    });
  }
  
  if (recipes && recipes.length > 0) {
    context += `\nðŸ“– RICETTE (${recipes.length}):\n`;
    recipes.slice(0, 10).forEach(r => {
      context += `- ${r.nome} (${r.kcal} kcal)\n`;
    });
  }
  
  if (window.userNeeds) {
    context += `\nðŸ’ª FABBISOGNO:\n`;
    context += `- Calorie: ${window.userNeeds.kcal} kcal/giorno\n`;
    context += `- Proteine: ${window.userNeeds.prot}g\n`;
  }
  
  return context || 'Nessun dato disponibile';
}

// Assistente base
function handleBasicAssist(userMsg, chat, robot) {
  const lower = userMsg.toLowerCase();
  let response = '';
  
  if (lower.includes('ricetta') || lower.includes('cucinare')) {
    response = 'ðŸ³ Per suggerimenti intelligenti, configura la chiave API Groq nelle Impostazioni!';
  } else if (lower.includes('calorie') || lower.includes('kcal')) {
    response = 'ðŸ“Š Vai alla sezione Fabbisogno per calcolare le tue calorie giornaliere!';
  } else if (lower.includes('frigo')) {
    const n = fridge.length;
    response = `â„ï¸ Hai ${n} alimenti nel frigo. Vai alla Lista per vederli!`;
  } else {
    response = 'ðŸ¤– Ciao! Configura la chiave API Groq nelle Impostazioni per un assistente AI avanzato!';
  }
  
  chat.innerHTML += `<div class="tiny" style="margin-bottom:6px"><strong>ðŸ¤–:</strong> ${response}</div>`;
  chat.scrollTop = chat.scrollHeight;
  
  if (window.audioEnabled) speak(response);
  
  setTimeout(() => {
    robot.classList.remove('talking');
    setTimeout(() => robot.classList.remove('visible'), 500);
  }, 3000);
}

// ========================================
// ðŸ“ˆ ANDAMENTO CON ANALISI INTELLIGENTE
// ========================================

// Renderizza andamento (rinominato da cronologia)
function renderAndamento() {
  const container = document.getElementById('andamentoLista');
  if (!container) return;
  
  const items = [];
  const oggi = new Date();
  
  for (let i = 0; i < 90; i++) {
    const data = new Date(oggi);
    data.setDate(data.getDate() - i);
    const dataStr = data.toISOString().split('T')[0];
    const pasti = window.dailyMeals[dataStr];
    
    if (!pasti || pasti.length === 0) continue;
    
    let kcal = 0, prot = 0, carb = 0, fat = 0;
    pasti.forEach(p => {
      kcal += p.kcal || 0;
      prot += p.prot || 0;
      carb += p.carb || 0;
      fat += p.fat || 0;
    });
    
    items.push({
      data: data.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' }),
      pasti: pasti.length,
      kcal: Math.round(kcal),
      prot: Math.round(prot),
      carb: Math.round(carb),
      fat: Math.round(fat)
    });
  }
  
  if (items.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">ðŸ“­ Nessun dato</div>';
    return;
  }
  
  let html = '';
  items.forEach(item => {
    const target = window.userNeeds ? window.userNeeds.kcal : 2000;
    const perc = Math.round((item.kcal / target) * 100);
    
    html += `
      <div class="cronologia-item">
        <div class="cronologia-header">
          <div style="font-weight:700">ðŸ“… ${item.data}</div>
          <div class="chip">${perc}% obiettivo</div>
        </div>
        <div class="tiny">ðŸ½ï¸ ${item.pasti} pasti</div>
        <div class="cronologia-macros">
          <div style="text-align:center">
            <div style="font-size:18px;font-weight:700">ðŸ”¥ ${item.kcal}</div>
            <div class="tiny">kcal</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:18px;font-weight:700">ðŸ’ª ${item.prot}g</div>
            <div class="tiny">proteine</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:18px;font-weight:700">ðŸž ${item.carb}g</div>
            <div class="tiny">carboidrati</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:18px;font-weight:700">ðŸ§ˆ ${item.fat}g</div>
            <div class="tiny">grassi</div>
          </div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// Analisi intelligente con consigli
function analizzaAndamento(tipo) {
  const oggi = new Date();
  let giorni = tipo === 'settimana' ? 7 : tipo === 'mese' ? 30 : 90;
  
  let totKcal = 0;
  let giorniRegistrati = 0;
  const datiGiornalieri = [];
  
  for (let i = 0; i < giorni; i++) {
    const data = new Date(oggi);
    data.setDate(data.getDate() - i);
    const dataStr = data.toISOString().split('T')[0];
    const pasti = window.dailyMeals[dataStr];
    
    if (pasti && pasti.length > 0) {
      let kcalGiorno = 0;
      pasti.forEach(p => kcalGiorno += p.kcal || 0);
      totKcal += kcalGiorno;
      giorniRegistrati++;
      datiGiornalieri.push(kcalGiorno);
    }
  }
  
  if (giorniRegistrati === 0) {
    return '<div class="tiny" style="text-align:center;padding:20px">ðŸ“­ Nessun dato disponibile per l\'analisi</div>';
  }
  
  const mediaKcal = Math.round(totKcal / giorniRegistrati);
  const fabbisogno = window.userNeeds ? window.userNeeds.kcal : 2000;
  const differenzaMedia = mediaKcal - fabbisogno;
  const differenzaTotale = differenzaMedia * giorniRegistrati;
  
  // Stima variazione peso (3500 kcal = ~0.5 kg)
  const kgVariazione = (differenzaTotale / 7000).toFixed(2);
  
  // Trend
  let trend = '';
  let trendColor = '';
  let trendIcon = '';
  
  if (Math.abs(differenzaMedia) < 100) {
    trend = 'Mantenimento';
    trendColor = 'var(--success)';
    trendIcon = 'âš–ï¸';
  } else if (differenzaMedia < 0) {
    trend = 'Deficit Calorico';
    trendColor = '#3b82f6';
    trendIcon = 'ðŸ“‰';
  } else {
    trend = 'Surplus Calorico';
    trendColor = '#ef4444';
    trendIcon = 'ðŸ“ˆ';
  }
  
  // Proiezione futura
  let proiezione = '';
  if (Math.abs(kgVariazione) >= 0.5) {
    if (kgVariazione < 0) {
      proiezione = `ðŸ“‰ Hai perso circa <strong>${Math.abs(kgVariazione)} kg</strong> in questo periodo`;
    } else {
      proiezione = `ðŸ“ˆ Hai guadagnato circa <strong>${kgVariazione} kg</strong> in questo periodo`;
    }
  } else {
    proiezione = `âš–ï¸ Peso stabile (variazione < 0.5 kg)`;
  }
  
  // Consigli
  let consigli = [];
  if (differenzaMedia < -500) {
    consigli.push('âš ï¸ Deficit molto alto. Assicurati di non scendere sotto il metabolismo basale.');
  } else if (differenzaMedia < -200) {
    consigli.push('âœ… Deficit salutare per perdita di peso graduale.');
  } else if (Math.abs(differenzaMedia) < 100) {
    consigli.push('âœ… Perfetto! Sei in mantenimento.');
  } else if (differenzaMedia > 200 && differenzaMedia < 500) {
    consigli.push('âœ… Surplus salutare per aumento massa muscolare.');
  } else if (differenzaMedia > 500) {
    consigli.push('âš ï¸ Surplus molto alto. Rischio di accumulo di grasso.');
  }
  
  // Consistenza
  const consistenza = (giorniRegistrati / giorni * 100).toFixed(0);
  if (consistenza < 50) {
    consigli.push('ðŸ“ Registra piÃ¹ pasti per analisi piÃ¹ accurate.');
  } else if (consistenza > 80) {
    consigli.push('ðŸŽ¯ Ottima consistenza nel tracciamento!');
  }
  
  // HTML output
  let html = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
      <div class="card" style="text-align:center;border-left:3px solid ${trendColor}">
        <div style="font-size:28px">${trendIcon}</div>
        <div style="font-size:18px;font-weight:700;margin-top:4px">${trend}</div>
        <div class="tiny" style="margin-top:4px">
          ${differenzaMedia > 0 ? '+' : ''}${differenzaMedia} kcal/giorno
        </div>
      </div>
      
      <div class="card" style="text-align:center;border-left:3px solid var(--accent)">
        <div style="font-size:28px">ðŸ“Š</div>
        <div style="font-size:18px;font-weight:700;margin-top:4px">${mediaKcal} kcal</div>
        <div class="tiny" style="margin-top:4px">Media giornaliera</div>
      </div>
    </div>
    
    <div class="card" style="margin-bottom:12px;background:rgba(79,195,247,0.05);border-left:3px solid var(--accent)">
      <div style="font-size:16px;font-weight:700;margin-bottom:8px">ðŸŽ¯ Risultato Periodo (${giorniRegistrati} giorni registrati)</div>
      <div class="tiny" style="margin-bottom:4px">${proiezione}</div>
      <div class="tiny">Obiettivo: ${fabbisogno} kcal/giorno</div>
    </div>
  `;
  
  if (consigli.length > 0) {
    html += `<div class="card" style="background:rgba(22,163,74,0.05);border-left:3px solid var(--success)">
      <div style="font-size:14px;font-weight:700;margin-bottom:8px">ðŸ’¡ Consigli</div>`;
    consigli.forEach(c => {
      html += `<div class="tiny" style="margin-bottom:4px">${c}</div>`;
    });
    html += `</div>`;
  }
  
  return html;
}

// Filtra andamento
function filtraAndamento() {
  renderAndamento();
}

function resetFiltroAndamento() {
  document.getElementById('filtroDa').value = '';
  document.getElementById('filtroA').value = '';
  renderAndamento();
}

// Override show per andamento
const originalShowForAndamento = window.show;
window.show = function(section) {
  originalShowForAndamento(section);
  if (section === 'andamento') {
    setTimeout(() => {
      renderAndamento();
      renderChart('settimana');
      const analisi = document.getElementById('analisiAndamento');
      if (analisi) analisi.innerHTML = analizzaAndamento('settimana');
    }, 100);
  }
  if (section === 'impostazioni') {
    setTimeout(checkAIStatus, 100);
  }
};

// Switch chart aggiornato con analisi
function switchChart(tipo) {
  document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + tipo).classList.add('active');
  renderChart(tipo);
  
  const analisi = document.getElementById('analisiAndamento');
  if (analisi) analisi.innerHTML = analizzaAndamento(tipo);
}

// ========================================
// ðŸŽ“ FUNZIONI UI E UTILITY
// ========================================

function showGroqGuide() {
  document.getElementById('groqGuideModal').classList.add('active');
}

function closeGroqGuide() {
  document.getElementById('groqGuideModal').classList.remove('active');
}

function toggleKeyVisibility() {
  const input = document.getElementById('groqApiKey');
  if (input.type === 'password') {
    input.type = 'text';
  } else {
    input.type = 'password';
  }
}

function checkAIStatus() {
  const statusDiv = document.getElementById('aiStatus');
  if (!statusDiv) return;
  
  let status = '';
  let color = '';
  
  if (groqApiKey) {
    status = 'ðŸ¥‡ <strong>AI Super Potente ATTIVA</strong> (Groq API)';
    color = 'var(--success)';
  } else if (window.transformers) {
    status = 'ðŸ¥ˆ <strong>AI Locale ATTIVA</strong> (Transformers.js)';
    color = 'var(--accent)';
  } else {
    status = 'ðŸ¥‰ <strong>Assistente Base</strong> (limitato)';
    color = 'var(--muted)';
  }
  
  statusDiv.innerHTML = status;
  statusDiv.style.background = color === 'var(--success)' ? 'rgba(22,163,74,0.1)' : 
                                color === 'var(--accent)' ? 'rgba(7,127,191,0.1)' : 
                                'var(--input-bg)';
  statusDiv.style.borderLeft = `3px solid ${color}`;
}

// Chiudi modale cliccando fuori
window.addEventListener('click', (e) => {
  const modal = document.getElementById('groqGuideModal');
  if (e.target === modal) closeGroqGuide();
});

// Carica chiave all'avvio
window.addEventListener('load', () => {
  setTimeout(() => {
    loadGroqKey();
    checkAIStatus();
  }, 500);
});
  

// ========================================
// ðŸ§  ANALISI AI INTELLIGENTE (REPLICATE + FALLBACK)
// ========================================

async function analyzePhotoWithGroq() {
  const file = document.getElementById('fotoInput').files[0];
  if (!file) {
    alert('âŒ Seleziona prima una foto');
    return;
  }
  
  const preview = document.getElementById('fotoPreview');
  const analysisDiv = document.getElementById('aiAnalysis');
  const contentDiv = document.getElementById('aiAnalysisContent');
  
  // Mostra foto
  preview.src = URL.createObjectURL(file);
  preview.style.display = 'block';
  
  // Mostra loading iniziale
  analysisDiv.style.display = 'block';
  contentDiv.innerHTML = `
    <div style="text-align:center;padding:20px">
      <div style="font-size:40px;animation:spin 2s linear infinite">ðŸ§ </div>
      <div class="tiny" style="margin-top:8px">Analisi AI in corso...</div>
      <div class="tiny" style="margin-top:4px;color:var(--muted)">Preparazione analisi</div>
    </div>
  `;
  
  try {
    let analisi = null;
    let usedMethod = '';
    
    // 1ï¸âƒ£ PROVA CON REPLICATE VISION (se chiave disponibile)
    const replicateKey = localStorage.getItem('replicateApiKey');
    
    if (replicateKey) {
      try {
        console.log('ðŸ”® Tentativo con Replicate Vision AI...');
        
        contentDiv.innerHTML = `
          <div style="text-align:center;padding:20px">
            <div style="font-size:40px;animation:spin 2s linear infinite">ðŸ”®</div>
            <div class="tiny" style="margin-top:8px;font-weight:700">Metodo: Replicate Vision AI</div>
            <div class="tiny" style="margin-top:4px;color:var(--success)">âœ… AI avanzata con analisi visiva diretta</div>
            <div class="tiny" style="margin-top:4px;color:var(--muted)">Invio immagine al server AI...</div>
          </div>
        `;
        
        const base64Image = await imageToBase64(file);
        
        // Crea predizione su Replicate
        const createResponse = await fetch('https://api.replicate.com/v1/predictions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${replicateKey}`,
            'Content-Type': 'application/json',
            'Prefer': 'wait'
          },
          body: JSON.stringify({
            version: "8beff3369e81422112d93b89ca01426147de542cd4684c244b673b105188fe5f",
            input: {
              image: base64Image,
              top_p: 0.9,
              prompt: `Analizza questa foto di cibo in formato JSON.

Per OGNI alimento visibile:
{
  "alimenti": [
    {
      "nome": "Nome in italiano",
      "quantita": "peso stimato",
      "categoria": "Frutta/Verdura/Latticini/Carne/Pesce/Cereali/Bevande/Altro",
      "stato": "fresco/maturo/da consumare",
      "calorie_totali": numero,
      "giorni_conservazione": numero
    }
  ],
  "suggerimento": "consiglio breve"
}

Rispondi SOLO JSON.`,
              temperature: 0.3,
              max_tokens: 2000
            }
          })
        });
        
        if (createResponse.ok) {
          let prediction = await createResponse.json();
          
          contentDiv.innerHTML = `
            <div style="text-align:center;padding:20px">
              <div style="font-size:40px;animation:spin 2s linear infinite">ðŸ”®</div>
              <div class="tiny" style="margin-top:8px;font-weight:700">Replicate Vision AI</div>
              <div class="tiny" style="margin-top:4px;color:var(--accent)">â³ L'AI sta analizzando la foto...</div>
              <div class="tiny" style="margin-top:4px;color:var(--muted)">PuÃ² richiedere 5-15 secondi</div>
            </div>
          `;
          
          // Attendi completamento (max 30 secondi)
          for (let i = 0; i < 30; i++) {
            if (prediction.status === 'succeeded') break;
            if (prediction.status === 'failed') throw new Error('Replicate analysis failed');
            
            await new Promise(r => setTimeout(r, 1000));
            
            const statusResponse = await fetch(prediction.urls.get, {
              headers: { 'Authorization': `Bearer ${replicateKey}` }
            });
            
            prediction = await statusResponse.json();
            
            // Aggiorna progresso ogni 3 secondi
            if (i % 3 === 0 && i > 0) {
              contentDiv.innerHTML = `
                <div style="text-align:center;padding:20px">
                  <div style="font-size:40px;animation:spin 2s linear infinite">ðŸ”®</div>
                  <div class="tiny" style="margin-top:8px;font-weight:700">Replicate Vision AI</div>
                  <div class="tiny" style="margin-top:4px;color:var(--accent)">â³ Elaborazione... (${i}s)</div>
                </div>
              `;
            }
          }
          
          if (prediction.status === 'succeeded') {
            const aiResponse = Array.isArray(prediction.output) 
              ? prediction.output.join('') 
              : prediction.output;
            
            const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
              analisi = JSON.parse(jsonMatch[0]);
              usedMethod = 'ðŸ”® Replicate Vision AI (analisi visiva diretta)';
              console.log('âœ… Usato Replicate Vision con successo!');
            }
          }
        }
      } catch (replicateError) {
        console.log('âš ï¸ Replicate non disponibile:', replicateError.message);
        
        contentDiv.innerHTML = `
          <div style="text-align:center;padding:20px;background:rgba(251,146,60,0.1);border-radius:8px">
            <div style="font-size:30px">âš ï¸</div>
            <div class="tiny" style="margin-top:8px;font-weight:700">Replicate non disponibile</div>
            <div class="tiny" style="margin-top:4px;color:var(--muted)">Motivo: ${replicateError.message}</div>
            <div class="tiny" style="margin-top:8px;color:var(--accent)">ðŸ”„ Uso metodo alternativo...</div>
          </div>
        `;
        
        await new Promise(r => setTimeout(r, 1500)); // Mostra messaggio per 1.5s
      }
    } else {
      console.log('â„¹ï¸ Chiave Replicate non configurata');
      
      contentDiv.innerHTML = `
        <div style="text-align:center;padding:20px;background:rgba(79,195,247,0.1);border-radius:8px">
          <div style="font-size:30px">â„¹ï¸</div>
          <div class="tiny" style="margin-top:8px;font-weight:700">Chiave Replicate non trovata</div>
          <div class="tiny" style="margin-top:4px;color:var(--muted)">Configura nelle Impostazioni per AI visiva avanzata</div>
          <div class="tiny" style="margin-top:8px;color:var(--accent)">ðŸ”„ Uso scansione locale COCO-SSD...</div>
        </div>
      `;
      
      await new Promise(r => setTimeout(r, 1500));
    }
    
    // 2ï¸âƒ£ FALLBACK: USA COCO-SSD + GROQ
    if (!analisi) {
      console.log('ðŸŽ¯ Uso fallback: COCO-SSD + Groq');
      
      contentDiv.innerHTML = `
        <div style="text-align:center;padding:20px">
          <div style="font-size:40px;animation:spin 2s linear infinite">ðŸŽ¯</div>
          <div class="tiny" style="margin-top:8px;font-weight:700">Metodo: Scansione Locale + AI</div>
          <div class="tiny" style="margin-top:4px;color:var(--accent)">ðŸ“± COCO-SSD rileva oggetti localmente</div>
          <div class="tiny" style="margin-top:4px;color:var(--muted)">Nessun dato inviato al cloud durante la scansione</div>
        </div>
      `;
      
      const img = document.getElementById('fotoPreview');
      const mdl = await loadModel();
      
      if (!mdl) {
        throw new Error('Impossibile caricare il modello di scansione');
      }
      
      const preds = await mdl.detect(img);
      let detectedObjects = preds
        .filter(p => p.score > 0.4)
        .map(p => p.class);
      
      detectedObjects = [...new Set(detectedObjects)];
      
      if (detectedObjects.length === 0) {
        contentDiv.innerHTML = `
          <div class="tiny" style="padding:12px;background:rgba(239,68,68,0.1);border-radius:8px;border-left:3px solid var(--danger)">
            âŒ <strong>Nessun oggetto rilevato</strong><br><br>
            <strong>Metodo usato:</strong> COCO-SSD (locale)<br>
            <strong>Motivo:</strong> ${!replicateKey ? 'Chiave Replicate non configurata' : 'Replicate non disponibile'}<br><br>
            <strong>Suggerimenti:</strong><br>
            â€¢ Foto ben illuminate e nitide<br>
            â€¢ Inquadra gli alimenti da vicino<br>
            â€¢ Configura Replicate per AI piÃ¹ accurata
          </div>
        `;
        return;
      }
      
      // Usa Groq per analisi nutrizionale
      if (!groqApiKey) {
        contentDiv.innerHTML = `
          <div class="tiny" style="padding:12px;background:rgba(239,68,68,0.1);border-radius:8px;border-left:3px solid var(--danger)">
            <strong>âš ï¸ Chiave API Groq Necessaria</strong><br><br>
            <strong>Oggetti rilevati:</strong> ${detectedObjects.join(', ')}<br>
            <strong>Metodo usato:</strong> COCO-SSD (locale)<br><br>
            Per completare l'analisi nutrizionale, configura Groq.<br>
            <button class="btn-primary" onclick="show('impostazioni')" style="margin-top:8px">
              ðŸ”‘ Vai alle Impostazioni
            </button>
          </div>
        `;
        return;
      }
      
      contentDiv.innerHTML = `
        <div style="text-align:center;padding:20px">
          <div style="font-size:40px;animation:spin 2s linear infinite">ðŸ§ </div>
          <div class="tiny" style="margin-top:8px;font-weight:700">Groq AI - Analisi Nutrizionale</div>
          <div class="tiny" style="margin-top:4px;color:var(--success)">âœ… Oggetti: ${detectedObjects.join(', ')}</div>
          <div class="tiny" style="margin-top:4px;color:var(--muted)">Elaborazione dati nutrizionali...</div>
        </div>
      `;
      
      const prompt = `Oggetti rilevati: ${detectedObjects.join(', ')}.

Per OGNI oggetto che Ã¨ cibo:
{
  "alimenti": [
    {
      "nome": "Nome italiano",
      "quantita": "peso stimato",
      "categoria": "Frutta/Verdura/Latticini/Carne/Pesce/Cereali/Bevande/Altro",
      "stato": "fresco",
      "calorie_totali": numero,
      "giorni_conservazione": numero
    }
  ],
  "suggerimento": "consiglio"
}

SOLO JSON.`;

      const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${groqApiKey}`
        },
        body: JSON.stringify({
          model: 'llama-3.1-8b-instant',
          messages: [
            { role: 'system', content: 'Esperto nutrizionista. Rispondi SOLO JSON.' },
            { role: 'user', content: prompt }
          ],
          temperature: 0.3,
          max_tokens: 1000
        })
      });
      
      if (!response.ok) {
        throw new Error(`Groq API Error: ${response.status}`);
      }
      
      const data = await response.json();
      const aiResponse = data.choices[0].message.content;
      const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
      
      if (!jsonMatch) {
        throw new Error('Formato risposta non valido');
      }
      
      analisi = JSON.parse(jsonMatch[0]);
      usedMethod = 'ðŸŽ¯ COCO-SSD (locale) + Groq AI (analisi nutrizionale)';
      console.log('âœ… Usato COCO-SSD + Groq con successo!');
    }
    
    // 3ï¸âƒ£ MOSTRA RISULTATI
    let html = `
      <div style="padding:10px;background:rgba(34,197,94,0.1);border-radius:8px;margin-bottom:12px;border-left:3px solid var(--success)">
        <div class="tiny" style="font-weight:700">âœ… Analisi completata</div>
        <div class="tiny" style="margin-top:4px;color:var(--muted)">${usedMethod}</div>
      </div>
      <div style="margin-bottom:12px">
    `;
    
    analisi.alimenti.forEach((alimento) => {
      const peso = parseInt(alimento.quantita) || 100;
      const scadenza = nextDays(alimento.giorni_conservazione || 7);
      
      html += `
        <div class="card" style="margin-bottom:8px;background:var(--card);border-left:3px solid var(--accent)">
          <div style="display:flex;justify-content:space-between;align-items:start;gap:12px">
            <div style="flex:1">
              <strong style="font-size:16px">${alimento.nome}</strong>
              <div class="tiny" style="margin-top:4px;color:var(--muted)">
                ðŸ“¦ ${alimento.quantita} â€¢ ðŸ“ ${alimento.categoria}
              </div>
              <div class="tiny" style="margin-top:4px">
                ${alimento.stato === 'fresco' ? 'âœ…' : 'ðŸŸ¡'} ${alimento.stato || 'fresco'}
              </div>
              <div class="tiny" style="margin-top:4px">
                ðŸ”¥ ${alimento.calorie_totali} kcal â€¢ â„ï¸ ${alimento.giorni_conservazione} giorni
              </div>
            </div>
            <button class="btn-primary" onclick="aggiungiAlFrigoDaAI('${alimento.nome}', '${peso}', '${alimento.categoria}', '${scadenza}')" style="padding:6px 12px;white-space:nowrap">
              âž• Aggiungi
            </button>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    
    if (analisi.suggerimento) {
      html += `
        <div class="card" style="background:rgba(34,197,94,0.05);border-left:3px solid var(--success)">
          <strong>ðŸ’¡ Suggerimento:</strong>
          <div class="tiny" style="margin-top:6px">${analisi.suggerimento}</div>
        </div>
      `;
    }
    
    contentDiv.innerHTML = html;
    
    if (typeof toast === 'function') {
      toast('âœ… Analisi completata!');
    }
    
  } catch (error) {
    console.error('âŒ Errore analisi AI:', error);
    
    contentDiv.innerHTML = `
      <div class="card" style="background:rgba(239,68,68,0.1);border-left:3px solid var(--danger)">
        <strong>âŒ Errore durante l'analisi</strong>
        <div class="tiny" style="margin-top:8px">${error.message}</div>
        <div class="tiny" style="margin-top:6px">
          <strong>Possibili cause:</strong><br>
          â€¢ Problema di connessione<br>
          â€¢ Chiave API non valida<br>
          â€¢ Immagine non supportata<br><br>
          <button class="btn-ghost" onclick="show('impostazioni')">
            ðŸ”‘ Verifica Impostazioni
          </button>
        </div>
      </div>
    `;
  }
}

// CONVERTI FILE IN BASE64
async function imageToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// AGGIUNGI ALIMENTO AL FRIGO
function aggiungiAlFrigoDaAI(nome, peso, categoria, scadenza) {
  fridge.push({
    nome: nome,
    peso: parseInt(peso) || 100,
    scadenza: scadenza || nextDays(7),
    categoria: categoria || 'Generale'
  });
  
  if (typeof saveFridgeIndexed === 'function') saveFridgeIndexed();
  if (typeof refreshList === 'function') refreshList();
  if (typeof toast === 'function') toast(`âœ… ${nome} aggiunto al frigo!`);
  
  show('lista');
}

// ðŸ†• FUNZIONE OTTIMIZZATA: Riduce maggiormente le immagini
async function optimizeImageForAI(imageDataUrl) {
  return new Promise((resolve) => {
    try {
      const img = new Image();
      
      img.onload = function() {
        // Calcola nuove dimensioni (max 800px per essere sicuri)
        let width = img.width;
        let height = img.height;
        const maxSize = 800; // ðŸ‘ˆ Ridotto da 1024 a 800
        
        if (width > maxSize || height > maxSize) {
          if (width > height) {
            height = (height / width) * maxSize;
            width = maxSize;
          } else {
            width = (width / height) * maxSize;
            height = maxSize;
          }
        }
        
        // Crea canvas per ridimensionare
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        
        // Disegna immagine ridimensionata
        ctx.drawImage(img, 0, 0, width, height);
        
        // Converti in base64 JPEG con piÃ¹ compressione
        const optimized = canvas.toDataURL('image/jpeg', 0.7); // ðŸ‘ˆ Ridotto da 0.85 a 0.7
        
        console.log('Immagine ottimizzata:', width + 'x' + height, 'Dimensione:', (optimized.length / 1024).toFixed(2) + 'KB');
        resolve(optimized);
      };
      
      img.onerror = function() {
        console.error('Errore caricamento immagine');
        resolve(null);
      };
      
      img.src = imageDataUrl;
      
    } catch (error) {
      console.error('Errore ottimizzazione:', error);
      resolve(null);
    }
  });
}

// Funzione per aggiungere risultati AI al frigo
function addAIResultsToFridge() {
  if (!window.lastAIAnalysis) {
    if (typeof toast === 'function') toast('âš ï¸ Nessuna analisi disponibile');
    return;
  }
  
  // Mostra prompt per conferma
  const userConfirm = confirm('Vuoi aggiungere gli alimenti identificati dall\'AI al frigo?\n\nPotrai modificare i dettagli dopo l\'aggiunta.');
  
  if (!userConfirm) return;
  
  // Analisi semplice del testo per estrarre alimenti
  const text = window.lastAIAnalysis.toLowerCase();
  
  // Pattern comuni per identificare alimenti
  const foodPatterns = [
    /(\d+)\s*(banana|banane)/gi,
    /(\d+)\s*(mela|mele|apple)/gi,
    /(\d+)\s*(arancia|arance|orange)/gi,
    /(\d+)\s*(pomodoro|pomodori|tomato)/gi,
    /(\d+)\s*(carota|carote|carrot)/gi,
    // Aggiungi altri pattern comuni
  ];
  
  let foundItems = [];
  
  foodPatterns.forEach(pattern => {
    const matches = text.matchAll(pattern);
    for (const match of matches) {
      const qty = match[1];
      const name = match[2];
      foundItems.push({
        nome: name.charAt(0).toUpperCase() + name.slice(1),
        peso: parseInt(qty) * 100, // stima 100g per item
        scadenza: getDefaultExpiry(name)
      });
    }
  });
  
  if (foundItems.length === 0) {
    if (typeof toast === 'function') toast('â„¹ï¸ Aggiungi manualmente gli alimenti dalla lista');
    show('lista');
    return;
  }
  
  // Aggiungi al frigo
  foundItems.forEach(item => {
    fridge.push(item);
  });
  
  if (typeof refreshList === 'function') refreshList();
  if (typeof salvaTutto === 'function') salvaTutto();
  if (typeof toast === 'function') toast(`âœ… ${foundItems.length} alimenti aggiunti!`);
  
  show('lista');
}

// Helper per scadenza predefinita
function getDefaultExpiry(foodName) {
  const today = new Date();
  const daysToAdd = foodName.includes('banan') ? 3 :
                    foodName.includes('mel') ? 7 :
                    foodName.includes('pomodor') ? 5 :
                    foodName.includes('carot') ? 14 : 7;
  
  const expiry = new Date(today);
  expiry.setDate(today.getDate() + daysToAdd);
  return expiry.toISOString().split('T')[0];
}

// Aggiungi stile per animazione spin
window.addEventListener('DOMContentLoaded', () => {
  const styleSheet = document.createElement('style');
  styleSheet.textContent = `
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  `;
  document.head.appendChild(styleSheet);
});

// ========================================
// ðŸ·ï¸ RICERCA CODICE A BARRE MIGLIORATA
// ========================================

window.searchBarcode = async function() {
  const input = document.getElementById('barcodeInput');
  const barcode = input.value.trim();
  const resultDiv = document.getElementById('barcodeResult');
  
  if (!barcode) {
    if (typeof toast === 'function') toast('âš ï¸ Inserisci un codice a barre');
    return;
  }
  
  resultDiv.innerHTML = '<div class="tiny" style="text-align:center;padding:10px">ðŸ” Ricerca in corso...</div>';
  
  try {
    // STRATEGIA: Prima cerca nel database ITALIANO, poi MONDIALE
    let data = null;
    let source = '';
    
    // 1ï¸âƒ£ Prova database ITALIANO
    console.log('ðŸ‡®ðŸ‡¹ Cerco nel database italiano...');
    try {
      const itResponse = await fetch(`https://it.openfoodfacts.org/api/v2/product/${barcode}.json`);
      const itData = await itResponse.json();
      
      if (itData.status === 1 && itData.product) {
        data = itData;
        source = 'ðŸ‡®ðŸ‡¹ Database Italiano';
        console.log('âœ… Trovato nel database italiano!');
      }
    } catch (e) {
      console.log('âŒ Non trovato nel database italiano');
    }
    
    // 2ï¸âƒ£ Se non trovato, prova database MONDIALE
    if (!data) {
      console.log('ðŸŒ Cerco nel database mondiale...');
      const worldResponse = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}.json`);
      const worldData = await worldResponse.json();
      
      if (worldData.status === 1 && worldData.product) {
        data = worldData;
        source = 'ðŸŒ Database Mondiale';
        console.log('âœ… Trovato nel database mondiale!');
      }
    }
    
    // âŒ Non trovato in nessun database
    if (!data || data.status === 0) {
      resultDiv.innerHTML = `
        <div class="tiny" style="padding:12px;background:rgba(239,68,68,0.1);border-radius:8px">
          âŒ <strong>Prodotto non trovato</strong><br>
          Il codice <code>${barcode}</code> non Ã¨ presente nei database.<br><br>
          <strong>Prova:</strong><br>
          â€¢ Verifica il codice (deve avere 8 o 13 cifre)<br>
          â€¢ Cerca prodotti confezionati (non freschi)<br>
          â€¢ Prodotti italiani ed europei hanno piÃ¹ dati
        </div>
      `;
      return;
    }
    
    const product = data.product;
    
    // ESTRAI INFORMAZIONI
    const name = product.product_name || product.product_name_it || 'Prodotto sconosciuto';
    const brand = product.brands || '';
    const quantity = product.quantity || '';
    const imageUrl = product.image_front_small_url || product.image_url || '';
    
    // NUTRIENTI E QUALITÃ€
    const nutriScore = product.nutrition_grades || product.nutriscore_grade || '';
    const novaGroup = product.nova_group || '';
    const ecoScore = product.ecoscore_grade || '';
    
    // Additivi e allergeni
    const additives = product.additives_n || 0;
    const allergens = product.allergens_tags ? product.allergens_tags.length : 0;
    
    // Calorie e nutrienti
    const nutrients = product.nutriments || {};
    const calories = nutrients['energy-kcal_100g'] || nutrients['energy-kcal'] || null;
    const proteins = nutrients['proteins_100g'] || null;
    const carbs = nutrients['carbohydrates_100g'] || null;
    const fats = nutrients['fat_100g'] || null;
    
    // COSTRUISCI HTML
    let html = `<div class="card" style="background:rgba(139,92,246,0.05);margin-top:8px">`;
    
    // Immagine prodotto
    if (imageUrl) {
      html += `<img src="${imageUrl}" style="width:100%;max-width:150px;border-radius:8px;margin-bottom:8px" />`;
    }
    
    // Nome e brand
    html += `<div style="font-weight:700;font-size:16px;margin-bottom:4px">âœ… ${name}</div>`;
    if (brand) html += `<div class="tiny" style="margin-bottom:4px">ðŸ·ï¸ ${brand}</div>`;
    if (quantity) html += `<div class="tiny" style="margin-bottom:8px">ðŸ“¦ ${quantity}</div>`;
    
    // Fonte dati
    html += `<div class="tiny" style="margin-bottom:8px;color:var(--muted)">${source}</div>`;
    
    // NUTRI-SCORE
    if (nutriScore) {
      const nutriScoreColors = {
        'a': 'ðŸŸ¢', 'b': 'ðŸŸ¡', 'c': 'ðŸŸ ', 'd': 'ðŸŸ ', 'e': 'ðŸ”´'
      };
      const nutriScoreIcon = nutriScoreColors[nutriScore.toLowerCase()] || 'âšª';
      
      html += `<div class="tiny" style="margin-top:8px;padding:8px;background:rgba(79,195,247,0.1);border-radius:6px">
        <strong>ðŸ“Š Nutri-Score: ${nutriScoreIcon} ${nutriScore.toUpperCase()}</strong><br>
        <span style="font-size:11px;color:var(--muted)">QualitÃ  nutrizionale (A=ottima, E=scarsa)</span>
      </div>`;
    } else {
      html += `<div class="tiny" style="margin-top:8px;padding:8px;background:rgba(148,163,184,0.1);border-radius:6px;color:var(--muted)">
        ðŸ“Š Nutri-Score: <em>Non disponibile</em>
      </div>`;
    }
    
    // NOVA GROUP
    if (novaGroup) {
      const novaText = {
        1: 'âœ… Non processato',
        2: 'âœ… Poco processato',
        3: 'âš ï¸ Processato',
        4: 'âŒ Ultra-processato'
      };
      html += `<div class="tiny" style="margin-top:4px;padding:8px;background:rgba(139,92,246,0.1);border-radius:6px">
        <strong>ðŸ­ Processazione: ${novaText[novaGroup] || novaGroup}</strong>
      </div>`;
    } else {
      html += `<div class="tiny" style="margin-top:4px;padding:8px;background:rgba(148,163,184,0.1);border-radius:6px;color:var(--muted)">
        ðŸ­ Processazione: <em>Non disponibile</em>
      </div>`;
    }
    
    // ECO-SCORE
    if (ecoScore) {
      html += `<div class="tiny" style="margin-top:4px;padding:8px;background:rgba(34,197,94,0.1);border-radius:6px">
        <strong>ðŸŒ Eco-Score: ${ecoScore.toUpperCase()}</strong><br>
        <span style="font-size:11px;color:var(--muted)">Impatto ambientale</span>
      </div>`;
    } else {
      html += `<div class="tiny" style="margin-top:4px;padding:8px;background:rgba(148,163,184,0.1);border-radius:6px;color:var(--muted)">
        ðŸŒ Eco-Score: <em>Non disponibile</em>
      </div>`;
    }
    
    // ADDITIVI
    if (additives > 0) {
      html += `<div class="tiny" style="margin-top:4px;padding:8px;background:rgba(239,68,68,0.1);border-radius:6px">
        âš ï¸ Contiene <strong>${additives} additivi</strong>
      </div>`;
    }
    
    // ALLERGENI
    if (allergens > 0) {
      html += `<div class="tiny" style="margin-top:4px;padding:8px;background:rgba(251,146,60,0.1);border-radius:6px">
        âš ï¸ Contiene <strong>${allergens} allergeni</strong>
      </div>`;
    }
    
    // VALORI NUTRIZIONALI
    if (calories || proteins || carbs || fats) {
      html += `<div class="tiny" style="margin-top:8px;padding:8px;background:rgba(79,195,247,0.05);border-radius:6px">
        <strong>ðŸ“Š Valori per 100g:</strong><br>`;
      if (calories) html += `ðŸ”¥ ${Math.round(calories)} kcal<br>`;
      if (proteins) html += `ðŸ’ª Proteine: ${proteins.toFixed(1)}g<br>`;
      if (carbs) html += `ðŸž Carboidrati: ${carbs.toFixed(1)}g<br>`;
      if (fats) html += `ðŸ§ˆ Grassi: ${fats.toFixed(1)}g`;
      html += `</div>`;
    }
    
    // BOTTONE AGGIUNGI
    html += `<button class="btn-primary" onclick="addBarcodeToList('${name.replace(/'/g, "\\'")}', '${brand.replace(/'/g, "\\'")}', ${calories || 0})" style="width:100%;margin-top:12px">
      âž• Aggiungi alla Spesa
    </button>`;
    
    html += `</div>`;
    
    resultDiv.innerHTML = html;
    
    if (typeof toast === 'function') toast('âœ… Prodotto trovato!');
    
  } catch (error) {
    console.error('Errore ricerca barcode:', error);
    resultDiv.innerHTML = `
      <div class="tiny" style="padding:12px;background:rgba(239,68,68,0.1);border-radius:6px">
        âŒ <strong>Errore di connessione</strong><br>
        ${error.message}<br><br>
        Verifica la tua connessione e riprova.
      </div>
    `;
  }
};

// ========================================
// ðŸ“¸ SCANNER BARCODE LIVE
// ========================================

let html5QrcodeScanner = null;
let isScannerRunning = false;

function lowerZForScanner() {
  const els = document.querySelectorAll('nav, #interactive-progress, .interactive-tooltip, .interactive-arrow');
  window.__scannerLowered = [];
  els.forEach(el => {
    // salva valore + prioritÃ  precedenti
    const prevValue = el.style.getPropertyValue('z-index');
    const prevPriority = el.style.getPropertyPriority('z-index'); // '' oppure 'important'
    el.dataset.prevZ = prevValue || '';
    el.dataset.prevZImp = prevPriority || '';
    // forza z-index basso con !important (batte il tuo CSS !important)
    el.style.setProperty('z-index', '1', 'important');
    window.__scannerLowered.push(el);
  });
}

function restoreZAfterScanner() {
  (window.__scannerLowered || []).forEach(el => {
    const prevValue = el.dataset.prevZ || '';
    const prevPriority = el.dataset.prevZImp || '';
    if (prevValue) {
      el.style.setProperty('z-index', prevValue, prevPriority === 'important' ? 'important' : '');
    } else {
      el.style.removeProperty('z-index');
    }
    delete el.dataset.prevZ;
    delete el.dataset.prevZImp;
  });
  window.__scannerLowered = [];
}


// Apri scanner live
async function openBarcodeScanner() {
  const modal = document.getElementById('scannerModal');
  const statusDiv = document.getElementById('scannerStatus');
  
  if (!modal) {
    if (typeof toast === 'function') toast('âŒ Modal non trovato');
    return;
  }
  
  modal.style.cssText = `
    display: flex !important;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.95);
    z-index: 99999;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;
  
  if (typeof lowerZForScanner === 'function') {
    lowerZForScanner();
  }
  
  if (statusDiv) statusDiv.textContent = 'ðŸ”„ Inizializzazione scanner...';
  
  try {
    // Carica Quagga
    if (!window.Quagga) {
      await loadQuaggaLibrary();
    }
    
   // Configura Quagga
Quagga.init({
  inputStream: {
    name: "Live",
    type: "LiveStream",
    target: document.querySelector('#scannerReader'),
    constraints: {
      width: 640,           // â¬…ï¸ FISSO (no min/ideal/max)
      height: 480,          // â¬…ï¸ FISSO
      facingMode: "environment",
      aspectRatio: 1.33     // â¬…ï¸ Rapporto 4:3 standard
    }
  },
  locator: {
    patchSize: "large",     // â¬…ï¸ Area piÃ¹ grande
    halfSample: true
  },
  numOfWorkers: 2,
  frequency: 10,            // â¬…ï¸ Scansiona ogni 10 frame (piÃ¹ fluido)
  decoder: {
    readers: [
      "ean_reader",
      "ean_8_reader",
      "upc_reader",
      "upc_e_reader",
      "code_128_reader"
    ],
    multiple: false
  },
  locate: true
}, function(err) {
  if (err) {
    console.error('âŒ Errore init Quagga:', err);
    if (statusDiv) statusDiv.textContent = 'âŒ Errore: ' + err.message;
    setTimeout(() => closeBarcodeScanner(), 3000);
    return;
  }
  
  console.log('âœ… Quagga inizializzata');
  Quagga.start();
  isScannerRunning = true;
  
  if (statusDiv) {
    statusDiv.innerHTML = `
      âœ… Scanner attivo<br>
      <small style="font-size:11px;color:rgba(255,255,255,0.7)">
        ðŸ’¡ Inquadra il barcode al centro
      </small>
    `;
  }
});
    
    // Listener per barcode rilevati
    Quagga.onDetected(function(result) {
      const code = result.codeResult.code;
      console.log('âœ… Barcode rilevato:', code);
      
      // Vibrazione
      if (navigator.vibrate) {
        navigator.vibrate([100, 50, 100]);
      }
      
      // Ferma scanner
      Quagga.stop();
      
      if (statusDiv) {
        statusDiv.innerHTML = `
          <div style="background:rgba(34,197,94,0.2);padding:10px;border-radius:8px">
            âœ… <strong>Codice trovato!</strong><br>${code}
          </div>
        `;
      }
      
      setTimeout(() => {
        closeBarcodeScanner();
        
        const input = document.getElementById('barcodeInput');
        if (input) input.value = code;
        
        if (typeof toast === 'function') {
          toast('âœ… Barcode: ' + code);
        }
        
        setTimeout(() => {
          if (typeof searchBarcode === 'function') {
            searchBarcode();
          }
        }, 500);
      }, 1000);
    });
    
  } catch (error) {
    console.error('âŒ Errore scanner:', error);
    if (statusDiv) {
      statusDiv.innerHTML = `âŒ Errore: ${error.message}`;
    }
    setTimeout(() => closeBarcodeScanner(), 3000);
  }
}


// Quando trova un barcode
function onBarcodeScanned(decodedText, decodedResult) {
  console.log('âœ… Barcode rilevato:', decodedText);
  
  // ðŸŽ‰ Vibrazione feedback (se supportato)
  if (navigator.vibrate) {
    navigator.vibrate([100, 50, 100]);
  }
  
  const statusDiv = document.getElementById('scannerStatus');
  if (statusDiv) {
    statusDiv.innerHTML = `
      <div style="background:rgba(34,197,94,0.2);padding:10px;border-radius:8px;margin-top:10px">
        âœ… <strong>Codice trovato!</strong><br>
        ${decodedText}
      </div>
    `;
    statusDiv.style.color = '#4ade80';
  }
  
  // Chiudi scanner dopo 1 secondo
  setTimeout(() => {
    closeBarcodeScanner();
    
    // Inserisci codice nel campo
    const input = document.getElementById('barcodeInput');
    if (input) input.value = decodedText;
    
    if (typeof toast === 'function') {
      toast('âœ… Barcode rilevato: ' + decodedText);
    }
    
    // Cerca automaticamente il prodotto
    setTimeout(() => {
      if (typeof searchBarcode === 'function') {
        searchBarcode();
      }
    }, 500);
    
  }, 1000);
}

// Errori di scansione (normali, ignora)
function onScanError(errorMessage) {
  // Ignora errori normali (quando non trova ancora il codice)
  // console.log('Scansione...', errorMessage);
}

// Chiudi scanner
function closeBarcodeScanner() {
  const modal = document.getElementById('scannerModal');
  
  const cleanupAndHide = () => {
    try { 
      if (window.Quagga) {
        Quagga.stop();
        Quagga.offDetected();
      }
    } catch(e) {
      console.log('Cleanup Quagga:', e.message);
    }
    
    isScannerRunning = false;
    if (typeof restoreZAfterScanner === 'function') {
      restoreZAfterScanner();
    }
    if (modal) modal.style.display = 'none';
  };
  
  cleanupAndHide();
}

window.closeBarcodeScanner = closeBarcodeScanner;


// Carica libreria html5-qrcode dinamicamente
async function loadQuaggaLibrary() {
  return new Promise((resolve, reject) => {
    if (window.Quagga) {
      resolve();
      return;
    }
    
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js';
    script.onload = () => {
      console.log('âœ… Quagga.js caricata');
      resolve();
    };
    script.onerror = () => {
      console.error('âŒ Errore caricamento Quagga');
      reject(new Error('Impossibile caricare Quagga'));
    };
    document.head.appendChild(script);
  });
}


// ========================================
// ðŸ“· SCANNER DA FOTO (con ZXing)
// ========================================
async function scanBarcodeFromImage() {
  const fileInput = document.getElementById('barcodeCamera');
  const resultDiv = document.getElementById('barcodeResult');
  
  if (!fileInput.files || fileInput.files.length === 0) return;
  
  resultDiv.innerHTML = '<div class="tiny" style="text-align:center;padding:10px">ðŸ“· Scansione foto in corso...</div>';
  
  try {
    const file = fileInput.files[0];
    
    // Carica ZXing se non presente
    if (!window.ZXing) {
      await new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js';
        script.onload = () => {
          console.log('âœ… ZXing caricato per foto');
          resolve();
        };
        script.onerror = () => reject(new Error('Errore caricamento ZXing'));
        document.head.appendChild(script);
      });
    }
    
    // Crea URL per l'immagine
    const imageUrl = URL.createObjectURL(file);
    const img = new Image();
    img.src = imageUrl;
    
    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
    });
    
    // Crea reader ZXing
    const codeReader = new ZXing.BrowserMultiFormatReader();
    
    // Scansiona l'immagine
    const result = await codeReader.decodeFromImageUrl(imageUrl);
    
    // Pulisci
    URL.revokeObjectURL(imageUrl);
    codeReader.reset();
    
    if (result && result.text) {
      const barcode = result.text;
      console.log('âœ… Barcode trovato:', barcode);
      
      // Inserisci nel campo
      document.getElementById('barcodeInput').value = barcode;
      
      resultDiv.innerHTML = `
        <div class="tiny" style="padding:12px;background:rgba(34,197,94,0.1);border-radius:8px;text-align:center">
          âœ… Codice trovato!<br>
          <strong style="font-size:16px;color:var(--primary)">${barcode}</strong><br><br>
          <button onclick="addToShoppingListFromBarcode('${barcode}')" 
                  style="padding:8px 16px;background:var(--primary);color:white;border:none;border-radius:8px;cursor:pointer">
            âž• Aggiungi alla Spesa
          </button>
        </div>
      `;
      
      // Cerca automaticamente dopo 300ms
      setTimeout(() => {
        if (typeof searchBarcode === 'function') {
          searchBarcode();
        }
      }, 300);
      
    } else {
      throw new Error('Nessun codice trovato');
    }
    
  } catch (error) {
    console.error('Errore scansione:', error);
    resultDiv.innerHTML = `
      <div class="tiny" style="padding:12px;background:rgba(239,68,68,0.1);border-radius:8px">
        âŒ <strong>Codice non rilevato</strong><br><br>
        <strong>Suggerimenti:</strong><br>
        â€¢ Foto nitida e ben illuminata<br>
        â€¢ Barcode ben visibile<br>
        â€¢ Prova con lo Scanner Live<br>
        â€¢ Oppure inserisci manualmente
      </div>
    `;
  }
}

// Funzione per aggiungere prodotto alla spesa
window.addBarcodeToList = function(productName, brand, calories) {
  const fullName = brand ? `${productName} (${brand})` : productName;
  
  const input = document.getElementById('nuovoItemSpesa');
  if (input) {
    input.value = fullName;
    
    if (typeof addGroceryItem === 'function') {
      addGroceryItem();
    }
  }
  
  if (typeof toast === 'function') toast(`âœ… ${productName} aggiunto!`);
  
  // Pulisci
  document.getElementById('barcodeInput').value = '';
  document.getElementById('barcodeResult').innerHTML = '';
};

// === ðŸ“· SCANSIONE BARCODE DA FOTO (QUAGGA) ===

window.scanBarcodeFromImage = async function() {
  const fileInput = document.getElementById('barcodeCamera');
  const resultDiv = document.getElementById('barcodeResult');
  
  if (!fileInput.files || fileInput.files.length === 0) return;
  
  resultDiv.innerHTML = '<div class="tiny" style="text-align:center;padding:10px">ðŸ“· Scansione foto in corso...</div>';
  
  try {
    const file = fileInput.files[0];
    
    // Carica Quagga se necessario
    if (!window.Quagga) {
      await loadQuaggaLibrary();
    }
    
    // Converti file in URL
    const imageUrl = URL.createObjectURL(file);
    
    // Scansiona con Quagga
    Quagga.decodeSingle({
      decoder: {
        readers: [
          "ean_reader",
          "ean_8_reader", 
          "upc_reader",
          "upc_e_reader",
          "code_128_reader"
        ]
      },
      locate: true,
      src: imageUrl
    }, function(result) {
      // Pulisci URL temporaneo
      URL.revokeObjectURL(imageUrl);
      
      if (result && result.codeResult) {
        const decodedText = result.codeResult.code;
        console.log('âœ… Barcode trovato da foto:', decodedText);
        
        // Inserisci nel campo
        document.getElementById('barcodeInput').value = decodedText;
        
        resultDiv.innerHTML = `
          <div class="tiny" style="padding:10px;background:rgba(34,197,94,0.1);border-radius:8px;text-align:center">
            âœ… Codice trovato: <strong>${decodedText}</strong><br>
            <span style="font-size:11px;color:var(--muted)">Ricerca prodotto in corso...</span>
          </div>
        `;
        
        // Cerca automaticamente
        setTimeout(() => {
          if (typeof searchBarcode === 'function') {
            searchBarcode();
          }
        }, 500);
        
      } else {
        resultDiv.innerHTML = `
          <div class="tiny" style="padding:12px;background:rgba(239,68,68,0.1);border-radius:8px">
            âŒ <strong>Codice non rilevato</strong><br><br>
            <strong>Suggerimenti:</strong><br>
            â€¢ Foto ben illuminata e nitida<br>
            â€¢ Barcode visibile e non sfocato<br>
            â€¢ Inquadratura ravvicinata<br>
            â€¢ Prova con lo Scanner Live<br>
            â€¢ Oppure inserisci manualmente
          </div>
        `;
      }
    });
    
  } catch (error) {
    console.error('Errore scansione foto:', error);
    resultDiv.innerHTML = `
      <div class="tiny" style="padding:12px;background:rgba(239,68,68,0.1);border-radius:8px">
        âŒ Errore: ${error.message}
      </div>
    `;
  }
};


window.showBarcodeHelp = function() {
  alert('ðŸ·ï¸ SCANSIONE CODICI A BARRE\n\nðŸ“· CON FOTO:\n1. Clicca "Scansiona con Fotocamera"\n2. Scatta foto del codice a barre\n3. L\'app lo rileverÃ  automaticamente\n\nâŒ¨ï¸ MANUALE:\n1. Trova il codice a barre (8 o 13 cifre)\n2. Digitalo nel campo\n3. Clicca ðŸ”\n\nðŸ‡®ðŸ‡¹ FUNZIONA MEGLIO CON:\nâ€¢ Prodotti italiani ed europei\nâ€¢ Prodotti confezionati\nâ€¢ Codici EAN-13 e UPC\n\nâ„¹ï¸ Alcuni prodotti potrebbero non avere tutti i dati (Nutri-Score, Eco-Score).');
};

// ========================================
// ðŸ½ï¸ MODALITÃ€ RISTORANTE
// ========================================

const restaurantMeals = {
  pizza: { nome: 'ðŸ• Pizza Margherita', kcal: 800, prot: 30, carb: 100, fat: 25 },
  pizzaquattro: { nome: 'ðŸ• Pizza 4 Stagioni', kcal: 950, prot: 35, carb: 110, fat: 35 },
  pasta: { nome: 'ðŸ Pasta al Pomodoro', kcal: 600, prot: 20, carb: 90, fat: 15 },
  pastacarbonara: { nome: 'ðŸ Pasta Carbonara', kcal: 850, prot: 30, carb: 80, fat: 40 },
  burger: { nome: 'ðŸ” Hamburger + Patatine', kcal: 1000, prot: 35, carb: 80, fat: 50 },
  sushi: { nome: 'ðŸ£ Sushi Misto (16pz)', kcal: 500, prot: 25, carb: 70, fat: 10 },
  insalata: { nome: 'ðŸ¥— Insalata Caesar', kcal: 400, prot: 20, carb: 20, fat: 25 },
  bistecca: { nome: 'ðŸ¥© Bistecca + Contorno', kcal: 700, prot: 50, carb: 30, fat: 35 },
  kebab: { nome: 'ðŸŒ¯ Kebab', kcal: 900, prot: 40, carb: 70, fat: 45 },
  pokebowl: { nome: 'ðŸ¥™ Poke Bowl', kcal: 650, prot: 35, carb: 60, fat: 20 },
  panino: { nome: 'ðŸ¥ª Panino Gourmet', kcal: 550, prot: 25, carb: 50, fat: 25 }
};

window.addRestaurantMeal = function() {
  const select = document.getElementById('ristorantePasto');
  const mealKey = select.value;
  
  if (!mealKey) {
    if (typeof toast === 'function') toast('âš ï¸ Seleziona un pasto');
    return;
  }
  
  const meal = restaurantMeals[mealKey];
  const today = new Date().toISOString().slice(0, 10);
  
  // Aggiungi al tracking giornaliero
  if (!dailyMeals[today]) {
    dailyMeals[today] = [];
  }
  
  dailyMeals[today].push({
    nome: meal.nome,
    kcal: meal.kcal,
    prot: meal.prot,
    carb: meal.carb,
    fat: meal.fat,
    timestamp: new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })
  });
  
  // ðŸ”¥ AGGIUNGI QUESTE RIGHE:
  localStorage.setItem('dailyMeals', JSON.stringify(dailyMeals));
  
  // Salva e aggiorna
  if (typeof saveDailyMealsIndexed === 'function') saveDailyMealsIndexed();
  if (typeof updateDailyTracking === 'function') updateDailyTracking();
  if (typeof updateDonutChart === 'function') updateDonutChart(); // ðŸ†•
  if (typeof renderMealTracking === 'function') renderMealTracking();
  if (typeof salvaTutto === 'function') salvaTutto();
  if (typeof toast === 'function') toast('âœ… Pasto aggiunto al tracking!');
  
  // Reset select
  select.value = '';
};
  
window.showRestaurantCustom = function() {
  const customDiv = document.getElementById('restaurantCustom');
  customDiv.style.display = customDiv.style.display === 'none' ? 'block' : 'none';
}

window.addCustomRestaurantMeal = function() {
  const name = document.getElementById('customMealName').value.trim();
  const kcal = parseInt(document.getElementById('customMealKcal').value);
  
  if (!name || !kcal) {
    if (typeof toast === 'function') toast('âš ï¸ Compila tutti i campi');
    return;
  }
  
  // Stima macro (proporzioni medie ristorante)
  const prot = Math.round(kcal * 0.15 / 4); // 15% proteine
  const carb = Math.round(kcal * 0.50 / 4); // 50% carbo
  const fat = Math.round(kcal * 0.35 / 9);  // 35% grassi
  
  const today = new Date().toISOString().split('T')[0];
  
  if (!window.dailyMeals) window.dailyMeals = {};
  if (!window.dailyMeals[today]) window.dailyMeals[today] = [];
  
  window.dailyMeals[today].push({
    nome: `ðŸ½ï¸ ${name}`,
    kcal: kcal,
    prot: prot,
    carb: carb,
    fat: fat,
    tipo: 'ristorante_custom',
    ora: new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })
  });
  
  // Salva in localStorage
localStorage.setItem('dailyMeals', JSON.stringify(window.dailyMeals));

if (typeof saveDailyMealsIndexed === 'function') saveDailyMealsIndexed();
if (typeof updateDailyTracking === 'function') updateDailyTracking();
if (typeof updateDonutChart === 'function') updateDonutChart(); // ðŸ†•
if (typeof renderMealTracking === 'function') renderMealTracking();
if (typeof salvaTutto === 'function') salvaTutto();
if (typeof toast === 'function') toast(`âœ… ${name} aggiunto!`);
  
  // Reset campi
  document.getElementById('customMealName').value = '';
  document.getElementById('customMealKcal').value = '';
  document.getElementById('restaurantCustom').style.display = 'none';
}

// ========================================
// TUTORIAL CLASSICO (OVERLAY)
// ========================================

const classicTutorialSlides = [
  {
    icon: "â„ï¸",
    title: "Benvenuto in Frigo Smart AI Ultra!",
    subtitle: "La tua gestione intelligente del frigorifero",
    content: `
      <p style="font-size: 18px; text-align: center; margin-bottom: 20px;">
        Frigo Smart ti aiuta a <span class="tutorial-highlight">gestire gli alimenti</span>, 
        <span class="tutorial-highlight">ridurre gli sprechi</span> e 
        <span class="tutorial-highlight">mangiare meglio</span>!
      </p>
      
      <div class="tutorial-grid">
        <div class="tutorial-card">
          <div class="tutorial-card-icon">ðŸ“‹</div>
          <div class="tutorial-card-title">Gestione alimenti</div>
        </div>
        <div class="tutorial-card">
          <div class="tutorial-card-icon">ðŸ¤–</div>
          <div class="tutorial-card-title">AI Intelligente</div>
        </div>
        <div class="tutorial-card">
          <div class="tutorial-card-icon">ðŸ“·</div>
          <div class="tutorial-card-title">Scansione foto</div>
        </div>
        <div class="tutorial-card">
          <div class="tutorial-card-icon">ðŸ“Š</div>
          <div class="tutorial-card-title">Statistiche</div>
        </div>
      </div>
      
      <p style="text-align: center; color: #94a3b8; margin-top: 20px;">
        Clicca <strong>Avanti</strong> per iniziare il tour oppure <strong>Salta</strong> per esplorare da solo!
      </p>
    `
  },
  {
    icon: "ðŸ“‹",
    title: "Gestisci i tuoi alimenti",
    subtitle: "Lista completa con scadenze",
    content: `
      <div class="tutorial-feature">
        <div class="tutorial-feature-title">ðŸ“ Aggiungi alimenti manualmente</div>
        <div class="tutorial-feature-desc">
          Inserisci nome, peso, scadenza e categoria. L'app ti avviserÃ  quando un alimento sta per scadere!
        </div>
      </div>
      
      <div class="tutorial-feature">
        <div class="tutorial-feature-title">ðŸ” Filtra per categoria</div>
        <div class="tutorial-feature-desc">
          Visualizza solo frutta, verdura, carne, latticini o bevande per trovare subito quello che cerchi.
        </div>
      </div>
      
      <div class="tutorial-feature">
        <div class="tutorial-feature-title">âš ï¸ Notifiche intelligenti</div>
        <div class="tutorial-feature-desc">
          Ricevi avvisi quando gli alimenti stanno per scadere: rosso per scaduti, arancione per quelli in scadenza oggi!
        </div>
      </div>
    `
  },
  {
    icon: "ðŸ“·",
    title: "Scansione con fotocamera",
    subtitle: "Rileva automaticamente il contenuto del frigo",
    content: `
      <p style="font-size: 16px; margin-bottom: 20px;">
        Usa l'<span class="tutorial-highlight">intelligenza artificiale</span> per scansionare il tuo frigo in pochi secondi!
      </p>
      
      <ul class="tutorial-list">
        <li>Scatta una foto del tuo frigorifero</li>
        <li>L'AI rileva automaticamente tutti gli alimenti visibili</li>
        <li>Conferma gli alimenti rilevati con un click</li>
        <li>Gli alimenti vengono aggiunti alla tua lista</li>
      </ul>
      
      <div style="background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; padding: 15px; border-radius: 8px; margin-top: 15px;">
        <strong style="color: #fca5a5;">âš ï¸ Nota importante:</strong>
        <p style="color: #cbd5e1; margin: 8px 0 0 0; font-size: 14px;">
          Per usare questa funzione Ã¨ necessario configurare la chiave API Groq nelle impostazioni. Ãˆ gratuita e veloce!
        </p>
      </div>
    `
  },
  {
    icon: "ðŸ¤–",
    title: "Assistente AI Avanzato",
    subtitle: "Il tuo chef virtuale sempre disponibile",
    content: `
      <div class="tutorial-feature">
        <div class="tutorial-feature-title">ðŸ’¬ Risposte intelligenti</div>
        <div class="tutorial-feature-desc">
          Chiedi "Quante calorie ha la pasta al pomodoro?" o "Suggeriscimi una ricetta con pollo"
        </div>
      </div>
      
      <div class="tutorial-feature">
        <div class="tutorial-feature-title">ðŸŽ¤ Comando vocale</div>
        <div class="tutorial-feature-desc">
          Parla con l'assistente e ricevi risposte vocali. Perfetto quando hai le mani occupate in cucina!
        </div>
      </div>
      
      <div class="tutorial-feature">
        <div class="tutorial-feature-title">ðŸ³ Consigli personalizzati</div>
        <div class="tutorial-feature-desc">
          Ricevi suggerimenti basati sugli alimenti che hai nel frigo e sui tuoi obiettivi nutrizionali
        </div>
      </div>
    `
  },
  {
    icon: "ðŸ“–",
    title: "Ricette personalizzate",
    subtitle: "Crea e cerca le tue ricette preferite",
    content: `
      <p style="font-size: 16px; margin-bottom: 20px;">
        Gestisci il tuo <span class="tutorial-highlight">ricettario digitale</span> completo!
      </p>
      
      <ul class="tutorial-list">
        <li><strong>Aggiungi ricette</strong> con ingredienti e valori nutrizionali</li>
        <li><strong>Cerca ricette</strong> per nome o ingrediente</li>
        <li><strong>Filtra per categoria</strong>: primi, secondi, dolci, vegetariane...</li>
        <li><strong>Ascolta le istruzioni</strong> con la sintesi vocale</li>
        <li><strong>Valori nutrizionali</strong> automatici per ogni ricetta</li>
      </ul>
      
      <div style="background: rgba(22, 163, 74, 0.1); border-left: 3px solid #16a34a; padding: 15px; border-radius: 8px; margin-top: 15px;">
        <strong style="color: #86efac;">ðŸ’¡ Suggerimento:</strong>
        <p style="color: #cbd5e1; margin: 8px 0 0 0; font-size: 14px;">
          Le ricette si integrano con il menÃ¹ settimanale e la lista della spesa!
        </p>
      </div>
    `
  },
  {
    icon: "ðŸ½ï¸",
    title: "Pianifica il menÃ¹ settimanale",
    subtitle: "Organizza i pasti per tutta la settimana",
    content: `
      <div class="tutorial-feature">
        <div class="tutorial-feature-title">ðŸ“… MenÃ¹ completo</div>
        <div class="tutorial-feature-desc">
          Pianifica colazione, pranzo, cena e spuntini per ogni giorno della settimana
        </div>
      </div>
      
      <div class="tutorial-feature">
        <div class="tutorial-feature-title">ðŸ”„ Integrazione con ricette</div>
        <div class="tutorial-feature-desc">
          Seleziona le tue ricette salvate o aggiungi pasti personalizzati velocemente
        </div>
      </div>
      
      <div class="tutorial-feature">
        <div class="tutorial-feature-title">ðŸ“Š Valori nutrizionali giornalieri</div>
        <div class="tutorial-feature-desc">
          Vedi automaticamente calorie, proteine, carboidrati e grassi per ogni giorno
        </div>
      </div>
    `
  },
  {
    icon: "ðŸ›’",
    title: "Lista della spesa intelligente",
    subtitle: "Non dimenticare mai nulla",
    content: `
      <p style="font-size: 16px; margin-bottom: 20px;">
        La lista della spesa piÃ¹ <span class="tutorial-highlight">smart</span> che tu abbia mai usato!
      </p>
      
      <ul class="tutorial-list">
        <li><strong>Aggiungi prodotti</strong> manualmente con quantitÃ </li>
        <li><strong>Genera automaticamente</strong> la spesa dal menÃ¹ settimanale</li>
        <li><strong>Spunta gli acquisti</strong> mentre sei al supermercato</li>
        <li><strong>Svuota e riutilizza</strong> la lista quando vuoi</li>
      </ul>
      
      <div style="background: rgba(79, 195, 247, 0.1); border-left: 3px solid #4fc3f7; padding: 15px; border-radius: 8px; margin-top: 15px;">
        <strong style="color: #4fc3f7;">âœ¨ Funzione Pro:</strong>
        <p style="color: #cbd5e1; margin: 8px 0 0 0; font-size: 14px;">
          Clicca "Genera da menÃ¹" per creare automaticamente la spesa basata sui pasti pianificati!
        </p>
      </div>
    `
  },
  {
    icon: "ðŸ’ª",
    title: "Traccia il tuo fabbisogno",
    subtitle: "Raggiungi i tuoi obiettivi nutrizionali",
    content: `
      <div class="tutorial-feature">
        <div class="tutorial-feature-title">âš–ï¸ Calcolo personalizzato</div>
        <div class="tutorial-feature-desc">
          Inserisci etÃ , peso, altezza, sesso e livello di attivitÃ  per calcolare il tuo fabbisogno calorico ideale
        </div>
      </div>
      
      <div class="tutorial-feature">
        <div class="tutorial-feature-title">ðŸŽ¯ Obiettivi chiari</div>
        <div class="tutorial-feature-desc">
          Scegli se mantenere, perdere o aumentare peso. L'app calcola le calorie target automaticamente
        </div>
      </div>
      
      <div class="tutorial-feature">
        <div class="tutorial-feature-title">ðŸ“ Registra i pasti</div>
        <div class="tutorial-feature-desc">
          Tieni traccia di ciÃ² che mangi ogni giorno e monitora le tue macro (proteine, carboidrati, grassi)
        </div>
      </div>
    `
  },
  {
    icon: "ðŸ“Š",
    title: "Statistiche e andamento",
    subtitle: "Monitora i tuoi progressi nel tempo",
    content: `
      <p style="font-size: 16px; margin-bottom: 20px;">
        Visualizza i tuoi dati con <span class="tutorial-highlight">grafici interattivi</span>!
      </p>
      
      <div class="tutorial-grid">
        <div class="tutorial-card">
          <div class="tutorial-card-icon">ðŸ“ˆ</div>
          <div class="tutorial-card-title">Andamento calorico</div>
        </div>
        <div class="tutorial-card">
          <div class="tutorial-card-icon">ðŸ¥—</div>
          <div class="tutorial-card-title">Distribuzione macro</div>
        </div>
        <div class="tutorial-card">
          <div class="tutorial-card-icon">âš–ï¸</div>
          <div class="tutorial-card-title">Peso corporeo</div>
        </div>
        <div class="tutorial-card">
          <div class="tutorial-card-icon">ðŸ“…</div>
          <div class="tutorial-card-title">Cronologia pasti</div>
        </div>
      </div>
      
      <p style="text-align: center; color: #94a3b8; margin-top: 20px; font-size: 14px;">
        Analizza le tendenze settimanali e mensili per ottimizzare la tua alimentazione
      </p>
    `
  },
  {
    icon: "âš™ï¸",
    title: "Impostazioni e personalizzazione",
    subtitle: "Configura l'app come preferisci",
    content: `
      <ul class="tutorial-list">
        <li><strong>Tema scuro/chiaro</strong> - Passa dalla modalitÃ  chiara a quella scura</li>
        <li><strong>Chiave API Groq</strong> - Necessaria per fotocamera e assistente AI</li>
        <li><strong>Gestione dati</strong> - Esporta, importa o elimina tutti i dati</li>
        <li><strong>Informazioni app</strong> - Versione e crediti</li>
        <li><strong>Tutorial</strong> - Rivedi queste guide quando vuoi!</li>
      </ul>
      
      <div style="background: rgba(79, 195, 247, 0.1); border-left: 3px solid #4fc3f7; padding: 15px; border-radius: 8px; margin-top: 15px;">
        <strong style="color: #4fc3f7;">ðŸ”’ Privacy:</strong>
        <p style="color: #cbd5e1; margin: 8px 0 0 0; font-size: 14px;">
          Tutti i tuoi dati sono salvati localmente sul tuo dispositivo. Niente cloud, massima privacy!
        </p>
      </div>
    `
  },
  {
    icon: "ðŸŽ‰",
    title: "Sei pronto per iniziare!",
    subtitle: "Inizia a usare Frigo Smart AI Ultra",
    content: `
      <p style="font-size: 18px; text-align: center; margin-bottom: 25px;">
        Hai completato il tutorial! ðŸŽŠ
      </p>
      
      <div style="background: linear-gradient(135deg, rgba(7, 127, 191, 0.1), rgba(79, 195, 247, 0.1)); border-radius: 12px; padding: 20px; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 15px;">â„ï¸</div>
        <h3 style="color: #4fc3f7; margin: 0 0 10px 0;">Consigli finali:</h3>
        <ul class="tutorial-list" style="text-align: left;">
          <li>Configura subito la chiave API Groq per sbloccare tutte le funzioni AI</li>
          <li>Inizia aggiungendo alcuni alimenti nella sezione <strong>ðŸ“‹ Lista</strong></li>
          <li>Prova la fotocamera per scansionare il tuo frigo</li>
          <li>Crea le tue ricette preferite</li>
          <li>Calcola il tuo fabbisogno calorico</li>
        </ul>
      </div>
      
      <p style="text-align: center; color: #94a3b8; margin-top: 25px; font-size: 14px;">
        Puoi rivedere questo tutorial in qualsiasi momento dalle impostazioni!
      </p>
      
      <div style="text-align: center; margin-top: 30px;">
        <button class="tutorial-btn tutorial-btn-start" onclick="completeClassicTutorial()">
          ðŸš€ Inizia ora!
        </button>
      </div>
    `
  }
];

let currentClassicSlide = 0;

function initClassicTutorial() {
  const progressContainer = document.getElementById('classic-tutorial-progress');
  progressContainer.innerHTML = '';
  for (let i = 0; i < classicTutorialSlides.length; i++) {
    const dot = document.createElement('div');
    dot.className = 'progress-dot' + (i === 0 ? ' active' : '');
    dot.id = `classic-progress-dot-${i}`;
    progressContainer.appendChild(dot);
  }
  showClassicSlide(0);
}

function showClassicSlide(index) {
  if (index < 0 || index >= classicTutorialSlides.length) return;
  
  currentClassicSlide = index;
  const slide = classicTutorialSlides[index];
  
  document.getElementById('classic-tutorial-icon').textContent = slide.icon;
  document.getElementById('classic-tutorial-title').textContent = slide.title;
  document.getElementById('classic-tutorial-subtitle').textContent = slide.subtitle;
  document.getElementById('classic-tutorial-content').innerHTML = slide.content;
  
  for (let i = 0; i < classicTutorialSlides.length; i++) {
    const dot = document.getElementById(`classic-progress-dot-${i}`); 
    if (dot) {
      dot.className = 'progress-dot' + (i === index ? ' active' : '');
    }
  }
  
  const nextBtn = document.getElementById('classic-next-btn');
  const skipBtn = document.getElementById('classic-skip-btn');
  
  if (index === classicTutorialSlides.length - 1) {
    nextBtn.style.display = 'none';
    skipBtn.style.display = 'none';
  } else {
    nextBtn.style.display = 'block';
    skipBtn.style.display = 'block';
  }
  
  // ðŸ‘‡ AGGIUNTO: Reset scroll quando mostri una nuova slide
  const content = document.getElementById('classic-tutorial-content');
  if (content) content.scrollTop = 0;
}

function nextClassicSlide() {
  if (currentClassicSlide < classicTutorialSlides.length - 1) {
    showClassicSlide(currentClassicSlide + 1);
  }
  
  // ðŸ‘‡ AGGIUNTO: Reset scroll quando cambi slide
  const content = document.getElementById('classic-tutorial-content');
  if (content) content.scrollTop = 0;
}

function skipClassicTutorial() {
  if (confirm('Vuoi davvero saltare il tutorial? Potrai rivederlo dalle impostazioni.')) {
    closeClassicTutorial();
  }
}

function completeClassicTutorial() {
  closeClassicTutorial();
  alert('âœ… Tutorial completato! Buon utilizzo di Frigo Smart! â„ï¸');
}

function closeClassicTutorial() {
  const overlay = document.getElementById('tutorial-overlay');
  overlay.style.opacity = '0';
  setTimeout(() => {
    overlay.classList.remove('active');
  }, 400);
}

function openClassicTutorial() {
  currentClassicSlide = 0;
  initClassicTutorial();
  const overlay = document.getElementById('tutorial-overlay');
  overlay.classList.add('active');
  setTimeout(() => {
    overlay.style.opacity = '1';
  }, 10);
}

// ========================================
// TUTORIAL INTERATTIVO (CON FREEZY)
// ========================================

const interactiveTutorialSteps = [
  {
    target: null,
    speech: "Ciao! ðŸ‘‹ Sono Freezy, la tua guida in Frigo Smart! Vuoi che ti mostri come funziona l'app?",
    buttons: [
      { text: "â­ï¸ No grazie", action: "skip" },
      { text: "Certo! âž¡ï¸", action: "next" }
    ]
  },
  {
    target: 'nav button[onclick*="lista"]',
    speech: "Perfetto! Iniziamo dalla sezione ðŸ“‹ <strong>Lista</strong>. Qui puoi aggiungere e gestire tutti gli alimenti nel tuo frigo!",
    tooltip: {
      title: "ðŸ“‹ Lista Alimenti",
      desc: "Aggiungi alimenti con nome, peso, scadenza e categoria. Riceverai notifiche quando stanno per scadere!"
    },
    arrowDirection: "bottom"
  },
  {
    target: 'nav button[onclick*="fotocamera"]',
    speech: "Fantastico! Ora guarda qui ðŸ“· - Con la <strong>Fotocamera</strong> puoi scansionare il tuo frigo e l'AI rileverÃ  automaticamente gli alimenti!",
    tooltip: {
      title: "ðŸ“· Scansione Intelligente",
      desc: "Scatta una foto e l'intelligenza artificiale riconoscerÃ  gli alimenti. Richiede la chiave API Groq (gratuita)."
    },
    arrowDirection: "bottom"
  },
  {
    target: 'nav button[onclick*="assistente"]',
    speech: "Questo Ã¨ il mio preferito! ðŸ¤– L'<strong>Assistente AI</strong> risponde alle tue domande su alimentazione, ricette e molto altro!",
    tooltip: {
      title: "ðŸ¤– Assistente AI",
      desc: "Chiedi qualsiasi cosa: calorie, ricette, consigli nutrizionali. Supporta anche comandi vocali!"
    },
    arrowDirection: "bottom"
  },
  {
    target: 'nav button[onclick*="ricette"]',
    speech: "Nella sezione ðŸ“– <strong>Ricette</strong> puoi salvare tutte le tue ricette preferite con ingredienti e valori nutrizionali!",
    tooltip: {
      title: "ðŸ“– Ricettario Digitale",
      desc: "Crea, cerca e organizza le tue ricette. Include valori nutrizionali e sintesi vocale!"
    },
    arrowDirection: "bottom"
  },
  {
    target: 'nav button[onclick*="aggiungiRicetta"]',
    speech: "Con questo pulsante âž• puoi aggiungere velocemente una nuova ricetta al tuo ricettario personale!",
    tooltip: {
      title: "âž• Aggiungi Ricetta",
      desc: "Crea nuove ricette inserendo ingredienti, porzioni e procedimento."
    },
    arrowDirection: "bottom"
  },
  {
    target: 'nav button[onclick*="menu"]',
    speech: "Qui puoi pianificare il tuo ðŸ½ï¸ <strong>MenÃ¹ Settimanale</strong> con colazione, pranzo, cena e spuntini per ogni giorno!",
    tooltip: {
      title: "ðŸ½ï¸ MenÃ¹ Settimanale",
      desc: "Organizza i pasti di tutta la settimana. Calcolo automatico dei valori nutrizionali giornalieri!"
    },
    arrowDirection: "bottom"
  },
  {
    target: 'nav button[onclick*="spesa"]',
    speech: "La ðŸ›’ <strong>Lista della Spesa</strong> si genera automaticamente dal menÃ¹! Non dimenticherai piÃ¹ nulla al supermercato!",
    tooltip: {
      title: "ðŸ›’ Lista della Spesa Smart",
      desc: "Crea manualmente o genera automaticamente dal menÃ¹ settimanale. Spunta gli acquisti mentre fai shopping!"
    },
    arrowDirection: "bottom"
  },
  {
    target: 'nav button[onclick*="fabbisogno"]',
    speech: "In ðŸ’ª <strong>Fabbisogno</strong> calcoli le tue calorie ideali e registri cosa mangi ogni giorno per raggiungere i tuoi obiettivi!",
    tooltip: {
      title: "ðŸ’ª Tracking Nutrizionale",
      desc: "Calcola il fabbisogno calorico personalizzato e tieni traccia dei pasti giornalieri."
    },
    arrowDirection: "bottom"
  },
  {
    target: 'nav button[onclick*="andamento"]',
    speech: "Con ðŸ“ˆ <strong>Andamento</strong> visualizzi grafici interattivi del tuo progresso: calorie, peso, macro e molto altro!",
    tooltip: {
      title: "ðŸ“ˆ Statistiche & Grafici",
      desc: "Monitora i tuoi progressi nel tempo con grafici settimanali e mensili."
    },
    arrowDirection: "bottom"
  },
  {
    target: 'nav button[onclick*="stat"]',
    speech: "Nella sezione ðŸ“Š <strong>Statistiche</strong> trovi il riepilogo completo dei tuoi dati nutrizionali e la cronologia dei pasti!",
    tooltip: {
      title: "ðŸ“Š Statistiche Dettagliate",
      desc: "Analisi completa dell'andamento alimentare con distribuzione macro e tendenze."
    },
    arrowDirection: "bottom"
  },
  {
    target: 'nav button[onclick*="impostazioni"]',
    speech: "E infine, nelle âš™ï¸ <strong>Impostazioni</strong> configuri la chiave API, cambi il tema e gestisci i tuoi dati!",
    tooltip: {
      title: "âš™ï¸ Impostazioni",
      desc: "Configura l'app: tema scuro/chiaro, chiave API Groq, esporta/importa dati."
    },
    arrowDirection: "bottom"
  },
  {
    target: null,
    speech: "Perfetto! ðŸŽ‰ Ora conosci tutte le funzionalitÃ  di Frigo Smart! Se hai bisogno di aiuto, torna nelle impostazioni!",
    buttons: [
      { text: "ðŸš€ Inizia!", action: "complete" }
    ]
  }
];

let currentInteractiveStep = 0;
let interactiveTutorialActive = false;

function initInteractiveTutorial() {
  console.log('âœ… Tutorial inizializzato');
}

function startInteractiveTutorial() {
  console.log('ðŸŽ¬ Tutorial avviato!'); // ðŸ‘ˆ DEBUG
  
  // Forza reset se era giÃ  attivo
  if (interactiveTutorialActive) {
    console.log('ðŸ”„ Reset tutorial precedente...');
    endInteractiveTutorial();
  }
  
  interactiveTutorialActive = true;
  currentInteractiveStep = 0;
  
  console.log('ðŸ“‹ Inizializzo tutorial...');
  initInteractiveTutorial();
  
  console.log('ðŸ“Š Mostro progress bar...');
  setTimeout(() => {
    initProgressBar(13);
  }, 100);
  
  console.log('ðŸŽ­ Attivo elementi UI...');
  
  const guideChar = document.getElementById('guide-character');
  const overlay = document.getElementById('interactive-overlay');
  const freezyVideo = document.getElementById('freezy-video-container');
  const buttons = document.getElementById('tutorial-buttons');
  
  if (guideChar) guideChar.classList.add('active');
  if (overlay) overlay.classList.add('active');
  if (freezyVideo) freezyVideo.classList.add('active');
  if (buttons) buttons.classList.add('active');

  console.log('âœ… Elementi attivati, avvio primo step...');
  
  setTimeout(() => {
    console.log('ðŸ‘‰ Mostro step 0');
    showInteractiveStep(0);
  }, 500);
}

function showInteractiveStep(stepIndex) {
  if (stepIndex < 0 || stepIndex >= interactiveTutorialSteps.length) return;
  
  // ðŸ†• PREVIENI SOVRAPPOSIZIONI
  if (window.stepTransitioning) return;
  window.stepTransitioning = true;
  
  currentInteractiveStep = stepIndex;
  
  // ðŸ§¹ PULIZIA TOTALE PRIMA DI MOSTRARE IL NUOVO STEP
  cleanupCurrentStep();
  
  setTimeout(() => {
    const step = interactiveTutorialSteps[stepIndex];
    
    // Aggiorna progress bar
    updateProgressBar(stepIndex, 13);
    
    // Aggiorna testo
    const guideText = document.getElementById('guide-text');
    const guideSpeech = document.getElementById('guide-speech');
    guideText.innerHTML = step.speech;
    
    // Posizionamento card
    const guideCard = document.getElementById('guide-character');
    if (step.target) {
      guideCard.style.bottom = '20px';
      guideCard.style.top = 'auto';
    } else {
      guideCard.style.bottom = '80px';
      guideCard.style.top = 'auto';
    }
    
    // Gestione bottoni
    const skipBtn = document.getElementById('skip-btn');
    const nextBtn = document.getElementById('next-btn');
    
    if (stepIndex === interactiveTutorialSteps.length - 1) {
      skipBtn.style.display = 'none';
      nextBtn.innerHTML = 'ðŸš€ Inizia!';
      nextBtn.onclick = function() {
        completeInteractiveTutorial();
      };
    } else {
      skipBtn.style.display = 'block';
      nextBtn.innerHTML = 'Avanti âž¡ï¸';
      nextBtn.onclick = function() {
        nextInteractiveStep();
      };
    }
    
    guideSpeech.classList.add('active');
    
    // Mostra nuovo target con delay
    if (step.target) {
      const targetElement = document.querySelector(step.target);
      if (targetElement) {
        setTimeout(() => {
          targetElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center',
            inline: 'center'
          });
          
          setTimeout(() => {
            targetElement.classList.add('interactive-highlight');
            
            const navBar = document.querySelector('nav');
            if (navBar) {
              navBar.style.position = 'relative';
              navBar.style.zIndex = '300000';
            }
            
            if (step.tooltip) {
              createInteractiveTooltip(targetElement, step.tooltip, step.arrowDirection);
            }
          }, 300);
        }, 100);
      }
    }
    
  // ðŸ§© FINE: sblocca il prossimo step SOLO dopo il rendering completo
setTimeout(() => {
  window.stepTransitioning = false;
}, 800);
}, 200);
}

function cleanupCurrentStep() {
  // Rimuovi TUTTI i tooltip esistenti
  document.querySelectorAll('.interactive-tooltip').forEach(el => {
    el.remove();
  });
  
  // Rimuovi TUTTI gli highlight
  document.querySelectorAll('.interactive-highlight').forEach(el => {
    el.classList.remove('interactive-highlight');
  });
  
  // Rimuovi TUTTI gli effetti neon dai tasti
  document.querySelectorAll('nav button').forEach(btn => {
    btn.classList.remove('interactive-highlight', 'neon', 'glow', 'pulse');
    btn.style.boxShadow = '';
    btn.style.animation = '';
    btn.style.filter = '';
    btn.style.border = '';
  });
  
  // Reset navbar z-index
  const navBar = document.querySelector('nav');
  if (navBar) {
    navBar.style.zIndex = '';
    navBar.style.position = '';
  }
}


function createInteractiveTooltip(targetElement, tooltip, direction) {
  const tooltipEl = document.createElement('div');
  tooltipEl.className = `interactive-tooltip arrow-${direction || 'bottom'}`;
  tooltipEl.innerHTML = `
    <div class="tooltip-title">${tooltip.title}</div>
    <div class="tooltip-desc">${tooltip.desc}</div>
  `;
  
  document.body.appendChild(tooltipEl);
  
  const rect = targetElement.getBoundingClientRect();
  
  // PRIMA calcoliamo le dimensioni del tooltip
  tooltipEl.style.visibility = 'hidden';
  tooltipEl.style.display = 'block';
  const tooltipRect = tooltipEl.getBoundingClientRect();
  tooltipEl.style.visibility = 'visible';
  
  // ðŸ”§ FIX: Posiziona SEMPRE SOPRA il bottone per non coprirlo
  let top = rect.top - tooltipRect.height - 20; // Sopra con margine
  let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
  
  // Se va troppo in alto, mettilo sotto
  if (top < 10) {
    top = rect.bottom + 20; // Sotto il bottone
    tooltipEl.className = `interactive-tooltip arrow-top`; // Cambia direzione freccia
  } else {
    tooltipEl.className = `interactive-tooltip arrow-bottom`; // Freccia che punta in basso
  }
  
  // Controllo margini laterali
  if (left < 10) left = 10;
  if (left + tooltipRect.width > window.innerWidth - 10) {
    left = window.innerWidth - tooltipRect.width - 10;
  }
  
  tooltipEl.style.top = `${top}px`;
  tooltipEl.style.left = `${left}px`;
  tooltipEl.style.zIndex = '999998'; // Sotto il progress ma sopra tutto il resto
  
  setTimeout(() => {
    tooltipEl.classList.add('active');
  }, 100);
}

function positionInteractiveArrow(targetElement, direction) {
  const arrow = document.getElementById('interactive-arrow');
  const rect = targetElement.getBoundingClientRect();
  
  let top = rect.bottom + 20;
  let left = rect.left + (rect.width / 2) - 30;
  let rotation = 0;
  
  arrow.style.top = `${top}px`;
  arrow.style.left = `${left}px`;
  arrow.style.transform = `rotate(${rotation}deg)`;
  arrow.classList.add('active');
}

function nextInteractiveStep() {
  // Previeni click multipli
  if (window.skipDebounce) return;
  window.skipDebounce = true;
  
  setTimeout(() => {
    window.skipDebounce = false;
  }, 500);
  
  if (currentInteractiveStep < interactiveTutorialSteps.length - 1) {
    showInteractiveStep(currentInteractiveStep + 1);
  }
}

function skipInteractiveTutorial() {
  if (confirm('Vuoi davvero saltare il tutorial? Potrai rivederlo dalle impostazioni.')) {
    endInteractiveTutorial();
    localStorage.setItem('interactiveTutorialCompleted', 'true');
  }
}

function completeInteractiveTutorial() {
endInteractiveTutorial();
  localStorage.setItem('interactiveTutorialCompleted', 'true');
  
  setTimeout(() => {
    alert('âœ… Tutorial completato! Buon utilizzo di Frigo Smart! â„ï¸\n\nSe hai bisogno di aiuto, torna nelle impostazioni!');
  }, 500);
}

function endInteractiveTutorial() {
  interactiveTutorialActive = false;
  
  // PULIZIA COMPLETA
  cleanupCurrentStep();
  
  // Nascondi progress bar
  hideProgressBar();
  
  // Rimuovi classi active
  const elementsToDeactivate = [
    'guide-character',
    'interactive-overlay',
    'interactive-progress',
    'freezy-video-container',
    'tutorial-buttons'
  ];
  
 elementsToDeactivate.forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    el.classList.remove('active');
    el.style.display = 'none';
  }
});

  
  // PULIZIA EXTRA per essere sicuri
  setTimeout(() => {
    // Rimuovi qualsiasi tooltip residuo
    document.querySelectorAll('.interactive-tooltip').forEach(el => el.remove());
    
    // Pulisci TUTTI i bottoni della navbar
    document.querySelectorAll('nav button, .btn-primary, .btn-ghost').forEach(btn => {
      btn.classList.remove('interactive-highlight', 'neon', 'glow', 'pulse');
      btn.style.cssText = btn.style.cssText
        .replace(/box-shadow:[^;]+;?/g, '')
        .replace(/animation:[^;]+;?/g, '')
        .replace(/filter:[^;]+;?/g, '');
    });
    
    // Reset navbar finale
    const nav = document.querySelector('nav');
    if (nav) {
      nav.style.cssText = '';
    }
  }, 500);
}

// ========================================
// CONTROLLO PRIMO AVVIO
// ========================================

function checkFirstLaunch() {
  const completed = localStorage.getItem('interactiveTutorialCompleted');
  if (!completed) {
    setTimeout(() => {
      startInteractiveTutorial();
    }, 1500);
  }
}

// Avvia controllo al caricamento
window.addEventListener('DOMContentLoaded', checkFirstLaunch);

// ========================================
// ðŸŽ¤ RICONOSCIMENTO VOCALE
// ========================================

let recognition = null;
let isListening = false;
let recordingInterval = null;
let recordingStartTime = 0;

// Inizializza riconoscimento vocale
function initVoiceRecognition() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    console.warn('âš ï¸ Riconoscimento vocale non supportato');
    return null;
  }
  
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recog = new SpeechRecognition();
  
  recog.lang = 'it-IT';
  recog.continuous = false;
  recog.interimResults = false;
  recog.maxAlternatives = 1;
  
  recog.onstart = function() {
  isListening = true;
  showRecordingBar();
};
  
  recog.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    console.log('ðŸ“ Riconosciuto:', transcript);
    
    // Inserisci il testo nel textarea
    document.getElementById('inputUtente').value = transcript;
    showVoiceStatus(`âœ… Ho capito: "${transcript}"`);
    
    // Invia automaticamente la domanda all'AI
setTimeout(() => {
  handleAssist();
}, 500);
  };
  
  recog.onerror = function(event) {
  console.error('âŒ Errore riconoscimento:', event.error);
  hideRecordingBar();
  
  let errorMsg = 'âŒ ';
  switch(event.error) {
    case 'no-speech':
      errorMsg += 'Non ho sentito nulla';
      break;
    case 'audio-capture':
      errorMsg += 'Microfono non disponibile';
      break;
    case 'not-allowed':
      errorMsg += 'Permesso microfono negato';
      break;
    default:
      errorMsg += 'Errore: ' + event.error;
  }
  
  if (typeof toast === 'function') toast(errorMsg);
  isListening = false;
};
  
  recog.onend = function() {
  isListening = false;
  hideRecordingBar();
};
  
  return recog;
}

// Toggle riconoscimento vocale
function toggleVoiceInput() {
  if (!recognition) {
    recognition = initVoiceRecognition();
    if (!recognition) {
      alert('âŒ Il tuo browser non supporta il riconoscimento vocale.\n\nProva con Chrome, Edge o Safari.');
      return;
    }
  }
  
  if (isListening) {
    stopRecordingManually();
  } else {
    try {
      recognition.start();
      showRecordingBar();
    } catch(e) {
      console.error('Errore avvio riconoscimento:', e);
      if (typeof toast === 'function') toast('âŒ Errore microfono');
    }
  }
}

function showRecordingBar() {
  const bar = document.getElementById('recordingBar');
  const voiceBtn = document.getElementById('voiceBtn');
  
  bar.style.display = 'block';
  voiceBtn.innerHTML = 'â¹ï¸ Stop';
  voiceBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
  
  // Timer
  recordingStartTime = Date.now();
  recordingInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('recordingTime').textContent = 
      `${minutes}:${seconds.toString().padStart(2, '0')}`;
  }, 100);
}

function hideRecordingBar() {
  const bar = document.getElementById('recordingBar');
  const voiceBtn = document.getElementById('voiceBtn');
  
  bar.style.display = 'none';
  voiceBtn.innerHTML = 'ðŸŽ¤';
  voiceBtn.style.background = '';
  
  if (recordingInterval) {
    clearInterval(recordingInterval);
    recordingInterval = null;
  }
}

function stopRecordingManually() {
  if (recognition && isListening) {
    recognition.stop();
  }
  hideRecordingBar();
}

function cancelRecording() {
  if (recognition && isListening) {
    recognition.abort();
  }
  hideRecordingBar();
  document.getElementById('inputUtente').value = '';
  if (typeof toast === 'function') toast('âŒ Registrazione annullata');
}


// Mostra stato vocale
function showVoiceStatus(message) {
  const status = document.getElementById('voiceStatus');
  status.textContent = message;
  status.style.display = 'block';
}

// Nascondi stato vocale
function hideVoiceStatus() {
  const status = document.getElementById('voiceStatus');
  status.style.display = 'none';
}

// ========================================
// ðŸŽ¯ COMANDI VOCALI AVANZATI (OPZIONALE)
// ========================================

// Interpreta comandi vocali per azioni dirette
function processVoiceCommand(text) {
  const lowerText = text.toLowerCase();
  
  // Comando: Aggiungi alla spesa
  if (lowerText.includes('aggiungi') && (lowerText.includes('spesa') || lowerText.includes('lista'))) {
    // Estrai il nome del prodotto
    const match = text.match(/aggiungi\s+(.+?)\s+(alla\s+spesa|alla\s+lista)/i);
    if (match) {
      const product = match[1];
      addToShoppingList(product);
      return true;
    }
  }
  
  // Comando: Aggiungi alimento al frigo
  if (lowerText.includes('aggiungi') && (lowerText.includes('frigo') || lowerText.includes('alimento'))) {
    const match = text.match(/aggiungi\s+(.+?)\s+(al\s+frigo|come\s+alimento)/i);
    if (match) {
      const food = match[1];
      // Apri la sezione lista e pre-compila
      show('lista');
      document.getElementById('nome').value = food;
      if (typeof toast === 'function') toast(`âœ… Alimento "${food}" pronto da aggiungere!`);
      return true;
    }
  }
  
  return false;
}

// Helper: Aggiungi alla lista della spesa
function addToShoppingList(product) {
  if (!window.groceryList) window.groceryList = [];
  
  window.groceryList.push({
    nome: product,
    quantita: '1',
    acquistato: false,
    timestamp: Date.now()
  });
  
   if (typeof saveGroceryIndexed === 'function') saveGroceryIndexed();
  if (typeof renderGrocery === 'function') renderGrocery();
  if (typeof toast === 'function') toast(`âœ… "${product}" aggiunto alla spesa!`);
}
</script>

</script>

<!-- âœ… FIX: video, bottone â€œIniziaâ€ e vignette solo durante il tutorial -->
<style>
  /* Nascondi SEMPRE di base */
  #freezy-video-container,
  #tutorial-buttons {
    display: none !important;
  }

  /* Mostra SOLO quando la guida del tutorial Ã¨ attiva */
  body:has(#guide-character.active) #freezy-video-container {
    display: block !important;
  }

  body:has(#guide-character.active) #tutorial-buttons {
    display: flex !important;
  }

  /* Le vignette (tooltip) devono sparire fuori dal tutorial */
  body:not(:has(#interactive-overlay.active)) .interactive-tooltip {
    display: none !important;
  }

  /* ðŸ”§ Rimuove eventuali effetti neon/pulse dopo il tutorial */
  body:not(:has(#interactive-overlay.active)) #tutorial-buttons button,
  body:not(:has(#interactive-overlay.active)) #tutorial-buttons .glow,
  body:not(:has(#interactive-overlay.active)) #tutorial-buttons .pulse,
  body:not(:has(#interactive-overlay.active)) #tutorial-buttons .neon {
    box-shadow: none !important;
    animation: none !important;
    filter: none !important;
    border-color: transparent !important;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const video = document.getElementById("freezy-video-container");
  const button = document.getElementById("tutorial-buttons");
  let hideTimeout = null;
  let stepStartTime = null; // â­ Timestamp inizio step
  let minStepDuration = 1500; // â­ Tempo minimo per step (1.5 secondi)
  
  // â­ Funzione chiamata all'inizio di ogni step del tutorial
  window.startTutorialStep = function() {
    stepStartTime = Date.now();
  };
  
  const checkHide = () => {
    const overlay = document.getElementById("interactive-overlay");
    const guide = document.getElementById("guide-character");
    
    // se overlay e guida non sono attivi, nasconde tutto
    if (
      overlay && !overlay.classList.contains("active") &&
      guide && !guide.classList.contains("active")
    ) {
      clearTimeout(hideTimeout);
      
      // â­ Calcola quanto tempo Ã¨ passato dall'inizio dello step
      const elapsed = stepStartTime ? Date.now() - stepStartTime : minStepDuration;
      const remainingTime = Math.max(0, minStepDuration - elapsed);
      
      hideTimeout = setTimeout(() => {
        // Rimuove le vignette
        document.querySelectorAll(".interactive-tooltip").forEach(t => t.remove());
        // Nasconde video
        if (video) {
          video.style.display = "none";
          video.classList.remove("active");
        }
        // Nasconde pulsanti e rimuove neon residui
        if (button) {
          button.style.display = "none";
          button.classList.remove("active", "glow", "pulse");
          document.querySelectorAll("#tutorial-buttons button").forEach(btn => {
            btn.classList.remove("glow", "pulse", "neon");
            btn.style.boxShadow = "none";
          });
        }
        stepStartTime = null; // Reset timestamp
      }, remainingTime + 300); // â­ Aspetta il tempo rimanente + 300ms di buffer
    }
  };
  
  // osserva cambiamenti di classi su tutto il documento
  const observer = new MutationObserver(() => {
    // â­ Se un nuovo step diventa attivo, resetta il timer
    const overlay = document.getElementById("interactive-overlay");
    const guide = document.getElementById("guide-character");
    if ((overlay && overlay.classList.contains("active")) ||
        (guide && guide.classList.contains("active"))) {
      if (!stepStartTime) {
        stepStartTime = Date.now();
      }
    }
    checkHide();
  });
  
  observer.observe(document.body, {
    attributes: true,
    subtree: true,
    attributeFilter: ["class"]
  });
});
</script>


<!-- NUOVA NAVBAR -->
<div class="navbar-container">
    <nav class="navbar" aria-label="Navigazione principale">
        
        <!-- GRUPPO SINISTRA: HOME + SPESA -->
        <div class="nav-group nav-group-left">
            <button class="nav-item" data-tab="home" aria-label="Home">
                <div class="nav-icon">
                    <svg viewBox="0 0 24 24">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                    </svg>
                </div>
                <span class="nav-label">Home</span>
            </button>

            <button class="nav-item" data-tab="spesa" aria-label="Lista spesa">
                <div class="nav-icon">
                    <svg viewBox="0 0 24 24">
                        <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
                    </svg>
                </div>
                <span class="nav-label">Spesa</span>
            </button>
        </div>

        <!-- CENTRO: FRIGO -->
        <button class="nav-item frigo active" data-tab="frigo" aria-label="Il mio frigo">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24">
                    <rect x="6.4" y="3.3" width="11.2" height="17.4" rx="2.7" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
                    <line x1="6.4" y1="10" x2="17.6" y2="10" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
                    <line x1="9.1" y1="6.4" x2="9.1" y2="8" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                    <line x1="9.1" y1="13.2" x2="9.1" y2="16.1" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                </svg>
            </div>
            <span class="nav-label">Frigo</span>
        </button>

        <!-- GRUPPO DESTRA: DIETA + IMPOSTAZIONI -->
        <div class="nav-group nav-group-right">
            <button class="nav-item" data-tab="dieta" aria-label="Dieta">
                <div class="nav-icon">
                    <svg viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="7.5" fill="none" stroke="currentColor" stroke-width="1.6"/>
                        <circle cx="12" cy="12" r="4.8" fill="none" stroke="currentColor" stroke-width="1.4" opacity="0.75"/>
                    </svg>
                </div>
                <span class="nav-label">Dieta</span>
            </button>

            <button class="nav-item" data-tab="impostazioni" aria-label="Impostazioni">
                <div class="nav-icon">
                    <svg viewBox="0 0 24 24">
                        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94L14.4 2.81c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                    </svg>
                </div>
                <span class="nav-label">Impo</span>
            </button>
        </div>
    </nav>
</div>

<script>
// Script navbar - CONNETTI I BOTTONI ALLE SEZIONI
const navbarButtons = document.querySelectorAll('.navbar .nav-item');
navbarButtons.forEach(btn => {
    btn.addEventListener('click', function() {
        // Rimuovi active da tutti
        navbarButtons.forEach(b => b.classList.remove('active'));
        // Aggiungi active al cliccato
        this.classList.add('active');
        
        // Apri la sezione corrispondente
        const tab = this.getAttribute('data-tab');
        if (tab) {
            // ðŸ†• COLLEGA DIETA A FABBISOGNO
            if (tab === 'dieta') {
                show('fabbisogno');
            } else {
                show(tab);
            }
        }
    });
});

// ðŸ”¹ Quando si apre l'app: vai subito su HOME
show('home');
const homeBtn = document.querySelector('.navbar .nav-item[data-tab="home"]');
if (homeBtn) homeBtn.classList.add('active');
</script>

<script>
// === GESTIONE PROSSIME SCADENZE ===
function updateExpiringFoods() {
  console.log('ðŸ” updateExpiringFoods chiamata');
  
  const container = document.getElementById('expiring-foods-list');
  if (!container) {
    console.log('âŒ Container non trovato');
    return;
  }
  
  console.log('ðŸ“¦ Frigo:', fridge);
  
  if (!fridge || fridge.length === 0) {
    container.innerHTML = '<p class="expiry-text" style="color:#94a3b8">ðŸ“¦ Nessun alimento nel frigo</p>';
    return;
  }
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const itemsWithExpiry = fridge.filter(item => item.scadenza);
  
  console.log('ðŸ“‹ Alimenti con scadenza:', itemsWithExpiry.length);
  
  if (itemsWithExpiry.length === 0) {
    container.innerHTML = '<p class="expiry-text" style="color:#94a3b8">âœ… Nessun alimento con data di scadenza</p>';
    return;
  }
  
  const urgentItems = itemsWithExpiry.filter(item => {
    const expDate = new Date(item.scadenza);
    expDate.setHours(0, 0, 0, 0);
    
    const diffTime = expDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    return diffDays <= 5;
  });
  
  let itemsToShow = [];
  if (urgentItems.length === 0) {
    const sortedItems = [...itemsWithExpiry].sort((a, b) => {
      return new Date(a.scadenza) - new Date(b.scadenza);
    });
    itemsToShow = sortedItems.slice(0, 3);
  } else {
    itemsToShow = urgentItems.sort((a, b) => {
      return new Date(a.scadenza) - new Date(b.scadenza);
    });
  }
  
  console.log('âœ… Alimenti da mostrare:', itemsToShow.length);
  
  let html = '';
  itemsToShow.forEach((item, index) => {
    const expDate = new Date(item.scadenza);
    expDate.setHours(0, 0, 0, 0);
    
    const diffTime = expDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    let statusText, statusClass, dangerText = '';
    
    // ðŸŽ¨ NUOVA LOGICA COLORI E PERICOLOSITÃ€
    if (diffDays < 0) {
      // SCADUTO - ROSSO
      const daysAgo = Math.abs(diffDays);
      statusText = `Scaduto da ${daysAgo} giorn${daysAgo === 1 ? 'o' : 'i'}`;
      statusClass = 'badge-dangerous';
      
      // ðŸ§  PERICOLOSITÃ€ GRADUALE
      const categoria = (item.categoria || '').toLowerCase();
      const nome = (item.nome || '').toLowerCase();
      const isPerishable = categoria.includes('latte') || categoria.includes('carne') || 
                           categoria.includes('pesce') || nome.includes('latte') ||
                           nome.includes('carne') || nome.includes('pesce') ||
                           nome.includes('yogurt') || nome.includes('uova');
      
      if (daysAgo === 1) {
        // 1 GIORNO SCADUTO
        if (isPerishable) {
          dangerText = '<div style="color:#f59e0b;font-size:11px;margin-top:4px">âš ï¸ Controllare aspetto e odore</div>';
        } else {
          dangerText = '<div style="color:#10b981;font-size:11px;margin-top:4px">âœ“ Probabilmente ancora buono</div>';
        }
      } else if (daysAgo <= 3) {
        // 2-3 GIORNI SCADUTI
        if (isPerishable) {
          dangerText = '<div style="color:#ef4444;font-size:11px;margin-top:4px">âš ï¸ Evitare il consumo</div>';
        } else {
          dangerText = '<div style="color:#f59e0b;font-size:11px;margin-top:4px">âš ï¸ Controllare bene prima</div>';
        }
      } else {
        // 4+ GIORNI SCADUTI
        if (isPerishable) {
          dangerText = '<div style="color:#ef4444;font-size:11px;margin-top:4px">âŒ Non consumare</div>';
        } else {
          dangerText = '<div style="color:#ef4444;font-size:11px;margin-top:4px">âš ï¸ Sconsigliato</div>';
        }
      }
      
    } else if (diffDays === 0) {
      // SCADE OGGI - ROSSO
      statusText = 'Scade oggi!';
      statusClass = 'badge-dangerous';
      
    } else if (diffDays <= 3) {
      // 1-3 GIORNI - GIALLO
      statusText = diffDays === 1 ? 'Scade domani' : `Scade tra ${diffDays} giorni`;
      statusClass = 'badge-warning';
      
    } else {
      // 4+ GIORNI - VERDE
      statusText = `Scade tra ${diffDays} giorni`;
      statusClass = 'badge-safe';
    }
    
    const borderStyle = index < itemsToShow.length - 1 ? 'border-bottom: 1px solid rgba(148, 163, 184, 0.2); padding-bottom: 12px; margin-bottom: 12px;' : '';
    
    html += `
      <div class="expiry-item" style="${borderStyle}">
        <div>
          <span class="expiry-text">${item.nome}</span>
          ${dangerText}
        </div>
        <span class="badge-expiry ${statusClass}">${statusText}</span>
      </div>
    `;
  });
  
  container.innerHTML = html;
  console.log('âœ… HTML generato e inserito');
}

// ========================================
// INIT FROSTY AI AL CARICAMENTO
// ========================================

window.addEventListener('load', () => {
    setTimeout(() => {
        if (typeof resetFrostyChat === 'function') {
            resetFrostyChat();
        }
        if (typeof updateFrostyOrb === 'function') {
            updateFrostyOrb('IDLE');
        }
    }, 500);
});

</script>

<script>
// ========== DATI PROFILO ==========
let userProfile = JSON.parse(localStorage.getItem('userProfile')) || {
    name: 'Utente',
    email: '',
    phone: '',
    photo: ''
};

// ========== NOTIFICHE SISTEMA ==========
let appNotifications = JSON.parse(localStorage.getItem('appNotifications')) || [];

// Inizializza notifiche di benvenuto se prima volta
if (appNotifications.length === 0) {
    appNotifications = [
        {
            id: Date.now(),
            type: 'welcome',
            icon: 'star',
            color: '#8b5cf6',
            title: 'Benvenuto in Frigo Smart! ðŸŽ‰',
            message: 'Grazie per aver installato l\'app! Inizia ad aggiungere i tuoi alimenti per ricevere suggerimenti personalizzati.',
            fullMessage: 'Benvenuto in Frigo Smart AI Ultra!\n\nSiamo felici di averti con noi. Ecco cosa puoi fare:\n\nâ€¢ Aggiungi alimenti scansionando il codice a barre o manualmente\nâ€¢ Ricevi notifiche quando i prodotti stanno per scadere\nâ€¢ Chiedi a Frosty AI suggerimenti per ricette\nâ€¢ Tieni traccia della tua spesa\n\nBuon appetito! ðŸ½ï¸',
            time: new Date().toISOString(),
            read: false
        }
    ];
    localStorage.setItem('appNotifications', JSON.stringify(appNotifications));
}

// ========== PROFILO SECTION ==========
function openProfiloSection() {
    updateProfileDisplay();
    document.getElementById('profilo-overlay').classList.add('open');
    document.getElementById('profilo-section').classList.add('open');
    document.body.style.overflow = 'hidden';
}

function closeProfiloSection() {
    document.getElementById('profilo-overlay').classList.remove('open');
    document.getElementById('profilo-section').classList.remove('open');
    document.body.style.overflow = '';
}

function updateProfileDisplay() {
    document.getElementById('profile-name-display').textContent = userProfile.name || 'Utente';
    document.getElementById('profile-email-display').textContent = userProfile.email || 'Aggiungi email';
    
    // Aggiorna immagine profilo ovunque
    const profileImages = ['profile-img', 'home-profile-img'];
    const profileIcons = ['profile-icon', 'home-profile-icon'];
    
    if (userProfile.photo) {
        profileImages.forEach(id => {
            const img = document.getElementById(id);
            if (img) {
                img.src = userProfile.photo;
                img.style.display = 'block';
            }
        });
        profileIcons.forEach(id => {
            const icon = document.getElementById(id);
            if (icon) icon.style.display = 'none';
        });
    } else {
        profileImages.forEach(id => {
            const img = document.getElementById(id);
            if (img) img.style.display = 'none';
        });
        profileIcons.forEach(id => {
            const icon = document.getElementById(id);
            if (icon) icon.style.display = 'block';
        });
    }
}

// ========== MODIFICA PROFILO ==========
function openModificaProfilo() {
    document.getElementById('edit-name').value = userProfile.name || '';
    document.getElementById('edit-email').value = userProfile.email || '';
    document.getElementById('edit-phone').value = userProfile.phone || '';
    
    if (userProfile.photo) {
        document.getElementById('edit-profile-img').src = userProfile.photo;
        document.getElementById('edit-profile-img').style.display = 'block';
        document.getElementById('edit-profile-icon').style.display = 'none';
    }
    
    const panel = document.getElementById('modifica-profilo-panel');
    panel.style.display = 'block';
    setTimeout(() => panel.style.right = '0', 10);
}

function closeModificaProfilo() {
    const panel = document.getElementById('modifica-profilo-panel');
    panel.style.right = '-100%';
    setTimeout(() => panel.style.display = 'none', 300);
}

function saveProfile() {
    userProfile.name = document.getElementById('edit-name').value || 'Utente';
    userProfile.email = document.getElementById('edit-email').value;
    userProfile.phone = document.getElementById('edit-phone').value;
    
    localStorage.setItem('userProfile', JSON.stringify(userProfile));
    updateProfileDisplay();
    closeModificaProfilo();
    
    // Notifica salvataggio
    showToast('Profilo salvato! âœ“');
}

function changeProfilePhoto() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                userProfile.photo = event.target.result;
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                
                // Aggiorna tutte le immagini profilo
                const imgs = ['profile-img', 'edit-profile-img'];
                const icons = ['profile-icon', 'edit-profile-icon'];
                
                imgs.forEach(id => {
                    const img = document.getElementById(id);
                    if (img) {
                        img.src = userProfile.photo;
                        img.style.display = 'block';
                    }
                });
                
                icons.forEach(id => {
                    const icon = document.getElementById(id);
                    if (icon) icon.style.display = 'none';
                });
                
                showToast('Foto aggiornata! ðŸ“¸');
            };
            reader.readAsDataURL(file);
        }
    };
    
    input.click();
}

// ========== PREFERENZE ==========
function openPreferenze() {
    const panel = document.getElementById('preferenze-panel');
    panel.style.display = 'block';
    setTimeout(() => panel.style.right = '0', 10);
}

function closePreferenze() {
    const panel = document.getElementById('preferenze-panel');
    panel.style.right = '-100%';
    setTimeout(() => panel.style.display = 'none', 300);
}

// ========== AIUTO ==========
function openAiuto() {
    const panel = document.getElementById('aiuto-panel');
    panel.style.display = 'block';
    setTimeout(() => panel.style.right = '0', 10);
}

function closeAiuto() {
    const panel = document.getElementById('aiuto-panel');
    panel.style.right = '-100%';
    setTimeout(() => panel.style.display = 'none', 300);
}

// ========== LOGOUT ==========
function logoutUser() {
    if (confirm('Sei sicuro di voler uscire?')) {
        localStorage.removeItem('userProfile');
        userProfile = { name: 'Utente', email: '', phone: '', photo: '' };
        updateProfileDisplay();
        closeProfiloSection();
        showToast('Disconnesso');
    }
}

// ========== NOTIFICHE SECTION ==========
function openNotificheSection() {
    renderNotifications();
    document.getElementById('notifiche-overlay').classList.add('open');
    document.getElementById('notifiche-section').classList.add('open');
    document.body.style.overflow = 'hidden';
    
    // Segna TUTTE le notifiche come lette quando apri la campanella
    appNotifications.forEach(n => n.read = true);
    localStorage.setItem('appNotifications', JSON.stringify(appNotifications));
    
    // Azzera il badge
    updateNotificationBadge();
    
    // Aggiorna la visualizzazione (toglie i pallini blu)
    setTimeout(() => renderNotifications(), 100);
}

function closeNotificheSection() {
    document.getElementById('notifiche-overlay').classList.remove('open');
    document.getElementById('notifiche-section').classList.remove('open');
    document.body.style.overflow = '';
}

function renderNotifications() {
    const list = document.getElementById('notifiche-list');
    const noNotif = document.getElementById('no-notifiche');
    
    if (appNotifications.length === 0) {
        list.style.display = 'none';
        noNotif.style.display = 'block';
        return;
    }
    
    list.style.display = 'flex';
    noNotif.style.display = 'none';
    
    list.innerHTML = appNotifications.map((notif, index) => {
        const timeAgo = getTimeAgo(notif.time);
        const iconColors = {
            'warning': '#f59e0b',
            'recipe': '#06b6d4',
            'reminder': '#8b5cf6',
            'expiry': '#ef4444',
            'low-stock': '#f97316',
            'welcome': '#8b5cf6',
            'star': '#8b5cf6'
        };
        const color = iconColors[notif.type] || notif.color || '#06b6d4';
        
        const icons = {
            'warning': '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>',
            'recipe': '<path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path>',
            'reminder': '<circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>',
            'expiry': '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>',
            'low-stock': '<path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path>',
            'welcome': '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>',
            'star': '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>'
        };
        
        const iconSvg = icons[notif.type] || icons['recipe'];
        
        return `
            <div onclick="openNotificaDetail(${index})" style="padding: 14px; background: ${notif.read ? '#f8fafc' : 'white'}; border-radius: 12px; border: 1px solid ${notif.read ? '#e2e8f0' : '#06b6d4'}; display: flex; gap: 12px; align-items: flex-start; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.01)'" onmouseout="this.style.transform='scale(1)'">
                <div style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, ${color}, ${color}dd); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">${iconSvg}</svg>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <p style="margin: 0 0 4px 0; font-weight: 600; color: #1e293b; font-size: 14px; ${notif.read ? '' : 'font-weight:700;'}">${notif.title}</p>
                    <p style="margin: 0; color: #64748b; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${notif.message}</p>
                    <p style="margin: 8px 0 0 0; color: #94a3b8; font-size: 11px;">${timeAgo}</p>
                </div>
                ${!notif.read ? '<div style="width:8px;height:8px;background:#06b6d4;border-radius:50%;flex-shrink:0;margin-top:6px;"></div>' : ''}
            </div>
        `;
    }).join('');
}

function openNotificaDetail(index) {
    const notif = appNotifications[index];
    if (!notif) return;
    
    // Segna come letta
    notif.read = true;
    localStorage.setItem('appNotifications', JSON.stringify(appNotifications));

    updateNotificationBadge();    

    const content = document.getElementById('notifica-detail-content');
    content.innerHTML = `
        <div style="text-align:center;margin-bottom:24px;">
            <div style="width:60px;height:60px;border-radius:16px;background:linear-gradient(135deg,${notif.color || '#06b6d4'},${notif.color || '#06b6d4'}dd);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="white">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                </svg>
            </div>
            <h2 style="margin:0 0 8px 0;font-size:20px;font-weight:700;color:#1e293b;">${notif.title}</h2>
            <p style="margin:0;color:#94a3b8;font-size:13px;">${getTimeAgo(notif.time)}</p>
        </div>
        <div style="background:white;padding:20px;border-radius:16px;border:1px solid #e2e8f0;">
            <p style="margin:0;color:#334155;font-size:15px;line-height:1.7;white-space:pre-line;">${notif.fullMessage || notif.message}</p>
        </div>
    `;
    
    document.getElementById('notifica-detail-panel').style.display = 'block';
}

function closeNotificaDetail() {
    document.getElementById('notifica-detail-panel').style.display = 'none';
    renderNotifications();
}

function clearAllNotifications() {
    if (confirm(t('eliminareNotifiche') || 'Eliminare tutte le notifiche?')) {
        appNotifications = [];
        localStorage.setItem('appNotifications', JSON.stringify(appNotifications));
        // NON toccare welcomeNotificationShown - il benvenuto non deve tornare!
        renderNotifications();
        updateNotificationBadge();
    }
}

function getTimeAgo(dateString) {
    const now = new Date();
    const date = new Date(dateString);
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'Adesso';
    if (seconds < 3600) return Math.floor(seconds / 60) + ' min fa';
    if (seconds < 86400) return Math.floor(seconds / 3600) + ' ore fa';
    if (seconds < 604800) return Math.floor(seconds / 86400) + ' giorni fa';
    return date.toLocaleDateString('it-IT');
}

// ========== AGGIUNGERE NOTIFICHE AUTOMATICHE ==========
function addNotification(type, title, message, fullMessage = null) {
    const colors = {
        'warning': '#f59e0b',
        'recipe': '#06b6d4',
        'reminder': '#8b5cf6',
        'expiry': '#ef4444',
        'low-stock': '#f97316'
    };
    
    const notif = {
        id: Date.now(),
        type: type,
        color: colors[type] || '#06b6d4',
        title: title,
        message: message,
        fullMessage: fullMessage || message,
        time: new Date().toISOString(),
        read: false
    };
    
    appNotifications.unshift(notif);
    localStorage.setItem('appNotifications', JSON.stringify(appNotifications));
    
    // Aggiorna badge campanella
    updateNotificationBadge();
}

function updateNotificationBadge() {
    const badge = document.getElementById('notification-badge');
    if (!badge) return;
    
    const unread = appNotifications.filter(n => !n.read).length;
    
    if (unread > 0) {
        badge.textContent = unread > 9 ? '9+' : unread;
        badge.style.display = 'flex';
    } else {
        badge.style.display = 'none';
    }
}

// ========== NOTIFICHE AUTOMATICHE PER SCADENZE ==========
function checkExpiryNotifications() {
    // Controlla prodotti in scadenza da IndexedDB
    if (typeof db !== 'undefined' && db) {
        const tx = db.transaction('alimenti', 'readonly');
        const store = tx.objectStore('alimenti');
        const request = store.getAll();
        
        request.onsuccess = () => {
            const items = request.result;
            const today = new Date();
            
            items.forEach(item => {
                if (item.scadenza) {
                    const expDate = new Date(item.scadenza);
                    const daysLeft = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
                    
                    // Prodotto in scadenza domani
                    if (daysLeft === 1) {
                        const alreadyNotified = appNotifications.some(n => 
                            n.title.includes(item.nome) && n.type === 'expiry' && 
                            new Date(n.time).toDateString() === today.toDateString()
                        );
                        
                        if (!alreadyNotified) {
                            addNotification(
                                'expiry',
                                `${item.nome} scade domani! âš ï¸`,
                                `Usa ${item.nome} prima che scada.`,
                                `Il prodotto "${item.nome}" scadrÃ  domani!\n\nConsigli:\nâ€¢ Usalo oggi per una ricetta\nâ€¢ Controlla se Ã¨ ancora buono prima di consumarlo\nâ€¢ Se non riesci a usarlo, considera di congelarlo`
                            );
                        }
                    }
                    
                    // Prodotto scaduto
                    if (daysLeft < 0) {
                        const alreadyNotified = appNotifications.some(n => 
                            n.title.includes(item.nome) && n.message.includes('scaduto')
                        );
                        
                        if (!alreadyNotified) {
                            addNotification(
                                'warning',
                                `${item.nome} Ã¨ scaduto! ðŸš«`,
                                `Controlla ${item.nome} nel frigo.`,
                                `Il prodotto "${item.nome}" Ã¨ scaduto da ${Math.abs(daysLeft)} giorni.\n\nAttenzione:\nâ€¢ Verifica lo stato del prodotto\nâ€¢ Se ha un cattivo odore o aspetto, eliminalo\nâ€¢ Alcuni prodotti possono essere ancora buoni poco dopo la scadenza`
                            );
                        }
                    }
                }
                
                // QuantitÃ  bassa
                if (item.quantita && item.quantita <= 1) {
                    const alreadyNotified = appNotifications.some(n => 
                        n.title.includes(item.nome) && n.type === 'low-stock' &&
                        new Date(n.time) > new Date(Date.now() - 86400000)
                    );
                    
                    if (!alreadyNotified) {
                        addNotification(
                            'low-stock',
                            `${item.nome} quasi esaurito! ðŸ›’`,
                            `Aggiungi ${item.nome} alla lista spesa.`,
                            `Hai quasi finito "${item.nome}"!\n\nQuantitÃ  rimasta: ${item.quantita}\n\nVuoi aggiungerlo alla lista della spesa?`
                        );
                    }
                }
            });
        };
    }
}

// ========== PROMEMORIA PASTI ==========
function checkMealReminders() {
    const now = new Date();
    const hour = now.getHours();
    const todayKey = now.toDateString();
    const remindersShown = JSON.parse(localStorage.getItem('mealReminders')) || {};
    
    // Colazione (7-9)
    if (hour >= 7 && hour < 9 && !remindersShown[todayKey + '-breakfast']) {
        addNotification(
            'reminder',
            'Buongiorno! â˜€ï¸ Ora di colazione',
            'Inizia la giornata con una colazione sana!',
            'Buongiorno!\n\nÃˆ ora di fare colazione. Una colazione sana ti dÃ  energia per tutta la mattina.\n\nðŸ’¡ Suggerimento: Controlla cosa hai nel frigo per preparare una colazione nutriente!'
        );
        remindersShown[todayKey + '-breakfast'] = true;
        localStorage.setItem('mealReminders', JSON.stringify(remindersShown));
    }
    
    // Pranzo (12-14)
    if (hour >= 12 && hour < 14 && !remindersShown[todayKey + '-lunch']) {
        addNotification(
            'reminder',
            'Ãˆ ora di pranzo! ðŸ½ï¸',
            'Prenditi una pausa e mangia qualcosa di buono.',
            'Ãˆ ora di pranzo!\n\nRicorda di fare un pasto equilibrato con proteine, carboidrati e verdure.\n\nðŸ´ Chiedi a Frosty AI un suggerimento per una ricetta veloce con gli ingredienti che hai!'
        );
        remindersShown[todayKey + '-lunch'] = true;
        localStorage.setItem('mealReminders', JSON.stringify(remindersShown));
    }
    
    // Cena (19-21)
    if (hour >= 19 && hour < 21 && !remindersShown[todayKey + '-dinner']) {
        addNotification(
            'reminder',
            'Tempo di cena! ðŸŒ™',
            'Cosa prepari di buono stasera?',
            'Ãˆ ora di cena!\n\nUna cena leggera ti aiuta a dormire meglio.\n\nðŸ‘¨â€ðŸ³ Suggerimento: Usa gli ingredienti che hai nel frigo prima che scadano!'
        );
        remindersShown[todayKey + '-dinner'] = true;
        localStorage.setItem('mealReminders', JSON.stringify(remindersShown));
    }
}

// ========== SUGGERIMENTI RICETTE (usa Groq se disponibile) ==========
async function suggestRecipeNotification() {
    const lastSuggestion = localStorage.getItem('lastRecipeSuggestion');
    const today = new Date().toDateString();
    
    if (lastSuggestion === today) return; // Una al giorno
    
    // Prova a usare Groq per suggerimento personalizzato
    if (typeof groqApiKey !== 'undefined' && groqApiKey) {
        try {
            // Ottieni ingredienti dal frigo
            let ingredients = [];
            if (typeof db !== 'undefined' && db) {
                const tx = db.transaction('alimenti', 'readonly');
                const store = tx.objectStore('alimenti');
                const request = store.getAll();
                
                await new Promise((resolve) => {
                    request.onsuccess = () => {
                        ingredients = request.result.map(i => i.nome).slice(0, 5);
                        resolve();
                    };
                    request.onerror = resolve;
                });
            }
            
            if (ingredients.length > 0) {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${groqApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: [{
                            role: 'user',
                            content: `Suggerisci UNA ricetta veloce e semplice con questi ingredienti: ${ingredients.join(', ')}. Rispondi con: nome ricetta (max 5 parole) | descrizione breve (max 15 parole) | istruzioni (max 50 parole)`
                        }],
                        max_tokens: 150
                    })
                });
                
                const data = await response.json();
                const suggestion = data.choices[0].message.content;
                const parts = suggestion.split('|');
                
                if (parts.length >= 2) {
                    addNotification(
                        'recipe',
                        `Ricetta suggerita: ${parts[0].trim()} ðŸ³`,
                        parts[1].trim(),
                        `${parts[0].trim()}\n\n${parts[1].trim()}\n\nðŸ“ Istruzioni:\n${parts[2] ? parts[2].trim() : 'Chiedi a Frosty AI per i dettagli!'}\n\nIngredienti disponibili nel tuo frigo: ${ingredients.join(', ')}`
                    );
                    localStorage.setItem('lastRecipeSuggestion', today);
                }
            }
        } catch (e) {
            console.log('Errore suggerimento ricetta:', e);
        }
    }
}

// ========== TOAST NOTIFICATION ==========
function showToast(message) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: #1e293b;
        color: white;
        padding: 12px 24px;
        border-radius: 100px;
        font-size: 14px;
        z-index: 999999;
        animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.remove(), 3000);
}

// Aggiungi animazione toast al CSS
const toastStyle = document.createElement('style');
toastStyle.textContent = `
    @keyframes toastIn {
        from { opacity: 0; transform: translateX(-50%) translateY(20px); }
        to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    @keyframes toastOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
`;
document.head.appendChild(toastStyle);

// ========== INIZIALIZZAZIONE ==========
document.addEventListener('DOMContentLoaded', () => {
    // Carica profilo
    updateProfileDisplay();
    
    updateNotificationBadge();

    // Controlla notifiche ogni 30 minuti
    checkExpiryNotifications();
    checkMealReminders();
    suggestRecipeNotification();
    
    setInterval(() => {
        checkExpiryNotifications();
        checkMealReminders();
    }, 1800000); // 30 minuti
    
    // Suggerisci ricetta una volta al giorno
    setInterval(suggestRecipeNotification, 3600000); // 1 ora
});

// ========== PREFERENZE TOGGLE ==========
let userPreferences = JSON.parse(localStorage.getItem('userPreferences')) || {
    notifiche: true,
    tema: false,
    suoni: true,
    promemoria: true,
    ricette: true,
    analytics: false,
    marketing: false
};

function togglePreference(key, element) {
    const isActive = element.getAttribute('data-active') === 'true';
    const newValue = !isActive;
    
    element.setAttribute('data-active', newValue.toString());
    userPreferences[key] = newValue;
    localStorage.setItem('userPreferences', JSON.stringify(userPreferences));
    
    // Feedback visivo
    if (newValue) {
        showToast('Attivato âœ“');
    } else {
        showToast('Disattivato');
    }
    
    // Applica tema scuro se necessario
    if (key === 'tema') {
        document.body.classList.toggle('dark-mode', newValue);
    }
}

function loadPreferences() {
    const toggles = document.querySelectorAll('.toggle-switch');
    toggles.forEach(toggle => {
        const onclick = toggle.getAttribute('onclick');
        if (onclick) {
            const match = onclick.match(/'(\w+)'/);
            if (match) {
                const key = match[1];
                if (userPreferences[key] !== undefined) {
                    toggle.setAttribute('data-active', userPreferences[key].toString());
                }
            }
        }
    });
}

// ========== PRIVACY E TERMINI ==========
function openPrivacyPolicy() {
    const panel = document.getElementById('privacy-panel');
    panel.style.display = 'block';
    setTimeout(() => panel.style.right = '0', 10);
}

function closePrivacyPolicy() {
    const panel = document.getElementById('privacy-panel');
    panel.style.right = '-100%';
    setTimeout(() => panel.style.display = 'none', 300);
}

function openTermsOfService() {
    const panel = document.getElementById('terms-panel');
    panel.style.display = 'block';
    setTimeout(() => panel.style.right = '0', 10);
}

function closeTermsOfService() {
    const panel = document.getElementById('terms-panel');
    panel.style.right = '-100%';
    setTimeout(() => panel.style.display = 'none', 300);
}

function deleteAllData() {
    if (confirm(t('eliminaDatiConferma') || 'Sei sicuro di voler eliminare TUTTI i tuoi dati?\n\nQuesta azione Ã¨ irreversibile.')) {
        if (confirm(t('eliminareNotificheConferma') || 'Conferma: eliminare profilo, preferenze, alimenti e notifiche?')) {
            // Elimina TUTTO incluso welcomeNotificationShown
            localStorage.clear();
            
            // Pulisci IndexedDB se esiste
            if (typeof db !== 'undefined' && db) {
                try {
                    const tx = db.transaction(['alimenti', 'ricette', 'spesa'], 'readwrite');
                    tx.objectStore('alimenti').clear();
                    tx.objectStore('ricette').clear();
                    tx.objectStore('spesa').clear();
                } catch(e) {
                    console.log('IndexedDB clear error:', e);
                }
            }
            
            showToast(t('tuttiDatiEliminati') || 'Tutti i dati eliminati');
            setTimeout(() => location.reload(), 1500);
        }
    }
}

// Carica preferenze all'apertura delle preferenze
const originalOpenPreferenze = openPreferenze;
openPreferenze = function() {
    originalOpenPreferenze();
    setTimeout(loadPreferences, 100);
};

</script>

<!-- OVERLAY PROFILO -->
<div id="profilo-overlay" onclick="closeProfiloSection()"></div>

<!-- SEZIONE PROFILO -->
<div id="profilo-section">
    <!-- Background Image Full -->
<div style="position:absolute;top:0;left:0;width:100%;height:100%;background-image:url('img/immagine-sezione-profilo.png');background-size:cover;background-position:center;"></div>
<div style="position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(180deg, transparent 0%, transparent 70%, rgba(248,250,252,0.9) 90%, rgba(248,250,252,1) 100%);"></div>
    
    <div style="padding: 20px; position: relative; z-index: 1;">
        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="margin: 0; font-size: 24px; font-weight: 700; color: #1e293b;">Profilo</h2>
            <button onclick="closeProfiloSection()" style="background: rgba(255,255,255,0.9); border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        
        <!-- Avatar e Info -->
        <div style="text-align: center; margin: 80px 0 32px 0;">
            <div id="profile-avatar-container" style="position: relative; width: 100px; height: 100px; margin: 0 auto 16px;">
                <div id="profile-avatar" style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #06b6d4, #8b5cf6); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 24px rgba(6, 182, 212, 0.3); overflow: hidden; border: 4px solid white;">
                    <img id="profile-img" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                    <svg id="profile-icon" width="50" height="50" viewBox="0 0 24 24" fill="white">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <button onclick="changeProfilePhoto()" style="position: absolute; bottom: 0; right: 0; width: 32px; height: 32px; border-radius: 50%; background: #06b6d4; border: 3px solid white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="white">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                </button>
            </div>
            <h3 id="profile-name-display" style="margin: 0 0 4px 0; font-size: 20px; font-weight: 600; color: #1e293b;">Utente</h3>
            <p id="profile-email-display" style="margin: 0; color: #64748b; font-size: 14px;">Aggiungi email</p>
        </div>
        
        <!-- Menu Opzioni -->
        <div style="display: flex; flex-direction: column; gap: 8px;">
            <button onclick="openModificaProfilo()" style="width: 100%; padding: 14px 16px; background: white; border: 1px solid #e2e8f0; border-radius: 12px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.2s;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                <span style="font-size: 15px; color: #334155; flex: 1; text-align: left;">Modifica profilo</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
            
            <button onclick="openPreferenze()" style="width: 100%; padding: 14px 16px; background: white; border: 1px solid #e2e8f0; border-radius: 12px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.2s;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                <span style="font-size: 15px; color: #334155; flex: 1; text-align: left;">Preferenze</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
            
            <button onclick="openAiuto()" style="width: 100%; padding: 14px 16px; background: white; border: 1px solid #e2e8f0; border-radius: 12px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.2s;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <span style="font-size: 15px; color: #334155; flex: 1; text-align: left;">Aiuto & Assistenza</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
            
            <div style="height: 1px; background: #e2e8f0; margin: 8px 0;"></div>
            
            <button onclick="logoutUser()" style="width: 100%; padding: 14px 16px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.2s;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                <span style="font-size: 15px; color: #ef4444;">Esci</span>
            </button>
        </div>
    </div>
</div>

<!-- MODIFICA PROFILO PANEL -->
<div id="modifica-profilo-panel" style="display:none;position:fixed;top:0;right:-100%;width:100%;max-width:400px;height:100vh;background:#f8fafc;z-index:100001;transition:right 0.3s ease;box-shadow:-5px 0 30px rgba(0,0,0,0.2);overflow-y:auto;">
    <div style="padding:20px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
            <button onclick="closeModificaProfilo()" style="background:transparent;border:none;cursor:pointer;display:flex;align-items:center;gap:8px;color:#64748b;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Indietro
            </button>
            <button onclick="saveProfile()" style="background:#06b6d4;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:500;">Salva</button>
        </div>
        
        <h2 style="margin:0 0 24px 0;font-size:20px;font-weight:700;color:#1e293b;">Modifica Profilo</h2>
        
        <!-- Foto Profilo -->
        <div style="text-align:center;margin-bottom:24px;">
            <div id="edit-avatar" style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#06b6d4,#8b5cf6);margin:0 auto 12px;display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer;" onclick="changeProfilePhoto()">
                <img id="edit-profile-img" src="" style="width:100%;height:100%;object-fit:cover;display:none;">
                <svg id="edit-profile-icon" width="40" height="40" viewBox="0 0 24 24" fill="white">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </div>
            <button onclick="changeProfilePhoto()" style="background:transparent;border:none;color:#06b6d4;cursor:pointer;font-size:14px;">Cambia foto</button>
        </div>
        
        <!-- Form -->
        <div style="display:flex;flex-direction:column;gap:16px;">
            <div>
                <label style="display:block;font-size:13px;color:#64748b;margin-bottom:6px;">Nome</label>
                <input id="edit-name" type="text" placeholder="Il tuo nome" style="width:100%;padding:12px;border:1px solid #e2e8f0;border-radius:10px;font-size:15px;outline:none;box-sizing:border-box;" onfocus="this.style.borderColor='#06b6d4'" onblur="this.style.borderColor='#e2e8f0'">
            </div>
            <div>
                <label style="display:block;font-size:13px;color:#64748b;margin-bottom:6px;">Email</label>
                <input id="edit-email" type="email" placeholder="La tua email" style="width:100%;padding:12px;border:1px solid #e2e8f0;border-radius:10px;font-size:15px;outline:none;box-sizing:border-box;" onfocus="this.style.borderColor='#06b6d4'" onblur="this.style.borderColor='#e2e8f0'">
            </div>
            <div>
                <label style="display:block;font-size:13px;color:#64748b;margin-bottom:6px;">Telefono</label>
                <input id="edit-phone" type="tel" placeholder="Il tuo numero" style="width:100%;padding:12px;border:1px solid #e2e8f0;border-radius:10px;font-size:15px;outline:none;box-sizing:border-box;" onfocus="this.style.borderColor='#06b6d4'" onblur="this.style.borderColor='#e2e8f0'">
            </div>
        </div>
    </div>
</div>

<!-- PREFERENZE PANEL -->
<div id="preferenze-panel" style="display:none;position:fixed;top:0;right:-100%;width:100%;max-width:400px;height:100vh;background:#f8fafc;z-index:100001;transition:right 0.3s ease;box-shadow:-5px 0 30px rgba(0,0,0,0.2);overflow-y:auto;">
    <div style="padding:20px;">
        <div style="display:flex;align-items:center;margin-bottom:24px;">
            <button onclick="closePreferenze()" style="background:transparent;border:none;cursor:pointer;display:flex;align-items:center;gap:8px;color:#64748b;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Indietro
            </button>
        </div>
        
        <h2 style="margin:0 0 24px 0;font-size:20px;font-weight:700;color:#1e293b;">Preferenze</h2>
        
        <div style="display:flex;flex-direction:column;gap:12px;">
            <!-- Notifiche -->
            <div style="background:white;padding:16px;border-radius:12px;border:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <p style="margin:0;font-weight:500;color:#1e293b;">Notifiche</p>
                    <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">Ricevi avvisi su scadenze</p>
                </div>
                <div class="toggle-switch" onclick="togglePreference('notifiche', this)" data-active="true">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            
            <!-- Tema scuro -->
            <div style="background:white;padding:16px;border-radius:12px;border:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <p style="margin:0;font-weight:500;color:#1e293b;">Tema scuro</p>
                    <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">Attiva modalitÃ  scura</p>
                </div>
                <div class="toggle-switch" onclick="togglePreference('tema', this)" data-active="false">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            
            <!-- Suoni -->
            <div style="background:white;padding:16px;border-radius:12px;border:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <p style="margin:0;font-weight:500;color:#1e293b;">Suoni</p>
                    <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">Abilita suoni app</p>
                </div>
                <div class="toggle-switch" onclick="togglePreference('suoni', this)" data-active="true">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            
            <!-- Promemoria pasti -->
            <div style="background:white;padding:16px;border-radius:12px;border:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <p style="margin:0;font-weight:500;color:#1e293b;">Promemoria pasti</p>
                    <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">Ricorda colazione, pranzo, cena</p>
                </div>
                <div class="toggle-switch" onclick="togglePreference('promemoria', this)" data-active="true">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            
            <!-- Suggerimenti ricette -->
            <div style="background:white;padding:16px;border-radius:12px;border:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <p style="margin:0;font-weight:500;color:#1e293b;">Suggerimenti ricette</p>
                    <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">Ricevi idee giornaliere</p>
                </div>
                <div class="toggle-switch" onclick="togglePreference('ricette', this)" data-active="true">
                    <div class="toggle-slider"></div>
                </div>
            </div>
        
    <!-- Lingua -->
<div style="background:white;padding:16px;border-radius:12px;border:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;">
    <div>
        <p data-t="lingua" style="margin:0;font-weight:500;color:#1e293b;">Lingua</p>
        <p data-t="cambiaLingua" style="margin:4px 0 0 0;font-size:12px;color:#64748b;">Cambia lingua dell'app</p>
    </div>
    <button onclick="openLanguageSelector()" style="padding:8px 12px;background:#06b6d4;color:white;border:none;border-radius:8px;cursor:pointer;font-size:13px;">
        <span id="current-lang-label">ðŸ‡®ðŸ‡¹ IT</span>
    </button>
</div>
    </div>    

        <!-- Sezione Privacy -->
        <h3 style="margin:32px 0 16px 0;font-size:16px;font-weight:600;color:#1e293b;">Privacy e Consensi</h3>
        
        <div style="display:flex;flex-direction:column;gap:12px;">
            <!-- Dati utilizzo -->
            <div style="background:white;padding:16px;border-radius:12px;border:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <p style="margin:0;font-weight:500;color:#1e293b;">Dati di utilizzo</p>
                    <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">Aiutaci a migliorare l'app</p>
                </div>
                <div class="toggle-switch" onclick="togglePreference('analytics', this)" data-active="false">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            
            <!-- Marketing -->
            <div style="background:white;padding:16px;border-radius:12px;border:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <p style="margin:0;font-weight:500;color:#1e293b;">Comunicazioni marketing</p>
                    <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">NovitÃ  e offerte speciali</p>
                </div>
                <div class="toggle-switch" onclick="togglePreference('marketing', this)" data-active="false">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            
            <!-- Privacy Policy -->
            <button onclick="openPrivacyPolicy()" style="width:100%;padding:14px 16px;background:white;border:1px solid #e2e8f0;border-radius:12px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all 0.2s;margin-top:8px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
                <span style="font-size:15px;color:#334155;flex:1;text-align:left;">Informativa Privacy</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
            
            <!-- Termini di servizio -->
            <button onclick="openTermsOfService()" style="width:100%;padding:14px 16px;background:white;border:1px solid #e2e8f0;border-radius:12px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all 0.2s;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
                <span style="font-size:15px;color:#334155;flex:1;text-align:left;">Termini di Servizio</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
            
            <!-- Elimina dati -->
            <button onclick="deleteAllData()" style="width:100%;padding:14px 16px;background:#fef2f2;border:1px solid #fecaca;border-radius:12px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all 0.2s;margin-top:16px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                <span style="font-size:15px;color:#ef4444;">Elimina tutti i miei dati</span>
            </button>
        </div>
    </div>
</div>

<!-- PRIVACY POLICY PANEL -->
<div id="privacy-panel" style="display:none;position:fixed;top:0;right:-100%;width:100%;max-width:400px;height:100vh;background:#f8fafc;z-index:100002;transition:right 0.3s ease;box-shadow:-5px 0 30px rgba(0,0,0,0.2);overflow-y:auto;">
    <div style="padding:20px;">
        <div style="display:flex;align-items:center;margin-bottom:24px;">
            <button onclick="closePrivacyPolicy()" style="background:transparent;border:none;cursor:pointer;display:flex;align-items:center;gap:8px;color:#64748b;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Indietro
            </button>
        </div>
        
        <h2 style="margin:0 0 24px 0;font-size:20px;font-weight:700;color:#1e293b;">Informativa Privacy</h2>
        
        <div style="background:white;padding:20px;border-radius:16px;border:1px solid #e2e8f0;">
            <p style="margin:0 0 16px 0;color:#334155;font-size:14px;line-height:1.7;">
                <strong>Ultimo aggiornamento:</strong> Dicembre 2024
            </p>
            
            <h4 style="margin:16px 0 8px 0;color:#1e293b;">1. Dati raccolti</h4>
            <p style="margin:0 0 16px 0;color:#64748b;font-size:13px;line-height:1.6;">
                Raccogliamo solo i dati necessari per il funzionamento dell'app: informazioni sugli alimenti, preferenze utente e dati del profilo. Tutti i dati sono salvati localmente sul tuo dispositivo.
            </p>
            
            <h4 style="margin:16px 0 8px 0;color:#1e293b;">2. Utilizzo dei dati</h4>
            <p style="margin:0 0 16px 0;color:#64748b;font-size:13px;line-height:1.6;">
                I tuoi dati vengono utilizzati esclusivamente per fornirti un'esperienza personalizzata, come suggerimenti di ricette e notifiche di scadenza.
            </p>
            
            <h4 style="margin:16px 0 8px 0;color:#1e293b;">3. Condivisione</h4>
            <p style="margin:0 0 16px 0;color:#64748b;font-size:13px;line-height:1.6;">
                Non condividiamo i tuoi dati personali con terze parti. Le richieste all'assistente AI vengono elaborate in modo anonimo.
            </p>
            
            <h4 style="margin:16px 0 8px 0;color:#1e293b;">4. I tuoi diritti</h4>
            <p style="margin:0;color:#64748b;font-size:13px;line-height:1.6;">
                Puoi eliminare tutti i tuoi dati in qualsiasi momento dalle Preferenze. Per domande, contattaci a freezy_assistens.@gmail.com
            </p>
        </div>
    </div>
</div>

<!-- TERMS OF SERVICE PANEL -->
<div id="terms-panel" style="display:none;position:fixed;top:0;right:-100%;width:100%;max-width:400px;height:100vh;background:#f8fafc;z-index:100002;transition:right 0.3s ease;box-shadow:-5px 0 30px rgba(0,0,0,0.2);overflow-y:auto;">
    <div style="padding:20px;">
        <div style="display:flex;align-items:center;margin-bottom:24px;">
            <button onclick="closeTermsOfService()" style="background:transparent;border:none;cursor:pointer;display:flex;align-items:center;gap:8px;color:#64748b;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Indietro
            </button>
        </div>
        
        <h2 style="margin:0 0 24px 0;font-size:20px;font-weight:700;color:#1e293b;">Termini di Servizio</h2>
        
        <div style="background:white;padding:20px;border-radius:16px;border:1px solid #e2e8f0;">
            <p style="margin:0 0 16px 0;color:#334155;font-size:14px;line-height:1.7;">
                <strong>Ultimo aggiornamento:</strong> Dicembre 2024
            </p>
            
            <h4 style="margin:16px 0 8px 0;color:#1e293b;">1. Accettazione</h4>
            <p style="margin:0 0 16px 0;color:#64748b;font-size:13px;line-height:1.6;">
                Utilizzando Frigo Smart AI, accetti questi termini di servizio. L'app Ã¨ fornita "cosÃ¬ com'Ã¨" per uso personale.
            </p>
            
            <h4 style="margin:16px 0 8px 0;color:#1e293b;">2. Uso consentito</h4>
            <p style="margin:0 0 16px 0;color:#64748b;font-size:13px;line-height:1.6;">
                L'app Ã¨ destinata alla gestione domestica degli alimenti. Non siamo responsabili per decisioni alimentari basate sui suggerimenti dell'app.
            </p>
            
            <h4 style="margin:16px 0 8px 0;color:#1e293b;">3. Limitazioni</h4>
            <p style="margin:0 0 16px 0;color:#64748b;font-size:13px;line-height:1.6;">
                I suggerimenti dell'assistente AI sono indicativi. Verifica sempre le date di scadenza reali sui prodotti.
            </p>
            
            <h4 style="margin:16px 0 8px 0;color:#1e293b;">4. Contatti</h4>
            <p style="margin:0;color:#64748b;font-size:13px;line-height:1.6;">
                Per supporto: 055 614 5172 o freezy_assistens.@gmail.com
            </p>
        </div>
    </div>
</div>

<!-- AIUTO PANEL -->
<div id="aiuto-panel" style="display:none;position:fixed;top:0;right:-100%;width:100%;max-width:400px;height:100vh;background:#f8fafc;z-index:100001;transition:right 0.3s ease;box-shadow:-5px 0 30px rgba(0,0,0,0.2);overflow-y:auto;">
    <div style="padding:20px;">
        <div style="display:flex;align-items:center;margin-bottom:24px;">
            <button onclick="closeAiuto()" style="background:transparent;border:none;cursor:pointer;display:flex;align-items:center;gap:8px;color:#64748b;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Indietro
            </button>
        </div>
        
        <h2 style="margin:0 0 8px 0;font-size:20px;font-weight:700;color:#1e293b;">Aiuto & Assistenza</h2>
        <p style="margin:0 0 24px 0;color:#64748b;font-size:14px;">Siamo qui per aiutarti!</p>
        
        <div style="display:flex;flex-direction:column;gap:12px;">
            <!-- Telefono -->
            <a href="tel:0556145172" style="text-decoration:none;background:white;padding:16px;border-radius:12px;border:1px solid #e2e8f0;display:flex;align-items:center;gap:12px;">
                <div style="width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#22c55e,#16a34a);display:flex;align-items:center;justify-content:center;">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="white">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                    </svg>
                </div>
                <div style="flex:1;">
                    <p style="margin:0;font-weight:500;color:#1e293b;">Chiamaci</p>
                    <p style="margin:4px 0 0 0;font-size:13px;color:#06b6d4;">055 614 5172</p>
                </div>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </a>
            
            <!-- Email -->
            <a href="mailto:freezy_assistens.@gmail.com" style="text-decoration:none;background:white;padding:16px;border-radius:12px;border:1px solid #e2e8f0;display:flex;align-items:center;gap:12px;">
                <div style="width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#06b6d4,#0891b2);display:flex;align-items:center;justify-content:center;">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="white">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                </div>
                <div style="flex:1;">
                    <p style="margin:0;font-weight:500;color:#1e293b;">Scrivici</p>
                    <p style="margin:4px 0 0 0;font-size:13px;color:#06b6d4;">freezy_assistens.@gmail.com</p>
                </div>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </a>
            
            <!-- FAQ -->
            <div style="background:white;padding:16px;border-radius:12px;border:1px solid #e2e8f0;">
                <p style="margin:0 0 12px 0;font-weight:600;color:#1e293b;">Domande Frequenti</p>
                
                <div style="border-top:1px solid #e2e8f0;padding-top:12px;">
                    <details style="margin-bottom:8px;">
                        <summary style="cursor:pointer;font-size:14px;color:#334155;padding:8px 0;">Come aggiungo alimenti?</summary>
                        <p style="margin:8px 0 0 0;font-size:13px;color:#64748b;padding-left:12px;">Vai nella sezione Frigo e usa la fotocamera o aggiungi manualmente.</p>
                    </details>
                    <details style="margin-bottom:8px;">
                        <summary style="cursor:pointer;font-size:14px;color:#334155;padding:8px 0;">Come funzionano le notifiche?</summary>
                        <p style="margin:8px 0 0 0;font-size:13px;color:#64748b;padding-left:12px;">Riceverai avvisi quando i prodotti stanno per scadere o sono quasi finiti.</p>
                    </details>
                    <details>
                        <summary style="cursor:pointer;font-size:14px;color:#334155;padding:8px 0;">Posso suggerire ricette?</summary>
                        <p style="margin:8px 0 0 0;font-size:13px;color:#64748b;padding-left:12px;">SÃ¬! Frosty AI ti suggerirÃ  ricette basate sugli ingredienti che hai.</p>
                    </details>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- OVERLAY NOTIFICHE -->
<div id="notifiche-overlay" onclick="closeNotificheSection()"></div>

<!-- SEZIONE NOTIFICHE -->
<div id="notifiche-section">
    <div style="padding: 20px;">
        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-top: env(safe-area-inset-top, 10px);">
            <h2 style="margin: 0; font-size: 20px; font-weight: 700; color: #1e293b;">Notifiche</h2>
            <div style="display:flex;gap:12px;align-items:center;">
    <button onclick="closeNotificheSection()" style="background: rgba(0,0,0,0.05); border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Lista Notifiche -->
        <div id="notifiche-list" style="display: flex; flex-direction: column; gap: 12px;">
            <!-- Le notifiche verranno aggiunte qui dal JavaScript -->
        </div>
        
        <!-- Nessuna notifica -->
        <div id="no-notifiche" style="display:none;text-align:center;padding:40px 20px;">
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" stroke-width="1.5" style="margin-bottom:16px;">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            <p style="margin:0;color:#94a3b8;font-size:15px;">Nessuna notifica</p>
        </div>
    </div>
</div>

<!-- DETTAGLIO NOTIFICA PANEL -->
<div id="notifica-detail-panel" style="display:none;position:fixed;top:0;left:0;width:100%;height:100vh;background:#f8fafc;z-index:100002;overflow-y:auto;">
    <div style="padding:20px;">
        <div style="display:flex;align-items:center;margin-bottom:24px;padding-top:env(safe-area-inset-top,10px);">
            <button onclick="closeNotificaDetail()" style="background:transparent;border:none;cursor:pointer;display:flex;align-items:center;gap:8px;color:#64748b;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Indietro
            </button>
        </div>
        
        <div id="notifica-detail-content">
            <!-- Contenuto notifica qui -->
        </div>
    </div>
</div>

<script>
// ========== FIX TASTIERA MOBILE - BARRA CHE SI ALZA ==========
(function() {
    const assistenteSection = document.getElementById('assistente');
    const frostyInput = document.getElementById('frosty-input');
    
    if (!frostyInput || !assistenteSection) return;
    
    let keyboardHeight = 0;
    
    // Metodo 1: Visual Viewport API (migliore per mobile moderni)
    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
            const currentHeight = window.innerHeight - window.visualViewport.height;
            
            if (currentHeight > 100) {
                // Tastiera aperta
                keyboardHeight = currentHeight;
                assistenteSection.style.setProperty('--keyboard-height', keyboardHeight + 'px');
                assistenteSection.classList.add('keyboard-open');
                
                // Scrolla i messaggi in vista
                const messagesArea = document.getElementById('frosty-messages');
                if (messagesArea) {
                    setTimeout(() => {
                        messagesArea.scrollTop = messagesArea.scrollHeight;
                    }, 100);
                }
            } else {
                // Tastiera chiusa
                assistenteSection.classList.remove('keyboard-open');
                assistenteSection.style.setProperty('--keyboard-height', '0px');
            }
        });
    }
    
    // Metodo 2: Focus/Blur (fallback per browser vecchi)
    frostyInput.addEventListener('focus', function() {
        setTimeout(() => {
            // Stima altezza tastiera se visualViewport non disponibile
            if (!window.visualViewport) {
                const estimatedKeyboard = window.innerHeight * 0.4; // ~40% schermo
                assistenteSection.style.setProperty('--keyboard-height', estimatedKeyboard + 'px');
                assistenteSection.classList.add('keyboard-open');
            }
            
            // Scrolla l'input in vista
            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
    });
    
    frostyInput.addEventListener('blur', function() {
        setTimeout(() => {
            if (!window.visualViewport) {
                assistenteSection.classList.remove('keyboard-open');
                assistenteSection.style.setProperty('--keyboard-height', '0px');
            }
        }, 100);
    });
    
    // Fix iOS Safari - previene scroll della pagina
    if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
        document.addEventListener('focusin', (e) => {
            if (e.target === frostyInput) {
                document.body.style.position = 'fixed';
                document.body.style.width = '100%';
            }
        });
        
        document.addEventListener('focusout', (e) => {
            if (e.target === frostyInput) {
                document.body.style.position = '';
                document.body.style.width = '';
                window.scrollTo(0, 0);
            }
        });
    }
})();

// ========== SISTEMA MULTILINGUA COMPLETO ==========
const translations = {
    it: {
        // Navbar
        home: 'Home',
        spesa: 'Spesa',
        frigo: 'Frigo',
        dieta: 'Dieta',
        impostazioni: 'Impostazioni',
        
        // Assistente Frosty
        scriviOParla: 'Scrivi o parla...',
        ciaoSonoFrosty: 'Ciao! Sono Frosty.',
        possoAiutarti: 'Posso aiutarti con il frigo, le diete e nuove ricette.',
        scriviQualcosa: 'Scrivi qualcosa per iniziare!',
        ascolta: 'Ascolta',
        
        // Profilo
        profilo: 'Profilo',
        modificaProfilo: 'Modifica profilo',
        preferenze: 'Preferenze',
        aiutoAssistenza: 'Aiuto & Assistenza',
        esci: 'Esci',
        salva: 'Salva',
        indietro: 'Indietro',
        nome: 'Nome',
        email: 'Email',
        telefono: 'Telefono',
        cambiaFoto: 'Cambia foto',
        ilTuoNome: 'Il tuo nome',
        laTuaEmail: 'La tua email',
        ilTuoNumero: 'Il tuo numero',
        utente: 'Utente',
        aggiungiEmail: 'Aggiungi email',
        
        // Preferenze
        notifiche: 'Notifiche',
        riceviAvvisi: 'Ricevi avvisi su scadenze',
        temaScuro: 'Tema scuro',
        attivaModalita: 'Attiva modalitÃ  scura',
        suoni: 'Suoni',
        abilitaSuoni: 'Abilita suoni app',
        promemoriaPasti: 'Promemoria pasti',
        ricordaPasti: 'Ricorda colazione, pranzo, cena',
        suggerimentiRicette: 'Suggerimenti ricette',
        riceviIdee: 'Ricevi idee giornaliere',
        privacyConsensi: 'Privacy e Consensi',
        datiUtilizzo: 'Dati di utilizzo',
        aiutaciMigliorare: 'Aiutaci a migliorare l\'app',
        comunicazioniMarketing: 'Comunicazioni marketing',
        novitaOfferte: 'NovitÃ  e offerte speciali',
        informativaPrivacy: 'Informativa Privacy',
        terminiServizio: 'Termini di Servizio',
        eliminaDati: 'Elimina tutti i miei dati',
        
        // Aiuto
        siamoQuiAiutarti: 'Siamo qui per aiutarti!',
        chiamaci: 'Chiamaci',
        scrivici: 'Scrivici',
        domandeFAQ: 'Domande Frequenti',
        comeAggiungoAlimenti: 'Come aggiungo alimenti?',
        rispostaAlimenti: 'Vai nella sezione Frigo e usa la fotocamera o aggiungi manualmente.',
        comeFunzionanoNotifiche: 'Come funzionano le notifiche?',
        rispostaNotifiche: 'Riceverai avvisi quando i prodotti stanno per scadere o sono quasi finiti.',
        possoSuggerireRicette: 'Posso suggerire ricette?',
        rispostaRicette: 'SÃ¬! Frosty AI ti suggerirÃ  ricette basate sugli ingredienti che hai.',
        
        // Notifiche
        notificheTitle: 'Notifiche',
        cancellaTutto: 'Cancella tutto',
        nessunaNotifica: 'Nessuna notifica',
        
        // Temperature Card
        temperaturaFrigo: 'Temperatura Frigo',
        stato: 'Stato',
        ottimale: 'Ottimale',
        
        // Menu 3 puntini
        aggiungiFile: 'Aggiungi file',
        aggiungiImmagine: 'Aggiungi immagine',
        cambiaVoce: 'Cambia voce',
        scegliVoce: 'Scegli voce',
        
        // Conferme
        seiSicuroUscire: 'Sei sicuro di voler uscire?',
        eliminareNotifiche: 'Eliminare tutte le notifiche?',
        eliminareNotificheConferma: 'Conferma: eliminare profilo, preferenze, alimenti e notifiche?',
        eliminaDatiConferma: 'Sei sicuro di voler eliminare TUTTI i tuoi dati?\n\nQuesta azione Ã¨ irreversibile.',
        
        // Toast
        profiloSalvato: 'Profilo salvato! âœ“',
        fotoAggiornata: 'Foto aggiornata! ðŸ“¸',
        attivato: 'Attivato âœ“',
        disattivato: 'Disattivato',
        disconnesso: 'Disconnesso',
        tuttiDatiEliminati: 'Tutti i dati eliminati',
        
        // Privacy
        ultimoAggiornamento: 'Ultimo aggiornamento:',
        datiRaccolti: 'Dati raccolti',
        testoPrivacy1: 'Raccogliamo solo i dati necessari per il funzionamento dell\'app: informazioni sugli alimenti, preferenze utente e dati del profilo. Tutti i dati sono salvati localmente sul tuo dispositivo.',
        utilizzoDati: 'Utilizzo dei dati',
        testoPrivacy2: 'I tuoi dati vengono utilizzati esclusivamente per fornirti un\'esperienza personalizzata, come suggerimenti di ricette e notifiche di scadenza.',
        condivisione: 'Condivisione',
        testoPrivacy3: 'Non condividiamo i tuoi dati personali con terze parti. Le richieste all\'assistente AI vengono elaborate in modo anonimo.',
        tuoiDiritti: 'I tuoi diritti',
        testoPrivacy4: 'Puoi eliminare tutti i tuoi dati in qualsiasi momento dalle Preferenze.',
        
        // Termini
        accettazione: 'Accettazione',
        testoTermini1: 'Utilizzando Frigo Smart AI, accetti questi termini di servizio. L\'app Ã¨ fornita "cosÃ¬ com\'Ã¨" per uso personale.',
        usoConsentito: 'Uso consentito',
        testoTermini2: 'L\'app Ã¨ destinata alla gestione domestica degli alimenti. Non siamo responsabili per decisioni alimentari basate sui suggerimenti dell\'app.',
        limitazioni: 'Limitazioni',
        testoTermini3: 'I suggerimenti dell\'assistente AI sono indicativi. Verifica sempre le date di scadenza reali sui prodotti.',
        contatti: 'Contatti',
        testoTermini4: 'Per supporto:'
    },
    
    en: {
        // Navbar
        home: 'Home',
        spesa: 'Shopping',
        frigo: 'Fridge',
        dieta: 'Diet',
        impostazioni: 'Settings',
        
        // Assistente Frosty
        scriviOParla: 'Write or speak...',
        ciaoSonoFrosty: 'Hello! I\'m Frosty.',
        possoAiutarti: 'I can help you with the fridge, diets and new recipes.',
        scriviQualcosa: 'Write something to start!',
        ascolta: 'Listen',
        
        // Profilo
        profilo: 'Profile',
        modificaProfilo: 'Edit profile',
        preferenze: 'Preferences',
        aiutoAssistenza: 'Help & Support',
        esci: 'Logout',
        salva: 'Save',
        indietro: 'Back',
        nome: 'Name',
        email: 'Email',
        telefono: 'Phone',
        cambiaFoto: 'Change photo',
        ilTuoNome: 'Your name',
        laTuaEmail: 'Your email',
        ilTuoNumero: 'Your number',
        utente: 'User',
        aggiungiEmail: 'Add email',
        
        // Preferenze
        notifiche: 'Notifications',
        riceviAvvisi: 'Receive expiry alerts',
        temaScuro: 'Dark theme',
        attivaModalita: 'Enable dark mode',
        suoni: 'Sounds',
        abilitaSuoni: 'Enable app sounds',
        promemoriaPasti: 'Meal reminders',
        ricordaPasti: 'Remember breakfast, lunch, dinner',
        suggerimentiRicette: 'Recipe suggestions',
        riceviIdee: 'Receive daily ideas',
        privacyConsensi: 'Privacy and Consents',
        datiUtilizzo: 'Usage data',
        aiutaciMigliorare: 'Help us improve the app',
        comunicazioniMarketing: 'Marketing communications',
        novitaOfferte: 'News and special offers',
        informativaPrivacy: 'Privacy Policy',
        terminiServizio: 'Terms of Service',
        eliminaDati: 'Delete all my data',
        
        // Aiuto
        siamoQuiAiutarti: 'We\'re here to help!',
        chiamaci: 'Call us',
        scrivici: 'Write to us',
        domandeFAQ: 'Frequently Asked Questions',
        comeAggiungoAlimenti: 'How do I add food?',
        rispostaAlimenti: 'Go to the Fridge section and use the camera or add manually.',
        comeFunzionanoNotifiche: 'How do notifications work?',
        rispostaNotifiche: 'You\'ll receive alerts when products are about to expire or running low.',
        possoSuggerireRicette: 'Can I get recipe suggestions?',
        rispostaRicette: 'Yes! Frosty AI will suggest recipes based on the ingredients you have.',
        
        // Notifiche
        notificheTitle: 'Notifications',
        cancellaTutto: 'Clear all',
        nessunaNotifica: 'No notifications',
        
        // Temperature Card
        temperaturaFrigo: 'Fridge Temperature',
        stato: 'Status',
        ottimale: 'Optimal',
        
        // Menu 3 puntini
        aggiungiFile: 'Add file',
        aggiungiImmagine: 'Add image',
        cambiaVoce: 'Change voice',
        scegliVoce: 'Choose voice',
        
        // Conferme
        seiSicuroUscire: 'Are you sure you want to logout?',
        eliminareNotifiche: 'Delete all notifications?',
        eliminareNotificheConferma: 'Confirm: delete profile, preferences, food and notifications?',
        eliminaDatiConferma: 'Are you sure you want to delete ALL your data?\n\nThis action is irreversible.',
        
        // Toast
        profiloSalvato: 'Profile saved! âœ“',
        fotoAggiornata: 'Photo updated! ðŸ“¸',
        attivato: 'Enabled âœ“',
        disattivato: 'Disabled',
        disconnesso: 'Logged out',
        tuttiDatiEliminati: 'All data deleted',
        
        // Privacy
        ultimoAggiornamento: 'Last updated:',
        datiRaccolti: 'Data collected',
        testoPrivacy1: 'We only collect data necessary for the app to function: food information, user preferences and profile data. All data is saved locally on your device.',
        utilizzoDati: 'Data usage',
        testoPrivacy2: 'Your data is used exclusively to provide you with a personalized experience, such as recipe suggestions and expiry notifications.',
        condivisione: 'Sharing',
        testoPrivacy3: 'We do not share your personal data with third parties. AI assistant requests are processed anonymously.',
        tuoiDiritti: 'Your rights',
        testoPrivacy4: 'You can delete all your data at any time from Preferences.',
        
        // Termini
        accettazione: 'Acceptance',
        testoTermini1: 'By using Frigo Smart AI, you accept these terms of service. The app is provided "as is" for personal use.',
        usoConsentito: 'Permitted use',
        testoTermini2: 'The app is intended for home food management. We are not responsible for food decisions based on app suggestions.',
        limitazioni: 'Limitations',
        testoTermini3: 'AI assistant suggestions are indicative. Always check the actual expiry dates on products.',
        contatti: 'Contact',
        testoTermini4: 'For support:'
    },
    
    fr: {
        // Navbar
        home: 'Accueil',
        spesa: 'Courses',
        frigo: 'Frigo',
        dieta: 'RÃ©gime',
        impostazioni: 'ParamÃ¨tres',
        
        // Assistente Frosty
        scriviOParla: 'Ã‰crivez ou parlez...',
        ciaoSonoFrosty: 'Salut! Je suis Frosty.',
        possoAiutarti: 'Je peux vous aider avec le frigo, les rÃ©gimes et de nouvelles recettes.',
        scriviQualcosa: 'Ã‰crivez quelque chose pour commencer!',
        ascolta: 'Ã‰couter',
        
        // Profilo
        profilo: 'Profil',
        modificaProfilo: 'Modifier le profil',
        preferenze: 'PrÃ©fÃ©rences',
        aiutoAssistenza: 'Aide & Assistance',
        esci: 'DÃ©connexion',
        salva: 'Sauvegarder',
        indietro: 'Retour',
        nome: 'Nom',
        email: 'Email',
        telefono: 'TÃ©lÃ©phone',
        cambiaFoto: 'Changer la photo',
        ilTuoNome: 'Votre nom',
        laTuaEmail: 'Votre email',
        ilTuoNumero: 'Votre numÃ©ro',
        utente: 'Utilisateur',
        aggiungiEmail: 'Ajouter email',
        
        // Preferenze
        notifiche: 'Notifications',
        riceviAvvisi: 'Recevoir des alertes d\'expiration',
        temaScuro: 'ThÃ¨me sombre',
        attivaModalita: 'Activer le mode sombre',
        suoni: 'Sons',
        abilitaSuoni: 'Activer les sons de l\'app',
        promemoriaPasti: 'Rappels de repas',
        ricordaPasti: 'Rappeler petit-dÃ©jeuner, dÃ©jeuner, dÃ®ner',
        suggerimentiRicette: 'Suggestions de recettes',
        riceviIdee: 'Recevoir des idÃ©es quotidiennes',
        privacyConsensi: 'ConfidentialitÃ© et Consentements',
        datiUtilizzo: 'DonnÃ©es d\'utilisation',
        aiutaciMigliorare: 'Aidez-nous Ã  amÃ©liorer l\'app',
        comunicazioniMarketing: 'Communications marketing',
        novitaOfferte: 'NouveautÃ©s et offres spÃ©ciales',
        informativaPrivacy: 'Politique de confidentialitÃ©',
        terminiServizio: 'Conditions d\'utilisation',
        eliminaDati: 'Supprimer toutes mes donnÃ©es',
        
        // Aiuto
        siamoQuiAiutarti: 'Nous sommes lÃ  pour vous aider!',
        chiamaci: 'Appelez-nous',
        scrivici: 'Ã‰crivez-nous',
        domandeFAQ: 'Questions FrÃ©quentes',
        comeAggiungoAlimenti: 'Comment ajouter des aliments?',
        rispostaAlimenti: 'Allez dans la section Frigo et utilisez l\'appareil photo ou ajoutez manuellement.',
        comeFunzionanoNotifiche: 'Comment fonctionnent les notifications?',
        rispostaNotifiche: 'Vous recevrez des alertes lorsque les produits sont sur le point d\'expirer.',
        possoSuggerireRicette: 'Puis-je avoir des suggestions de recettes?',
        rispostaRicette: 'Oui! Frosty AI vous suggÃ©rera des recettes basÃ©es sur les ingrÃ©dients que vous avez.',
        
        // Notifiche
        notificheTitle: 'Notifications',
        cancellaTutto: 'Tout effacer',
        nessunaNotifica: 'Aucune notification',
        
        // Temperature Card
        temperaturaFrigo: 'TempÃ©rature du Frigo',
        stato: 'Ã‰tat',
        ottimale: 'Optimal',
        
        // Menu 3 puntini
        aggiungiFile: 'Ajouter fichier',
        aggiungiImmagine: 'Ajouter image',
        cambiaVoce: 'Changer de voix',
        scegliVoce: 'Choisir la voix',
        
        // Conferme
        seiSicuroUscire: 'ÃŠtes-vous sÃ»r de vouloir vous dÃ©connecter?',
        eliminareNotifiche: 'Supprimer toutes les notifications?',
        eliminareNotificheConferma: 'Confirmer: supprimer profil, prÃ©fÃ©rences, aliments et notifications?',
        eliminaDatiConferma: 'ÃŠtes-vous sÃ»r de vouloir supprimer TOUTES vos donnÃ©es?\n\nCette action est irrÃ©versible.',
        
        // Toast
        profiloSalvato: 'Profil sauvegardÃ©! âœ“',
        fotoAggiornata: 'Photo mise Ã  jour! ðŸ“¸',
        attivato: 'ActivÃ© âœ“',
        disattivato: 'DÃ©sactivÃ©',
        disconnesso: 'DÃ©connectÃ©',
        tuttiDatiEliminati: 'Toutes les donnÃ©es supprimÃ©es'
    },
    
    es: {
        // Navbar
        home: 'Inicio',
        spesa: 'Compras',
        frigo: 'Nevera',
        dieta: 'Dieta',
        impostazioni: 'Ajustes',
        
        // Assistente Frosty
        scriviOParla: 'Escribe o habla...',
        ciaoSonoFrosty: 'Â¡Hola! Soy Frosty.',
        possoAiutarti: 'Puedo ayudarte con la nevera, las dietas y nuevas recetas.',
        scriviQualcosa: 'Â¡Escribe algo para empezar!',
        ascolta: 'Escuchar',
        
        // Profilo
        profilo: 'Perfil',
        modificaProfilo: 'Editar perfil',
        preferenze: 'Preferencias',
        aiutoAssistenza: 'Ayuda y Soporte',
        esci: 'Cerrar sesiÃ³n',
        salva: 'Guardar',
        indietro: 'AtrÃ¡s',
        nome: 'Nombre',
        email: 'Email',
        telefono: 'TelÃ©fono',
        cambiaFoto: 'Cambiar foto',
        ilTuoNome: 'Tu nombre',
        laTuaEmail: 'Tu email',
        ilTuoNumero: 'Tu nÃºmero',
        utente: 'Usuario',
        aggiungiEmail: 'AÃ±adir email',
        
        // Preferenze
        notifiche: 'Notificaciones',
        riceviAvvisi: 'Recibir alertas de caducidad',
        temaScuro: 'Tema oscuro',
        attivaModalita: 'Activar modo oscuro',
        suoni: 'Sonidos',
        abilitaSuoni: 'Habilitar sonidos de la app',
        promemoriaPasti: 'Recordatorios de comidas',
        ricordaPasti: 'Recordar desayuno, almuerzo, cena',
        suggerimentiRicette: 'Sugerencias de recetas',
        riceviIdee: 'Recibir ideas diarias',
        privacyConsensi: 'Privacidad y Consentimientos',
        datiUtilizzo: 'Datos de uso',
        aiutaciMigliorare: 'AyÃºdanos a mejorar la app',
        comunicazioniMarketing: 'Comunicaciones de marketing',
        novitaOfferte: 'Novedades y ofertas especiales',
        informativaPrivacy: 'PolÃ­tica de Privacidad',
        terminiServizio: 'TÃ©rminos de Servicio',
        eliminaDati: 'Eliminar todos mis datos',
        
        // Aiuto
        siamoQuiAiutarti: 'Â¡Estamos aquÃ­ para ayudarte!',
        chiamaci: 'LlÃ¡manos',
        scrivici: 'EscrÃ­benos',
        domandeFAQ: 'Preguntas Frecuentes',
        comeAggiungoAlimenti: 'Â¿CÃ³mo aÃ±ado alimentos?',
        rispostaAlimenti: 'Ve a la secciÃ³n Nevera y usa la cÃ¡mara o aÃ±ade manualmente.',
        comeFunzionanoNotifiche: 'Â¿CÃ³mo funcionan las notificaciones?',
        rispostaNotifiche: 'RecibirÃ¡s alertas cuando los productos estÃ©n a punto de caducar.',
        possoSuggerireRicette: 'Â¿Puedo obtener sugerencias de recetas?',
        rispostaRicette: 'Â¡SÃ­! Frosty AI te sugerirÃ¡ recetas basadas en los ingredientes que tienes.',
        
        // Notifiche
        notificheTitle: 'Notificaciones',
        cancellaTutto: 'Borrar todo',
        nessunaNotifica: 'Sin notificaciones',
        
        // Temperature Card
        temperaturaFrigo: 'Temperatura de la Nevera',
        stato: 'Estado',
        ottimale: 'Ã“ptimo',
        
        // Menu 3 puntini
        aggiungiFile: 'AÃ±adir archivo',
        aggiungiImmagine: 'AÃ±adir imagen',
        cambiaVoce: 'Cambiar voz',
        scegliVoce: 'Elegir voz',
        
        // Conferme
        seiSicuroUscire: 'Â¿EstÃ¡s seguro de que quieres cerrar sesiÃ³n?',
        eliminareNotifiche: 'Â¿Eliminar todas las notificaciones?',
        eliminareNotificheConferma: 'Confirmar: Â¿eliminar perfil, preferencias, alimentos y notificaciones?',
        eliminaDatiConferma: 'Â¿EstÃ¡s seguro de que quieres eliminar TODOS tus datos?\n\nEsta acciÃ³n es irreversible.',
        
        // Toast
        profiloSalvato: 'Â¡Perfil guardado! âœ“',
        fotoAggiornata: 'Â¡Foto actualizada! ðŸ“¸',
        attivato: 'Activado âœ“',
        disattivato: 'Desactivado',
        disconnesso: 'Desconectado',
        tuttiDatiEliminati: 'Todos los datos eliminados'
    }
};

let currentLanguage = localStorage.getItem('appLanguage') || null;

function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('appLanguage', lang);
    applyTranslations();
    document.getElementById('language-selector-modal').style.display = 'none';
}

function t(key) {
    if (!currentLanguage || !translations[currentLanguage]) return key;
    return translations[currentLanguage][key] || translations['it'][key] || key;
}

function applyTranslations() {
    if (!currentLanguage) return;
    
    // Navbar labels
    const navLabels = document.querySelectorAll('.nav-label');
    const navKeys = ['home', 'spesa', 'frigo', 'dieta', 'impostazioni'];
    navLabels.forEach((el, i) => {
        if (navKeys[i]) el.textContent = t(navKeys[i]);
    });
    
    // Input placeholder Frosty
    const frostyInput = document.getElementById('frosty-input');
    if (frostyInput) frostyInput.placeholder = t('scriviOParla');
    
    // Tutti gli elementi con data-t
    document.querySelectorAll('[data-t]').forEach(el => {
        const key = el.getAttribute('data-t');
        el.textContent = t(key);
    });
    
    // Tutti i placeholder con data-t-placeholder
    document.querySelectorAll('[data-t-placeholder]').forEach(el => {
        const key = el.getAttribute('data-t-placeholder');
        el.placeholder = t(key);
    });
}

// Mostra selettore lingua se prima apertura
(function checkLanguage() {
    const modal = document.getElementById('language-selector-modal');
    if (!currentLanguage && modal) {
        modal.style.display = 'flex';
    } else {
        applyTranslations();
    }
})();

// ========== FUNZIONI LINGUA PREFERENZE ==========
function openLanguageSelector() {
    document.getElementById('language-selector-modal').style.display = 'flex';
}

function updateLangLabel() {
    const label = document.getElementById('current-lang-label');
    if (label) {
        const flags = { it: 'ðŸ‡®ðŸ‡¹ IT', en: 'ðŸ‡¬ðŸ‡§ EN', fr: 'ðŸ‡«ðŸ‡· FR', es: 'ðŸ‡ªðŸ‡¸ ES' };
        label.textContent = flags[currentLanguage] || 'ðŸ‡®ðŸ‡¹ IT';
    }
}

// Aggiorna label quando cambia lingua
const originalSetLanguage = setLanguage;
setLanguage = function(lang) {
    originalSetLanguage(lang);
    updateLangLabel();
};

// Aggiorna label all'avvio
document.addEventListener('DOMContentLoaded', updateLangLabel);

// ========== AGGIORNA GRAFICO DONUT E MACROS ==========
function updateDonutChart() {
    // Leggi valori correnti
    const target = parseInt(document.getElementById('kcalTarget')?.textContent) || 2000;
    const progress = parseInt(document.getElementById('kcalProgress')?.textContent) || 0;
    
    // Aggiorna valori nel donut
    const kcalConsumate = document.getElementById('kcalConsumate');
    const kcalTotaleDonut = document.getElementById('kcalTotaleDonut');
    if (kcalConsumate) kcalConsumate.textContent = progress;
    if (kcalTotaleDonut) kcalTotaleDonut.textContent = target;
    
    // Calcola percentuale per il grafico
    const percentage = Math.min((progress / target) * 100, 100);
    const circumference = 2 * Math.PI * 40; // r=40
    const dashArray = (percentage / 100) * circumference;
    
    const segment = document.getElementById('donutSegment');
    if (segment) {
        segment.style.strokeDasharray = `${dashArray} ${circumference}`;
        
        // Cambia colore in base alla percentuale
        if (progress > target) {
            segment.style.stroke = '#ef4444'; // Rosso se supera
        } else if (percentage > 85) {
            segment.style.stroke = '#f59e0b'; // Arancione se vicino
        } else {
            segment.style.stroke = '#10b981'; // Verde normale
        }
    }
    
    // Aggiorna macros nel riepilogo
    const protProgress = parseInt(document.getElementById('protProgress')?.textContent) || 0;
    const protTarget = parseInt(document.getElementById('protTarget')?.textContent) || 100;
    const carbProgress = parseInt(document.getElementById('carbProgress')?.textContent) || 0;
    const carbTarget = parseInt(document.getElementById('carbTarget')?.textContent) || 100;
    const fatProgress = parseInt(document.getElementById('fatProgress')?.textContent) || 0;
    const fatTarget = parseInt(document.getElementById('fatTarget')?.textContent) || 100;
    
    // Valori
    const protRiepilogo = document.getElementById('protRiepilogo');
    const carbRiepilogo = document.getElementById('carbRiepilogo');
    const fatRiepilogo = document.getElementById('fatRiepilogo');
    if (protRiepilogo) protRiepilogo.textContent = protProgress;
    if (carbRiepilogo) carbRiepilogo.textContent = carbProgress;
    if (fatRiepilogo) fatRiepilogo.textContent = fatProgress;
    
    // Totali
    const protTotRiepilogo = document.getElementById('protTotRiepilogo');
    const carbTotRiepilogo = document.getElementById('carbTotRiepilogo');
    const fatTotRiepilogo = document.getElementById('fatTotRiepilogo');
    if (protTotRiepilogo) protTotRiepilogo.textContent = protTarget;
    if (carbTotRiepilogo) carbTotRiepilogo.textContent = carbTarget;
    if (fatTotRiepilogo) fatTotRiepilogo.textContent = fatTarget;
    
    // Barre progresso
    const protPercent = Math.min((protProgress / protTarget) * 100, 100);
    const carbPercent = Math.min((carbProgress / carbTarget) * 100, 100);
    const fatPercent = Math.min((fatProgress / fatTarget) * 100, 100);
    
    const protBar = document.getElementById('protBarRiepilogo');
    const carbBar = document.getElementById('carbBarRiepilogo');
    const fatBar = document.getElementById('fatBarRiepilogo');
    if (protBar) protBar.style.width = protPercent + '%';
    if (carbBar) carbBar.style.width = carbPercent + '%';
    if (fatBar) fatBar.style.width = fatPercent + '%';
}

// Scrolla alla sezione calcola
function scrollToCalcSection() {
    const calcCard = document.querySelector('.fabbisogno-calc-card');
    if (calcCard) {
        calcCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Apri la sezione se chiusa
        const content = document.getElementById('calcContent');
        if (content && content.classList.contains('collapsed')) {
            toggleCalcSection();
        }
    }
}

function animateMacroBars() {
    const bars = document.querySelectorAll('.macro-progress-fill');
    bars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.width = width;
        }, 50);
    });
}

// ========================================
// ðŸ†• NUOVE FUNZIONI TRACCIA PASTI
// ========================================

// Popola il datalist con le ricette
function populateRecipeDatalist() {
    const datalist = document.getElementById('ricetteDatalist');
    const select = document.getElementById('pastoRicetta');
    
    if (!datalist || !recipes) return;
    
    datalist.innerHTML = '';
    select.innerHTML = '<option value="">Seleziona ricetta...</option>';
    
    recipes.forEach((r, idx) => {
        // Datalist per autocomplete
        const option = document.createElement('option');
        option.value = r.nome;
        option.setAttribute('data-idx', idx);
        datalist.appendChild(option);
        
        // Select nascosto per compatibilitÃ 
        const selectOpt = document.createElement('option');
        selectOpt.value = idx;
        selectOpt.textContent = `${r.nome} (${r.kcal} kcal)`;
        select.appendChild(selectOpt);
    });
}

// Aggiungi pasto dalla nuova barra di ricerca
function addMealFromSearch() {
    const searchInput = document.getElementById('searchPastoRicetta');
    const searchValue = searchInput.value.trim().toLowerCase();
    
    if (!searchValue) {
        if (typeof toast === 'function') toast('âš ï¸ Cerca una ricetta');
        return;
    }
    
    // Trova la ricetta corrispondente
    const recipeIndex = recipes.findIndex(r => 
        r.nome.toLowerCase() === searchValue || 
        r.nome.toLowerCase().includes(searchValue)
    );
    
    if (recipeIndex === -1) {
        if (typeof toast === 'function') toast('âŒ Ricetta non trovata');
        return;
    }
    
    // Imposta il select nascosto e chiama addMeal originale
    document.getElementById('pastoRicetta').value = recipeIndex;
    document.getElementById('porzioni').value = 1;
    
    // Chiama la funzione originale
    addMeal();
    
    // Pulisci input
    searchInput.value = '';
}

// Override filtraRicettePasto per aggiornare anche il datalist
const originalFiltraRicettePasto = window.filtraRicettePasto;
window.filtraRicettePasto = function() {
    const search = document.getElementById('searchPastoRicetta').value.toLowerCase();
    const select = document.getElementById('pastoRicetta');
    const datalist = document.getElementById('ricetteDatalist');
    
    // Aggiorna select nascosto (per compatibilitÃ )
    select.innerHTML = '<option value="">Seleziona...</option>';
    
    recipes.forEach((r, idx) => {
        if (search) {
            const match = r.nome.toLowerCase().includes(search) || 
                          r.ingredienti.some(i => i.toLowerCase().includes(search));
            if (!match) return;
        }
        
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = `${r.nome} (${r.kcal} kcal)`;
        select.appendChild(opt);
    });
    
    // Abilita/disabilita bottone
    const btn = document.getElementById('btnAddMealNew');
    if (btn) {
        btn.disabled = !search;
    }
};

// Inizializza al caricamento
window.addEventListener('load', () => {
    setTimeout(() => {
        populateRecipeDatalist();
        
        // Aggiungi listener Enter per aggiungere pasto
        const searchInput = document.getElementById('searchPastoRicetta');
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addMealFromSearch();
                }
            });
        }
    }, 1000);
});

// Aggiorna datalist quando cambiano le ricette
const originalRenderRecipes = window.renderRecipes;
window.renderRecipes = function() {
    if (typeof originalRenderRecipes === 'function') {
        originalRenderRecipes();
    }
    populateRecipeDatalist();
};


// ========================================
// ðŸ†• QUICK ADD - FUNZIONI DROPDOWN
// ========================================

let quickSelectedRecipe = null;
let quickSelectedRestaurant = null;

// Lista pasti ristorante (usa quella esistente se c'Ã¨, altrimenti crea)
const quickRestaurantList = [
    { name: 'ðŸ• Pizza Margherita', kcal: 800 },
    { name: 'ðŸ• Pizza 4 Stagioni', kcal: 950 },
    { name: 'ðŸ Pasta al Pomodoro', kcal: 600 },
    { name: 'ðŸ Pasta Carbonara', kcal: 850 },
    { name: 'ðŸ” Hamburger con Patatine', kcal: 1000 },
    { name: 'ðŸ£ Sushi Misto (16 pz)', kcal: 500 },
    { name: 'ðŸ¥— Insalata Caesar', kcal: 400 },
    { name: 'ðŸ¥© Bistecca con Contorno', kcal: 700 },
    { name: 'ðŸŒ¯ Kebab', kcal: 900 },
    { name: 'ðŸ¥™ Poke Bowl', kcal: 650 },
    { name: 'ðŸ¥ª Panino Gourmet', kcal: 550 }
];

// ========== DROPDOWN RICETTE ==========

function openRecipeDropdown() {
    const dropdown = document.getElementById('recipeDropdownList');
    const filters = document.getElementById('quickSearchFilters');
    buildRecipeDropdown();
    dropdown.classList.add('show');
    if (filters) filters.classList.add('show');
}

// ========== FILTRI QUICK SEARCH ==========

let quickSearchFilterState = {
    category: '',
    favOnly: false,
    savedOnly: false
};

function toggleQuickFilterFav() {
    quickSearchFilterState.favOnly = !quickSearchFilterState.favOnly;
    document.getElementById('quickFilterFavBtn').classList.toggle('active', quickSearchFilterState.favOnly);
    applyQuickSearchFilters();
}

function toggleQuickFilterSaved() {
    quickSearchFilterState.savedOnly = !quickSearchFilterState.savedOnly;
    document.getElementById('quickFilterSavedBtn').classList.toggle('active', quickSearchFilterState.savedOnly);
    applyQuickSearchFilters();
}

function applyQuickSearchFilters() {
    quickSearchFilterState.category = document.getElementById('quickFilterCategory').value;
    const input = document.getElementById('quickSearchRecipe');
    buildRecipeDropdownFiltered(input ? input.value : '');
}

function resetQuickSearchFilters() {
    quickSearchFilterState = { category: '', favOnly: false, savedOnly: false };
    document.getElementById('quickFilterCategory').value = '';
    document.getElementById('quickFilterFavBtn').classList.remove('active');
    document.getElementById('quickFilterSavedBtn').classList.remove('active');
    const input = document.getElementById('quickSearchRecipe');
    buildRecipeDropdownFiltered(input ? input.value : '');
}

let aiSearchTimeout = null;
let usedFoodsHistory = JSON.parse(localStorage.getItem('usedFoodsHistory') || '[]');

function saveUsedFood(name) {
    const nameLower = name.toLowerCase();
    if (!usedFoodsHistory.includes(nameLower)) {
        usedFoodsHistory.push(nameLower);
        localStorage.setItem('usedFoodsHistory', JSON.stringify(usedFoodsHistory));
    }
}

function isNewFood(name) {
    return !usedFoodsHistory.includes(name.toLowerCase());
}

function buildRecipeDropdownFiltered(filter = '') {
    const dropdown = document.getElementById('recipeDropdownList');
    if (!dropdown) return;
    
    dropdown.innerHTML = '';
    
    if (!recipes || recipes.length === 0) {
        dropdown.innerHTML = '<div class="quick-dropdown-empty">Nessuna ricetta disponibile</div>';
        return;
    }
    
    let filtered = recipes.filter(r => {
        // Filtro testo
        if (filter && !r.nome.toLowerCase().includes(filter.toLowerCase())) {
            return false;
        }
        
        // Filtro preferiti
        if (quickSearchFilterState.favOnly && !r.preferito) {
            return false;
        }
        
        // Filtro categoria
        const cat = quickSearchFilterState.category;
        if (cat) {
            const nome = r.nome.toLowerCase();
            const ing = Array.isArray(r.ingredienti) ? r.ingredienti.join(' ').toLowerCase() : (r.ingredienti || '').toLowerCase();
            
            if (cat === 'veg' && !r.veg) return false;
            if (cat === 'dolce' && !['dolce','torta','biscott','tiramisÃ¹','pancake','muffin','cioccolat','crema','gelato','crostata'].some(k => nome.includes(k) || ing.includes(k))) return false;
            if (cat === 'salato' && ['dolce','torta','biscott','tiramisÃ¹','pancake','muffin','cioccolat','crema','gelato','crostata'].some(k => nome.includes(k))) return false;
            if (cat === 'bevanda' && !['frullato','smoothie','latte','caffÃ¨','tÃ¨','succo','bevanda','drink'].some(k => nome.includes(k) || ing.includes(k))) return false;
            if (cat === 'colazione' && !['colazione','yogurt','cereali','pancake','uova','toast','brioche','cappuccino','latte'].some(k => nome.includes(k) || ing.includes(k))) return false;
            if (cat === 'snack' && !['snack','barretta','frutta','noci','mandorle','crackers'].some(k => nome.includes(k) || ing.includes(k))) return false;
            if (cat === 'carne' && !['pollo','manzo','maiale','vitello','tacchino','carne','bistecca','hamburger','salsiccia'].some(k => nome.includes(k) || ing.includes(k))) return false;
            if (cat === 'pesce' && !['pesce','salmone','tonno','merluzzo','gamberi','orata','branzino','frutti di mare'].some(k => nome.includes(k) || ing.includes(k))) return false;
            if (cat === 'pasta' && !['pasta','spaghetti','penne','fusilli','lasagne','ravioli','gnocchi','risotto','riso'].some(k => nome.includes(k) || ing.includes(k))) return false;
        }
        
        return true;
    });
    
    // Se ci sono risultati locali, mostrali
    if (filtered.length > 0) {
        filtered.slice(0, 15).forEach((r) => {
            const realIdx = recipes.indexOf(r);
            const item = document.createElement('div');
            item.className = 'quick-dropdown-item';
            item.innerHTML = `
                <span class="quick-dropdown-item-name">${r.preferito ? 'â­ ' : ''}${r.nome}</span>
                <span class="quick-dropdown-item-kcal">${r.kcal || 0} kcal</span>
            `;
            item.onclick = () => openQtySelect(realIdx, r.nome, r.kcal);
            dropdown.appendChild(item);
        });
        return;
    }
    
    // Nessun risultato locale - cerca con IA se c'Ã¨ testo
    const searchText = filter.trim();
    if (searchText.length >= 2 && groqApiKey) {
        dropdown.innerHTML = '<div class="quick-dropdown-ai-loading"><div class="spinner" style="width:20px;height:20px;border-width:2px;"></div> Cerco...</div>';
        
        // Debounce per non chiamare IA ad ogni lettera
        clearTimeout(aiSearchTimeout);
        aiSearchTimeout = setTimeout(() => {
            searchFoodWithAI(searchText);
        }, 600);
    } else if (searchText.length >= 2) {
        dropdown.innerHTML = '<div class="quick-dropdown-empty">Nessun risultato</div>';
    } else {
        dropdown.innerHTML = '<div class="quick-dropdown-empty">Scrivi per cercare...</div>';
    }
} 

async function searchFoodWithAI(query) {
    const dropdown = document.getElementById('recipeDropdownList');
    if (!dropdown) return;
    
    try {
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${groqApiKey}`
            },
            body: JSON.stringify({
                model: 'llama-3.1-8b-instant',
                messages: [{
                    role: 'user',
                    content: `Dammi i valori nutrizionali per "${query}". Rispondi SOLO con un JSON array di 1-3 risultati (varianti comuni). Formato esatto:
[{"nome": "Nome alimento", "kcal": 100, "prot": 10, "carb": 20, "fat": 5}]
Valori per porzione standard. Solo JSON array, nient'altro.`
                }],
                max_tokens: 300,
                temperature: 0.3
            })
        });
        
        const data = await response.json();
        const text = data.choices?.[0]?.message?.content || '';
        
        // Cerca array JSON
        const jsonMatch = text.match(/\[[\s\S]*?\]/);
        if (jsonMatch) {
            try {
                const results = JSON.parse(jsonMatch[0]);
                renderAIFoodResults(results);
                return;
            } catch(e) {}
        }
        
        // Prova oggetto singolo
        const objMatch = text.match(/\{[\s\S]*?\}/);
        if (objMatch) {
            try {
                const result = JSON.parse(objMatch[0]);
                renderAIFoodResults([result]);
                return;
            } catch(e) {}
        }
        
        dropdown.innerHTML = '<div class="quick-dropdown-empty">Nessun risultato trovato</div>';
        
    } catch (error) {
        console.error('Errore ricerca IA:', error);
        dropdown.innerHTML = '<div class="quick-dropdown-empty">Errore nella ricerca</div>';
    }
}

function renderAIFoodResults(results) {
    const dropdown = document.getElementById('recipeDropdownList');
    if (!dropdown || !results || results.length === 0) {
        dropdown.innerHTML = '<div class="quick-dropdown-empty">Nessun risultato trovato</div>';
        return;
    }
    
    dropdown.innerHTML = '';
    
    results.forEach((r) => {
        const isNew = isNewFood(r.nome);
        const item = document.createElement('div');
        item.className = 'quick-dropdown-ai-item';
        item.innerHTML = `
            <div class="quick-dropdown-ai-item-left">
                <span class="quick-dropdown-ai-item-name">${r.nome || 'Alimento'}</span>
                <span class="quick-dropdown-ai-item-info">P:${r.prot || 0}g Â· C:${r.carb || 0}g Â· G:${r.fat || 0}g</span>
            </div>
            <div class="quick-dropdown-ai-item-right">
                ${isNew ? '<span class="quick-dropdown-new-badge">Nuova!</span>' : ''}
                <span class="quick-dropdown-ai-item-kcal">${r.kcal || 0} kcal</span>
            </div>
        `;
        item.onclick = () => selectAIFood(r);
        dropdown.appendChild(item);
    });
}

function selectAIFood(food) {
    // Salva nello storico alimenti usati
    saveUsedFood(food.nome);
    
    // Aggiungi alle ricette per poterlo selezionare
    const tempRecipe = {
        nome: food.nome,
        veg: false,
        ingredienti: '',
        kcal: food.kcal || 0,
        prot: food.prot || 0,
        carb: food.carb || 0,
        fat: food.fat || 0
    };
    
    // Controlla se esiste giÃ 
    let existingIndex = recipes.findIndex(r => r.nome.toLowerCase() === tempRecipe.nome.toLowerCase());
    
    if (existingIndex === -1) {
        recipes.push(tempRecipe);
        existingIndex = recipes.length - 1;
        if (typeof saveRecipeIndexed === 'function') saveRecipeIndexed();
    }
    
    // Apri card quantitÃ 
    openQtySelect(existingIndex, tempRecipe.nome, tempRecipe.kcal);
}  
  
function buildRecipeDropdown(filter = '') {
    const dropdown = document.getElementById('recipeDropdownList');
    if (!dropdown) return;
    
    dropdown.innerHTML = '';
    
    if (!recipes || recipes.length === 0) {
        dropdown.innerHTML = '<div class="quick-dropdown-empty">Nessuna ricetta disponibile</div>';
        return;
    }
    
    const filtered = recipes.filter(r => 
        r.nome.toLowerCase().includes(filter.toLowerCase())
    );
    
    if (filtered.length === 0) {
        dropdown.innerHTML = '<div class="quick-dropdown-empty">Nessun risultato</div>';
        return;
    }
    
    filtered.slice(0, 15).forEach((r) => {
        const realIdx = recipes.indexOf(r);
        const item = document.createElement('div');
        item.className = 'quick-dropdown-item';
        item.innerHTML = `
            <span class="quick-dropdown-item-name">${r.nome}</span>
            <span class="quick-dropdown-item-kcal">${r.kcal || 0} kcal</span>
        `;
        item.onclick = () => openQtySelect(realIdx, r.nome, r.kcal);
        dropdown.appendChild(item);
    });
}

function filterRecipeDropdown() {
    const input = document.getElementById('quickSearchRecipe');
    if (!input) return;
    buildRecipeDropdownFiltered(input.value);
    document.getElementById('recipeDropdownList').classList.add('show');
}

function selectQuickRecipe(idx, name) {
    quickSelectedRecipe = idx;
    document.getElementById('quickSearchRecipe').value = name;
    document.getElementById('recipeDropdownList').classList.remove('show');
}

let currentQtySelection = null;  
  
function quickAddMeal() {
    // Usa selezione dalla card quantitÃ  se presente
    if (currentQtySelection) {
        // Salva nello storico
        if (typeof saveUsedFood === 'function') saveUsedFood(currentQtySelection.nome);
        
        // Prendi la ricetta
        const recipe = recipes[currentQtySelection.index];
        if (!recipe) {
            if (typeof toast === 'function') toast('âš ï¸ Seleziona un alimento');
            removeQtySelection();
            return;
        }
        
        // Verifica userNeeds
        if (!userNeeds) {
            alert('âš ï¸ Salva prima il fabbisogno');
            removeQtySelection();
            return;
        }
        
        // Calcola valori con moltiplicatore
        const mult = currentQtySelection.multiplier || 1;
        
        // Ottieni data di oggi
        const today = typeof getTodayKey === 'function' ? getTodayKey() : new Date().toISOString().split('T')[0];
        
        // Inizializza se necessario
        if (!window.dailyMeals) window.dailyMeals = {};
        if (!dailyMeals[today]) dailyMeals[today] = [];
        
        // Aggiungi il pasto
        dailyMeals[today].push({
            nome: recipe.nome,
            kcal: (recipe.kcal || 0) * mult,
            prot: (recipe.prot || 0) * mult,
            carb: (recipe.carb || 0) * mult,
            fat: (recipe.fat || 0) * mult,
            porzioni: mult,
            time: new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })
        });
        
        // Aggiorna UI
        if (typeof updateDailyTracking === 'function') updateDailyTracking();
        if (typeof updateDonutChart === 'function') updateDonutChart();
        if (typeof saveMenuIndexed === 'function') saveMenuIndexed();
        if (typeof aggiornaAnalisiSalute === 'function') aggiornaAnalisiSalute();
        if (typeof calcolaConfrontoCalorie === 'function') calcolaConfrontoCalorie();
        
        if (typeof toast === 'function') toast(`âœ… ${recipe.nome} aggiunto`);
        
        // Reset
        removeQtySelection();
        return;
    }
    
    // Fallback: nessuna selezione
    if (typeof toast === 'function') toast('âš ï¸ Seleziona un alimento');
}

// ========== DROPDOWN RISTORANTE ==========

function openRestaurantDropdown() {
    const dropdown = document.getElementById('restaurantDropdownList');
    buildRestaurantDropdown();
    dropdown.classList.add('show');
}

function buildRestaurantDropdown(filter = '') {
    const dropdown = document.getElementById('restaurantDropdownList');
    if (!dropdown) return;
    
    dropdown.innerHTML = '';
    
    const filtered = quickRestaurantList.filter(m => 
        m.name.toLowerCase().includes(filter.toLowerCase())
    );
    
    if (filtered.length === 0) {
        dropdown.innerHTML = '<div class="quick-dropdown-empty">Nessun risultato</div>';
        return;
    }
    
    filtered.forEach((m, idx) => {
        const realIdx = quickRestaurantList.indexOf(m);
        const item = document.createElement('div');
        item.className = 'quick-dropdown-item';
        item.innerHTML = `
            <span class="quick-dropdown-item-name">${m.name}</span>
            <span class="quick-dropdown-item-kcal">${m.kcal} kcal</span>
        `;
        item.onclick = () => selectQuickRestaurant(realIdx, m.name);
        dropdown.appendChild(item);
    });
}

function filterRestaurantDropdown() {
    const input = document.getElementById('quickSearchRestaurant');
    if (!input) return;
    buildRestaurantDropdown(input.value);
    document.getElementById('restaurantDropdownList').classList.add('show');
}

function selectQuickRestaurant(idx, name) {
    quickSelectedRestaurant = idx;
    document.getElementById('quickSearchRestaurant').value = name;
    document.getElementById('restaurantDropdownList').classList.remove('show');
}

function quickAddRestaurant() {
    const searchVal = document.getElementById('quickSearchRestaurant').value.trim().toLowerCase();
    
    if (quickSelectedRestaurant === null && searchVal) {
        const found = quickRestaurantList.findIndex(m => m.name.toLowerCase().includes(searchVal));
        if (found !== -1) quickSelectedRestaurant = found;
    }
    
    if (quickSelectedRestaurant === null) {
        if (typeof toast === 'function') toast('âš ï¸ Seleziona un pasto');
        return;
    }
    
    const meal = quickRestaurantList[quickSelectedRestaurant];
    const today = new Date().toISOString().split('T')[0];
    
    if (!dailyMeals) window.dailyMeals = {};
    if (!dailyMeals[today]) dailyMeals[today] = [];
    
    dailyMeals[today].push({
        nome: meal.name,
        kcal: meal.kcal,
        prot: Math.round(meal.kcal * 0.15 / 4),
        carb: Math.round(meal.kcal * 0.5 / 4),
        fat: Math.round(meal.kcal * 0.35 / 9),
        porzioni: 1,
        ora: new Date().toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'}),
        tipo: 'ristorante'
    });
    
    if (typeof saveMenuIndexed === 'function') saveMenuIndexed();
    if (typeof updateDailyTracking === 'function') updateDailyTracking();
    if (typeof updateDonutChart === 'function') updateDonutChart();
    if (typeof toast === 'function') toast(`âœ… ${meal.name} aggiunto`);
    
    // Aggiorna Analisi Salute e Bilancio
    if (typeof aggiornaAnalisiSalute === 'function') aggiornaAnalisiSalute();
    if (typeof calcolaConfrontoCalorie === 'function') calcolaConfrontoCalorie();
    
    // Reset
    document.getElementById('quickSearchRestaurant').value = '';
    quickSelectedRestaurant = null;
}

// ========== PASTO PERSONALIZZATO ==========

function toggleQuickCustomMeal() {
    const section = document.getElementById('quickCustomMeal');
    if (section) section.classList.toggle('show');
}

function quickAddCustomMeal() {
    const name = document.getElementById('quickCustomName').value.trim();
    const kcal = parseInt(document.getElementById('quickCustomKcal').value) || 0;
    
    if (!name || !kcal) {
        if (typeof toast === 'function') toast('âš ï¸ Compila tutti i campi');
        return;
    }
    
    const today = new Date().toISOString().split('T')[0];
    if (!dailyMeals) window.dailyMeals = {};
    if (!dailyMeals[today]) dailyMeals[today] = [];
    
    dailyMeals[today].push({
        nome: `ðŸ½ï¸ ${name}`,
        kcal: kcal,
        prot: Math.round(kcal * 0.15 / 4),
        carb: Math.round(kcal * 0.5 / 4),
        fat: Math.round(kcal * 0.35 / 9),
        porzioni: 1,
        ora: new Date().toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'}),
        tipo: 'custom'
    });
    
    if (typeof saveMenuIndexed === 'function') saveMenuIndexed();
    if (typeof updateDailyTracking === 'function') updateDailyTracking();
    if (typeof updateDonutChart === 'function') updateDonutChart();
    if (typeof toast === 'function') toast(`âœ… ${name} aggiunto`);
    
    // Aggiorna Analisi Salute e Bilancio
    if (typeof aggiornaAnalisiSalute === 'function') aggiornaAnalisiSalute();
    if (typeof calcolaConfrontoCalorie === 'function') calcolaConfrontoCalorie();
    
    // Reset
    document.getElementById('quickCustomName').value = '';
    document.getElementById('quickCustomKcal').value = '';
    document.getElementById('quickCustomMeal').classList.remove('show');
}

// ========== CHIUDI DROPDOWN CLICCANDO FUORI ==========
document.addEventListener('click', function(e) {
    // Chiudi dropdown ricette e filtri
    const isInSearch = e.target.closest('#recipeSearchContainer');
    const isInFilters = e.target.closest('#quickSearchFilters');
    const isInQuickAdd = e.target.closest('.quick-add-section');
    
    if (!isInSearch && !isInFilters && !isInQuickAdd) {
        const rd = document.getElementById('recipeDropdownList');
        if (rd) rd.classList.remove('show');
        const filters = document.getElementById('quickSearchFilters');
        if (filters) filters.classList.remove('show');
    }
    
    // Chiudi dropdown ristorante
    if (!e.target.closest('#restaurantSearchContainer')) {
        const rrd = document.getElementById('restaurantDropdownList');
        if (rrd) rrd.classList.remove('show');
    }
});

// ========== INIZIALIZZA DROPDOWN AL CARICAMENTO ==========

document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        // Popola il select nascosto per compatibilitÃ 
        const selectEl = document.getElementById('pastoRicetta');
        if (selectEl && typeof recipes !== 'undefined' && recipes.length > 0) {
            selectEl.innerHTML = '<option value="">Seleziona...</option>';
            recipes.forEach((r, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.textContent = r.nome;
                selectEl.appendChild(opt);
            });
        }
    }, 1500);
});

console.log('âœ… Quick Add Dropdown caricato');

// ========================================
// ðŸ†• TOOLTIP INFO RISTORANTE
// ========================================

function toggleRestaurantInfo(event) {
    event.stopPropagation();
    const tooltip = document.getElementById('restaurantInfoTooltip');
    if (tooltip) {
        tooltip.classList.toggle('show');
    }
}

function closeRestaurantInfo() {
    const tooltip = document.getElementById('restaurantInfoTooltip');
    if (tooltip) {
        tooltip.classList.remove('show');
    }
}

// Chiudi tooltip cliccando fuori
document.addEventListener('click', function(e) {
    if (!e.target.closest('.restaurant-info-btn') && !e.target.closest('.restaurant-info-tooltip')) {
        closeRestaurantInfo();
    }
});

console.log('âœ… Restaurant Info Tooltip caricato');


// ========== SLIDE-IN FABBISOGNO ==========

function openFabbisognoSlide() {
    document.getElementById('fabbisogno-slide').classList.add('open');
    document.getElementById('fabbisogno-overlay').classList.add('open');
    document.body.style.overflow = 'hidden';
}

function closeFabbisognoSlide() {
    document.getElementById('fabbisogno-slide').classList.remove('open');
    document.getElementById('fabbisogno-overlay').classList.remove('open');
    document.body.style.overflow = '';
}
  
function scrollToCalcSection() {
    openFabbisognoSlide();
}
  
// ðŸ†• Mostra spinner aggiornamento
function mostraSpinnerAggiornamento() {
    const spinner = document.getElementById('updateSpinner');
    if (spinner) {
        spinner.style.display = 'flex';
    }
}

// ðŸ†• Nascondi spinner aggiornamento
function nascondiSpinnerAggiornamento() {
    const spinner = document.getElementById('updateSpinner');
    if (spinner) {
        spinner.style.display = 'none';
    }
}  

function toggleFabbisognoInfo(event) {
    event.stopPropagation();
    const tooltip = document.getElementById('fabbisognoInfoTooltip');
    tooltip.classList.toggle('show');
    
    // Chiudi cliccando fuori
    if (tooltip.classList.contains('show')) {
        setTimeout(() => {
            document.addEventListener('click', closeFabbisognoInfoOnClick);
        }, 10);
    }
}

function closeFabbisognoInfoOnClick(e) {
    const tooltip = document.getElementById('fabbisognoInfoTooltip');
    if (!tooltip.contains(e.target)) {
        tooltip.classList.remove('show');
        document.removeEventListener('click', closeFabbisognoInfoOnClick);
    }
}


// ========================================
// NUTRIFLOW PROFESSIONAL CALCULATOR
// Conversione completa da React a Vanilla JS
// Include: Steps, Canvas Chart, AI Tips, Results
// ========================================

(function() {
    'use strict';
    
    let currentStep = 0;
    const totalSteps = 10; // 0-10 = 11 steps (incluso step finale con risultati)
    let results = null;
    let aiTips = null;
    let isLoadingAi = false;
    
    const userData = {
        gender: 'Uomo',
        age: 28,
        weight: 75,
        height: 180,
        activityLevel: 'Moderato',
        activityMultiplier: 1.55,
        goal: 'Mantenimento',
        goalIntensity: 0,
        dietType: 'Bilanciata'
    };
    
    // Constants
    const Gender = { MALE: 'Uomo', FEMALE: 'Donna' };
    
    const ActivityLevel = {
        SEDENTARY: 'Sedentario',
        LIGHT: 'Leggero',
        MODERATE: 'Moderato',
        INTENSE: 'Intenso',
        ATHLETE: 'Atleta'
    };
    
    const ActivityMultipliers = {
        [ActivityLevel.SEDENTARY]: 1.2,
        [ActivityLevel.LIGHT]: 1.375,
        [ActivityLevel.MODERATE]: 1.55,
        [ActivityLevel.INTENSE]: 1.725,
        [ActivityLevel.ATHLETE]: 1.9
    };
    
    const Goal = {
        MAINTENANCE: 'Mantenimento',
        LOSE_WEIGHT: 'Perdere Peso',
        GAIN_MUSCLE: 'Massa Muscolare',
        HEALTH: 'Salute Generale',
        PERFORMANCE: 'Performance Sportiva'
    };
    
    const DietType = {
        BALANCED: 'Bilanciata',
        LOW_CARB: 'Low Carb',
        KETO: 'Chetogenica',
        HIGH_PROTEIN: 'Proteica',
        VEGAN: 'Vegana',
        MEDITERRANEAN: 'Mediterranea'
    };
    
    const DietMacroSplit = {
        [DietType.BALANCED]: { c: 0.50, p: 0.20, f: 0.30 },
        [DietType.LOW_CARB]: { c: 0.25, p: 0.35, f: 0.40 },
        [DietType.KETO]: { c: 0.05, p: 0.20, f: 0.75 },
        [DietType.HIGH_PROTEIN]: { c: 0.30, p: 0.45, f: 0.25 },
        [DietType.VEGAN]: { c: 0.55, p: 0.20, f: 0.25 },
        [DietType.MEDITERRANEAN]: { c: 0.45, p: 0.20, f: 0.35 }
    };
    
    const DietDescriptions = {
        [DietType.BALANCED]: "Bilanciata e flessibile, include tutti i gruppi alimentari in proporzioni moderate. Ideale per la salute a lungo termine e il benessere generale.",
        [DietType.LOW_CARB]: "Riduce l'apporto di carboidrati per favorire l'ossidazione dei grassi. Ottima per il controllo insulinico e la gestione del peso.",
        [DietType.KETO]: "Bassissimi carboidrati e grassi alti per indurre la chetosi. Trasforma i grassi nella fonte di energia principale del corpo.",
        [DietType.HIGH_PROTEIN]: "Enfasi sulle proteine per preservare la massa magra. Perfetta per chi si allena intensamente o desidera un maggior senso di sazietÃ .",
        [DietType.VEGAN]: "Basata su vegetali, legumi e cereali integrali. Esclude prodotti animali per un approccio etico, sostenibile e ricco di nutrienti.",
        [DietType.MEDITERRANEAN]: "Ricca di grassi sani, fibre e micronutrienti. Riconosciuta come eccellente per la longevitÃ , il cuore e la varietÃ  alimentare."
    };
    
    const Icons = {
    User: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`,
    Calendar: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`,
  Weight: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="3"></circle><path d="M6.5 8a2 2 0 0 0-1.905 1.46L2.1 18.5A2 2 0 0 0 4 21h16a2 2 0 0 0 1.925-2.54L19.4 9.5A2 2 0 0 0 17.48 8Z"></path></svg>`,
    Ruler: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.4 2.4 0 0 1 0-3.4l2.6-2.6a2.4 2.4 0 0 1 3.4 0z"></path><path d="m14.5 12.5 2-2"></path><path d="m11.5 9.5 2-2"></path><path d="m8.5 6.5 2-2"></path><path d="m17.5 15.5 2-2"></path></svg>`,
    Zap: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`,
    Info: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`,
    Target: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>`,
    Settings: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>`,
    Salad: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 21h10"></path><path d="M12 21a9 9 0 0 0 9-9H3a9 9 0 0 0 9 9Z"></path><path d="M11.38 12a2.4 2.4 0 0 1-.4-4.77 2.4 2.4 0 0 1 3.2-2.77 2.4 2.4 0 0 1 3.47-.63 2.4 2.4 0 0 1 3.37 3.37 2.4 2.4 0 0 1-1.1 3.7 2.51 2.51 0 0 1 .03 1.1"></path><path d="m13 12 4-4"></path><path d="M10.9 7.25A3.99 3.99 0 0 0 4 10c0 .73.2 1.41.54 2"></path></svg>`,
    ListChecks: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 17 2 2 4-4"></path><path d="m3 7 2 2 4-4"></path><path d="M13 6h8"></path><path d="M13 12h8"></path><path d="M13 18h8"></path></svg>`,
    ChartBar: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M18 17V9"></path><path d="M13 17V5"></path><path d="M8 17v-3"></path></svg>`,
    ChevronLeft: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>`,
    ChevronRight: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`,
    ArrowRight: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>`,
    Calculator: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="8" y1="10" x2="16" y2="10"></line><line x1="8" y1="14" x2="12" y2="14"></line></svg>`,
    Save: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>`,
    RefreshCcw: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"></path><path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path><path d="M3 22v-6h6"></path><path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path></svg>`,
    Sparkles: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>`,
    BrainCircuit: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 4.5a2.5 2.5 0 0 0-4.96-.46 2.5 2.5 0 0 0-1.98 3 2.5 2.5 0 0 0-1.32 4.24 3 3 0 0 0 .34 5.58 2.5 2.5 0 0 0 2.96 3.08 2.5 2.5 0 0 0 4.91.05L12 20V4.5Z"></path><path d="M16 8V5c0-1.1.9-2 2-2"></path><path d="M12 13h4"></path><path d="M12 18h6a2 2 0 0 1 2 2v1"></path><path d="M12 8h8"></path><path d="M20.5 8a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0Z"></path><path d="M16.5 13a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0Z"></path><path d="M20.5 21a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0Z"></path><path d="M18.5 3a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0Z"></path></svg>`,
    Sofa: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 9V6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v3"></path><path d="M2 11v5a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-5a2 2 0 0 0-4 0v2H6v-2a2 2 0 0 0-4 0Z"></path><path d="M4 18v2"></path><path d="M20 18v2"></path><path d="M12 4v9"></path></svg>`,
    Footprints: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 10 3.8 10 5.5c0 3.11-2 5.66-2 8.68V16a2 2 0 1 1-4 0Z"></path><path d="M20 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 6 14 7.8 14 9.5c0 3.11 2 5.66 2 8.68V20a2 2 0 1 0 4 0Z"></path></svg>`,
 Dumbbell: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.4 14.4 9.6 9.6"></path><path d="M18.657 21.485a2 2 0 1 1-2.829-2.828l-1.767 1.768a2 2 0 1 1-2.829-2.829l6.364-6.364a2 2 0 1 1 2.829 2.829l-1.768 1.767a2 2 0 1 1 2.828 2.829z"></path><path d="m21.5 21.5-1.4-1.4"></path><path d="M3.9 3.9 2.5 2.5"></path><path d="M6.404 12.768a2 2 0 1 1-2.829-2.829l1.768-1.767a2 2 0 1 1-2.828-2.829l2.828-2.828a2 2 0 1 1 2.829 2.828l1.767-1.768a2 2 0 1 1 2.829 2.829z"></path></svg>`,
    Flame: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path></svg>`,
    Trophy: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>`,
    Anchor: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="3"></circle><line x1="12" y1="22" x2="12" y2="8"></line><path d="M5 12H2a10 10 0 0 0 20 0h-3"></path></svg>`,
    TrendingDown: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></svg>`,
    Heart: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path></svg>`,
    FastForward: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 19 22 12 13 5 13 19"></polygon><polygon points="2 19 11 12 2 5 2 19"></polygon></svg>`,
    Apple: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20.94c1.5 0 2.75 1.06 4 1.06 3 0 6-8 6-12.22A4.91 4.91 0 0 0 17 5c-2.22 0-4 1.44-5 2-1-.56-2.78-2-5-2a4.9 4.9 0 0 0-5 4.78C2 14 5 22 8 22c1.25 0 2.5-1.06 4-1.06Z"></path><path d="M10 2c1 .5 2 2 2 5"></path></svg>`,
    Cloud: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"></path></svg>`,
    Beef: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12.5" cy="8.5" r="2.5"></circle><path d="M12.5 2a6.5 6.5 0 0 0-6.22 4.6c-1.1 3.13-.78 3.9-3.18 6.08A3 3 0 0 0 5 18c4 0 8.4-1.8 11.4-4.3A6.5 6.5 0 0 0 12.5 2Z"></path><path d="m18.5 6 2.19 4.5a6.48 6.48 0 0 1 .31 2 6.49 6.49 0 0 1-2.6 5.2C15.4 20.2 11 22 7 22a3 3 0 0 1-2.68-1.66L2.4 16.5"></path></svg>`,
    Leaf: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"></path><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"></path></svg>`,
    Fish: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6.5 12c.94-3.46 4.94-6 8.5-6 3.56 0 6.06 2.54 7 6-.94 3.47-3.44 6-7 6s-7.56-2.53-8.5-6Z"></path><path d="M18 12v.5"></path><path d="M16 17.93a9.77 9.77 0 0 1 0-11.86"></path><path d="M7 10.67C7 8 5.58 5.97 2.73 5.5c-1 1.5-1 5 .23 6.5-1.24 1.5-1.24 5-.23 6.5C5.58 18.03 7 16 7 13.33"></path><path d="M10.46 7.26C10.2 5.88 9.17 4.24 8 3h5.8a2 2 0 0 1 1.98 1.67l.23 1.4"></path><path d="m16.01 17.93-.23 1.4A2 2 0 0 1 13.8 21H9.5a5.96 5.96 0 0 0 1.49-3.98"></path></svg>`
};
    
    // Activity Icons
    const activityIconsMap = {
        [ActivityLevel.SEDENTARY]: Icons.Sofa,
        [ActivityLevel.LIGHT]: Icons.Footprints,
        [ActivityLevel.MODERATE]: Icons.Dumbbell,
        [ActivityLevel.INTENSE]: Icons.Flame,
        [ActivityLevel.ATHLETE]: Icons.Trophy
    };
    
    // Goal Icons
    const goalIconsMap = {
        [Goal.MAINTENANCE]: Icons.Anchor,
        [Goal.LOSE_WEIGHT]: Icons.TrendingDown,
        [Goal.GAIN_MUSCLE]: Icons.Dumbbell,
        [Goal.HEALTH]: Icons.Heart,
        [Goal.PERFORMANCE]: Icons.FastForward
    };
    
    // Diet Icons
    const dietIconsMap = {
        [DietType.BALANCED]: Icons.Apple,
        [DietType.LOW_CARB]: Icons.Cloud,
        [DietType.KETO]: Icons.Beef,
        [DietType.HIGH_PROTEIN]: Icons.Zap,
        [DietType.VEGAN]: Icons.Leaf,
        [DietType.MEDITERRANEAN]: Icons.Fish
    };

// Calculate Results
    function calculateResults() {
        let bmr = (10 * userData.weight) + (6.25 * userData.height) - (5 * userData.age);
        bmr = userData.gender === Gender.MALE ? bmr + 5 : bmr - 161;
        const tdee = Math.round(bmr * userData.activityMultiplier);
        const goalCalories = tdee + userData.goalIntensity;
        const split = DietMacroSplit[userData.dietType];
        const macros = {
            protein: Math.round((goalCalories * split.p) / 4),
            carbs: Math.round((goalCalories * split.c) / 4),
            fats: Math.round((goalCalories * split.f) / 9)
        };
        
        results = {
            bmr: Math.round(bmr),
            tdee: tdee,
            goalCalories: goalCalories,
            macros: macros
        };
        
        currentStep = 10; // Go to results step
        renderStep();
    }
    
    // Render Progress Bar
    function renderProgressBar() {
        const container = document.getElementById('progressBarNutriflow');
        if (!container) return;
        
        let html = '';
        for (let i = 0; i <= totalSteps; i++) {
            if (i === currentStep) {
                html += `<div style="height:4px;width:24px;background:#34d399;border-radius:999px;transition:all 0.3s;"></div>`;
            } else {
                html += `<div style="height:4px;width:6px;background:rgba(255,255,255,0.1);border-radius:999px;transition:all 0.3s;"></div>`;
            }
        }
        container.innerHTML = html;
    }
    
    // Render Step
    function renderStep() {
        const container = document.getElementById('stepContentNutriflow');
        if (!container) return;
        
        container.className = 'animate-slide-nutriflow';
        
        if (currentStep === 10) {
            // Results step
            renderResultsStep();
        } else {
            renderNormalStep();
        }
        
        renderNavigationButtons();
        renderProgressBar();
    }
    
    // Render Normal Step
    function renderNormalStep() {
        const container = document.getElementById('stepContentNutriflow');
        
        const stepTitles = [
            'Genere', 'EtÃ ', 'Peso Corporeo', 'Altezza',
            'Livello AttivitÃ ', 'Info AttivitÃ ', 'Obiettivo',
            'Dettagli Obiettivo', 'Stile Alimentare', 'Recap Scelte'
        ];
        
        const stepIconsSvg = [
            Icons.User, Icons.Calendar, Icons.Weight, Icons.Ruler,
            Icons.Zap, Icons.Info, Icons.Target, Icons.Settings,
            Icons.Salad, Icons.ListChecks
        ];
        
        let html = `
            <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:24px;text-align:center;">
                <div style="margin-bottom:12px;padding:12px;background:rgba(255,255,255,0.03);backdrop-filter:blur(30px);border:1px solid rgba(255,255,255,0.12);border-radius:16px;box-shadow:0 10px 15px -3px rgba(0,0,0,0.2),inset 0 1px 0 rgba(255,255,255,0.1);transform:scale(1.1);color:#34d399;width:48px;height:48px;display:flex;align-items:center;justify-content:center;">
                    ${stepIconsSvg[currentStep]}
                </div>
                <h2 style="font-size:18px;font-weight:900;color:white;letter-spacing:0.2em;text-transform:uppercase;margin:0;">${stepTitles[currentStep]}</h2>
                <div style="width:32px;height:2px;background:rgba(52,211,153,0.3);border-radius:999px;margin-top:8px;"></div>
            </div>
        `;
        
        switch(currentStep) {
            case 0: html += renderGenderStep(); break;
            case 1: html += renderAgeStep(); break;
            case 2: html += renderWeightStep(); break;
            case 3: html += renderHeightStep(); break;
            case 4: html += renderActivityStep(); break;
            case 5: html += renderActivityInfoStep(); break;
            case 6: html += renderGoalStep(); break;
            case 7: html += renderGoalDetailsStep(); break;
            case 8: html += renderDietStep(); break;
            case 9: html += renderRecapStep(); break;
        }
        
        container.innerHTML = html;
    }
    
    // Individual Step Renderers
    function renderGenderStep() {
        return `
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                ${[Gender.MALE, Gender.FEMALE].map(g => {
                    const isSelected = userData.gender === g;
                    return `
                        <button onclick="selectGender('${g}')" class="glass-card-nutriflow" style="padding:24px;border-radius:24px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:12px;${isSelected ? 'background:#34d399;color:white;box-shadow:0 6px 20px rgba(52,211,153,0.3);' : 'color:rgba(255,255,255,0.7);'}">
                            <div style="color:inherit;">${Icons.User}</div>
                            <span style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.15em;">${g}</span>
                        </button>
                    `;
                }).join('')}
            </div>
        `;
    }
    
function renderAgeStep() {
    console.log('renderAgeStep called');
    return `
        <div class="glass-card-nutriflow" style="padding:48px 24px;border-radius:32px;text-align:center;">
            <div style="display:flex;align-items:baseline;justify-content:center;gap:8px;">
                <input type="number" value="${userData.age}" oninput="updateAge(this.value)" class="input-nutriflow" style="width:auto !important;min-width:100px;text-align:center !important;font-size:80px !important;font-weight:900 !important;color:white !important;background:transparent !important;border:none !important;outline:none !important;font-family:inherit;padding:0 !important;line-height:1;font-variant-numeric:tabular-nums;">
                <span style="font-size:12px;font-weight:700;color:rgba(255,255,255,0.4);text-transform:uppercase;padding-bottom:10px;">Anni</span>
            </div>
        </div>
    `;
}

function renderWeightStep() {
    return `
        <div class="glass-card-nutriflow" style="padding:48px 24px;border-radius:32px;text-align:center;">
            <div style="display:flex;align-items:baseline;justify-content:center;gap:12px;">
                <input type="number" value="${userData.weight}" oninput="updateWeight(this.value)" class="input-nutriflow" style="width:auto !important;min-width:120px;text-align:center !important;font-size:80px !important;font-weight:900 !important;color:white !important;background:transparent !important;border:none !important;outline:none !important;font-family:inherit;padding:0 !important;line-height:1;font-variant-numeric:tabular-nums;">
                <span style="font-size:14px;font-weight:900;color:#34d399;text-transform:uppercase;padding-bottom:10px;">kg</span>
            </div>
        </div>
    `;
}

function renderHeightStep() {
    return `
        <div class="glass-card-nutriflow" style="padding:48px 24px;border-radius:32px;text-align:center;">
            <div style="display:flex;align-items:baseline;justify-content:center;gap:12px;">
                <input type="number" value="${userData.height}" oninput="updateHeight(this.value)" class="input-nutriflow" style="width:auto !important;min-width:120px;text-align:center !important;font-size:80px !important;font-weight:900 !important;color:white !important;background:transparent !important;border:none !important;outline:none !important;font-family:inherit;padding:0 !important;line-height:1;font-variant-numeric:tabular-nums;">
                <span style="font-size:14px;font-weight:900;color:#34d399;text-transform:uppercase;padding-bottom:10px;">cm</span>
            </div>
        </div>
    `;
}
    
    function renderActivityStep() {
        return `
            <div style="display:flex;flex-direction:column;gap:10px;">
                ${Object.values(ActivityLevel).map(level => {
                    const isSelected = userData.activityLevel === level;
                    const icon = activityIconsMap[level];
                    const multiplier = ActivityMultipliers[level];
                    return `
                        <button onclick="selectActivity('${level}')" class="glass-card-nutriflow" style="padding:16px;border-radius:20px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;${isSelected ? 'background:#34d399;color:white;box-shadow:0 4px 15px rgba(52,211,153,0.3);' : 'color:rgba(255,255,255,0.8);'}">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <div style="color:inherit;">${icon}</div>
                                <div style="text-align:left;">
                                    <div style="font-size:12px;font-weight:700;">${level}</div>
                                    <div style="font-size:10px;opacity:0.6;">Moltiplicatore: ${multiplier}</div>
                                </div>
                            </div>
                            ${Icons.ChevronRight}
                        </button>
                    `;
                }).join('')}
            </div>
        `;
    }
    
    function renderActivityInfoStep() {
        const multiplier = ActivityMultipliers[userData.activityLevel];
        return `
            <div class="glass-card-nutriflow" style="padding:24px;border-radius:32px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <span class="label-small-nutriflow">Scelta:</span>
                    <span style="font-size:12px;font-weight:700;color:#34d399;text-transform:uppercase;letter-spacing:0.1em;">${userData.activityLevel}</span>
                </div>
                <div style="padding:16px;background:rgba(255,255,255,0.05);border-radius:16px;border:1px solid rgba(255,255,255,0.05);">
                    <p style="font-size:11px;color:rgba(255,255,255,0.6);line-height:1.6;font-style:italic;margin:0;">
                        Hai selezionato uno stile di vita <span style="color:white;font-weight:700;">${userData.activityLevel}</span>. 
                        Questo moltiplica il tuo metabolismo basale per <span style="color:#34d399;font-weight:700;">${multiplier}</span>.
                        Un calcolo preciso del movimento quotidiano Ã¨ fondamentale per evitare stime errate delle calorie totali (TDEE).
                    </p>
                </div>
                <div style="margin-top:16px;text-align:center;">
                    <p style="font-size:9px;color:rgba(255,255,255,0.3);text-transform:uppercase;font-weight:900;letter-spacing:0.15em;margin:0;">Procedi per impostare l'obiettivo</p>
                </div>
            </div>
        `;
    }
    
    function renderGoalStep() {
        return `
            <div style="display:grid;grid-template-columns:1fr;gap:10px;">
                ${Object.values(Goal).map(goal => {
                    const isSelected = userData.goal === goal;
                    const icon = goalIconsMap[goal];
                    return `
                        <button onclick="selectGoal('${goal}')" class="glass-card-nutriflow" style="padding:20px;border-radius:20px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;text-align:left;${isSelected ? 'background:#34d399;color:white;box-shadow:0 4px 15px rgba(52,211,153,0.3);' : 'color:rgba(255,255,255,0.8);'}">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <div style="color:${isSelected ? 'white' : '#f43f5e'};">${icon}</div>
                                <span style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;">${goal}</span>
                            </div>
                        </button>
                    `;
                }).join('')}
            </div>
        `;
    }
    
    function renderGoalDetailsStep() {
        let options = [];
        
        if (userData.goal === Goal.LOSE_WEIGHT) {
            options = [
                { label: 'Deficit Leggero', val: -250, desc: 'Perdita di peso lenta e sostenibile' },
                { label: 'Deficit Standard', val: -500, desc: 'Il gold standard per il dimagrimento' },
                { label: 'Deficit Aggressivo', val: -750, desc: 'Perdita rapida (Richiede disciplina)' }
            ];
        } else if (userData.goal === Goal.GAIN_MUSCLE) {
            options = [
                { label: 'Lean Bulk', val: 200, desc: 'Minimo accumulo di grasso' },
                { label: 'Standard Bulk', val: 350, desc: 'Ottimale per la crescita muscolare' },
                { label: 'Power Bulk', val: 500, desc: 'Massima spinta anabolica' }
            ];
        } else if (userData.goal === Goal.PERFORMANCE) {
            options = [
                { label: 'Focus Endurance', val: 150, desc: 'Supporto per attivitÃ  aerobiche' },
                { label: 'Focus Forza', val: 250, desc: 'Massima potenza esplosiva' },
                { label: 'Ibrido Elite', val: 400, desc: 'Per atleti ad alto volume di lavoro' }
            ];
        }
        
        let html = `
            <div class="glass-card-nutriflow" style="padding:24px;border-radius:32px;">
                <div style="text-align:center;margin-bottom:24px;">
                    <span class="label-small-nutriflow" style="display:block;margin-bottom:8px;">Hai scelto:</span>
                    <span style="font-size:16px;font-weight:900;color:#f43f5e;text-transform:uppercase;letter-spacing:-0.05em;">${userData.goal}</span>
                </div>
        `;
        
        if (options.length > 0) {
            html += `
                <p style="font-size:10px;font-weight:900;text-transform:uppercase;letter-spacing:0.15em;color:rgba(255,255,255,0.4);text-align:center;margin-bottom:12px;">Personalizza l'intensitÃ :</p>
                <div style="display:grid;grid-template-columns:1fr;gap:8px;">
                    ${options.map(opt => {
                        const isSelected = userData.goalIntensity === opt.val;
                        return `
                            <button onclick="selectGoalIntensity(${opt.val})" style="padding:16px;border-radius:16px;text-align:left;transition:all 0.3s;border:${isSelected ? '1px solid #34d399' : '1px solid transparent'};background:${isSelected ? 'rgba(52,211,153,0.2)' : 'rgba(255,255,255,0.05)'};cursor:pointer;color:white;">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                                    <span style="font-size:10px;font-weight:900;text-transform:uppercase;">${opt.label}</span>
                                    <span style="font-size:10px;font-weight:700;color:#34d399;">${opt.val > 0 ? '+' : ''}${opt.val} kcal</span>
                                </div>
                                <p style="font-size:9px;color:rgba(255,255,255,0.4);margin:0;">${opt.desc}</p>
                            </button>
                        `;
                    }).join('')}
                </div>
            `;
        } else {
            html += `
                <div style="padding:16px;background:rgba(255,255,255,0.05);border-radius:16px;border:1px solid rgba(255,255,255,0.05);text-align:center;">
                    <p style="font-size:11px;color:rgba(255,255,255,0.6);font-style:italic;margin:0;">
                        Per l'obiettivo <span style="color:white;font-weight:700;">${userData.goal}</span> Ã¨ previsto un aggiustamento calorico standard di <span style="color:#34d399;font-weight:700;">${userData.goalIntensity} kcal</span> per mantenere l'equilibrio fisiologico.
                    </p>
                </div>
            `;
        }
        
        html += `</div>`;
        return html;
    }
    
    function renderDietStep() {
        return `
            <div style="display:flex;flex-direction:column;gap:12px;">
                ${Object.values(DietType).map(diet => {
                    const isSelected = userData.dietType === diet;
                    const icon = dietIconsMap[diet];
                    const desc = DietDescriptions[diet];
                    return `
                        <div>
                            <button onclick="selectDiet('${diet}')" class="glass-card-nutriflow" style="width:100%;padding:16px;border-radius:20px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;text-align:left;${isSelected ? 'background:#34d399;color:white;box-shadow:0 4px 15px rgba(52,211,153,0.3);' : 'color:rgba(255,255,255,0.8);'}">
                                <div style="display:flex;align-items:center;gap:12px;">
                                    <div style="color:inherit;">${icon}</div>
                                    <span style="font-size:12px;font-weight:700;letter-spacing:0.05em;">${diet}</span>
                                </div>
                                <div style="transition:transform 0.3s;transform:${isSelected ? 'rotate(90deg)' : 'rotate(0)'};opacity:${isSelected ? '1' : '0.3'};">
                                    ${Icons.ChevronRight}
                                </div>
                            </button>
                            ${isSelected ? `
                                <div style="padding:12px 20px 8px;animation:slideInNutriflow 0.3s ease;">
                                    <p style="font-size:10px;color:rgba(255,255,255,0.6);line-height:1.5;font-style:italic;font-weight:500;margin:0;">${desc}</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
    
    function renderRecapStep() {
        return `
            <div class="glass-card-nutriflow" style="padding:24px;border-radius:32px;">
                <p style="font-size:10px;font-weight:900;text-transform:uppercase;letter-spacing:0.15em;text-align:center;color:rgba(255,255,255,0.4);margin-bottom:16px;">Conferma i tuoi dati:</p>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    ${[
                        { label: 'Profilo', val: `${userData.gender}, ${userData.age} anni` },
                        { label: 'Fisico', val: `${userData.weight}kg x ${userData.height}cm` },
                        { label: 'AttivitÃ ', val: userData.activityLevel },
                        { label: 'Obiettivo', val: userData.goal },
                        { label: 'Alimentazione', val: userData.dietType }
                    ].map(item => `
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.05);">
                            <span style="font-size:9px;font-weight:700;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.15em;">${item.label}</span>
                            <span style="font-size:10px;font-weight:900;color:white;text-align:right;">${item.val}</span>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top:16px;padding:16px;background:rgba(52,211,153,0.1);border-radius:16px;border:1px solid rgba(52,211,153,0.2);text-align:center;">
                    <p style="font-size:11px;color:rgba(52,211,153,0.8);line-height:1.6;font-style:italic;margin:0;">
                        Tutto pronto per l'analisi professionale. Clicca su "Analizza" per generare il tuo piano calorico e i macro personalizzati.
                    </p>
                </div>
            </div>
        `;
    }

// Render Results Step with Canvas Chart
function renderResultsStep() {
    const container = document.getElementById('stepContentNutriflow');
    const header = document.getElementById('headerSection');
    
    // Hide header on results
    if (header) header.style.display = 'none';
    
    if (!results) return;
    
    const chartData = [
        { name: 'Proteine', value: results.macros.protein * 4, color: '#60a5fa', grams: results.macros.protein },
        { name: 'Carbs', value: results.macros.carbs * 4, color: '#34d399', grams: results.macros.carbs },
        { name: 'Grassi', value: results.macros.fats * 9, color: '#fbbf24', grams: results.macros.fats }
    ];
    
    let html = `
        <div style="text-align:center;margin-bottom:24px;">
            <div style="margin-bottom:12px;padding:12px;background:rgba(255,255,255,0.03);backdrop-filter:blur(30px);border:1px solid rgba(255,255,255,0.12);border-radius:16px;box-shadow:0 10px 15px -3px rgba(0,0,0,0.2),inset 0 1px 0 rgba(255,255,255,0.1);display:inline-flex;align-items:center;justify-content:center;color:#34d399;width:48px;height:48px;">
                ${Icons.ChartBar}
            </div>
            <h2 style="font-size:30px;font-weight:900;color:white;letter-spacing:0.2em;text-transform:uppercase;margin:0;">RIEPILOGO</h2>
            <div style="width:32px;height:2px;background:rgba(52,211,153,0.3);border-radius:999px;margin:12px auto 0;"></div>
        </div>
        
        <div style="display:flex;flex-direction:column;gap:20px;">
            <!-- Goal Calories Card -->
            <div class="glass-card-nutriflow" style="padding:32px;border-radius:32px;text-align:center;">
                <p class="label-small-nutriflow" style="margin-bottom:8px;">Target Giornaliero</p>
                <div style="font-size:56px;font-weight:900;color:white;font-variant-numeric:tabular-nums;">${results.goalCalories}</div>
                <p style="font-size:10px;font-weight:700;color:#34d399;margin-top:8px;text-transform:uppercase;letter-spacing:0.15em;">Kcal / Giorno</p>
            </div>
            
            <!-- Chart Card -->
            <div class="glass-card-nutriflow" style="padding:24px;border-radius:32px;">
                <div style="height:176px;width:100%;margin-bottom:16px;display:flex;align-items:center;justify-content:center;">
                    <canvas id="macroChart" width="200" height="200"></canvas>
                </div>
                <div style="display:grid;grid-template-columns:1fr;gap:8px;">
                    ${chartData.map(m => `
                        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.05);">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <div style="width:8px;height:8px;border-radius:50%;background:${m.color};"></div>
                                <span style="font-size:9px;font-weight:700;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:0.15em;">${m.name}</span>
                            </div>
                            <span style="font-weight:900;font-size:12px;color:white;">${m.grams}g</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <!-- AI Tips Card -->
            <div class="glass-card-nutriflow" style="padding:8px;border-radius:32px;overflow:hidden;">
                ${!aiTips ? `
                    <button onclick="generateAiAdvice()" ${isLoadingAi ? 'disabled' : ''} class="shimmer-nutriflow" style="width:100%;padding:24px 16px;border-radius:24px;background:linear-gradient(135deg,rgba(139,92,246,0.3) 0%,rgba(99,102,241,0.2) 50%,rgba(52,211,153,0.1) 100%);border:1px solid rgba(255,255,255,0.1);color:white;cursor:${isLoadingAi ? 'not-allowed' : 'pointer'};transition:all 0.3s;display:flex;flex-direction:column;align-items:center;gap:12px;opacity:${isLoadingAi ? '0.7' : '1'};${isLoadingAi ? '' : 'position:relative;overflow:hidden;'}">
                        <div style="padding:12px;background:rgba(255,255,255,0.05);border-radius:16px;box-shadow:inset 0 1px 1px rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.05);">
                            <div style="width:24px;height:24px;color:#a78bfa;display:flex;align-items:center;justify-content:center;${isLoadingAi ? 'animation: spin-nutriflow 1s linear infinite;' : ''}">${isLoadingAi ? Icons.RefreshCcw : Icons.BrainCircuit}</div>
                        </div>
                        <div style="text-align:center;">
                            <span style="display:block;font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:0.2em;color:rgba(255,255,255,0.9);">${isLoadingAi ? 'Generando...' : 'Genera Consigli AI'}</span>
                            <span style="display:block;font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:0.15em;color:rgba(255,255,255,0.4);margin-top:4px;">Powered by Gemini</span>
                        </div>
                    </button>
                ` : `
                    <div style="padding:24px;animation:slideInNutriflow 0.6s ease;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
                            <div style="color:#a78bfa;">${Icons.Sparkles}</div>
                            <span class="label-small-nutriflow">AI Feedback</span>
                        </div>
                        <p style="font-size:11px;color:rgba(255,255,255,0.8);line-height:1.6;font-style:italic;text-align:center;font-weight:500;margin:0;">${aiTips}</p>
                        <button onmouseover="this.querySelector('div').style.animation='spin-nutriflow 1s linear infinite'" onmouseout="this.querySelector('div').style.animation=''" onclick="resetAiTips()" style="margin-top:24px;width:100%;font-size:9px;color:rgba(255,255,255,0.3);text-transform:uppercase;font-weight:700;letter-spacing:0.15em;background:transparent;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;padding:8px;transition:color 0.3s;">
                            <div style="width:12px;height:12px;transition:all 0.3s;">${Icons.RefreshCcw}</div>
                            <span>Rigenera Analisi</span>
                        </button>
                    </div>
                `}
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // Draw chart with animation after render
    setTimeout(() => drawMacroChart(chartData), 100);
}
    
    // Draw Macro Chart (Canvas)
   function drawMacroChart(data) {
    const canvas = document.getElementById('macroChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const outerRadius = 75;
    const innerRadius = 50;
    const paddingAngle = 29; // ðŸ†• Aumentato a 12 gradi per piÃ¹ spazio
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const total = data.reduce((sum, item) => sum + item.value, 0);
    
    // Animation
    let progress = 0;
    const duration = 2000; // ðŸ†• Animazione SUPER LENTA (2 secondi)
    const startTime = Date.now();
    
    function drawRoundedSegment(startAngle, endAngle, color) {
        const avgRadius = (outerRadius + innerRadius) / 2;
        const thickness = outerRadius - innerRadius;
        
        ctx.save();
        ctx.strokeStyle = color;
        ctx.lineWidth = thickness;
        ctx.lineCap = 'round';
        
        ctx.beginPath();
        ctx.arc(centerX, centerY, avgRadius, startAngle, endAngle);
        ctx.stroke();
        
        ctx.restore();
    }
    
    function animate() {
        const elapsed = Date.now() - startTime;
        progress = Math.min(elapsed / duration, 1);
        
        // Easing piÃ¹ morbido
        const eased = 1 - Math.pow(1 - progress, 3);
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        let currentAngle = -Math.PI / 2;
        const paddingRad = (paddingAngle * Math.PI) / 180;
        
        data.forEach((item) => {
            const sliceAngle = (item.value / total) * 2 * Math.PI * eased;
            
            const startAngle = currentAngle + paddingRad / 2;
            const endAngle = currentAngle + sliceAngle - paddingRad / 2;
            
            drawRoundedSegment(startAngle, endAngle, item.color);
            
            currentAngle += sliceAngle;
        });
        
        if (progress < 1) {
            requestAnimationFrame(animate);
        }
    }
    
    animate();
}
    
   // Generate AI Advice
window.generateAiAdvice = async function() {
    if (!results || isLoadingAi) return;
    
    isLoadingAi = true;
    
    // ðŸ†• Aggiorna SOLO il bottone AI, NON tutto lo step
    const aiCard = document.querySelector('.glass-card-nutriflow:last-child');
    if (aiCard) {
        aiCard.innerHTML = `
            <button disabled class="shimmer-nutriflow" style="width:100%;padding:24px 16px;border-radius:28px;background:linear-gradient(to bottom right, rgba(147,51,234,0.3) 0%, rgba(99,102,241,0.2) 50%, rgba(52,211,153,0.1) 100%);border:1px solid rgba(255,255,255,0.1);color:white;cursor:not-allowed;transition:all 0.3s;display:flex;flex-direction:column;align-items:center;gap:12px;opacity:0.7;position:relative;overflow:hidden;">
                <div style="padding:12px;background:rgba(255,255,255,0.05);border-radius:16px;box-shadow:inset 0 1px 1px rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.05);margin-bottom:4px;">
                    <div style="width:24px;height:24px;color:#c084fc;display:flex;align-items:center;justify-content:center;animation: spin-nutriflow 1s linear infinite;">${Icons.RefreshCcw}</div>
                </div>
                <div style="text-align:center;">
                    <span style="display:block;font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:0.2em;color:rgba(255,255,255,0.9);">Generando...</span>
                    <span style="display:block;font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:0.15em;color:rgba(255,255,255,0.4);margin-top:2px;">Powered by Gemini</span>
                </div>
            </button>
        `;
    }
    
    // Simulate AI call
    try {
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        aiTips = `Per il tuo obiettivo di ${userData.goal.toLowerCase()} con ${results.goalCalories} kcal al giorno, concentrati su cibi integrali e non processati. Mantieni un'idratazione costante (2-3L/giorno) e assicurati di dormire 7-9 ore per ottimizzare il recupero e i risultati.`;
        
        isLoadingAi = false;
        
        // ðŸ†• Aggiorna SOLO la card AI con i risultati
        if (aiCard) {
            aiCard.innerHTML = `
                <div style="padding:24px;animation:slideInNutriflow 0.6s ease;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
                        <div style="color:#a78bfa;">${Icons.Sparkles}</div>
                        <span class="label-small-nutriflow">AI Feedback</span>
                    </div>
                    <p style="font-size:11px;color:rgba(255,255,255,0.8);line-height:1.6;font-style:italic;text-align:center;font-weight:500;margin:0;">${aiTips}</p>
                    <button onmouseover="this.querySelector('div').style.animation='spin-nutriflow 1s linear infinite'" onmouseout="this.querySelector('div').style.animation=''" onclick="resetAiTips()" style="margin-top:24px;width:100%;font-size:9px;color:rgba(255,255,255,0.3);text-transform:uppercase;font-weight:700;letter-spacing:0.15em;background:transparent;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;padding:8px;transition:color 0.3s;">
                        <div style="width:12px;height:12px;transition:all 0.3s;">${Icons.RefreshCcw}</div>
                        <span>Rigenera Analisi</span>
                    </button>
                </div>
            `;
        }
    } catch (e) {
        aiTips = "Consiglio Rapido: Focalizzati su cibi integrali, mantieni un'idratazione costante e assicurati di dormire bene!";
        isLoadingAi = false;
        if (aiCard) {
            aiCard.innerHTML = `<div style="padding:24px;"><p style="font-size:11px;color:rgba(255,255,255,0.8);text-align:center;">${aiTips}</p></div>`;
        }
    }
};
    
   window.resetAiTips = function() {
    aiTips = null;
    isLoadingAi = false;
    
    // ðŸ†• Aggiorna SOLO la card AI
    const aiCard = document.querySelector('.glass-card-nutriflow:last-child');
    if (aiCard) {
        aiCard.innerHTML = `
            <button onclick="generateAiAdvice()" class="shimmer-nutriflow" style="width:100%;padding:24px 16px;border-radius:28px;background:linear-gradient(to bottom right, rgba(147,51,234,0.3) 0%, rgba(99,102,241,0.2) 50%, rgba(52,211,153,0.1) 100%);border:1px solid rgba(255,255,255,0.1);color:white;cursor:pointer;transition:all 0.3s;display:flex;flex-direction:column;align-items:center;gap:12px;position:relative;overflow:hidden;">
                <div style="padding:12px;background:rgba(255,255,255,0.05);border-radius:16px;box-shadow:inset 0 1px 1px rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.05);margin-bottom:4px;">
                    <div style="width:24px;height:24px;color:#c084fc;display:flex;align-items:center;justify-content:center;transition:color 0.3s;">${Icons.BrainCircuit}</div>
                </div>
                <div style="text-align:center;">
                    <span style="display:block;font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:0.2em;color:rgba(255,255,255,0.9);">Genera Consigli AI</span>
                    <span style="display:block;font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:0.15em;color:rgba(255,255,255,0.4);margin-top:2px;">Powered by Gemini</span>
                </div>
            </button>
        `;
    }
};
    
    // Navigation Buttons
    function renderNavigationButtons() {
        const container = document.getElementById('navButtonsNutriflow');
        if (!container) return;
        
        let html = '';
        
        // Back button
        if (currentStep > 0 && currentStep < 10) {
            html += `
                <button onclick="previousStep()" class="glass-card-nutriflow" style="width:48px;height:48px;padding:0;border-radius:16px;cursor:pointer;color:rgba(255,255,255,0.5);display:flex;align-items:center;justify-content:center;transition:all 0.3s;">
                    ${Icons.ChevronLeft}
                </button>
            `;
        }
        
        // Next/Calculate button
        if (currentStep < 9) {
            html += `
                <button onclick="nextStep()" style="flex:1;padding:16px 24px;border-radius:16px;background:linear-gradient(135deg,#34d399,#059669);color:white;border:none;cursor:pointer;font-size:14px;font-weight:700;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 6px 20px rgba(52,211,153,0.3);transition:all 0.3s;text-transform:uppercase;letter-spacing:0.1em;">
                    <span>Avanti</span>
                    ${Icons.ArrowRight}
                </button>
            `;
        } else if (currentStep === 9) {
            html += `
                <button onclick="calculateAndShowResults()" style="flex:1;padding:16px 24px;border-radius:16px;background:linear-gradient(135deg,#3b82f6,#34d399);color:white;border:none;cursor:pointer;font-size:14px;font-weight:700;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 6px 20px rgba(52,211,153,0.3);transition:all 0.3s;text-transform:uppercase;letter-spacing:0.1em;">
                    ${Icons.Calculator}
                    <span>Analizza</span>
                </button>
            `;
        } else if (currentStep === 10) {
    html += `
        <div style="display:flex;flex-direction:column;width:100%;gap:12px;">
            <button onclick="saveReport()" style="width:100%;padding:16px 24px;border-radius:16px;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;cursor:pointer;font-size:14px;font-weight:700;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 6px 20px rgba(16,185,129,0.3);text-transform:uppercase;letter-spacing:0.1em;transition:all 0.3s;">
                ${Icons.Save}
                <span>Salva Report</span>
            </button>
            <button onmouseover="this.querySelector('div').style.animation='spin-nutriflow 1s linear infinite'" onmouseout="this.querySelector('div').style.animation=''" onclick="resetCalculator()" class="glass-card-nutriflow" style="width:100%;padding:12px;color:rgba(255,255,255,0.4);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.15em;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all 0.3s;border:none;">
    <div style="width:14px;height:14px;transition:all 0.3s;">${Icons.RefreshCcw}</div>
    <span>Ricomincia Test</span>
</button>
        </div>
    `;
}
        
        container.innerHTML = html;
    }
    
    // Navigation Functions
    window.nextStep = function() {
        if (currentStep < 9) {
            currentStep++;
            renderStep();
        }
    };
    
    window.previousStep = function() {
        if (currentStep > 0) {
            currentStep--;
            renderStep();
        }
    };
    
    window.calculateAndShowResults = function() {
    // Calculate BMR and macros
    let bmr = (10 * userData.weight) + (6.25 * userData.height) - (5 * userData.age);
    bmr = userData.gender === Gender.MALE ? bmr + 5 : bmr - 161;
    const tdee = Math.round(bmr * userData.activityMultiplier);
    const goalCalories = tdee + userData.goalIntensity;
    const split = DietMacroSplit[userData.dietType];
    const macros = {
        protein: Math.round((goalCalories * split.p) / 4),
        carbs: Math.round((goalCalories * split.c) / 4),
        fats: Math.round((goalCalories * split.f) / 9)
    };
    
    results = {
        bmr: Math.round(bmr),
        tdee: tdee,
        goalCalories: goalCalories,
        macros: macros
    };
    
    // Move to results step
    currentStep = 10;
    renderStep();
};
    
    // Data Update Functions
    window.selectGender = function(gender) {
        userData.gender = gender;
        renderStep();
    };
    
    window.updateAge = function(age) {
        userData.age = parseInt(age) || 18;
    };
    
    window.updateWeight = function(weight) {
        userData.weight = parseFloat(weight) || 50;
    };
    
    window.updateHeight = function(height) {
        userData.height = parseFloat(height) || 150;
    };
    
    window.selectActivity = function(level) {
        userData.activityLevel = level;
        userData.activityMultiplier = ActivityMultipliers[level];
        renderStep();
    };
    
    window.selectGoal = function(goal) {
        userData.goal = goal;
        
        // Set default intensity
        if (goal === Goal.LOSE_WEIGHT) userData.goalIntensity = -500;
        else if (goal === Goal.GAIN_MUSCLE) userData.goalIntensity = 350;
        else if (goal === Goal.PERFORMANCE) userData.goalIntensity = 200;
        else if (goal === Goal.HEALTH) userData.goalIntensity = -100;
        else userData.goalIntensity = 0;
        
        renderStep();
    };
    
    window.selectGoalIntensity = function(intensity) {
        userData.goalIntensity = intensity;
        renderStep();
    };
    
    window.selectDiet = function(diet) {
        userData.dietType = diet;
        renderStep();
    };
    
// Save Report
window.saveReport = function() {
    if (!results) return;
    
    // Map to original format for existing functions
    const sexo = userData.gender === Gender.MALE ? 'uomo' : 'donna';
    const attivita = userData.activityMultiplier;
    const obiettivo = userData.goalIntensity;
    
    const dietMap = {
        [DietType.BALANCED]: 'bilanciata',
        [DietType.LOW_CARB]: 'lowcarb',
        [DietType.KETO]: 'chetogenica',
        [DietType.HIGH_PROTEIN]: 'ipertrofica',
        [DietType.VEGAN]: 'mediterranea',
        [DietType.MEDITERRANEAN]: 'mediterranea'
    };
    
    // Populate hidden fields
    document.getElementById('sesso').value = sexo;
    document.getElementById('eta').value = userData.age;
    document.getElementById('pesoF').value = userData.weight;
    document.getElementById('altezza').value = userData.height;
    document.getElementById('attivita').value = attivita;
    document.getElementById('obiettivo').value = obiettivo;
    document.getElementById('tipoDieta').value = dietMap[userData.dietType] || 'bilanciata';
    
    // Show feedback on button
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        <span>âœ“ Salvato!</span>
    `;
    btn.style.background = '#10b981';
    btn.disabled = true;
    
  // Call existing save function if it exists
    if (typeof saveFabbisogno === 'function') {
        if (typeof calcolaFabbisogno === 'function') {
            calcolaFabbisogno();
        }
        setTimeout(() => {
            saveFabbisogno();
        }, 300);
    }
    
    // Chiude lo slide
    setTimeout(() => {
        if (typeof closeFabbisognoSlide === 'function') {
            closeFabbisognoSlide();
        }
        
        // ðŸ†• MOSTRA SPINNER
        setTimeout(() => {
            if (typeof mostraSpinnerAggiornamento === 'function') {
                mostraSpinnerAggiornamento();
            }
            
            console.log('ðŸ”„ Aggiornamento widget progressi...');
            
            // Ricarica dati
            if (typeof window.loadAllData === 'function') {
                window.loadAllData();
            }
            
            // Aspetta caricamento
            setTimeout(() => {
                
                // Ricalcola valori
                if (typeof window.calcolaConfrontoCalorie === 'function') {
                    window.calcolaConfrontoCalorie();
                }
                if (typeof window.mostraDietaInfo === 'function') {
                    window.mostraDietaInfo();
                }
                
                // Aspetta ricalcolo
                setTimeout(() => {
                    
                    // Aggiorna widget
                    if (typeof updateDonutChart === 'function') {
                        updateDonutChart();
                        console.log('âœ… Widget donut aggiornato!');
                    }
                    
                    // Anima barre
                    if (typeof animateMacroBars === 'function') {
                        animateMacroBars();
                    }
                    
                    // ðŸ†• NASCONDI SPINNER
                    setTimeout(() => {
                        if (typeof nascondiSpinnerAggiornamento === 'function') {
                            nascondiSpinnerAggiornamento();
                        }
                        console.log('âœ… Aggiornamento completato!');
                    }, 300);
                    
                }, 300);
                
            }, 1500);
        }, 400);
    }, 800);
};
    
  window.closeFabbisognoSlide = function() {
    const slide = document.getElementById('fabbisogno-slide');
    const overlay = document.getElementById('fabbisogno-overlay');
    const bg = document.getElementById('paintSplatterBg');
    const closeBtn = document.getElementById('closeFabbisognoBtn');
    
    if (slide) {
        slide.style.right = '-100%';
        document.body.style.overflow = '';
    }
    if (overlay) {
        overlay.style.opacity = '0';
        overlay.style.visibility = 'hidden';
    }
    if (bg) {
        bg.style.display = 'none';
    }
    if (closeBtn) {
        closeBtn.style.display = 'none';
    }
    
    // ðŸ†• Forza ricaricamento dati dopo 500ms
    setTimeout(() => {
        if (typeof window.loadAllData === 'function') {
            window.loadAllData();
        }
    }, 500);
};
  
    // Reset Calculator
    window.resetCalculator = function() {
        currentStep = 0;
        results = null;
        aiTips = null;
        isLoadingAi = false;
        
        // Reset to defaults
        userData.gender = Gender.MALE;
        userData.age = 28;
        userData.weight = 75;
        userData.height = 180;
        userData.activityLevel = ActivityLevel.MODERATE;
        userData.activityMultiplier = 1.55;
        userData.goal = Goal.MAINTENANCE;
        userData.goalIntensity = 0;
        userData.dietType = DietType.BALANCED;
        
        // Show header again
        const header = document.getElementById('headerSection');
        if (header) header.style.display = 'block';
        
        renderStep();
    };
    
    // Override open function
    const originalOpen = window.openFabbisognoSlide;
    window.openFabbisognoSlide = function() {
      // ðŸ†• Aggiorna valore memorizzato quando apri slide
    if (typeof fermaMonitoraggio === 'function') {
        fermaMonitoraggio();
    }
    if (typeof getValoreProgressoAttuale === 'function') {
        valoreProgressoMemorizzato = getValoreProgressoAttuale();
        console.log('ðŸ”„ Valore aggiornato all\'apertura slide:', valoreProgressoMemorizzato);
    }
    const slide = document.getElementById('fabbisogno-slide');
    const overlay = document.getElementById('fabbisogno-overlay');
    const bg = document.getElementById('paintSplatterBg');
    const closeBtn = document.getElementById('closeFabbisognoBtn'); // ðŸ†•
    
    if (slide) {
        slide.style.right = '0';
        document.body.style.overflow = 'hidden';
    }
    if (overlay) {
        overlay.style.opacity = '1';
        overlay.style.visibility = 'visible';
    }
    if (bg) {
        bg.style.display = 'block';
    }
    if (closeBtn) { // ðŸ†• MOSTRA IL BOTTONE
        closeBtn.style.display = 'flex';
    }
    
    // Reset and render
    currentStep = 0;
    results = null;
    aiTips = null;
    const header = document.getElementById('headerSection');
    if (header) header.style.display = 'block';
    renderStep();
};
    
    // Override close function
 window.closeFabbisognoSlide = function() {
    const slide = document.getElementById('fabbisogno-slide');
    const overlay = document.getElementById('fabbisogno-overlay');
    const bg = document.getElementById('paintSplatterBg');
    const closeBtn = document.getElementById('closeFabbisognoBtn'); // ðŸ†•
    
    if (slide) {
        slide.style.right = '-100%';
        document.body.style.overflow = '';
    }
    if (overlay) {
        overlay.style.opacity = '0';
        overlay.style.visibility = 'hidden';
    }
    if (bg) {
        bg.style.display = 'none';
    }
    if (closeBtn) { // ðŸ†• NASCONDI IL BOTTONE
        closeBtn.style.display = 'none';
    }
};
})();

// Dati
const sections = { body: true, macros: false, metabolic: true };
let timeRange = '30d';
let pesoChart = null;
let pieChart = null;

document.addEventListener('DOMContentLoaded', () => {
    renderMacros();
    renderMicros();
    // NON inizializzare i grafici qui - si faranno quando si apre la modal
});

async function generateWeightData(range) {
    const days = range === '7d' ? 7 : range === '30d' ? 30 : 90;
    const pesoData = await calcolaPesoAutomatico();
    
    if (!pesoData || pesoData.length === 0) {
        const pesoBase = (window.userNeeds && window.userNeeds.peso) ? window.userNeeds.peso : 75;
        return Array.from({ length: days }, (_, i) => ({
            giorno: i + 1,
            peso: pesoBase
        }));
    }
    
    const ultimiGiorni = pesoData.slice(-days);
    
    return ultimiGiorni.map((p, i) => ({
        giorno: i + 1,
        peso: p.peso,
        data: p.data,
        kcalMangiate: p.kcalMangiate,
        differenza: p.differenza
    }));
}

let isFirstLoad = true;

async function initPesoChart() {
    const canvas = document.getElementById('pesoChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    
    const data = await generateWeightData(timeRange);
    
    if (pesoChart) {
        pesoChart.destroy();
        pesoChart = null;
    }
    
    if (data.length === 0) {
        document.getElementById('variazioneDisplay').textContent = '0 kg';
        return;
    }
    
    const gradient = ctx.createLinearGradient(0, 0, 0, 200);
    gradient.addColorStop(0, 'rgba(46, 125, 50, 0.35)');
    gradient.addColorStop(1, 'rgba(46, 125, 50, 0)');
    
    const minVal = Math.min(...data.map(d => d.peso));
    const maxVal = Math.max(...data.map(d => d.peso));
    
    const dataPoints = data.length;
    const delayPerPoint = dataPoints <= 7 ? 80 : dataPoints <= 30 ? 30 : 15;
    
    const animationConfig = isFirstLoad ? {
        x: {
            type: 'number',
            easing: 'easeInOutCubic',
            duration: 1200,
            from: NaN,
            delay(ctx) {
                if (ctx.type !== 'data' || ctx.xStarted) return 0;
                ctx.xStarted = true;
                return ctx.index * delayPerPoint;
            }
        },
        y: {
            type: 'number',
            easing: 'easeInOutCubic',
            duration: 1200,
            from: (ctx) => {
                if (ctx.type === 'data') {
                    return ctx.chart.scales.y.getPixelForValue(ctx.chart.scales.y.min);
                }
            },
            delay(ctx) {
                if (ctx.type !== 'data' || ctx.yStarted) return 0;
                ctx.yStarted = true;
                return ctx.index * delayPerPoint;
            }
        }
    } : {
        x: {
            type: 'number',
            easing: 'easeInOutQuart',
            duration: 800,
            from: (ctx) => {
                if (ctx.type === 'data') {
                    return ctx.chart.scales.x.getPixelForValue(0);
                }
            }
        },
        y: {
            type: 'number',
            easing: 'easeInOutQuart',
            duration: 800
        }
    };
    
    pesoChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => d.giorno),
            datasets: [{
                data: data.map(d => d.peso),
                borderColor: '#2e7d32',
                borderWidth: 4,
                fill: true,
                backgroundColor: gradient,
                tension: 0.4,
                pointRadius: 2,
                pointBackgroundColor: '#2e7d32',
                pointBorderWidth: 0,
                pointHoverRadius: 7,
                pointHoverBackgroundColor: '#2e7d32',
                pointHoverBorderWidth: 3,
                pointHoverBorderColor: 'white'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animations: animationConfig,
            transitions: {
                active: {
                    animation: {
                        duration: 400,
                        easing: 'easeInOutCubic'
                    }
                }
            },
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(255,255,255,0.98)',
                    titleColor: '#051410',
                    bodyColor: '#051410',
                    titleFont: { weight: '600', size: 11 },
                    bodyFont: { weight: '700', size: 14 },
                    borderColor: 'rgba(0,0,0,0.08)',
                    borderWidth: 1,
                    cornerRadius: 12,
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        title: (ctx) => `Giorno ${ctx[0].label}`,
                        label: (ctx) => {
                            const point = data[ctx.dataIndex];
                            let label = `${ctx.parsed.y.toFixed(1)} kg`;
                            if (point && point.kcalMangiate !== undefined) {
                                label += ` (${Math.round(point.kcalMangiate)} kcal)`;
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { 
                        font: { size: 9, weight: '500' }, 
                        color: 'rgba(0,0,0,0.35)',
                        maxTicksLimit: 12
                    },
                    border: { display: false }
                },
                y: {
                    position: 'left',
                    title: {
                        display: true,
                        text: 'kg',
                        color: '#64748b',
                        font: {
                            size: 10,
                            weight: '700',
                            family: "'Inter', -apple-system, sans-serif"
                        },
                        padding: { bottom: 8 }
                    },
                    grid: {
                        display: true,
                        color: 'rgba(148, 163, 184, 0.12)',
                        lineWidth: 1,
                        drawBorder: false
                    },
                    ticks: { 
                        font: { size: 9, weight: '500' }, 
                        color: 'rgba(0,0,0,0.35)',
                        padding: 8
                    },
                    min: minVal - 0.5,
                    max: maxVal + 0.5
                }
            }
        }
    });
    
    const pesoInizio = data[0].peso;
    const pesoFine = data[data.length - 1].peso;
    const variazione = (pesoFine - pesoInizio).toFixed(1);
    const segno = variazione > 0 ? '+' : '';
    document.getElementById('variazioneDisplay').textContent = `${segno}${variazione} kg`;
    
    const pesoDisplay = document.getElementById('pesoDisplay');
    if (pesoDisplay) {
        pesoDisplay.innerHTML = `${pesoFine.toFixed(1)} <span>kg</span>`;
    }
}

async function setTimeRange(range) {
    isFirstLoad = false;
    
    const canvas = document.getElementById('pesoChart');
    const variazione = document.getElementById('variazioneDisplay');
    
    canvas.style.transition = 'opacity 0.25s ease';
    variazione.style.transition = 'opacity 0.25s ease';
    canvas.style.opacity = '0';
    variazione.style.opacity = '0';
    
    timeRange = range;
    document.querySelectorAll('.time-toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.range === range);
    });
    
    setTimeout(async () => {
        await initPesoChart();
        
        setTimeout(() => {
            canvas.style.opacity = '1';
            variazione.style.opacity = '1';
        }, 50);
    }, 250);
}

// PIE CHART CON ANIMAZIONE
async function initPieChart() {
    const ctx = document.getElementById('pieChart');
    if (!ctx) return;
    
    if (pieChart) pieChart.destroy();
    
    // Calcola il peso attuale dal sistema automatico
    let pesoAttuale = null;
    const pesoData = await calcolaPesoAutomatico();
    if (pesoData && pesoData.length > 0) {
        pesoAttuale = pesoData[pesoData.length - 1].peso;
    }
    
    const bodyData = getBodyCompData(pesoAttuale);
    
    pieChart = new Chart(ctx.getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: bodyData.map(d => d.name),
            datasets: [{
                data: bodyData.map(d => d.value),
                backgroundColor: bodyData.map(d => d.color),
                borderWidth: 0,
                spacing: 6,
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            animation: {
                animateRotate: true,
                animateScale: true,
                duration: 1500,
                easing: 'easeInOutQuart'
            },
            plugins: { 
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(255,255,255,0.98)',
                    titleColor: '#051410',
                    bodyColor: '#051410',
                    titleFont: { weight: '700', size: 12 },
                    bodyFont: { weight: '600', size: 14 },
                    borderColor: 'rgba(0,0,0,0.08)',
                    borderWidth: 1,
                    cornerRadius: 12,
                    padding: 12,
                    displayColors: true,
                    callbacks: {
                        label: (ctx) => ` ${ctx.label}: ${ctx.parsed}%`
                    }
                }
            }
        }
    });
    
    // Aggiorna legenda
    const legendItems = document.querySelectorAll('.legend-item');
    if (legendItems.length >= 3) {
        bodyData.forEach((d, i) => {
            const valueEl = legendItems[i]?.querySelector('.legend-value');
            if (valueEl) valueEl.textContent = `${d.value}%`;
        });
    }
}
  
function toggleSection(name) {
    sections[name] = !sections[name];
    
    const content = document.getElementById(`${name}Content`);
    const chevron = document.getElementById(`${name}Chevron`);
    const section = document.getElementById(`${name}Section`);
    
    if (sections[name]) {
        content.classList.add('open');
        chevron.classList.add('active');
        section.classList.remove('nature-card-closed');
        if (name === 'macros') document.getElementById('infoBtn').classList.remove('hidden');
        if (name === 'metabolic') document.getElementById('metabolicInfoBtn').classList.remove('hidden');
    } else {
        content.classList.remove('open');
        chevron.classList.remove('active');
        section.classList.add('nature-card-closed');
        if (name === 'macros') {
            document.getElementById('infoBtn').classList.add('hidden');
            document.getElementById('nutriTooltip').classList.remove('show');
        }
        if (name === 'metabolic') {
            document.getElementById('metabolicInfoBtn').classList.add('hidden');
            document.getElementById('metabolicTooltip').classList.remove('show');
        }
    }
}

function toggleTooltip(e) {
    e.stopPropagation();
    document.getElementById('nutriTooltip').classList.toggle('show');
}
document.addEventListener('click', (e) => {
    if (!e.target.closest('.info-container')) {
        document.getElementById('nutriTooltip').classList.remove('show');
    }
});

function toggleMetabolicTooltip(event) {
    event.stopPropagation();
    const tooltip = document.getElementById('metabolicTooltip');
    if (tooltip) {
        tooltip.classList.toggle('show');
    }
}

// Chiudi tooltip metabolico quando clicchi fuori
document.addEventListener('click', (e) => {
    if (!e.target.closest('#metabolicInfoBtn') && !e.target.closest('#metabolicTooltip')) {
        const tooltip = document.getElementById('metabolicTooltip');
        if (tooltip) tooltip.classList.remove('show');
    }
});

function closeAnalisiSalute() {
    const modal = document.querySelector('.analisi-salute-wrapper');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }
    
    // Chiudi anche overlay IA se aperto
    const aiOverlay = document.getElementById('aiPanelOverlay');
    if (aiOverlay) {
        aiOverlay.classList.remove('show');
    }
    
    // Reset bottone consulto
    const btnConsulto = document.getElementById('btnConsulto');
    if (btnConsulto) {
        btnConsulto.style.display = 'inline-flex';
    }
    
    // Reset bottone accurate
    const btnAccurate = document.getElementById('btnAccurate');
    if (btnAccurate) {
        btnAccurate.disabled = false;
        btnAccurate.innerHTML = '<i class="fa-solid fa-chart-line"></i> Genera un consiglio piÃ¹ accurato';
        btnAccurate.style.display = 'flex';
    }
    
    // Nascondi sezione accurate
    const accSection = document.getElementById('accurateAdviceSection');
    if (accSection) {
        accSection.style.display = 'none';
    }
}

function renderMacros() {
    const macrosData = getMacrosData();
    document.getElementById('macrosList').innerHTML = macrosData.map(m => `
        <div>
            <div class="macro-header">
                <span class="macro-label">${m.label}</span>
                <span class="macro-value">${m.val}${m.unit || 'g'} <span>/ ${m.goal}${m.unit || 'g'}</span></span>
            </div>
            <div class="progress-track">
                <div class="progress-fill" style="width: ${Math.min((m.val/m.goal)*100, 100)}%; background-color: ${m.color};"></div>
            </div>
        </div>
    `).join('');
}

function renderMicros() {
    const microsData = getMicrosData();
    document.getElementById('microsGrid').innerHTML = microsData.map(m => `
        <div>
            <div class="micro-header">
                <p class="micro-name">${m.n}</p>
                <span class="micro-value">${m.v}</span>
            </div>
            <div class="micro-track">
                <div class="micro-fill" style="width: ${m.p}%; background-color: ${m.color};"></div>
            </div>
            <span class="micro-status ${m.p < 50 ? 'warning' : 'good'}">${m.p}% - ${m.st}</span>
        </div>
    `).join('');
}

// ========== CONSULTO IA AVANZATO ==========
async function runConsultoIA() {
    document.getElementById('btnConsulto').style.display = 'none';
    document.getElementById('loadingBox').classList.add('show');
    
    // Raccogli dati reali dell'utente
    const oggi = calcolaNutrizioneOggi();
    const target = getTargetNutrizione();
    const eff = calcolaEfficienzaMetabolica();
    
    // Dati aggiuntivi
    const bmr = window.userNeeds?.bmr || 0;
    const peso = window.userNeeds?.peso || 0;
    const eta = window.userNeeds?.eta || 0;
    const sesso = window.userNeeds?.sesso || 'non specificato';
    const obiettivo = window.userNeeds?.obiettivo || 0;
    const tipoDieta = window.userNeeds?.tipoDieta || 'bilanciata';
    
    // Calcola percentuali raggiunte
    const percKcal = target.kcal > 0 ? Math.round((oggi.kcal / target.kcal) * 100) : 0;
    const percProt = target.prot > 0 ? Math.round((oggi.prot / target.prot) * 100) : 0;
    const percCarb = target.carb > 0 ? Math.round((oggi.carb / target.carb) * 100) : 0;
    const percFat = target.fat > 0 ? Math.round((oggi.fat / target.fat) * 100) : 0;
    
    // Pasti di oggi
    const todayKey = new Date().toISOString().split('T')[0];
    const pastiOggi = (dailyMeals && dailyMeals[todayKey]) || [];
    const numPasti = pastiOggi.length;
    
    // Calcola stato nutrizionale
    let statoNutrizionale = "equilibrato";
    if (percKcal > 130) statoNutrizionale = "ECCESSO CALORICO SIGNIFICATIVO";
    else if (percKcal > 110) statoNutrizionale = "leggermente sopra il target";
    else if (percKcal < 30 && oggi.kcal > 0) statoNutrizionale = "DEFICIT GRAVE - mangia di piÃ¹!";
    else if (percKcal < 50) statoNutrizionale = "deficit calorico importante";
    else if (percKcal < 80) statoNutrizionale = "sotto il target";
    
    const prompt = `Sei un nutrizionista AI esperto. ANALIZZA ATTENTAMENTE questi dati REALI e fornisci un consulto SPECIFICO e PERSONALIZZATO. NON dare risposte generiche!

PROFILO UTENTE:
- Sesso: ${sesso}
- EtÃ : ${eta} anni  
- Peso: ${peso} kg
- BMR: ${bmr} kcal/giorno
- Obiettivo: ${obiettivo > 0 ? 'MASSA (+' + obiettivo + ' kcal surplus)' : obiettivo < 0 ? 'DEFINIZIONE (' + obiettivo + ' kcal deficit)' : 'MANTENIMENTO'}
- Dieta: ${tipoDieta}

NUTRIZIONE OGGI - STATO: ${statoNutrizionale.toUpperCase()}
- Pasti consumati: ${numPasti}
- Calorie: ${oggi.kcal}/${target.kcal} kcal (${percKcal}% - ${percKcal > 100 ? 'SOPRA' : percKcal < 80 ? 'SOTTO' : 'OK'})
- Proteine: ${oggi.prot}g/${target.prot}g (${percProt}% - ${percProt > 100 ? 'ECCESSO' : percProt < 70 ? 'CARENZA' : 'OK'})
- Carboidrati: ${oggi.carb}g/${target.carb}g (${percCarb}% - ${percCarb > 100 ? 'ECCESSO' : percCarb < 70 ? 'CARENZA' : 'OK'})
- Grassi: ${oggi.fat}g/${target.fat}g (${percFat}% - ${percFat > 100 ? 'ECCESSO' : percFat < 70 ? 'CARENZA' : 'OK'})

EFFICIENZA:
- Digestione: ${eff.digestione}
- Recupero: ${eff.recupero}%

ISTRUZIONI IMPORTANTI:
1. Basa il punteggio sui DATI REALI (se calorie a 0 = punteggio basso, se eccesso = punteggio medio)
2. Nel feedback CITA i numeri specifici dell'utente
3. Se l'utente sta mangiando troppo, DILLO CHIARAMENTE
4. Se l'utente sta mangiando troppo poco, AVVISALO
5. L'azione deve essere CONCRETA e basata sui dati

Rispondi SOLO con JSON valido (NO markdown, NO backtick):
{
    "punteggio": numero da 0 a 100,
    "analisi": "feedback motivazionale del coach (2-3 frasi ispiratrici)",
    "dettaglio": "analisi scientifica dettagliata dei dati (3-4 frasi tecniche ma comprensibili)",
    "azione": "una azione prioritaria concreta da fare oggi"
}`;

    let aiResponse;
    
    // Se non c'Ã¨ API key, usa direttamente il fallback locale
    if (!groqApiKey) {
        // Simula un piccolo delay per UX
        await new Promise(resolve => setTimeout(resolve, 800));
        
        // Fallback DINAMICO basato sui dati reali
        const score = Math.max(10, Math.min(100, 100 - Math.abs(100 - percKcal)));
        
        let feedback = "";
        let dettaglio = "";
        let azione = "";
        
        if (percKcal > 130) {
            feedback = `Attenzione! Hai assunto ${oggi.kcal} kcal, ben ${oggi.kcal - target.kcal} oltre il target. Riduci le porzioni.`;
            dettaglio = `Eccesso calorico del ${percKcal - 100}%. Proteine al ${percProt}%, Carbo al ${percCarb}%, Grassi al ${percFat}%.`;
            azione = "Salta lo snack serale e fai 30 minuti di camminata.";
        } else if (percKcal > 110) {
            feedback = `Sei leggermente sopra il target con ${oggi.kcal} kcal. Niente di grave, ma attenzione.`;
            dettaglio = `Calorie al ${percKcal}% del target. Bilancio macro: P${percProt}% C${percCarb}% G${percFat}%.`;
            azione = "Riduci i carboidrati nel prossimo pasto.";
        } else if (percKcal < 50 && oggi.kcal > 0) {
            feedback = `Solo ${oggi.kcal} kcal oggi? Stai mangiando troppo poco! Target: ${target.kcal} kcal.`;
            dettaglio = `Deficit del ${100 - percKcal}%. Rischio rallentamento metabolico se prolungato.`;
            azione = "Aggiungi un pasto proteico completo.";
        } else if (percKcal >= 80 && percKcal <= 110) {
            feedback = `Ottimo! ${oggi.kcal} kcal su ${target.kcal} target. Sei sulla strada giusta!`;
            dettaglio = `Calorie al ${percKcal}%. Proteine ${percProt}%, Carbo ${percCarb}%, Grassi ${percFat}%.`;
            azione = "Continua cosÃ¬ e mantieni l'idratazione.";
        } else if (oggi.kcal === 0) {
            feedback = `Nessun pasto registrato oggi. Inizia a tracciare per ricevere consigli personalizzati!`;
            dettaglio = `Target giornaliero: ${target.kcal} kcal, ${target.prot}g proteine, ${target.carb}g carbo, ${target.fat}g grassi.`;
            azione = "Registra il tuo primo pasto della giornata.";
        } else {
            feedback = `Hai assunto ${oggi.kcal} kcal su ${target.kcal} target (${percKcal}%).`;
            dettaglio = `Proteine: ${oggi.prot}g/${target.prot}g. Carbo: ${oggi.carb}g/${target.carb}g. Grassi: ${oggi.fat}g/${target.fat}g.`;
            azione = "Bilancia meglio i macro nei prossimi pasti.";
        }
        
        aiResponse = {
            punteggio: oggi.kcal === 0 ? 0 : score,
            analisi: feedback,
            dettaglio: dettaglio,
            azione: azione,
            isOffline: true,
            noApiKey: true
        };
    } else {
        // Prova a chiamare l'IA
        try {
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${groqApiKey}`
                },
                body: JSON.stringify({
                    model: 'llama-3.1-8b-instant',
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.7,
                    max_tokens: 800
                })
            });
            
            const data = await response.json();
            
            // Controlla errori API
            if (!response.ok || data.error) {
                throw new Error(data.error?.message || 'Errore API');
            }
            
            try {
                const content = data.choices[0].message.content;
                // Estrai JSON dalla risposta
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('JSON non trovato');
                aiResponse = JSON.parse(jsonMatch[0]);
            } catch (e) {
                console.error('âŒ Errore parsing JSON IA:', e);
                
                // Fallback DINAMICO
                const score = Math.max(10, Math.min(100, 100 - Math.abs(100 - percKcal)));
                
                let feedback = "";
                let dettaglio = "";
                let azione = "";
                
                if (percKcal > 130) {
                    feedback = `Attenzione! Hai assunto ${oggi.kcal} kcal, ben ${oggi.kcal - target.kcal} oltre il target.`;
                    dettaglio = `Eccesso calorico del ${percKcal - 100}%. Proteine al ${percProt}%, Carbo al ${percCarb}%, Grassi al ${percFat}%.`;
                    azione = "Salta lo snack serale e fai 30 minuti di camminata.";
                } else if (percKcal > 110) {
                    feedback = `Sei leggermente sopra il target con ${oggi.kcal} kcal.`;
                    dettaglio = `Calorie al ${percKcal}% del target. Bilancio macro: P${percProt}% C${percCarb}% G${percFat}%.`;
                    azione = "Riduci i carboidrati nel prossimo pasto.";
                } else if (percKcal < 50 && oggi.kcal > 0) {
                    feedback = `Solo ${oggi.kcal} kcal oggi? Stai mangiando troppo poco!`;
                    dettaglio = `Deficit del ${100 - percKcal}%. Rischio rallentamento metabolico.`;
                    azione = "Aggiungi un pasto proteico completo.";
                } else if (percKcal >= 80 && percKcal <= 110) {
                    feedback = `Ottimo! ${oggi.kcal} kcal su ${target.kcal} target. Sei sulla strada giusta!`;
                    dettaglio = `Calorie al ${percKcal}%. Proteine ${percProt}%, Carbo ${percCarb}%, Grassi ${percFat}%.`;
                    azione = "Continua cosÃ¬ e mantieni l'idratazione.";
                } else {
                    feedback = `Hai assunto ${oggi.kcal} kcal su ${target.kcal} target (${percKcal}%).`;
                    dettaglio = `Proteine: ${oggi.prot}g/${target.prot}g. Carbo: ${oggi.carb}g/${target.carb}g. Grassi: ${oggi.fat}g/${target.fat}g.`;
                    azione = "Bilancia meglio i macro nei prossimi pasti.";
                }
                
                aiResponse = {
                    punteggio: score,
                    analisi: feedback,
                    dettaglio: dettaglio,
                    azione: azione,
                    isOffline: true
                };
            }
        } catch (error) {
            console.error('Errore Consulto IA:', error);
            
            // Fallback in caso di errore di rete
            const score = Math.max(10, Math.min(100, 100 - Math.abs(100 - percKcal)));
            
            aiResponse = {
                punteggio: oggi.kcal === 0 ? 0 : score,
                analisi: `Analisi basata sui tuoi dati: ${oggi.kcal} kcal su ${target.kcal} target (${percKcal}%).`,
                dettaglio: `Proteine: ${oggi.prot}g/${target.prot}g. Carbo: ${oggi.carb}g/${target.carb}g. Grassi: ${oggi.fat}g/${target.fat}g.`,
                azione: percKcal > 100 ? "Riduci le porzioni nei prossimi pasti." : "Continua a monitorare l'alimentazione.",
                isOffline: true
            };
        }
    }
    
    // Mostra risultati
    document.getElementById('loadingBox').classList.remove('show');
    
    document.getElementById('aiScoreValue').textContent = aiResponse.punteggio;
    document.getElementById('aiFeedbackText').textContent = `"${aiResponse.analisi}"`;
    document.getElementById('aiDetailText').textContent = aiResponse.dettaglio;
    document.getElementById('aiActionText').textContent = aiResponse.azione;
    
    // Mostra avviso se Ã¨ fallback offline
    let offlineWarning = document.getElementById('aiOfflineWarning');
    if (aiResponse.isOffline) {
        const warningText = aiResponse.noApiKey 
            ? '<strong>Analisi Locale</strong> â€” Configura la chiave API Groq nelle Impostazioni per analisi IA avanzate.'
            : '<strong>Analisi Locale</strong> â€” L\'IA non ha risposto. Analisi basata sui tuoi dati.';
        
        if (!offlineWarning) {
            const warning = document.createElement('div');
            warning.id = 'aiOfflineWarning';
            warning.innerHTML = `
                <div style="background: rgba(251, 191, 36, 0.15); border: 1px solid rgba(251, 191, 36, 0.4); 
                            border-radius: 12px; padding: 12px 16px; margin-bottom: 16px; 
                            display: flex; align-items: center; gap: 10px;">
                    <i class="fa-solid fa-triangle-exclamation" style="color: #fbbf24; font-size: 18px;"></i>
                    <span style="color: #fbbf24; font-size: 13px; line-height: 1.4;">
                        ${warningText}
                    </span>
                </div>
            `;
            const headerBar = document.querySelector('.ai-header-bar');
            if (headerBar) headerBar.after(warning);
        } else {
            offlineWarning.querySelector('span').innerHTML = warningText;
            offlineWarning.style.display = 'flex';
        }
    } else {
        if (offlineWarning) offlineWarning.style.display = 'none';
    }
    
    // Reset sezione accurate - nascondi bottone se no API key
    document.getElementById('accurateAdviceSection').style.display = 'none';
    if (groqApiKey) {
        document.getElementById('btnAccurate').style.display = 'flex';
    } else {
        document.getElementById('btnAccurate').style.display = 'none';
    }
    
    // Mostra overlay
    document.getElementById('aiPanelOverlay').classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Scroll to top dell'overlay
    document.getElementById('aiPanelOverlay').scrollTop = 0;
}

async function generateAccurateAdvice() {
    // Verifica API key
    if (!groqApiKey) {
        toast('âš ï¸ Configura la chiave API Groq nelle Impostazioni');
        return;
    }
    
    const btn = document.getElementById('btnAccurate');
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Elaborazione...';
    
    const oggi = calcolaNutrizioneOggi();
    const target = getTargetNutrizione();
    const eff = calcolaEfficienzaMetabolica();
    
    // Dati profilo
    const bmr = window.userNeeds?.bmr || 0;
    const peso = window.userNeeds?.peso || 0;
    const sesso = window.userNeeds?.sesso || 'non specificato';
    const obiettivo = window.userNeeds?.obiettivo || 0;
    const tipoDieta = window.userNeeds?.tipoDieta || 'bilanciata';
    
    // Gap dai target
    const gapProt = target.prot - oggi.prot;
    const gapCarb = target.carb - oggi.carb;
    const gapFat = target.fat - oggi.fat;
    const gapKcal = target.kcal - oggi.kcal;
    
    // Stato attuale
    const percProt = target.prot > 0 ? Math.round((oggi.prot / target.prot) * 100) : 0;
    const percCarb = target.carb > 0 ? Math.round((oggi.carb / target.carb) * 100) : 0;
    const percFat = target.fat > 0 ? Math.round((oggi.fat / target.fat) * 100) : 0;
    
    const prompt = `Sei un nutrizionista sportivo esperto. Analizza questi dati REALI e fornisci consigli SPECIFICI e PERSONALIZZATI.

PROFILO UTENTE:
- Sesso: ${sesso}, Peso: ${peso}kg, BMR: ${bmr} kcal
- Dieta scelta: ${tipoDieta}
- Obiettivo: ${obiettivo > 0 ? 'MASSA MUSCOLARE (+' + obiettivo + ' kcal)' : obiettivo < 0 ? 'DIMAGRIMENTO (' + obiettivo + ' kcal)' : 'MANTENIMENTO'}

ANALISI DETTAGLIATA:
- Proteine: ${oggi.prot}g su ${target.prot}g target (${percProt}%) ${gapProt > 0 ? 'â†’ MANCANO ' + gapProt + 'g' : gapProt < 0 ? 'â†’ ECCESSO di ' + Math.abs(gapProt) + 'g' : 'â†’ PERFETTO'}
- Carboidrati: ${oggi.carb}g su ${target.carb}g target (${percCarb}%) ${gapCarb > 0 ? 'â†’ MANCANO ' + gapCarb + 'g' : gapCarb < 0 ? 'â†’ ECCESSO di ' + Math.abs(gapCarb) + 'g' : 'â†’ PERFETTO'}
- Grassi: ${oggi.fat}g su ${target.fat}g target (${percFat}%) ${gapFat > 0 ? 'â†’ MANCANO ' + gapFat + 'g' : gapFat < 0 ? 'â†’ ECCESSO di ' + Math.abs(gapFat) + 'g' : 'â†’ PERFETTO'}
- Calorie totali: ${oggi.kcal} su ${target.kcal} ${gapKcal > 0 ? 'â†’ MANCANO ' + gapKcal + ' kcal' : gapKcal < 0 ? 'â†’ ECCESSO di ' + Math.abs(gapKcal) + ' kcal' : 'â†’ PERFETTO'}

ISTRUZIONI:
1. I grammi consigliati devono essere SPECIFICI per questo utente (non generici)
2. Le previsioni devono basarsi sullo stato ATTUALE (se Ã¨ giÃ  in eccesso, non dire +%)
3. Il consiglio extra deve menzionare i NUMERI specifici

Rispondi SOLO con JSON valido (NO markdown):
{
    "macro": {
        "proteine": "Xg - descrizione breve",
        "carboidrati": "Xg - descrizione breve",
        "grassi": "Xg - descrizione breve"
    },
    "previsioni": [
        {"titolo": "Energia", "percentuale": "+X%"},
        {"titolo": "Recupero", "percentuale": "+X%"},
        {"titolo": "Composizione", "percentuale": "+X%"}
    ],
    "testoExtra": "consiglio personalizzato aggiuntivo"
}`;

    try {
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${groqApiKey}`
            },
            body: JSON.stringify({
                model: 'llama-3.1-8b-instant',
                messages: [{ role: 'user', content: prompt }],
                temperature: 0.7,
                max_tokens: 600
            })
        });
        
        const data = await response.json();
        let advice;
        
        try {
            const content = data.choices[0].message.content;
            const cleanContent = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            advice = JSON.parse(cleanContent);
        } catch (e) {
            advice = {
                macro: {
                    proteine: `${target.prot}g - ottimale per massa muscolare`,
                    carboidrati: `${target.carb}g - energia sostenuta`,
                    grassi: `${target.fat}g - salute ormonale`
                },
                previsioni: [
                    {titolo: "Energia", percentuale: "+15%"},
                    {titolo: "Recupero", percentuale: "+20%"},
                    {titolo: "Composizione", percentuale: "+10%"}
                ],
                testoExtra: "Seguendo queste indicazioni per 4 settimane vedrai miglioramenti significativi nella tua composizione corporea e nei livelli di energia."
            };
        }
        
        // Popola i dati
        document.getElementById('accProteine').textContent = advice.macro.proteine;
        document.getElementById('accCarboidrati').textContent = advice.macro.carboidrati;
        document.getElementById('accGrassi').textContent = advice.macro.grassi;
        
        // Previsioni
        const prevContainer = document.getElementById('previsioniContainer');
        prevContainer.innerHTML = '';
        advice.previsioni.forEach(p => {
            prevContainer.innerHTML += `
                <div class="previsione-item">
                    <span class="prev-title">${p.titolo}</span>
                    <span class="prev-perc">${p.percentuale}</span>
                </div>
            `;
        });
        
        document.getElementById('accTestoExtra').textContent = advice.testoExtra;
        
        // Mostra sezione e nascondi bottone
        document.getElementById('accurateAdviceSection').style.display = 'block';
        btn.style.display = 'none';
        
    } catch (error) {
        console.error('Errore Accurate Advice:', error);
        toast('âŒ Errore generazione consiglio');
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-chart-line"></i> Genera un consiglio piÃ¹ accurato';
    }
}

function closeAiPanel() {
    document.getElementById('aiPanelOverlay').classList.remove('show');
    document.body.style.overflow = 'hidden'; // Mantieni hidden perchÃ© siamo ancora in Analisi Salute
    document.getElementById('btnConsulto').style.display = 'inline-flex';
    
    // Reset del bottone Accurate
    const btnAccurate = document.getElementById('btnAccurate');
    if (btnAccurate) {
        btnAccurate.disabled = false;
        btnAccurate.innerHTML = '<i class="fa-solid fa-chart-line"></i> Genera un consiglio piÃ¹ accurato';
        btnAccurate.style.display = 'flex';
    }
    
    // Nascondi sezione accurate
    const accSection = document.getElementById('accurateAdviceSection');
    if (accSection) {
        accSection.style.display = 'none';
    }
    
    // Scroll to top di Analisi Salute
    const modal = document.querySelector('.analisi-salute-wrapper');
    if (modal) {
        modal.scrollTop = 0;
    }
}

// Mantieni la vecchia funzione per compatibilitÃ 
function closeResult() {
    closeAiPanel();
}

// Modal Chiave API

async function analisiIAComposizione() {
    const btn = document.getElementById('btnIAComposizione');
    const resultBox = document.getElementById('composizioneIAResult');
    const resultText = document.getElementById('composizioneIAText');
    
    // Raccogli dati composizione
    const legendItems = document.querySelectorAll('#bodyContent .legend-item');
    let massaMagra = '72%', massaGrassa = '18%', liquidi = '10%';
    if (legendItems.length >= 3) {
        massaMagra = legendItems[0]?.querySelector('.legend-value')?.textContent || '72%';
        massaGrassa = legendItems[1]?.querySelector('.legend-value')?.textContent || '18%';
        liquidi = legendItems[2]?.querySelector('.legend-value')?.textContent || '10%';
    }
    
    // Mostra loading
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analisi in corso...';
    
    if (!groqApiKey) {
        // Fallback senza API
        setTimeout(() => {
            btn.style.display = 'none';
            resultBox.style.display = 'block';
            resultText.textContent = `La tua composizione corporea mostra ${massaMagra} di massa magra, ${massaGrassa} di massa grassa e ${liquidi} di liquidi. Per una valutazione piÃ¹ dettagliata, configura la chiave API Groq nelle Impostazioni.`;
        }, 800);
        return;
    }
    
    try {
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${groqApiKey}`
            },
            body: JSON.stringify({
                model: 'llama-3.1-8b-instant',
                messages: [{
                    role: 'user',
                    content: `Sei un nutrizionista esperto. Analizza questa composizione corporea in modo semplice e utile:
                    - Massa Magra: ${massaMagra}
                    - Massa Grassa: ${massaGrassa}
                    - Liquidi: ${liquidi}
                    
                    Dai un'analisi breve (3-4 frasi) su cosa significano questi valori e un consiglio pratico per migliorare. Rispondi in italiano, tono amichevole ma professionale.`
                }],
                max_tokens: 300,
                temperature: 0.7
            })
        });
        
        const data = await response.json();
        const aiText = data.choices?.[0]?.message?.content || 'Analisi non disponibile.';
        
        btn.style.display = 'none';
        resultBox.style.display = 'block';
        resultText.textContent = aiText;
        
    } catch (error) {
        console.error('Errore IA Composizione:', error);
        btn.style.display = 'none';
        resultBox.style.display = 'block';
        resultText.textContent = `La tua composizione mostra ${massaMagra} di massa magra e ${massaGrassa} di massa grassa. Valori nella norma. Per un'analisi piÃ¹ approfondita, verifica la connessione e riprova.`;
    }
}

async function analisiIANutrizione() {
    const btn = document.getElementById('btnIANutrizione');
    const resultBox = document.getElementById('nutrizioneIAResult');
    const resultText = document.getElementById('nutrizioneIAText');
    
    // ========== RACCOGLI TUTTI I DATI ==========
    
    // 1. Dati Bio-Nutrizione (MACRO + MICRO)
    const macrosData = typeof getMacrosData === 'function' ? getMacrosData() : [];
    const microsData = typeof getMicrosData === 'function' ? getMicrosData() : [];
    
    // Formatta macro per il prompt
    let macrosText = macrosData.map(m => 
        `- ${m.label}: ${m.val}${m.unit || 'g'} / ${m.goal}${m.unit || 'g'} (${Math.round(m.val/m.goal*100)}%)`
    ).join('\n');
    
    // Formatta micro per il prompt
    let microsText = microsData.map(m => 
        `- ${m.n}: ${m.v} (${m.p}% - ${m.st})`
    ).join('\n');
    
    // 2. Nutrizione di oggi
    const oggi = typeof calcolaNutrizioneOggi === 'function' ? calcolaNutrizioneOggi() : {kcal:0, prot:0, carb:0, fat:0};
    const target = typeof getTargetNutrizione === 'function' ? getTargetNutrizione() : {kcal:2000, prot:120, carb:250, fat:70};
    
    // 3. Dati profilo utente
    const fabbisogno = window.userNeeds || {};
    const sesso = fabbisogno.sesso || 'non specificato';
    const eta = fabbisogno.eta || 0;
    const peso = fabbisogno.peso || 0;
    const altezza = fabbisogno.altezza || 0;
    const bmr = fabbisogno.bmr || 0;
    const obiettivo = fabbisogno.obiettivo || 'mantenimento';
    const tipoDieta = fabbisogno.tipoDieta || 'bilanciata';
    
    // 4. Dati smartwatch
    const smartwatch = (typeof swData !== 'undefined') ? swData : {};
    const calorieBruciate = smartwatch.caloriesBurned || 0;
    const passi = smartwatch.steps || 0;
    const battito = smartwatch.heartRateAvg || 0;
    
    // 5. Pasti di oggi
    const today = typeof getTodayKey === 'function' ? getTodayKey() : new Date().toISOString().slice(0,10);
    let meals = [];
    if (typeof dailyMeals !== 'undefined' && dailyMeals[today]) meals = dailyMeals[today];
    else if (window.dailyMeals && window.dailyMeals[today]) meals = window.dailyMeals[today];
    const numPasti = meals.length;
    const listaPasti = meals.map(m => `${m.nome} (${Math.round(m.kcal)} kcal)`).join(', ') || 'Nessun pasto';
    
    // 6. Efficienza metabolica
    const eff = typeof calcolaEfficienzaMetabolica === 'function' ? calcolaEfficienzaMetabolica() : {digestione: '---', recupero: 0};
    
    // 7. Calcola bilancio
    const calorieConsumate = bmr + calorieBruciate;
    const bilancioCalorico = calorieConsumate - oggi.kcal;
    
    // Mostra loading
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analisi Bio-nutrizione...';
    
    // ========== PROMPT SPECIFICO BIO-NUTRIZIONE ==========
    const promptBioNutrizione = `Sei un nutrizionista esperto specializzato in Bio-Nutrizione. Analizza DETTAGLIATAMENTE i MACRONUTRIENTI e MICRONUTRIENTI con contesto completo.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“Š MACRONUTRIENTI (FOCUS PRINCIPALE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${macrosText || 'Nessun dato macro disponibile'}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ§¬ MICRONUTRIENTI (VITAMINE E MINERALI)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${microsText || 'Nessun dato micro disponibile'}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ‘¤ CONTESTO UTENTE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- Sesso: ${sesso}, EtÃ : ${eta} anni, Peso: ${peso} kg, Altezza: ${altezza} cm
- Obiettivo: ${obiettivo}
- Tipo dieta: ${tipoDieta}
- BMR: ${bmr} kcal/giorno
- Fabbisogno totale: ${target.kcal} kcal

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ½ï¸ PASTI OGGI (${numPasti} pasti)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${listaPasti}
- Totale: ${Math.round(oggi.kcal)} kcal | P: ${Math.round(oggi.prot)}g | C: ${Math.round(oggi.carb)}g | G: ${Math.round(oggi.fat)}g

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âŒš ATTIVITÃ€ FISICA (SMARTWATCH)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- Calorie bruciate attive: ${calorieBruciate} kcal
- Passi: ${passi}
- Battito medio: ${battito} BPM
- Bilancio energetico: ${bilancioCalorico > 0 ? '+' : ''}${bilancioCalorico} kcal

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš¡ EFFICIENZA METABOLICA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- Digestione: ${eff.digestione}
- Recupero muscolare: ${eff.recupero}%

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“ ISTRUZIONI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Fornisci un'analisi BIO-NUTRIZIONALE dettagliata (5-6 frasi) focalizzandoti su:

1. MACRO BALANCE - Valuta l'equilibrio tra proteine, carboidrati (semplici vs complessi), grassi (sani vs saturi), fibre e omega-3
2. MICRO CARENZE - Identifica le vitamine/minerali sotto il 50% e spiega le conseguenze
3. MICRO ECCESSI - Segnala eventuali eccessi (es. sodio alto)
4. CORRELAZIONE ATTIVITÃ€ - Come i dati smartwatch (${passi} passi, ${calorieBruciate} kcal) influenzano il fabbisogno di nutrienti
5. AZIONE SPECIFICA - Cosa mangiare ORA per bilanciare macro e micro (cibo specifico, non generico)

Rispondi in italiano, tono professionale ma comprensibile. USA NUMERI SPECIFICI dall'analisi. NON usare asterischi o markdown nella risposta.`;

    if (!groqApiKey) {
        // Fallback senza API - mostra riepilogo dati
        setTimeout(() => {
            btn.style.display = 'none';
            resultBox.style.display = 'block';
            
            // Trova carenze
            const carenze = microsData.filter(m => m.p < 50).map(m => m.n).join(', ') || 'Nessuna';
            const eccessi = microsData.filter(m => m.p > 100).map(m => m.n).join(', ') || 'Nessuno';
            
            resultText.innerHTML = `
                <div style="font-size:13px; line-height:1.6;">
                    <strong>ðŸ“Š Riepilogo Bio-Nutrizione:</strong><br><br>
                    
                    <strong>Macronutrienti:</strong><br>
                    â€¢ Proteine: ${Math.round(oggi.prot)}g/${target.prot}g (${Math.round(oggi.prot/target.prot*100)}%)<br>
                    â€¢ Carboidrati: ${Math.round(oggi.carb)}g/${target.carb}g (${Math.round(oggi.carb/target.carb*100)}%)<br>
                    â€¢ Grassi: ${Math.round(oggi.fat)}g/${target.fat}g (${Math.round(oggi.fat/target.fat*100)}%)<br><br>
                    
                    <strong>Micronutrienti:</strong><br>
                    â€¢ âš ï¸ Carenze (<50%): ${carenze}<br>
                    â€¢ âœ… In eccesso: ${eccessi}<br><br>
                    
                    <strong>AttivitÃ :</strong> ${passi} passi, ${calorieBruciate} kcal bruciate<br>
                    <strong>Bilancio:</strong> ${bilancioCalorico > 0 ? '+' : ''}${bilancioCalorico} kcal<br><br>
                    
                    <em>âš™ï¸ Configura la chiave API Groq nelle Impostazioni per consigli IA personalizzati.</em>
                </div>
            `;
        }, 800);
        return;
    }
    
    try {
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${groqApiKey}`
            },
            body: JSON.stringify({
                model: 'llama-3.1-8b-instant',
                messages: [{ role: 'user', content: promptBioNutrizione }],
                max_tokens: 500,
                temperature: 0.7
            })
        });
        
        const data = await response.json();
        const aiText = data.choices?.[0]?.message?.content || 'Analisi non disponibile.';
        
        btn.style.display = 'none';
        resultBox.style.display = 'block';
        
        // Trova carenze per header
        const carenze = microsData.filter(m => m.p < 50);
        const carenzeText = carenze.length > 0 
            ? `âš ï¸ ${carenze.length} carenze: ${carenze.map(m => m.n).slice(0,3).join(', ')}${carenze.length > 3 ? '...' : ''}`
            : 'âœ… Nessuna carenza grave';
        
        // Rimuovi eventuali ** dal testo AI
        const aiTextClean = aiText.replace(/\*\*/g, '').replace(/\*/g, '');
        
        resultText.innerHTML = `<div style="line-height:1.6;">${aiTextClean}</div>`;
        
    } catch (error) {
        console.error('Errore IA Bio-Nutrizione:', error);
        btn.style.display = 'none';
        resultBox.style.display = 'block';
        resultText.textContent = `Errore di connessione. Riprova piÃ¹ tardi.`;
    }
}

function chiudiIAComposizione() {
    const btn = document.getElementById('btnIAComposizione');
    const resultBox = document.getElementById('composizioneIAResult');
    
    // Nascondi risultato
    resultBox.style.display = 'none';
    
    // Ripristina bottone
    btn.style.display = 'flex';
    btn.disabled = false;
    btn.innerHTML = '<i class="fa-solid fa-atom"></i> Analizza Composizione con IA';
}

function chiudiIANutrizione() {
    const btn = document.getElementById('btnIANutrizione');
    const resultBox = document.getElementById('nutrizioneIAResult');
    
    // Nascondi risultato
    resultBox.style.display = 'none';
    
    // Ripristina bottone
    btn.style.display = 'flex';
    btn.disabled = false;
    btn.innerHTML = '<i class="fa-solid fa-atom"></i> Analizza con IA';
}
  
// ========== APERTURA/CHIUSURA MODAL ==========
async function openAnalisiSalute() {
    const modal = document.querySelector('.analisi-salute-wrapper');
    if (modal) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // Scroll to top
        modal.scrollTop = 0;
        
        // IMPORTANTE: Resetta sempre l'overlay IA quando si apre Analisi Salute
        const aiOverlay = document.getElementById('aiPanelOverlay');
        if (aiOverlay) {
            aiOverlay.classList.remove('show');
        }
        
        // Reset bottone consulto
        const btnConsulto = document.getElementById('btnConsulto');
        if (btnConsulto) {
            btnConsulto.style.display = 'inline-flex';
        }
        
        // Reset bottone accurate
        const btnAccurate = document.getElementById('btnAccurate');
        if (btnAccurate) {
            btnAccurate.disabled = false;
            btnAccurate.innerHTML = '<i class="fa-solid fa-chart-line"></i> Genera un consiglio piÃ¹ accurato';
            btnAccurate.style.display = 'flex';
        }
        
        // Nascondi sezione accurate
        const accSection = document.getElementById('accurateAdviceSection');
        if (accSection) {
            accSection.style.display = 'none';
        }
        
        // Rimuovi stili inline dalle section
        modal.querySelectorAll('section').forEach(section => {
            section.style.display = '';
        });
        
        // Aspetta render
        requestAnimationFrame(async () => {
            requestAnimationFrame(async () => {
                console.log('ðŸŽ¨ Modal visibile, inizializzo grafici...');
                
                if (typeof initPesoChart === 'function') {
                    await initPesoChart();
                    console.log('âœ… Peso chart inizializzato');
                }
                
                if (typeof initPieChart === 'function') {
                    await initPieChart();
                    console.log('âœ… Pie chart (composizione) inizializzato');
                }
                
                if (typeof renderMacros === 'function') {
                    renderMacros();
                    console.log('âœ… Macros aggiornati');
                }
                
                if (typeof renderMicros === 'function') {
                    renderMicros();
                    console.log('âœ… Micros aggiornati');
                }
                
                if (typeof updateEfficienzaMetabolica === 'function') {
                    updateEfficienzaMetabolica();
                    console.log('âœ… Efficienza metabolica aggiornata');
                }
            });
        });
    }
}
  
function closeAnalisiSalute() {
    const modal = document.querySelector('.analisi-salute-wrapper');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
        
        // ðŸ†• RESET FLAG: prossima apertura = animazione punto per punto
        isFirstLoad = true;
    }
}

// ========== RICETTE FULLSCREEN ==========

function openRicetteFullscreen() {
    const wrapper = document.getElementById('ricetteFullscreen');
    const navbar = document.querySelector('.navbar');
    if (wrapper) {
        wrapper.classList.add('open');
        document.body.style.overflow = 'hidden';
        
        // Nascondi navbar
        if (navbar) navbar.style.display = 'none';
        
        // Carica le ricette
        switchRicetteTab('salvate');
    }
}

function closeRicetteFullscreen() {
    const wrapper = document.getElementById('ricetteFullscreen');
    const navbar = document.querySelector('.navbar');
    if (wrapper) {
        wrapper.classList.remove('open');
        document.body.style.overflow = '';
        
        // Mostra navbar
        if (navbar) navbar.style.display = 'flex';
    }
}

function switchRicetteTab(tab) {
  const tabSalvate = document.getElementById('tabRicetteSalvate');
  const tabPreferite = document.getElementById('tabRicettePreferite');
  const tabAggiungi = document.getElementById('tabRicetteAggiungi');
  const sectionLista = document.getElementById('ricetteBookViewContainer');
  const sectionAggiungi = document.getElementById('aggiungiRicetta');
  const searchContainer = document.getElementById('ricetteBookSearchContainer');
  
  // Reset tutti i tab
  if (tabSalvate) tabSalvate.classList.remove('active');
  if (tabPreferite) tabPreferite.classList.remove('active');
  if (tabAggiungi) tabAggiungi.classList.remove('active');
  
  if (tab === 'salvate') {
    if (tabSalvate) tabSalvate.classList.add('active');
    if (sectionLista) sectionLista.style.display = 'block';
    if (sectionAggiungi) sectionAggiungi.style.display = 'none';
    if (searchContainer) searchContainer.style.display = 'block';
    ricetteFiltroTipo = 'tutti';
    filtraRicette();
  } else if (tab === 'preferite') {
    if (tabPreferite) tabPreferite.classList.add('active');
    if (sectionLista) sectionLista.style.display = 'block';
    if (sectionAggiungi) sectionAggiungi.style.display = 'none';
    if (searchContainer) searchContainer.style.display = 'block';
    ricetteFiltroTipo = 'preferite';
    filtraRicettePreferite();
  } else {
    if (tabAggiungi) tabAggiungi.classList.add('active');
    if (sectionLista) sectionLista.style.display = 'none';
    if (sectionAggiungi) sectionAggiungi.style.display = 'block';
    if (searchContainer) searchContainer.style.display = 'none';
  }
}

// Funzione per salvare definitivamente un preferito
function salvaPreferito(idx) {
    if (recipes[idx]) {
        delete recipes[idx].soloPreferito;
        if (typeof saveRecipeIndexed === 'function') saveRecipeIndexed();
        if (typeof renderRecipes === 'function') renderRecipes();
        filtraRicettePreferite();
        if (typeof toast === 'function') toast('âœ… Ricetta salvata definitivamente!');
    }
}

function rimuoviPreferito(idx) {
    if (recipes[idx]) {
        recipes[idx].preferito = false;
        if (typeof saveRecipeIndexed === 'function') saveRecipeIndexed();
        filtraRicettePreferite();
        if (typeof toast === 'function') toast('â˜† Rimossa dai preferiti');
    }
}  

// Toggle preferito per design libro
function togglePreferito(idx) {
  if (recipes[idx]) {
    recipes[idx].preferito = !recipes[idx].preferito;
    if (typeof saveRecipeIndexed === 'function') saveRecipeIndexed();
    
    // Aggiorna la vista corrente
    if (ricetteFiltroTipo === 'preferite') {
      filtraRicettePreferite();
    } else {
      filtraRicette();
    }
    
    const action = recipes[idx].preferito ? 'aggiunta ai' : 'rimossa dai';
    if (typeof toast === 'function') toast(`â­ Ricetta ${action} preferiti`);
  }
}

// Toggle veg per form libro
function toggleVegBook() {
  const input = document.getElementById('rVeg');
  const btn = document.getElementById('rVegBtn');
  if (!input || !btn) return;
  
  const isVeg = input.value === 'true';
  
  if (!isVeg) {
    input.value = 'true';
    btn.className = 'ricette-book-veg-btn veg';
    btn.innerText = 'ðŸŒ¿ Veg';
  } else {
    input.value = 'false';
    btn.className = 'ricette-book-veg-btn nonveg';
    btn.innerText = 'ðŸ– Non-Veg';
  }
}  
  
// ========== CERCA RICETTE ONLINE ==========

const ricetteOnlineDatabase = {
    italiana: [
        { nome: "Spaghetti Carbonara", desc: "Pasta con uova, guanciale, pecorino", kcal: 550, prot: 22, carb: 65, fat: 24, icon: "ðŸ", img: "https://images.unsplash.com/photo-1612874742237-6526221588e3?w=400&h=400&fit=crop" },
        { nome: "Lasagne alla Bolognese", desc: "Strati di pasta con ragÃ¹ e besciamella", kcal: 680, prot: 28, carb: 52, fat: 38, icon: "ðŸ", img: "https://images.unsplash.com/photo-1574894709920-11b28e7367e3?w=400&h=400&fit=crop" },
        { nome: "Risotto ai Funghi", desc: "Riso cremoso con porcini", kcal: 420, prot: 12, carb: 58, fat: 16, icon: "ðŸš", img: "https://images.unsplash.com/photo-1476124369491-e7addf5db371?w=400&h=400&fit=crop" },
        { nome: "Pizza Margherita", desc: "Pomodoro, mozzarella, basilico", kcal: 750, prot: 26, carb: 88, fat: 28, icon: "ðŸ•", img: "https://images.unsplash.com/photo-1604068549290-dea0e4a305ca?w=400&h=400&fit=crop" },
        { nome: "Ossobuco alla Milanese", desc: "Stinco di vitello brasato", kcal: 480, prot: 38, carb: 8, fat: 32, icon: "ðŸ¥©", img: "https://images.unsplash.com/photo-1544025162-d76694265947?w=400&h=400&fit=crop" },
        { nome: "TiramisÃ¹", desc: "Dolce con mascarpone e caffÃ¨", kcal: 450, prot: 8, carb: 42, fat: 28, icon: "ðŸ°", img: "https://images.unsplash.com/photo-1571877227200-a0d98ea607e9?w=400&h=400&fit=crop" }
    ],
    americana: [
        { nome: "Burger Classic", desc: "Hamburger con cheddar e bacon", kcal: 850, prot: 42, carb: 48, fat: 54, icon: "ðŸ”", img: "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400&h=400&fit=crop" },
        { nome: "Mac and Cheese", desc: "Maccheroni al formaggio cremoso", kcal: 580, prot: 18, carb: 62, fat: 28, icon: "ðŸ§€", img: "https://images.unsplash.com/photo-1543339494-b4cd4f7ba686?w=400&h=400&fit=crop" },
        { nome: "BBQ Ribs", desc: "Costine di maiale con salsa BBQ", kcal: 720, prot: 45, carb: 22, fat: 52, icon: "ðŸ–", img: "https://images.unsplash.com/photo-1544025162-d76694265947?w=400&h=400&fit=crop" },
        { nome: "Caesar Salad", desc: "Insalata con pollo e parmigiano", kcal: 380, prot: 28, carb: 18, fat: 22, icon: "ðŸ¥—", img: "https://images.unsplash.com/photo-1546793665-c74683f339c1?w=400&h=400&fit=crop" },
        { nome: "Pancakes", desc: "Frittelle con sciroppo d'acero", kcal: 520, prot: 12, carb: 68, fat: 22, icon: "ðŸ¥ž", img: "https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=400&h=400&fit=crop" },
        { nome: "Hot Dog", desc: "Wurstel con senape e ketchup", kcal: 480, prot: 18, carb: 42, fat: 26, icon: "ðŸŒ­", img: "https://images.unsplash.com/photo-1612392062126-2f3db05de089?w=400&h=400&fit=crop" }
    ],
    giapponese: [
        { nome: "Sushi Misto", desc: "Nigiri e maki assortiti", kcal: 380, prot: 22, carb: 52, fat: 8, icon: "ðŸ£", img: "https://images.unsplash.com/photo-1579584425555-c3ce17fd4351?w=400&h=400&fit=crop" },
        { nome: "Ramen Tonkotsu", desc: "Zuppa di noodles con brodo di maiale", kcal: 620, prot: 28, carb: 68, fat: 26, icon: "ðŸœ", img: "https://images.unsplash.com/photo-1569718212165-3a8278d5f624?w=400&h=400&fit=crop" },
        { nome: "Tempura", desc: "Verdure e gamberi fritti", kcal: 450, prot: 18, carb: 42, fat: 24, icon: "ðŸ¤", img: "https://images.unsplash.com/photo-1581781870027-04212e231e96?w=400&h=400&fit=crop" },
        { nome: "Teriyaki Chicken", desc: "Pollo con salsa teriyaki e riso", kcal: 520, prot: 35, carb: 58, fat: 14, icon: "ðŸ—", img: "https://images.unsplash.com/photo-1609183480237-ccbec tried-44d3-99e9-0e4d35f2c8e5?w=400&h=400&fit=crop" },
        { nome: "Gyoza", desc: "Ravioli giapponesi alla piastra", kcal: 320, prot: 14, carb: 36, fat: 14, icon: "ðŸ¥Ÿ", img: "https://images.unsplash.com/photo-1496116218417-1a781b1c416c?w=400&h=400&fit=crop" },
        { nome: "Onigiri", desc: "Triangoli di riso con ripieno", kcal: 180, prot: 5, carb: 38, fat: 2, icon: "ðŸ™", img: "https://images.unsplash.com/photo-1536304993881-ff6e9eefa2a6?w=400&h=400&fit=crop" }
    ],
    messicana: [
        { nome: "Tacos al Pastor", desc: "Tortilla con carne marinata", kcal: 420, prot: 24, carb: 38, fat: 20, icon: "ðŸŒ®", img: "https://images.unsplash.com/photo-1565299585323-38d6b0865b47?w=400&h=400&fit=crop" },
        { nome: "Burrito", desc: "Tortilla ripiena di carne e fagioli", kcal: 680, prot: 32, carb: 72, fat: 28, icon: "ðŸŒ¯", img: "https://images.unsplash.com/photo-1626700051175-6818013e1d4f?w=400&h=400&fit=crop" },
        { nome: "Quesadilla", desc: "Tortilla con formaggio fuso", kcal: 480, prot: 22, carb: 42, fat: 26, icon: "ðŸ§€", img: "https://images.unsplash.com/photo-1618040996337-56904b7850b9?w=400&h=400&fit=crop" },
        { nome: "Nachos Supreme", desc: "Tortilla chips con guacamole", kcal: 550, prot: 16, carb: 52, fat: 32, icon: "ðŸŒ½", img: "https://images.unsplash.com/photo-1513456852971-30c0b8199d4d?w=400&h=400&fit=crop" },
        { nome: "Enchiladas", desc: "Tortillas arrotolate con salsa", kcal: 520, prot: 26, carb: 48, fat: 24, icon: "ðŸ«”", img: "https://images.unsplash.com/photo-1534352956036-cd81e27dd615?w=400&h=400&fit=crop" },
        { nome: "Guacamole", desc: "Crema di avocado con nachos", kcal: 280, prot: 4, carb: 18, fat: 22, icon: "ðŸ¥‘", img: "https://images.unsplash.com/photo-1600891964092-4316c288032e?w=400&h=400&fit=crop" }
    ],
    indiana: [
        { nome: "Chicken Tikka Masala", desc: "Pollo in salsa cremosa speziata", kcal: 480, prot: 32, carb: 18, fat: 32, icon: "ðŸ›", img: "https://images.unsplash.com/photo-1565557623262-b51c2513a641?w=400&h=400&fit=crop" },
        { nome: "Biryani", desc: "Riso basmati speziato con carne", kcal: 550, prot: 28, carb: 68, fat: 18, icon: "ðŸš", img: "https://images.unsplash.com/photo-1563379091339-03b21ab4a4f8?w=400&h=400&fit=crop" },
        { nome: "Butter Chicken", desc: "Pollo in salsa al burro", kcal: 520, prot: 30, carb: 14, fat: 38, icon: "ðŸ—", img: "https://images.unsplash.com/photo-1603894584373-5ac82b2ae398?w=400&h=400&fit=crop" },
        { nome: "Samosa", desc: "Fagottini fritti ripieni", kcal: 280, prot: 6, carb: 32, fat: 14, icon: "ðŸ¥Ÿ", img: "https://images.unsplash.com/photo-1601050690597-df0568f70950?w=400&h=400&fit=crop" },
        { nome: "Naan", desc: "Pane indiano al forno", kcal: 260, prot: 8, carb: 48, fat: 5, icon: "ðŸ«“", img: "https://images.unsplash.com/photo-1565557623262-b51c2513a641?w=400&h=400&fit=crop" },
        { nome: "Dal Makhani", desc: "Lenticchie cremose speziate", kcal: 320, prot: 14, carb: 42, fat: 12, icon: "ðŸ²", img: "https://images.unsplash.com/photo-1546833999-b9f581a1996d?w=400&h=400&fit=crop" }
    ],
    cinese: [
        { nome: "Pollo Kung Pao", desc: "Pollo piccante con arachidi", kcal: 420, prot: 28, carb: 24, fat: 26, icon: "ðŸ—", img: "https://images.unsplash.com/photo-1525755662778-989d0524087e?w=400&h=400&fit=crop" },
        { nome: "Riso alla Cantonese", desc: "Riso saltato con uova e verdure", kcal: 380, prot: 12, carb: 58, fat: 12, icon: "ðŸš", img: "https://images.unsplash.com/photo-1603133872878-684f208fb84b?w=400&h=400&fit=crop" },
        { nome: "Involtini Primavera", desc: "Rotolini fritti di verdure", kcal: 220, prot: 6, carb: 28, fat: 10, icon: "ðŸ¥¢", img: "https://images.unsplash.com/photo-1606525437679-037aca74a3e9?w=400&h=400&fit=crop" },
        { nome: "Anatra alla Pechinese", desc: "Anatra arrosto croccante", kcal: 580, prot: 35, carb: 12, fat: 44, icon: "ðŸ¦†", img: "https://images.unsplash.com/photo-1518492104633-130d0cc84637?w=400&h=400&fit=crop" },
        { nome: "Mapo Tofu", desc: "Tofu in salsa piccante", kcal: 280, prot: 18, carb: 14, fat: 18, icon: "ðŸ¥¡", img: "https://images.unsplash.com/photo-1582576163090-09d3b6f8a969?w=400&h=400&fit=crop" },
        { nome: "Chow Mein", desc: "Noodles saltati con verdure", kcal: 420, prot: 14, carb: 56, fat: 16, icon: "ðŸœ", img: "https://images.unsplash.com/photo-1585032226651-759b368d7246?w=400&h=400&fit=crop" }
    ],
    francese: [
        { nome: "Coq au Vin", desc: "Pollo brasato nel vino rosso", kcal: 480, prot: 35, carb: 12, fat: 28, icon: "ðŸ·", img: "https://images.unsplash.com/photo-1598515214211-89d3c73ae83b?w=400&h=400&fit=crop" },
        { nome: "Croissant", desc: "Sfoglia al burro francese", kcal: 320, prot: 6, carb: 38, fat: 18, icon: "ðŸ¥", img: "https://images.unsplash.com/photo-1555507036-ab1f4038808a?w=400&h=400&fit=crop" },
        { nome: "Quiche Lorraine", desc: "Torta salata con pancetta", kcal: 420, prot: 16, carb: 28, fat: 28, icon: "ðŸ¥§", img: "https://images.unsplash.com/photo-1527515545081-5db817172677?w=400&h=400&fit=crop" },
        { nome: "Bouillabaisse", desc: "Zuppa di pesce marsigliese", kcal: 380, prot: 32, carb: 18, fat: 18, icon: "ðŸŸ", img: "https://images.unsplash.com/photo-1534939561126-855b8675edd7?w=400&h=400&fit=crop" },
        { nome: "CrÃªpes Suzette", desc: "CrÃªpes flambÃ© all'arancia", kcal: 350, prot: 8, carb: 48, fat: 14, icon: "ðŸ¥ž", img: "https://images.unsplash.com/photo-1519676867240-f03562e64548?w=400&h=400&fit=crop" },
        { nome: "Ratatouille", desc: "Verdure provenzali stufate", kcal: 180, prot: 4, carb: 22, fat: 10, icon: "ðŸ†", img: "https://images.unsplash.com/photo-1572453800999-e8d2d1589b7c?w=400&h=400&fit=crop" }
    ],
    tedesca: [
        { nome: "Schnitzel", desc: "Cotoletta di maiale impanata", kcal: 520, prot: 32, carb: 28, fat: 32, icon: "ðŸ¥©", img: "https://images.unsplash.com/photo-1599921841143-819065a55cc6?w=400&h=400&fit=crop" },
        { nome: "Bratwurst", desc: "Salsiccia grigliata con crauti", kcal: 450, prot: 22, carb: 8, fat: 36, icon: "ðŸŒ­", img: "https://images.unsplash.com/photo-1617093727343-374698b1b08d?w=400&h=400&fit=crop" },
        { nome: "SpÃ¤tzle", desc: "Gnocchetti al formaggio", kcal: 480, prot: 16, carb: 52, fat: 24, icon: "ðŸ", img: "https://images.unsplash.com/photo-1595295333158-4742f28fbd85?w=400&h=400&fit=crop" },
        { nome: "Pretzel", desc: "Pane salato bavarese", kcal: 320, prot: 10, carb: 62, fat: 4, icon: "ðŸ¥¨", img: "https://images.unsplash.com/photo-1570145820259-b5b80c5c8bd6?w=400&h=400&fit=crop" },
        { nome: "Sauerbraten", desc: "Arrosto marinato all'aceto", kcal: 550, prot: 42, carb: 18, fat: 34, icon: "ðŸ¥©", img: "https://images.unsplash.com/photo-1544025162-d76694265947?w=400&h=400&fit=crop" },
        { nome: "Apfelstrudel", desc: "Strudel di mele", kcal: 380, prot: 6, carb: 58, fat: 14, icon: "ðŸŽ", img: "https://images.unsplash.com/photo-1568571780765-9276ac8b75a2?w=400&h=400&fit=crop" }
    ],
    greca: [
        { nome: "Moussaka", desc: "Sformato di melanzane e carne", kcal: 480, prot: 24, carb: 32, fat: 28, icon: "ðŸ†", img: "https://images.unsplash.com/photo-1598866594230-a7c12756260f?w=400&h=400&fit=crop" },
        { nome: "Gyros", desc: "Carne speziata in pita", kcal: 550, prot: 32, carb: 42, fat: 28, icon: "ðŸ¥™", img: "https://images.unsplash.com/photo-1561651823-34feb02250e4?w=400&h=400&fit=crop" },
        { nome: "Souvlaki", desc: "Spiedini di carne marinata", kcal: 380, prot: 35, carb: 8, fat: 22, icon: "ðŸ¢", img: "https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=400&h=400&fit=crop" },
        { nome: "Insalata Greca", desc: "Pomodori, feta, olive, cetrioli", kcal: 280, prot: 8, carb: 12, fat: 22, icon: "ðŸ¥—", img: "https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?w=400&h=400&fit=crop" },
        { nome: "Spanakopita", desc: "Torta di spinaci e feta", kcal: 320, prot: 12, carb: 28, fat: 18, icon: "ðŸ¥§", img: "https://images.unsplash.com/photo-1592417817098-8fd3d9eb14a5?w=400&h=400&fit=crop" },
        { nome: "Tzatziki", desc: "Salsa di yogurt e cetrioli", kcal: 120, prot: 6, carb: 8, fat: 8, icon: "ðŸ¥’", img: "https://images.unsplash.com/photo-1563379926898-05f4575a45d8?w=400&h=400&fit=crop" }
    ]
};

let currentCucinaFilter = 'tutte';
let ricetteAIResults = [];

function openCercaRicette() {
    const wrapper = document.getElementById('cercaRicetteWrapper');
    if (wrapper) {
        wrapper.classList.add('open');
        document.body.style.overflow = 'hidden';
        renderRicetteOnline();
    }
}

function closeCercaRicette() {
    const wrapper = document.getElementById('cercaRicetteWrapper');
    if (wrapper) {
        wrapper.classList.remove('open');
        document.body.style.overflow = '';
    }
    // Chiudi tendina e risultati
    closeDropdown();
    const results = document.getElementById('cercaAIResults');
    if (results) results.style.display = 'none';
}

function filtraCucina(tipo) {
    currentCucinaFilter = tipo;
    
    document.querySelectorAll('.cucina-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    renderRicetteOnline();
}

function renderRicetteOnline() {
    const container = document.getElementById('cercaRicetteContent');
    if (!container) return;
    
    let html = '';
    
    if (currentCucinaFilter === 'tutte') {
        for (const [cucina, ricette] of Object.entries(ricetteOnlineDatabase)) {
            html += renderSezioneRicette(cucina, ricette);
        }
    } else {
        const ricette = ricetteOnlineDatabase[currentCucinaFilter];
        if (ricette) {
            html += renderSezioneRicette(currentCucinaFilter, ricette);
        }
    }
    
    container.innerHTML = html || '<p style="text-align:center;color:#9ca3af;padding:40px;">Nessuna ricetta trovata</p>';
}

function renderSezioneRicette(cucina, ricette) {
    const bandiere = {
        italiana: 'ðŸ‡®ðŸ‡¹', americana: 'ðŸ‡ºðŸ‡¸', giapponese: 'ðŸ‡¯ðŸ‡µ', messicana: 'ðŸ‡²ðŸ‡½',
        indiana: 'ðŸ‡®ðŸ‡³', cinese: 'ðŸ‡¨ðŸ‡³', francese: 'ðŸ‡«ðŸ‡·', tedesca: 'ðŸ‡©ðŸ‡ª', greca: 'ðŸ‡¬ðŸ‡·'
    };
    
    const nomiCucina = {
        italiana: 'Cucina Italiana', americana: 'Cucina Americana', giapponese: 'Cucina Giapponese',
        messicana: 'Cucina Messicana', indiana: 'Cucina Indiana', cinese: 'Cucina Cinese',
        francese: 'Cucina Francese', tedesca: 'Cucina Tedesca', greca: 'Cucina Greca'
    };
    
    let html = `
        <div class="ricette-tipo-section">
            <h3 class="ricette-tipo-title">${bandiere[cucina] || 'ðŸ½ï¸'} ${nomiCucina[cucina] || cucina}</h3>
    `;
    
    ricette.forEach((r, i) => {
        const ricettaId = `${cucina}_${i}`;
        const isFav = recipes.some(rec => rec.nome.toLowerCase() === r.nome.toLowerCase() && rec.preferito);
        html += `
            <div class="ricetta-online-card" onclick="openRecipeDetailCard('${cucina}', ${i})">
                <img class="ricetta-online-img" src="${r.img}" alt="${r.nome}" onerror="this.style.display='none'">
                <div class="ricetta-online-info">
                    <p class="ricetta-online-nome">${r.nome}</p>
                    <p class="ricetta-online-desc">${r.desc}</p>
                    <div class="ricetta-online-tags">
                        <span class="ricetta-tag kcal">${r.kcal} Kcal</span>
                        <span class="ricetta-tag carb">${r.carb}g Carbo</span>
                        <span class="ricetta-tag prot">${r.prot}g Proteine</span>
                        <span class="ricetta-tag fat">${r.fat}g Grassi</span>
                    </div>
                </div>
                <button class="star-fav-btn ${isFav ? 'active' : ''}" id="starBtn_${ricettaId}" onclick="event.stopPropagation(); toggleStarOnline('${cucina}', ${i})">
                    <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                </button>
            </div>
        `;
    });
    
    html += '</div>';
    return html;
}

function onSearchInputChange(value) {
    const dropdown = document.getElementById('searchDropdownResults');
    if (!dropdown) return;
    
    const query = value.trim().toLowerCase();
    
    if (query.length < 2) {
        dropdown.style.display = 'none';
        return;
    }
    
    let risultati = [];
    for (const [cucina, ricette] of Object.entries(ricetteOnlineDatabase)) {
        ricette.forEach((r, i) => {
            if (r.nome.toLowerCase().includes(query) || r.desc.toLowerCase().includes(query)) {
                risultati.push({ ...r, cucina, index: i });
            }
        });
    }
    
    risultati = risultati.slice(0, 6);
    
    if (risultati.length === 0) {
        dropdown.style.display = 'none';
        return;
    }
    
    let html = '';
    
    risultati.forEach(r => {
        const isFav = recipes.some(rec => rec.nome.toLowerCase() === r.nome.toLowerCase() && rec.preferito);
        html += `
            <div class="ricetta-ai-mini-card" onclick="openRecipeDetailCard('${r.cucina}', ${r.index}); closeDropdown();">
                <img class="ricetta-ai-mini-img" src="${r.img}" alt="${r.nome}" onerror="this.style.display='none'">
                <div class="ricetta-ai-mini-info">
                    <p class="ricetta-ai-mini-nome">${r.nome}</p>
                    <p class="ricetta-ai-mini-kcal">${r.kcal} kcal Â· P:${r.prot}g Â· C:${r.carb}g Â· G:${r.fat}g</p>
                </div>
                <button class="star-fav-btn-mini ${isFav ? 'active' : ''}" onclick="event.stopPropagation(); toggleStarOnline('${r.cucina}', ${r.index}); onSearchInputChange(document.getElementById('cercaRicetteInput').value);">
                    <svg viewBox="0 0 24 24" fill="${isFav ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                </button>
            </div>
        `;
    });
    
    dropdown.innerHTML = html;
    dropdown.style.display = 'block';
    
    // Mostra overlay scuro
    const overlay = document.getElementById('searchOverlay');
    if (overlay) overlay.classList.add('active');
}

// Riapri tendina su focus se c'Ã¨ testo
function onSearchInputFocus() {
    const input = document.getElementById('cercaRicetteInput');
    if (input && input.value.trim().length >= 2) {
        // Piccolo delay per evitare conflitti con eventi
        setTimeout(() => {
            onSearchInputChange(input.value);
        }, 50);
    }
}

// Chiudi tendina
function closeDropdown() {
    const dropdown = document.getElementById('searchDropdownResults');
    if (dropdown) dropdown.style.display = 'none';
    
    // Nascondi overlay scuro
    const overlay = document.getElementById('searchOverlay');
    if (overlay) overlay.classList.remove('active');
}  
  
// Chiudi tendina cliccando fuori
document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('searchDropdownResults');
    const searchBox = document.querySelector('.cerca-ricette-search-box');
    
    if (dropdown && dropdown.style.display === 'block') {
        if (searchBox && !searchBox.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    }
}); 

function handleOverlayClick(event) {
    const searchBox = document.querySelector('.cerca-ricette-search-box');
    if (searchBox && !searchBox.contains(event.target)) {
        closeDropdown();
    }
}  
  
function aggiungiRicettaOnline(cucina, index) {
    const ricetta = ricetteOnlineDatabase[cucina][index];
    if (!ricetta) return;
    
    // Genera procedimento di default basato sulla ricetta
    const procedimentoDefault = [
        `Prepara tutti gli ingredienti per ${ricetta.nome}`,
        'Segui la preparazione tradizionale della ricetta',
        'Cuoci secondo i tempi indicati',
        'Impiatta e servi caldo'
    ];
    
    // Aggiungi alle ricette
    const nuovaRicetta = {
        nome: ricetta.nome,
        veg: false,
        ingredienti: ricetta.desc,
        kcal: ricetta.kcal,
        prot: ricetta.prot,
        carb: ricetta.carb,
        fat: ricetta.fat,
        descrizione: ricetta.desc || '',
        procedimento: ricetta.procedimento || procedimentoDefault,
        tempo: 30,
        porzioni: 2,
        immagine: ricetta.img || ''
    };
    
    // Controlla se esiste giÃ 
    const esiste = recipes.find(r => r.nome.toLowerCase() === nuovaRicetta.nome.toLowerCase());
    if (esiste) {
        if (typeof toast === 'function') toast('âš ï¸ Ricetta giÃ  presente!');
        return;
    }
    
    recipes.push(nuovaRicetta);
    
    if (typeof saveRecipeIndexed === 'function') saveRecipeIndexed();
    if (typeof renderRecipes === 'function') renderRecipes();
    if (typeof updateRecipeSelector === 'function') updateRecipeSelector();
    
    const btn = document.getElementById(`addBtn_${cucina}_${index}`);
    if (btn) {
        btn.textContent = 'âœ“ Aggiunto';
        btn.classList.add('added');
    }
    
    if (typeof toast === 'function') {
        toast(`âœ… "${ricetta.nome}" aggiunta!`);
    }
}

async function toggleStarOnline(cucina, index) {
    const ricetta = ricetteOnlineDatabase[cucina]?.[index];
    if (!ricetta) return;
    
    const btn = document.getElementById(`starBtn_${cucina}_${index}`);
    const esistente = recipes.find(r => r.nome.toLowerCase() === ricetta.nome.toLowerCase());
    
    if (esistente) {
        // Toggle preferito
        esistente.preferito = !esistente.preferito;
        if (btn) btn.classList.toggle('active', esistente.preferito);
        
        if (esistente.preferito) {
            // Se non ha ancora ingredienti/procedimento, generali
            if (!esistente.procedimento || esistente.procedimento.length === 0) {
                if (typeof toast === 'function') toast('â³ Generazione ricetta...');
                const datiIA = await generaDettagliRicettaIA(ricetta);
                if (datiIA) {
                    esistente.ingredienti = datiIA.ingredienti;
                    esistente.procedimento = datiIA.procedimento;
                    esistente.descrizione = datiIA.storia || esistente.descrizione;
                }
            }
            if (typeof toast === 'function') toast('â­ Aggiunta ai preferiti!');
        } else {
            if (typeof toast === 'function') toast('â˜† Rimossa dai preferiti');
        }
    } else {
        // Nuova ricetta - genera dati IA
        if (btn) btn.classList.add('active');
        if (typeof toast === 'function') toast('â³ Generazione ricetta...');
        
        const datiIA = await generaDettagliRicettaIA(ricetta);
        
        const nuovaRicetta = {
            nome: ricetta.nome,
            veg: false,
            ingredienti: datiIA ? datiIA.ingredienti : (ricetta.desc || ''),
            procedimento: datiIA ? datiIA.procedimento : [],
            descrizione: datiIA ? (datiIA.storia || ricetta.desc || '') : (ricetta.desc || ''),
            kcal: ricetta.kcal || 0,
            prot: ricetta.prot || 0,
            carb: ricetta.carb || 0,
            fat: ricetta.fat || 0,
            preferito: true,
            soloPreferito: true,
            tempo: 30,
            porzioni: 2,
            immagine: ricetta.img || ''
        };
        
        recipes.push(nuovaRicetta);
        if (typeof toast === 'function') toast('â­ Aggiunta ai preferiti!');
    }
    
    if (typeof saveRecipeIndexed === 'function') saveRecipeIndexed();
    
    // Sincronizza stellina dentro la card se aperta
    if (currentRecipeDetail && currentRecipeDetail.nome.toLowerCase() === ricetta.nome.toLowerCase()) {
        const starBtnCard = document.getElementById('recipeDetailStarBtn');
        const isFav = recipes.find(r => r.nome.toLowerCase() === ricetta.nome.toLowerCase())?.preferito;
        if (starBtnCard) {
            if (isFav) {
                starBtnCard.classList.add('active');
                starBtnCard.querySelector('svg').setAttribute('fill', 'currentColor');
                starBtnCard.querySelector('svg').setAttribute('stroke', 'currentColor');
            } else {
                starBtnCard.classList.remove('active');
                starBtnCard.querySelector('svg').setAttribute('fill', 'none');
                starBtnCard.querySelector('svg').setAttribute('stroke', 'currentColor');
            }
        }
    }
}
  
// Ricerca AI
async function cercaRicetteAI() {
    const input = document.getElementById('cercaRicetteInput');
    closeDropdown();
    const btn = document.getElementById('cercaRicetteBtn');
    const resultsDiv = document.getElementById('cercaAIResults');
    const query = input.value.trim();
    
    if (!query) {
        if (typeof toast === 'function') toast('âš ï¸ Scrivi cosa cercare');
        return;
    }
    
    // Loading
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;margin:0;"></div>';
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<div class="cerca-ricette-loading"><div class="spinner"></div><p>Cerco ricette...</p></div>';
    
    if (!groqApiKey) {
        // Fallback senza API
        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> Cerca';
            resultsDiv.innerHTML = `
                <div class="cerca-ai-results">
                    <p class="cerca-ai-results-title">âš ï¸ API non configurata</p>
                    <p style="color:#6b7280;font-size:13px;">Configura la chiave API Groq nelle Impostazioni per cercare ricette online.</p>
                </div>
            `;
        }, 1000);
        return;
    }
    
    try {
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${groqApiKey}`
            },
            body: JSON.stringify({
                model: 'llama-3.1-8b-instant',
                messages: [{
                    role: 'user',
                    content: `Sei un esperto chef. L'utente cerca: "${query}".
Genera ESATTAMENTE 15 ricette DIVERSE e SPECIFICHE per questa richiesta.
Se cerca un piatto specifico (es. "carbonara"), dai 10 varianti o piatti simili.
Se cerca una categoria (es. "pasta"), dai 15 piatti diversi di quella categoria.
Se cerca un ingrediente (es. "pollo"), dai 15 ricette con quell'ingrediente.

Rispondi SOLO con questo JSON, nient'altro:
[
  {"nome": "Nome Ricetta Completo", "desc": "Ingredienti principali in 10-15 parole", "kcal": 450, "prot": 22, "carb": 55, "fat": 18, "icon": "ðŸ"},
  {"nome": "Altra Ricetta", "desc": "Altri ingredienti principali", "kcal": 380, "prot": 28, "carb": 40, "fat": 15, "icon": "ðŸ¥—"}
]
IMPORTANTE: Valori nutrizionali REALISTICI per porzione. Nomi ricette in italiano.`
                }],
                max_tokens: 1500,
                temperature: 0.8
            })
        });
        
        const data = await response.json();
        const text = data.choices?.[0]?.message?.content || '';
        
        // Estrai JSON
        const jsonMatch = text.match(/\[[\s\S]*\]/);
        if (jsonMatch) {
            ricetteAIResults = JSON.parse(jsonMatch[0]);
            renderRicetteAIResults(query);
        } else {
            throw new Error('Formato non valido');
        }
        
    } catch (error) {
        console.error('Errore ricerca AI:', error);
        resultsDiv.innerHTML = `
            <div class="cerca-ai-results">
                <p class="cerca-ai-results-title">âŒ Errore nella ricerca</p>
                <p style="color:#6b7280;font-size:13px;">Riprova piÃ¹ tardi o controlla la connessione.</p>
            </div>
        `;
    }
    
    btn.disabled = false;
    btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> Cerca';
}

function renderRicetteAIResults(query) {
    const resultsDiv = document.getElementById('cercaAIResults');
    if (!resultsDiv || !ricetteAIResults.length) return;
    
    // Array di immagini di cibo reali e diverse
    const foodImages = [
        'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400&h=400&fit=crop',
        'https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=400&h=400&fit=crop',
        'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400&h=400&fit=crop',
        'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?w=400&h=400&fit=crop',
        'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=400&h=400&fit=crop',
        'https://images.unsplash.com/photo-1484723091739-30a097e8f929?w=400&h=400&fit=crop',
        'https://images.unsplash.com/photo-1473093295043-cdd812d0e601?w=400&h=400&fit=crop',
        'https://images.unsplash.com/photo-1482049016gy-958d08c5c0c6?w=400&h=400&fit=crop',
        'https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=400&h=400&fit=crop',
        'https://images.unsplash.com/photo-1493770348161-369560ae357d?w=400&h=400&fit=crop'
    ];
    
    let html = `
        <div class="cerca-ai-results">
            <p class="cerca-ai-results-title">Risultati per "${query}"</p>
            `;
    
    ricetteAIResults.forEach((r, i) => {
        const isFav = recipes.some(rec => rec.nome.toLowerCase() === r.nome.toLowerCase() && rec.preferito);
        // Scegli immagine basata su hash del nome per consistenza
        const hashCode = r.nome.split('').reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a; }, 0);
        const imgIndex = Math.abs(hashCode) % foodImages.length;
        const imgUrl = foodImages[imgIndex];
        
        html += `
            <div class="ricetta-online-card" onclick="openRecipeDetailCardAI(${i})">
                <img class="ricetta-online-img" src="${imgUrl}" alt="${r.nome}">
                <div class="ricetta-online-info">
                    <p class="ricetta-online-nome">${r.nome}</p>
                    <p class="ricetta-online-desc">${r.desc}</p>
                    <div class="ricetta-online-tags">
                        <span class="ricetta-tag kcal">${r.kcal} Kcal</span>
                        <span class="ricetta-tag carb">${r.carb}g Carbo</span>
                        <span class="ricetta-tag prot">${r.prot}g Proteine</span>
                        <span class="ricetta-tag fat">${r.fat}g Grassi</span>
                    </div>
                </div>
                <button class="star-fav-btn ${isFav ? 'active' : ''}" id="starBtnAI_${i}" onclick="event.stopPropagation(); toggleStarAI(${i})">
                    <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                </button>
            </div>
        `;
    });
    
    html += '</div>';
    resultsDiv.innerHTML = html;
}

function aggiungiRicettaAI(index) {
    const ricetta = ricetteAIResults[index];
    if (!ricetta) return;
    
    const nuovaRicetta = {
        nome: ricetta.nome,
        veg: false,
        ingredienti: ricetta.desc,
        kcal: ricetta.kcal || 0,
        prot: ricetta.prot || 0,
        carb: ricetta.carb || 0,
        fat: ricetta.fat || 0
    };
    
    const esiste = recipes.find(r => r.nome.toLowerCase() === nuovaRicetta.nome.toLowerCase());
    if (esiste) {
        if (typeof toast === 'function') toast('âš ï¸ Ricetta giÃ  presente!');
        return;
    }
    
    recipes.push(nuovaRicetta);
    
    if (typeof saveRecipeIndexed === 'function') saveRecipeIndexed();
    if (typeof renderRecipes === 'function') renderRecipes();
    if (typeof updateRecipeSelector === 'function') updateRecipeSelector();
    
    const btn = document.getElementById(`addBtnAI_${index}`);
    if (btn) {
        btn.textContent = 'âœ“ Aggiunto';
        btn.classList.add('added');
    }
    
    if (typeof toast === 'function') {
        toast(`âœ… "${ricetta.nome}" aggiunta!`);
    }
}
  
// ========== CARD DETTAGLIO RICETTA ONLINE ==========

let currentRecipeDetail = null;

function openRecipeDetailCard(cucina, index) {
    const ricetta = ricetteOnlineDatabase[cucina]?.[index];
    if (!ricetta) return;
    
    currentRecipeDetail = { cucina, index, ...ricetta };
    
    const nomiCucina = {
        italiana: 'Cucina Italiana', americana: 'Cucina Americana', giapponese: 'Cucina Giapponese',
        messicana: 'Cucina Messicana', indiana: 'Cucina Indiana', cinese: 'Cucina Cinese',
        francese: 'Cucina Francese', tedesca: 'Cucina Tedesca', greca: 'Cucina Greca'
    };
    
    // Popola immagine
    const imgEl = document.getElementById('recipeDetailImg');
    if (imgEl) imgEl.src = ricetta.img || 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=800';
    
    // Popola titolo e cucina
    document.getElementById('recipeDetailTitle').textContent = ricetta.nome;
    document.getElementById('recipeDetailCuisine').textContent = nomiCucina[cucina] || cucina;
    document.getElementById('recipeDetailDesc').textContent = ricetta.desc;
    
    // Popola macro
    document.getElementById('macroKcal').textContent = ricetta.kcal;
    document.getElementById('macroProt').textContent = ricetta.prot + 'g';
    document.getElementById('macroCarb').textContent = ricetta.carb + 'g';
    document.getElementById('macroFat').textContent = ricetta.fat + 'g';
    
    // Reset campi IA
    document.getElementById('recipeDetailIngredients').innerHTML = `
        <li class="recipe-detail-ingredient">
            <div class="recipe-detail-ingredient-left">
                <span class="recipe-detail-ingredient-dot"></span>
                <span class="recipe-detail-ingredient-name recipe-detail-loading">â³ Caricamento...</span>
            </div>
        </li>
    `;
    document.getElementById('recipeDetailSteps').innerHTML = `
        <div class="recipe-detail-steps-line"></div>
        <div class="recipe-detail-step">
            <div class="recipe-detail-step-dot"></div>
            <p class="recipe-detail-step-text recipe-detail-loading">â³ Caricamento...</p>
        </div>
    `;
    document.getElementById('recipeDetailHistory').textContent = 'â³ Caricamento...';
    
    // Controlla stato stellina (preferiti)
    const esistente = recipes.find(r => r.nome.toLowerCase() === ricetta.nome.toLowerCase());
    const isFav = esistente && esistente.preferito;
    const starBtn = document.getElementById('recipeDetailStarBtn');
    if (starBtn) {
        if (isFav) {
            starBtn.classList.add('active');
            starBtn.querySelector('svg').setAttribute('fill', 'currentColor');
        } else {
            starBtn.classList.remove('active');
            starBtn.querySelector('svg').setAttribute('fill', 'none');
        }
    }
    
    // Controlla stato bottone salva (salvata = esiste E non Ã¨ soloPreferito)
    const saveBtn = document.getElementById('recipeDetailSaveBtn');
    const saveBtnText = saveBtn?.querySelector('.recipe-detail-save-btn-text');
    const isSaved = esistente && !esistente.soloPreferito;
    if (isSaved) {
        saveBtn?.classList.add('saved');
        if (saveBtnText) saveBtnText.textContent = 'âœ“ Salvata';
    } else {
        saveBtn?.classList.remove('saved');
        if (saveBtnText) saveBtnText.textContent = 'Salva Ricetta';
    }
    
    // Mostra card
    document.getElementById('recipeDetailOverlay').classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Carica dettagli con IA
    loadRecipeDetailAI(ricetta);
}

function closeRecipeDetailCard(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('recipeDetailOverlay').classList.remove('show');
    document.body.style.overflow = '';
    currentRecipeDetail = null;
}

async function loadRecipeDetailAI(ricetta) {
    if (!groqApiKey) {
        document.getElementById('recipeDetailIngredients').innerHTML = `
            <li class="recipe-detail-ingredient">
                <div class="recipe-detail-ingredient-left">
                    <span class="recipe-detail-ingredient-dot"></span>
                    <span class="recipe-detail-ingredient-name">Configura API Groq nelle impostazioni</span>
                </div>
            </li>
        `;
        document.getElementById('recipeDetailSteps').innerHTML = `
            <div class="recipe-detail-steps-line"></div>
            <div class="recipe-detail-step">
                <div class="recipe-detail-step-dot"></div>
                <p class="recipe-detail-step-text">Configura API Groq nelle impostazioni</p>
            </div>
        `;
        document.getElementById('recipeDetailHistory').textContent = 'Configura API Groq nelle impostazioni per vedere i dettagli.';
        return;
    }
    
    try {
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${groqApiKey}`
            },
            body: JSON.stringify({
                model: 'llama-3.1-8b-instant',
                messages: [{
                    role: 'user',
                    content: `Per la ricetta "${ricetta.nome}" (${ricetta.desc}), dammi in italiano:

1. INGREDIENTI: lista per 2 persone con quantitÃ 
2. PROCEDIMENTO: 4-5 passaggi brevi
3. STORIA: 2 frasi sull'origine

Rispondi SOLO in questo formato JSON senza altro testo:
{"ingredienti": [{"nome": "Spaghetti", "quantita": "320g"}, {"nome": "Aglio", "quantita": "2 spicchi"}], "procedimento": ["Cuocere la pasta...", "Rosolare l'aglio..."], "storia": "Storia del piatto..."}`
                }],
                max_tokens: 700,
                temperature: 0.7
            })
        });
        
        const data = await response.json();
        const text = data.choices?.[0]?.message?.content || '';
        
        try {
            const jsonMatch = text.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const parsed = JSON.parse(jsonMatch[0]);
                
                // Prepara array ingredienti per salvataggio
                let ingredientiArray = [];
                
                // Popola ingredienti
                if (parsed.ingredienti && Array.isArray(parsed.ingredienti)) {
                    let ingredientiHtml = '';
                    parsed.ingredienti.forEach(ing => {
                        const nome = typeof ing === 'string' ? ing : (ing.nome || ing);
                        const qty = typeof ing === 'object' ? (ing.quantita || '') : '';
                        ingredientiArray.push(qty ? `${qty} ${nome}` : nome);
                        ingredientiHtml += `
                            <li class="recipe-detail-ingredient">
                                <div class="recipe-detail-ingredient-left">
                                    <span class="recipe-detail-ingredient-dot"></span>
                                    <span class="recipe-detail-ingredient-name">${nome}</span>
                                </div>
                                ${qty ? `<span class="recipe-detail-ingredient-qty">${qty}</span>` : ''}
                            </li>
                        `;
                    });
                    document.getElementById('recipeDetailIngredients').innerHTML = ingredientiHtml;
                } else if (typeof parsed.ingredienti === 'string') {
                    const ingList = parsed.ingredienti.split(/\\n|\n/).filter(i => i.trim());
                    let ingredientiHtml = '';
                    ingList.forEach(ing => {
                        ingredientiArray.push(ing.trim());
                        ingredientiHtml += `
                            <li class="recipe-detail-ingredient">
                                <div class="recipe-detail-ingredient-left">
                                    <span class="recipe-detail-ingredient-dot"></span>
                                    <span class="recipe-detail-ingredient-name">${ing.trim()}</span>
                                </div>
                            </li>
                        `;
                    });
                    document.getElementById('recipeDetailIngredients').innerHTML = ingredientiHtml;
                }
                
                // Prepara array procedimento per salvataggio
                let procedimentoArray = [];
                
                // Popola procedimento
                if (parsed.procedimento && Array.isArray(parsed.procedimento)) {
                    let stepsHtml = '<div class="recipe-detail-steps-line"></div>';
                    parsed.procedimento.forEach(step => {
                        const stepText = step.replace(/^\d+\.\s*/, '');
                        procedimentoArray.push(stepText);
                        stepsHtml += `
                            <div class="recipe-detail-step">
                                <div class="recipe-detail-step-dot"></div>
                                <p class="recipe-detail-step-text">${stepText}</p>
                            </div>
                        `;
                    });
                    document.getElementById('recipeDetailSteps').innerHTML = stepsHtml;
                } else if (typeof parsed.procedimento === 'string') {
                    const stepList = parsed.procedimento.split(/\\n|\n/).filter(s => s.trim());
                    let stepsHtml = '<div class="recipe-detail-steps-line"></div>';
                    stepList.forEach(step => {
                        const stepText = step.replace(/^\d+\.\s*/, '').trim();
                        procedimentoArray.push(stepText);
                        stepsHtml += `
                            <div class="recipe-detail-step">
                                <div class="recipe-detail-step-dot"></div>
                                <p class="recipe-detail-step-text">${stepText}</p>
                            </div>
                        `;
                    });
                    document.getElementById('recipeDetailSteps').innerHTML = stepsHtml;
                }
                
                // Popola storia
                if (parsed.storia) {
                    document.getElementById('recipeDetailHistory').textContent = parsed.storia;
                }
                
                // SALVA I DATI GENERATI IN currentRecipeDetail
                if (currentRecipeDetail) {
                    currentRecipeDetail.ingredientiGenerati = ingredientiArray;
                    currentRecipeDetail.procedimentoGenerato = procedimentoArray;
                    currentRecipeDetail.storiaGenerata = parsed.storia || '';
                    currentRecipeDetail.datiIACaricati = true;
                }
            } else {
                extractManualContent(text);
            }
        } catch (parseError) {
            console.log('Parsing fallback per risposta IA');
            extractManualContent(text);
        }
    } catch (error) {
        console.error('Errore caricamento dettagli:', error);
        document.getElementById('recipeDetailIngredients').innerHTML = `
            <li class="recipe-detail-ingredient">
                <div class="recipe-detail-ingredient-left">
                    <span class="recipe-detail-ingredient-dot"></span>
                    <span class="recipe-detail-ingredient-name">Errore nel caricamento</span>
                </div>
            </li>
        `;
        document.getElementById('recipeDetailSteps').innerHTML = `
            <div class="recipe-detail-steps-line"></div>
            <div class="recipe-detail-step">
                <div class="recipe-detail-step-dot"></div>
                <p class="recipe-detail-step-text">Errore nel caricamento</p>
            </div>
        `;
        document.getElementById('recipeDetailHistory').textContent = 'Errore nel caricamento';
    }
}

// Funzione per generare dettagli ricetta con IA (usata dalle stelline)
async function generaDettagliRicettaIA(ricetta) {
    if (!groqApiKey) {
        console.log('API Groq non configurata');
        return null;
    }
    
    try {
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${groqApiKey}`
            },
            body: JSON.stringify({
                model: 'llama-3.1-8b-instant',
                messages: [{
                    role: 'user',
                    content: `Per la ricetta "${ricetta.nome}" (${ricetta.desc || ''}), dammi in italiano:

1. INGREDIENTI: lista per 2 persone con quantitÃ 
2. PROCEDIMENTO: 4-5 passaggi brevi
3. STORIA: 2 frasi sull'origine

Rispondi SOLO in questo formato JSON senza altro testo:
{"ingredienti": [{"nome": "Spaghetti", "quantita": "320g"}, {"nome": "Aglio", "quantita": "2 spicchi"}], "procedimento": ["Cuocere la pasta...", "Rosolare l'aglio..."], "storia": "Storia del piatto..."}`
                }],
                max_tokens: 700,
                temperature: 0.7
            })
        });
        
        const data = await response.json();
        const text = data.choices?.[0]?.message?.content || '';
        
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
            const parsed = JSON.parse(jsonMatch[0]);
            
            // Prepara ingredienti come stringa
            let ingredientiStr = '';
            if (parsed.ingredienti && Array.isArray(parsed.ingredienti)) {
                ingredientiStr = parsed.ingredienti.map(ing => {
                    const nome = typeof ing === 'string' ? ing : (ing.nome || ing);
                    const qty = typeof ing === 'object' ? (ing.quantita || '') : '';
                    return qty ? `${qty} ${nome}` : nome;
                }).join(', ');
            } else if (typeof parsed.ingredienti === 'string') {
                ingredientiStr = parsed.ingredienti;
            }
            
            // Prepara procedimento come array
            let procedimentoArr = [];
            if (parsed.procedimento && Array.isArray(parsed.procedimento)) {
                procedimentoArr = parsed.procedimento.map(step => step.replace(/^\d+\.\s*/, ''));
            } else if (typeof parsed.procedimento === 'string') {
                procedimentoArr = parsed.procedimento.split(/\\n|\n/).filter(s => s.trim()).map(s => s.replace(/^\d+\.\s*/, '').trim());
            }
            
            return {
                ingredienti: ingredientiStr,
                procedimento: procedimentoArr,
                storia: parsed.storia || ''
            };
        }
        
        return null;
    } catch (error) {
        console.error('Errore generazione dettagli IA:', error);
        return null;
    }
}  
  
function extractManualContent(text) {
    // Ingredienti
    const ingMatch = text.match(/"ingredienti"\s*:\s*"([^"]+)"/);
    if (ingMatch) {
        const ingList = ingMatch[1].split(/\\n|\n/).filter(i => i.trim());
        let ingredientiHtml = '';
        ingList.forEach(ing => {
            ingredientiHtml += `
                <li class="recipe-detail-ingredient">
                    <div class="recipe-detail-ingredient-left">
                        <span class="recipe-detail-ingredient-dot"></span>
                        <span class="recipe-detail-ingredient-name">${ing.trim()}</span>
                    </div>
                </li>
            `;
        });
        document.getElementById('recipeDetailIngredients').innerHTML = ingredientiHtml;
    }
    
    // Procedimento
    const procMatch = text.match(/"procedimento"\s*:\s*"([^"]+)"/);
    if (procMatch) {
        const stepList = procMatch[1].split(/\\n|\n/).filter(s => s.trim());
        let stepsHtml = '<div class="recipe-detail-steps-line"></div>';
        stepList.forEach(step => {
            const stepText = step.replace(/^\d+\.\s*/, '').trim();
            stepsHtml += `
                <div class="recipe-detail-step">
                    <div class="recipe-detail-step-dot"></div>
                    <p class="recipe-detail-step-text">${stepText}</p>
                </div>
            `;
        });
        document.getElementById('recipeDetailSteps').innerHTML = stepsHtml;
    }
    
    // Storia
    const storiaMatch = text.match(/"storia"\s*:\s*"([^"]+)"/);
    if (storiaMatch) {
        document.getElementById('recipeDetailHistory').textContent = storiaMatch[1];
    }
}
  
// Aggiunge/rimuove dai PREFERITI (stellina) - NON tocca il bottone salva
function toggleRecipeDetailFavorite() {
    if (!currentRecipeDetail) return;
    
    const ricetta = currentRecipeDetail;
    const starBtn = document.getElementById('recipeDetailStarBtn');
    
    // Cerca se esiste giÃ  nelle ricette salvate
    let esistente = recipes.find(r => r.nome.toLowerCase() === ricetta.nome.toLowerCase());
    
    if (esistente) {
        // Toggle preferito su ricetta esistente
        esistente.preferito = !esistente.preferito;
        
        // AGGIORNA anche i dati IA se disponibili
        if (ricetta.datiIACaricati) {
            if (ricetta.ingredientiGenerati && ricetta.ingredientiGenerati.length > 0) {
                esistente.ingredienti = Array.isArray(ricetta.ingredientiGenerati) ? ricetta.ingredientiGenerati.join(', ') : ricetta.ingredientiGenerati;
            }
            if (ricetta.procedimentoGenerato && ricetta.procedimentoGenerato.length > 0) {
                esistente.procedimento = ricetta.procedimentoGenerato;
            }
            if (ricetta.storiaGenerata) {
                esistente.descrizione = ricetta.storiaGenerata;
            }
        }
      
        if (esistente.preferito) {
            starBtn?.classList.add('active');
            if (starBtn) {
                starBtn.querySelector('svg').setAttribute('fill', 'currentColor');
                starBtn.querySelector('svg').setAttribute('stroke', 'currentColor');
            }
            if (typeof toast === 'function') toast('â­ Aggiunta ai preferiti!');
        } else {
            starBtn?.classList.remove('active');
            if (starBtn) {
                starBtn.querySelector('svg').setAttribute('fill', 'none');
                starBtn.querySelector('svg').setAttribute('stroke', 'currentColor');
            }
            if (typeof toast === 'function') toast('â˜† Rimossa dai preferiti');
        }
    } else {
        // Non esiste: crea nuova ricetta SOLO come preferito (non salvata come "mia ricetta")
        const nuovaRicetta = {
            nome: ricetta.nome,
            veg: false,
            ingredienti: Array.isArray(ricetta.ingredientiGenerati) ? ricetta.ingredientiGenerati.join(', ') : (ricetta.desc || ricetta.ingredienti || ''),
            procedimento: ricetta.procedimentoGenerato || [],
            descrizione: ricetta.storiaGenerata || ricetta.desc || '',
            kcal: ricetta.kcal || 0,
            prot: ricetta.prot || 0,
            carb: ricetta.carb || 0,
            fat: ricetta.fat || 0,
            tempo: 30,
            porzioni: 2,
            preferito: true,
            soloPreferito: true,
            immagine: ricetta.img || document.getElementById('recipeDetailImg')?.src || ''
        };
        
        recipes.push(nuovaRicetta);
        
        starBtn?.classList.add('active');
        if (starBtn) {
            starBtn.querySelector('svg').setAttribute('fill', 'currentColor');
            starBtn.querySelector('svg').setAttribute('stroke', 'currentColor');
        }
        
        if (typeof toast === 'function') toast('â­ Aggiunta ai preferiti!');
        
        // NON tocchiamo il bottone salva - rimane separato
    }
    
    // Salva
    if (typeof saveRecipeIndexed === 'function') saveRecipeIndexed();
    
    // Sincronizza stelline nei riquadri delle ricette online
    sincronizzaStellineEsterne(ricetta);
}

// Funzione per sincronizzare le stelline esterne (nei riquadri)
function sincronizzaStellineEsterne(ricetta) {
    const nomeRicetta = ricetta.nome.toLowerCase();
    const esistente = recipes.find(r => r.nome.toLowerCase() === nomeRicetta);
    const isFav = esistente && esistente.preferito;
    
    // Sincronizza stellina nelle ricette predefinite (per cucina e index)
    if (ricetta.cucina && ricetta.cucina !== 'ai') {
        const starBtnPredefinita = document.getElementById(`starBtn_${ricetta.cucina}_${ricetta.index}`);
        if (starBtnPredefinita) {
            if (isFav) {
                starBtnPredefinita.classList.add('active');
            } else {
                starBtnPredefinita.classList.remove('active');
            }
        }
    }
    
    // Sincronizza stellina nelle ricette AI
    if (ricetta.cucina === 'ai' || ricetta.index !== undefined) {
        const starBtnAI = document.getElementById(`starBtnAI_${ricetta.index}`);
        if (starBtnAI) {
            if (isFav) {
                starBtnAI.classList.add('active');
            } else {
                starBtnAI.classList.remove('active');
            }
        }
    }
    
    // Sincronizza anche le stelline mini nel dropdown di ricerca
    document.querySelectorAll('.star-fav-btn-mini').forEach(btn => {
        // Controlla se questa stellina appartiene alla stessa ricetta
        const cardParent = btn.closest('.ricetta-ai-mini-card');
        if (cardParent) {
            const nomeEl = cardParent.querySelector('.ricetta-ai-mini-nome');
            if (nomeEl && nomeEl.textContent.toLowerCase() === nomeRicetta) {
                if (isFav) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
        }
    });
    
    // Sincronizza stelline nelle card grandi delle ricette online
    document.querySelectorAll('.star-fav-btn').forEach(btn => {
        const cardParent = btn.closest('.ricetta-online-card');
        if (cardParent) {
            const nomeEl = cardParent.querySelector('.ricetta-online-nome');
            if (nomeEl && nomeEl.textContent.toLowerCase() === nomeRicetta) {
                if (isFav) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
        }
    });
}

// Salva/Rimuovi dalle MIE RICETTE (sezione Salvate) - SEPARATO dai preferiti
function saveRecipeDetailAsCustom() {
    if (!currentRecipeDetail) return;
    
    const ricetta = currentRecipeDetail;
    const saveBtn = document.getElementById('recipeDetailSaveBtn');
    const saveBtnText = saveBtn?.querySelector('.recipe-detail-save-btn-text');
    
    // Controlla se esiste giÃ 
    let esistente = recipes.find(r => r.nome.toLowerCase() === ricetta.nome.toLowerCase());
    
    if (esistente) {
        // Se Ã¨ salvata (non soloPreferito), rimuovila
        if (!esistente.soloPreferito) {
            // Chiedi conferma
            if (confirm(`Vuoi rimuovere "${ricetta.nome}" dalle tue ricette salvate?`)) {
                // Se Ã¨ anche preferita, convertila in soloPreferito
                if (esistente.preferito) {
                    esistente.soloPreferito = true;
                    if (typeof toast === 'function') toast('ðŸ—‘ï¸ Rimossa dalle ricette salvate (resta nei preferiti)');
                } else {
                    // Rimuovi completamente
                    const idx = recipes.indexOf(esistente);
                    if (idx > -1) recipes.splice(idx, 1);
                    if (typeof toast === 'function') toast('ðŸ—‘ï¸ Ricetta rimossa!');
                }
                
                saveBtn?.classList.remove('saved');
                if (saveBtnText) saveBtnText.textContent = 'Salva Ricetta';
            }
        } else {
            // Era soloPreferito, ora la salviamo veramente
            delete esistente.soloPreferito;
            
            // AGGIORNA i dati IA se disponibili
            if (ricetta.datiIACaricati) {
                if (ricetta.ingredientiGenerati && ricetta.ingredientiGenerati.length > 0) {
                    esistente.ingredienti = Array.isArray(ricetta.ingredientiGenerati) ? ricetta.ingredientiGenerati.join(', ') : ricetta.ingredientiGenerati;
                }
                if (ricetta.procedimentoGenerato && ricetta.procedimentoGenerato.length > 0) {
                    esistente.procedimento = ricetta.procedimentoGenerato;
                }
                if (ricetta.storiaGenerata) {
                    esistente.descrizione = ricetta.storiaGenerata;
                }
                esistente.immagine = ricetta.img || document.getElementById('recipeDetailImg')?.src || '';
                esistente.tempo = 30;
                esistente.porzioni = 2;
            }
            
            saveBtn?.classList.add('saved');
            if (saveBtnText) saveBtnText.textContent = 'âœ“ Salvata';
            if (typeof toast === 'function') toast(`âœ… "${ricetta.nome}" salvata!`);
        }
    } else {
        // Non esiste: aggiungi come ricetta salvata COMPLETA
        const nuovaRicetta = {
            nome: ricetta.nome,
            veg: false,
            ingredienti: Array.isArray(ricetta.ingredientiGenerati) ? ricetta.ingredientiGenerati.join(', ') : (ricetta.desc || ricetta.ingredienti || ''),
            procedimento: ricetta.procedimentoGenerato || [],
            descrizione: ricetta.storiaGenerata || ricetta.desc || '',
            kcal: ricetta.kcal || 0,
            prot: ricetta.prot || 0,
            carb: ricetta.carb || 0,
            fat: ricetta.fat || 0,
            tempo: 30,
            porzioni: 2,
            preferito: false,
            immagine: ricetta.img || document.getElementById('recipeDetailImg')?.src || ''
        };
        
        recipes.push(nuovaRicetta);
        
        saveBtn?.classList.add('saved');
        if (saveBtnText) saveBtnText.textContent = 'âœ“ Salvata';
        if (typeof toast === 'function') toast(`âœ… "${ricetta.nome}" salvata!`);
    }
    
    // Salva e aggiorna liste
    if (typeof saveRecipeIndexed === 'function') saveRecipeIndexed();
    if (typeof renderRecipes === 'function') renderRecipes();
    if (typeof updateRecipeSelector === 'function') updateRecipeSelector();
}

function openRecipeDetailCardAI(index) {
    const ricetta = ricetteAIResults[index];
    if (!ricetta) {
        console.error('Ricetta AI non trovata per index:', index);
        return;
    }
    
    currentRecipeDetail = { cucina: 'ai', index: index, ...ricetta };
    
    // Array di immagini di cibo per le ricette AI
    const foodImages = [
        'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=800',
        'https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=800',
        'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=800',
        'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?w=800',
        'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=800',
        'https://images.unsplash.com/photo-1484723091739-30a097e8f929?w=800'
    ];
    
    // Scegli immagine basata su hash del nome
    const hashCode = ricetta.nome.split('').reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a; }, 0);
    const imgIndex = Math.abs(hashCode) % foodImages.length;
    
    // Popola immagine
    const imgEl = document.getElementById('recipeDetailImg');
    if (imgEl) imgEl.src = foodImages[imgIndex];
    
    // Popola titolo e cucina
    document.getElementById('recipeDetailTitle').textContent = ricetta.nome;
    document.getElementById('recipeDetailCuisine').textContent = 'âœ¨ Ricetta trovata con IA';
    document.getElementById('recipeDetailDesc').textContent = ricetta.desc || '';
    
    // Popola macro usando gli elementi esistenti
    document.getElementById('macroKcal').textContent = ricetta.kcal || 0;
    document.getElementById('macroProt').textContent = (ricetta.prot || 0) + 'g';
    document.getElementById('macroCarb').textContent = (ricetta.carb || 0) + 'g';
    document.getElementById('macroFat').textContent = (ricetta.fat || 0) + 'g';
    
    // Reset campi IA per ingredienti/procedimento
    document.getElementById('recipeDetailIngredients').innerHTML = `
        <li class="recipe-detail-ingredient">
            <div class="recipe-detail-ingredient-left">
                <span class="recipe-detail-ingredient-dot"></span>
                <span class="recipe-detail-ingredient-name recipe-detail-loading">â³ Caricamento...</span>
            </div>
        </li>
    `;
    document.getElementById('recipeDetailSteps').innerHTML = `
        <div class="recipe-detail-steps-line"></div>
        <div class="recipe-detail-step">
            <div class="recipe-detail-step-dot"></div>
            <p class="recipe-detail-step-text recipe-detail-loading">â³ Caricamento...</p>
        </div>
    `;
    document.getElementById('recipeDetailHistory').textContent = 'â³ Caricamento...';
    
    // Controlla stato stellina (preferiti)
    const esistente = recipes.find(r => r.nome.toLowerCase() === ricetta.nome.toLowerCase());
    const isFav = esistente && esistente.preferito;
    const starBtn = document.getElementById('recipeDetailStarBtn');
    if (starBtn) {
        if (isFav) {
            starBtn.classList.add('active');
            starBtn.querySelector('svg').setAttribute('fill', 'currentColor');
        } else {
            starBtn.classList.remove('active');
            starBtn.querySelector('svg').setAttribute('fill', 'none');
        }
    }
    
    // Controlla stato bottone salva (salvata = esiste E non Ã¨ soloPreferito)
    const saveBtn = document.getElementById('recipeDetailSaveBtn');
    const saveBtnText = saveBtn?.querySelector('.recipe-detail-save-btn-text');
    const isSaved = esistente && !esistente.soloPreferito;
    if (isSaved) {
        saveBtn?.classList.add('saved');
        if (saveBtnText) saveBtnText.textContent = 'âœ“ Salvata';
    } else {
        saveBtn?.classList.remove('saved');
        if (saveBtnText) saveBtnText.textContent = 'Salva Ricetta';
    }
    
    // Mostra card
    document.getElementById('recipeDetailOverlay').classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Carica dettagli con IA
    loadRecipeDetailAI(ricetta);
}

async function toggleStarAI(index) {
    const ricetta = ricetteAIResults[index];
    if (!ricetta) return;
    
    const btn = document.getElementById(`starBtnAI_${index}`);
    const esistente = recipes.find(r => r.nome.toLowerCase() === ricetta.nome.toLowerCase());
    
    if (esistente) {
        // Toggle preferito
        esistente.preferito = !esistente.preferito;
        if (btn) btn.classList.toggle('active', esistente.preferito);
        
        if (esistente.preferito) {
            // Se non ha ancora ingredienti/procedimento, generali
            if (!esistente.procedimento || esistente.procedimento.length === 0) {
                if (typeof toast === 'function') toast('â³ Generazione ricetta...');
                const datiIA = await generaDettagliRicettaIA(ricetta);
                if (datiIA) {
                    esistente.ingredienti = datiIA.ingredienti;
                    esistente.procedimento = datiIA.procedimento;
                    esistente.descrizione = datiIA.storia || esistente.descrizione;
                }
            }
            if (typeof toast === 'function') toast('â­ Aggiunta ai preferiti!');
        } else {
            if (typeof toast === 'function') toast('â˜† Rimossa dai preferiti');
        }
    } else {
        // Nuova ricetta - genera dati IA
        if (btn) btn.classList.add('active');
        if (typeof toast === 'function') toast('â³ Generazione ricetta...');
        
        const datiIA = await generaDettagliRicettaIA(ricetta);
        
        const nuovaRicetta = {
            nome: ricetta.nome,
            veg: false,
            ingredienti: datiIA ? datiIA.ingredienti : (ricetta.desc || ''),
            procedimento: datiIA ? datiIA.procedimento : [],
            descrizione: datiIA ? (datiIA.storia || ricetta.desc || '') : (ricetta.desc || ''),
            kcal: ricetta.kcal || 0,
            prot: ricetta.prot || 0,
            carb: ricetta.carb || 0,
            fat: ricetta.fat || 0,
            tempo: 30,
            porzioni: 2,
            preferito: true,
            soloPreferito: true,
            immagine: ''
        };
        
        recipes.push(nuovaRicetta);
        if (typeof toast === 'function') toast('â­ Aggiunta ai preferiti!');
    }
    
    if (typeof saveRecipeIndexed === 'function') saveRecipeIndexed();
    
    // Sincronizza stellina dentro la card se aperta
    if (currentRecipeDetail && currentRecipeDetail.nome.toLowerCase() === ricetta.nome.toLowerCase()) {
        const starBtnCard = document.getElementById('recipeDetailStarBtn');
        const isFav = recipes.find(r => r.nome.toLowerCase() === ricetta.nome.toLowerCase())?.preferito;
        if (starBtnCard) {
            if (isFav) {
                starBtnCard.classList.add('active');
                starBtnCard.querySelector('svg').setAttribute('fill', 'currentColor');
                starBtnCard.querySelector('svg').setAttribute('stroke', 'currentColor');
            } else {
                starBtnCard.classList.remove('active');
                starBtnCard.querySelector('svg').setAttribute('fill', 'none');
                starBtnCard.querySelector('svg').setAttribute('stroke', 'currentColor');
            }
        }
    }
}

// ========== CARD SELEZIONE QUANTITÃ€ ==========

let qtySelectRecipe = null;

function openQtySelect(index, nome, kcal) {
    qtySelectRecipe = { index, nome, kcal };
    
    document.getElementById('qtySelectTitle').textContent = nome;
    document.getElementById('qtySelectSubtitle').textContent = `${kcal || 0} kcal per porzione`;
    document.getElementById('qtySelectNumber').value = 1;
    document.getElementById('qtySelectUnit').value = 'porzione';
    
// Reset preset attivi e attiva "1 porz."
    document.querySelectorAll('.qty-preset-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.qty-preset-btn').forEach(btn => {
        if (btn.textContent.trim() === '1 porz.') btn.classList.add('active');
    });  
  
    document.getElementById('qtySelectOverlay').classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Chiudi dropdown
    const rd = document.getElementById('recipeDropdownList');
    if (rd) rd.classList.remove('show');
}

function closeQtySelect(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('qtySelectOverlay').classList.remove('show');
    document.body.style.overflow = '';
    qtySelectRecipe = null;
}

function setQtyPreset(value, unit) {
    document.getElementById('qtySelectNumber').value = value;
    document.getElementById('qtySelectUnit').value = unit;
    
    // Rimuovi active da tutti i preset
    document.querySelectorAll('.qty-preset-btn').forEach(btn => btn.classList.remove('active'));
    
    // Trova e attiva il pulsante cliccato
    const presetText = unit === 'porzione' ? 
        (value === 0.5 ? 'Â½ porz.' : value + ' porz.') : 
        value + 'g';
    
    document.querySelectorAll('.qty-preset-btn').forEach(btn => {
        if (btn.textContent.trim() === presetText) {
            btn.classList.add('active');
        }
    });
}

function confirmQtySelect() {
    if (!qtySelectRecipe) return;
    
    const qty = parseFloat(document.getElementById('qtySelectNumber').value) || 1;
    const unit = document.getElementById('qtySelectUnit').value;
    
    // Calcola moltiplicatore in base all'unitÃ 
    let multiplier = qty;
    
    if (unit === 'grammi') {
        multiplier = qty / 100;
    } else if (unit === 'etto') {
        multiplier = qty;
    } else if (unit === 'kg') {
        multiplier = qty * 10;
    } else if (unit === 'ml') {
        multiplier = qty / 100;
    } else if (unit === 'litro') {
        multiplier = qty * 10;
    } else if (unit === 'cucchiaio') {
        multiplier = qty * 0.15;
    } else if (unit === 'cucchiaino') {
        multiplier = qty * 0.05;
    } else if (unit === 'tazza') {
        multiplier = qty * 2.5;
    } else if (unit === 'bicchiere') {
        multiplier = qty * 2;
    } else if (unit === 'fetta' || unit === 'pezzo') {
        multiplier = qty * 0.5;
    } else if (unit === 'manciata') {
        multiplier = qty * 0.3;
    }
    
    // Salva selezione corrente
    currentQtySelection = {
        index: qtySelectRecipe.index,
        nome: qtySelectRecipe.nome,
        kcal: qtySelectRecipe.kcal,
        qty: qty,
        unit: unit,
        multiplier: multiplier
    };
    
    // Mostra selezione
    document.getElementById('quickSelectionName').textContent = qtySelectRecipe.nome;
    document.getElementById('quickSelectionQty').textContent = `${qty} ${unit}`;
    document.getElementById('quickSelectionDisplay').style.display = 'flex';
    
    // Chiudi card
    closeQtySelect();
    
    // Chiudi anche filtri
    const filters = document.getElementById('quickSearchFilters');
    if (filters) filters.classList.remove('show');
}

function editQtySelection() {
    if (!currentQtySelection) return;
    
    // Riapri card con valori salvati
    qtySelectRecipe = {
        index: currentQtySelection.index,
        nome: currentQtySelection.nome,
        kcal: currentQtySelection.kcal
    };
    
    document.getElementById('qtySelectTitle').textContent = currentQtySelection.nome;
    document.getElementById('qtySelectSubtitle').textContent = `${currentQtySelection.kcal || 0} kcal per porzione`;
    document.getElementById('qtySelectNumber').value = currentQtySelection.qty;
    document.getElementById('qtySelectUnit').value = currentQtySelection.unit;
    
    document.getElementById('qtySelectOverlay').classList.add('show');
    document.body.style.overflow = 'hidden';
}

function removeQtySelection() {
    currentQtySelection = null;
    document.getElementById('quickSelectionDisplay').style.display = 'none';
    document.getElementById('quickSearchRecipe').value = '';
}  

// ==========================================
// DETTAGLI RICETTA FULLSCREEN
// ==========================================

let currentRecipeDetailIndex = null;
let currentRecipeEditData = {};

// Array immagini per ricette
const recipeDetailImages = [
  'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400&h=400&fit=crop',
  'https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=400&h=400&fit=crop',
  'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400&h=400&fit=crop',
  'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?w=400&h=400&fit=crop',
  'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=400&h=400&fit=crop',
  'https://images.unsplash.com/photo-1484723091739-30a097e8f929?w=400&h=400&fit=crop',
  'https://images.unsplash.com/photo-1473093295043-cdd812d0e601?w=400&h=400&fit=crop',
  'https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=400&h=400&fit=crop',
  'https://images.unsplash.com/photo-1493770348161-369560ae357d?w=400&h=400&fit=crop',
  'https://images.unsplash.com/photo-1476224203421-9ac39bcb3327?w=400&h=400&fit=crop'
];

function getRecipeImage(nome, ricetta) {
  // Se la ricetta ha un'immagine custom, usala
  if (ricetta && ricetta.immagine) {
    return ricetta.immagine;
  }
  if (ricetta && ricetta.customImage) {
    return ricetta.customImage;
  }
  // Altrimenti genera da hash
  const hashCode = nome.split('').reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a; }, 0);
  const imgIndex = Math.abs(hashCode) % recipeDetailImages.length;
  return recipeDetailImages[imgIndex];
}

function openRecipeModal(index) {
  currentRecipeDetailIndex = index;
  const r = recipes[index];
  if (!r) return;
  
  const wrapper = document.getElementById('recipeDetailFullscreen');
  const navbar = document.querySelector('.navbar');
  
  // Popola i dati
  document.getElementById('rdHeaderTitle').textContent = r.nome;
  document.getElementById('rdHeroImage').src = getRecipeImage(r.nome, r);
  document.getElementById('rdBadgeTime').textContent = (r.tempo || 30) + ' MIN';
  document.getElementById('rdBadgeServ').textContent = (r.porzioni || 2) + ' PERS';
  document.getElementById('rdMacroKcal').textContent = r.kcal || 0;
  document.getElementById('rdMacroProt').textContent = (r.prot || 0) + 'g';
  document.getElementById('rdMacroCarb').textContent = (r.carb || 0) + 'g';
  document.getElementById('rdMacroFat').textContent = (r.fat || 0) + 'g';
  document.getElementById('rdDescription').textContent = r.descrizione || 'Ricetta deliziosa da provare!';
  document.getElementById('rdDividerText').textContent = r.veg ? 'ðŸŒ¿ Vegetariano' : 'ðŸ½ï¸ Ricetta';
  
  // Stella preferiti
  const favBtn = document.getElementById('rdFavBtn');
  if (r.preferito) {
    favBtn.innerHTML = '<svg width="22" height="22" viewBox="0 0 24 24" fill="#fbbf24" stroke="#fbbf24" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';
  } else {
    favBtn.innerHTML = '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';
  }
  
  // Ingredienti
  const ingList = document.getElementById('rdIngredientList');
  let ingHtml = '';
  const ingredienti = Array.isArray(r.ingredienti) ? r.ingredienti : (r.ingredienti ? r.ingredienti.split(',') : []);
  ingredienti.forEach(ing => {
    const parts = ing.trim().split(' ');
    let qty = '';
    let name = ing.trim();
    // Cerca quantitÃ  all'inizio
    if (parts.length > 1 && /^\d/.test(parts[0])) {
      qty = parts[0] + (parts[1] && !/[a-zA-Z]/.test(parts[1].charAt(0)) ? ' ' + parts[1] : '');
      name = parts.slice(qty.split(' ').length).join(' ') || ing.trim();
    }
    ingHtml += `
      <li class="rd-ingredient-item">
        <div class="rd-ing-name-group">
          <div class="rd-ing-dot"></div>
          <span class="rd-ing-name">${name}</span>
        </div>
        <span class="rd-ing-amount">${qty || 'q.b.'}</span>
      </li>
    `;
  });
  ingList.innerHTML = ingHtml || '<li class="rd-ingredient-item"><span class="rd-ing-name" style="color:#94a3b8;">Nessun ingrediente</span></li>';
  
  // Procedimento
  const procContainer = document.getElementById('rdProcedimento');
  let procHtml = '<div class="rd-timeline-line"></div>';
  const steps = Array.isArray(r.procedimento) ? r.procedimento : (r.procedimento ? r.procedimento.split('\n').filter(s => s.trim()) : []);
  if (steps.length === 0) {
    steps.push('Prepara tutti gli ingredienti', 'Segui la ricetta', 'Servi e buon appetito!');
  }
  steps.forEach(step => {
    procHtml += `
      <div class="rd-step-item">
        <div class="rd-step-marker-container">
          <div class="rd-step-marker"></div>
        </div>
        <p class="rd-step-text">${step}</p>
      </div>
    `;
  });
  procContainer.innerHTML = procHtml;
  
  // Mostra schermata view
  document.getElementById('rd-view-screen').classList.add('active');
  document.getElementById('rd-edit-screen').classList.remove('active');
  
  // Apri fullscreen
  wrapper.classList.add('open');
  document.body.style.overflow = 'hidden';
  if (navbar) navbar.style.display = 'none';
}

function closeRecipeDetail() {
  const wrapper = document.getElementById('recipeDetailFullscreen');
  // NON mostrare la navbar - siamo ancora in "Le Mie Ricette"
  
  wrapper.classList.remove('open');
  document.body.style.overflow = 'hidden'; // Mantieni hidden perchÃ© siamo in fullscreen ricette
  
  currentRecipeDetailIndex = null;
}

function toggleRecipeDetailFav() {
  if (currentRecipeDetailIndex === null) return;
  
  recipes[currentRecipeDetailIndex].preferito = !recipes[currentRecipeDetailIndex].preferito;
  saveRecipeIndexed();
  
  const isFav = recipes[currentRecipeDetailIndex].preferito;
  const favBtn = document.getElementById('rdFavBtn');
  if (isFav) {
    favBtn.innerHTML = '<svg width="22" height="22" viewBox="0 0 24 24" fill="#fbbf24" stroke="#fbbf24" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';
    toast('â­ Aggiunta ai preferiti');
  } else {
    favBtn.innerHTML = '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';
    toast('â˜† Rimossa dai preferiti');
  }
  
  // Aggiorna lista
  if (typeof filtraRicette === 'function') filtraRicette();
}

function deleteRecipeFromDetail() {
  if (currentRecipeDetailIndex === null) return;
  
  const r = recipes[currentRecipeDetailIndex];
  if (confirm(`Eliminare "${r.nome}"?`)) {
    recipes.splice(currentRecipeDetailIndex, 1);
    saveRecipeIndexed();
    closeRecipeDetail();
    if (typeof filtraRicette === 'function') filtraRicette();
    toast('ðŸ—‘ï¸ Ricetta eliminata');
  }
}

// ==========================================
// EDIT MODE
// ==========================================

function openRecipeEditMode() {
  if (currentRecipeDetailIndex === null) return;
  
  const r = recipes[currentRecipeDetailIndex];
  
  // Popola form
  document.getElementById('rdEditImage').src = getRecipeImage(r.nome, r);
  document.getElementById('rdEditNome').value = r.nome || '';
  document.getElementById('rdEditTempo').value = r.tempo || 30;
  document.getElementById('rdEditPorzioni').value = r.porzioni || 2;
  document.getElementById('rdEditKcal').value = r.kcal || 0;
  document.getElementById('rdEditProt').value = r.prot || 0;
  document.getElementById('rdEditCarb').value = r.carb || 0;
  document.getElementById('rdEditFat').value = r.fat || 0;
  document.getElementById('rdEditDescrizione').value = r.descrizione || '';
  
  // Ingredienti edit
  const ingContainer = document.getElementById('rdEditIngredientList');
  const ingredienti = Array.isArray(r.ingredienti) ? r.ingredienti : (r.ingredienti ? r.ingredienti.split(',') : ['']);
  let ingHtml = '';
  ingredienti.forEach((ing, i) => {
    ingHtml += `
      <div class="rd-edit-list-row" data-ing-index="${i}">
        <input type="text" value="${ing.trim()}" class="rd-input-base" style="flex: 1;" placeholder="Ingrediente">
        <button class="rd-btn-remove" onclick="removeEditIngredient(${i})">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
      </div>
    `;
  });
  ingContainer.innerHTML = ingHtml;
  
  // Steps edit
  const stepsContainer = document.getElementById('rdEditStepList');
  const steps = Array.isArray(r.procedimento) ? r.procedimento : (r.procedimento ? r.procedimento.split('\n').filter(s => s.trim()) : ['']);
  let stepsHtml = '';
  steps.forEach((step, i) => {
    stepsHtml += `
      <div class="rd-edit-list-row" style="align-items: flex-start;" data-step-index="${i}">
        <div class="rd-step-number">${i + 1}</div>
        <textarea rows="2" class="rd-textarea-base" style="flex: 1;">${step}</textarea>
        <button class="rd-btn-remove" style="margin-top: 8px;" onclick="removeEditStep(${i})">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
      </div>
    `;
  });
  stepsContainer.innerHTML = stepsHtml;
  
  // Switch to edit screen
  document.getElementById('rd-view-screen').classList.remove('active');
  document.getElementById('rd-edit-screen').classList.add('active');
  document.getElementById('rd-edit-screen').querySelector('.rd-scroll-content').scrollTop = 0;
}

function closeRecipeEditMode() {
  document.getElementById('rd-edit-screen').classList.remove('active');
  document.getElementById('rd-view-screen').classList.add('active');
}

function addEditIngredient() {
  const container = document.getElementById('rdEditIngredientList');
  const index = container.children.length;
  const div = document.createElement('div');
  div.className = 'rd-edit-list-row';
  div.dataset.ingIndex = index;
  div.innerHTML = `
    <input type="text" value="" class="rd-input-base" style="flex: 1;" placeholder="Nuovo ingrediente">
    <button class="rd-btn-remove" onclick="this.parentElement.remove()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
    </button>
  `;
  container.appendChild(div);
}

function removeEditIngredient(index) {
  const el = document.querySelector(`[data-ing-index="${index}"]`);
  if (el) el.remove();
}

function addEditStep() {
  const container = document.getElementById('rdEditStepList');
  const index = container.children.length;
  const div = document.createElement('div');
  div.className = 'rd-edit-list-row';
  div.style.alignItems = 'flex-start';
  div.dataset.stepIndex = index;
  div.innerHTML = `
    <div class="rd-step-number">${index + 1}</div>
    <textarea rows="2" class="rd-textarea-base" style="flex: 1;" placeholder="Nuovo passaggio..."></textarea>
    <button class="rd-btn-remove" style="margin-top: 8px;" onclick="this.parentElement.remove(); renumberSteps();">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
    </button>
  `;
  container.appendChild(div);
}

function removeEditStep(index) {
  const el = document.querySelector(`[data-step-index="${index}"]`);
  if (el) el.remove();
  renumberSteps();
}

function renumberSteps() {
  const container = document.getElementById('rdEditStepList');
  const rows = container.querySelectorAll('.rd-edit-list-row');
  rows.forEach((row, i) => {
    const numEl = row.querySelector('.rd-step-number');
    if (numEl) numEl.textContent = i + 1;
  });
}

function handleEditImageChange(input) {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('rdEditImage').src = e.target.result;
      currentRecipeEditData.customImage = e.target.result;
    };
    reader.readAsDataURL(input.files[0]);
  }
}

function saveRecipeEdit() {
  if (currentRecipeDetailIndex === null) return;
  
  const r = recipes[currentRecipeDetailIndex];
  
  // Salva dati base
  r.nome = document.getElementById('rdEditNome').value || r.nome;
  r.tempo = parseInt(document.getElementById('rdEditTempo').value) || 30;
  r.porzioni = parseInt(document.getElementById('rdEditPorzioni').value) || 2;
  r.kcal = parseInt(document.getElementById('rdEditKcal').value) || 0;
  r.prot = parseInt(document.getElementById('rdEditProt').value) || 0;
  r.carb = parseInt(document.getElementById('rdEditCarb').value) || 0;
  r.fat = parseInt(document.getElementById('rdEditFat').value) || 0;
  r.descrizione = document.getElementById('rdEditDescrizione').value || '';
  
  // Ingredienti
  const ingInputs = document.querySelectorAll('#rdEditIngredientList input');
  r.ingredienti = Array.from(ingInputs).map(inp => inp.value.trim()).filter(v => v);
  
  // Procedimento
  const stepInputs = document.querySelectorAll('#rdEditStepList textarea');
  r.procedimento = Array.from(stepInputs).map(ta => ta.value.trim()).filter(v => v);
  
  // Immagine custom - SEMPRE salva se presente
  if (currentRecipeEditData.customImage) {
    r.immagine = currentRecipeEditData.customImage;
    r.customImage = currentRecipeEditData.customImage; // Backup
  }
  
  saveRecipeIndexed();
  
  // Reset edit data
  currentRecipeEditData = {};
  
  // Torna a view e aggiorna
  closeRecipeEditMode();
  openRecipeModal(currentRecipeDetailIndex);
  
  if (typeof filtraRicette === 'function') filtraRicette();
  
  toast('âœ… Ricetta salvata!');
}  
  
</script>

<!-- CERCA RICETTE ONLINE - FULLSCREEN -->
<div class="cerca-ricette-wrapper" id="cercaRicetteWrapper">
    <div class="cerca-ricette-header">
        <button class="cerca-ricette-back-btn" onclick="closeCercaRicette()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>
            </svg>
        </button>
        <h2 class="cerca-ricette-title">Ricette Online</h2>
        <div style="width:44px;"></div>
    </div>
    
  <div class="search-overlay" id="searchOverlay" onclick="handleOverlayClick(event)"></div>
    <div class="cerca-ricette-content">
       <div class="cerca-ricette-search-box">
            <div class="cerca-ricette-search-row">
                <div class="search-icon-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </div>
                <input 
                    type="text" 
                    id="cercaRicetteInput" 
                    class="cerca-ricette-input" 
                    placeholder="Cerca qualsiasi ricetta..."
                    onkeypress="if(event.key==='Enter') cercaRicetteAI()"
                    oninput="onSearchInputChange(this.value)"
                    onfocus="onSearchInputFocus()"
                    autocomplete="off"
                >
              <button class="cerca-ricette-search-btn" onclick="cercaRicetteAI()" id="cercaRicetteBtn">Cerca</button>
            </div>
            <div id="searchDropdownResults" style="display:none;"></div>
        </div>
        
        <div id="cercaAIResults" style="display:none;"></div>
        
        <div class="cucina-filters">
            <button class="cucina-filter-btn active" onclick="filtraCucina('tutte')">ðŸ½ï¸ Tutte</button>
            <button class="cucina-filter-btn" onclick="filtraCucina('italiana')">ðŸ‡®ðŸ‡¹ Italiana</button>
            <button class="cucina-filter-btn" onclick="filtraCucina('americana')">ðŸ‡ºðŸ‡¸ Americana</button>
            <button class="cucina-filter-btn" onclick="filtraCucina('giapponese')">ðŸ‡¯ðŸ‡µ Giapponese</button>
            <button class="cucina-filter-btn" onclick="filtraCucina('messicana')">ðŸ‡²ðŸ‡½ Messicana</button>
            <button class="cucina-filter-btn" onclick="filtraCucina('indiana')">ðŸ‡®ðŸ‡³ Indiana</button>
            <button class="cucina-filter-btn" onclick="filtraCucina('cinese')">ðŸ‡¨ðŸ‡³ Cinese</button>
            <button class="cucina-filter-btn" onclick="filtraCucina('francese')">ðŸ‡«ðŸ‡· Francese</button>
            <button class="cucina-filter-btn" onclick="filtraCucina('tedesca')">ðŸ‡©ðŸ‡ª Tedesca</button>
            <button class="cucina-filter-btn" onclick="filtraCucina('greca')">ðŸ‡¬ðŸ‡· Greca</button>
        </div>
        
        <div id="cercaRicetteContent"></div>
    </div>
</div>

<div class="recipe-detail-overlay" id="recipeDetailOverlay" onclick="closeRecipeDetailCard(event)">
    <div class="recipe-detail-card" onclick="event.stopPropagation()">
        <!-- Pulsante chiudi fisso -->
        <button class="recipe-detail-close" onclick="closeRecipeDetailCard()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        
        <!-- Container scrollabile -->
        <div class="recipe-detail-scroll">
            <!-- Header con immagine -->
            <div class="recipe-detail-header" id="recipeDetailHeader">
                <img class="recipe-detail-header-img" id="recipeDetailImg" src="https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=800" alt="Ricetta">
                <div class="recipe-detail-header-gradient"></div>
                
                <!-- Badge tempo e porzioni -->
                <div class="recipe-detail-badges">
                    <div class="recipe-detail-badge">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        <span id="recipeDetailTime">30 Min</span>
                    </div>
                    <div class="recipe-detail-badge">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        <span id="recipeDetailServings">2 Pers</span>
                    </div>
                </div>
            </div>
            
            <!-- Contenuto principale -->
            <div class="recipe-detail-body" id="recipeDetailBody">
                <!-- Titolo centrato -->
                <div class="recipe-detail-title-section">
                    <div class="recipe-detail-ai-badge">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>
                        <span>Ricetta</span>
                    </div>
                    <h2 class="recipe-detail-title" id="recipeDetailTitle">Nome Ricetta</h2>
                    <div class="recipe-detail-cuisine">
                        <span class="recipe-detail-cuisine-line"></span>
                        <span class="recipe-detail-cuisine-text" id="recipeDetailCuisine">Cucina Italiana</span>
                        <span class="recipe-detail-cuisine-line"></span>
                    </div>
                </div>
                
                <!-- Macro cards -->
                <div class="recipe-detail-macros" id="recipeDetailMacros">
                    <div class="recipe-detail-macro">
                        <span class="recipe-detail-macro-label">Kcal</span>
                        <span class="recipe-detail-macro-value" id="macroKcal">550</span>
                    </div>
                    <div class="recipe-detail-macro">
                        <span class="recipe-detail-macro-label">Prot</span>
                        <span class="recipe-detail-macro-value" id="macroProt">22g</span>
                    </div>
                    <div class="recipe-detail-macro">
                        <span class="recipe-detail-macro-label">Carb</span>
                        <span class="recipe-detail-macro-value" id="macroCarb">65g</span>
                    </div>
                    <div class="recipe-detail-macro">
                        <span class="recipe-detail-macro-label">Gras</span>
                        <span class="recipe-detail-macro-value" id="macroFat">24g</span>
                    </div>
                </div>
                
                <!-- Descrizione/Citazione -->
                <div class="recipe-detail-quote">
                    <p id="recipeDetailDesc">Descrizione della ricetta...</p>
                </div>
                
                <!-- Ingredienti -->
                <div class="recipe-detail-section">
                    <h4 class="recipe-detail-section-title">
                        <span class="recipe-detail-section-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"></path><path d="M7 2v20"></path><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"></path></svg>
                        </span>
                        Ingredienti
                    </h4>
                    <ul class="recipe-detail-ingredients-list" id="recipeDetailIngredients">
                        <li class="recipe-detail-ingredient">
                            <div class="recipe-detail-ingredient-left">
                                <span class="recipe-detail-ingredient-dot"></span>
                                <span class="recipe-detail-ingredient-name">Caricamento...</span>
                            </div>
                        </li>
                    </ul>
                </div>
                
                <!-- Procedimento -->
                <div class="recipe-detail-section">
                    <h4 class="recipe-detail-section-title">
                        <span class="recipe-detail-section-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"></path><line x1="6" y1="17" x2="18" y2="17"></line></svg>
                        </span>
                        Procedimento
                    </h4>
                    <div class="recipe-detail-steps" id="recipeDetailSteps">
                        <div class="recipe-detail-steps-line"></div>
                        <div class="recipe-detail-step">
                            <div class="recipe-detail-step-dot"></div>
                            <p class="recipe-detail-step-text">Caricamento...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Storia -->
                <div class="recipe-detail-section">
                    <h4 class="recipe-detail-section-title">
                        <span class="recipe-detail-section-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                        </span>
                        Storia
                    </h4>
                    <div class="recipe-detail-history">
                        <div class="recipe-detail-history-icon">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                        </div>
                        <p id="recipeDetailHistory">Caricamento...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer con stellina + bottone salva -->
        <div class="recipe-detail-footer">
            <div class="recipe-detail-footer-row">
                <!-- Stellina Preferiti (minimal) -->
                <button class="recipe-detail-star-btn" id="recipeDetailStarBtn" onclick="toggleRecipeDetailFavorite()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                </button>
                
                <!-- Bottone Salva compatto -->
                <button class="recipe-detail-save-btn" id="recipeDetailSaveBtn" onclick="saveRecipeDetailAsCustom()">
                    <span class="recipe-detail-save-btn-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                    </span>
                    <span class="recipe-detail-save-btn-text">Salva Ricetta</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- CARD SELEZIONE QUANTITÃ€ -->
<div class="qty-select-overlay" id="qtySelectOverlay" onclick="closeQtySelect(event)">
    <div class="qty-select-card" onclick="event.stopPropagation()">
        <!-- SVG Decorations -->
        <svg class="qty-deco-svg-top" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="45" fill="currentColor" />
        </svg>
        <svg class="qty-deco-svg-bottom" viewBox="0 0 200 200">
            <path d="M0,100 Q50,0 100,100 T200,100" fill="none" stroke="currentColor" stroke-width="2" />
            <path d="M0,120 Q50,20 100,120 T200,120" fill="none" stroke="currentColor" stroke-width="1" />
        </svg>
        <div class="qty-floating-ring qty-ring-1"></div>
        <div class="qty-floating-ring qty-ring-2"></div>
        
        <div class="qty-card-content">
            <div class="qty-select-header">
                <div>
                    <h3 class="qty-select-title" id="qtySelectTitle">Nome Alimento</h3>
                    <p class="qty-select-subtitle" id="qtySelectSubtitle">120 kcal per porzione</p>
                </div>
                <button class="qty-select-close" onclick="closeQtySelect()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="qty-select-input-row">
                <input type="number" class="qty-select-number" id="qtySelectNumber" value="1" min="0.1" step="0.5" inputmode="decimal">
                <div class="qty-unit-select-wrapper">
                    <select class="qty-select-unit" id="qtySelectUnit">
                        <option value="porzione">Porzione</option>
                        <option value="grammi">Grammi (g)</option>
                        <option value="etto">Etto (100g)</option>
                        <option value="kg">Chilogrammo (kg)</option>
                        <option value="ml">Millilitri (ml)</option>
                        <option value="litro">Litro (l)</option>
                        <option value="cucchiaio">Cucchiaio</option>
                        <option value="cucchiaino">Cucchiaino</option>
                        <option value="tazza">Tazza</option>
                        <option value="bicchiere">Bicchiere</option>
                        <option value="fetta">Fetta</option>
                        <option value="pezzo">Pezzo</option>
                        <option value="manciata">Manciata</option>
                    </select>
                    <div class="qty-select-arrow">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="qty-select-presets">
                <button class="qty-preset-btn" onclick="setQtyPreset(0.5, 'porzione')">Â½ porz.</button>
                <button class="qty-preset-btn" onclick="setQtyPreset(1, 'porzione')">1 porz.</button>
                <button class="qty-preset-btn" onclick="setQtyPreset(2, 'porzione')">2 porz.</button>
            </div>
            
            <div class="qty-select-presets">
                <button class="qty-preset-btn" onclick="setQtyPreset(50, 'grammi')">50g</button>
                <button class="qty-preset-btn" onclick="setQtyPreset(100, 'grammi')">100g</button>
                <button class="qty-preset-btn" onclick="setQtyPreset(200, 'grammi')">200g</button>
            </div>

            <div class="qty-select-actions">
                <button class="qty-select-cancel" onclick="closeQtySelect()">Annulla</button>
                <button class="qty-select-confirm" onclick="confirmQtySelect()">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- DETTAGLI RICETTA FULLSCREEN -->
<div class="recipe-detail-fullscreen" id="recipeDetailFullscreen">
  
  <!-- VIEW SCREEN -->
  <div id="rd-view-screen" class="rd-screen active">
    
    <header class="rd-header">
      <button class="rd-btn-icon" onclick="closeRecipeDetail()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
      </button>
      <div class="rd-header-title" id="rdHeaderTitle">Nome Ricetta</div>
      <button class="rd-btn-icon" id="rdFavBtn" onclick="toggleRecipeDetailFav()">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
      </button>
    </header>

    <div class="rd-scroll-content">
      <div class="rd-content-padding">
        
        <!-- Hero Section -->
        <div class="rd-hero-section">
          <div class="rd-hero-image-container">
            <img id="rdHeroImage" src="" class="rd-hero-image" alt="Ricetta">
            <div class="rd-image-badges">
              <div class="rd-badge">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#14b8a6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                <span id="rdBadgeTime">30 MIN</span>
              </div>
              <div class="rd-badge">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#14b8a6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                <span id="rdBadgeServ">2 PERS</span>
              </div>
            </div>
          </div>

          <div class="rd-hero-details">
            <div class="rd-macros-grid">
              <div class="rd-macro-card">
                <span class="rd-macro-label">KCAL</span>
                <span class="rd-macro-value" id="rdMacroKcal">0</span>
              </div>
              <div class="rd-macro-card">
                <span class="rd-macro-label">PROT</span>
                <span class="rd-macro-value" id="rdMacroProt">0g</span>
              </div>
              <div class="rd-macro-card">
                <span class="rd-macro-label">CARB</span>
                <span class="rd-macro-value" id="rdMacroCarb">0g</span>
              </div>
              <div class="rd-macro-card">
                <span class="rd-macro-label">GRAS</span>
                <span class="rd-macro-value" id="rdMacroFat">0g</span>
              </div>
            </div>
            <div class="rd-description-box">
              <p class="rd-description-text" id="rdDescription">Descrizione della ricetta...</p>
            </div>
          </div>
        </div>

        <!-- Divider -->
        <div class="rd-divider">
          <div class="rd-divider-line"></div>
          <span class="rd-divider-text" id="rdDividerText">ðŸ½ï¸ Ricetta</span>
          <div class="rd-divider-line"></div>
        </div>

        <!-- Ingredienti -->
        <div class="rd-section-header">
          <div class="rd-icon-box">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>
          </div>
          <h2 class="rd-section-title">Ingredienti</h2>
        </div>

        <ul class="rd-ingredient-list" id="rdIngredientList">
          <!-- Ingredienti dinamici -->
        </ul>

        <!-- Procedimento -->
        <div class="rd-section-header" style="margin-top: 28px;">
          <div class="rd-icon-box">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/></svg>
          </div>
          <h2 class="rd-section-title">Procedimento</h2>
        </div>

        <div class="rd-timeline-container" id="rdProcedimento">
          <div class="rd-timeline-line"></div>
          <!-- Steps dinamici -->
        </div>

      </div>
    </div>

    <!-- Footer View -->
    <footer class="rd-footer">
      <div class="rd-footer-row">
        <button class="rd-btn-primary" onclick="openRecipeEditMode()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
          Modifica ricetta
        </button>
        <button class="rd-btn-secondary" onclick="deleteRecipeFromDetail()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
        </button>
      </div>
    </footer>
  </div>

  <!-- EDIT SCREEN -->
  <div id="rd-edit-screen" class="rd-screen">
    
    <header class="rd-header" style="justify-content: space-between;">
      <button class="rd-btn-icon" style="width: auto; border-radius: 10px; gap: 6px; padding: 8px 12px;" onclick="closeRecipeEditMode()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        <span style="font-size: 14px; font-weight: 700;">Annulla</span>
      </button>
      <div class="rd-header-title" style="flex: none;">Modifica Ricetta</div>
      <div style="width: 80px;"></div>
    </header>

    <div class="rd-scroll-content" style="padding-bottom: 40px;">
      <div class="rd-content-padding">
        
        <!-- Edit Image -->
        <div class="rd-edit-image-container" onclick="document.getElementById('rdEditImageInput').click()">
          <img id="rdEditImage" src="" class="rd-hero-image">
          <div class="rd-edit-overlay">
            <div class="rd-edit-icon-circle">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
            </div>
            <span class="rd-edit-text-overlay">Cambia Foto</span>
          </div>
          <input type="file" id="rdEditImageInput" accept="image/*" style="display:none;" onchange="handleEditImageChange(this)">
        </div>

        <!-- Nome -->
        <div class="rd-form-group">
          <label class="rd-label-tiny">Nome Ricetta</label>
          <input type="text" id="rdEditNome" class="rd-input-base rd-input-lg" placeholder="Nome della ricetta">
        </div>

        <!-- Tempo & Porzioni -->
        <div class="rd-form-row">
          <div class="rd-form-col">
            <label class="rd-label-tiny">Tempo (min)</label>
            <div class="rd-input-icon-wrapper">
              <svg class="rd-input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
              <input type="number" id="rdEditTempo" class="rd-input-base rd-input-w-icon" placeholder="30">
            </div>
          </div>
          <div class="rd-form-col">
            <label class="rd-label-tiny">Porzioni</label>
            <div class="rd-input-icon-wrapper">
              <svg class="rd-input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
              <input type="number" id="rdEditPorzioni" class="rd-input-base rd-input-w-icon" placeholder="2">
            </div>
          </div>
        </div>

        <!-- Macro -->
        <div class="rd-form-group">
          <label class="rd-label-tiny">Macronutrienti</label>
          <div class="rd-macro-edit-grid">
            <div class="rd-macro-edit-item">
              <span class="rd-macro-label" style="text-align:center;">KCAL</span>
              <input type="number" id="rdEditKcal" class="rd-macro-edit-input" placeholder="0">
            </div>
            <div class="rd-macro-edit-item">
              <span class="rd-macro-label" style="text-align:center;">PROT</span>
              <input type="number" id="rdEditProt" class="rd-macro-edit-input" placeholder="0">
            </div>
            <div class="rd-macro-edit-item">
              <span class="rd-macro-label" style="text-align:center;">CARB</span>
              <input type="number" id="rdEditCarb" class="rd-macro-edit-input" placeholder="0">
            </div>
            <div class="rd-macro-edit-item">
              <span class="rd-macro-label" style="text-align:center;">GRAS</span>
              <input type="number" id="rdEditFat" class="rd-macro-edit-input" placeholder="0">
            </div>
          </div>
        </div>

        <!-- Descrizione -->
        <div class="rd-form-group">
          <label class="rd-label-tiny">Descrizione</label>
          <textarea id="rdEditDescrizione" rows="3" class="rd-textarea-base" placeholder="Descrizione della ricetta..."></textarea>
        </div>

        <div class="rd-divider-line" style="width: 100%; margin: 24px 0;"></div>

        <!-- Edit Ingredienti -->
        <div class="rd-form-group">
          <div class="rd-list-header">
            <label class="rd-label-tiny" style="margin:0;">Ingredienti</label>
            <button class="rd-btn-add" onclick="addEditIngredient()">+ AGGIUNGI</button>
          </div>
          <div id="rdEditIngredientList">
            <!-- Ingredienti edit dinamici -->
          </div>
        </div>

        <div class="rd-divider-line" style="width: 100%; margin: 24px 0;"></div>

        <!-- Edit Steps -->
        <div class="rd-form-group">
          <div class="rd-list-header">
            <label class="rd-label-tiny" style="margin:0;">Procedimento</label>
            <button class="rd-btn-add" onclick="addEditStep()">+ STEP</button>
          </div>
          <div id="rdEditStepList">
            <!-- Steps edit dinamici -->
          </div>
        </div>

        <!-- Bottone Salva (sotto procedimento) -->
        <div style="margin-top: 32px;">
          <button class="rd-btn-primary rd-btn-save" onclick="saveRecipeEdit()" style="width: 100%; height: 54px; border-radius: 16px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            Salva Modifiche
          </button>
        </div>

      </div>
    </div>

  </div>

</div>


  </div>

</div>

</body>
</html>